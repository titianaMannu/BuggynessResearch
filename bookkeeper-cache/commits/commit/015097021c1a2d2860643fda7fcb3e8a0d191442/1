{"sha":"015097021c1a2d2860643fda7fcb3e8a0d191442","node_id":"MDY6Q29tbWl0MTU3NTk1NjowMTUwOTcwMjFjMWEyZDI4NjA2NDNmZGE3ZmNiM2U4YTBkMTkxNDQy","commit":{"author":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2011-12-16T14:32:58Z"},"committer":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2011-12-16T14:32:58Z"},"message":"BOOKKEEPER-141: Run extracting ledger id from entry log files in GC thread to speed up bookie restart (Sijie Gou via ivank)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1215156 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"e58e2c4ad7e38e2b67a7a0a9b7685490f7eb17e0","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/e58e2c4ad7e38e2b67a7a0a9b7685490f7eb17e0"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/015097021c1a2d2860643fda7fcb3e8a0d191442","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/015097021c1a2d2860643fda7fcb3e8a0d191442","html_url":"https://github.com/apache/bookkeeper/commit/015097021c1a2d2860643fda7fcb3e8a0d191442","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/015097021c1a2d2860643fda7fcb3e8a0d191442/comments","author":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"committer":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"parents":[{"sha":"9eb549d4c308963af0be3288a59b0c4c39cbb5e6","url":"https://api.github.com/repos/apache/bookkeeper/commits/9eb549d4c308963af0be3288a59b0c4c39cbb5e6","html_url":"https://github.com/apache/bookkeeper/commit/9eb549d4c308963af0be3288a59b0c4c39cbb5e6"}],"stats":{"total":25,"additions":18,"deletions":7},"files":[{"sha":"da99d8eccfcfd3a74fa513b817e01d80f09584d5","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/015097021c1a2d2860643fda7fcb3e8a0d191442/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/015097021c1a2d2860643fda7fcb3e8a0d191442/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=015097021c1a2d2860643fda7fcb3e8a0d191442","patch":"@@ -14,6 +14,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-142: Parsing last log id is wrong, which may make entry log files overwritten (Sijie Gou via ivank)\n \n+        BOOKKEEPER-141: Run extracting ledger id from entry log files in GC thread to speed up bookie restart (Sijie Gou via ivank)\n+\n     IMPROVEMENTS:\n \n Release 4.0.0 - 2011-11-30"},{"sha":"42f54d26ac7d3edaf280b1c7dfd77a25992a12d7","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java","status":"modified","additions":12,"deletions":6,"changes":18,"blob_url":"https://github.com/apache/bookkeeper/blob/015097021c1a2d2860643fda7fcb3e8a0d191442/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java","raw_url":"https://github.com/apache/bookkeeper/raw/015097021c1a2d2860643fda7fcb3e8a0d191442/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/EntryLogger.java?ref=015097021c1a2d2860643fda7fcb3e8a0d191442","patch":"@@ -137,9 +137,17 @@ public void run() {\n                         continue;\n                     }\n                 }\n+                // Extract all of the ledger ID's that comprise all of the entry logs\n+                // (except for the current new one which is still being written to).\n+                try {\n+                    extractLedgersFromEntryLogs();\n+                } catch (IOException ie) {\n+                    LOG.warn(\"Exception when extracting ledgers from entry logs : \", ie);\n+                }\n+\n                 // Initialization check. No need to run any logic if we are still starting up.\n-                if (bookie.zk == null || entryLogs2LedgersMap.isEmpty() ||\n-                    bookie.ledgerCache == null) {\n+                if (bookie == null ||\n+                    bookie.zk == null || bookie.ledgerCache == null) {\n                     continue;\n                 }\n \n@@ -225,9 +233,6 @@ private void createLogId(long logId) throws IOException {\n         for(File f: dirs) {\n             setLastLogId(f, logId);\n         }\n-        // Extract all of the ledger ID's that comprise all of the entry logs\n-        // (except for the current new one which is still being written to).\n-        extractLedgersFromEntryLogs();\n     }\n \n     /**\n@@ -391,7 +396,8 @@ private void extractLedgersFromEntryLogs() throws IOException {\n         // by 1 when the log fills up and we roll to a new one.\n         ByteBuffer sizeBuff = ByteBuffer.allocate(4);\n         BufferedChannel bc;\n-        for (long entryLogId = 0; entryLogId < logId; entryLogId++) {\n+        long curLogId = logId;\n+        for (long entryLogId = 0; entryLogId < curLogId; entryLogId++) {\n             // Comb the current entry log file if it has not already been extracted.\n             if (entryLogs2LedgersMap.containsKey(entryLogId)) {\n                 continue;"},{"sha":"2e5d784b96c90086c2c6918dba388797259bd6eb","filename":"bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java","status":"modified","additions":4,"deletions":1,"changes":5,"blob_url":"https://github.com/apache/bookkeeper/blob/015097021c1a2d2860643fda7fcb3e8a0d191442/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java","raw_url":"https://github.com/apache/bookkeeper/raw/015097021c1a2d2860643fda7fcb3e8a0d191442/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/EntryLogTest.java?ref=015097021c1a2d2860643fda7fcb3e8a0d191442","patch":"@@ -45,11 +45,13 @@ public void setUp() throws Exception {\n     }\n \n     @Test\n-    public void testCorruptEntryLog() throws IOException, SecurityException, NoSuchFieldException, IllegalArgumentException, IllegalAccessException {\n+    public void testCorruptEntryLog() throws Exception {\n         File tmpDir = File.createTempFile(\"bkTest\", \".dir\");\n         tmpDir.delete();\n         tmpDir.mkdir();\n+        int gcWaitTime = 1000;\n         ServerConfiguration conf = new ServerConfiguration();\n+        conf.setGcWaitTime(gcWaitTime);\n         conf.setLedgerDirNames(new String[] {tmpDir.toString()});\n         // create some entries\n         EntryLogger logger = new EntryLogger(conf, null);\n@@ -64,6 +66,7 @@ public void testCorruptEntryLog() throws IOException, SecurityException, NoSuchF\n         raf.close();\n         // now see which ledgers are in the log\n         logger = new EntryLogger(conf, null);\n+        Thread.sleep(2 * gcWaitTime);\n         Field entryLogs2LedgersMapField = logger.getClass().getDeclaredField(\"entryLogs2LedgersMap\");\n         entryLogs2LedgersMapField.setAccessible(true);\n         @SuppressWarnings(\"unchecked\")"}]}

