{"sha":"06b50969499330d4a5421b48a042fdee63857d23","node_id":"MDY6Q29tbWl0MTU3NTk1NjowNmI1MDk2OTQ5OTMzMGQ0YTU0MjFiNDhhMDQyZmRlZTYzODU3ZDIz","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2012-09-07T05:26:40Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2012-09-07T05:26:40Z"},"message":"BOOKKEEPER-387: BookKeeper Upgrade is not working. (surendra via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1381879 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"efb3ed239dc047ec36d0e38612479d2c569cbd01","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/efb3ed239dc047ec36d0e38612479d2c569cbd01"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/06b50969499330d4a5421b48a042fdee63857d23","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/06b50969499330d4a5421b48a042fdee63857d23","html_url":"https://github.com/apache/bookkeeper/commit/06b50969499330d4a5421b48a042fdee63857d23","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/06b50969499330d4a5421b48a042fdee63857d23/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"3d036b0bf3939b042f4ba01a80b8b81ca6774d1b","url":"https://api.github.com/repos/apache/bookkeeper/commits/3d036b0bf3939b042f4ba01a80b8b81ca6774d1b","html_url":"https://github.com/apache/bookkeeper/commit/3d036b0bf3939b042f4ba01a80b8b81ca6774d1b"}],"stats":{"total":27,"additions":26,"deletions":1},"files":[{"sha":"91fcdff730ef0c5cdb6caf994e66db4759542c98","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/06b50969499330d4a5421b48a042fdee63857d23/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/06b50969499330d4a5421b48a042fdee63857d23/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=06b50969499330d4a5421b48a042fdee63857d23","patch":"@@ -78,6 +78,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-395: HDFS dep transitively depends on a busted pom (Stu Hood via sijie)\n \n+        BOOKKEEPER-387: BookKeeper Upgrade is not working. (surendra via sijie)\n+\n       hedwig-protocol:\n \n         BOOKKEEPER-394: CompositeException message is not useful (Stu Hood via sijie)"},{"sha":"f44d397dca8406be752dce4e8842d2df979cf843","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","status":"modified","additions":7,"deletions":1,"changes":8,"blob_url":"https://github.com/apache/bookkeeper/blob/06b50969499330d4a5421b48a042fdee63857d23/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","raw_url":"https://github.com/apache/bookkeeper/raw/06b50969499330d4a5421b48a042fdee63857d23/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java?ref=06b50969499330d4a5421b48a042fdee63857d23","patch":"@@ -195,6 +195,7 @@ public static void upgrade(ServerConfiguration conf)\n                 int version = detectPreviousVersion(d);\n                 if (version == Cookie.CURRENT_COOKIE_LAYOUT_VERSION) {\n                     LOG.info(\"Directory is current, no need to upgrade\");\n+                    continue;\n                 }\n                 try {\n                     File curDir = new File(d, Bookie.CURRENT_DIR);\n@@ -230,6 +231,11 @@ public boolean accept(File dir, String name) {\n                     throw new BookieException.UpgradeException(ioe);\n                 }\n             }\n+\n+            if (deferredMoves.isEmpty()) {\n+                return;\n+            }\n+\n             try {\n                 c.writeToZooKeeper(zk, conf);\n             } catch (KeeperException ke) {\n@@ -376,4 +382,4 @@ public static void main(String[] args) throws Exception {\n             throw new IllegalArgumentException(err);\n         }\n     }\n-}\n\\ No newline at end of file\n+}"},{"sha":"3a7fa084f020a5b952323a64ef71fd6066d0ecce","filename":"bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java","status":"modified","additions":17,"deletions":0,"changes":17,"blob_url":"https://github.com/apache/bookkeeper/blob/06b50969499330d4a5421b48a042fdee63857d23/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java","raw_url":"https://github.com/apache/bookkeeper/raw/06b50969499330d4a5421b48a042fdee63857d23/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/UpgradeTest.java?ref=06b50969499330d4a5421b48a042fdee63857d23","patch":"@@ -213,6 +213,23 @@ public void testUpgradeV2toCurrent() throws Exception {\n         testUpgradeProceedure(zkutil.getZooKeeperConnectString(), journalDir, ledgerDir);\n     }\n \n+    @Test\n+    public void testUpgradeCurrent() throws Exception {\n+        String journalDir = newV2JournalDirectory();\n+        String ledgerDir = newV2LedgerDirectory();\n+        testUpgradeProceedure(zkutil.getZooKeeperConnectString(), journalDir, ledgerDir);\n+        // Upgrade again\n+        ServerConfiguration conf = new ServerConfiguration()\n+            .setZkServers(zkutil.getZooKeeperConnectString())\n+            .setJournalDirName(journalDir)\n+            .setLedgerDirNames(new String[] { ledgerDir })\n+            .setBookiePort(3181);\n+        FileSystemUpgrade.upgrade(conf); // should work fine with current directory\n+        Bookie b = new Bookie(conf);\n+        b.start();\n+        b.shutdown();\n+    }\n+\n     @Test\n     public void testCommandLine() throws Exception {\n         PrintStream origerr = System.err;"}]}

