{"sha":"0a925975e9a09839e4501479cade955eb1963695","node_id":"MDY6Q29tbWl0MTU3NTk1NjowYTkyNTk3NWU5YTA5ODM5ZTQ1MDE0NzljYWRlOTU1ZWIxOTYzNjk1","commit":{"author":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2014-05-27T10:52:49Z"},"committer":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2014-05-27T10:52:49Z"},"message":"BOOKKEEPER-752: Deadlock on NIOServer shutdown (sijie via ivank)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/branches/branch-4.2@1597744 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"3138441632673a2fc1441ecccdcf1ebe7fcdd474","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/3138441632673a2fc1441ecccdcf1ebe7fcdd474"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/0a925975e9a09839e4501479cade955eb1963695","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/0a925975e9a09839e4501479cade955eb1963695","html_url":"https://github.com/apache/bookkeeper/commit/0a925975e9a09839e4501479cade955eb1963695","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/0a925975e9a09839e4501479cade955eb1963695/comments","author":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"committer":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"parents":[{"sha":"4e337aee19b1f63024df95a7569b74ba22bf9370","url":"https://api.github.com/repos/apache/bookkeeper/commits/4e337aee19b1f63024df95a7569b74ba22bf9370","html_url":"https://github.com/apache/bookkeeper/commit/4e337aee19b1f63024df95a7569b74ba22bf9370"}],"stats":{"total":26,"additions":17,"deletions":9},"files":[{"sha":"ac2d9ad589130403b5ef45e9784ae6fbb6b25baf","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/0a925975e9a09839e4501479cade955eb1963695/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/0a925975e9a09839e4501479cade955eb1963695/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=0a925975e9a09839e4501479cade955eb1963695","patch":"@@ -28,6 +28,8 @@ Release 4.2.3 - 2013-12-04\n \n \tBOOKKEEPER-755: Incorrect number of seconds specified in a day (Joseph Redfern via fpj)\n \n+        BOOKKEEPER-752: Deadlock on NIOServer shutdown (sijie via ivank)\n+\n     IMPROVEMENT:\n \n         BOOKKEEPER-747: Implement register/unregister LedgerMetadataListener in MSLedgerManagerFactory (fpj via sijie)"},{"sha":"99658df26d5f7d794984bb756cb1e136df89a894","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/NIOServerFactory.java","status":"modified","additions":15,"deletions":9,"changes":24,"blob_url":"https://github.com/apache/bookkeeper/blob/0a925975e9a09839e4501479cade955eb1963695/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/NIOServerFactory.java","raw_url":"https://github.com/apache/bookkeeper/raw/0a925975e9a09839e4501479cade955eb1963695/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/NIOServerFactory.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/NIOServerFactory.java?ref=0a925975e9a09839e4501479cade955eb1963695","patch":"@@ -513,17 +513,23 @@ private void sendBuffers(ByteBuffer bb[]) {\n             makeWritable(sk);\n         }\n \n-        synchronized public void sendResponse(ByteBuffer... bb) {\n-            if (closed) {\n-                return;\n+        public void sendResponse(ByteBuffer... bb) {\n+            synchronized (this) {\n+                if (closed) {\n+                    return;\n+                }\n+                sendBuffers(bb);\n+                outstandingRequests--;\n             }\n-            sendBuffers(bb);\n+            // acquire these monitors in order to avoid deadlock during shutdown\n+            // it doesn't matter much whether we do this synchronusly with sendBuffers, as long as it happens\n             synchronized (NIOServerFactory.this) {\n-                outstandingRequests--;\n-                // check throttling\n-                if (outstandingRequests < outstandingLimit) {\n-                    sk.selector().wakeup();\n-                    enableRecv();\n+                synchronized (this) {\n+                    // check throttling\n+                    if (outstandingRequests < outstandingLimit) {\n+                        sk.selector().wakeup();\n+                        enableRecv();\n+                    }\n                 }\n             }\n         }"}]}

