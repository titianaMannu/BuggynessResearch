{"sha":"0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","node_id":"MDY6Q29tbWl0MTU3NTk1NjowZTA2ZGRlYjdlNDdiZDg3OTRmZDM3ODYyOTYwMmU0MWVhNGExZmQ5","commit":{"author":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2012-07-11T17:24:48Z"},"committer":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2012-07-11T17:24:48Z"},"message":"BOOKKEEPER-329: provide stop scripts for hub server (sijie via ivank)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1360311 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"e6203de847dbdb26231471d74a3d7166d86f3c2a","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/e6203de847dbdb26231471d74a3d7166d86f3c2a"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","html_url":"https://github.com/apache/bookkeeper/commit/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/comments","author":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"committer":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"parents":[{"sha":"c2efd0a48c5d1ea4edd7bf33c69a7e5270942eb4","url":"https://api.github.com/repos/apache/bookkeeper/commits/c2efd0a48c5d1ea4edd7bf33c69a7e5270942eb4","html_url":"https://github.com/apache/bookkeeper/commit/c2efd0a48c5d1ea4edd7bf33c69a7e5270942eb4"}],"stats":{"total":203,"additions":199,"deletions":4},"files":[{"sha":"f9523c51ada4e806230f84d39bb8d37b49e8aec7","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","patch":"@@ -58,6 +58,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-250: Need a ledger manager like interface to manage metadata operations in Hedwig (sijie via ivank)\n \n+        BOOKKEEPER-329: provide stop scripts for hub server (sijie via ivank)\n+\n Release 4.1.0 - 2012-06-07\n \n   Non-backward compatible changes:"},{"sha":null,"filename":"bookkeeper-server/bin/bookkeeper-daemon.sh","status":"modified","additions":0,"deletions":0,"changes":0,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/bookkeeper-server/bin/bookkeeper-daemon.sh","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/bookkeeper-server/bin/bookkeeper-daemon.sh","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/bin/bookkeeper-daemon.sh?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9"},{"sha":"e3b06cc89e76e83ff6f6a3cac34a9bf0e6fd9382","filename":"hedwig-server/bin/hedwig","status":"modified","additions":15,"deletions":0,"changes":15,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/bin/hedwig","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/bin/hedwig","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/hedwig-server/bin/hedwig?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","patch":"@@ -113,6 +113,9 @@ Environment variables:\n    HEDWIG_CONSOLE_CLIENT_CONF   Client part configuration for hedwig console,\n                                 used for interacting with hub server.\n    HEDWIG_LOG_CONF              Log4j configuration file (default $DEFAULT_LOG_CONF)\n+   HEDWIG_ROOT_LOGGER           Root logger for hedwig\n+   HEDWIG_LOG_DIR               Log directory to store log files for hedwig server\n+   HEDWIG_LOG_FILE              Log file name\n    HEDWIG_EXTRA_OPTS            Extra options to be passed to the jvm\n \n These variable can also be set in conf/hwenv.sh\n@@ -148,6 +151,18 @@ OPTS=\"-cp $HEDWIG_CLASSPATH $OPTS $HEDWIG_EXTRA_OPTS\"\n # Disable ipv6 as it can cause issues\n OPTS=\"$OPTS -Djava.net.preferIPv4Stack=true\"\n \n+# log directory & file\n+HEDWIG_ROOT_LOGGER=${HEDWIG_ROOT_LOGGER:-\"INFO,CONSOLE\"}\n+HEDWIG_LOG_DIR=${HEDWIG_LOG_DIR:-\"$HW_HOME/logs\"}\n+HEDWIG_LOG_FILE=${HEDWIG_LOG_FILE:-\"hedwig-server.log\"}\n+\n+# Configure log configuration system properties\n+OPTS=\"$OPTS -Dhedwig.root.logger=$HEDWIG_ROOT_LOGGER\"\n+OPTS=\"$OPTS -Dhedwig.log.dir=$HEDWIG_LOG_DIR\"\n+OPTS=\"$OPTS -Dhedwig.log.file=$HEDWIG_LOG_FILE\"\n+\n+# Change to HW_HOME to support relative paths\n+cd \"$BK_HOME\"\n if [ $COMMAND == \"server\" ]; then\n     exec java $OPTS $JMX_ARGS org.apache.hedwig.server.netty.PubSubServer $HEDWIG_SERVER_CONF $@\n elif [ $COMMAND == \"console\" ]; then"},{"sha":"73eac6f8236645e72826fef21716c92c75836096","filename":"hedwig-server/bin/hedwig-daemon.sh","status":"added","additions":163,"deletions":0,"changes":163,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/bin/hedwig-daemon.sh","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/bin/hedwig-daemon.sh","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/hedwig-server/bin/hedwig-daemon.sh?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","patch":"@@ -0,0 +1,163 @@\n+#!/usr/bin/env bash\n+#\n+#/**\n+# * Licensed to the Apache Software Foundation (ASF) under one\n+# * or more contributor license agreements.  See the NOTICE file\n+# * distributed with this work for additional information\n+# * regarding copyright ownership.  The ASF licenses this file\n+# * to you under the Apache License, Version 2.0 (the\n+# * \"License\"); you may not use this file except in compliance\n+# * with the License.  You may obtain a copy of the License at\n+# *\n+# *     http://www.apache.org/licenses/LICENSE-2.0\n+# *\n+# * Unless required by applicable law or agreed to in writing, software\n+# * distributed under the License is distributed on an \"AS IS\" BASIS,\n+# * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# * See the License for the specific language governing permissions and\n+# * limitations under the License.\n+# */\n+\n+usage() {\n+    cat <<EOF\n+Usage: hedwig-daemon.sh (start|stop) <command> <args...>\n+where command is one of:\n+    server           Run the hedwig server\n+EOF\n+}\n+\n+\n+BINDIR=`dirname \"$0\"`\n+HEDWIG_HOME=`cd $BINDIR/..;pwd`\n+\n+if [ -f $HEDWIG_HOME/conf/hwenv.sh ]\n+then\n+ . $HEDWIG_HOME/conf/hwenv.sh\n+fi\n+\n+HEDWIG_LOG_DIR=${HEDWIG_LOG_DIR:-\"$HEDWIG_HOME/logs\"}\n+\n+HEDWIG_ROOT_LOGGER=${HEDWIG_ROOT_LOGGER:-'INFO,ROLLINGFILE'}\n+\n+HEDWIG_STOP_TIMEOUT=${HEDWIG_STOP_TIMEOUT:-30}\n+\n+HEDWIG_PID_DIR=${HEDWIG_PID_DIR:-$HEDWIG_HOME/bin}\n+\n+if [ $# -lt 2 ]\n+then\n+    echo \"Error: no enough arguments provided.\"\n+    usage\n+    exit 1\n+fi\n+\n+startStop=$1\n+shift\n+command=$1\n+shift\n+\n+case $command in\n+    (server)\n+        echo \"doing $startStop $command ...\"\n+        ;;\n+    (*)\n+        echo \"Error: unknown service name $command\"\n+        usage\n+        exit 1\n+        ;;\n+esac\n+\n+export HEDWIG_LOG_DIR=$HEDWIG_LOG_DIR\n+export HEDWIG_ROOT_LOGGER=$HEDWIG_ROOT_LOGGER\n+export HEDWIG_LOG_FILE=hedwig-$command-$HOSTNAME.log\n+\n+pid=$HEDWIG_PID_DIR/hedwig-$command.pid\n+out=$HEDWIG_LOG_DIR/hedwig-$command-$HOSTNAME.out\n+logfile=$HEDWIG_LOG_DIR/$HEDWIG_LOG_FILE\n+\n+rotate_out_log ()\n+{\n+    log=$1;\n+    num=5;\n+    if [ -n \"$2\" ]; then\n+       num=$2\n+    fi\n+    if [ -f \"$log\" ]; then # rotate logs\n+        while [ $num -gt 1 ]; do\n+            prev=`expr $num - 1`\n+            [ -f \"$log.$prev\" ] && mv \"$log.$prev\" \"$log.$num\"\n+            num=$prev\n+        done\n+        mv \"$log\" \"$log.$num\";\n+    fi\n+}\n+\n+mkdir -p \"$HEDWIG_LOG_DIR\"\n+\n+case $startStop in\n+  (start)\n+    if [ -f $pid ]; then\n+      if kill -0 `cat $pid` > /dev/null 2>&1; then\n+        echo $command running as process `cat $pid`.  Stop it first.\n+        exit 1\n+      fi\n+    fi\n+\n+    rotate_out_log $out\n+    echo starting $command, logging to $logfile\n+    hedwig=$HEDWIG_HOME/bin/hedwig\n+    nohup $hedwig $command \"$@\" > \"$out\" 2>&1 < /dev/null &\n+    echo $! > $pid\n+    sleep 1; head $out\n+    sleep 2;\n+    if ! ps -p $! > /dev/null ; then\n+      exit 1\n+    fi\n+    ;;\n+\n+  (stop)\n+    if [ -f $pid ]; then\n+      TARGET_PID=`cat $pid`\n+      if kill -0 $TARGET_PID > /dev/null 2>&1; then\n+        echo stopping $command\n+        kill $TARGET_PID\n+\n+        count=0\n+        location=$HEDWIG_LOG_DIR\n+        while ps -p $TARGET_PID > /dev/null;\n+         do\n+          echo \"Shutdown is in progress... Please wait...\"\n+          sleep 1\n+          count=`expr $count + 1`\n+         \n+          if [ \"$count\" = \"$HEDWIG_STOP_TIMEOUT\" ]; then\n+                break\n+          fi\n+         done\n+        \n+        if [ \"$count\" != \"$HEDWIG_STOP_TIMEOUT\" ]; then\n+                 echo \"Shutdown completed.\"\n+                exit 0\n+        fi\n+                 \n+        if kill -0 $TARGET_PID > /dev/null 2>&1; then\n+              fileName=$location/$command.out\n+              $JAVA_HOME/bin/jstack $TARGET_PID > $fileName\n+              echo Thread dumps are taken for analysis at $fileName\n+              echo forcefully stopping $command\n+              kill -9 $TARGET_PID >/dev/null 2>&1\n+              echo Successfully stopped the process\n+        fi\n+      else\n+        echo no $command to stop\n+      fi\n+      rm $pid\n+    else\n+      echo no $command to stop\n+    fi\n+    ;;\n+\n+  (*)\n+    usage\n+    exit 1\n+    ;;\n+esac"},{"sha":"a0aeb8442d2b2198c9efa0cb494482ea98490946","filename":"hedwig-server/conf/hwenv.sh","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/conf/hwenv.sh","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/conf/hwenv.sh","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/hedwig-server/conf/hwenv.sh?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","patch":"@@ -34,5 +34,14 @@\n # Log4j configuration file\n # HEDWIG_LOG_CONF=\n \n+# Logs location\n+# HEDWIG_LOG_DIR=\n+\n # Extra options to be passed to the jvm\n # HEDWIG_EXTRA_OPTS=\n+\n+#Folder where the hedwig server PID file should be stored\n+#HEDWIG_PID_DIR=\n+\n+#Wait time before forcefully kill the hedwig server instance, if the stop is not successful\n+#HEDWIG_STOP_TIMEOUT="},{"sha":"c0f1c49f1c4dca8270bd3cf9e686c1a3c6cf627c","filename":"hedwig-server/conf/log4j.properties","status":"modified","additions":10,"deletions":4,"changes":14,"blob_url":"https://github.com/apache/bookkeeper/blob/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/conf/log4j.properties","raw_url":"https://github.com/apache/bookkeeper/raw/0e06ddeb7e47bd8794fd378629602e41ea4a1fd9/hedwig-server/conf/log4j.properties","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/hedwig-server/conf/log4j.properties?ref=0e06ddeb7e47bd8794fd378629602e41ea4a1fd9","patch":"@@ -26,7 +26,13 @@\n # Format is \"<default threshold> (, <appender>)+\n \n # DEFAULT: console appender only\n-log4j.rootLogger=WARN, CONSOLE\n+# Define some default values that can be overridden by system properties\n+hedwig.root.logger=WARN,CONSOLE\n+hedwig.log.dir=.\n+hedwig.log.file=hedwig-server.log\n+hedwig.trace.file=hedwig-trace.log\n+\n+log4j.rootLogger=${hedwig.root.logger}\n \n # Example with rolling log file\n #log4j.rootLogger=DEBUG, CONSOLE, ROLLINGFILE\n@@ -47,12 +53,12 @@ log4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} - %-5p - [%t:%C{1}@%\n #    Log DEBUG level and above messages to a log file\n log4j.appender.ROLLINGFILE=org.apache.log4j.DailyRollingFileAppender\n log4j.appender.ROLLINGFILE.Threshold=INFO\n-log4j.appender.ROLLINGFILE.File=hedwig-server.log\n+log4j.appender.ROLLINGFILE.File=${hedwig.log.dir}/${hedwig.log.file}\n log4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayout\n log4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p - [%t:%C{1}@%L] - %m%n\n \n # Max log file size of 10MB\n-log4j.appender.ROLLINGFILE.MaxFileSize=10MB\n+#log4j.appender.ROLLINGFILE.MaxFileSize=10MB\n # uncomment the next line to limit number of backup files\n #log4j.appender.ROLLINGFILE.MaxBackupIndex=10\n \n@@ -65,7 +71,7 @@ log4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}\n #    Log DEBUG level and above messages to a log file\n log4j.appender.TRACEFILE=org.apache.log4j.FileAppender\n log4j.appender.TRACEFILE.Threshold=TRACE\n-log4j.appender.TRACEFILE.File=hedwig-trace.log\n+log4j.appender.TRACEFILE.File=${hedwig.log.dir}/${hedwig.trace.file}\n \n log4j.appender.TRACEFILE.layout=org.apache.log4j.PatternLayout\n ### Notice we are including log4j's NDC here (%x)"}]}

