{"sha":"36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","node_id":"MDY6Q29tbWl0MTU3NTk1NjozNmE0YTQxOTBjMzQyZDdiM2ExZDU4NTljNTQ1Y2ExZmMxYjcxM2Nm","commit":{"author":{"name":"Flavio Paiva Junqueira","email":"fpj@apache.org","date":"2012-05-09T07:16:05Z"},"committer":{"name":"Flavio Paiva Junqueira","email":"fpj@apache.org","date":"2012-05-09T07:16:05Z"},"message":"BOOKKEEPER-241: Add documentation for bookie entry log compaction (sijie via fpj)\n\n\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1335947 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"7ce6c6803cce03086873f7534f5a8ff8cc8f7ad1","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/7ce6c6803cce03086873f7534f5a8ff8cc8f7ad1"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","html_url":"https://github.com/apache/bookkeeper/commit/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/comments","author":{"login":"fpj","id":572920,"node_id":"MDQ6VXNlcjU3MjkyMA==","avatar_url":"https://avatars.githubusercontent.com/u/572920?v=4","gravatar_id":"","url":"https://api.github.com/users/fpj","html_url":"https://github.com/fpj","followers_url":"https://api.github.com/users/fpj/followers","following_url":"https://api.github.com/users/fpj/following{/other_user}","gists_url":"https://api.github.com/users/fpj/gists{/gist_id}","starred_url":"https://api.github.com/users/fpj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fpj/subscriptions","organizations_url":"https://api.github.com/users/fpj/orgs","repos_url":"https://api.github.com/users/fpj/repos","events_url":"https://api.github.com/users/fpj/events{/privacy}","received_events_url":"https://api.github.com/users/fpj/received_events","type":"User","site_admin":false},"committer":{"login":"fpj","id":572920,"node_id":"MDQ6VXNlcjU3MjkyMA==","avatar_url":"https://avatars.githubusercontent.com/u/572920?v=4","gravatar_id":"","url":"https://api.github.com/users/fpj","html_url":"https://github.com/fpj","followers_url":"https://api.github.com/users/fpj/followers","following_url":"https://api.github.com/users/fpj/following{/other_user}","gists_url":"https://api.github.com/users/fpj/gists{/gist_id}","starred_url":"https://api.github.com/users/fpj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fpj/subscriptions","organizations_url":"https://api.github.com/users/fpj/orgs","repos_url":"https://api.github.com/users/fpj/repos","events_url":"https://api.github.com/users/fpj/events{/privacy}","received_events_url":"https://api.github.com/users/fpj/received_events","type":"User","site_admin":false},"parents":[{"sha":"a7d658179db3226dc33d53f4d25afd64ea90c061","url":"https://api.github.com/repos/apache/bookkeeper/commits/a7d658179db3226dc33d53f4d25afd64ea90c061","html_url":"https://github.com/apache/bookkeeper/commit/a7d658179db3226dc33d53f4d25afd64ea90c061"}],"stats":{"total":25,"additions":25,"deletions":0},"files":[{"sha":"fd5937710f991391eda300f8f4661b3c311eba10","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","patch":"@@ -150,6 +150,8 @@ Trunk (unreleased changes)\n \n \tBOOKKEEPER-173: Uncontrolled number of threads in bookkeeper (sijie via fpj)\n \n+\tBOOKKEEPER-241: Add documentation for bookie entry log compaction (sijie via fpj)\n+\n       hedwig-server/\n \n         BOOKKEEPER-77: Add a console client for hedwig (Sijie Guo via ivank)"},{"sha":"3717433d7cd4e0df4b21e7ea89816755b4f4a30f","filename":"doc/bookieConfigParams.textile","status":"modified","additions":5,"deletions":0,"changes":5,"blob_url":"https://github.com/apache/bookkeeper/blob/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/doc/bookieConfigParams.textile","raw_url":"https://github.com/apache/bookkeeper/raw/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/doc/bookieConfigParams.textile","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/doc/bookieConfigParams.textile?ref=36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","patch":"@@ -43,4 +43,9 @@ h3. Ledger manager settings\n | @ledgerManagerType@ | What kind of ledger manager is used to manage how ledgers are stored, managed and garbage collected. See \"BookKeeper Internals\":./bookkeeperInternals.html for detailed info. Default is flat. |\n | @zkLedgersRootPath@ | Root zookeeper path to store ledger metadata. Default is /ledgers. |\n \n+h3. Entry Log compaction settings\n \n+| @minorCompactionInterval@ | Interval to run minor compaction, in seconds. If it is set to less than or equal to zero, then minor compaction is disabled. Default is 1 hour. |\n+| @minorCompactionThreshold@ | Entry log files with remaining size under this threshold value will be compacted in a minor compaction. If it is set to less than or equal to zero, the minor compaction is disabled. Default is 0.2 |\n+| @majorCompactionInterval@ | Interval to run major compaction, in seconds. If it is set to less than or equal to zero, then major compaction is disabled. Default is 1 day. |\n+| @majorCompactionThreshold@ | Entry log files with remaining size below this threshold value will be compacted in a major compaction. Those entry log files whose remaining size percentage is still higher than the threshold value will never be compacted. If it is set to less than or equal to zero, the major compaction is disabled. Default is 0.8. |"},{"sha":"87ba67287e27c8483e64381486aa814c09db062c","filename":"doc/bookkeeperOverview.textile","status":"modified","additions":18,"deletions":0,"changes":18,"blob_url":"https://github.com/apache/bookkeeper/blob/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/doc/bookkeeperOverview.textile","raw_url":"https://github.com/apache/bookkeeper/raw/36a4a4190c342d7b3a1d5859c545ca1fc1b713cf/doc/bookkeeperOverview.textile","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/doc/bookkeeperOverview.textile?ref=36a4a4190c342d7b3a1d5859c545ca1fc1b713cf","patch":"@@ -165,3 +165,21 @@ p. Using the above data flush mechanism, it is safe for the _Sync Thread_ to ski\n p. As described above, _EntryLogger#flush_ is invoked in the following two cases:\n * in _Sync Thread_ : used to ensure entries added before _LastLogMark_ are persisted to disk.\n * in _ShutDown_ : used to ensure its buffered data persisted to disk to avoid data corruption with partial entries.\n+\n+h2. Data Compaction\n+\n+p. In bookie server, entries of different ledgers are interleaved in entry log files. A bookie server runs a _Garbage Collector_ thread to delete un-associated entry log files to reclaim disk space. If a given entry log file contains entries from a ledger that has not been deleted, then the entry log file would never be removed and the occupied disk space never reclaimed. In order to avoid such a case, a bookie server compacts entry log files in _Garbage Collector_ thread to reclaim disk space.\n+\n+p. There are two kinds of compaction running with different frequency, which are _Minor Compaction_ and _Major Compaction_. The differences of _Minor Compaction_ and _Major Compaction_ are just their threshold value and compaction interval.\n+\n+# _Threshold_ : Size percentage of an entry log file occupied by those undeleted ledgers. Default minor compaction threshold is 0.2, while major compaction threshold is 0.8.\n+# _Interval_ : How long to run the compaction. Default minor compaction is 1 hour, while major compaction threshold is 1 day.\n+\n+p. NOTE: if either _Threshold_ or _Interval_ is set to less than or equal to zero, then compaction is disabled.\n+\n+p. The data compaction flow in _Garbage Collector Thread_ is as follows:\n+\n+# _Garbage Collector_ thread scans entry log files to get their entry log metadata, which records a list of ledgers comprising an entry log and their corresponding percentages.\n+# With the normal garbage collection flow, once the bookie determines that a ledger has been deleted, the ledger will be removed from the entry log metadata and the size of the entry log reduced.\n+# If the remaining size of an entry log file reaches a specified threshold, the entries of active ledgers in the entry log will be copied to a new entry log file.\n+# Once all valid entries have been copied, the old entry log file is deleted."}]}

