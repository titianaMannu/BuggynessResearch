{"sha":"3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","node_id":"MDY6Q29tbWl0MTU3NTk1NjozZDliYjIwYTdmN2U1MTBiY2U3YzE2YmUzOTJjMGFjODJjM2EzNDk2","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-10-02T04:54:35Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-10-02T04:54:35Z"},"message":"BOOKKEEPER-645: Bookkeeper shell command to get a list of readonly bookies (rakesh via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1528306 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"a1cf823f5e7eac140e13e12e07c01312080cc58c","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/a1cf823f5e7eac140e13e12e07c01312080cc58c"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","html_url":"https://github.com/apache/bookkeeper/commit/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"e2013e3f2b2e3e10ce5d1977adac8e073fd0404d","url":"https://api.github.com/repos/apache/bookkeeper/commits/e2013e3f2b2e3e10ce5d1977adac8e073fd0404d","html_url":"https://github.com/apache/bookkeeper/commit/e2013e3f2b2e3e10ce5d1977adac8e073fd0404d"}],"stats":{"total":38,"additions":31,"deletions":7},"files":[{"sha":"7a44519a4e1abbbf6f9fe2050bea281f566808f2","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","patch":"@@ -158,6 +158,8 @@ Trunk (unreleased changes)\n \n       BOOKKEEPER-666: Naming threads of ExecutorService (rakesh via sijie)\n \n+      BOOKKEEPER-645: Bookkeeper shell command to get a list of readonly bookies (rakesh via sijie)\n+\n     NEW FEATURE:\n \n       BOOKKEEPER-562: Ability to tell if a ledger is closed or not (fpj)"},{"sha":"8f680297a5e2d49fb8dba3bdf50782266f1d2b2b","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","status":"modified","additions":29,"deletions":7,"changes":36,"blob_url":"https://github.com/apache/bookkeeper/blob/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","raw_url":"https://github.com/apache/bookkeeper/raw/3d9bb20a7f7e510bce7c16be392c0ac82c3a3496/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=3d9bb20a7f7e510bce7c16be392c0ac82c3a3496","patch":"@@ -23,6 +23,8 @@\n import java.io.IOException;\n import java.net.InetSocketAddress;\n import java.nio.ByteBuffer;\n+import java.util.ArrayList;\n+import java.util.Collection;\n import java.util.Formatter;\n import java.util.HashMap;\n import java.util.Map;\n@@ -34,7 +36,6 @@\n \n import org.apache.bookkeeper.bookie.EntryLogger.EntryLogScanner;\n import org.apache.bookkeeper.bookie.Journal.JournalScanner;\n-import org.apache.bookkeeper.bookie.Journal.LastLogMark;\n import org.apache.bookkeeper.client.BKException;\n import org.apache.bookkeeper.client.BookKeeperAdmin;\n import org.apache.bookkeeper.conf.ClientConfiguration;\n@@ -483,17 +484,38 @@ public void printUsage() {\n \n         ListBookiesCmd() {\n             super(CMD_LISTBOOKIES);\n-            opts.addOption(\"h\", \"hostnames\", false, \"Also print hostnames\");\n+            opts.addOption(\"rw\", \"readwrite\", false, \"Print readwrite bookies\");\n+            opts.addOption(\"ro\", \"readonly\", false, \"Print readonly bookies\");\n+            opts.addOption(\"h\", \"hostnames\", false,\n+                    \"Also print hostname of the bookie\");\n         }\n \n         @Override\n         public int runCmd(CommandLine cmdLine) throws Exception {\n+            boolean readwrite = cmdLine.hasOption(\"rw\");\n+            boolean readonly = cmdLine.hasOption(\"ro\");\n+\n+            if ((!readwrite && !readonly) || (readwrite && readonly)) {\n+                LOG.error(\"One and only one of -readwrite and -readonly must be specified\");\n+                printUsage();\n+                return 1;\n+            }\n             ClientConfiguration clientconf = new ClientConfiguration(bkConf)\n                 .setZkServers(bkConf.getZkServers());\n             BookKeeperAdmin bka = new BookKeeperAdmin(clientconf);\n \n             int count = 0;\n-            for (InetSocketAddress b : bka.getAvailableBookies()) {\n+            Collection<InetSocketAddress> bookies = new ArrayList<InetSocketAddress>();\n+            if (cmdLine.hasOption(\"rw\")) {\n+                Collection<InetSocketAddress> availableBookies = bka\n+                        .getAvailableBookies();\n+                bookies.addAll(availableBookies);\n+            } else if (cmdLine.hasOption(\"ro\")) {\n+                Collection<InetSocketAddress> roBookies = bka\n+                        .getReadOnlyBookies();\n+                bookies.addAll(roBookies);\n+            }\n+            for (InetSocketAddress b : bookies) {\n                 System.out.print(StringUtils.addrToString(b));\n                 if (cmdLine.hasOption(\"h\")) {\n                     System.out.print(\"\\t\" + b.getHostName());\n@@ -502,20 +524,20 @@ public int runCmd(CommandLine cmdLine) throws Exception {\n                 count++;\n             }\n             if (count == 0) {\n-                System.err.println(\"No bookies available\");\n+                System.err.println(\"No bookie exists!\");\n                 return 1;\n             }\n             return 0;\n         }\n \n         @Override\n         String getDescription() {\n-            return \"List all available bookies.\";\n+            return \"List the bookies, which are running as either readwrite or readonly mode.\";\n         }\n \n         @Override\n         String getUsage() {\n-            return \"listbookies [-hostnames]\";\n+            return \"listbookies [-readwrite|-readonly] [-hostnames]\";\n         }\n \n         @Override\n@@ -659,7 +681,7 @@ private static void printShellUsage() {\n         System.err.println(\"       readlog      [-msg] <entry_log_id|entry_log_file_name>\");\n         System.err.println(\"       readjournal  [-msg] <journal_id|journal_file_name>\");\n         System.err.println(\"       autorecovery [-enable|-disable]\");\n-        System.err.println(\"       listbookies  [-hostnames]\");\n+        System.err.println(\"       listbookies  [-readwrite|-readonly] [-hostnames]\");\n         System.err.println(\"       lastmark\");\n         System.err.println(\"       help\");\n     }"}]}

