{"sha":"4c27506835dd0a58ee0a37c4422c44237a344b30","node_id":"MDY6Q29tbWl0MTU3NTk1Njo0YzI3NTA2ODM1ZGQwYTU4ZWUwYTM3YzQ0MjJjNDQyMzdhMzQ0YjMw","commit":{"author":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2014-05-06T10:30:54Z"},"committer":{"name":"Ivan Brendan Kelly","email":"ivank@apache.org","date":"2014-05-06T10:30:54Z"},"message":"BOOKKEEPER-744: Run the auditor bookie check periodically (ivank)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1592705 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"d259c1be237ff2b7ec2ad0d884708f0654427c9f","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/d259c1be237ff2b7ec2ad0d884708f0654427c9f"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/4c27506835dd0a58ee0a37c4422c44237a344b30","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/4c27506835dd0a58ee0a37c4422c44237a344b30","html_url":"https://github.com/apache/bookkeeper/commit/4c27506835dd0a58ee0a37c4422c44237a344b30","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/4c27506835dd0a58ee0a37c4422c44237a344b30/comments","author":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"committer":{"login":"ivankelly","id":54955,"node_id":"MDQ6VXNlcjU0OTU1","avatar_url":"https://avatars.githubusercontent.com/u/54955?v=4","gravatar_id":"","url":"https://api.github.com/users/ivankelly","html_url":"https://github.com/ivankelly","followers_url":"https://api.github.com/users/ivankelly/followers","following_url":"https://api.github.com/users/ivankelly/following{/other_user}","gists_url":"https://api.github.com/users/ivankelly/gists{/gist_id}","starred_url":"https://api.github.com/users/ivankelly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ivankelly/subscriptions","organizations_url":"https://api.github.com/users/ivankelly/orgs","repos_url":"https://api.github.com/users/ivankelly/repos","events_url":"https://api.github.com/users/ivankelly/events{/privacy}","received_events_url":"https://api.github.com/users/ivankelly/received_events","type":"User","site_admin":false},"parents":[{"sha":"5c18886657c88f48672554c0f814cf6418ad1e18","url":"https://api.github.com/repos/apache/bookkeeper/commits/5c18886657c88f48672554c0f814cf6418ad1e18","html_url":"https://github.com/apache/bookkeeper/commit/5c18886657c88f48672554c0f814cf6418ad1e18"}],"stats":{"total":53,"additions":50,"deletions":3},"files":[{"sha":"ae82753d19427e39bd72a68f1f9832c71f49fea7","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/4c27506835dd0a58ee0a37c4422c44237a344b30/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/4c27506835dd0a58ee0a37c4422c44237a344b30/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=4c27506835dd0a58ee0a37c4422c44237a344b30","patch":"@@ -184,6 +184,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-716: padding writes for bookie journal (sijie via ivank)\n \n+        BOOKKEEPER-744: Run the auditor bookie check periodically (ivank)\n+\n       hedwig-server:\n \n         BOOKKEEPER-601: readahead cache size isn't updated correctly (sijie via fpj)"},{"sha":"43fa88a42a87eae58c2b8d3e8cb0ad6a55c3e4fc","filename":"bookkeeper-server/conf/bk_server.conf","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/apache/bookkeeper/blob/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/conf/bk_server.conf","raw_url":"https://github.com/apache/bookkeeper/raw/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/conf/bk_server.conf","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/conf/bk_server.conf?ref=4c27506835dd0a58ee0a37c4422c44237a344b30","patch":"@@ -244,6 +244,15 @@ zkTimeout=10000\n # not be run more frequently than once a day.\n #auditorPeriodicCheckInterval=604800\n \n+# The interval between auditor bookie checks.\n+# The auditor bookie check, checks ledger metadata to see which bookies should\n+# contain entries for each ledger. If a bookie which should contain entries is\n+# unavailable, then the ledger containing that entry is marked for recovery.\n+# Setting this to 0 disabled the periodic check. Bookie checks will still\n+# run when a bookie fails.\n+# The interval is specified in seconds.\n+#auditorPeriodicBookieCheckInterval=84600\n+\n # number of threads that should handle write requests. if zero, the writes would\n # be handled by netty threads directly.\n # numAddWorkerThreads=1"},{"sha":"720cdb79c38f2b3687c91c688bdff43ce55cbeb2","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java","status":"modified","additions":24,"deletions":0,"changes":24,"blob_url":"https://github.com/apache/bookkeeper/blob/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java","raw_url":"https://github.com/apache/bookkeeper/raw/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ServerConfiguration.java?ref=4c27506835dd0a58ee0a37c4422c44237a344b30","patch":"@@ -86,6 +86,7 @@\n     protected final static String DISK_USAGE_WARN_THRESHOLD = \"diskUsageWarnThreshold\";\n     protected final static String DISK_CHECK_INTERVAL = \"diskCheckInterval\";\n     protected final static String AUDITOR_PERIODIC_CHECK_INTERVAL = \"auditorPeriodicCheckInterval\";\n+    protected final static String AUDITOR_PERIODIC_BOOKIE_CHECK_INTERVAL = \"auditorPeriodicBookieCheckInterval\";\n     protected final static String AUTO_RECOVERY_DAEMON_ENABLED = \"autoRecoveryDaemonEnabled\";\n \n     // Worker Thread parameters.\n@@ -1161,6 +1162,29 @@ public long getAuditorPeriodicCheckInterval() {\n         return getLong(AUDITOR_PERIODIC_CHECK_INTERVAL, 604800);\n     }\n \n+    /**\n+     * Set the interval between auditor bookie checks.\n+     * The auditor bookie check, checks ledger metadata to see which bookies\n+     * contain entries for each ledger. If a bookie which should contain entries\n+     * is unavailable, then the ledger containing that entry is marked for recovery.\n+     * Setting this to 0 disabled the periodic check. Bookie checks will still\n+     * run when a bookie fails.\n+     *\n+     * @param interval The period in seconds.\n+     */\n+    public void setAuditorPeriodicBookieCheckInterval(long interval) {\n+        setProperty(AUDITOR_PERIODIC_BOOKIE_CHECK_INTERVAL, interval);\n+    }\n+\n+    /**\n+     * Get the interval between auditor bookie check runs.\n+     * @see #setAuditorPeriodicBookieCheckInterval(long)\n+     * @return the interval between bookie check runs, in seconds. Default is 84600 (= 1 day)\n+     */\n+    public long getAuditorPeriodicBookieCheckInterval() {\n+        return getLong(AUDITOR_PERIODIC_BOOKIE_CHECK_INTERVAL, 84600);\n+    }\n+\n     /**\n      * Sets that whether the auto-recovery service can start along with Bookie\n      * server itself or not"},{"sha":"6da944512f9cc339ebadf16f6fe436b715cb66d5","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/replication/Auditor.java","status":"modified","additions":15,"deletions":3,"changes":18,"blob_url":"https://github.com/apache/bookkeeper/blob/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/src/main/java/org/apache/bookkeeper/replication/Auditor.java","raw_url":"https://github.com/apache/bookkeeper/raw/4c27506835dd0a58ee0a37c4422c44237a344b30/bookkeeper-server/src/main/java/org/apache/bookkeeper/replication/Auditor.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/replication/Auditor.java?ref=4c27506835dd0a58ee0a37c4422c44237a344b30","patch":"@@ -195,8 +195,10 @@ public void start() {\n             }\n \n             long interval = conf.getAuditorPeriodicCheckInterval();\n+\n             if (interval > 0) {\n-                LOG.info(\"Periodic checking enabled\");\n+                LOG.info(\"Auditor periodic ledger checking enabled\"\n+                         + \" 'auditorPeriodicCheckInterval' {} seconds\", interval);\n                 executor.scheduleAtFixedRate(new Runnable() {\n                         public void run() {\n                             LOG.info(\"Running periodic check\");\n@@ -229,7 +231,7 @@ public void run() {\n                 LOG.info(\"Periodic checking disabled\");\n             }\n \n-            executor.submit(new Runnable() {\n+            Runnable bookieCheck = new Runnable() {\n                     public void run() {\n                         try {\n                             knownBookies = getAvailableBookies();\n@@ -249,7 +251,17 @@ public void run() {\n                             submitShutdownTask();\n                         }\n                     }\n-                });\n+                };\n+\n+            long bookieCheckInterval = conf.getAuditorPeriodicBookieCheckInterval();\n+            if (bookieCheckInterval == 0) {\n+                LOG.info(\"Auditor periodic bookie checking disabled, running once check now anyhow\");\n+                executor.submit(bookieCheck);\n+            } else {\n+                LOG.info(\"Auditor periodic bookie checking enabled\"\n+                         + \" 'auditorPeriodicBookieCheckInterval' {} seconds\", bookieCheckInterval);\n+                executor.scheduleAtFixedRate(bookieCheck, 0, bookieCheckInterval, TimeUnit.SECONDS);\n+            }\n         }\n     }\n "}]}

