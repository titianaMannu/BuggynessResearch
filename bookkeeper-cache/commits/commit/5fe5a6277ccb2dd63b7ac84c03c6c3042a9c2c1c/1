{"sha":"5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c","node_id":"MDY6Q29tbWl0MTU3NTk1Njo1ZmU1YTYyNzdjY2IyZGQ2M2I3YWM4NGMwM2M2YzMwNDJhOWMyYzFj","commit":{"author":{"name":"Charan Reddy Guttapalem","email":"reddycharan18@gmail.com","date":"2018-10-09T00:54:30Z"},"committer":{"name":"Sijie Guo","email":"guosijie@gmail.com","date":"2018-10-09T00:54:30Z"},"message":"ReadEntryCallback in ReadLedgerEntriesCmd shouldn't release buffer.\n\n\r\n\r\nDescriptions of the changes in this PR:\r\n\r\n- ReadEntryCallback in ReadLedgerEntriesCmd shouldn't release buffer,\r\nwhich is not owned by the callback.\r\n\r\n### Motivation\r\n\r\nwith the following change, Per channel bookie clients owns the buffer for read responses. So it is not correct for ReadEntryCallback in ReadLedgerEntriesCmd to release buffer\r\nhttps://github.com/apache/bookkeeper/commit/8d048abce486c63d428041f77ee9a506756f4d1e#diff-e50ee2c1aec1539ea185a94605b0e550R1611\r\n\r\nbecause of this issue I'm seeing following error with ReadLedgerEntriesCmd\r\n```\r\n/Workspace/SFStorage/bookkeeper/bookkeeper-server/bin$ ./bookkeeper shell -localbookie readledger -bookie ****  -ledgerid 00000000-0000-0000-0000-000000000003 -firstentryid 1 -lastentryid 3\r\nJAVA_HOME not set, using java from PATH. (/usr/bin/java)\r\n\r\n--------- Lid=00000000-0000-0000-0000-000000000003, Eid=1 ---------\r\n18:32:03,724 ERROR Unexpected throwable caught \r\nio.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1\r\n\tat io.netty.buffer.AbstractReferenceCountedByteBuf.release0(AbstractReferenceCountedByteBuf.java:100) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:84) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat org.apache.bookkeeper.proto.PerChannelBookieClient$ReadCompletion.handleV3Response(PerChannelBookieClient.java:1699) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat org.apache.bookkeeper.proto.PerChannelBookieClient$3.safeRun(PerChannelBookieClient.java:1286) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [bookkeeper-common-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]\r\n\r\n--------- Lid=00000000-0000-0000-0000-000000000003, Eid=2 ---------\r\n\r\n18:32:03,733 ERROR Unexpected throwable caught \r\nio.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1\r\n\tat io.netty.buffer.AbstractReferenceCountedByteBuf.release0(AbstractReferenceCountedByteBuf.java:100) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:84) ~[netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat org.apache.bookkeeper.proto.PerChannelBookieClient$ReadCompletion.handleV3Response(PerChannelBookieClient.java:1699) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat org.apache.bookkeeper.proto.PerChannelBookieClient$3.safeRun(PerChannelBookieClient.java:1286) ~[bookkeeper-server-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat org.apache.bookkeeper.common.util.SafeRunnable.run(SafeRunnable.java:36) [bookkeeper-common-4.7.0-SNAPSHOT.jar:4.7.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.22.Final.jar:4.1.22.Final]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]\r\n```\n\nAuthor: cguttapalem <cguttapalem@salesforce.com>\n\nReviewers: Sijie Guo <sijie@apache.org>, Enrico Olivelli <eolivelli@gmail.com>, Andrey Yegorov <None>\n\nThis closes #1736 from reddycharan/readledgerfix","tree":{"sha":"4f50c22d2b20fa933bc1cc4d25b4d954365924da","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/4f50c22d2b20fa933bc1cc4d25b4d954365924da"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c","html_url":"https://github.com/apache/bookkeeper/commit/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c/comments","author":{"login":"reddycharan","id":13989266,"node_id":"MDQ6VXNlcjEzOTg5MjY2","avatar_url":"https://avatars.githubusercontent.com/u/13989266?v=4","gravatar_id":"","url":"https://api.github.com/users/reddycharan","html_url":"https://github.com/reddycharan","followers_url":"https://api.github.com/users/reddycharan/followers","following_url":"https://api.github.com/users/reddycharan/following{/other_user}","gists_url":"https://api.github.com/users/reddycharan/gists{/gist_id}","starred_url":"https://api.github.com/users/reddycharan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reddycharan/subscriptions","organizations_url":"https://api.github.com/users/reddycharan/orgs","repos_url":"https://api.github.com/users/reddycharan/repos","events_url":"https://api.github.com/users/reddycharan/events{/privacy}","received_events_url":"https://api.github.com/users/reddycharan/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"df6595804cb1d78f5b531ae2db3a7c751439eb1c","url":"https://api.github.com/repos/apache/bookkeeper/commits/df6595804cb1d78f5b531ae2db3a7c751439eb1c","html_url":"https://github.com/apache/bookkeeper/commit/df6595804cb1d78f5b531ae2db3a7c751439eb1c"}],"stats":{"total":1,"additions":0,"deletions":1},"files":[{"sha":"2829a730d3ef22d4b89e0e432ad86b1b4bc88b02","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/apache/bookkeeper/blob/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","raw_url":"https://github.com/apache/bookkeeper/raw/5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/BookieShell.java?ref=5fe5a6277ccb2dd63b7ac84c03c6c3042a9c2c1c","patch":"@@ -854,7 +854,6 @@ int runCmd(CommandLine cmdLine) throws Exception {\n                                     System.out.println(\"Data: \" + ByteBufUtil.prettyHexDump(buffer));\n                                 }\n \n-                                buffer.release();\n                                 future.complete(null);\n                                 }, null, BookieProtocol.FLAG_NONE);\n "}]}

