{"sha":"8f0bed9f8401001abd683c420757610996cf96d8","node_id":"MDY6Q29tbWl0MTU3NTk1Njo4ZjBiZWQ5Zjg0MDEwMDFhYmQ2ODNjNDIwNzU3NjEwOTk2Y2Y5NmQ4","commit":{"author":{"name":"Charan Reddy Guttapalem","email":"cguttapalem@salesforce.com","date":"2016-11-09T07:44:54Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2016-11-09T07:44:54Z"},"message":"BOOKKEEPER-957: LedgerHandleAdv fixes\n\n- making addToLength call synchronized\n- adding op to pendingAddOps after doing sanity check\n\nAuthor: Charan Reddy Guttapalem <cguttapalem@salesforce.com>\n\nReviewers: Sijie Guo <sijie@apache.org>\n\nCloses #65 from reddycharan/ledgerhandleadvfix","tree":{"sha":"cf84872bc569d3c8b079878dad7a09ded3a185ba","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/cf84872bc569d3c8b079878dad7a09ded3a185ba"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/8f0bed9f8401001abd683c420757610996cf96d8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/8f0bed9f8401001abd683c420757610996cf96d8","html_url":"https://github.com/apache/bookkeeper/commit/8f0bed9f8401001abd683c420757610996cf96d8","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/8f0bed9f8401001abd683c420757610996cf96d8/comments","author":{"login":"reddycharan","id":13989266,"node_id":"MDQ6VXNlcjEzOTg5MjY2","avatar_url":"https://avatars.githubusercontent.com/u/13989266?v=4","gravatar_id":"","url":"https://api.github.com/users/reddycharan","html_url":"https://github.com/reddycharan","followers_url":"https://api.github.com/users/reddycharan/followers","following_url":"https://api.github.com/users/reddycharan/following{/other_user}","gists_url":"https://api.github.com/users/reddycharan/gists{/gist_id}","starred_url":"https://api.github.com/users/reddycharan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reddycharan/subscriptions","organizations_url":"https://api.github.com/users/reddycharan/orgs","repos_url":"https://api.github.com/users/reddycharan/repos","events_url":"https://api.github.com/users/reddycharan/events{/privacy}","received_events_url":"https://api.github.com/users/reddycharan/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"cc3d2701687ce1a4ff14502e2214a381b43aed5f","url":"https://api.github.com/repos/apache/bookkeeper/commits/cc3d2701687ce1a4ff14502e2214a381b43aed5f","html_url":"https://github.com/apache/bookkeeper/commit/cc3d2701687ce1a4ff14502e2214a381b43aed5f"}],"stats":{"total":23,"additions":17,"deletions":6},"files":[{"sha":"4cdcdca6b35881890ba27f6756cf2d88c8f943d4","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandleAdv.java","status":"modified","additions":17,"deletions":6,"changes":23,"blob_url":"https://github.com/apache/bookkeeper/blob/8f0bed9f8401001abd683c420757610996cf96d8/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandleAdv.java","raw_url":"https://github.com/apache/bookkeeper/raw/8f0bed9f8401001abd683c420757610996cf96d8/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandleAdv.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandleAdv.java?ref=8f0bed9f8401001abd683c420757610996cf96d8","patch":"@@ -150,9 +150,7 @@ public void asyncAddEntry(final long entryId, final byte[] data, final int offse\n             cb.addComplete(BKException.Code.DuplicateEntryIdException,\n                     LedgerHandleAdv.this, entryId, ctx);\n             return;\n-        }\n-        pendingAddOps.add(op);\n-\n+        }       \n         doAsyncAddEntry(op, data, offset, length, cb, ctx);\n     }\n \n@@ -174,7 +172,22 @@ void doAsyncAddEntry(final PendingAddOp op, final byte[] data, final int offset,\n             throttler.acquire();\n         }\n \n-        if (metadata.isClosed()) {\n+        final long currentLength;\n+        boolean wasClosed = false;\n+        synchronized (this) {\n+            // synchronized on this to ensure that\n+            // the ledger isn't closed between checking and\n+            // updating lastAddPushed\n+            if (metadata.isClosed()) {\n+                wasClosed = true;\n+                currentLength = 0;\n+            } else {\n+                currentLength = addToLength(length);\n+                pendingAddOps.add(op);\n+            }\n+        }\n+\n+        if (wasClosed) {\n             // make sure the callback is triggered in main worker pool\n             try {\n                 bk.mainWorkerPool.submit(new SafeRunnable() {\n@@ -197,8 +210,6 @@ public String toString() {\n         }\n \n         try {\n-            final long currentLength = addToLength(length);\n-\n             bk.mainWorkerPool.submit(new SafeRunnable() {\n                 @Override\n                 public void safeRun() {"}]}

