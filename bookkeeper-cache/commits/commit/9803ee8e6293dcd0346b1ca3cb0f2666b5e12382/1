{"sha":"9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","node_id":"MDY6Q29tbWl0MTU3NTk1Njo5ODAzZWU4ZTYyOTNkY2QwMzQ2YjFjYTNjYjBmMjY2NmI1ZTEyMzgy","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2015-10-10T16:38:11Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2015-10-10T16:38:11Z"},"message":"BOOKKEEPER-872: Resource leak with unclosed LedgerManager in HierarchicalLedgerManagerFactory#format() (Ted Yu via sijie)","tree":{"sha":"2ae191fe833fd4351a528524fb239b7192895eaa","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/2ae191fe833fd4351a528524fb239b7192895eaa"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","html_url":"https://github.com/apache/bookkeeper/commit/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"885cebf113ea104dc579f93d6e112825a3bf1959","url":"https://api.github.com/repos/apache/bookkeeper/commits/885cebf113ea104dc579f93d6e112825a3bf1959","html_url":"https://github.com/apache/bookkeeper/commit/885cebf113ea104dc579f93d6e112825a3bf1959"}],"stats":{"total":34,"additions":22,"deletions":12},"files":[{"sha":"3e91989f92cd9c1f2d050032016bdf46358eb0ac","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","patch":"@@ -44,6 +44,8 @@ Trunk (unreleased changes)\n \n       BOOKKEEPER-826: PendingAddOp is ignoring ack response after meet ack quorum constraint (sijie)\n \n+      BOOKKEEPER-872: Resource leak with unclosed LedgerManager in HierarchicalLedgerManagerFactory#format() (Ted Yu via sijie)\n+\n     IMPROVEMENTS:\n \n       BOOKKEEPER-800: Expose whether a ledger is closed or not (ivank)"},{"sha":"78a1867c5d2d888ea49e35ab9ad27e83239ae0e0","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/FlatLedgerManagerFactory.java","status":"modified","additions":10,"deletions":6,"changes":16,"blob_url":"https://github.com/apache/bookkeeper/blob/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/FlatLedgerManagerFactory.java","raw_url":"https://github.com/apache/bookkeeper/raw/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/FlatLedgerManagerFactory.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/FlatLedgerManagerFactory.java?ref=9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","patch":"@@ -83,13 +83,17 @@ public LedgerUnderreplicationManager newLedgerUnderreplicationManager()\n     public void format(AbstractConfiguration conf, ZooKeeper zk)\n             throws InterruptedException, KeeperException, IOException {\n         FlatLedgerManager ledgerManager = (FlatLedgerManager) newLedgerManager();\n-        String ledgersRootPath = conf.getZkLedgersRootPath();\n-        List<String> children = zk.getChildren(ledgersRootPath, false);\n-        for (String child : children) {\n-            if (ledgerManager.isSpecialZnode(child)) {\n-                continue;\n+        try {\n+            String ledgersRootPath = conf.getZkLedgersRootPath();\n+            List<String> children = zk.getChildren(ledgersRootPath, false);\n+            for (String child : children) {\n+                if (ledgerManager.isSpecialZnode(child)) {\n+                    continue;\n+                }\n+                ZKUtil.deleteRecursive(zk, ledgersRootPath + \"/\" + child);\n             }\n-            ZKUtil.deleteRecursive(zk, ledgersRootPath + \"/\" + child);\n+        } finally {\n+            ledgerManager.close();\n         }\n         // Delete and recreate the LAYOUT information.\n         super.format(conf, zk);"},{"sha":"dac9e965b0619d3201b6ebec95f560766a5c52c0","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/HierarchicalLedgerManagerFactory.java","status":"modified","additions":10,"deletions":6,"changes":16,"blob_url":"https://github.com/apache/bookkeeper/blob/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/HierarchicalLedgerManagerFactory.java","raw_url":"https://github.com/apache/bookkeeper/raw/9803ee8e6293dcd0346b1ca3cb0f2666b5e12382/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/HierarchicalLedgerManagerFactory.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/meta/HierarchicalLedgerManagerFactory.java?ref=9803ee8e6293dcd0346b1ca3cb0f2666b5e12382","patch":"@@ -83,13 +83,17 @@ public LedgerUnderreplicationManager newLedgerUnderreplicationManager()\n     public void format(AbstractConfiguration conf, ZooKeeper zk)\n             throws InterruptedException, KeeperException, IOException {\n         HierarchicalLedgerManager ledgerManager = (HierarchicalLedgerManager) newLedgerManager();\n-        String ledgersRootPath = conf.getZkLedgersRootPath();\n-        List<String> children = zk.getChildren(ledgersRootPath, false);\n-        for (String child : children) {\n-            if (ledgerManager.isSpecialZnode(child)) {\n-                continue;\n+        try {\n+            String ledgersRootPath = conf.getZkLedgersRootPath();\n+            List<String> children = zk.getChildren(ledgersRootPath, false);\n+            for (String child : children) {\n+                if (ledgerManager.isSpecialZnode(child)) {\n+                    continue;\n+                }\n+                ZKUtil.deleteRecursive(zk, ledgersRootPath + \"/\" + child);\n             }\n-            ZKUtil.deleteRecursive(zk, ledgersRootPath + \"/\" + child);\n+        } finally {\n+            ledgerManager.close();\n         }\n         // Delete and recreate the LAYOUT information.\n         super.format(conf, zk);"}]}

