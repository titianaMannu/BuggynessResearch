{"sha":"a522fa33b31e2405830a33cd2120be60d3174cd5","node_id":"C_kwDOABgMFNoAKGE1MjJmYTMzYjMxZTI0MDU4MzBhMzNjZDIxMjBiZTYwZDMxNzRjZDU","commit":{"author":{"name":"Raúl Gracia","email":"raul.gracia@emc.com","date":"2021-10-15T00:16:02Z"},"committer":{"name":"GitHub","email":"noreply@github.com","date":"2021-10-15T00:16:02Z"},"message":"Issue 2815: Upgrade to log4j2 to get rid of CVE-2019-17571 (#2816)\n\n### Motivation\r\nUpgrades to log4j2 to get rid of CVE-2019-17571.  \r\n\r\n### Changes\r\n\r\nThe migration of log4j has been done mainly taking the official guidelines: https://logging.apache.org/log4j/2.x/manual/migration.html.\r\nIn this PR, the following changes are included:\r\n- Replacement of `slf4j-log4j12` by `log4j-1.2-api`. Also included the `log4j-slf4j-impl` binding as well as the `log4j-core` library.\r\n- Changes in `pom`, `gradle` and license files to reflect the above library upgrade.\r\n- Test classes `TestOrderedExecutorDecorators`, `LoggerOutput`, `MdcContextTest`, as well as the class `FIleSystemUpgrade` made use of log4j1.2 API. This PR attempts to keep the same functionality with the new APIs.\r\n\r\n### Verification\r\n- Existing tests are passing.\r\n- log4j1.2 is removed from project: https://github.com/apache/bookkeeper/pull/2816#issuecomment-937818625\r\n- Using `localbookie`, we observe that logs are shown correctly:\r\n```\r\n2021-10-07T16:04:23,757 - INFO  - [main:GarbageCollectorThread@245] - Minor Compaction : enabled=true, threshold=0.20000000298023224, interval=3600000\r\n2021-10-07T16:04:23,760 - INFO  - [main:GarbageCollectorThread@247] - Major Compaction : enabled=true, threshold=0.800000011920929, interval=86400000\r\n2021-10-07T16:04:23,952 - INFO  - [main:BookieImpl@920] - Finished replaying journal in 2 ms.\r\n2021-10-07T16:04:23,958 - INFO  - [SyncThread-7-1:SyncThread@135] - Flush ledger storage at checkpoint CheckpointList{checkpoints=[LogMark: logFileId - 0 , logFileOffset - 0]}.\r\n2021-10-07T16:04:23,980 - INFO  - [main:BookieImpl@1010] - Finished reading journal, starting bookie\r\n2021-10-07T16:04:24,011 - INFO  - [BookieJournal-5000:Journal@919] - Starting journal on /tmp/localbookkeeper06554024139823286046test/current\r\n2021-10-07T16:04:24,031 - INFO  - [ForceWriteThread:Journal$ForceWriteThread@478] - ForceWrite Thread started\r\n2021-10-07T16:04:24,048 - INFO  - [BookieJournal-5000:JournalChannel@169] - Opening journal /tmp/localbookkeeper06554024139823286046test/current/17c5b11c65b.txn\r\n```\r\nIn addition to that, if we change the `log4j.properties` file, the changes are reflected in the console output, meaning that the legacy configuration works and changes can be correctly applied:\r\n```\r\nOver Replicated Ledger Deletion : enabled=true, interval=86400000\r\nMinor Compaction : enabled=true, threshold=0.20000000298023224, interval=3600000\r\nMajor Compaction : enabled=true, threshold=0.800000011920929, interval=86400000\r\nFinished replaying journal in 5 ms.\r\nFlush ledger storage at checkpoint CheckpointList{checkpoints=[LogMark: logFileId - 0 , logFileOffset - 0]}.\r\nFinished reading journal, starting bookie\r\nStarting journal on /tmp/localbookkeeper015049859959001160726test/current\r\nForceWrite Thread started\r\nOpening journal /tmp/localbookkeeper015049859959001160726test/current/17c5b143063.txn\r\n```\r\nMore verifications that logging works properly related to other Bookkeeper sub-components impacted may be needed.\r\n\r\nMaster Issue: #2815","tree":{"sha":"31d354e302765e1b3b8e921c0be13feb97c9122a","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/31d354e302765e1b3b8e921c0be13feb97c9122a"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/a522fa33b31e2405830a33cd2120be60d3174cd5","comment_count":0,"verification":{"verified":true,"reason":"valid","signature":"-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhaMhCCRBK7hj4Ov3rIwAANFAIAAqesrssePkduE8I5SYNQ/Jf\nY1fOCsVfulGt+OQ6h3KaajNI/Ye3JwzMuOhHjiKz8S/urcwmQE6NYVxSUjUabUuU\nkCOVQhX8EtkGe1LQs8rLyBh2d09xPt1CKkg9mCJc//MEpuVYpclyMytnoPFg9Lzg\nTY4i86JMvVvDonVpXh1JqC4eI2ixQ53actB6JEHdN3jVPw50SwU3/Ara0BctrRP3\nlW5wIMPGrQ7cjiz0a8VWYbU5KO3iwTQR/2j1luNfSGr43mjGLPakekjy2PD8UmFp\nLwJbF6X9B2YnZ+ZXKFKy4vdJ+f5gGwsb0wepe3krkSeFwPYiv1d8A226Vgg7sC4=\n=JjY6\n-----END PGP SIGNATURE-----\n","payload":"tree 31d354e302765e1b3b8e921c0be13feb97c9122a\nparent 04650521b3a91e03cf598a647ecd58df106d081b\nauthor Raúl Gracia <raul.gracia@emc.com> 1634256962 +0200\ncommitter GitHub <noreply@github.com> 1634256962 +0800\n\nIssue 2815: Upgrade to log4j2 to get rid of CVE-2019-17571 (#2816)\n\n### Motivation\r\nUpgrades to log4j2 to get rid of CVE-2019-17571.  \r\n\r\n### Changes\r\n\r\nThe migration of log4j has been done mainly taking the official guidelines: https://logging.apache.org/log4j/2.x/manual/migration.html.\r\nIn this PR, the following changes are included:\r\n- Replacement of `slf4j-log4j12` by `log4j-1.2-api`. Also included the `log4j-slf4j-impl` binding as well as the `log4j-core` library.\r\n- Changes in `pom`, `gradle` and license files to reflect the above library upgrade.\r\n- Test classes `TestOrderedExecutorDecorators`, `LoggerOutput`, `MdcContextTest`, as well as the class `FIleSystemUpgrade` made use of log4j1.2 API. This PR attempts to keep the same functionality with the new APIs.\r\n\r\n### Verification\r\n- Existing tests are passing.\r\n- log4j1.2 is removed from project: https://github.com/apache/bookkeeper/pull/2816#issuecomment-937818625\r\n- Using `localbookie`, we observe that logs are shown correctly:\r\n```\r\n2021-10-07T16:04:23,757 - INFO  - [main:GarbageCollectorThread@245] - Minor Compaction : enabled=true, threshold=0.20000000298023224, interval=3600000\r\n2021-10-07T16:04:23,760 - INFO  - [main:GarbageCollectorThread@247] - Major Compaction : enabled=true, threshold=0.800000011920929, interval=86400000\r\n2021-10-07T16:04:23,952 - INFO  - [main:BookieImpl@920] - Finished replaying journal in 2 ms.\r\n2021-10-07T16:04:23,958 - INFO  - [SyncThread-7-1:SyncThread@135] - Flush ledger storage at checkpoint CheckpointList{checkpoints=[LogMark: logFileId - 0 , logFileOffset - 0]}.\r\n2021-10-07T16:04:23,980 - INFO  - [main:BookieImpl@1010] - Finished reading journal, starting bookie\r\n2021-10-07T16:04:24,011 - INFO  - [BookieJournal-5000:Journal@919] - Starting journal on /tmp/localbookkeeper06554024139823286046test/current\r\n2021-10-07T16:04:24,031 - INFO  - [ForceWriteThread:Journal$ForceWriteThread@478] - ForceWrite Thread started\r\n2021-10-07T16:04:24,048 - INFO  - [BookieJournal-5000:JournalChannel@169] - Opening journal /tmp/localbookkeeper06554024139823286046test/current/17c5b11c65b.txn\r\n```\r\nIn addition to that, if we change the `log4j.properties` file, the changes are reflected in the console output, meaning that the legacy configuration works and changes can be correctly applied:\r\n```\r\nOver Replicated Ledger Deletion : enabled=true, interval=86400000\r\nMinor Compaction : enabled=true, threshold=0.20000000298023224, interval=3600000\r\nMajor Compaction : enabled=true, threshold=0.800000011920929, interval=86400000\r\nFinished replaying journal in 5 ms.\r\nFlush ledger storage at checkpoint CheckpointList{checkpoints=[LogMark: logFileId - 0 , logFileOffset - 0]}.\r\nFinished reading journal, starting bookie\r\nStarting journal on /tmp/localbookkeeper015049859959001160726test/current\r\nForceWrite Thread started\r\nOpening journal /tmp/localbookkeeper015049859959001160726test/current/17c5b143063.txn\r\n```\r\nMore verifications that logging works properly related to other Bookkeeper sub-components impacted may be needed.\r\n\r\nMaster Issue: #2815\r\n"}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/a522fa33b31e2405830a33cd2120be60d3174cd5","html_url":"https://github.com/apache/bookkeeper/commit/a522fa33b31e2405830a33cd2120be60d3174cd5","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/a522fa33b31e2405830a33cd2120be60d3174cd5/comments","author":{"login":"RaulGracia","id":717112,"node_id":"MDQ6VXNlcjcxNzExMg==","avatar_url":"https://avatars.githubusercontent.com/u/717112?v=4","gravatar_id":"","url":"https://api.github.com/users/RaulGracia","html_url":"https://github.com/RaulGracia","followers_url":"https://api.github.com/users/RaulGracia/followers","following_url":"https://api.github.com/users/RaulGracia/following{/other_user}","gists_url":"https://api.github.com/users/RaulGracia/gists{/gist_id}","starred_url":"https://api.github.com/users/RaulGracia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RaulGracia/subscriptions","organizations_url":"https://api.github.com/users/RaulGracia/orgs","repos_url":"https://api.github.com/users/RaulGracia/repos","events_url":"https://api.github.com/users/RaulGracia/events{/privacy}","received_events_url":"https://api.github.com/users/RaulGracia/received_events","type":"User","site_admin":false},"committer":{"login":"web-flow","id":19864447,"node_id":"MDQ6VXNlcjE5ODY0NDQ3","avatar_url":"https://avatars.githubusercontent.com/u/19864447?v=4","gravatar_id":"","url":"https://api.github.com/users/web-flow","html_url":"https://github.com/web-flow","followers_url":"https://api.github.com/users/web-flow/followers","following_url":"https://api.github.com/users/web-flow/following{/other_user}","gists_url":"https://api.github.com/users/web-flow/gists{/gist_id}","starred_url":"https://api.github.com/users/web-flow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/web-flow/subscriptions","organizations_url":"https://api.github.com/users/web-flow/orgs","repos_url":"https://api.github.com/users/web-flow/repos","events_url":"https://api.github.com/users/web-flow/events{/privacy}","received_events_url":"https://api.github.com/users/web-flow/received_events","type":"User","site_admin":false},"parents":[{"sha":"04650521b3a91e03cf598a647ecd58df106d081b","url":"https://api.github.com/repos/apache/bookkeeper/commits/04650521b3a91e03cf598a647ecd58df106d081b","html_url":"https://github.com/apache/bookkeeper/commit/04650521b3a91e03cf598a647ecd58df106d081b"}],"stats":{"total":308,"additions":210,"deletions":98},"files":[{"sha":"94b5b36d63ccf3e5dd7366cb20335579826d93b5","filename":"bookkeeper-common/build.gradle","status":"modified","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-common/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -41,9 +41,10 @@ dependencies {\n     testImplementation depLibs.commonsLang3\n     testImplementation depLibs.hamcrest\n     testImplementation depLibs.junit\n-    testImplementation depLibs.log4j\n+    testImplementation depLibs.log4jSlf4jImpl\n+    testImplementation depLibs.log4j12api\n+    testImplementation depLibs.log4jCore\n     testImplementation depLibs.mockito\n-    testImplementation depLibs.slf4jLog4j\n \n     annotationProcessor depLibs.lombok\n     testAnnotationProcessor depLibs.lombok"},{"sha":"c1065c975be7c13f457fc3106cba103e623c16da","filename":"bookkeeper-common/pom.xml","status":"modified","additions":20,"deletions":0,"changes":20,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-common/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -74,6 +74,26 @@\n       <artifactId>commons-lang3</artifactId>\n       <scope>test</scope>\n     </dependency>\n+    <dependency>\n+      <groupId>org.slf4j</groupId>\n+      <artifactId>slf4j-api</artifactId>\n+      <version>${slf4j.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+      <version>${log4j.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+      <version>${log4j.version}</version>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n+      <version>${log4j.version}</version>\n+    </dependency>\n   </dependencies>\n   <build>\n     <plugins>"},{"sha":"2c8921150144cc99513c817cf252be609ac999cb","filename":"bookkeeper-common/src/main/java/org/apache/bookkeeper/common/util/OrderedExecutor.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/src/main/java/org/apache/bookkeeper/common/util/OrderedExecutor.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/src/main/java/org/apache/bookkeeper/common/util/OrderedExecutor.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-common/src/main/java/org/apache/bookkeeper/common/util/OrderedExecutor.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -410,7 +410,7 @@ protected OrderedExecutor(String baseName, int numThreads, ThreadFactory threadF\n                         try {\n                             CpuAffinity.acquireCore();\n                         } catch (Throwable t) {\n-                            log.warn(\"Failed to acquire CPU core for thread {}\", Thread.currentThread().getName(),\n+                            log.warn(\"Failed to acquire CPU core for thread {}: {}\", Thread.currentThread().getName(),\n                                     t.getMessage(), t);\n                         }\n                     }"},{"sha":"f8d53b496d82132510ea52bb0ac1e5cea6b69d40","filename":"bookkeeper-common/src/test/java/org/apache/bookkeeper/common/util/TestOrderedExecutorDecorators.java","status":"modified","additions":22,"deletions":18,"changes":40,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/src/test/java/org/apache/bookkeeper/common/util/TestOrderedExecutorDecorators.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-common/src/test/java/org/apache/bookkeeper/common/util/TestOrderedExecutorDecorators.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-common/src/test/java/org/apache/bookkeeper/common/util/TestOrderedExecutorDecorators.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -27,18 +27,18 @@\n import static org.mockito.AdditionalAnswers.answerVoid;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.doAnswer;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.spy;\n \n import java.util.Queue;\n+import java.util.UUID;\n import java.util.concurrent.ConcurrentLinkedQueue;\n import java.util.concurrent.TimeUnit;\n \n-import org.apache.log4j.Appender;\n-import org.apache.log4j.Level;\n-import org.apache.log4j.LogManager;\n import org.apache.log4j.MDC;\n-import org.apache.log4j.spi.LoggingEvent;\n+import org.apache.logging.log4j.Level;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.NullAppender;\n import org.junit.After;\n import org.junit.Before;\n import org.junit.Test;\n@@ -53,7 +53,7 @@\n     private static final Logger log = LoggerFactory.getLogger(TestOrderedExecutorDecorators.class);\n     private static final String MDC_KEY = \"mdc-key\";\n \n-    private Appender mockAppender;\n+    private NullAppender mockAppender;\n     private final Queue<String> capturedEvents = new ConcurrentLinkedQueue<>();\n \n     public static String mdcFormat(Object mdc, String message) {\n@@ -63,21 +63,25 @@ public static String mdcFormat(Object mdc, String message) {\n     @Before\n     public void setUp() throws Exception {\n         MDC.clear();\n-        mockAppender = mock(Appender.class);\n-        when(mockAppender.getName()).thenReturn(\"MockAppender\");\n-\n-        LogManager.getRootLogger().addAppender(mockAppender);\n-        LogManager.getRootLogger().setLevel(Level.INFO);\n-\n-        doAnswer(answerVoid((LoggingEvent event) -> {\n-                    capturedEvents.add(mdcFormat(event.getMDC(MDC_KEY),\n-                                                 event.getRenderedMessage()));\n-                })).when(mockAppender).doAppend(any());\n+        LoggerContext lc = (LoggerContext) org.apache.logging.log4j.LogManager.getContext(false);\n+        mockAppender = spy(NullAppender.createAppender(UUID.randomUUID().toString()));\n+        mockAppender.start();\n+        lc.getConfiguration().addAppender(mockAppender);\n+        lc.getRootLogger().addAppender(lc.getConfiguration().getAppender(mockAppender.getName()));\n+        lc.getConfiguration().getRootLogger().setLevel(Level.INFO);\n+        lc.updateLoggers();\n+\n+        doAnswer(answerVoid((LogEvent event) -> {\n+                    capturedEvents.add(mdcFormat(event.getContextData().getValue(MDC_KEY),\n+                                                 event.getMessage().getFormattedMessage()));\n+                })).when(mockAppender).append(any());\n     }\n \n     @After\n     public void tearDown() throws Exception {\n-        LogManager.getRootLogger().removeAppender(mockAppender);\n+        LoggerContext lc = (LoggerContext) org.apache.logging.log4j.LogManager.getContext(false);\n+        lc.getRootLogger().removeAppender(lc.getConfiguration().getAppender(mockAppender.getName()));\n+        lc.updateLoggers();\n         capturedEvents.clear();\n         MDC.clear();\n     }"},{"sha":"343f01a7111d39f9841b0b0166dd76aa52c39f6e","filename":"bookkeeper-dist/all/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/all/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/all/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/all/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -40,7 +40,7 @@ dependencies {\n     compileOnly depLibs.lombok\n     compileOnly depLibs.spotbugsAnnotations\n \n-    implementation depLibs.slf4jLog4j\n+    implementation depLibs.log4j12api\n \n \n     testCompileOnly depLibs.lombok"},{"sha":"146dafa32715adbf412528a103144f3ad4393ace","filename":"bookkeeper-dist/all/pom.xml","status":"modified","additions":10,"deletions":2,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/all/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/all/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/all/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -99,8 +99,16 @@\n \n     <!-- slf4j binding -->\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n     </dependency>\n \n     <dependency>"},{"sha":"8ac6545851e7c3f6ecd3c7aaf591a9261cbb669c","filename":"bookkeeper-dist/bkctl/pom.xml","status":"modified","additions":10,"deletions":2,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/bkctl/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/bkctl/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/bkctl/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -47,8 +47,16 @@\n \n     <!-- slf4j binding -->\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n     </dependency>\n   </dependencies>\n "},{"sha":"6ce817ddf9f389e986f983d05a07cd37ee98c3a7","filename":"bookkeeper-dist/server/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/server/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/server/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/server/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -42,7 +42,7 @@ dependencies {\n     compileOnly depLibs.lombok\n     compileOnly depLibs.spotbugsAnnotations\n \n-    implementation depLibs.slf4jLog4j\n+    implementation depLibs.log4j12api\n \n \n     testCompileOnly depLibs.lombok"},{"sha":"83777f5f3423ea54f1bf3221fc4f0fc37dbbf90e","filename":"bookkeeper-dist/server/pom.xml","status":"modified","additions":10,"deletions":2,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/server/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/server/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/server/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -85,8 +85,16 @@\n \n     <!-- slf4j binding -->\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n     </dependency>\n \n     <dependency>"},{"sha":"d13f96ac1b9affd6e2d893764f1bfdf92d00c0a3","filename":"bookkeeper-dist/src/main/resources/LICENSE-all.bin.txt","status":"modified","additions":5,"deletions":3,"changes":8,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-all.bin.txt","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-all.bin.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/src/main/resources/LICENSE-all.bin.txt?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -241,7 +241,10 @@ Apache Software License, Version 2.\n - lib/io.vertx-vertx-core-3.9.8.jar [15]\n - lib/io.vertx-vertx-web-3.9.8.jar [16]\n - lib/io.vertx-vertx-web-common-3.9.8.jar [16]\n-- lib/log4j-log4j-1.2.17.jar [17]\n+- lib/org.apache.logging.log4j-log4j-1.2-api-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-api-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-core-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-slf4j-impl-2.14.1.jar [17]\n - lib/net.java.dev.jna-jna-3.2.7.jar [18]\n - lib/org.apache.commons-commons-collections4-4.1.jar [19]\n - lib/org.apache.commons-commons-lang3-3.6.jar [20]\n@@ -318,7 +321,7 @@ Apache Software License, Version 2.\n [14] Source available at https://github.com/vert-x3/vertx-bridge-common/tree/3.9.8\n [15] Source available at https://github.com/eclipse/vert.x/tree/3.9.8\n [16] Source available at https://github.com/vert-x3/vertx-web/tree/3.9.8\n-[17] Source available at http://logging.apache.org/log4j/1.2/download.html\n+[17] Source available at https://github.com/apache/logging-log4j2/tree/rel/2.14.1\n [18] Source available at https://github.com/java-native-access/jna/tree/3.2.7\n [19] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-collections.git;a=tag;h=a3a5ad\n [20] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-lang.git;a=shortlog;h=refs/tags/LANG_3_6\n@@ -639,7 +642,6 @@ MIT license. For details, see deps/slf4j-1.7.32/LICENSE.txt.\n \n Bundled as\n   - lib/org.slf4j-slf4j-api-1.7.32.jar\n-  - lib/org.slf4j-slf4j-log4j12-1.7.32.jar\n Source available at https://github.com/qos-ch/slf4j/tree/v_1.7.32\n ------------------------------------------------------------------------------------\n This product bundles the Google Auth Library, which is available under a \"3-clause BSD\""},{"sha":"ceaa468b8293c0fa2f7b6894a08048cd6feabebd","filename":"bookkeeper-dist/src/main/resources/LICENSE-bkctl.bin.txt","status":"modified","additions":5,"deletions":3,"changes":8,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-bkctl.bin.txt","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-bkctl.bin.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/src/main/resources/LICENSE-bkctl.bin.txt?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -230,7 +230,10 @@ Apache Software License, Version 2.\n - lib/io.netty-netty-transport-4.1.68.Final.jar [11]\n - lib/io.netty-netty-transport-native-epoll-4.1.68.Final-linux-x86_64.jar [11]\n - lib/io.netty-netty-transport-native-unix-common-4.1.68.Final.jar [11]\n-- lib/log4j-log4j-1.2.17.jar [16]\n+- lib/org.apache.logging.log4j-log4j-1.2-api-2.14.1.jar [16]\n+- lib/org.apache.logging.log4j-log4j-api-2.14.1.jar [16]\n+- lib/org.apache.logging.log4j-log4j-core-2.14.1.jar [16]\n+- lib/org.apache.logging.log4j-log4j-slf4j-impl-2.14.1.jar [16]\n - lib/net.java.dev.jna-jna-3.2.7.jar [17]\n - lib/org.apache.commons-commons-collections4-4.1.jar [18]\n - lib/org.apache.commons-commons-lang3-3.6.jar [19]\n@@ -290,7 +293,7 @@ Apache Software License, Version 2.\n [9] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-lang.git;a=tag;h=375459\n [10] Source available at http://svn.apache.org/viewvc/commons/proper/logging/tags/commons-logging-1.1.1/\n [11] Source available at https://github.com/netty/netty/tree/netty-4.1.68.Final\n-[16] Source available at http://logging.apache.org/log4j/1.2/download.html\n+[16] Source available at https://github.com/apache/logging-log4j2/tree/rel/2.14.1\n [17] Source available at https://github.com/java-native-access/jna/tree/3.2.7\n [18] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-collections.git;a=tag;h=a3a5ad\n [19] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-lang.git;a=shortlog;h=refs/tags/LANG_3_6\n@@ -565,7 +568,6 @@ MIT license. For details, see deps/slf4j-1.7.32/LICENSE.txt.\n \n Bundled as\n   - lib/org.slf4j-slf4j-api-1.7.32.jar\n-  - lib/org.slf4j-slf4j-log4j12-1.7.32.jar\n Source available at https://github.com/qos-ch/slf4j/tree/v_1.7.32\n ------------------------------------------------------------------------------------\n This product bundles the Google Auth Library, which is available under a \"3-clause BSD\""},{"sha":"7c0bad9f1aabe3fc129bd4118cf0c8711aa21c49","filename":"bookkeeper-dist/src/main/resources/LICENSE-server.bin.txt","status":"modified","additions":5,"deletions":3,"changes":8,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-server.bin.txt","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-dist/src/main/resources/LICENSE-server.bin.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-dist/src/main/resources/LICENSE-server.bin.txt?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -241,7 +241,10 @@ Apache Software License, Version 2.\n - lib/io.vertx-vertx-core-3.9.8.jar [15]\n - lib/io.vertx-vertx-web-3.9.8.jar [16]\n - lib/io.vertx-vertx-web-common-3.9.8.jar [16]\n-- lib/log4j-log4j-1.2.17.jar [17]\n+- lib/org.apache.logging.log4j-log4j-1.2-api-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-api-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-core-2.14.1.jar [17]\n+- lib/org.apache.logging.log4j-log4j-slf4j-impl-2.14.1.jar [17]\n - lib/net.java.dev.jna-jna-3.2.7.jar [18]\n - lib/org.apache.commons-commons-collections4-4.1.jar [19]\n - lib/org.apache.commons-commons-lang3-3.6.jar [20]\n@@ -316,7 +319,7 @@ Apache Software License, Version 2.\n [14] Source available at https://github.com/vert-x3/vertx-bridge-common/tree/3.9.8\n [15] Source available at https://github.com/eclipse/vert.x/tree/3.9.8\n [16] Source available at https://github.com/vert-x3/vertx-web/tree/3.9.8\n-[17] Source available at http://logging.apache.org/log4j/1.2/download.html\n+[17] Source available at https://github.com/apache/logging-log4j2/tree/rel/2.14.1\n [18] Source available at https://github.com/java-native-access/jna/tree/3.2.7\n [19] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-collections.git;a=tag;h=a3a5ad\n [20] Source available at https://git-wip-us.apache.org/repos/asf?p=commons-lang.git;a=shortlog;h=refs/tags/LANG_3_6\n@@ -631,7 +634,6 @@ MIT license. For details, see deps/slf4j-1.7.32/LICENSE.txt.\n \n Bundled as\n   - lib/org.slf4j-slf4j-api-1.7.32.jar\n-  - lib/org.slf4j-slf4j-log4j12-1.7.32.jar\n Source available at https://github.com/qos-ch/slf4j/tree/v_1.7.32\n ------------------------------------------------------------------------------------\n This product bundles the Google Auth Library, which is available under a \"3-clause BSD\""},{"sha":"b18ed013032374765a3615399e826895cc3d5cb7","filename":"bookkeeper-server/build.gradle","status":"modified","additions":3,"deletions":1,"changes":4,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -72,7 +72,9 @@ dependencies {\n     testImplementation depLibs.zookeeperTest\n     annotationProcessor depLibs.lombok\n     testAnnotationProcessor depLibs.lombok\n-    testImplementation depLibs.slf4jLog4j\n+    testImplementation depLibs.log4jSlf4jImpl\n+    testImplementation depLibs.log4j12api\n+    testImplementation depLibs.log4jCore\n }\n \n test {"},{"sha":"07004c8770a57bae15d18590e4a240ce84570cc8","filename":"bookkeeper-server/pom.xml","status":"modified","additions":10,"deletions":2,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -50,8 +50,16 @@\n       <artifactId>rocksdbjni</artifactId>\n     </dependency>\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n     </dependency>\n     <dependency>\n       <groupId>org.apache.zookeeper</groupId>"},{"sha":"b009eae38cadea86b4f78128681cdb36e2ba7aa8","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","status":"modified","additions":4,"deletions":2,"changes":6,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileSystemUpgrade.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -52,6 +52,7 @@\n import org.apache.commons.cli.Options;\n import org.apache.commons.configuration.ConfigurationException;\n import org.apache.commons.io.FileUtils;\n+import org.apache.log4j.ConsoleAppender;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n@@ -335,8 +336,9 @@ private static void printHelp(Options opts) {\n \n     public static void main(String[] args) throws Exception {\n         org.apache.log4j.Logger root = org.apache.log4j.Logger.getRootLogger();\n-        root.addAppender(new org.apache.log4j.ConsoleAppender(\n-                                 new org.apache.log4j.PatternLayout(\"%-5p [%t]: %m%n\")));\n+        ConsoleAppender console = new org.apache.log4j.ConsoleAppender();\n+        console.setLayout(new org.apache.log4j.PatternLayout(\"%-5p [%t]: %m%n\"));\n+        root.addAppender(console);\n         root.setLevel(org.apache.log4j.Level.ERROR);\n         org.apache.log4j.Logger.getLogger(FileSystemUpgrade.class).setLevel(\n                 org.apache.log4j.Level.INFO);"},{"sha":"51d66d84059f81ab65177e81fad3b31add4020ff","filename":"bookkeeper-server/src/test/java/org/apache/bookkeeper/client/MdcContextTest.java","status":"modified","additions":19,"deletions":17,"changes":36,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/MdcContextTest.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/MdcContextTest.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/MdcContextTest.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -28,11 +28,11 @@\n import static org.mockito.AdditionalAnswers.answerVoid;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.doAnswer;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.spy;\n \n import java.io.File;\n import java.util.Queue;\n+import java.util.UUID;\n import java.util.concurrent.ConcurrentLinkedQueue;\n \n import lombok.extern.slf4j.Slf4j;\n@@ -43,12 +43,10 @@\n import org.apache.bookkeeper.bookie.LedgerDirsManager;\n import org.apache.bookkeeper.conf.ClientConfiguration;\n import org.apache.bookkeeper.test.BookKeeperClusterTestCase;\n-import org.apache.log4j.Appender;\n-import org.apache.log4j.Level;\n-import org.apache.log4j.LogManager;\n-import org.apache.log4j.Logger;\n import org.apache.log4j.MDC;\n-import org.apache.log4j.spi.LoggingEvent;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.NullAppender;\n import org.hamcrest.CoreMatchers;\n import org.junit.After;\n import org.junit.Assert;\n@@ -69,9 +67,8 @@\n     BookKeeper bkc;\n     LedgerHandle lh;\n \n-    private Appender mockAppender;\n+    private NullAppender mockAppender;\n     private Queue<String> capturedEvents;\n-    private Logger rootLogger = LogManager.getRootLogger();\n \n     public MdcContextTest() {\n         super(3);\n@@ -118,23 +115,28 @@ public void setUp() throws Exception {\n         lh = bkc.createLedgerAdv(3, 3, 3, BookKeeper.DigestType.CRC32, new byte[] {});\n         MDC.clear();\n \n-        mockAppender = mock(Appender.class);\n-        when(mockAppender.getName()).thenReturn(\"MockAppender\");\n+        LoggerContext lc = (LoggerContext) org.apache.logging.log4j.LogManager.getContext(false);\n+        mockAppender = spy(NullAppender.createAppender(UUID.randomUUID().toString()));\n+        mockAppender.start();\n+        lc.getConfiguration().addAppender(mockAppender);\n+        lc.getRootLogger().addAppender(lc.getConfiguration().getAppender(mockAppender.getName()));\n+        lc.getConfiguration().getRootLogger().setLevel(org.apache.logging.log4j.Level.INFO);\n+        lc.updateLoggers();\n \n-        rootLogger.addAppender(mockAppender);\n-        rootLogger.setLevel(Level.INFO);\n         capturedEvents = new ConcurrentLinkedQueue<>();\n \n-        doAnswer(answerVoid((LoggingEvent event) -> capturedEvents.add(\n-                    mdcFormat(event.getMDC(MDC_REQUEST_ID), event.getRenderedMessage())\n-            ))).when(mockAppender).doAppend(any());\n+        doAnswer(answerVoid((LogEvent event) -> capturedEvents.add(\n+                    mdcFormat(event.getContextData().getValue(MDC_REQUEST_ID), event.getMessage().getFormattedMessage())\n+            ))).when(mockAppender).append(any());\n     }\n \n     @After\n     public void tearDown() throws Exception {\n         lh.close();\n         bkc.close();\n-        rootLogger.removeAppender(mockAppender);\n+        LoggerContext lc = (LoggerContext) org.apache.logging.log4j.LogManager.getContext(false);\n+        lc.getRootLogger().removeAppender(lc.getConfiguration().getAppender(mockAppender.getName()));\n+        lc.updateLoggers();\n         capturedEvents = null;\n         MDC.clear();\n         super.tearDown();"},{"sha":"610997cba917932edebb732e79f584adb9306af9","filename":"bookkeeper-server/src/test/java/org/apache/bookkeeper/util/LoggerOutput.java","status":"modified","additions":22,"deletions":16,"changes":38,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/test/java/org/apache/bookkeeper/util/LoggerOutput.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/bookkeeper-server/src/test/java/org/apache/bookkeeper/util/LoggerOutput.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/util/LoggerOutput.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -21,16 +21,18 @@\n package org.apache.bookkeeper.util;\n \n import static org.mockito.Mockito.atLeastOnce;\n-import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.spy;\n import static org.mockito.Mockito.verify;\n \n import java.util.ArrayList;\n import java.util.List;\n+import java.util.UUID;\n import java.util.function.Consumer;\n import java.util.stream.Collectors;\n-import org.apache.log4j.Appender;\n-import org.apache.log4j.LogManager;\n-import org.apache.log4j.Logger;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.LoggerContext;\n+import org.apache.logging.log4j.core.appender.NullAppender;\n import org.junit.rules.TestRule;\n import org.junit.runner.Description;\n import org.junit.runners.featureSelection.Statement;\n@@ -44,13 +46,13 @@\n  */\n public class LoggerOutput implements TestRule {\n \n-    private Appender logAppender;\n-    private ArgumentCaptor<org.apache.log4j.spi.LoggingEvent> logEventCaptor;\n-    private List<Consumer<List<LoggingEvent>>> logEventExpectations = new ArrayList<>();\n+    private NullAppender logAppender;\n+    private ArgumentCaptor<LogEvent> logEventCaptor;\n+    private final List<Consumer<List<LoggingEvent>>> logEventExpectations = new ArrayList<>();\n \n     public void expect(Consumer<List<LoggingEvent>> expectation) {\n         if (logEventCaptor == null) {\n-            logEventCaptor = ArgumentCaptor.forClass(org.apache.log4j.spi.LoggingEvent.class);\n+            logEventCaptor = ArgumentCaptor.forClass(LogEvent.class);\n         }\n         logEventExpectations.add(expectation);\n     }\n@@ -61,13 +63,16 @@ public Statement apply(final Statement base, Description description) {\n \n             @Override\n             public void evaluate() throws Throwable {\n-                logAppender = mock(Appender.class);\n-                Logger rootLogger = LogManager.getRootLogger();\n-                rootLogger.addAppender(logAppender);\n+                LoggerContext lc = (LoggerContext) LogManager.getContext(false);\n+                logAppender = spy(NullAppender.createAppender(UUID.randomUUID().toString()));\n+                logAppender.start();\n+                lc.getConfiguration().addAppender(logAppender);\n+                lc.getRootLogger().addAppender(lc.getConfiguration().getAppender(logAppender.getName()));\n+                lc.updateLoggers();\n                 try {\n                     base.evaluate();\n                     if (!logEventExpectations.isEmpty()) {\n-                        verify(logAppender, atLeastOnce()).doAppend(logEventCaptor.capture());\n+                        verify(logAppender, atLeastOnce()).append(logEventCaptor.capture());\n                         List<LoggingEvent> logEvents = logEventCaptor.getAllValues().stream()\n                                 .map(LoggerOutput::toSlf4j)\n                                 .collect(Collectors.toList());\n@@ -76,15 +81,16 @@ public void evaluate() throws Throwable {\n                         }\n                     }\n                 } finally {\n-                    rootLogger.removeAppender(logAppender);\n+                    lc.getRootLogger().removeAppender(lc.getConfiguration().getAppender(logAppender.getName()));\n+                    lc.updateLoggers();\n                     logEventExpectations.clear();\n                     logEventCaptor = null;\n                 }\n             }\n         };\n     }\n \n-    private static LoggingEvent toSlf4j(org.apache.log4j.spi.LoggingEvent log4jEvent) {\n+    private static LoggingEvent toSlf4j(LogEvent log4jEvent) {\n         return new LoggingEvent() {\n             @Override\n             public Level getLevel() {\n@@ -113,7 +119,7 @@ public String getLoggerName() {\n \n             @Override\n             public String getMessage() {\n-                return log4jEvent.getRenderedMessage();\n+                return log4jEvent.getMessage().getFormattedMessage();\n             }\n \n             @Override\n@@ -128,7 +134,7 @@ public String getThreadName() {\n \n             @Override\n             public long getTimeStamp() {\n-                return log4jEvent.getTimeStamp();\n+                return log4jEvent.getTimeMillis();\n             }\n \n             @Override"},{"sha":"a7bc5bf66bb8cbe1ee0549e2b183fd1f2decc6a9","filename":"dependencies.gradle","status":"modified","additions":4,"deletions":3,"changes":7,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/dependencies.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/dependencies.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/dependencies.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -59,7 +59,7 @@ depVersions = [\n     junit: \"4.12\",\n     junitFoundation: \"11.0.0\",\n     kerby: \"1.1.1\",\n-    log4j: \"1.2.27\",\n+    log4j: \"2.14.1\",\n     lombok: \"1.18.20\",\n     lz4: \"1.3.0\",\n     mockito: \"3.0.0\",\n@@ -126,7 +126,9 @@ depLibs = [\n     junit: \"junit:junit:${depVersions.junit}\",\n     junitFoundation: \"com.nordstrom.tools:junit-foundation:${depVersions.junitFoundation}\",\n     kerbySimpleKdc: \"org.apache.kerby:kerb-simplekdc:${depVersions.kerby}\",\n-    log4j: \"log4j:log4j:${depVersions.log4j}\",\n+    log4jSlf4jImpl: \"org.apache.logging.log4j:log4j-slf4j-impl:${depVersions.log4j}\",\n+    log4j12api: \"org.apache.logging.log4j:log4j-1.2-api:${depVersions.log4j}\",\n+    log4jCore: \"org.apache.logging.log4j:log4j-core:${depVersions.log4j}\",\n     lombok: \"org.projectlombok:lombok:${depVersions.lombok}\",\n     lz4: \"net.jpountz.lz4:lz4:${depVersions.lz4}\",\n     metricsCore: \"io.dropwizard.metrics:metrics-core:${depVersions.dropwizard}\",\n@@ -151,7 +153,6 @@ depLibs = [\n     rocksDb: \"org.rocksdb:rocksdbjni:${depVersions.rocksDb}\",\n     slf4j: \"org.slf4j:slf4j-api:${depVersions.slf4j}\",\n     slf4jSimple: \"org.slf4j:slf4j-simple:${depVersions.slf4j}\",\n-    slf4jLog4j: \"org.slf4j:slf4j-log4j12:${depVersions.slf4j}\",\n     shrinkwrapImpl: \"org.jboss.shrinkwrap.resolver:shrinkwrap-resolver-impl-maven:${depVersions.shrinkwrap}\",\n     shrinkwrapApi: \"org.jboss.shrinkwrap.resolver:shrinkwrap-resolver-api:${depVersions.shrinkwrap}\",\n     snappy: \"org.xerial.snappy:snappy-java:${depVersions.snappy}\","},{"sha":"dc0093954dbfa6c08eda1cf66ecfd8ec057cae67","filename":"microbenchmarks/pom.xml","status":"modified","additions":10,"deletions":2,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/microbenchmarks/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/microbenchmarks/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/microbenchmarks/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -43,8 +43,16 @@\n       <artifactId>slf4j-api</artifactId>\n     </dependency>\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>log4j-over-slf4j</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n     </dependency>\n     <dependency>\n       <groupId>org.apache.bookkeeper</groupId>"},{"sha":"cbcd017b950dde5895f8a1d0182879478316a4d6","filename":"pom.xml","status":"modified","additions":19,"deletions":8,"changes":27,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -145,6 +145,7 @@\n     <junit.version>4.12</junit.version>\n     <libthrift.version>0.14.2</libthrift.version>\n     <lombok.version>1.18.20</lombok.version>\n+    <log4j.version>2.14.1</log4j.version>\n     <lz4.version>1.3.0</lz4.version>\n     <mockito.version>3.0.0</mockito.version>\n     <netty.version>4.1.68.Final</netty.version>\n@@ -242,14 +243,19 @@\n         <version>${slf4j.version}</version>\n       </dependency>\n       <dependency>\n-        <groupId>org.slf4j</groupId>\n-        <artifactId>slf4j-log4j12</artifactId>\n-        <version>${slf4j.version}</version>\n+        <groupId>org.apache.logging.log4j</groupId>\n+        <artifactId>log4j-1.2-api</artifactId>\n+        <version>${log4j.version}</version>\n       </dependency>\n       <dependency>\n-        <groupId>org.slf4j</groupId>\n-        <artifactId>log4j-over-slf4j</artifactId>\n-        <version>${slf4j.version}</version>\n+        <groupId>org.apache.logging.log4j</groupId>\n+        <artifactId>log4j-core</artifactId>\n+        <version>${log4j.version}</version>\n+      </dependency>\n+      <dependency>\n+        <groupId>org.apache.logging.log4j</groupId>\n+        <artifactId>log4j-slf4j-impl</artifactId>\n+        <version>${log4j.version}</version>\n       </dependency>\n \n       <!-- commons dependencies -->\n@@ -790,8 +796,13 @@\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+      <scope>test</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n       <scope>test</scope>\n     </dependency>\n     <dependency>"},{"sha":"39ff187fbf5cfbc717b6620ed0a17ec957e77e45","filename":"stats/utils/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/stats/utils/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/stats/utils/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/stats/utils/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -33,7 +33,7 @@ dependencies {\n     implementation depLibs.jacksonAnnotations\n     implementation depLibs.jcommander\n     implementation depLibs.reflections\n-    implementation depLibs.slf4jLog4j\n+    implementation depLibs.log4j12api\n     implementation depLibs.snakeyaml\n \n "},{"sha":"31366ed9fc096e423125a9c37854c44b3d21724a","filename":"stream/distributedlog/io/dlfs/pom.xml","status":"modified","additions":8,"deletions":0,"changes":8,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/stream/distributedlog/io/dlfs/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/stream/distributedlog/io/dlfs/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/stream/distributedlog/io/dlfs/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -50,6 +50,14 @@\n           <groupId>com.google.guava</groupId>\n           <artifactId>guava</artifactId>\n         </exclusion>\n+        <exclusion>\n+          <groupId>org.slf4j</groupId>\n+          <artifactId>slf4j-log4j12</artifactId>\n+        </exclusion>\n+        <exclusion>\n+          <groupId>log4j</groupId>\n+          <artifactId>log4j</artifactId>\n+        </exclusion>\n       </exclusions>\n     </dependency>\n     <dependency>"},{"sha":"76f966abc2d3a6027c51a63483e65747196c4c4c","filename":"stream/server/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/stream/server/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/stream/server/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/stream/server/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -50,7 +50,7 @@ dependencies {\n     implementation depLibs.zookeeper\n     runtimeOnly depLibs.metricsCore\n     runtimeOnly depLibs.snappy\n-    runtimeOnly depLibs.slf4jLog4j\n+    runtimeOnly depLibs.log4j12api\n     runtimeOnly depLibs.commonsBeanutils\n     runtimeOnly depLibs.vertxCore\n     runtimeOnly depLibs.vertxWeb"},{"sha":"2404f21a210f1073f760b6630b928b99e319d895","filename":"tests/integration-tests-utils/src/main/java/org/apache/bookkeeper/tests/integration/utils/MavenClassLoader.java","status":"modified","additions":1,"deletions":2,"changes":3,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/tests/integration-tests-utils/src/main/java/org/apache/bookkeeper/tests/integration/utils/MavenClassLoader.java","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/tests/integration-tests-utils/src/main/java/org/apache/bookkeeper/tests/integration/utils/MavenClassLoader.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/tests/integration-tests-utils/src/main/java/org/apache/bookkeeper/tests/integration/utils/MavenClassLoader.java?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -71,14 +71,13 @@ private static MavenClassLoader createClassLoader(ConfigurableMavenResolverSyste\n         Optional<String> slf4jVersion = Arrays.stream(resolver.resolve(mainArtifact)\n                                                       .withTransitivity().asResolvedArtifact())\n             .filter((a) -> a.getCoordinate().getGroupId().equals(\"org.slf4j\")\n-                    && a.getCoordinate().getArtifactId().equals(\"slf4j-log4j12\"))\n+                    && a.getCoordinate().getArtifactId().equals(\"slf4j-1.2-api\"))\n             .map((a) -> a.getCoordinate().getVersion())\n             .findFirst();\n \n         List<MavenDependency> deps = Lists.newArrayList(\n                 MavenDependencies.createDependency(\n                         mainArtifact, ScopeType.COMPILE, false,\n-                        MavenDependencies.createExclusion(\"org.slf4j:slf4j-log4j12\"),\n                         MavenDependencies.createExclusion(\"log4j:log4j\")));\n         if (slf4jVersion.isPresent()) {\n             deps.add(MavenDependencies.createDependency(\"org.slf4j:slf4j-simple:\" + slf4jVersion.get(),"},{"sha":"16e8fe6855f41f9f406e387cf026dd0782013569","filename":"tests/integration/cluster/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/tests/integration/cluster/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/tests/integration/cluster/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/tests/integration/cluster/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -37,7 +37,7 @@ dependencies {\n     testImplementation project(':stream:clients:java:kv')\n \n     testCompileOnly depLibs.lombok\n-    testImplementation depLibs.slf4jLog4j\n+    testImplementation depLibs.log4j12api\n     testImplementation depLibs.testcontainers\n     testImplementation depLibs.commonsConfiguration\n     testAnnotationProcessor depLibs.lombok"},{"sha":"8becea1f2812aa9e44f2d6b74622ceaaee9e1131","filename":"tools/ledger/pom.xml","status":"modified","additions":12,"deletions":2,"changes":14,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/ledger/pom.xml","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/ledger/pom.xml","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/tools/ledger/pom.xml?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -36,8 +36,18 @@\n       <version>${project.parent.version}</version>\n     </dependency>\n     <dependency>\n-      <groupId>org.slf4j</groupId>\n-      <artifactId>slf4j-log4j12</artifactId>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-1.2-api</artifactId>\n+      <scope>runtime</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-core</artifactId>\n+      <scope>runtime</scope>\n+    </dependency>\n+    <dependency>\n+      <groupId>org.apache.logging.log4j</groupId>\n+      <artifactId>log4j-slf4j-impl</artifactId>\n       <scope>runtime</scope>\n     </dependency>\n     <dependency>"},{"sha":"b7d659e68538b71cec51ea5c7b348f1b71e5b67a","filename":"tools/perf/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/perf/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/perf/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/tools/perf/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -43,7 +43,7 @@ dependencies {\n     implementation depLibs.commonsConfiguration\n     implementation depLibs.guava\n     implementation depLibs.jcommander\n-    implementation depLibs.slf4jLog4j\n+    implementation depLibs.log4j12api\n     implementation depLibs.zookeeper\n     implementation depLibs.curatorFramework\n     implementation depLibs.protobuf"},{"sha":"223f27ed4dc2f45b4638fffbeb3afa72824c4fa8","filename":"tools/stream/build.gradle","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/stream/build.gradle","raw_url":"https://github.com/apache/bookkeeper/raw/a522fa33b31e2405830a33cd2120be60d3174cd5/tools/stream/build.gradle","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/tools/stream/build.gradle?ref=a522fa33b31e2405830a33cd2120be60d3174cd5","patch":"@@ -41,7 +41,7 @@ dependencies {\n     implementation depLibs.commonsConfiguration\n     implementation depLibs.guava\n     implementation depLibs.jcommander\n-    implementation depLibs.slf4jLog4j\n+    implementation depLibs.log4j12api\n     implementation depLibs.zookeeper\n     implementation depLibs.curatorFramework\n     implementation depLibs.protobuf"}]}

