{"sha":"d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","node_id":"MDY6Q29tbWl0MTU3NTk1NjpkMWJiOGVjMGU3YzY1ZTI0MWY1NWM4YjcwMDM5NTU3MGUwZWU1ZGFm","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-03-25T05:48:01Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-03-25T05:48:01Z"},"message":"BOOKKEEPER-583: Read from a ReadOnlyBookie fails if index fileinfo is not in ledger cache (vinay via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1460524 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"effa3e92e565b3460aa3987b8a3c1ea805f3ba1c","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/effa3e92e565b3460aa3987b8a3c1ea805f3ba1c"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","html_url":"https://github.com/apache/bookkeeper/commit/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"f2bb5603ff33b8ac54bcdf2daddb61cf3e65de80","url":"https://api.github.com/repos/apache/bookkeeper/commits/f2bb5603ff33b8ac54bcdf2daddb61cf3e65de80","html_url":"https://github.com/apache/bookkeeper/commit/f2bb5603ff33b8ac54bcdf2daddb61cf3e65de80"}],"stats":{"total":41,"additions":38,"deletions":3},"files":[{"sha":"b97c054d7f02f22e9171c467d5bbcf856f9d252f","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","patch":"@@ -52,6 +52,8 @@ Trunk (unreleased changes)\n \n       BOOKKEEPER-557: Compiler error showing up badly with jdk 7 (ivank via sijie)\n \n+      BOOKKEEPER-583: Read from a ReadOnlyBookie fails if index fileinfo is not in ledger cache (vinay via sijie)\n+\n Release 4.2.0 - 2013-01-14\n \n   Non-backward compatible changes:"},{"sha":"9d4ae5e53bbdd41276f37aa5a088c10beec67cad","filename":"bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java","status":"modified","additions":0,"deletions":3,"changes":3,"blob_url":"https://github.com/apache/bookkeeper/blob/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java","raw_url":"https://github.com/apache/bookkeeper/raw/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCacheImpl.java?ref=d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","patch":"@@ -263,9 +263,6 @@ FileInfo getFileInfo(Long ledger, byte masterKey[]) throws IOException {\n                 }\n                 evictFileInfoIfNecessary();\n                 fi = new FileInfo(lf, masterKey);\n-                if (ledgerDirsManager.isDirFull(getLedgerDirForLedger(fi))) {\n-                    moveLedgerIndexFile(ledger, fi);\n-                }\n                 fileInfoCache.put(ledger, fi);\n                 openLedgers.add(ledger);\n             }"},{"sha":"47633a24bfbb85ba066539cb9c7672b1ae25eccb","filename":"bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ReadOnlyBookieTest.java","status":"modified","additions":36,"deletions":0,"changes":36,"blob_url":"https://github.com/apache/bookkeeper/blob/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ReadOnlyBookieTest.java","raw_url":"https://github.com/apache/bookkeeper/raw/d1bb8ec0e7c65e241f55c8b700395570e0ee5daf/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ReadOnlyBookieTest.java","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/ReadOnlyBookieTest.java?ref=d1bb8ec0e7c65e241f55c8b700395570e0ee5daf","patch":"@@ -184,4 +184,40 @@ public void testLedgerCreationShouldFailWithReadonlyBookie() throws Exception {\n             // Expected\n         }\n     }\n+\n+    /**\n+     * Try to read closed ledger from restarted ReadOnlyBookie.\n+     */\n+    public void testReadFromReadOnlyBookieShouldBeSuccess() throws Exception {\n+        LedgerHandle ledger = bkc.createLedger(2, 2, DigestType.MAC, \"\".getBytes());\n+        for (int i = 0; i < 10; i++) {\n+            ledger.addEntry(\"data\".getBytes());\n+        }\n+        ledger.close();\n+        bsConfs.get(1).setReadOnlyModeEnabled(true);\n+        bsConfs.get(1).setDiskCheckInterval(500);\n+        restartBookies();\n+\n+        // Check new bookie with readonly mode enabled.\n+        File[] ledgerDirs = bsConfs.get(1).getLedgerDirs();\n+        assertEquals(\"Only one ledger dir should be present\", 1, ledgerDirs.length);\n+        Bookie bookie = bs.get(1).getBookie();\n+        LedgerDirsManager ledgerDirsManager = bookie.getLedgerDirsManager();\n+\n+        // Now add the current ledger dir to filled dirs list\n+        ledgerDirsManager.addToFilledDirs(new File(ledgerDirs[0], \"current\"));\n+\n+        // Wait till Bookie converts to ReadOnly mode.\n+        Thread.sleep(1000);\n+        assertTrue(\"Bookie should be converted to readonly mode\", bookie.isRunning() && bookie.isReadOnly());\n+\n+        // Now kill the other bookie and read entries from the readonly bookie\n+        killBookie(0);\n+\n+        Enumeration<LedgerEntry> readEntries = ledger.readEntries(0, 9);\n+        while (readEntries.hasMoreElements()) {\n+            LedgerEntry entry = readEntries.nextElement();\n+            assertEquals(\"Entry should contain correct data\", \"data\", new String(entry.getEntry()));\n+        }\n+    }\n }"}]}

