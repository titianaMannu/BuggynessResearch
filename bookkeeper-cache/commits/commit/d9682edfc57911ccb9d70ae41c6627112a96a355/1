{"sha":"d9682edfc57911ccb9d70ae41c6627112a96a355","node_id":"MDY6Q29tbWl0MTU3NTk1NjpkOTY4MmVkZmM1NzkxMWNjYjlkNzBhZTQxYzY2MjcxMTJhOTZhMzU1","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-07-20T18:16:37Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2013-07-20T18:16:37Z"},"message":"BOOKKEEPER-635: jenkins build should highlight which lines of the patch cause raw analysis errors (ivank via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1505179 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"76928dea111afd057810db4906ef95b268e33f31","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/76928dea111afd057810db4906ef95b268e33f31"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/d9682edfc57911ccb9d70ae41c6627112a96a355","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/d9682edfc57911ccb9d70ae41c6627112a96a355","html_url":"https://github.com/apache/bookkeeper/commit/d9682edfc57911ccb9d70ae41c6627112a96a355","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/d9682edfc57911ccb9d70ae41c6627112a96a355/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"f3731732ce984f41b8530939254706f9e597583d","url":"https://api.github.com/repos/apache/bookkeeper/commits/f3731732ce984f41b8530939254706f9e597583d","html_url":"https://github.com/apache/bookkeeper/commit/f3731732ce984f41b8530939254706f9e597583d"}],"stats":{"total":71,"additions":66,"deletions":5},"files":[{"sha":"2e1259da6c30d69ad856dbed185ac618b9d49c87","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/d9682edfc57911ccb9d70ae41c6627112a96a355/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/d9682edfc57911ccb9d70ae41c6627112a96a355/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=d9682edfc57911ccb9d70ae41c6627112a96a355","patch":"@@ -42,6 +42,8 @@ Trunk (unreleased changes)\n \n       BOOKKEEPER-636: Latest txn logs might be deleted in a race condition which is not recoverable if BK goes down before next txn log created. (vinay via ivank)\n \n+      BOOKKEEPER-635: jenkins build should highlight which lines of the patch cause raw analysis errors (ivank via sijie)\n+\n       bookkeeper-server:\n \n         BOOKKEEPER-567: ReadOnlyBookieTest hangs on shutdown (sijie via ivank)"},{"sha":"b3bfd01af87e735b2aa6abdfe5c490160f4ea8be","filename":"bin/raw-check-patch","status":"added","additions":47,"deletions":0,"changes":47,"blob_url":"https://github.com/apache/bookkeeper/blob/d9682edfc57911ccb9d70ae41c6627112a96a355/bin/raw-check-patch","raw_url":"https://github.com/apache/bookkeeper/raw/d9682edfc57911ccb9d70ae41c6627112a96a355/bin/raw-check-patch","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bin/raw-check-patch?ref=d9682edfc57911ccb9d70ae41c6627112a96a355","patch":"@@ -0,0 +1,47 @@\n+#!/usr/bin/env bash\n+#\n+#   Licensed under the Apache License, Version 2.0 (the \"License\");\n+#   you may not use this file except in compliance with the License.\n+#   You may obtain a copy of the License at\n+#\n+#       http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#   Unless required by applicable law or agreed to in writing, software\n+#   distributed under the License is distributed on an \"AS IS\" BASIS,\n+#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#   See the License for the specific language governing permissions and\n+#   limitations under the License.\n+\n+printTrailingSpaces() {\n+    PATCH=$1\n+    cat $PATCH | awk '/^+/ { if (/ $/) { print \"\\tL\" NR \":\" $0} }'\n+}\n+\n+printTabs() {\n+    PATCH=$1\n+    cat $PATCH | awk '/^+/ { if (/\\t/) { print \"\\tL\" NR \":\" $0 } }'\n+}\n+\n+printAuthors() {\n+    PATCH=$1\n+    cat $PATCH | awk '/^+/ { L=tolower($0); if (L ~ /.*\\*.* @author/) { print \"\\tL\" NR \":\" $0 } }'\n+}\n+\n+printLongLines() {\n+    PATCH=$1\n+    cat $PATCH | awk '/^+/ { if ( length > 121 ) { print \"\\tL\" NR \":\" $0 } }'\n+}\n+\n+if [[ \"X$(basename -- \"$0\")\" = \"Xraw-check-patch\" ]]; then\n+    echo Trailing spaces\n+    printTrailingSpaces $1\n+    echo\n+    echo Tabs\n+    printTabs $1\n+    echo\n+    echo Authors\n+    printAuthors $1\n+    echo\n+    echo Long lines\n+    printLongLines $1\n+fi"},{"sha":"52c0b2f50006fb0e016172502ad84fd668d9c16b","filename":"bin/test-patch-05-patch-raw-analysis","status":"modified","additions":17,"deletions":5,"changes":22,"blob_url":"https://github.com/apache/bookkeeper/blob/d9682edfc57911ccb9d70ae41c6627112a96a355/bin/test-patch-05-patch-raw-analysis","raw_url":"https://github.com/apache/bookkeeper/raw/d9682edfc57911ccb9d70ae41c6627112a96a355/bin/test-patch-05-patch-raw-analysis","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bin/test-patch-05-patch-raw-analysis?ref=d9682edfc57911ccb9d70ae41c6627112a96a355","patch":"@@ -11,6 +11,7 @@\n #   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n #   See the License for the specific language governing permissions and\n #   limitations under the License.\n+source $(dirname \"$0\")/raw-check-patch\n \n if [ \"${TESTPATCHDEBUG}\" == \"true\" ] ; then\n     set -x\n@@ -74,37 +75,48 @@ parseArgs() {\n }\n ###############################################################################\n checkNoAuthors() {\n-    authorTags=`grep \"^+ \" ${PATCHFILE} | grep -c -i -e \".*\\*.* @author\"`\n+    TMPFILE=$TEMPDIR/$TASKNAME-authors.txt\n+    printAuthors $PATCHFILE > $TMPFILE\n+    authorTags=$(wc -l $TMPFILE | awk '{print $1}')\n     if [[ ${authorTags} != 0 ]] ; then\n         REPORT+=(\"{color:red}-1{color} the patch seems to contain ${authorTags} line(s) with @author tags\")\n+        REPORT+=(\"$(cat $TMPFILE)\")\n     else\n         REPORT+=(\"{color:green}+1{color} the patch does not introduce any @author tags\")\n     fi\n }\n ###############################################################################\n checkNoTabs() {\n-    tabs=`grep \"^+ \" ${PATCHFILE} | grep -c -P \"\\t\"`\n+    TMPFILE=$TEMPDIR/$TASKNAME-tabs.txt\n+    printTabs $PATCHFILE > $TMPFILE\n+    tabs=$(wc -l $TMPFILE | awk '{print $1}')\n     if [[ ${tabs} != 0 ]] ; then\n         REPORT+=(\"{color:red}-1{color} the patch contains ${tabs} line(s) with tabs\")\n+        REPORT+=(\"$(cat $TMPFILE)\")\n     else\n         REPORT+=(\"{color:green}+1{color} the patch does not introduce any tabs\")\n     fi\n }\n ###############################################################################\n checkNoTrailingSpaces() {\n-    trailingSpaces=`grep \"^+ \" ${PATCHFILE} | grep -c -e \" $\"`\n+    TMPFILE=$TEMPDIR/$TASKNAME-trailingspaces.txt\n+    printTrailingSpaces $PATCHFILE > $TMPFILE\n+    trailingSpaces=$(wc -l $TMPFILE | awk '{print $1}')\n     if [[ ${trailingSpaces} != 0 ]] ; then\n         REPORT+=(\"{color:red}-1{color} the patch contains ${trailingSpaces} line(s) with trailing spaces\")\n+        REPORT+=(\"$(cat $TMPFILE)\")\n     else\n         REPORT+=(\"{color:green}+1{color} the patch does not introduce any trailing spaces\")\n     fi\n }\n ###############################################################################\n checkLinesLength() {\n-  # We check for > 120 to account for the \"+\" sign\n-    longLines=`grep \"^+ \" ${PATCHFILE} | awk 'BEGIN{count=0}{if ( length > 121 ) { count=count+1} }END{ print count}'`\n+    TMPFILE=$TEMPDIR/$TASKNAME-trailingspaces.txt\n+    printLongLines $PATCHFILE > $TMPFILE\n+    longLines=$(wc -l $TMPFILE | awk '{print $1}')\n     if [[ ${longLines} != 0 ]] ; then\n         REPORT+=(\"{color:red}-1{color} the patch contains ${longLines} line(s) longer than 120 characters\")\n+        REPORT+=(\"$(cat $TMPFILE)\")\n     else\n         REPORT+=(\"{color:green}+1{color} the patch does not introduce any line longer than 120\")\n     fi"}]}

