{"sha":"db71147d9df0ad9efa697275e934330d21c99a88","node_id":"MDY6Q29tbWl0MTU3NTk1NjpkYjcxMTQ3ZDlkZjBhZDllZmE2OTcyNzVlOTM0MzMwZDIxYzk5YTg4","commit":{"author":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2012-07-05T05:26:09Z"},"committer":{"name":"Sijie Guo","email":"sijie@apache.org","date":"2012-07-05T05:26:09Z"},"message":"BOOKKEEPER-296: It's better provide stop script for bookie (nijel via sijie)\n\ngit-svn-id: https://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk@1357466 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"be6e4a9a0472ea1bd9478d8f0f995cefe848da6c","url":"https://api.github.com/repos/apache/bookkeeper/git/trees/be6e4a9a0472ea1bd9478d8f0f995cefe848da6c"},"url":"https://api.github.com/repos/apache/bookkeeper/git/commits/db71147d9df0ad9efa697275e934330d21c99a88","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/bookkeeper/commits/db71147d9df0ad9efa697275e934330d21c99a88","html_url":"https://github.com/apache/bookkeeper/commit/db71147d9df0ad9efa697275e934330d21c99a88","comments_url":"https://api.github.com/repos/apache/bookkeeper/commits/db71147d9df0ad9efa697275e934330d21c99a88/comments","author":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"committer":{"login":"sijie","id":1217863,"node_id":"MDQ6VXNlcjEyMTc4NjM=","avatar_url":"https://avatars.githubusercontent.com/u/1217863?v=4","gravatar_id":"","url":"https://api.github.com/users/sijie","html_url":"https://github.com/sijie","followers_url":"https://api.github.com/users/sijie/followers","following_url":"https://api.github.com/users/sijie/following{/other_user}","gists_url":"https://api.github.com/users/sijie/gists{/gist_id}","starred_url":"https://api.github.com/users/sijie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sijie/subscriptions","organizations_url":"https://api.github.com/users/sijie/orgs","repos_url":"https://api.github.com/users/sijie/repos","events_url":"https://api.github.com/users/sijie/events{/privacy}","received_events_url":"https://api.github.com/users/sijie/received_events","type":"User","site_admin":false},"parents":[{"sha":"6b249579f1cdf4e9fb940b0bf54b8d55a1ab38b2","url":"https://api.github.com/repos/apache/bookkeeper/commits/6b249579f1cdf4e9fb940b0bf54b8d55a1ab38b2","html_url":"https://github.com/apache/bookkeeper/commit/6b249579f1cdf4e9fb940b0bf54b8d55a1ab38b2"}],"stats":{"total":182,"additions":178,"deletions":4},"files":[{"sha":"49af1e1dba65855653f5bc5bb3da2290077d19c5","filename":"CHANGES.txt","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/bookkeeper/blob/db71147d9df0ad9efa697275e934330d21c99a88/CHANGES.txt","raw_url":"https://github.com/apache/bookkeeper/raw/db71147d9df0ad9efa697275e934330d21c99a88/CHANGES.txt","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/CHANGES.txt?ref=db71147d9df0ad9efa697275e934330d21c99a88","patch":"@@ -34,6 +34,8 @@ Trunk (unreleased changes)\n \n         BOOKKEEPER-318: Spelling mistake in MultiCallback log message. (surendra via sijie)\n \n+        BOOKKEEPER-296: It's better provide stop script for bookie (nijel via sijie)\n+\n       hedwig-client:\n \n         BOOKKEEPER-274: Hedwig cpp client library should not link to cppunit which is just used for test. (sijie via ivank)"},{"sha":"a2d0edec59410597eb988e450be5ddc3ba7ea1cb","filename":"bookkeeper-server/bin/bookkeeper","status":"modified","additions":12,"deletions":0,"changes":12,"blob_url":"https://github.com/apache/bookkeeper/blob/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/bin/bookkeeper","raw_url":"https://github.com/apache/bookkeeper/raw/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/bin/bookkeeper","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/bin/bookkeeper?ref=db71147d9df0ad9efa697275e934330d21c99a88","patch":"@@ -149,6 +149,18 @@ OPTS=\"$OPTS $BOOKIE_EXTRA_OPTS\"\n # Disable ipv6 as it can cause issues\n OPTS=\"$OPTS -Djava.net.preferIPv4Stack=true\"\n \n+# log directory & file\n+BOOKIE_ROOT_LOGGER=${BOOKIE_ROOT_LOGGER:-\"INFO,CONSOLE\"}\n+BOOKIE_LOG_DIR=${BOOKIE_LOG_DIR:-\"$BK_HOME/logs\"}\n+BOOKIE_LOG_FILE=${BOOKIE_LOG_FILE:-\"bookkeeper-server.log\"}\n+\n+#Configure log configuration system properties\n+OPTS=\"$OPTS -Dbookkeeper.root.logger=$BOOKIE_ROOT_LOGGER\"\n+OPTS=\"$OPTS -Dbookkeeper.log.dir=$BOOKIE_LOG_DIR\"\n+OPTS=\"$OPTS -Dbookkeeper.log.file=$BOOKIE_LOG_FILE\"\n+\n+#Change to BK_HOME to support relative paths\n+cd \"$BK_HOME\"\n if [ $COMMAND == \"bookie\" ]; then\n     exec java $OPTS $JMX_ARGS org.apache.bookkeeper.proto.BookieServer --conf $BOOKIE_CONF $@\n elif [ $COMMAND == \"localbookie\" ]; then"},{"sha":"2f29a2ec51297df98c7a61dcfb28b94289a48379","filename":"bookkeeper-server/bin/bookkeeper-daemon.sh","status":"added","additions":146,"deletions":0,"changes":146,"blob_url":"https://github.com/apache/bookkeeper/blob/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/bin/bookkeeper-daemon.sh","raw_url":"https://github.com/apache/bookkeeper/raw/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/bin/bookkeeper-daemon.sh","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/bin/bookkeeper-daemon.sh?ref=db71147d9df0ad9efa697275e934330d21c99a88","patch":"@@ -0,0 +1,146 @@\n+#!/usr/bin/env bash\n+#\n+#/**\n+# * Licensed to the Apache Software Foundation (ASF) under one\n+# * or more contributor license agreements.  See the NOTICE file\n+# * distributed with this work for additional information\n+# * regarding copyright ownership.  The ASF licenses this file\n+# * to you under the Apache License, Version 2.0 (the\n+# * \"License\"); you may not use this file except in compliance\n+# * with the License.  You may obtain a copy of the License at\n+# *\n+# *     http://www.apache.org/licenses/LICENSE-2.0\n+# *\n+# * Unless required by applicable law or agreed to in writing, software\n+# * distributed under the License is distributed on an \"AS IS\" BASIS,\n+# * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# * See the License for the specific language governing permissions and\n+# * limitations under the License.\n+# */\n+\n+usage=\"Usage: bookkeeper-daemon.sh (start|stop) <command> <args...>\"\n+supportedargs=\"Supported args : -force (accepted only with stop command) - Decides whether to stop the Bookie Server forcefully if not stopped by normal shutdown\"\n+\n+BINDIR=`dirname \"$0\"`\n+BK_HOME=`cd $BINDIR/..;pwd`\n+\n+if [ -f $BK_HOME/conf/bkenv.sh ]\n+then\n+ . $BK_HOME/conf/bkenv.sh\n+fi\n+\n+BOOKIE_LOG_DIR=${BOOKIE_LOG_DIR:-\"$BK_HOME/logs\"}\n+\n+BOOKIE_ROOT_LOGGER=${BOOKIE_ROOT_LOGGER:-'INFO,ROLLINGFILE'}\n+\n+BOOKIE_STOP_TIMEOUT=${BOOKIE_STOP_TIMEOUT:-30}\n+\n+BOOKIE_PID_DIR=${BOOKIE_PID_DIR:-$BK_HOME/bin}\n+\n+startStop=$1\n+shift\n+command=$1\n+shift\n+\n+export BOOKIE_LOG_DIR=$BOOKIE_LOG_DIR\n+export BOOKIE_ROOT_LOGGER=$BOOKIE_ROOT_LOGGER\n+export BOOKIE_LOG_FILE=bookkeeper-$command-$HOSTNAME.log\n+\n+pid=$BOOKIE_PID_DIR/bookkeeper-$command.pid\n+out=$BOOKIE_LOG_DIR/bookkeeper-$command-$HOSTNAME.out\n+logfile=$BOOKIE_LOG_DIR/$BOOKIE_LOG_FILE\n+\n+rotate_out_log ()\n+{\n+    log=$1;\n+    num=5;\n+    if [ -n \"$2\" ]; then\n+       num=$2\n+    fi\n+    if [ -f \"$log\" ]; then # rotate logs\n+        while [ $num -gt 1 ]; do\n+            prev=`expr $num - 1`\n+            [ -f \"$log.$prev\" ] && mv \"$log.$prev\" \"$log.$num\"\n+            num=$prev\n+        done\n+        mv \"$log\" \"$log.$num\";\n+    fi\n+}\n+\n+mkdir -p \"$BOOKIE_LOG_DIR\"\n+\n+case $startStop in\n+  (start)\n+    if [ -f $pid ]; then\n+      if kill -0 `cat $pid` > /dev/null 2>&1; then\n+        echo $command running as process `cat $pid`.  Stop it first.\n+        exit 1\n+      fi\n+    fi\n+\n+    rotate_out_log $out\n+    echo starting $command, logging to $logfile\n+    bookkeeper=$BK_HOME/bin/bookkeeper\n+    nohup $bookkeeper $command \"$@\" > \"$out\" 2>&1 < /dev/null &\n+    echo $! > $pid\n+    sleep 1; head $out\n+    sleep 2;\n+    if ! ps -p $! > /dev/null ; then\n+      exit 1\n+    fi\n+    ;;\n+\n+  (stop)\n+    if [ -f $pid ]; then\n+      TARGET_PID=`cat $pid`\n+      if kill -0 $TARGET_PID > /dev/null 2>&1; then\n+        echo stopping $command\n+        kill $TARGET_PID\n+\n+        count=0\n+        location=$BOOKIE_LOG_DIR\n+        while ps -p $TARGET_PID > /dev/null;\n+         do\n+          echo \"Shutdown is in progress... Please wait...\"\n+          sleep 1\n+          count=`expr $count + 1`\n+         \n+          if [ \"$count\" = \"$BOOKIE_STOP_TIMEOUT\" ]; then\n+                break\n+          fi\n+         done\n+        \n+        if [ \"$count\" != \"$BOOKIE_STOP_TIMEOUT\" ]; then\n+                 echo \"Shutdown completed.\"\n+                exit 0\n+        fi\n+                 \n+        if kill -0 $TARGET_PID > /dev/null 2>&1; then\n+              fileName=$location/$command.out\n+              $JAVA_HOME/bin/jstack $TARGET_PID > $fileName\n+              echo Thread dumps are taken for analysis at $fileName\n+              if [ \"$1\" == \"-force\" ]\n+              then\n+                 echo forcefully stopping $command\n+                 kill -9 $TARGET_PID >/dev/null 2>&1\n+                 echo Successfully stopped the process\n+              else\n+                 echo \"WARNNING :  Bookie Server is not stopped completely.\"\n+                 exit 1\n+              fi\n+        fi\n+      else\n+        echo no $command to stop\n+      fi\n+      rm $pid\n+    else\n+      echo no $command to stop\n+    fi\n+    ;;\n+\n+  (*)\n+    echo $usage\n+    echo $supportedargs\n+    exit 1\n+    ;;\n+esac"},{"sha":"24d3be0262cd119feed2b295bae5d343978b8519","filename":"bookkeeper-server/conf/bkenv.sh","status":"modified","additions":9,"deletions":0,"changes":9,"blob_url":"https://github.com/apache/bookkeeper/blob/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/conf/bkenv.sh","raw_url":"https://github.com/apache/bookkeeper/raw/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/conf/bkenv.sh","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/conf/bkenv.sh?ref=db71147d9df0ad9efa697275e934330d21c99a88","patch":"@@ -28,8 +28,17 @@\n # Log4j configuration file\n # BOOKIE_LOG_CONF=\n \n+# Logs location\n+# BOOKIE_LOG_DIR=\n+\n # Extra options to be passed to the jvm\n # BOOKIE_EXTRA_OPTS=\n \n # Add extra paths to the bookkeeper classpath\n # BOOKIE_EXTRA_CLASSPATH=\n+\n+#Folder where the Bookie server PID file should be stored\n+#BOOKIE_PID_DIR=\n+\n+#Wait time before forcefully kill the Bookie server instance, if the stop is not successful\n+#BOOKIE_STOP_TIMEOUT=\n\\ No newline at end of file"},{"sha":"1dadb3d69d0c9d812a493fc752beaa3e58de3f5b","filename":"bookkeeper-server/conf/log4j.properties","status":"modified","additions":9,"deletions":4,"changes":13,"blob_url":"https://github.com/apache/bookkeeper/blob/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/conf/log4j.properties","raw_url":"https://github.com/apache/bookkeeper/raw/db71147d9df0ad9efa697275e934330d21c99a88/bookkeeper-server/conf/log4j.properties","contents_url":"https://api.github.com/repos/apache/bookkeeper/contents/bookkeeper-server/conf/log4j.properties?ref=db71147d9df0ad9efa697275e934330d21c99a88","patch":"@@ -26,7 +26,12 @@\n # Format is \"<default threshold> (, <appender>)+\n \n # DEFAULT: console appender only\n-log4j.rootLogger=WARN, CONSOLE\n+# Define some default values that can be overridden by system properties\n+bookkeeper.root.logger=WARN,CONSOLE\n+bookkeeper.log.dir=.\n+bookkeeper.log.file=bookkeeper-server.log\n+\n+log4j.rootLogger=${bookkeeper.root.logger}\n \n # Example with rolling log file\n #log4j.rootLogger=DEBUG, CONSOLE, ROLLINGFILE\n@@ -46,20 +51,20 @@ log4j.appender.CONSOLE.layout.ConversionPattern=%d{ISO8601} - %-5p - [%t:%C{1}@%\n # Add ROLLINGFILE to rootLogger to get log file output\n #    Log DEBUG level and above messages to a log file\n log4j.appender.ROLLINGFILE=org.apache.log4j.DailyRollingFileAppender\n+\n log4j.appender.ROLLINGFILE.Threshold=INFO\n-log4j.appender.ROLLINGFILE.File=bookkeeper-server.log\n+log4j.appender.ROLLINGFILE.File=${bookkeeper.log.dir}/${bookkeeper.log.file}\n log4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayout\n log4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p - [%t:%C{1}@%L] - %m%n\n \n # Max log file size of 10MB\n-log4j.appender.ROLLINGFILE.MaxFileSize=10MB\n+#log4j.appender.ROLLINGFILE.MaxFileSize=10MB\n # uncomment the next line to limit number of backup files\n #log4j.appender.ROLLINGFILE.MaxBackupIndex=10\n \n log4j.appender.ROLLINGFILE.layout=org.apache.log4j.PatternLayout\n log4j.appender.ROLLINGFILE.layout.ConversionPattern=%d{ISO8601} - %-5p [%t:%C{1}@%L] - %m%n\n \n-\n #\n # Add TRACEFILE to rootLogger to get log file output\n #    Log DEBUG level and above messages to a log file"}]}

