{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12530339","self":"https://issues.apache.org/jira/rest/api/2/issue/12530339","key":"BOOKKEEPER-106","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"216077","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"173876","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-106/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@77b774ec[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2c4b16db[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6d0a476e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@198379da[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@319cd03c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@22e48a94[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1dea8891[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@1fa56f5f[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@486f41a7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@4ed9c214[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@73e755e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@33d52d71[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2011-11-15T18:45:41.289+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-106/watchers","watchCount":0,"isWatching":false},"created":"2011-11-04T16:19:55.753+0000","updated":"2011-12-07T15:56:11.130+0000","timeoriginalestimate":null,"description":"As the summary says, if you don't specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn't take care to select a bookie which is not is the ledgers ensemble.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12503380","id":"12503380","filename":"BOOKKEEPER-106.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-11T16:04:21.148+0000","size":59000,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12503380/BOOKKEEPER-106.diff"}],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13148550","id":"13148550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I've tries to unnest a little. \n\nLedger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.\n\nI've also added a couple of tests and some test framework stuff to verify that entries are all replicated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-11T16:04:21.274+0000","updated":"2011-11-11T16:04:21.274+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13148551","id":"13148551","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2806/\n-----------------------------------------------------------\n\nReview request for bookkeeper.\n\n\nSummary\n-------\n\nAs the summary says, if you don't specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn't take care to select a bookie which is not is the ledgers ensemble.\n\nAttached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I've tries to unnest a little.\n\nLedger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.\n\nI've also added a couple of tests and some test framework stuff to verify that entries are all replicated.\n\n\nThis addresses bug BOOKKEEPER-106.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-106\n\n\nDiffs\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a \n\nDiff: https://reviews.apache.org/r/2806/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-11T16:06:51.323+0000","updated":"2011-11-11T16:06:51.323+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13150495","id":"13150495","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2806/#review3253\n-----------------------------------------------------------\n\n\nIvan, It is not very easy to review this patch because there is reformatting mixed with the fix itself. My understanding is that the fix itself is essentially the implementation of getNewBookie and the changes to call it. Could you please describe the changes in slightly more detail so that it helps the review?\n\n\nbookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java\n<https://reviews.apache.org/r/2806/#comment7284>\n\n    Is the formatting of this block correct? It doesn't look like on review board but I need to check on a text editor.\n\n\n\nbookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java\n<https://reviews.apache.org/r/2806/#comment7283>\n\n    Is this todo to the lh.close that is commented out?\n\n\n- fpj\n\n\nOn 2011-11-11 16:05:38, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2806/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-11 16:05:38)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  As the summary says, if you don't specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn't take care to select a bookie which is not is the ledgers ensemble.\nbq.  \nbq.  Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I've tries to unnest a little.\nbq.  \nbq.  Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.\nbq.  \nbq.  I've also added a couple of tests and some test framework stuff to verify that entries are all replicated.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-106.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-106\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2806/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-15T13:53:51.701+0000","updated":"2011-11-15T13:53:51.701+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13150526","id":"13150526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2806/\n-----------------------------------------------------------\n\n(Updated 2011-11-15 14:40:58.957071)\n\n\nReview request for bookkeeper.\n\n\nSummary (updated)\n-------\n\nAs the summary says, if you don't specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn't take care to select a bookie which is not is the ledgers ensemble.\n\nA new bookie is now selected for each bookie & ledger metadata is now updated once each fragment has been replicated. There is a new algorithm for selecting the new bookie, which takes into account the current bookies.\n\nThe structure of the callbacks needed to be changed to allow an update for each individual fragment. Now when you recover a bookie, the recovery callback is wrapped a multi callback (MCB-LEDGERS) is created with a count equal to the number of ledgers which will be recovered. MCB-LEDGERS is passed to call to #recoverLedger for each ledger. #recoverLedger creates a multi callback (MCB-FRAGMENTS), with the number of fragments to be recovered as the count. Then a loop kicks off recovery for each fragment, passing a new SingleFragmentCallback to each. SingleFragmentCallback takes MCB-FRAGMENTS as a parameter, and triggers it each time a fragment recovery completes.\n\nSingleFragmentCallback and the fragment count multi callback, replace ledgerFragmentMcb, which wrapped LedgerMultiCallbackWrapper, which in turn wrapped MCB-LEDGERS. LedgerMultiCallbackWrapper updated the ledger metadata once during the recovery process, when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. The new approach, writes once per fragment. The callback restructuring was necessary to allow this.\n\nI've also added a couple of tests and some test framework stuff to verify that entries are all replicated.\n\n\nThis addresses bug BOOKKEEPER-106.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-106\n\n\nDiffs\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a \n\nDiff: https://reviews.apache.org/r/2806/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-15T14:41:51.607+0000","updated":"2011-11-15T14:41:51.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13150527","id":"13150527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2011-11-15 13:53:03, fpj wrote:\nbq.  > Ivan, It is not very easy to review this patch because there is reformatting mixed with the fix itself. My understanding is that the fix itself is essentially the implementation of getNewBookie and the changes to call it. Could you please describe the changes in slightly more detail so that it helps the review?\n\nThe refactoring in BookKeeperAdmin is part of the fix. The sequence of callbacks and the exact detail of what they do had to be restructured. I updated the description of the review to explain the change. Its quite complex. For BookieRecoveryTest.java, everything below line 430 is new. I had to move the test from org.apache.bookkeeper.test to org.apache.bookkeeper.client to allow it to access the metadata from the ledger handle.\n\n\nbq.  On 2011-11-15 13:53:03, fpj wrote:\nbq.  > bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java, line 600\nbq.  > <https://reviews.apache.org/r/2806/diff/1/?file=57480#file57480line600>\nbq.  >\nbq.  >     Is the formatting of this block correct? It doesn't look like on review board but I need to check on a text editor.\n\nWhat looks wrong with it? availableBookies is lined up with the start of the argument list which is in line with Sun conventions (http://www.oracle.com/technetwork/java/codeconventions-136091.html#248). \n\nThere's a few superfluous spaces (rb marks red), which i need to remove. \n\n\nbq.  On 2011-11-15 13:53:03, fpj wrote:\nbq.  > bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java, line 605\nbq.  > <https://reviews.apache.org/r/2806/diff/1/?file=57482#file57482line605>\nbq.  >\nbq.  >     Is this todo to the lh.close that is commented out?\n\nThis is something I need to open another JIRA for. Basically, if you recover a bookie, all ledgers recovered will have their zookeeper metadata changed. If another process is currently writing to the ledger, when they try to close the handle, they will get a KeeperException.BadVersion because the version of the ledger znode has changed. It's not a correctness issue, but more of something that could be annoying for users. \n\n\n- Ivan\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2806/#review3253\n-----------------------------------------------------------\n\n\nOn 2011-11-11 16:05:38, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/2806/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2011-11-11 16:05:38)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  As the summary says, if you don't specify a destBookie when doing recoveryBookieData, it will select at random from the available bookie list. It doesn't take care to select a bookie which is not is the ledgers ensemble.\nbq.  \nbq.  Attached patch fixes this problem and also cleans up BookKeeperAdmin a little. There were a lot of nested callbacks nested in more callbacks etc. I've tries to unnest a little.\nbq.  \nbq.  Ledger metadata is now updated on each fragment. It used to be updated when the whole ledger was recovered, but only specified a single possible ledger. This was incorrect as it could lead to underreplication. There can be contention in the writes to the ledger data, but just retry as the previously successful write should have updated the stat, and they will be writing from the same ledger handle.\nbq.  \nbq.  I've also added a couple of tests and some test framework stuff to verify that entries are all replicated.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-106.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-106\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java b3eb5b9 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java f1b3ad9 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java PRE-CREATION \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 6bac569 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java ac54d9a \nbq.  \nbq.  Diff: https://reviews.apache.org/r/2806/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-15T14:41:52.809+0000","updated":"2011-11-15T14:41:52.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13150669","id":"13150669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"+1, thanks Ivan! Committed revision 1202370 and 1202372. (I forgot to edit CHANGES.txt in the first commit.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-15T18:45:41.338+0000","updated":"2011-11-15T18:45:41.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12530339/comment/13150688","id":"13150688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in bookkeeper-trunk #217 (See [https://builds.apache.org/job/bookkeeper-trunk/217/])\n    BOOKKEEPER-106:\trecoveryBookieData can select a recovery bookie which is already in the ledgers ensemble (forgot to edit CHANGES.txt)\nBOOKKEEPER-106: recoveryBookieData can select a recovery bookie which is already in the ledgers ensemble\n\nfpj : \nFiles : \n* /zookeeper/bookkeeper/trunk/CHANGES.txt\n\nfpj : \nFiles : \n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookKeeperAdmin.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookieRecoveryTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-15T19:15:59.296+0000","updated":"2011-11-15T19:15:59.296+0000"}],"maxResults":7,"total":7,"startAt":0},"customfield_12311820":"0|i0u4jb:","customfield_12314139":null}}

