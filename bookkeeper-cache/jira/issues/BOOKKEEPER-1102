{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13089196","self":"https://issues.apache.org/jira/rest/api/2/issue/13089196","key":"BOOKKEEPER-1102","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335340","id":"12335340","description":"Release 4.5.0","name":"4.5.0","archived":false,"released":true,"releaseDate":"2017-08-10"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335340","id":"12335340","description":"Release 4.5.0","name":"4.5.0","archived":false,"released":true,"releaseDate":"2017-08-10"}],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjust2","name":"sjust2","key":"sjust2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Samuel Just","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314393","id":"12314393","name":"bookkeeper-client","description":"Bookkeeper client."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjust2","name":"sjust2","key":"sjust2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Samuel Just","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sjust2","name":"sjust2","key":"sjust2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Samuel Just","active":true,"timeZone":"Etc/UTC"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-1102/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@e7279ce[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@70e0ec4[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@507e2283[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@27f16e66[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@26677479[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@17feae3c[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@36b5fc7a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@1a9b2694[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7424d02[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@652f9c98[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7ce0ea6b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@3f0cdce5[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2017-08-01T06:40:46.629+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-1102/watchers","watchCount":3,"isWatching":false},"created":"2017-07-22T00:47:20.726+0000","updated":"2017-08-01T13:56:11.788+0000","timeoriginalestimate":null,"description":"org.apache.bookkeeper.client.BookKeeperDiskSpaceWeightedLedgerPlacementTest.testDiskSpaceWeightedBookieSelectionWithBookiesBeingAdded can intermittently fail depending on the timing of the client receiving the info back from the bookies.\n\nAdditionally, the synchronization in BookieInfoReader is more complicated than necessary and not entirely correct.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"org.apache.bookkeeper.client.BookKeeperDiskSpaceWeightedLedgerPlacementTest.testDiskSpaceWeightedBookieSelectionWithBookiesBeingAdded is unreliable","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13089196/comment/16108468","id":"16108468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sijie%40apache.org","name":"sijie@apache.org","key":"sijie@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Issue resolved by merging pull request 275\n            [https://github.com/apache/bookkeeper/pull/275]\n\n            {noformat}\n            commit a5f8580f53464065243a9af038935f5893434166\nAuthor:     Samuel Just <sjust@salesforce.com>\nAuthorDate: Mon Jul 31 23:34:07 2017 -0700\nCommit:     Sijie Guo <sijie@apache.org>\nCommitDate: Mon Jul 31 23:34:07 2017 -0700\n\n    BOOKKEEPER-1102: Clarify BookieInfoReader and fix associated test flappers\n    \n    BookieInfoReader:\n    \n    The previous syncronization logic wasn't really correct, and the logic\n    at the top of the method was far more complicated than it needed to be.\n    Restrict bookies to be non-null.  Restructure the code to simply use\n    the BookieInfoReader instance as a single lock.\n    \n    One significant behavioral change is that we scan every bookie not in\n    the map, and we clear from the map bookies which returned an error.\n    \n    Also, explicitely cache the most recent bookie set reported by the\n    BookieWatcher.  This eliminates the need to call into BookieWatcher\n    from getReadWriteBookieInfo and the corresponding error path.  The\n    periodic scan continues to explicitely check.\n    \n    Another departure is the addition of an explicit retry-on-error param to\n    trigger retry if any of the requests failed\n    (getBookieInfoRetryIntervalSeconds).  We'll only retry the ones that\n    actually failed (along with any new additions since the last run).  This\n    is useful because bookie startup triggers the addition of the bookie\n    node to zk before the bookie actually becomes available for the bookie\n    info request, so there can be rare races in the unit tests between\n    BookieInfoReader requesting the info and the bookie actually being up.\n    \n    Also, add a method to allow tests to wait for updates to be reflected.\n    \n    PerChannelBookieClient: fix error handling for BookieInfo keys\n    \n    Passing a key corresponding to a GET_BOOKIE_INFO operation to\n    errorOutReadKey results in a casting exception, clean up the invalid\n    calls.\n    \n    BookKeeperClusterTestCase: add killBookieAndWaitForZK\n    \n    Should reduce the need for tests to wait for an arbitrary period to let\n    the cluster \"settle\".\n    \n    BookKeeperDiskSpaceWeightedLedgerPlacementTest:\n    \n    This test was heavily time dependent, and the Thread.sleep values did\n    not work universally.  Instead, eliminate the arbitrary Thread.sleep\n    values and instead verify the free space changes on each change.\n    \n    Also, switch the delay on\n    testDiskSpaceWeightedBookieSelectionWithPeriodicBookieInfoUpdate\n    to simply use an atomic boolean to signal the value switch.\n    \n    Signed-off-by: Samuel Just <sjustsalesforce.com>\n    \n    Author: Samuel Just <sjust@salesforce.com>\n    \n    Reviewers: Enrico Olivelli <eolivelli@gmail.com>\n    \n    This patch had conflicts when merged, resolved by\n    Committer: Sijie Guo <sijie@apache.org>\n    \n    This closes #275 from athanatos/forupstream/BOOKKEEPER-1102\n\n            {noformat}\n            ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sijie%40apache.org","name":"sijie@apache.org","key":"sijie@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-08-01T06:40:46.694+0000","updated":"2017-08-01T06:40:46.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13089196/comment/16108941","id":"16108941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Jenkins build bookkeeper-master #1836 (See [https://builds.apache.org/job/bookkeeper-master/1836/])\nBOOKKEEPER-1102: Clarify BookieInfoReader and fix associated test (sijie: [https://github.com/apache/bookkeeper/commit/a5f8580f53464065243a9af038935f5893434166])\n* (edit) bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookKeeperDiskSpaceWeightedLedgerPlacementTest.java\n* (edit) bookkeeper-server/src/main/java/org/apache/bookkeeper/conf/ClientConfiguration.java\n* (edit) bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/PerChannelBookieClient.java\n* (edit) bookkeeper-server/src/main/java/org/apache/bookkeeper/client/BookieInfoReader.java\n* (edit) bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BookKeeperClusterTestCase.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-01T13:56:11.788+0000","updated":"2017-08-01T13:56:11.788+0000"}],"maxResults":2,"total":2,"startAt":0},"customfield_12311820":"0|i3hvhr:","customfield_12314139":null}}

