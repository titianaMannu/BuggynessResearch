{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12533637","self":"https://issues.apache.org/jira/rest/api/2/issue/12533637","key":"BOOKKEEPER-137","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12319145","id":"12319145","name":"4.1.0","archived":false,"released":true,"releaseDate":"2012-06-13"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"219364","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[{"id":"12347977","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12347977","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12541649","key":"BOOKKEEPER-165","self":"https://issues.apache.org/jira/rest/api/2/issue/12541649","fields":{"summary":"Add versioning support for journal files","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"61749","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-137/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@3589fb3d[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2ee46936[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4a82d97[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@98849ed[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@52f71f09[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@3f132507[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7a1263e7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@319e8a69[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5b7bd404[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@7d66e971[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1482a061[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@518aad5a[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2012-02-09T17:15:25.937+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-137/watchers","watchCount":1,"isWatching":false},"created":"2011-12-02T14:58:10.229+0000","updated":"2012-10-22T14:50:13.878+0000","timeoriginalestimate":null,"description":"This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12513827","id":"12513827","filename":"BOOKKEEPER-137.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-08T15:53:48.884+0000","size":34254,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12513827/BOOKKEEPER-137.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12513648","id":"12513648","filename":"BOOKKEEPER-137.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-07T18:11:32.919+0000","size":33854,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12513648/BOOKKEEPER-137.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512172","id":"12512172","filename":"BOOKKEEPER-137.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-27T14:53:22.137+0000","size":33857,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12512172/BOOKKEEPER-137.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12512161","id":"12512161","filename":"BOOKKEEPER-137.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-27T14:26:40.483+0000","size":33435,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12512161/BOOKKEEPER-137.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12505911","id":"12505911","filename":"BOOKKEEPER-137.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-12-02T17:53:35.867+0000","size":19191,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12505911/BOOKKEEPER-137.diff"}],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Do not create Ledger index files until absolutely necessary.","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13161748","id":"13161748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"This patch is ready to go, but is blocked by BOOKKEEPER-135 & BOOKKEEPER-136","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-12-02T17:53:35.980+0000","updated":"2011-12-02T17:53:35.980+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13194785","id":"13194785","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"This patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\n\nBOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-01-27T14:26:41.034+0000","updated":"2012-01-27T14:26:41.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13194789","id":"13194789","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/\n-----------------------------------------------------------\n\nReview request for bookkeeper.\n\n\nSummary\n-------\n\nThis is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\n\nThis patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\n\nBOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\n\n\nThis addresses bug BOOKKEEPER-137.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-137\n\n\nDiffs\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 \n\nDiff: https://reviews.apache.org/r/3661/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T14:30:09.789+0000","updated":"2012-01-27T14:30:09.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13194815","id":"13194815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/\n-----------------------------------------------------------\n\n(Updated 2012-01-27 14:54:04.113114)\n\n\nReview request for bookkeeper.\n\n\nChanges\n-------\n\nThere was one compile error fix I hadn't committed.\n\n\nSummary\n-------\n\nThis is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\n\nThis patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\n\nBOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\n\n\nThis addresses bug BOOKKEEPER-137.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-137\n\n\nDiffs (updated)\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 \n\nDiff: https://reviews.apache.org/r/3661/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-27T14:54:09.000+0000","updated":"2012-01-27T14:54:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13200342","id":"13200342","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/#review4819\n-----------------------------------------------------------\n\n\n\nbookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java\n<https://reviews.apache.org/r/3661/#comment10582>\n\n    suppose the code running in journalLayoutVersion=1 directory. the first time is OK, since there would be no meta entries. but the code would add meta entries then. the next time bookie restarts, journalLayoutVersion is still 1, it would throw IOException.\n    \n    so do we need to upgrade the layout version when we run new code  in old data directories? \n\n\n\nbookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java\n<https://reviews.apache.org/r/3661/#comment10583>\n\n    if a ledger existed before, getHandle would checkAccess  of masterKey, which would call FileInfo#readHeader. Then isMasterKeyPersisted would call FileInfo#readHeader again, which is not necessary. \n    \n    I think it would be easy to avoid readHeader twice.\n\n\n- Sijie\n\n\nOn 2012-01-27 14:54:04, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/3661/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2012-01-27 14:54:04)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\nbq.  \nbq.  This patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\nbq.  \nbq.  BOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-137.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-137\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java cb3bb26 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java d2f959b \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java beab5e8 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 7403604 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/3661/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-04T06:17:54.128+0000","updated":"2012-02-04T06:17:54.128+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13201173","id":"13201173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"{quote}suppose the code running in journalLayoutVersion=1 directory. the first time is OK, since there would be no meta entries. but the code would add meta entries then. the next time bookie restarts, journalLayoutVersion is still 1, it would throw IOException.\n\nso do we need to upgrade the layout version when we run new code in old data directories? {quote}\n\nThis is true, I need to add upgrade logic. I may separate this out into another JIRA.\n\n{quote}\nif a ledger existed before, getHandle would checkAccess of masterKey, which would call FileInfo#readHeader. Then isMasterKeyPersisted would call FileInfo#readHeader again, which is not necessary.\n\nI think it would be easy to avoid readHeader twice.\n{quote}\nIm not clear on this point. checkAccess doesn't call #readHeader at all.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-06T09:43:45.832+0000","updated":"2012-02-06T09:43:45.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13201195","id":"13201195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"{quote}\nIm not clear on this point. checkAccess doesn't call #readHeader at all.\n{quote}\n\n#checkAccess => #getMasterKey => #readHeader","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-06T10:20:10.258+0000","updated":"2012-02-06T10:20:10.258+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13201223","id":"13201223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Ah yes, you're right, it calls it through #checkOpen. This should be simple to resolve.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-06T11:13:49.063+0000","updated":"2012-02-06T11:13:49.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13202587","id":"13202587","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"New patch, addresses Sijie's comments, now only depends on BOOKKEEPER-165\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-07T18:11:33.017+0000","updated":"2012-02-07T18:11:33.017+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13202590","id":"13202590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/\n-----------------------------------------------------------\n\n(Updated 2012-02-07 18:13:15.812700)\n\n\nReview request for bookkeeper.\n\n\nChanges\n-------\n\nNew diff, addresses Sijie's comments. Diffed against trunk with BOOKKEEPER-165 applied.\n\n\nSummary\n-------\n\nThis is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\n\nThis patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\n\nBOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\n\n\nThis addresses bug BOOKKEEPER-137.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-137\n\n\nDiffs (updated)\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 \n\nDiff: https://reviews.apache.org/r/3661/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-07T18:14:59.961+0000","updated":"2012-02-07T18:14:59.961+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13203674","id":"13203674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/#review4903\n-----------------------------------------------------------\n\n\nmost is good to me. thanks Ivan, except a BookieException is missing in BaseTestCase that I commented as below.\n\nand it seems that new patch doesn't fix the readHeader twice problem.\n\n\nbookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java\n<https://reviews.apache.org/r/3661/#comment10799>\n\n    this patch applied to trunk would compile fail. due to in BOOKKEEPER-156, start bookie action has been put in startBookie function. so it need to add BookieException also in startBookie.\n\n\n- Sijie\n\n\nOn 2012-02-07 18:13:15, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/3661/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2012-02-07 18:13:15)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\nbq.  \nbq.  This patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\nbq.  \nbq.  BOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-137.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-137\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/3661/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-08T15:39:59.230+0000","updated":"2012-02-08T15:39:59.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13203680","id":"13203680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n\nbq.  On 2012-02-08 15:39:47, Sijie Guo wrote:\nbq.  > most is good to me. thanks Ivan, except a BookieException is missing in BaseTestCase that I commented as below.\nbq.  > \nbq.  > and it seems that new patch doesn't fix the readHeader twice problem.\n\nAh, will fix the BookieException thing and upload a new patch against trunk.\n\nThe readHeader issue has been fixed. It can still be called twice, but if the file has already been opened, it returns immediately.\n\n\n- Ivan\n\n\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/#review4903\n-----------------------------------------------------------\n\n\nOn 2012-02-07 18:13:15, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/3661/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2012-02-07 18:13:15)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\nbq.  \nbq.  This patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\nbq.  \nbq.  BOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-137.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-137\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 99b797f \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java PRE-CREATION \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 0fc5206 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java PRE-CREATION \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java db1a763 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/3661/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-08T15:49:58.138+0000","updated":"2012-02-08T15:49:58.138+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13203682","id":"13203682","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/\n-----------------------------------------------------------\n\n(Updated 2012-02-08 15:53:28.318711)\n\n\nReview request for bookkeeper.\n\n\nChanges\n-------\n\nFixed compile error\n\n\nSummary\n-------\n\nThis is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\n\nThis patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\n\nBOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\n\n\nThis addresses bug BOOKKEEPER-137.\n    https://issues.apache.org/jira/browse/BOOKKEEPER-137\n\n\nDiffs (updated)\n-----\n\n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 8abe87a \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java 10ecac7 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 771c0ba \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 \n  bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java ae63710 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \n  bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 9750158 \n\nDiff: https://reviews.apache.org/r/3661/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nIvan\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-08T15:53:58.679+0000","updated":"2012-02-08T15:53:58.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13204339","id":"13204339","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"hmm, I can't find the code to avoid readHeader twice.\n\n{code}\n909     LedgerDescriptor l = getHandle(ledgerId, false, masterKey);\t\n910\tif (!l.isMasterKeyPersisted()) {\n{code}\n\nsuppose a ledger is existed before but not in cache. then readHeader still be called twice as below:\n\ngetHandle => createHandle => lh#checkAccess(masterKey) => the initial masterKey in lh is null, lh gets FileInfo#getMasterKey => no master key in FileInfo => FileInfo#checkOpen => FileInfo#readHeader (yes, it read header).\n\nlh#isMasterKeyPersisted (the initial masterKeyPersisted is false) => it will get FileInfo from LedgerCache => call FileInfo#readHeader (then, it read header again)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-02-09T07:57:26.690+0000","updated":"2012-02-09T07:57:26.690+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13204355","id":"13204355","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"#readHeader will be called twice. However, the second call will do nothing, as it will see that fc != null, and return immediately.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-09T08:30:02.399+0000","updated":"2012-02-09T08:30:02.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13204441","id":"13204441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/3661/#review4966\n-----------------------------------------------------------\n\nShip it!\n\n\nthanks Ivan for explanation. the new patch is ok for me. +1 \n\n- Sijie\n\n\nOn 2012-02-08 15:53:28, Ivan Kelly wrote:\nbq.  \nbq.  -----------------------------------------------------------\nbq.  This is an automatically generated e-mail. To reply, visit:\nbq.  https://reviews.apache.org/r/3661/\nbq.  -----------------------------------------------------------\nbq.  \nbq.  (Updated 2012-02-08 15:53:28)\nbq.  \nbq.  \nbq.  Review request for bookkeeper.\nbq.  \nbq.  \nbq.  Summary\nbq.  -------\nbq.  \nbq.  This is an optimization to speed up the case where we have many ledgers and are writing to them at random (a benchmark case we currently have). Currently, we create the ledger index file and write the first 1k of it to disk immediately. With a lot of ledgers being randomly written to, this means a lot of random writes on the ledger disk. This fix postpones the creation of the index file and writing of the first 1k until the first flush of the ledger.\nbq.  \nbq.  This patch includes BOOKKEEPER-136, as they both deal in the same area, and I found it difficult to separate them.\nbq.  \nbq.  BOOKKEEPER-135 is not required for this patch, and will need modifications after this goes in.\nbq.  \nbq.  \nbq.  This addresses bug BOOKKEEPER-137.\nbq.      https://issues.apache.org/jira/browse/BOOKKEEPER-137\nbq.  \nbq.  \nbq.  Diffs\nbq.  -----\nbq.  \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java 8abe87a \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java fa713c8 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java 10ecac7 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java 771c0ba \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java 728d729 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java 2228ab4 \nbq.    bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java 5706dd8 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java ae63710 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java c7b07e6 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java 8526db5 \nbq.    bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java 9750158 \nbq.  \nbq.  Diff: https://reviews.apache.org/r/3661/diff\nbq.  \nbq.  \nbq.  Testing\nbq.  -------\nbq.  \nbq.  \nbq.  Thanks,\nbq.  \nbq.  Ivan\nbq.  \nbq.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-09T10:52:58.359+0000","updated":"2012-02-09T10:52:58.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13204661","id":"13204661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Committed as r1242404. Thanks for reviewing Sijie.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-02-09T17:15:25.990+0000","updated":"2012-02-09T17:15:25.990+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12533637/comment/13204696","id":"13204696","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in bookkeeper-trunk #353 (See [https://builds.apache.org/job/bookkeeper-trunk/353/])\n    BOOKKEEPER-137: Do not create Ledger index files until absolutely necessary. (ivank)\n\nivank : \nFiles : \n* /zookeeper/bookkeeper/trunk/CHANGES.txt\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/Bookie.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/FileInfo.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/JournalChannel.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerCache.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/LedgerDescriptor.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/proto/BookieServer.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/util/LocalBookKeeper.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieJournalTest.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/BookieLayoutVersionTest.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieRecoveryTest.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/test/BaseTestCase.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-09T18:02:11.589+0000","updated":"2012-02-09T18:02:11.589+0000"}],"maxResults":18,"total":18,"startAt":0},"customfield_12311820":"0|i0axsv:","customfield_12314139":null}}

