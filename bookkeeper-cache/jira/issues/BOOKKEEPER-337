{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12598377","self":"https://issues.apache.org/jira/rest/api/2/issue/12598377","key":"BOOKKEEPER-337","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320244","id":"12320244","description":"Release 4.2.0","name":"4.2.0","archived":false,"released":true,"releaseDate":"2013-01-19"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"293553","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"169255","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-337/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@3c3d6e26[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3b1a4fb9[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7aecf3fd[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@13621c9e[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@43c77d3f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@51839f40[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4ceded96[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4fe89e79[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@37be3c3e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@7a0adc16[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@59281f9c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@52385996[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2012-08-28T08:52:13.841+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-337/watchers","watchCount":8,"isWatching":false},"created":"2012-07-11T14:03:38.291+0000","updated":"2013-02-13T15:46:50.923+0000","timeoriginalestimate":null,"description":"Scenario:\n========\nStart Five BK's\nWrite ledger's with ensemble three and quroum size=2\nwhile write inprogress down two bookies(Bookies should be in ensemble)\n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12539578","id":"12539578","filename":"BOOKKEEPER-337.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-07T14:49:38.126+0000","size":16077,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12539578/BOOKKEEPER-337.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12542409","id":"12542409","filename":"BOOKKEEPER-337.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-25T12:58:42.261+0000","size":20778,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12542409/BOOKKEEPER-337.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536400","id":"12536400","filename":"BOOKKEEPER-337.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-07-13T15:51:15.659+0000","size":1993,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12536400/BOOKKEEPER-337.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536389","id":"12536389","filename":"BOOKKEEPER-337-testtoreproduce.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-07-13T14:30:18.793+0000","size":6691,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12536389/BOOKKEEPER-337-testtoreproduce.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536188","id":"12536188","filename":"BOOKKEEPER-337-try.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-12T08:23:38.432+0000","size":3753,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12536188/BOOKKEEPER-337-try.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536553","id":"12536553","filename":"BOOKKEEPER-337-try2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-15T14:06:00.953+0000","size":13916,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12536553/BOOKKEEPER-337-try2.patch"}],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Add entry fails with MetadataVersionException when last ensemble has morethan one bookie failures","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13411538","id":"13411538","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"body":"I had faced this in HDFS-HA,where ANN got shutdown by throwing following..Here availoble bookies are seven even then addentry failed because continuous fail bookie fail which are in ensemble\n{noformat}\n2012-07-11 04:02:50,445 ERROR hidden.bkjournal.org.apache.bookkeeper.proto.PerChannelBookieClient: Invoked callback method: 1058\n2012-07-11 04:02:50,445 ERROR hidden.bkjournal.org.apache.bookkeeper.proto.PerChannelBookieClient: Could not write request for adding entry: 1058 ledger-id: 364 bookie: /HOST****.168:3183\n2012-07-11 04:02:50,445 WARN hidden.bkjournal.org.apache.bookkeeper.client.PendingAddOp: Write did not succeed: 364, 1058\n2012-07-11 04:02:50,445 ERROR hidden.bkjournal.org.apache.bookkeeper.proto.PerChannelBookieClient: Invoked callback method: 1058\n2012-07-11 04:02:50,445 ERROR hidden.bkjournal.org.apache.bookkeeper.proto.PerChannelBookieClient: Unexpected add response received from bookie: /HOST****.168:3183 for ledger: 364, entry: 1058 , ignoring\n2012-07-11 04:02:50,445 ERROR hidden.bkjournal.org.apache.bookkeeper.proto.PerChannelBookieClient: Unexpected add response received from bookie: /HOST****.168:3182 for ledger: 364, entry: 1058 , ignoring\n2012-07-11 04:02:50,981 ERROR hidden.bkjournal.org.apache.bookkeeper.client.LedgerHandle: Could not resolve ledger metadata conflict while changing ensemble to: [/HOST****.20:3181, /HOST****.168:3181, /10.18.52.55:3187], old meta data is \nBookieMetadataFormatVersion\t1\n2\n3\n0\n0\tHOST****.168:3183\tHOST****.168:3181\tHOST****.168:3182\n, new meta data is \nBookieMetadataFormatVersion\t1\n2\n3\n0\n0\tHOST****.168:3183\tHOST****.168:3181\tHOST****.168:3182\n1058\tHOST****.168:3183\tHOST****.168:3181\t10.18.52.55:3187\n ,closing ledger\n2012-07-11 04:02:51,366 FATAL org.apache.hadoop.hdfs.server.namenode.FSEditLog: Error: flush failed for required journal (JournalAndStream(mgr=org.apache.hadoop.contrib.bkjournal.BookKeeperJournalManager@f73f2c5, stream=org.apache.hadoop.contrib.bkjournal.BookKeeperEditLogOutputStream@5476b70))\njava.io.IOException: Failed to write to bookkeeper; Error is (-9) Error while using ZooKeeper\n\tat org.apache.hadoop.contrib.bkjournal.BookKeeperEditLogOutputStream.flushAndSync(BookKeeperEditLogOutputStream.java:141)\n\tat org.apache.hadoop.hdfs.server.namenode.EditLogOutputStream.flush(EditLogOutputStream.java:105)\n\tat org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalSetOutputStream$8.apply(JournalSet.java:460)\n\tat org.apache.hadoop.hdfs.server.namenode.JournalSet.mapJournalsAndReportErrors(JournalSet.java:319)\n\tat org.apache.hadoop.hdfs.server.namenode.JournalSet.access$200(JournalSet.java:50)\n\tat org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalSetOutputStream.flush(JournalSet.java:456)\n\tat org.apache.hadoop.hdfs.server.namenode.FSEditLog.logSync(FSEditLog.java:550)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock(FSNamesystem.java:2007)\n\tat org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.addBlock(NameNodeRpcServer.java:471)\n\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.addBlock(ClientNamenodeProtocolServerSideTranslatorPB.java:292)\n\tat org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java:42676)\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:427)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:916)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1692)\n\tat org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1688)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:396)\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1232)\n\tat org.apache.hadoop.ipc.Server$Handler.run(Server.java:1686)\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-07-11T14:09:50.938+0000","updated":"2012-07-11T14:09:50.938+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13412531","id":"13412531","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"I just tried the following test case by putting break points in the AbstractZkLedgerManager.writeLedgerMetadata()\n\nConsider the case, where added 5 entries and now the writer is idle.\nLedger metadata as follows: 0 - A B C\nSay bookies A and B got shutdown. Now, when the writer tries to add more entries it will try reforming the ensemble for A in first pass:\n0  - A B C\n5 - F B C\nThen in the second pass when tries to reform the ensemble for B, it is throwing ZK BadVersionException and not able to resolve the conflicts.\n\n----\n\n??I think the cause is simple, +due to the async setdata+, on handleBookieFailure() its just passing the request to zk and moving to process next ChannelBookieClient response. As the zk callback didn't responsed, this client response seeing the previous zkVersion and is causing the trouble.??\n\nAbstractZkLedgerManager.java\n{code}\npublic void writeLedgerMetadata(final long ledgerId, final LedgerMetadata metadata,\n                                    final GenericCallback<Void> cb) {\n        //.....\n        //.....\n        zk.setData(getLedgerPath(ledgerId),\n                   metadata.serialize(), zv.getZnodeVersion(),\n                   new StatCallback() {\n{code}\n\nIt would be great to know the opinion from others also.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-07-12T05:42:16.620+0000","updated":"2012-07-12T05:42:16.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13412604","id":"13412604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"yup, ur right. the confliction occurred due to there are more than two changing-same-ensemble requests sending on-the-fly. but LedgerMetadata#resolveConflict doesn't handle this case. so it threw the MetadataVersionException. \n\nI think the simple fix would be improve LedgerMetadata#resolveConflict to handle this case. I attached a draft about it and also add some logging messages to inform users that there are more than two changing-same-ensemble requests are processing.\n\nbut I don't think the fix is best. since it introduced overhead to maintain confliction cases that we need to handle in LedgerMetadata#resolveConflict. for long term plan, seems that we need to find better solution to resolve confliction. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-12T08:23:38.568+0000","updated":"2012-07-12T08:23:38.568+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13413703","id":"13413703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"@Sijie\nIs there any chance of multiple-thread execution in the following snippet? (I'm just doubting, since all these callbacks are getting invoked upon netty server notifications)\n{code}BookieClient.addEntry(args....){\nfinal PerChannelBookieClient client = lookupClient(addr);\n        client.connectIfNeededAndDoOp(new GenericCallback<Void>() {\n            @Override\n            public void operationComplete(int rc, Void result) {\n                if (rc != BKException.Code.OK) {\n                    cb.writeComplete(rc, ledgerId, entryId, addr, ctx);\n                    return;\n                }\n                client.addEntry(ledgerId, masterKey, entryId, toSend, cb, ctx, options);\n            }\n        });\n}\n{code}\n\nAssume we have ensemble like 0 A B C D E\nSay, A B C are down in a row and now reached the callback of A's failure, sametime B's connect failure, then sametime C's connect failure?\nIf yes, all three guys will do modifying the ledger metadata(ensemble) at the sametime and will clash eachother. Any thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-07-13T13:06:10.566+0000","updated":"2012-07-13T13:06:10.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13413778","id":"13413778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"Attached the test case to reproduce the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-07-13T14:30:18.860+0000","updated":"2012-07-13T14:30:18.860+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13413835","id":"13413835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"The solution has to be at the handleBookieFailure level and not the resolveConflict level, because otherwise it could try replace both failed bookie with the same new bookie. I think it's quite straightforward though. \n\nSuggested fix attached.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-07-13T15:51:15.691+0000","updated":"2012-07-13T15:51:15.691+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13414637","id":"13414637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"yup, Ivan's patch is quite simple and straightforward. but as Rakesh mentioned in previous comment, #handleBookieFailure would be called concurrently to recover same ensemble. so metadata.currentEnsemble would be changed several times before the write callback executed.\n\nsuppose, we had ensemble [ A, B, C, D, E ]. A, B, C are down, F, G, H is available.\nA -> handleBookieFailure to replace A with F. [F, B, C, D, E]. write request 1 is sent to zookeeper.\nB -> handleBookieFailure to replace B with G. [F, G, C, D, E]. write request 2 is sent to zookeeper.\nC -> handleBookieFailure to replace C with H. [F, G, H, D, E]. write request 3 is sent to zookeeper.\n\nwrite request 1 is back. succeed.\nwrite request 2 should fail due to metadata version conflict. so it would call #handleBookieFailure again, but its current ensemble is [F, G, H, D, E], there is no other bookie could be picked up to replace G.\n\nthe problem here is we don't have any synchronization on metadata.currentEnsemble. so we got confused when metadata version conflicts. so we had to have synchronized on metadata.currentEnsemble to avoid correct bookie replacement is modified by wrong replacement. also we not only check new metadata's currentEnsemble but also need to check current metadata's currentEnsemble to see whether that bookie has been replaced before. if it has been replaced before, we should not do #handleBookieFailure again.\n\nattach a new patch based on Ivan's patch and Rakesh's test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-07-15T14:05:32.884+0000","updated":"2012-07-15T14:05:32.884+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13430870","id":"13430870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"@Ivan @Sijie\nThanks a lot for your thoughts. I've modified the logic little bit, please review.\n\nLatest patch contains:\n# synchronized block while replacing the failed bookie in the ensemble. This is done to avoid concurrent ensemble modification (same as mentioned in the above discussion threads)\n# When there is a zversion conflict, \n - first would check the metadata state, return false and throws exception if the state mismatches\n - update znode version\n - then if my changes doesn't exists in zk, writeLedgerConfig(), otw again back to handleFailure\n - return success and continue with write req, if in-memory structure is insync with zk.\n\n\n@Sijie\nI'm thinking the resolveconflicts() would not required to have the currentStartEntryId checks. Instead it can be generic by only checking the states. Any thoughts?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-08T05:06:11.063+0000","updated":"2012-08-08T05:06:11.063+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13430880","id":"13430880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"seems that the patch is based my last patch just changing currentStartEntryId check to state check, right? \n\nstate check is missed in my last patch, which is necessary. as you described, there would be only one ensemble used to write at that time, checking currentStartEntryId is trivial. so I am OK with this change.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-08-08T05:32:20.351+0000","updated":"2012-08-08T05:32:20.351+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13430884","id":"13430884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"@Sijie\nThanks for your time and review.\nYup, I've rebased the patch as mentioned in my above comments. Also added one more test case with async writes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-08T05:44:51.858+0000","updated":"2012-08-08T05:44:51.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13434057","id":"13434057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"@Ivan \nIt would be great if you could also review the proposed changes and push the issue in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-14T11:37:09.023+0000","updated":"2012-08-14T11:37:09.023+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13436832","id":"13436832","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"{code}\n// Update ledger metadata in zk, if in-memory metadata doesn't contains\n// the failed bookie.\nif (!metadata.currentEnsemble.get(bookieIndex).equals(addr)) {\n    LOG.info(\"Resolve ledger metadata conflict while changing ensemble to: \"\n             + newEnsemble + \", old meta data is \\n\"\n             + new String(metadata.serialize())\n             + \"\\n, new meta data is \\n\" + new String(newMeta.serialize()));\n    writeLedgerConfig(new ChangeEnsembleCb());\n} else {\n    handleBookieFailure(addr, bookieIndex);\n}\n{code}\nI don't think the else part of this can ever be reached. Could you give an example of how it could be?\n\nAlso, it would be good to move define the callback for rereadMetadata in the same way as ChangeEnsembleCb as the nesting is going a bit too deep.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-08-17T16:23:03.648+0000","updated":"2012-08-17T16:23:03.648+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13438490","id":"13438490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks a lot Ivan for the reviews.\n\n@Ivan\nbq.I don't think the else part of this can ever be reached. Could you give an example of how it could be?\n\nYeah you're correct, there is no straight away scenario. What I referred is, LedgerHandle#recover() is directly replacing \"metadata = newMeta;\". (Will come only if recovery and write calls from same bkclient)\n\n{code}\nsynchronized void recover(final GenericCallback<Void> cb) {\n  public void operationComplete(int rc, LedgerMetadata newMeta) {\n     if (rc != BKException.Code.OK) {\n         cb.operationComplete(rc, null);\n     } else {\n         metadata = newMeta;\n         recover(cb);\n      }\n  }\n{code}\n\nAlso, I know its a very corner case and I just included it as defensive coding.\n\nbq.Also, it would be good to move define the callback for rereadMetadata in the same way as ChangeEnsembleCb as the nesting is going a bit too deep\n\nSure. I'll refactor it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-21T06:45:22.853+0000","updated":"2012-08-21T06:45:22.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13440970","id":"13440970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Sijie,\n\nIts great and will help us to shape our thoughts on the following case. I hope you were also thinking about handlingBookieFailure?\nAlso, could you please check my previous comment to get more on my view.\n\nbq.I don't think the else part of this can ever be reached.\n{code}\nif (!metadata.currentEnsemble.get(bookieIndex).equals(addr)) {\n\n} else {\n    handleBookieFailure(addr, bookieIndex);\n}\n{code}\n\nThanks,\nRakesh","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-24T05:44:13.864+0000","updated":"2012-08-24T05:44:13.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13441888","id":"13441888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Ivan,\n\nbq.I don't think the else part of this can ever be reached. Could you give an example of how it could be?\nIf I understood your point, you are saying an optimistic approach of resolveConflicts. \nAs I mentioned in the above [comments|https://issues.apache.org/jira/browse/BOOKKEEPER-337?focusedCommentId=13438490&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13438490],  I could see only the close/recovery logic can concurrently do the metadata modifications. Anyway in that scenario, after the ensemble change while sendWrite() request this guy will get fenced exception. So I agree with you to remove the \"else block\" as part of this issue.\n\nI've attached new patch with the following changes:\n# removed the else part\n# refactored the deep callbacks\n\n\nCould you please look at the new patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rakeshr","name":"rakeshr","key":"rakeshr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rakeshr&avatarId=29267","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rakeshr&avatarId=29267","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rakeshr&avatarId=29267","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rakeshr&avatarId=29267"},"displayName":"Rakesh Radhakrishnan","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-25T13:17:58.777+0000","updated":"2012-08-25T13:17:58.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13443035","id":"13443035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Committed r1378023. Good work Rakesh.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2012-08-28T08:52:13.849+0000","updated":"2012-08-28T08:52:13.849+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12598377/comment/13443040","id":"13443040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in bookkeeper-trunk #676 (See [https://builds.apache.org/job/bookkeeper-trunk/676/])\n    BOOKKEEPER-337: Add entry fails with MetadataVersionException when last ensemble has morethan one bookie failures (rakeshr via ivank) (Revision 1378023)\n\n     Result = SUCCESS\nivank : \nFiles : \n* /zookeeper/bookkeeper/trunk/CHANGES.txt\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/main/java/org/apache/bookkeeper/client/LedgerHandle.java\n* /zookeeper/bookkeeper/trunk/bookkeeper-server/src/test/java/org/apache/bookkeeper/client/BookieWriteLedgerTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-28T09:13:05.075+0000","updated":"2012-08-28T09:13:05.075+0000"}],"maxResults":17,"total":17,"startAt":0},"customfield_12311820":"0|i0tc0f:","customfield_12314139":null}}

