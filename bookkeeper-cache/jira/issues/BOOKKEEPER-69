{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12525013","self":"https://issues.apache.org/jira/rest/api/2/issue/12525013","key":"BOOKKEEPER-69","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"34387","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314391","id":"12314391","name":"hedwig-client","description":"Hedwig client."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12314392","id":"12314392","name":"hedwig-server","description":"Hedwig server."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"173908","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-69/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@25c3219b[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@67d60911[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@28925bf5[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@7f5b5177[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@538bafe9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@4c8d8b24[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@76fa3cb3[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@530f0bf2[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5d75129d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@7d8176bc[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5a39d21b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@71421235[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2011-11-18T10:39:01.596+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-69/watchers","watchCount":0,"isWatching":false},"created":"2011-09-28T06:01:27.641+0000","updated":"2011-12-07T15:56:06.899+0000","timeoriginalestimate":null,"description":"1) machine perf10 is rebooted. the bookie server & hub server are not restarted automatically after reboot.\n2) client 1 & client 2 are still running. the topics owned in perf10 will be re-assigned to perf8/perf9. but they would fail because not enough bookie servers are available.\n3) after 2 hours, we found that perf10 is rebooted. we restarted bookie server & hub server on perf10\n4) then we got ServerRedirectLoopException in client.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12502116","id":"12502116","filename":"bookkeeper-69.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-03T08:40:43.023+0000","size":45703,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12502116/bookkeeper-69.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12497401","id":"12497401","filename":"bookkeeper-69.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-02T12:34:00.585+0000","size":44347,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12497401/bookkeeper-69.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504052","id":"12504052","filename":"bookkeeper-69.patch_v2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-17T10:55:48.077+0000","size":12317,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12504052/bookkeeper-69.patch_v2"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12503094","id":"12503094","filename":"BOOKKEEPER-69.possiblefix.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-09T15:40:43.201+0000","size":1630,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12503094/BOOKKEEPER-69.possiblefix.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12497270","id":"12497270","filename":"bookkeeper-69-testcase.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-01T06:52:16.608+0000","size":10683,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12497270/bookkeeper-69-testcase.patch"}],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"ServerRedirectLoopException when a machine (hosts bookie server & hub server) reboot, which is caused by race condition of topic manager","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"3 machines (perf8, perf9, perf10), each machine hosts a bookie server & a hub server.\nperf8 is used as default server for client 1. perf9 is used as default server for client 2.\n\nbookkeeper is configured as below:\nensemble size is 3, quorum size is 2.","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13116218","id":"13116218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"h2. 0. investigation\n\nwe did some investigation on the ServerRedirectLoopException topic, said topic-0.\nfrom zookeeper, topic-0 is owned by perf9.\nwe dump the hub server jvm of perf8 / perf9. we found that topic-0 is owned by both perf8 and perf9.\nin perf8, topic-0 is owned in topic manger but not in persistence manager.\n\nh2. 1. Cause \n\nThe ServerRedirectLoopException \"Already made the request before to redirected host: \" is caused by \"topic manager own topic but persistence manager doesn't\".\n\nif \"topic manager own topic\", a subscription request will call persistence manager to get current seq id of the topic. if the persistence manager doesn't has the topic info, persistence manager will throw a ServerNotResponsibleForTopicException with *empty redirect host*.\n\n{code:title=BookKeeperPersistenceManager.java|borderStyle=solid}\n        TopicInfo topicInfo = topicInfos.get(topic);\n\n        if (topicInfo == null) {\n            throw new PubSubException.ServerNotResponsibleForTopicException(\"\");\n        }\n{code}\n\nhub server will send *NOT_RESPONSIBLE_FOR_TOPIC* to hedwig client.\n\nclient handles redirect request, and it found that no host to redirect. it will try default server again, but the default server has been in tried server list. \nclient throws ServerRedirectLoopException.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-28T06:15:09.558+0000","updated":"2011-09-28T06:15:09.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13116227","id":"13116227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"h4. why topic manager own topic but persistence manager doesn't own topic.\n\nfirst, the topic acquisition flow and release topic flow when exception are stated as below:\n\nacquireTopic:\n\n{quote}\na) check topics list, if the topic is in topic set owned by this hub server, return itself.\nb) then, read the zk server to know who is the owner of the topic (async)\n    i) if the node existed and the owner is not itself, return the owner and send a redirect response to client.\n    ii) if the node existed and the owner is itself, then *it consider the zk node is stale. topic manager will delete it and go to c)*\n    iii) if the node is not existed go to c)\nc) choose or claim a topic.\n     i) if the topic manager succeed to acquire the topic, it will call listeners (persistence/subscriptions/region manager) to do their topic acquisition logic. (async)\n        a) if all the listeners succeed to acquire topic, topic manager add the topic to topic set.\n        b) if one of the listeners failed, topic manager starts to do 'lostTopic' logic.\n{quote}        \n\nlostTopic:\n\n{quote}\na) first topic manager removes topic from topic set.\nb) ask all the listeners (persistence/subscriptions/region manager) to do 'lostTopic' logic (just put a releaseOp in their queues).\n{quote}\n\nIn our case, there are some parallel subscribe requests sent during we restart bookkeeper server.\nFor ease, we assume 'sub-1' and 'sub-2' subscribe 'topic-0' in default server A at the same time.\n\n1) two topic acquire ops will be executed asynchronously.\n\n2) sub-1 acquire op succeed to claim the hub server as the topic owner ( in c) ) (the owner zk node is created). And it call listeners (persistence/subscriptions/region manager) to do their topic acquisition logic. these manager will just put an acquire op in their queues, as below.\n\n{quote}\n> Persistence Manager <\n| sub-1 acquire op |\n{quote}\n\n3) then sub-2 acquire op executed. since sub-1 doesn't callback, so the topic will not in topic set. sub-2 will got to b)-ii). sub-2 deletes the zk node created by sub-1. and sub-2 does same logic as sub-1 in 2)\n\n{quote}\n> Persistence Manager <\n| sub-1 acquire op |\n| sub-2 acquire op |\n{quote}\n\n4) if bookkeeper restart from failure between sub-1 acquire op execution and sub-2 acquire op execution in persistence manager. sub-1 acquire op will fail due to NotEnoughBookieException. sub-1 will enter lost topic logic. A release op will be added in persistence manager queue.\n\n{quote}\n> Persistence Manager <\n| sub-2 acquire op |\n| sub-1 release op |\n{quote}\n\n5) sub-2 acquire op is executed successfully, because the bookkeeper server has been restarted. the topic will be added to topic manager's topic set.\n\n{quote}\n> Persistence Manager <\n| sub-1 release op |\n{quote}\n\n6) sub-1 release op is executed. it deletes the topic info in persistence manager. so we have *the topic in topic manager but not in persistence manager*, which is dangerous.\n\nEven worse, if we have multi default servers (actually in our testing, we have!), we have other servers trying to claim the same topic. Assume sub-3 communicates with default server B to subscribe topic-0.\n\nin 3) of the above flow, after sub-2 delete the zk node created by sub-1. sub-3 in default server B and sub-1 in default server A have same chance to acquire topic-0. If sub-3 in default server B succeed, then we in a worse status: *server A considers itself as owner since the topic is in its topic set, also the same as server B. in zookeeper the owner is server B*. (actually we indeed in this status in our testing!)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-28T06:24:58.215+0000","updated":"2011-09-28T06:24:58.215+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13116230","id":"13116230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"A proposal to fix this issue is:\n\n1) make sure only one acquireOp is executed when acquiring a topic in topic manager.\n2) the other requests to the under-acquisition topic, will queue their callbacks.\n3) when the topic acquisition is done, all the queued callbacks will be triggered according to the acquisition result. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-28T06:33:33.506+0000","updated":"2011-09-28T06:33:33.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13118695","id":"13118695","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Attach a testcase to reproduce this issue. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-01T06:52:16.713+0000","updated":"2011-10-01T06:52:16.713+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13118999","id":"13118999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"A detailed proposal:\n\n\n1) introduce TopicStatus to record the status change of topic during topic acquisition/releasing.\n{quote}\n/** Acquire Topic with shouldClaim == true **/\nCLAIMING,\nCLAIMING_ENQUEUE_CALLBACK,\nCLAIMING_GET_ENQUEUED_CALLBACKS,\n\n/** Acquire topic with shouldClaim == false **/\nCHOOSING,\nCHOOSING_ENQUEUE_CALLBACK,\nCHOOSING_GET_ENQUEUED_CALLBACKS,\n\n/** Topic is acquired **/\nACQUIRED,\n\n/** Topic is failed during acquisition **/\nACQUIRE_FAIL_RELEASE,\n\n/** Release Topic **/\nRELEASING,\nRELEASE_ENQUEUE_CALLBACK,\nRELEASE_GET_ENQUEUED_CALLBACKS\n{quote}\n\n[CLAIM/CHOOSE/RELEASE]ING : the topic is under claim/choose/release status, some one got the chance to do actual work.\n[CLAIM/CHOOSE/RELEASE]_ENQUEUE_CALLBACK : there is some on doing claim/choose/release works, the op tries to queue callback.\n[CLAIM/CHOOSE/RELEASE]_GET_ENQUEUED_CALLBACKS : claim/choose/release works are done. try to get all the queued callbacks and trigger them.\nACQUIRED : the topic is acquired by the hub server\nACQUIRE_FAIL_RELEASE : topic acquisition is failed due to some reason (such as NotEnoughBookiesException), enter topic releasing phase\n\n2) change topic set to a concurrent map *ConcurrentMap<ByteString, TopicStatus>* :\nthis map is used for tracking topic status transition to ensure only one acquisition/release for a specific topic is executed at the same time.\n\n3) added HashMap<ByteString, List<Callback<HedwigSocketAddress>>> to queue get owner callbacks. added HashMap<ByteString, List<Callback<Void>>> to queue release op callbacks.\n\n4) topic status transition in get owner & release op flow:\n{noformat}\n*             CLAMING_ENQUEUE_CALLBACK\n*                  ^ |\n*      enqueue     | |\n*      callback    | |\n*                  | >\n*      claim             claim topic\n* null -------> CLAMING -------------> CLAMING_GET_CALLBACKS ---------| (trigger queued callbacks)\n*  ^   |                                                              |-----> ACQUIRED\n*  |   -------> CHOOSING -------------> CHOOSING_GET_CALLBACKS -------|  |        |\n*  |   choose      | ^   choose topic                                    |        |\n*  |               | |                                                   |        |  Release\n*  |               | |   enqueue callback                                |        |   topic\n*  |               > |                                                   >        |\n*  |          CHOOSING_ENQUEUE_CALLBACK                  ACQUIRE_FAILE_RELEASE    |\n*  |                                                                     |        |\n*  |                                                                     >        >\n*  ---------------------------- RELEASE_GET_ENQUEUED_CALLBACKS <--------- RELEASING\n*                                                                           ^ |\n*                                                         enqueue callback  | |\n*                                                                           | >\n*                                                                RELEASE_ENQUEUE_CALLBACK\n{noformat}\n\nget owner:\n# check topic status\n## if topic is not existed, go to 2)\n## if topic is CLAIMING/CHOOSING, go to 3)\n## if topic is ACQUIRED, callback immediately\n## else go to 1)\n# claim/choose topic: set topic status as CLAIMING/CHOOSING\n## if success, go to 4)\n## if false, go to 1) to check topic status again\n# enqueue callback\n# do get owner\n## real get owner\n## if get owner succeed\n### get enqueued callback list\n### mark topic as ACQUIRED\n### trigger all the queued callbacks\n## if failed\n### get enqueued callback list\n### mark topic as ACQUIRE_FAIL_RELEASE\n### enter releasing phase, the queued callback list will be triggered at the end of topic-releasing\n\nrelease: most are same as get owner.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-02T12:25:03.015+0000","updated":"2011-10-02T12:26:22.808+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13119002","id":"13119002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Attach a patch implemented the proposal. And add 3 test cases in topic manager for concurrent get owner / release operations on same topic.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-02T12:34:00.671+0000","updated":"2011-10-02T12:34:00.671+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13139389","id":"13139389","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2615/\n-----------------------------------------------------------\n\nReview request for bookkeeper.\n\n\nSummary\n-------\n\nimplement the proposal to fix race condition of topic manager\n\n\nThis addresses bug BOOKKEEPER-69.\n    http://issues.apache.org/jira/browse/BOOKKEEPER-69\n\n\nDiffs\n-----\n\n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicStatus.java PRE-CREATION \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TrivialOwnAllTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/netty/TestPubSubServer.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/persistence/BookKeeperTestBase.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/StubTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestConcurrentTopicAcquisition.java PRE-CREATION \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestZkTopicManager.java 1194964 \n\nDiff: https://reviews.apache.org/r/2615/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nSijie\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-29T18:25:32.117+0000","updated":"2011-10-29T18:25:32.117+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13139390","id":"13139390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"body":"\n-----------------------------------------------------------\nThis is an automatically generated e-mail. To reply, visit:\nhttps://reviews.apache.org/r/2615/\n-----------------------------------------------------------\n\n(Updated 2011-10-29 18:25:31.143990)\n\n\nReview request for bookkeeper.\n\n\nSummary (updated)\n-------\n\nimplement the proposal to fix race condition of topic manager\n\n\nThis addresses bug BOOKKEEPER-69.\n    http://issues.apache.org/jira/browse/BOOKKEEPER-69\n\n\nDiffs\n-----\n\n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TopicStatus.java PRE-CREATION \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/TrivialOwnAllTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/ZkTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/netty/TestPubSubServer.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/persistence/BookKeeperTestBase.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/StubTopicManager.java 1194964 \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestConcurrentTopicAcquisition.java PRE-CREATION \n  http://svn.apache.org/repos/asf/zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestZkTopicManager.java 1194964 \n\nDiff: https://reviews.apache.org/r/2615/diff\n\n\nTesting\n-------\n\n\nThanks,\n\nSijie\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jiraposter%40reviews.apache.org","name":"jiraposter@reviews.apache.org","key":"jiraposter@reviews.apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"jiraposter@reviews.apache.org","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-29T18:25:33.487+0000","updated":"2011-10-29T18:25:33.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13147110","id":"13147110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Im not sure the analysis of the issue here is correct. Or at least, the test attached doesn't exercise this scenario. One problem I did spot was that the topic manager was completing the operation without error sometimes even when it couldn't acquire the topic. I've attached a patch to fix this. \n\nThere seems to be other issues with how a hub handles a bookie failure. For example, if a hub has a topic and then a bookie dies and comes back up, it can no longer publish to the topic because it doesn't clear up the ledger after the failed write.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-09T15:39:58.329+0000","updated":"2011-11-09T15:39:58.329+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13147122","id":"13147122","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Actually, BOOKKEEPER-74 talks about the problem im seeing with bookie failures and publish.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-09T15:56:58.310+0000","updated":"2011-11-09T15:56:58.310+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13147562","id":"13147562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Ivan, thanks for your comments.\n\nAfter checking the code again, I found that my analysis has some problems. The acquire/release op in TopicManager is executed one by one. \n\nAnd after reading your patch, I found that the real cause of race condition is between acquire and release. If we can follow the following patterns, we can avoid this race condition. \n1) topic is put in topic list only after persistence manager and subscription manager acquire topic successfully.\n2) topic is removed from topic list only after persistence manager and subscription manager released topic.\n\nnow, 1) is guaranteed, 2) is not guaranteed (your patch makes sure callback is triggered after all managers release topic).\n\nI will reading codes again to confirm my thoughts, and comment later.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-10T08:54:49.000+0000","updated":"2011-11-10T08:54:49.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13149238","id":"13149238","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"In TopicManager, acquireTopic / releaseTopic puts a TopicOp in topicOpQueue. And the TopicOps are executed one by one. So if we can guarantee that AcquireOp and ReleaseOp trigger callback only when they finished acquire/release, we can avoid race condition.\n\nIn AcquireOp:\n\nIt uses a MultiCallback to trigger original callback when its listeners (SubscritpionManager / PersistenceManager) finished acquired topic, as below:\n\n{code:title=AbstractTopicManager.java}\n    protected final synchronized void notifyListenersAndAddToOwnedTopics(final ByteString topic,\n            final Callback<HedwigSocketAddress> originalCallback, final Object originalContext) {\n\n        Callback<Void> postCb = new Callback<Void>() {\n\n            @Override\n            public void operationFinished(Object ctx, Void resultOfOperation) {\n                topics.add(topic);\n                if (cfg.getRetentionSecs() > 0) {\n                    scheduler.schedule(new Runnable() {\n                        @Override\n                        public void run() {\n                            // Enqueue a release operation. (Recall that release\n                            // doesn't \"fail\" even if the topic is missing.)\n                            releaseTopic(topic, new Callback<Void>() {\n\n                                @Override\n                                public void operationFailed(Object ctx, PubSubException exception) {\n                                    logger.error(\"failure that should never happen when periodically releasing topic \"\n                                                 + topic, exception);\n                                }\n\n                                @Override\n                                public void operationFinished(Object ctx, Void resultOfOperation) {\n                                    logger.debug(\"successful periodic release of topic \" + topic);\n                                }\n\n                            }, null);\n                        }\n                    }, cfg.getRetentionSecs(), TimeUnit.SECONDS);\n                }\n                originalCallback.operationFinished(originalContext, addr);\n            }\n\n            @Override\n            public void operationFailed(Object ctx, PubSubException exception) {\n                // TODO: optimization: we can release this as soon as we experience the first error.\n                realReleaseTopic(topic, CallbackUtils.curry(originalCallback, addr), originalContext);\n                originalCallback.operationFailed(ctx, exception);\n            }\n        };\n\n        Callback<Void> mcb = CallbackUtils.multiCallback(listeners.size(), postCb, null);\n        for (TopicOwnershipChangeListener listener : listeners) {\n            listener.acquiredTopic(topic, mcb, null);\n        }\n    }\n{code}\n\nIf topic acquisition is proceed without any error, the original callback did be triggered after all acquisition works are done in every manager.\n\nIf topic acquisition is proceed with any error, it did realReleaseTopic. since realReleaseTopic is processed in asynchronous way. so the original callback will be triggered immediately when realReleaseTopic is called. So topic manager may process acquiring/releasing a same topic in same time.\n\nIvan's patch fixed this issue by letting original callback is triggered after realReleaseTopic did finished actually.\n\n{code}\n--- a/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java\n+++ b/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java\n@@ -135,10 +135,19 @@ public abstract class AbstractTopicManager implements TopicManager {\n             }\n \n             @Override\n-            public void operationFailed(Object ctx, PubSubException exception) {\n+            public void operationFailed(final Object ctx, final PubSubException exception) {\n                 // TODO: optimization: we can release this as soon as we experience the first error.\n-                realReleaseTopic(topic, CallbackUtils.curry(originalCallback, addr), originalContext);\n-                originalCallback.operationFailed(ctx, exception);\n+                Callback<Void> cb = new Callback<Void>() {\n+                    public void operationFinished(Object _ctx, Void _resultOfOperation) {\n+                        originalCallback.operationFailed(ctx, exception);\n+                    }\n+                    public void operationFailed(Object _ctx, PubSubException _exception) {\n+                        logger.error(\"Exception releasing topic\", _exception);\n+                        originalCallback.operationFailed(ctx, exception);\n+                    }\n+                };\n+                \n+                realReleaseTopic(topic, cb, originalContext);\n             }\n         };\n{code}\n\nAlthough in realReleaseTopic, its listeners (SubscriptionManager/PersistenceManager) did losing topic in asynchronous way. But it wouldn't introduce race again, since operations in SubscriptionManager/PersistenceManager still be processed in a queue one by one, which means newer acquire op will be executed until older releaseOp executed.\n\n{code}\n\n    // AbstractTopicManager.java\n\n    private void realReleaseTopic(ByteString topic, Callback<Void> callback, Object ctx) {\n        for (TopicOwnershipChangeListener listener : listeners)\n            listener.lostTopic(topic);\n        topics.remove(topic);\n        postReleaseCleanup(topic, callback, ctx);\n    }\n\n{code}\n\nSo Ivan's patch did fixed this issue. It is simple and clear. Thanks, Ivan.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-13T07:12:31.985+0000","updated":"2011-11-13T07:12:31.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13151986","id":"13151986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"attach a new patch which contains Ivan's fix and test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-17T10:55:48.238+0000","updated":"2011-11-17T10:55:48.238+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13152770","id":"13152770","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Committed r1203576, Thanks Sijie.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-18T10:39:01.630+0000","updated":"2011-11-18T10:39:01.630+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12525013/comment/13152777","id":"13152777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in bookkeeper-trunk #228 (See [https://builds.apache.org/job/bookkeeper-trunk/228/])\n    BOOKKEEPER-69: ServerRedirectLoopException when a machine (hosts bookie server & hub server) reboot, which is caused by race condition of topic manager (Sijie, ivank via ivank)\n\nivank : \nFiles : \n* /zookeeper/bookkeeper/trunk/CHANGES.txt\n* /zookeeper/bookkeeper/trunk/hedwig-server/src/main/java/org/apache/hedwig/server/topics/AbstractTopicManager.java\n* /zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/persistence/BookKeeperTestBase.java\n* /zookeeper/bookkeeper/trunk/hedwig-server/src/test/java/org/apache/hedwig/server/topics/TestConcurrentTopicAcquisition.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-18T10:57:40.359+0000","updated":"2011-11-18T10:57:40.359+0000"}],"maxResults":15,"total":15,"startAt":0},"customfield_12311820":"0|i0u4qf:","customfield_12314139":null}}

