{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12527154","self":"https://issues.apache.org/jira/rest/api/2/issue/12527154","key":"BOOKKEEPER-79","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"85534","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317843","id":"12317843","description":"","name":"4.0.0","archived":false,"released":true,"releaseDate":"2011-12-07"}],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12314391","id":"12314391","name":"hedwig-client","description":"Hedwig client."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"173940","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-79/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@35d6ab8c[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4cde6843[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1f19f9a0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@203a0670[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2f553806[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@2d1c757a[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7d985d80[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@d61ddc5[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@bf25167[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@458b52c6[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7a4073aa[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@794c16d2[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2011-11-21T10:33:20.120+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-79/watchers","watchCount":1,"isWatching":false},"created":"2011-10-14T07:37:18.188+0000","updated":"2011-12-07T15:56:07.396+0000","timeoriginalestimate":null,"description":"in our test program, we tried to startDelivery/stopDelivery different subscriptions randomly. And it core dump.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498994","id":"12498994","filename":"bookkeeper-79.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-14T08:02:40.896+0000","size":1587,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498994/bookkeeper-79.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12503639","id":"12503639","filename":"BOOKKEEPER-79.patch_v2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-14T17:06:25.687+0000","size":8597,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12503639/BOOKKEEPER-79.patch_v2"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504194","id":"12504194","filename":"BOOKKEEPER-79.patch_v3","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T10:22:27.346+0000","size":12055,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12504194/BOOKKEEPER-79.patch_v3"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504232","id":"12504232","filename":"BOOKKEEPER-79.patch_v4","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T17:25:49.748+0000","size":12207,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12504232/BOOKKEEPER-79.patch_v4"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504345","id":"12504345","filename":"BOOKKEEPER-79.patch_v5","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-19T08:29:10.761+0000","size":14725,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12504345/BOOKKEEPER-79.patch_v5"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504239","id":"12504239","filename":"make-check-errors.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-18T18:14:28.764+0000","size":32194,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12504239/make-check-errors.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12504066","id":"12504066","filename":"pubsubtest.cpp","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-17T14:40:32.263+0000","size":16391,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12504066/pubsubtest.cpp"}],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"randomly startDelivery/stopDelivery will core dump in c++ hedwig client","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13127336","id":"13127336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Did investigation on startDelivery/stopDelivery. \nI found that stopDelivery just set flag *receiving* as false without doing other things.\n\nLet me explain the startDelivery/stopDelivery flow.\n\nstartDelivery:\n1) check if *receiving* is true\n2) if *receiving* is true, it just return without doing anything. since it has been started.\n3) if *receiving* is false, it set *receiving* as true. and put an async io read in boost io queue to read 4bytes message size.\n4) if async sizeRead succeed, it will trigger sizeReadCallback and put an async io read in boost io queue to read actual message data.\n\nif we just startDelivery without stopDelivery, the boost io queue will be:\n\n> boost io queue <\n| read size |\n| read msg |\n| read size |\n| read msg |\n| ... |\n\nbut if we first startDelivery (1) -> stopDelivery (1) -> startDelivery (2), \nthe second delivery will add another read size io in the queue, then it will be:\n\n> boost io queue <\n| read size |\n| read msg |\n| ... |\n| *read size* |\n| *read size* |\n| read msg |\n\nso the data stream is corrupted which will cause memory corrupted. it core dump.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-14T07:47:28.324+0000","updated":"2011-10-14T07:47:28.324+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13127345","id":"13127345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"avoid putting asyc io in boost io queue when startDelivery again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-14T08:02:41.033+0000","updated":"2011-10-14T08:02:41.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13130660","id":"13130660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Could you add your test program to the tests in hedwig-client/src/main/cpp/test/. I've added another JIRA, BOOKKEEPER-71 which fixes the tests, which hadn't really been run since we opensourced hedwig. Perhaps you could review that change?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-10-19T14:47:05.238+0000","updated":"2011-10-19T14:47:05.238+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13131271","id":"13131271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Ivan, Let me add the test program.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-10-20T02:07:54.923+0000","updated":"2011-10-20T02:07:54.923+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13149746","id":"13149746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"attach new patch with test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-14T17:06:25.790+0000","updated":"2011-11-14T17:06:25.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152019","id":"13152019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"I'm running the testcase (without the fix) and I'm getting a number of different errors. What error do you get which shows this problem?\n\nAlso, I'm not sure the fix is correct. I don't think it's possible for receiving to be false, while stopReceivingBefore is false, because there's a lock,   \n{code}\nboost::lock_guard<boost::mutex> lock(receiving_lock);\n{code}\nwhich explicitly stops this situation.\n\nWhat this change seems to do is that, once you stopReceiving, the channel can never start receiving again? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-17T12:19:32.171+0000","updated":"2011-11-17T12:21:39.050+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152020","id":"13152020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Actually, I think the problem is that we always startReceiving with readSize() even though the channel may have read the size, and be in the message reading part. I think this needs to be fixed so that the state of the channel is recorded when you stopReceiving, and when you startReceiving again, you decide what you need to read by looking at the previous state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-17T12:25:23.798+0000","updated":"2011-11-17T12:25:23.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152068","id":"13152068","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"> What error do you get which shows this problem?\n\nIt core dump running the test case.\n\n> there's a lock, which explicitly stops this situation.\n\nThe lock is for changing received value. stopReceiving can set receiving to false since it can obtain the lock.\n\n> I think this needs to be fixed so that the state of the channel is recorded when you stopReceiving\n\nWe don't need to record the reading state of the channel, since the receiving check is in readSize which ensure it stop exactly in a frame of message.\n\n{code}\n\n/*static*/ void DuplexChannel::readSize(DuplexChannelPtr channel) {\n  if (!channel->isReceiving()) {\n    return;\n  }\n\n  int toread = sizeof(uint32_t) - channel->in_buf.size();\n  LOG4CXX_DEBUG(logger, \" size of incoming message \" << sizeof(uint32_t)\n                << \", currently in buffer \" << channel->in_buf.size()\n                << \" channel(\" << channel.get() << \")\");\n\n  if (toread < 0) {\n    DuplexChannel::sizeReadCallbackHandler(channel, boost::system::error_code(), 0);\n  } else {\n    //  in_buf_size.prepare(sizeof(uint32_t));\n    boost::asio::async_read(channel->socket, channel->in_buf,\n                            boost::asio::transfer_at_least(sizeof(uint32_t)),\n                            boost::bind(&DuplexChannel::sizeReadCallbackHandler,\n                                        channel,\n                                        boost::asio::placeholders::error,\n                                        boost::asio::placeholders::bytes_transferred));\n  }\n}\n{code}\n\nThe race here is between #startReceiving, #stopReceiving, and #readSize, as below\n\n1. #readSize passed isReceiving() checking and before async_read is called.\n2. main thread do #startReceiving #stopReceiving. it insert a new async_read op to read size.\n3. #readSize calls async_read to insert its async_read op to read size.\n\nBut you comment remind me that the patch only fix the above case. In following case, it failed:\n\n1. main thread #stopReceiving first\n2. #readSize check receiving, return. no more async_read op are inserted.\n3. main thread #startReceiving, it doesn't insert any async_read op, since stopReceivingBefore is true.\n\nI think the root cause of race here is between checking receiving flag and changing receiving flag. we have lock in #startReceiving and #stopReceiving, but we have no lock in #readSize which checks receiving flag.\n\nThe right fix may be:\nneed a flag which indicates whether there is a async_read size op in io service. we only do readSize if there is no async_read size op in io service when #startReceiving. said the flag is reading, its lock is reading_lock. the code is showed as below.\n\n{code}\nvoid DuplexChannel::startReceiving() {\n  LOG4CXX_DEBUG(logger, \"DuplexChannel::startReceiving channel(\" << this << \") currently receiving = \" << receiving);\n\n  boost::lock_guard<boost::mutex> lock(receiving_lock);\n  if (receiving) {\n    return;\n  }\n  receiving = true;\n\n  {\n    boost::lock_guard<boost::mutex> lock(reading_lock);\n    if (!reading) {\n      reading = true;\n      DuplexChannel::doReadSize(shared_from_this());\n    }\n  }\n}\n\n// no change in #stopReceiving\nvoid DuplexChannel::stopReceiving() {\n  LOG4CXX_DEBUG(logger, \"DuplexChannel::stopReceiving channel(\" << this << \")\");\n\n  boost::lock_guard<boost::mutex> lock(receiving_lock);\n  receiving = false;\n  stopReceivingBefore = true;\n}\n\n/*static*/ void DuplexChannel::readSize(DuplexChannelPtr channel) {\n  boost::lock_guard<boost::mutex> lock(receiving_lock);\n  if (!channel->isReceiving()) {\n    boost::lock_guard<boost::mutex> lock(reading_lock);\n    reading = false;\n    return;\n  }\n\n  doReadSize(channel);\n}\n\nvoid doReadSize(DuplexChannelPtr channel) {\n\n  int toread = sizeof(uint32_t) - channel->in_buf.size();\n  LOG4CXX_DEBUG(logger, \" size of incoming message \" << sizeof(uint32_t)\n                << \", currently in buffer \" << channel->in_buf.size()\n                << \" channel(\" << channel.get() << \")\");\n\n  if (toread < 0) {\n    DuplexChannel::sizeReadCallbackHandler(channel, boost::system::error_code(), 0);\n  } else {\n    //  in_buf_size.prepare(sizeof(uint32_t));\n    boost::asio::async_read(channel->socket, channel->in_buf,\n                            boost::asio::transfer_at_least(sizeof(uint32_t)),\n                            boost::bind(&DuplexChannel::sizeReadCallbackHandler,\n                                        channel,\n                                        boost::asio::placeholders::error,\n                                        boost::asio::placeholders::bytes_transferred));\n  }\n}\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-17T14:21:23.603+0000","updated":"2011-11-17T14:21:23.603+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152082","id":"13152082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"I think we agree on where the problem is. I think the fix will need a bit more though. Currently we seem to allow the messageReceived to be called even if stopSending has been called. stopReceiving should stop receiving, so no messages should come from the channel after it call.\n\nI've attached pubsubtest.cpp which seems to trigger the problem more reliably.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-17T14:44:21.185+0000","updated":"2011-11-17T14:44:21.185+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152227","id":"13152227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"The above code will deadlock on mutexes. There's a number of issues, one being that we try to handle the messages in the async io thread.\n\nI've made an attempt to sort this out, and it just gets ugly. Also, I think we should block stopDelivery from returning until we have stopped all reads, otherwise callbacks may trigger when we don't expect them. Trying this with some locks leads to deadlocks.\n\nhttps://github.com/ivankelly/bookkeeper/tree/BOOKKEEPER-79\n\nWe can discuss this tomorrow morning.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-17T18:53:03.733+0000","updated":"2011-11-17T18:53:03.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152763","id":"13152763","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Ivan, thanks for your comments. It is great that you tried to avoid callbacks be triggered after stopReceiving in new patch. But a thread is introduced for each channel, if we have lots of subscriptions we will have same number of threads. it is not good.\n\nBeside the number of threads issue, #stopReceiving will be blocked if no data sent from server in the channel, since it only be notified in messageCallbackHandler. async_read will not trigger the bound callback if no data read from the channel.\n\nI attached a new patch based on my previous comments, which can\n1) ensure no callbacks after #stopReceiving, also ensure no message lost between stopDelivery and startDelivery (add order checking in MessageHandlerCallback)\n2) avoid the deadlock on mutexes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T10:21:58.164+0000","updated":"2011-11-18T10:21:58.164+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152804","id":"13152804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"I think your patch is good. Could you rename last_response to outstanding_response? Also, the full test suite doesn't succeed when I run this on trunk. One problem is BOOKKEEPER-115, but once that is fixed, there are still problems. (running with make check)\n\nThe thread issue is something we should look at in general in the future. Im of the opinion that we should only have one one channel per hub. But that requires server side buffering of messages. \n\n{quote}\nBeside the number of threads issue, #stopReceiving will be blocked if no data sent from server in the channel, since it only be notified in messageCallbackHandler. async_read will not trigger the bound callback if no data read from the channel.\n{quote}\nThis was where I got stuck yesterday before giving up.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-18T12:01:53.346+0000","updated":"2011-11-18T12:01:53.346+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152982","id":"13152982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"I have tried running 'make check' several times. it is OK for me, only one time there is an Exception thrown in socket.close, the exception indicates closing a Not Connect socket.\n\nI think the exception is due to shut down a channel:\n{code}\nvoid DuplexChannel::kill() {\n    \n    ...\n  \n    socket.cancel();\n    socket.shutdown(boost::asio::ip::tcp::socket::shutdown_both);\n    socket.close();\n\n    ...\n}\n{code}\n\nI think we can change using cancel/shutdown/close to cancel(&error)/shutdown(&error)/close(&error), which returning an error code instead of throwing exception. http://www.boost.org/doc/libs/1_48_0/doc/html/boost_asio/reference/basic_stream_socket/close/overload2.html \n\nI am not sure the problems described in your comments, could you give more information about them?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T17:24:09.332+0000","updated":"2011-11-18T17:24:09.332+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13152984","id":"13152984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"new patch, rename last_response to outstanding_response","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-18T17:25:49.802+0000","updated":"2011-11-18T17:25:49.802+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13153013","id":"13153013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Have to you patched against the latest trunk? Did you clean before the check? I've attached a file with the errors I get. The cancel/shutdown/error idea is good.\nAlso, pubsubtest.cpp gives warnings.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-18T18:12:51.813+0000","updated":"2011-11-18T18:12:51.813+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13153427","id":"13153427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"I have run 'make clean check' against latest trunk (including BOOKKEEPER-114 and BOOKKEEPER-115) for several times. most is OK, sometimes I got following 2 exceptions.\n\nfirst one is Exception during socket.close, as commented in previous comments.\n\nsecond one is SERVER_DOWN exception thrown in publish_thread (running more than ~250 seconds) in #testRandomDelivery, which due to hub server disconnect to zk. I added code in publish thread to catch such exception to avoid it.\n{code}\n2011-11-19 11:59:46,856 - INFO  [Thread-2-SendThread(feelpartfirm-lm.local:2181):             ClientCnxn$SendThread@1057] - Client session timed out, have not heard from server in 2908ms  for sessionid 0x133b9f6474f0006, closing socket connection and attempting reconnect\n2011-11-19 11:59:46,988 - ERROR [Thread-2-EventThread:ZkUtils@75] - Topic:                    randomDeliveryTopic subscriberId: mysub-randomDelivery could not set subscription state:      consumeSeqId: local:21950,zkPath: /hedwig/CppUnitTest/topics/randomDeliveryTopic/subscribers/ mysub-randomDelivery\norg.apache.zookeeper.KeeperException$ConnectionLossException: KeeperErrorCode =               ConnectionLoss for /hedwig/CppUnitTest/topics/randomDeliveryTopic/subscribers/mysub-          randomDelivery\n        at org.apache.zookeeper.KeeperException.create(KeeperException.java:99)\n        at org.apache.zookeeper.KeeperException.create(KeeperException.java:51)\n        at org.apache.hedwig.zookeeper.ZkUtils.logErrorAndCreateZKException(ZkUtils.java:74)        at org.apache.hedwig.server.subscriptions.ZkSubscriptionManager$3.                    safeProcessResult(ZkSubscriptionManager.java:186)        at org.apache.hedwig.zookeeper.SafeAsyncZKCallback$StatCallback.                      processResult(SafeAsyncZKCallback.java:30)        at org.apache.zookeeper.ClientCnxn$EventThread.processEvent(ClientCnxn.java:554)\n        at org.apache.zookeeper.ClientCnxn$EventThread.run(ClientCnxn.java:497)\n2011-11-19 11:59:46,991 - WARN  [Thread-2-EventThread:ZkTopicManager$2@94] - ZK client has    been disconnected to the ZK server! 2011-11-19 11:59:47,054 - INFO  [Thread-2-SendThread(feelpartfirm-lm.local:2181):             ClientCnxn$SendThread@933] - Opening socket connection to server /127.0.0.1:21812011-11-19 11:59:47,058 - INFO  [Thread-2-SendThread(localhost:2181):ClientCnxn$SendThread@   846] - Socket connection established to localhost/127.0.0.1:2181, initiating session2011-11-19 11:59:47,069 - INFO  [Thread-2-SendThread(localhost:2181):ClientCnxn$SendThread@   1181] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid =        0x133b9f6474f0006, negotiated timeout = 4362\n2011-11-19 11:59:47,069 - INFO  [Thread-2-EventThread:ZkTopicManager$2@98] - ZK client has    been reconnected to the ZK server!\n{code}\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-19T08:27:02.504+0000","updated":"2011-11-19T08:27:02.504+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13153428","id":"13153428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"new patch remove warnings in pubsubtest.cpp due to unused variables. also catch exception in IntegerPublisher for testRandomDelivery. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-11-19T08:29:10.855+0000","updated":"2011-11-19T08:29:10.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13153441","id":"13153441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Cancelling the patch until we clear up the issues Sijie issue Sijie is raising. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-19T09:54:22.144+0000","updated":"2011-11-19T09:54:22.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13153442","id":"13153442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"body":"Never mind, I got confused with the comments :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fpj","name":"fpj","key":"fpj","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=fpj&avatarId=16030","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=fpj&avatarId=16030","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=fpj&avatarId=16030","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=fpj&avatarId=16030"},"displayName":"Flavio Paiva Junqueira","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-19T09:55:05.836+0000","updated":"2011-11-19T09:55:05.836+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13154105","id":"13154105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"body":"Committed r1204437, Thanks Sijie.\n\nThe testing problem was a problem in my environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ikelly","name":"ikelly","key":"ikelly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Kelly","active":true,"timeZone":"Europe/Berlin"},"created":"2011-11-21T10:33:20.217+0000","updated":"2011-11-21T10:33:20.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12527154/comment/13154162","id":"13154162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in bookkeeper-trunk #234 (See [https://builds.apache.org/job/bookkeeper-trunk/234/])\n    BOOKKEEPER-79: randomly startDelivery/stopDelivery will core dump in c++ hedwig client (Sijie Guo via ivank)\n\nivank : \nFiles : \n* /zookeeper/bookkeeper/trunk/CHANGES.txt\n* /zookeeper/bookkeeper/trunk/hedwig-client/src/main/cpp/lib/channel.cpp\n* /zookeeper/bookkeeper/trunk/hedwig-client/src/main/cpp/lib/channel.h\n* /zookeeper/bookkeeper/trunk/hedwig-client/src/main/cpp/lib/subscriberimpl.cpp\n* /zookeeper/bookkeeper/trunk/hedwig-client/src/main/cpp/scripts/server-control.sh\n* /zookeeper/bookkeeper/trunk/hedwig-client/src/main/cpp/test/pubsubtest.cpp\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-21T13:24:26.250+0000","updated":"2011-11-21T13:24:26.250+0000"}],"maxResults":21,"total":21,"startAt":0},"customfield_12311820":"0|i0u4xj:","customfield_12314139":null}}

