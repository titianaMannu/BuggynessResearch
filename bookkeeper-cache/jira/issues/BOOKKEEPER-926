{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12964106","self":"https://issues.apache.org/jira/rest/api/2/issue/12964106","key":"BOOKKEEPER-926","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325566","id":"12325566","name":"4.4.0","archived":false,"released":true,"releaseDate":"2016-05-16"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12328755","id":"12328755","description":"Bug fix release for 4.3 branch","name":"4.3.1","archived":false,"released":true,"releaseDate":"2015-05-24"}],"customfield_12311120":null,"customfield_12313826":null,"issuelinks":[],"customfield_12312339":null,"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-926/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@105e99f8[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@40d462dc[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7955d7f6[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@1af48882[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3b427a21[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@26982e3e[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7125b77c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4fab8142[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@679079e4[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@1e42f6[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5c5c8bde[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@4f6ea086[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311293","id":"12311293","key":"BOOKKEEPER","name":"Bookkeeper","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311293&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311293&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311293&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311293&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/14780","id":"14780","description":"BookKeeper","name":"BookKeeper"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2016-05-04T13:56:41.719+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/BOOKKEEPER-926/watchers","watchCount":8,"isWatching":false},"created":"2016-04-30T21:58:42.060+0000","updated":"2016-05-16T21:47:24.157+0000","timeoriginalestimate":null,"description":"I have identified a couple of issues in Bookie compaction code. \n\nh4. Compacted entries are not properly synced when index is updated\n\nWhen compacting, we read \"active\" entries from an entry log and we re-append to current entry log. After compacting a number of entries, by default 100K, or at the very end, we need to update the index pointing to the new entry log and offset.\n\nBefore updating the index, we need to wait for this entries to be flushed and fsynced, otherwise a bookie crash might leave the index updated, pointing to an invalid offset.\n\nThe current code that is supposed to wait until flushed is:\n\n{code:java}\n// GarbageCollectorThread.java:178\nEntryLocation lastOffset = offsets.get(offsets.size()-1);\nlong lastOffsetLogId = EntryLogger.logIdForOffset(lastOffset.location);\nwhile (lastOffsetLogId < entryLogger.getLeastUnflushedLogId() && running) {\n    synchronized (flushLock) {\n        flushLock.wait(1000);\n    }\n\n    lastOffset = offsets.get(offsets.size()-1);\n    lastOffsetLogId = EntryLogger.logIdForOffset(lastOffset.location);\n}\n\n// update the index \n{code}\n\nThe condition {{lastOffsetLogId < entryLogger.getLeastUnflushedLogId()}} is wrong, because if the last compacted entry was written in an earlier entry log than the least unflushed log, it means that the entries are already flushed and thus we don't need to wait.\n\nIn the normal case what happens is that {{lastOffsetLogId} is actually the current entryLog and it's equal to {{entryLogger.getLeastUnflushedLogId()}}, so we don't wait. But, in this case the entries appended to the current entrylog are not flushed nor synced, hence the problem. \n\nh4. Exception during index flush\n\nHaving an exception when updating the index, combined with the above issue, makes the bookie GC to stop indefinitely. \nWhat happens is that the offset list is not cleared, and at the next bookie GC iteration it will find the old compacted entries in that list, for which now the entryLogId is less than the current log id, and that makes the while loop to never exit.\n\nAnother problem is that, any IOException during the index flush, will make the GC thread to bail out and it will not remove even the entry logs that were compacted and flushed. Next time, these entry logs will be compacted again.\n\nh4. Proposed solution\nI think the best solution is to trigger the {{entryLogger.flush()}} form the bookie GC thread before updating the indexes. That would simplify the code and I don't see any disadvantages in doing that. \nAnother improvement would be to delete compacted entry logs individually, as soon as the compacted data is flush, without waiting the end of the whole compaction process. \n\nThe advantages are : \n * If compaction stop halfway, at least we don't have to re-compact what we just compacted\n * Compaction won't require significant space overhead. Today a major compaction can end up reappending a large amount of data and then deleting all the entry logs at the very end, requiring twice the size of the active data set to be stored on disk at some point in time.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"customfield_12312340":null,"attachment":[],"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Compacted entries are not properly synced before updating index","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12311024":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15265519","id":"15265519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user merlimat opened a pull request:\n\n    https://github.com/apache/bookkeeper/pull/41\n\n    BOOKKEEPER-926: Compacted entries are not properly synced before upda…\n\n    …ting index\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/merlimat/bookkeeper bk-926\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/bookkeeper/pull/41.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #41\n    \n----\ncommit 42dff817b5e85a12101d9674b323f237ddeaba78\nAuthor: Matteo Merli <mmerli@apache.org>\nDate:   2016-04-29T21:30:25Z\n\n    BOOKKEEPER-926: Compacted entries are not properly synced before updating index\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-30T22:04:45.855+0000","updated":"2016-04-30T22:04:45.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15265520","id":"15265520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"body":"[~sijie@apache.org] [~fpj] Please take a look","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-04-30T22:05:36.733+0000","updated":"2016-04-30T22:05:36.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15266192","id":"15266192","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eolivelli","name":"eolivelli","key":"eolivelli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Enrico Olivelli","active":true,"timeZone":"Europe/Rome"},"body":"very interesting.\nHave you ever noticed this issue in production or staging ?\nIs there any symptom to look for in logs ?\n\nit look like a major change and maybe there is no test case we can implement to cover this issue.\nIs is safe to add it to 4.4.0 ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eolivelli","name":"eolivelli","key":"eolivelli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Enrico Olivelli","active":true,"timeZone":"Europe/Rome"},"created":"2016-05-02T07:36:52.338+0000","updated":"2016-05-02T07:36:52.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15266222","id":"15266222","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhaijia","name":"zhaijia","key":"zhaijia","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhaijia&avatarId=21925","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhaijia&avatarId=21925","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhaijia&avatarId=21925","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhaijia&avatarId=21925"},"displayName":"Jia Zhai","active":true,"timeZone":"Asia/Shanghai"},"body":"Yes. Very interesting, maybe add a test case to reproduce and verify it is very useful.\n\nIn the description,\n\"Because if the last compacted entry was written in an earlier entry log than the least unflushed log, it means that the entries are already flushed and thus we don't need to wait.\"\nHow would this happen? I thought we only compact the entries that is always older than \"the least unflushed\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhaijia","name":"zhaijia","key":"zhaijia","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhaijia&avatarId=21925","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhaijia&avatarId=21925","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhaijia&avatarId=21925","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhaijia&avatarId=21925"},"displayName":"Jia Zhai","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-05-02T08:24:13.495+0000","updated":"2016-05-02T08:24:13.495+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15266884","id":"15266884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jujjuri","name":"jujjuri","key":"jujjuri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jujjuri&avatarId=24984","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jujjuri&avatarId=24984","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jujjuri&avatarId=24984","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jujjuri&avatarId=24984"},"displayName":"JV Jujjuri","active":true,"timeZone":"America/Los_Angeles"},"body":"[~rithin.shetty] and I noticed this at Salesforce testing.\n\nOur stack looked like this:\n\n\"GarbageCollectorThread\" prio=10 tid=0x00007f6981152330 nid=0x13da5 in Object.wait() [0x00007f68cc5d9000]\n   java.lang.Thread.State: TIMED_WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        at org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory.waitEntrylogFlushed(GarbageCollectorThread.java:182)\n        - locked <0x0000000480b13168> (a java.lang.Object)\n        - locked <0x0000000480b01a38> (a org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory)\n        at org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory.flush(GarbageCollectorThread.java:201)\n        - locked <0x0000000480b01a38> (a org.apache.bookkeeper.bookie.GarbageCollectorThread$CompactionScannerFactory)\n        at org.apache.bookkeeper.bookie.GarbageCollectorThread.doCompactEntryLogs(GarbageCollectorThread.java:488)\n        at org.apache.bookkeeper.bookie.GarbageCollectorThread.run(GarbageCollectorThread.java:388)\n\nAlso when [~rithin.shetty] added debug in the while loop mentioned above:\n\n[vagrant@gus-mnds7-1-sfm sfslogs]$ grep \"GC thread stuck\" bookkeeper-bookie-gus-mnds7-1-sfm.gus.2015105437.vpod.sfdc.net.log\n2016-05-01 19:59:21,271 - INFO [GarbageCollectorThread:GarbageCollectorThread$CompactionScannerFactory@187] - GC thread stuck waiting: lastOffsetLogId=12234, leastUnflushedLogId=12247\n2016-05-01 20:14:21,886 - INFO [GarbageCollectorThread:GarbageCollectorThread$CompactionScannerFactory@187] - GC thread stuck waiting: lastOffsetLogId=12234, leastUnflushedLogId=12268\n2016-05-01 20:29:22,181 - INFO [GarbageCollectorThread:GarbageCollectorThread$CompactionScannerFactory@187] - GC thread stuck waiting: lastOffsetLogId=12234, leastUnflushedLogId=12284\n2016-05-01 20:44:22,940 - INFO [GarbageCollectorThread:GarbageCollectorThread$CompactionScannerFactory@187] - GC thread stuck waiting: lastOffsetLogId=12234, leastUnflushedLogId=12291\n2016-05-01 20:59:28,856 - INFO [GarbageCollectorThread:GarbageCollectorThread$CompactionScannerFactory@187] - GC thread stuck waiting: lastOffsetLogId=12234, leastUnflushedLogId=12305\n\n----\nAs you can see lastUnflushedLogId is growing pretty fast. [~merlimat] What I see is, leastUnflushedLogId keeps getting updated even after flush started and hence a problem too?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jujjuri","name":"jujjuri","key":"jujjuri","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jujjuri&avatarId=24984","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jujjuri&avatarId=24984","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jujjuri&avatarId=24984","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jujjuri&avatarId=24984"},"displayName":"JV Jujjuri","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-02T16:05:28.409+0000","updated":"2016-05-02T16:05:28.409+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15266930","id":"15266930","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"body":"[~jujjuri] Yes, that looks like the same issue. If the {{leastUnflushedEntryLogId}} moves forward (eg: entries are being written, entry log is full and new one is created), then the bookie GC thread is essentially stuck, waiting for an older entry log to be flushed, but that entry log was already flushed.\n\n[~eolivelli] Yes we've seen it happening in production. I mean we've see the bookie GC getting stuck, in the same place that [~jujjuri] pasted above. \n\nAbout the other issue, of the compacted entries not being flushed on disk, it's hard to tell whether it has already happened or not. Even if it happens, you might not be aware of it given that : \n * The other bookie replica might still have the entries\n * You might not try to read these entries\n\n[~zhaijia] The \"compacted\" entries are appended to the current entry log and, before updating the index, we need to make sure the current entry log is flushed. Otherwise, if a bookie crashes during compaction, we might have indexes pointing to an invalid offset in the entry log. \n\nIn the current code, the current entryLogId is typically equal to the \"least unflushed entry log id\". That means, given the current if condition, we are not waiting for entries to be flushed.\n\nI'll definitely add a unit test to trigger this behavior, and I still think this should go into 4.4\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-02T16:35:04.498+0000","updated":"2016-05-02T16:35:04.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15267483","id":"15267483","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eolivelli","name":"eolivelli","key":"eolivelli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Enrico Olivelli","active":true,"timeZone":"Europe/Rome"},"body":"+1 for committing on 4.4.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eolivelli","name":"eolivelli","key":"eolivelli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Enrico Olivelli","active":true,"timeZone":"Europe/Rome"},"created":"2016-05-02T20:52:26.408+0000","updated":"2016-05-02T20:52:26.408+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15268072","id":"15268072","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhaijia","name":"zhaijia","key":"zhaijia","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhaijia&avatarId=21925","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhaijia&avatarId=21925","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhaijia&avatarId=21925","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhaijia&avatarId=21925"},"displayName":"Jia Zhai","active":true,"timeZone":"Asia/Shanghai"},"body":"Got it now, it happens when new entry log created. Thanks a lot for the explaination.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhaijia","name":"zhaijia","key":"zhaijia","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhaijia&avatarId=21925","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhaijia&avatarId=21925","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhaijia&avatarId=21925","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhaijia&avatarId=21925"},"displayName":"Jia Zhai","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-05-03T04:24:10.190+0000","updated":"2016-05-03T04:24:10.190+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15268088","id":"15268088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"Yup. we also encountered similar problem before. I have a bit concern on the proposed fix - it might potentially cause performance penalty if we flush too frequent. our fix at Twitter is different - in the compaction scanner, we keep tracking the mapping between entry id and its compacted offsets. when entry log file rotated or at the end of compaction, we update the offset for those compacted entries, flushing out the cache and delete the entry log files whose compacted entries' offsets have been updated.\n\nthe commit for that improvement is here: https://github.com/twitter/bookkeeper/commit/1b99d9a6f0840c5f8ae4acd74f5c4bdbff498cbe","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-03T04:41:50.474+0000","updated":"2016-05-03T04:41:50.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15269419","id":"15269419","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"body":"I have updated the PR with a test case that reproduces the problem. \n\nSijie, from what I've tested, having the sync done in the entry logger from GarbageCollectorThread every 100K entries compacted shouldn't degrade the performance. I've checked write throughput/latency and read throughput and couldn't see any difference with and without the patch.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-03T19:32:17.574+0000","updated":"2016-05-03T19:32:17.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15270006","id":"15270006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"body":"make sense to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hustlmsp","name":"hustlmsp","key":"hustlmsp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sijie Guo","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-04T01:59:29.089+0000","updated":"2016-05-04T01:59:29.089+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15270008","id":"15270008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user sijie commented on the pull request:\n\n    https://github.com/apache/bookkeeper/pull/41#issuecomment-216720201\n  \n    the change looks good to me. +1\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-04T02:00:27.115+0000","updated":"2016-05-04T02:00:27.115+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15270663","id":"15270663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user asfgit closed the pull request at:\n\n    https://github.com/apache/bookkeeper/pull/41\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-04T13:56:16.802+0000","updated":"2016-05-04T13:56:16.802+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15270664","id":"15270664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"body":"Issue resolved by merging pull request 41\n            [https://github.com/apache/bookkeeper/pull/41]\n\n            {noformat}\n            commit d32010f5fcc6a040a56dc8b983cc14d107cff2df\nAuthor:     Matteo Merli <mmerli@apache.org>\nAuthorDate: Wed May 4 06:55:46 2016 -0700\nCommit:     Matteo Merli <mmerli@apache.org>\nCommitDate: Wed May 4 06:55:46 2016 -0700\n\n    BOOKKEEPER-926: Compacted entries are not properly synced before updating index\n    \n    …ting index\n    \n    Author: Matteo Merli <mmerli@apache.org>\n    \n    Reviewers: Guo Sijie <sijie@apache.org>\n    \n    Closes #41 from merlimat/bk-926\n\n            {noformat}\n            ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-04T13:56:41.778+0000","updated":"2016-05-04T13:56:41.778+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15270692","id":"15270692","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in bookkeeper-master #1368 (See [https://builds.apache.org/job/bookkeeper-master/1368/])\nBOOKKEEPER-926: Compacted entries are not properly synced before (mmerli: rev d32010f5fcc6a040a56dc8b983cc14d107cff2df)\n* bookkeeper-server/src/main/java/org/apache/bookkeeper/bookie/GarbageCollectorThread.java\n* bookkeeper-server/src/test/java/org/apache/bookkeeper/bookie/CompactionTest.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2016-05-04T14:20:56.414+0000","updated":"2016-05-04T14:20:56.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12964106/comment/15285388","id":"15285388","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"body":"Closed as part of BookKeeper-4.4.0 release","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmerli","name":"mmerli","key":"mmerli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matteo Merli","active":true,"timeZone":"America/Los_Angeles"},"created":"2016-05-16T21:47:24.146+0000","updated":"2016-05-16T21:47:24.146+0000"}],"maxResults":16,"total":16,"startAt":0},"customfield_12311820":"0|i2x0bj:","customfield_12314139":null}}

