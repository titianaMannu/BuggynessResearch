{"sha":"04bb0664750212b332720e87b5f273310a8ed1f6","node_id":"MDY6Q29tbWl0MjA2MzY0OjA0YmIwNjY0NzUwMjEyYjMzMjcyMGU4N2I1ZjI3MzMxMGE4ZWQxZjY=","commit":{"author":{"name":"Jeremy Bauer","email":"jrbauer@apache.org","date":"2010-03-17T17:58:40Z"},"committer":{"name":"Jeremy Bauer","email":"jrbauer@apache.org","date":"2010-03-17T17:58:40Z"},"message":"OPENJPA-1410 Disable loading of dynamic enhancement agent if OpenJPA is not loaded with the system classloader.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@924395 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"1aaeb8f5506468abb841c46d7165ea62245ac86b","url":"https://api.github.com/repos/apache/openjpa/git/trees/1aaeb8f5506468abb841c46d7165ea62245ac86b"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/04bb0664750212b332720e87b5f273310a8ed1f6","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/04bb0664750212b332720e87b5f273310a8ed1f6","html_url":"https://github.com/apache/openjpa/commit/04bb0664750212b332720e87b5f273310a8ed1f6","comments_url":"https://api.github.com/repos/apache/openjpa/commits/04bb0664750212b332720e87b5f273310a8ed1f6/comments","author":null,"committer":null,"parents":[{"sha":"65385662b08df5d7fafc7819514c99a4b6b907a9","url":"https://api.github.com/repos/apache/openjpa/commits/65385662b08df5d7fafc7819514c99a4b6b907a9","html_url":"https://github.com/apache/openjpa/commit/65385662b08df5d7fafc7819514c99a4b6b907a9"}],"stats":{"total":15,"additions":13,"deletions":2},"files":[{"sha":"2a0d0cce627980ef19434af2f8cfc827e43a85bc","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/enhance/InstrumentationFactory.java","status":"modified","additions":13,"deletions":2,"changes":15,"blob_url":"https://github.com/apache/openjpa/blob/04bb0664750212b332720e87b5f273310a8ed1f6/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/InstrumentationFactory.java","raw_url":"https://github.com/apache/openjpa/raw/04bb0664750212b332720e87b5f273310a8ed1f6/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/InstrumentationFactory.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/InstrumentationFactory.java?ref=04bb0664750212b332720e87b5f273310a8ed1f6","patch":"@@ -79,8 +79,7 @@ public static synchronized void setDynamicallyInstallAgent(boolean val) {\n      * @return null if Instrumentation can not be obtained, or if any \n      * Exceptions are encountered.\n      */\n-    public static synchronized Instrumentation \n-        getInstrumentation(final Log log) {\n+    public static synchronized Instrumentation getInstrumentation(final Log log) {\n         if (_inst != null || !_dynamicallyInstall)\n             return _inst;\n \n@@ -90,6 +89,18 @@ public static synchronized void setDynamicallyInstallAgent(boolean val) {\n \n         AccessController.doPrivileged(new PrivilegedAction<Object>() {\n             public Object run() {\n+                // Dynamic agent enhancement should only occur when the OpenJPA library is \n+                // loaded using the system class loader.  Otherwise, the OpenJPA\n+                // library may get loaded by separate, disjunct loaders, leading to linkage issues.\n+                try {\n+                    if (!InstrumentationFactory.class.getClassLoader().equals(\n+                        ClassLoader.getSystemClassLoader())) {\n+                        return null;\n+                    }\n+                } catch (Throwable t) {\n+                    return null;\n+                }\n+                \n                 // If we can't find the tools.jar, we can't load the agent.\n                 File toolsJar = findToolsJar(log);\n                 if (toolsJar == null) {"}]}

