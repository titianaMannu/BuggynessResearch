{"sha":"079aa06091a9337a1f5087f904c332d590659c82","node_id":"MDY6Q29tbWl0MjA2MzY0OjA3OWFhMDYwOTFhOTMzN2ExZjUwODdmOTA0YzMzMmQ1OTA2NTljODI=","commit":{"author":{"name":"Kevin W. Sutter","email":"kwsutter@apache.org","date":"2008-09-08T20:11:35Z"},"committer":{"name":"Kevin W. Sutter","email":"kwsutter@apache.org","date":"2008-09-08T20:11:35Z"},"message":"OPENJPA-646.  Migrate this change from the 1.2.x branch to trunk.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@693233 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"1f9fc87ffc2d1c4bf1611fbae558c33b8c91bd12","url":"https://api.github.com/repos/apache/openjpa/git/trees/1f9fc87ffc2d1c4bf1611fbae558c33b8c91bd12"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/079aa06091a9337a1f5087f904c332d590659c82","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/079aa06091a9337a1f5087f904c332d590659c82","html_url":"https://github.com/apache/openjpa/commit/079aa06091a9337a1f5087f904c332d590659c82","comments_url":"https://api.github.com/repos/apache/openjpa/commits/079aa06091a9337a1f5087f904c332d590659c82/comments","author":null,"committer":null,"parents":[{"sha":"939b122c09432e54083d751469c56ad48aff9fb6","url":"https://api.github.com/repos/apache/openjpa/commits/939b122c09432e54083d751469c56ad48aff9fb6","html_url":"https://github.com/apache/openjpa/commit/939b122c09432e54083d751469c56ad48aff9fb6"}],"stats":{"total":17,"additions":16,"deletions":1},"files":[{"sha":"b8cefc0befad8b0d74b911ba1bd8ec9a67d4267a","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","status":"modified","additions":16,"deletions":1,"changes":17,"blob_url":"https://github.com/apache/openjpa/blob/079aa06091a9337a1f5087f904c332d590659c82/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","raw_url":"https://github.com/apache/openjpa/raw/079aa06091a9337a1f5087f904c332d590659c82/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java?ref=079aa06091a9337a1f5087f904c332d590659c82","patch":"@@ -70,7 +70,10 @@ protected Class loadClass(String name, boolean resolve)\n                 bout.write(b, 0, n))\n                 ;\n             byte[] classBytes = bout.toByteArray();\n-            if (isAnnotation(classBytes))\n+            // To avoid classloader issues with the JVM (Sun and IBM), we\n+            // will not load Enums via the TemporaryClassLoader either.\n+            // Reference JIRA Issue OPENJPA-646 for more information.\n+            if (isAnnotation(classBytes) || isEnum(classBytes))\n                 return Class.forName(name, resolve, getClass().\n                     getClassLoader());\n \n@@ -97,4 +100,16 @@ private static boolean isAnnotation(byte[] b) {\n         int access = ConstantPoolTable.readUnsignedShort(b, idx);\n         return (access & 0x2000) != 0; // access constant for annotation type\n     }\n+\n+    /**\n+     * Fast-parse the given class bytecode to determine if it is an\n+     * enum class.\n+     */\n+    private static boolean isEnum(byte[] b) {\n+        if (JavaVersions.VERSION < 5)\n+            return false;\n+        int idx = ConstantPoolTable.getEndIndex(b);\n+        int access = ConstantPoolTable.readUnsignedShort(b, idx);\n+        return (access & 0x4000) != 0; // access constant for enum type\n+    }\n }"}]}

