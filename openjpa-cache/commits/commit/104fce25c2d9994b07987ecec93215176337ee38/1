{"sha":"104fce25c2d9994b07987ecec93215176337ee38","node_id":"MDY6Q29tbWl0MjA2MzY0OjEwNGZjZTI1YzJkOTk5NGIwNzk4N2VjZWM5MzIxNTE3NjMzN2VlMzg=","commit":{"author":{"name":"Heath Thomann","email":"hthomann@apache.org","date":"2015-09-02T20:06:41Z"},"committer":{"name":"Heath Thomann","email":"hthomann@apache.org","date":"2015-09-02T20:06:41Z"},"message":"OPENJPA-2517: Option to allow the javax.persistence.query.timeout property to apply to EntityManager operations.  Ported 2.2.x changes to trunk.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1700885 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"a8f85f2881baf8b74ad3f151911c22da4ad528e5","url":"https://api.github.com/repos/apache/openjpa/git/trees/a8f85f2881baf8b74ad3f151911c22da4ad528e5"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/104fce25c2d9994b07987ecec93215176337ee38","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/104fce25c2d9994b07987ecec93215176337ee38","html_url":"https://github.com/apache/openjpa/commit/104fce25c2d9994b07987ecec93215176337ee38","comments_url":"https://api.github.com/repos/apache/openjpa/commits/104fce25c2d9994b07987ecec93215176337ee38/comments","author":null,"committer":null,"parents":[{"sha":"41c05d1bbe5f3b5c5e103ff7ae63da1fbe1b8448","url":"https://api.github.com/repos/apache/openjpa/commits/41c05d1bbe5f3b5c5e103ff7ae63da1fbe1b8448","html_url":"https://github.com/apache/openjpa/commit/41c05d1bbe5f3b5c5e103ff7ae63da1fbe1b8448"}],"stats":{"total":44,"additions":42,"deletions":2},"files":[{"sha":"ef38cd387d8d3090bef03e5bb2faa1d97cc3d85c","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","status":"modified","additions":20,"deletions":2,"changes":22,"blob_url":"https://github.com/apache/openjpa/blob/104fce25c2d9994b07987ecec93215176337ee38/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","raw_url":"https://github.com/apache/openjpa/raw/104fce25c2d9994b07987ecec93215176337ee38/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java?ref=104fce25c2d9994b07987ecec93215176337ee38","patch":"@@ -205,8 +205,26 @@ public static DecoratingDataSource installDBDictionary(DBDictionary dict,\n             ConfiguringConnectionDecorator ccd =\n                 new ConfiguringConnectionDecorator();\n             ccd.setTransactionIsolation(conf.getTransactionIsolationConstant());\n-            ccd.setQueryTimeout(conf.getQueryTimeout() == -1 \n-                ? -1 : conf.getQueryTimeout());\n+            \n+            //OPENJPA-2517: Allow a javax.persistence.query.timeout to apply to all\n+            //EM operations (not just Query operations).  Convert from milliseconds\n+            //to seconds.  See DBDictionary.setQueryTimeout for similar conversions.  \n+            //DBDictionary.setQueryTimeout will log warnings for invalid values, \n+            //therefore there is no need to do so again here.  Furthermore, there is no  \n+            //need to check for -1 here, ConfigurationConnectionDecorator checks for it.\n+            int timeout = conf.getQueryTimeout();\n+            if (dict.allowQueryTimeoutOnFindUpdate){\n+                if (timeout > 0 && timeout < 1000) {\n+                    // round up to 1 sec\n+                    timeout = 1; \n+                }\n+                else if (timeout >= 1000){\n+                    timeout = timeout/1000;\n+                }\n+            }\n+            \n+            ccd.setQueryTimeout(timeout);\n+            \n             Log log = conf.getLog(JDBCConfiguration.LOG_JDBC);\n             if (factory2 || !conf.isConnectionFactoryModeManaged()) {\n                 if (!dict.supportsMultipleNontransactionalResultSets)"},{"sha":"d9f2a4ab4c12a3741d64900c809ec8f55bd5568f","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/104fce25c2d9994b07987ecec93215176337ee38/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/104fce25c2d9994b07987ecec93215176337ee38/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java?ref=104fce25c2d9994b07987ecec93215176337ee38","patch":"@@ -241,6 +241,7 @@\n     public boolean supportsLockingWithInnerJoin = true;\n     public boolean supportsLockingWithSelectRange = true;\n     public boolean supportsQueryTimeout = true;\n+    public boolean allowQueryTimeoutOnFindUpdate = false; //OPENJPA-2517\n     public boolean simulateLocking = false;\n     public boolean supportsSubselect = true;\n     public boolean supportsCorrelatedSubselect = true;"},{"sha":"b03b25fcd7494099666b4aafb6c70855422ea9fc","filename":"openjpa-project/src/doc/manual/ref_guide_dbsetup.xml","status":"modified","additions":21,"deletions":0,"changes":21,"blob_url":"https://github.com/apache/openjpa/blob/104fce25c2d9994b07987ecec93215176337ee38/openjpa-project/src/doc/manual/ref_guide_dbsetup.xml","raw_url":"https://github.com/apache/openjpa/raw/104fce25c2d9994b07987ecec93215176337ee38/openjpa-project/src/doc/manual/ref_guide_dbsetup.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-project/src/doc/manual/ref_guide_dbsetup.xml?ref=104fce25c2d9994b07987ecec93215176337ee38","patch":"@@ -3045,6 +3045,27 @@ action on foreign keys.  Defaults to <literal>true</literal>.\n calls to <methodname> java.sql.Statement.setQueryTimeout</methodname>.\n                     </para>\n                 </listitem>\n+                <listitem id=\"DBDictionary.AllowQueryTimeoutOnFindUpdate\">\n+                    <para>\n+                    <indexterm>\n+                        <primary>\n+                            JDBC\n+                        </primary>\n+                        <secondary>\n+                            QueryTimeout\n+                        </secondary>\n+                        <tertiary>\n+                            AllowQueryTimeoutOnFindUpdate\n+                        </tertiary>\n+                    </indexterm>\n+<literal>AllowQueryTimeoutOnFindUpdate</literal>: The JPA Specification defines the \n+javax.persistence.query.timeout, in milliseconds, as a hint to the provider.  The hint\n+is used for Query operations.  This property, when set to true, will allow the query timeout hint\n+to apply to EntityManager operations.  For example, when a 'find' is executed and the resultant\n+entity updated, the query timeout will apply to the SQL update operation.  This property defaults\n+to false.</methodname>.\n+                    </para>\n+                </listitem>\n                 <listitem id=\"DBDictionary.SupportsRestrictDeleteAction\">\n                     <para>\n                     <indexterm>"}]}

