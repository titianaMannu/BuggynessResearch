{"sha":"12c0a094ee5976bf95253c04e5c3fb02f9221344","node_id":"MDY6Q29tbWl0MjA2MzY0OjEyYzBhMDk0ZWU1OTc2YmY5NTI1M2MwNGU1YzNmYjAyZjkyMjEzNDQ=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-06-11T23:59:15Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-06-11T23:59:15Z"},"message":" Merge from ../branches/1.1.x. svn merge -c 656796 ../branches/1.1.x\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@666919 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b9b58933c0ce922e998fad6fd9c957457cdaa19f","url":"https://api.github.com/repos/apache/openjpa/git/trees/b9b58933c0ce922e998fad6fd9c957457cdaa19f"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/12c0a094ee5976bf95253c04e5c3fb02f9221344","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/12c0a094ee5976bf95253c04e5c3fb02f9221344","html_url":"https://github.com/apache/openjpa/commit/12c0a094ee5976bf95253c04e5c3fb02f9221344","comments_url":"https://api.github.com/repos/apache/openjpa/commits/12c0a094ee5976bf95253c04e5c3fb02f9221344/comments","author":null,"committer":null,"parents":[{"sha":"5ee728e3327f4754f73381b10f13505bb243a27d","url":"https://api.github.com/repos/apache/openjpa/commits/5ee728e3327f4754f73381b10f13505bb243a27d","html_url":"https://github.com/apache/openjpa/commit/5ee728e3327f4754f73381b10f13505bb243a27d"}],"stats":{"total":60,"additions":59,"deletions":1},"files":[{"sha":"36371784c0363c4151b8eeee698d1b84d04b7d15","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/ManagedCache.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/12c0a094ee5976bf95253c04e5c3fb02f9221344/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/ManagedCache.java","raw_url":"https://github.com/apache/openjpa/raw/12c0a094ee5976bf95253c04e5c3fb02f9221344/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/ManagedCache.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/ManagedCache.java?ref=12c0a094ee5976bf95253c04e5c3fb02f9221344","patch":"@@ -71,7 +71,7 @@ public StateManagerImpl getById(Object oid, boolean allowNew) {\n         if (sm != null) {\r\n             // if it's a new instance, we know it's the only match, because\r\n             // other pers instances override new instances in _cache\r\n-            if (sm.isNew())\r\n+            if (sm.isNew() && !sm.isDeleted())\r\n                 return (allowNew) ? sm : null;\r\n             if (!allowNew || !sm.isDeleted())\r\n                 return sm;\r"},{"sha":"ad3ac29075f4885a05697e19c1c87400d2b8c379","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestMultipleInsertDeleteSameId.java","status":"added","additions":58,"deletions":0,"changes":58,"blob_url":"https://github.com/apache/openjpa/blob/12c0a094ee5976bf95253c04e5c3fb02f9221344/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestMultipleInsertDeleteSameId.java","raw_url":"https://github.com/apache/openjpa/raw/12c0a094ee5976bf95253c04e5c3fb02f9221344/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestMultipleInsertDeleteSameId.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestMultipleInsertDeleteSameId.java?ref=12c0a094ee5976bf95253c04e5c3fb02f9221344","patch":"@@ -0,0 +1,58 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.\r\n+ */\r\n+package org.apache.openjpa.persistence.kernel;\r\n+\r\n+import javax.persistence.Query;\r\n+\r\n+import org.apache.openjpa.persistence.common.apps.RuntimeTest1;\r\n+import org.apache.openjpa.persistence.test.SingleEMTestCase;\r\n+\r\n+public class TestMultipleInsertDeleteSameId\r\n+    extends SingleEMTestCase {\r\n+\r\n+    public void setUp() {\r\n+        setUp(RuntimeTest1.class, CLEAR_TABLES);\r\n+    }\r\n+\r\n+    public void testMultipleInsertDelete() {\r\n+        em.getTransaction().begin();\r\n+\r\n+        RuntimeTest1 o = new RuntimeTest1(\"one\", 99);\r\n+        em.persist(o);\r\n+        Query q = em.createQuery(\"select o from RuntimeTest1 o \"\r\n+          + \" where o.stringField = 'one'\"); \r\n+        assertEquals(o, q.getSingleResult());\r\n+\r\n+        em.remove(o);\r\n+        assertEquals(0, q.getResultList().size());\r\n+      \r\n+        RuntimeTest1 o2 = new RuntimeTest1(\"two\", 99);\r\n+        em.persist(o2);\r\n+        q = em.createQuery(\"select o from RuntimeTest1 o \"\r\n+          + \" where o.stringField = 'two'\"); \r\n+        assertEquals(o2, q.getSingleResult());\r\n+\r\n+        em.remove(o2);\r\n+        assertEquals(0, q.getResultList().size());\r\n+\r\n+        em.getTransaction().commit();\r\n+        assertNull(em.find(RuntimeTest1.class, 99));\r\n+        em.close();\r\n+    }\r\n+}\r"}]}

