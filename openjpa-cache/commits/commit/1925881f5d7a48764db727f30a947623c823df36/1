{"sha":"1925881f5d7a48764db727f30a947623c823df36","node_id":"MDY6Q29tbWl0MjA2MzY0OjE5MjU4ODFmNWQ3YTQ4NzY0ZGI3MjdmMzBhOTQ3NjIzYzgyM2RmMzY=","commit":{"author":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2012-03-21T19:06:42Z"},"committer":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2012-03-21T19:06:42Z"},"message":"OPENJPA-2158: Null out StateManager when lite auto detaching proxies.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1303507 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"2e500171848ecce931d1f264c49ddcd1a8ede785","url":"https://api.github.com/repos/apache/openjpa/git/trees/2e500171848ecce931d1f264c49ddcd1a8ede785"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/1925881f5d7a48764db727f30a947623c823df36","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/1925881f5d7a48764db727f30a947623c823df36","html_url":"https://github.com/apache/openjpa/commit/1925881f5d7a48764db727f30a947623c823df36","comments_url":"https://api.github.com/repos/apache/openjpa/commits/1925881f5d7a48764db727f30a947623c823df36/comments","author":null,"committer":null,"parents":[{"sha":"1d71976c8f38a7f56efcb70267a5249337a77981","url":"https://api.github.com/repos/apache/openjpa/commits/1d71976c8f38a7f56efcb70267a5249337a77981","html_url":"https://github.com/apache/openjpa/commit/1d71976c8f38a7f56efcb70267a5249337a77981"}],"stats":{"total":11,"additions":8,"deletions":3},"files":[{"sha":"b4e60d5abf688c84f31d098ab5747c7d40d1f439","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManagerLite.java","status":"modified","additions":5,"deletions":3,"changes":8,"blob_url":"https://github.com/apache/openjpa/blob/1925881f5d7a48764db727f30a947623c823df36/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManagerLite.java","raw_url":"https://github.com/apache/openjpa/raw/1925881f5d7a48764db727f30a947623c823df36/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManagerLite.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManagerLite.java?ref=1925881f5d7a48764db727f30a947623c823df36","patch":"@@ -81,13 +81,15 @@ private void detachProxyField(FieldMetaData fmd, PersistenceCapable pc,\n             // need to null out LRS fields.\n             nullField(fieldIndex, pc, sm, fm);\n         } else {\n-            if (!_detachProxies) {\n-                return;\n-            }\n             Object o = sm.fetchObject(fieldIndex);\n             if (o instanceof Proxy) {\n                 // Get unproxied object and replace\n                 Proxy proxy = (Proxy) o;\n+                if (!_detachProxies) {\n+                    // Even if we're not detaching proxies, we need to remove the reference to the SM.\n+                    proxy.setOwner(null, -1);\n+                    return;\n+                }\n                 Object unproxied = proxy.copy(proxy);\n                 fm.storeObjectField(fieldIndex, unproxied);\n                 sm.replaceField(pc, fm, fieldIndex);"},{"sha":"99dfb5482b0c5f4fb4ad227855d2fce69368dcab","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/detachment/TestDetachLite.java","status":"modified","additions":3,"deletions":0,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/1925881f5d7a48764db727f30a947623c823df36/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/detachment/TestDetachLite.java","raw_url":"https://github.com/apache/openjpa/raw/1925881f5d7a48764db727f30a947623c823df36/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/detachment/TestDetachLite.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/detachment/TestDetachLite.java?ref=1925881f5d7a48764db727f30a947623c823df36","patch":"@@ -76,6 +76,9 @@ public void testLeaveProxy() {\n \n                 assertTrue(beforeDetachCal instanceof Proxy);\n                 assertTrue(afterDetachCal instanceof Proxy);\n+                \n+                // Make sure that we get rid of the StateManager.\n+                assertNull(((Proxy)afterDetachCal).getOwner());\n             } finally {\n                 if (iem.getTransaction().isActive()) {\n                     iem.getTransaction().rollback();"}]}

