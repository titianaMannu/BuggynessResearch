{"sha":"194f59f02f524211a514bed41882fef9297357d0","node_id":"MDY6Q29tbWl0MjA2MzY0OjE5NGY1OWYwMmY1MjQyMTFhNTE0YmVkNDE4ODJmZWY5Mjk3MzU3ZDA=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-05-12T18:58:00Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-05-12T18:58:00Z"},"message":"OPENJPA-597. Committing on behalf of Sandeep Srivastava.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.1.x@655600 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"67358661cee2dcc7c2ea69b60689eccd64902865","url":"https://api.github.com/repos/apache/openjpa/git/trees/67358661cee2dcc7c2ea69b60689eccd64902865"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/194f59f02f524211a514bed41882fef9297357d0","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/194f59f02f524211a514bed41882fef9297357d0","html_url":"https://github.com/apache/openjpa/commit/194f59f02f524211a514bed41882fef9297357d0","comments_url":"https://api.github.com/repos/apache/openjpa/commits/194f59f02f524211a514bed41882fef9297357d0/comments","author":null,"committer":null,"parents":[{"sha":"51950e7d49b96805b763510ab4e4d97c92817ea7","url":"https://api.github.com/repos/apache/openjpa/commits/51950e7d49b96805b763510ab4e4d97c92817ea7","html_url":"https://github.com/apache/openjpa/commit/51950e7d49b96805b763510ab4e4d97c92817ea7"}],"stats":{"total":40,"additions":38,"deletions":2},"files":[{"sha":"de2a6127faf3d85ed2fe7fc69fd77292bc8b3c60","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","status":"modified","additions":37,"deletions":2,"changes":39,"blob_url":"https://github.com/apache/openjpa/blob/194f59f02f524211a514bed41882fef9297357d0/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/194f59f02f524211a514bed41882fef9297357d0/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java?ref=194f59f02f524211a514bed41882fef9297357d0","patch":"@@ -232,6 +232,7 @@\n     public boolean supportsSelectEndIndex = false;\n     public int rangePosition = RANGE_POST_SELECT;\n     public boolean requiresAliasForSubselect = false;\n+    public boolean requiresTargetForDelete = false;\n     public boolean allowsAliasInBulkClause = true;\n     public boolean supportsMultipleNontransactionalResultSets = true;\n     public String searchStringEscape = \"\\\\\";\n@@ -1873,8 +1874,16 @@ public SQLBuffer toUpdate(ClassMapping mapping, Select sel,\n     protected SQLBuffer toBulkOperation(ClassMapping mapping, Select sel,\n         JDBCStore store, Object[] params, Map updateParams) {\n         SQLBuffer sql = new SQLBuffer(this);\n-        if (updateParams == null)\n+        if (updateParams == null) {\n+          if (requiresTargetForDelete) {\n+            sql.append(\"DELETE \");\n+            SQLBuffer deleteTargets = getDeleteTargets(sel);\n+            sql.append(deleteTargets);\n+            sql.append(\" FROM \");\n+          } else {\n             sql.append(\"DELETE FROM \");\n+          }\n+        }\n         else\n             sql.append(\"UPDATE \");\n         sel.addJoinClassConditions();\n@@ -1970,6 +1979,28 @@ protected SQLBuffer toBulkOperation(ClassMapping mapping, Select sel,\n         return sql;\n     }\n \n+    protected SQLBuffer getDeleteTargets(Select sel) {\n+      SQLBuffer deleteTargets = new SQLBuffer(this);\n+      Collection aliases = sel.getTableAliases();\n+      // Assumes aliases are of the form \"TABLENAME t0\"\n+      for (Iterator itr = aliases.iterator(); itr.hasNext();) {\n+        String tableAlias = itr.next().toString();\n+        int spaceIndex = tableAlias.indexOf(' ');\n+        if (spaceIndex > 0 && spaceIndex < tableAlias.length() - 1) {\n+          if (allowsAliasInBulkClause) {\n+            deleteTargets.append(tableAlias.substring(spaceIndex + 1));\n+          } else {\n+            deleteTargets.append(tableAlias.substring(0, spaceIndex));\n+          }\n+        } else {\n+          deleteTargets.append(tableAlias);\n+        }\n+        if (itr.hasNext())\n+          deleteTargets.append(\", \");\n+      }      \n+      return deleteTargets;      \n+    }\n+\n     protected void appendUpdates(Select sel, JDBCStore store, SQLBuffer sql,\n         Object[] params, Map updateParams, boolean allowAlias) {\n         if (updateParams == null || updateParams.size() == 0)\n@@ -1997,7 +2028,11 @@ protected void appendUpdates(Select sel, JDBCStore store, SQLBuffer sql,\n             Val val = (Val) next.getValue();\n \n             Column col = fmd.getColumns()[0];\n-            sql.append(col.getName());\n+            if (allowAlias) {\n+              sql.append(sel.getColumnAlias(col));\n+            } else {\n+              sql.append(col.getName());  \n+            }            \n             sql.append(\" = \");\n \n             ExpState state = val.initialize(sel, ctx, 0);"},{"sha":"29579fbd26c38451ee26d328ad0a9dc8e6839172","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/194f59f02f524211a514bed41882fef9297357d0/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/194f59f02f524211a514bed41882fef9297357d0/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java?ref=194f59f02f524211a514bed41882fef9297357d0","patch":"@@ -73,6 +73,7 @@ public MySQLDictionary() {\n         constraintNameMode = CONS_NAME_MID;\n         supportsMultipleNontransactionalResultSets = false;\n         requiresAliasForSubselect = true; // new versions\n+        requiresTargetForDelete = true;\n         supportsSelectStartIndex = true;\n         supportsSelectEndIndex = true;\n "}]}

