{"sha":"1d667e8d67dfa0f2d730dc121c657b1015f9da3e","node_id":"MDY6Q29tbWl0MjA2MzY0OjFkNjY3ZThkNjdkZmEwZjJkNzMwZGMxMjFjNjU3YjEwMTVmOWRhM2U=","commit":{"author":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2010-07-21T16:42:02Z"},"committer":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2010-07-21T16:42:02Z"},"message":"OPENJPA-1719: Prepared SQL cache user parameter ordering problem with subqueries.\nOriginally fixed in trunk by Catalina Wei\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/2.0.x@966307 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"8a11d852c0d5ea211f497d90fc20dbb5db4d245c","url":"https://api.github.com/repos/apache/openjpa/git/trees/8a11d852c0d5ea211f497d90fc20dbb5db4d245c"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/1d667e8d67dfa0f2d730dc121c657b1015f9da3e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/1d667e8d67dfa0f2d730dc121c657b1015f9da3e","html_url":"https://github.com/apache/openjpa/commit/1d667e8d67dfa0f2d730dc121c657b1015f9da3e","comments_url":"https://api.github.com/repos/apache/openjpa/commits/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/comments","author":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"committer":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"parents":[{"sha":"e34e85396e08fda7c9ddec531869b0cc2dd6291b","url":"https://api.github.com/repos/apache/openjpa/commits/e34e85396e08fda7c9ddec531869b0cc2dd6291b","html_url":"https://github.com/apache/openjpa/commit/e34e85396e08fda7c9ddec531869b0cc2dd6291b"}],"stats":{"total":105,"additions":79,"deletions":26},"files":[{"sha":"51ce99f9fb8ed45e3673e60055022c75620f38c9","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/PreparedQueryImpl.java","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/PreparedQueryImpl.java","raw_url":"https://github.com/apache/openjpa/raw/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/PreparedQueryImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/PreparedQueryImpl.java?ref=1d667e8d67dfa0f2d730dc121c657b1015f9da3e","patch":"@@ -42,6 +42,7 @@\n import org.apache.openjpa.kernel.QueryLanguages;\n import org.apache.openjpa.kernel.StoreQuery;\n import org.apache.openjpa.kernel.PreparedQueryCache.Exclusion;\n+import org.apache.openjpa.kernel.exps.Parameter;\n import org.apache.openjpa.kernel.exps.QueryExpressions;\n import org.apache.openjpa.lib.rop.RangeResultObjectProvider;\n import org.apache.openjpa.lib.rop.ResultList;\n@@ -406,7 +407,7 @@ private void setCollectionValuedParameter(Map<Integer,Object> result,\n     void setUserParameterPositions(List list) {\n         _userParamPositions = new HashMap<Object, int[]>();\n         for (int i = 1; list != null && i < list.size(); i += 2) {\n-            Object key = list.get(i);\n+            Object key = ((Parameter)list.get(i)).getParameterKey();\n             int p = (Integer)list.get(i-1);\n             int[] positions = _userParamPositions.get(key);\n             if (positions == null) {"},{"sha":"5bcaa41c2b619baef027d031390a49ba29b6fe8a","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CollectionParam.java","status":"modified","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/apache/openjpa/blob/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CollectionParam.java","raw_url":"https://github.com/apache/openjpa/raw/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CollectionParam.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CollectionParam.java?ref=1d667e8d67dfa0f2d730dc121c657b1015f9da3e","patch":"@@ -56,6 +56,13 @@ public CollectionParam(Object key, Class type) {\n         setImplicitType(type);\n     }\n \n+    public CollectionParam clone() {\n+        CollectionParam c = new CollectionParam(this._key, this._type);\n+        c._idx = this._idx;\n+        c._container = this._container;\n+        return c;\n+    }\n+\n     public Object getParameterKey() {\n         return _key;\n     }"},{"sha":"90f9ebcfae380d4e9b3814035bddd37affa826f6","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLBuffer.java","status":"modified","additions":38,"deletions":24,"changes":62,"blob_url":"https://github.com/apache/openjpa/blob/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLBuffer.java","raw_url":"https://github.com/apache/openjpa/raw/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLBuffer.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLBuffer.java?ref=1d667e8d67dfa0f2d730dc121c657b1015f9da3e","patch":"@@ -32,6 +32,7 @@\n import org.apache.commons.lang.ObjectUtils;\n import org.apache.openjpa.jdbc.identifier.DBIdentifier;\n import org.apache.openjpa.jdbc.kernel.JDBCFetchConfiguration;\n+import org.apache.openjpa.jdbc.kernel.exps.CollectionParam;\n import org.apache.openjpa.jdbc.kernel.exps.Val;\n import org.apache.openjpa.jdbc.schema.Column;\n import org.apache.openjpa.jdbc.schema.Sequence;\n@@ -64,8 +65,9 @@\n     private List _cols = null;\n     \n     // Even element refers to an index of the _params list\n-    // Odd element refers to the user parameter key\n+    // Odd element refers to the user parameter\n     private List _userIndex = null;\n+    private List _userParams = null;\n     \n     /**\n      * Default constructor.\n@@ -142,44 +144,48 @@ private void append(SQLBuffer buf, int sqlIndex, int paramIndex,\n \n             if (paramIndex == _params.size()) {\n                 _params.addAll(buf._params);\n+                if (buf._userParams != null) {\n+                    if (_userParams == null)\n+                        _userParams = new ArrayList();\n+                   _userParams.addAll(paramIndex, buf._userParams);\n+                }\n+                if (buf._userIndex != null) {\n+                    if (_userIndex == null)\n+                        _userIndex = new ArrayList();\n+                    _userIndex.addAll(buf._userIndex);\n+                }\n                 if (buf._cols != null)\n                     _cols.addAll(buf._cols);\n                 else if (_cols != null)\n                     while (_cols.size() < _params.size())\n                         _cols.add(null);\n             } else {\n                 _params.addAll(paramIndex, buf._params);\n+                if ( buf._userParams != null) {\n+                    if (_userParams == null)\n+                        _userParams = new ArrayList();\n+                    _userParams.addAll(paramIndex, buf._userParams);\n+                }\n+                 if (buf._userIndex != null) {\n+                     if (_userIndex == null) {\n+                         _userIndex = new ArrayList();\n+                         _userIndex.addAll(buf._userIndex);\n+                     } else\n+                         _userIndex.addAll(paramIndex*2, buf._userIndex);\n+                 }\n                 if (buf._cols != null)\n                     _cols.addAll(paramIndex, buf._cols);\n                 else if (_cols != null)\n                     while (_cols.size() < _params.size())\n                         _cols.add(paramIndex, null);\n             }\n         }\n-        \n-        // adding user parameters from another buffer to this buffer\n-        // this buffer's user parameter index gets modified\n-        if (buf._userIndex == null && this._userIndex == null) {\n-            // do nothing\n-        } else if (buf._userIndex != null && this._userIndex == null) {\n-            // copy the other buffers data\n-            this._userIndex = new ArrayList(buf._userIndex);\n-        } else if (buf._userIndex == null && this._userIndex != null) {\n-            // nothing to add from the other buffer\n-        } else { // both has data. \n-            // modify this buffer's user parameter index\n-            int otherSize = buf._userIndex.size()/2;\n+\n+        if (_userIndex != null) {\n+            // fix up user parameter index\n             for (int i = 0; i < _userIndex.size(); i+=2) {\n-                int newIndex = ((Integer)_userIndex.get(i)).intValue() + otherSize;\n-                _userIndex.set(i, newIndex);\n+                _userIndex.set(i, _userParams.indexOf(_userIndex.get(i+1)));\n             }\n-            // append the other buffer's user parameters to this one\n-            for (int i = 0; i < buf._userIndex.size(); i+=2) {\n-                Object otherIndex = buf._userIndex.get(i);\n-                Object otherParam = buf._userIndex.get(i+1);\n-                _userIndex.add(otherIndex);\n-                _userIndex.add(otherParam);\n-            }            \n         }\n     }\n     \n@@ -293,6 +299,8 @@ else if (o instanceof Raw)\n             // we get the first non-null col\n             if (_params == null)\n                 _params = new ArrayList();\n+            if (_userParams == null)\n+                _userParams = new ArrayList();\n             if (col != null && _cols == null) {\n                 _cols = new ArrayList();\n                 while (_cols.size() < _params.size())\n@@ -301,12 +309,18 @@ else if (o instanceof Raw)\n \n             _params.add(o);\n             if (userParam != null) {\n+                Object param = userParam;\n+                if (userParam instanceof CollectionParam)\n+                    param = ((CollectionParam) userParam).clone();\n+                _userParams.add(param);\n                 if (_userIndex == null)\n                     _userIndex = new ArrayList();\n                 int index = _params.size()-1;\n                 _userIndex.add(index);\n-                _userIndex.add(userParam.getParameterKey());\n+                _userIndex.add(param);\n             }\n+            else\n+                _userParams.add(o);\n             if (_cols != null)\n                 _cols.add(col);\n         }"},{"sha":"7f74bb2d095b72559e8ff7fef098da3ce1c87612","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/sqlcache/TestPreparedQueryCache.java","status":"modified","additions":32,"deletions":1,"changes":33,"blob_url":"https://github.com/apache/openjpa/blob/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/sqlcache/TestPreparedQueryCache.java","raw_url":"https://github.com/apache/openjpa/raw/1d667e8d67dfa0f2d730dc121c657b1015f9da3e/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/sqlcache/TestPreparedQueryCache.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/sqlcache/TestPreparedQueryCache.java?ref=1d667e8d67dfa0f2d730dc121c657b1015f9da3e","patch":"@@ -213,7 +213,38 @@ public void tearDown() throws Exception {\n \t        em.close();\n \t\tsuper.tearDown();\n \t}\n-\t\n+    \n+    public void testRepeatedParameterInSubqueryInDifferentOrderSubQLast() {\n+        OpenJPAEntityManager em = emf.createEntityManager();\n+       \n+        String jpql = \"SELECT o from OrderJPA o \" +\n+                \"WHERE (o.CustomerId = :customerId) \" +\n+                \"AND (o.WarehouseId = :warehouseId) \" +\n+                \"AND (o.DistrictId = :districtId) \" +\n+                \"AND o.OrderId IN (SELECT MAX (o1.OrderId) from OrderJPA o1 \" +\n+                    \"WHERE ((o1.CustomerId = :customerId) \" +\n+                    \"AND    (o1.DistrictId = :districtId) \" +\n+                    \"AND    (o1.WarehouseId = :warehouseId)))\";\n+        \n+        em.getTransaction().begin();\n+        TypedQuery<OrderJPA> q1 = em.createQuery(jpql, OrderJPA.class);\n+        q1.setParameter(\"customerId\", 339)\n+          .setParameter(\"districtId\", 3)\n+          .setParameter(\"warehouseId\", 23);\n+                  \n+        assertEquals(JPQLParser.LANG_JPQL, OpenJPAPersistence.cast(q1).getLanguage());\n+        assertFalse(q1.getResultList().isEmpty());        \n+        \n+        TypedQuery<OrderJPA> q2 = em.createQuery(jpql, OrderJPA.class);\n+        assertEquals(QueryLanguages.LANG_PREPARED_SQL, OpenJPAPersistence.cast(q2).getLanguage());\n+        q2.setParameter(\"customerId\", 2967)\n+          .setParameter(\"districtId\", 5)\n+          .setParameter(\"warehouseId\", 22);\n+        \n+        assertFalse(q2.getResultList().isEmpty());\n+        em.getTransaction().rollback();\n+        \n+    }\n \n \tpublic void testPreparedQueryCacheIsActiveByDefault() {\n \t\tassertNotNull(getPreparedQueryCache());"}]}

