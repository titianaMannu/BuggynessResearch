{"sha":"21909df2ecea737a475d2d18ec33712570dc832a","node_id":"MDY6Q29tbWl0MjA2MzY0OjIxOTA5ZGYyZWNlYTczN2E0NzVkMmQxOGVjMzM3MTI1NzBkYzgzMmE=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2007-07-03T14:26:09Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2007-07-03T14:26:09Z"},"message":"Guarantee that remote commit events are fired against OpenJPA internal data structures before externally-registered listeners. This means that externally-registered listeners can rely on the OpenJPA data structures being up-to-date by the time that they are fired.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@552850 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"aa5aed7a2218c063bc22964d8d3e0a239132fa24","url":"https://api.github.com/repos/apache/openjpa/git/trees/aa5aed7a2218c063bc22964d8d3e0a239132fa24"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/21909df2ecea737a475d2d18ec33712570dc832a","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/21909df2ecea737a475d2d18ec33712570dc832a","html_url":"https://github.com/apache/openjpa/commit/21909df2ecea737a475d2d18ec33712570dc832a","comments_url":"https://api.github.com/repos/apache/openjpa/commits/21909df2ecea737a475d2d18ec33712570dc832a/comments","author":null,"committer":null,"parents":[{"sha":"1bded00298c66f51c8814b6391c32e3721495ed2","url":"https://api.github.com/repos/apache/openjpa/commits/1bded00298c66f51c8814b6391c32e3721495ed2","html_url":"https://github.com/apache/openjpa/commit/1bded00298c66f51c8814b6391c32e3721495ed2"}],"stats":{"total":23,"additions":20,"deletions":3},"files":[{"sha":"3208e640c7bfb985fbb4d4240c88910df3998f98","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentDataCache.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentDataCache.java","raw_url":"https://github.com/apache/openjpa/raw/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentDataCache.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentDataCache.java?ref=21909df2ecea737a475d2d18ec33712570dc832a","patch":"@@ -89,7 +89,7 @@ public int getSoftReferenceSize() {\n \n     public void initialize(DataCacheManager mgr) {\n         super.initialize(mgr);\n-        conf.getRemoteCommitEventManager().addListener(this);\n+        conf.getRemoteCommitEventManager().addInternalListener(this);\n     }\n \n     public void unpinAll(Class cls, boolean subs) {"},{"sha":"fd1a44f641c41fb2f51e70e69f3433d90fb85154","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentQueryCache.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentQueryCache.java","raw_url":"https://github.com/apache/openjpa/raw/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentQueryCache.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/datacache/ConcurrentQueryCache.java?ref=21909df2ecea737a475d2d18ec33712570dc832a","patch":"@@ -90,7 +90,7 @@ public void setSoftReferenceSize(int size) {\n \n     public void initialize(DataCacheManager mgr) {\n         super.initialize(mgr);\n-        conf.getRemoteCommitEventManager().addListener(this);\n+        conf.getRemoteCommitEventManager().addInternalListener(this);\n     }\n \n     public void writeLock() {"},{"sha":"3e7fc423d9f5cfe88c0ac9c36de3ca4c531fb995","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/event/RemoteCommitEventManager.java","status":"modified","additions":17,"deletions":0,"changes":17,"blob_url":"https://github.com/apache/openjpa/blob/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/event/RemoteCommitEventManager.java","raw_url":"https://github.com/apache/openjpa/raw/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-kernel/src/main/java/org/apache/openjpa/event/RemoteCommitEventManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/event/RemoteCommitEventManager.java?ref=21909df2ecea737a475d2d18ec33712570dc832a","patch":"@@ -93,6 +93,21 @@ public void setTransmitPersistedObjectIds(boolean transmit) {\n         _transmitPersIds = transmit;\n     }\n \n+    /**\n+     * Adds an OpenJPA-internal listener to this RemoteCommitEventManager.\n+     * Listeners so registered will be fired before any that are registered\n+     * via {@link #addListener}. This means that the external listeners can\n+     * rely on internal caches and data structures being up-to-date by the\n+     * time that they are invoked.\n+     *\n+     * @since 1.0.0\n+     */\n+    public void addInternalListener(RemoteCommitListener listen) {\n+        if (_provider == null)\n+            throw new UserException(_loc.get(\"no-provider\"));\n+        ((List) _listeners).add(0, listen);\n+    }\n+\n     public void addListener(RemoteCommitListener listen) {\n         if (_provider == null)\n             throw new UserException(_loc.get(\"no-provider\"));\n@@ -120,6 +135,8 @@ protected void fireEvent(Object event, Object listener) {\n     /**\n      * Fire an event to local listeners only notifying them of a detected\n      * stale record.\n+     *\n+     * @since 1.0.0\n      */\n     public void fireLocalStaleNotification(Object oid) {\n         RemoteCommitEvent ev = new RemoteCommitEvent("},{"sha":"9e807cb486cf26ab6dd7f4b3c095fa215af057fa","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/util/concurrent/AbstractConcurrentEventManager.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/concurrent/AbstractConcurrentEventManager.java","raw_url":"https://github.com/apache/openjpa/raw/21909df2ecea737a475d2d18ec33712570dc832a/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/concurrent/AbstractConcurrentEventManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/concurrent/AbstractConcurrentEventManager.java?ref=21909df2ecea737a475d2d18ec33712570dc832a","patch":"@@ -39,7 +39,7 @@\n \n     private static Exception[] EMPTY_EXCEPTIONS = new Exception[0];\n \n-    private final Collection _listeners;\n+    protected final Collection _listeners;\n     private boolean _failFast = false;\n \n     /**"}]}

