{"sha":"2a612c105315ff1b994a868505a65523e19690b0","node_id":"MDY6Q29tbWl0MjA2MzY0OjJhNjEyYzEwNTMxNWZmMWI5OTRhODY4NTA1YTY1NTIzZTE5NjkwYjA=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-01-25T19:41:57Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-01-25T19:41:57Z"},"message":"OPENJPA-245\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@615317 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5d6a5d4af0801945c07832bc0aaa025d48bc2552","url":"https://api.github.com/repos/apache/openjpa/git/trees/5d6a5d4af0801945c07832bc0aaa025d48bc2552"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/2a612c105315ff1b994a868505a65523e19690b0","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/2a612c105315ff1b994a868505a65523e19690b0","html_url":"https://github.com/apache/openjpa/commit/2a612c105315ff1b994a868505a65523e19690b0","comments_url":"https://api.github.com/repos/apache/openjpa/commits/2a612c105315ff1b994a868505a65523e19690b0/comments","author":null,"committer":null,"parents":[{"sha":"2a45dc5929232f897d20240d2891836dabff020d","url":"https://api.github.com/repos/apache/openjpa/commits/2a45dc5929232f897d20240d2891836dabff020d","html_url":"https://github.com/apache/openjpa/commit/2a45dc5929232f897d20240d2891836dabff020d"}],"stats":{"total":64,"additions":33,"deletions":31},"files":[{"sha":"a1e7b873c17cedb6d1352fc219e4ee43f9f81cbd","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachManager.java","status":"modified","additions":1,"deletions":31,"changes":32,"blob_url":"https://github.com/apache/openjpa/blob/2a612c105315ff1b994a868505a65523e19690b0/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachManager.java","raw_url":"https://github.com/apache/openjpa/raw/2a612c105315ff1b994a868505a65523e19690b0/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachManager.java?ref=2a612c105315ff1b994a868505a65523e19690b0","patch":"@@ -98,11 +98,7 @@ public Object attach(Object pc) {\n \n         CallbackException excep = null;\n         try {\n-            PersistenceCapable into = findFromDatabase(pc);\n-            OpenJPAStateManager owner = (into == null) ? null\n-                    : (OpenJPAStateManager) into.pcGetStateManager();\n-            return attach(pc, into, owner, null, true);\n-\n+            return attach(pc, null, null, null, true);\n         } catch (CallbackException ce) {\n             excep = ce;\n             return null; // won't be reached as the exceps will be rethrown\n@@ -339,30 +335,4 @@ StateManagerImpl assertManaged(Object obj) {\n                 Exceptions.toString(obj))).setFailedObject (obj);\n \t\treturn sm;\n \t}\n-\n-    /**\n-     * Find a PersistenceCapable instance of an Object if it exists in the \n-     * database. If the object is null or can't be found in the database.  \n-     *  \n-     * @param pc An object which will be attached into the current context. The \n-     * object may or may not correspond to a row in the database. \n-     * \n-     * @return If the object is null or can't be found in the database this \n-     * method returns null. Otherwise a PersistenceCapable representation of the\n-     * object is returned.\n-     */\n-    protected PersistenceCapable findFromDatabase(Object pc) {\n-        PersistenceCapable rval = null;\n-\n-        if (pc != null) {\n-            Object oid = _broker.newObjectId(pc.getClass(),\n-                    getDetachedObjectId(pc));\n-\n-            if (oid != null) {\n-                rval = ImplHelper.toPersistenceCapable(_broker.find(oid, true,\n-                        null), getBroker().getConfiguration());\n-            }\n-        }\n-        return rval;\n-    }\n }"},{"sha":"b41f63c44b91f978da49862b0b8172ebcf32fe0c","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/VersionAttachStrategy.java","status":"modified","additions":32,"deletions":0,"changes":32,"blob_url":"https://github.com/apache/openjpa/blob/2a612c105315ff1b994a868505a65523e19690b0/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/VersionAttachStrategy.java","raw_url":"https://github.com/apache/openjpa/raw/2a612c105315ff1b994a868505a65523e19690b0/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/VersionAttachStrategy.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/VersionAttachStrategy.java?ref=2a612c105315ff1b994a868505a65523e19690b0","patch":"@@ -68,6 +68,13 @@ protected void provideField(Object toAttach, StateManagerImpl sm,\n     public Object attach(AttachManager manager, Object toAttach,\n         ClassMetaData meta, PersistenceCapable into, OpenJPAStateManager owner,\n         ValueMetaData ownerMeta, boolean explicit) {\n+\n+        // VersionAttachStrategy is invoked in the case where no more\n+        // intelligent strategy could be found; let's be more lenient\n+        // about new vs. detached record determination.\n+        if (into == null)\n+            into = findFromDatabase(manager, toAttach);\n+\n         BrokerImpl broker = manager.getBroker();\n         PersistenceCapable pc = ImplHelper.toPersistenceCapable(toAttach,\n             meta.getRepository().getConfiguration());\n@@ -342,4 +349,29 @@ private Map attachInPlace(AttachManager manager, StateManagerImpl sm,\n         }\n         return (copy == null) ? map : copy;\n \t}\n+\n+    /**\n+     * Find a PersistenceCapable instance of an Object if it exists in the\n+     * database. If the object is null or can't be found in the database.\n+     *\n+     * @param pc An object which will be attached into the current context. The\n+     * object may or may not correspond to a row in the database.\n+     *\n+     * @return If the object is null or can't be found in the database this\n+     * method returns null. Otherwise a PersistenceCapable representation of the\n+     * object is returned.\n+     */\n+    protected PersistenceCapable findFromDatabase(AttachManager manager,\n+        Object pc) {\n+        Object oid = manager.getBroker().newObjectId(pc.getClass(),\n+            manager.getDetachedObjectId(pc));\n+\n+        if (oid != null) {\n+            return ImplHelper.toPersistenceCapable(\n+                manager.getBroker().find(oid, true, null),\n+                manager.getBroker().getConfiguration());\n+        } else {\n+            return null;\n+        }\n+    }\n }"}]}

