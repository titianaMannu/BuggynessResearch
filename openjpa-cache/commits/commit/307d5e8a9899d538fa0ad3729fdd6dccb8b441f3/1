{"sha":"307d5e8a9899d538fa0ad3729fdd6dccb8b441f3","node_id":"MDY6Q29tbWl0MjA2MzY0OjMwN2Q1ZThhOTg5OWQ1MzhmYTBhZDM3MjlmZGQ2ZGNjYjhiNDQxZjM=","commit":{"author":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-02-12T20:22:29Z"},"committer":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-02-12T20:22:29Z"},"message":"merge in updates from trunk/openjpa/pom.xml and waiting for testing from Apache Aries before merging into openjpa/pom.xml\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@909595 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"8df78930b699ad3693644c6bd5f8fb9942d17b7c","url":"https://api.github.com/repos/apache/openjpa/git/trees/8df78930b699ad3693644c6bd5f8fb9942d17b7c"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3","html_url":"https://github.com/apache/openjpa/commit/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3","comments_url":"https://api.github.com/repos/apache/openjpa/commits/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3/comments","author":null,"committer":null,"parents":[{"sha":"c1a24be02bed1d45a892acc4b777c0f834ef4c9b","url":"https://api.github.com/repos/apache/openjpa/commits/c1a24be02bed1d45a892acc4b777c0f834ef4c9b","html_url":"https://github.com/apache/openjpa/commit/c1a24be02bed1d45a892acc4b777c0f834ef4c9b"}],"stats":{"total":294,"additions":147,"deletions":147},"files":[{"sha":"66e2ee95b80814e00f97c73654a839bfd64c45f0","filename":"openjpa-osgi/pom.xml","status":"modified","additions":147,"deletions":147,"changes":294,"blob_url":"https://github.com/apache/openjpa/blob/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3/openjpa-osgi/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/307d5e8a9899d538fa0ad3729fdd6dccb8b441f3/openjpa-osgi/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-osgi/pom.xml?ref=307d5e8a9899d538fa0ad3729fdd6dccb8b441f3","patch":"@@ -24,7 +24,7 @@\n <project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd\">\n     <modelVersion>4.0.0</modelVersion>\n     <artifactId>openjpa-osgi</artifactId>\n-    <packaging>jar</packaging>\n+    <packaging>bundle</packaging>\n     <name>OpenJPA Aggregate Jar for OSGi</name>\n     <parent>\n         <groupId>org.apache.openjpa</groupId>\n@@ -34,219 +34,219 @@\n \n     <build>\n         <plugins>\n+            <!--\n+                Need to disable source plugin here, as it overwrites the shade\n+                plugin created sources jar.\n+            -->\n             <plugin>\n-                <!--\n-                    Manually build an aggregate jar of all the other\n-                    openjpa-* jars using ant. We cannot use the assembly\n-                    plugin, since it doesn't provide support for appending\n-                    multiple same-named files to each other (which is\n-                    required for correctly aggregating services files).\n-                -->\n                 <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-antrun-plugin</artifactId>\n+                <artifactId>maven-source-plugin</artifactId>\n+                <executions>\n+                    <execution>\n+                        <id>attach-sources</id>\n+                        <phase>none</phase> \n+                    </execution>\n+                </executions>\n+            </plugin>\n+            <!-- Create our aggregate JAR -->\n+            <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n+                <artifactId>maven-shade-plugin</artifactId>\n                 <executions>\n                     <execution>\n-                        <id>build-single-jar</id>\n-                        <phase>compile</phase>\n+                        <phase>package</phase>\n+                        <goals>\n+                            <goal>shade</goal>\n+                        </goals>\n                         <configuration>\n-                            <tasks>\n-                                <unjar overwrite=\"false\" dest=\"${basedir}/target/classes\">\n-                                    <fileset dir=\"${basedir}/..\">\n-                                        <include name=\"*/target/openjpa-*.jar\" />\n-                                        <exclude name=\"*/target/openjpa-2*.jar\" />\n-                                        <exclude name=\"*/target/openjpa-all-*.jar\" />\n-                                        <exclude name=\"*/target/openjpa-examples-*.jar\" />\n-                                        <exclude name=\"**/*-tests.jar\" />\n-                                        <exclude name=\"**/*-sources.jar\" />\n-                                        <exclude name=\"**/*-javadoc.jar\" />\n-                                        <exclude name=\"openjpa-integration/**/target/openjpa-all-*.jar\" />\n-                                    </fileset>\n-                                </unjar>\n-\n-                                <!--\n-                                    need to manually concatinate the services \n-                                    resources so they are aggregated\n+                            <createDependencyReducedPom>true</createDependencyReducedPom>\n+                            <createSourcesJar>true</createSourcesJar>\n+                            <keepDependenciesWithProvidedScope>true</keepDependenciesWithProvidedScope>\n+                            <promoteTransitiveDependencies>true</promoteTransitiveDependencies>\n+                            <!--\n+                                 Specify a subset of depends to include,\n+                                 which must match the <dependencies> section.\n+                            -->\n+                            <artifactSet>\n+                                <includes>\n+                                    <include>org.apache.openjpa:openjpa-lib</include>\n+                                    <include>org.apache.openjpa:openjpa-kernel</include>\n+                                    <include>org.apache.openjpa:openjpa-jdbc</include>\n+                                    <include>org.apache.openjpa:openjpa-persistence</include>\n+                                    <include>org.apache.openjpa:openjpa-persistence-jdbc</include>\n+                                    <include>org.apache.openjpa:openjpa-xmlstore</include>\n+                                    <include>org.apache.openjpa:openjpa-slice</include>\n+                                </includes>\n+                            </artifactSet>\n+                            <!-- OpenJPA unique META-INF setup -->\n+                            <transformers>\n+                                <!-- Need to concatinate the services resources:\n+                                 org.apache.openjpa.lib.conf.ProductDerivation\n+                                 javax.persistence.spi.PersistenceProvider\n+                                 org.apache.openjpa.kernel.exps.ExpressionParser\n                                 -->\n-                                <macrodef name=\"aggregate-file\">\n-                                   <attribute name=\"servicename\" />\n-                                    <sequential>\n-                                        <echo>Building service: @{servicename}</echo>\n-                                        <concat destfile=\"${basedir}/target/classes/META-INF/services/@{servicename}\">\n-                                            <fileset dir=\"${basedir}/..\" includes=\"*/src/main/resources/META-INF/services/@{servicename}\" />\n-                                        </concat>\n-                                    </sequential>\n-                                </macrodef>\n-\n-                                <aggregate-file servicename=\"org.apache.openjpa.lib.conf.ProductDerivation\" />\n-                                <aggregate-file servicename=\"javax.persistence.spi.PersistenceProvider\" />\n-                                <aggregate-file servicename=\"org.apache.openjpa.kernel.exps.ExpressionParser\" />\n-                            </tasks>\n+                                <transformer implementation=\"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer\"/>\n+                                <!-- Need to add some MANIFEST.MF metadata -->\n+                                <transformer implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\">\n+                                    <manifestEntries>\n+                                        <Main-Class>org.apache.openjpa.conf.OpenJPAVersion</Main-Class>\n+                                        <Premain-Class>org.apache.openjpa.enhance.PCEnhancerAgent</Premain-Class>\n+                                        <Agent-Class>org.apache.openjpa.enhance.InstrumentationFactory</Agent-Class>\n+                                        <Can-Redefine-Classes>true</Can-Redefine-Classes>\n+                                        <Can-Retransform-Classes>true</Can-Retransform-Classes>\n+                                        <Implementation-Title>Apache OpenJPA Aggregate JAR</Implementation-Title>\n+                                        <Specification-Title>JSR-317 Java Persistence</Specification-Title>\n+                                        <Specification-Vendor>Sun Microsystems, Inc.</Specification-Vendor>\n+                                        <Specification-Version>2.0</Specification-Version>\n+                                    </manifestEntries>\n+                                </transformer>\n+                            </transformers>\n                         </configuration>\n-                        <goals>\n-                            <goal>run</goal>\n-                        </goals>\n                     </execution>\n                 </executions>\n             </plugin>\n \n-            <!--\n-                create enhancer pre-main and agent-main attributes\n-            -->\n+            <!-- extract the shaded jar so a bundle can be created -->\n             <plugin>\n                 <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-jar-plugin</artifactId>\n-                <configuration>\n-                    <archive>\n-                        <manifestFile>${project.build.outputDirectory}/META-INF/MANIFEST.MF</manifestFile>\n-                        <manifest>\n-                           <mainClass>org.apache.openjpa.conf.OpenJPAVersion</mainClass>\n-                        </manifest>\n-                        <manifestEntries>\n-                            <Premain-Class>\n-                                org.apache.openjpa.enhance.PCEnhancerAgent\n-                            </Premain-Class>\n-                            <Can-Redefine-Classes>true</Can-Redefine-Classes>\n-                            <Agent-Class>\n-                                org.apache.openjpa.enhance.InstrumentationFactory\n-                            </Agent-Class>\n-                            <Can-Redefine-Classes>true</Can-Redefine-Classes>                            \n-                            <Can-Retransform-Classes>true</Can-Retransform-Classes>\n-                        </manifestEntries>\n-                    </archive>\n-                </configuration>\n+                <artifactId>maven-antrun-plugin</artifactId>\n+                <executions>\n+                    <execution>\n+                        <phase>package</phase>\n+                        <goals>\n+                            <goal>run</goal>\n+                        </goals>\n+                        <configuration>\n+                            <tasks>\n+                                <unzip src=\"${project.build.directory}/${pom.artifactId}-${pom.version}.jar\" dest=\"${project.build.directory}/classes\"/>\n+                            </tasks>\n+                        </configuration>\n+                    </execution>\n+                </executions>\n             </plugin>\n \n+            <!-- create an OSGi bundle -->\n             <plugin>\n                 <groupId>org.apache.felix</groupId>\n                 <artifactId>maven-bundle-plugin</artifactId>\n                 <extensions>true</extensions>\n                 <configuration>\n                     <instructions>\n-                        <Bundle-Activator>org.apache.openjpa.osgi.PersistenceActivator</Bundle-Activator>\n-                        <Bundle-Name>${artifactId}</Bundle-Name>\n-                        <Bundle-SymbolicName>${groupId}.${artifactId};singleton=true</Bundle-SymbolicName>\n-                        <Bundle-DocURL>http://openjpa.apache.org/documentation.html</Bundle-DocURL>\n-                        <Implementation-Title>Apache OpenJPA</Implementation-Title>\n-                        <Implementation-Version>${project.version}</Implementation-Version>\n-                        <Specification-Title>JSR-317 Java Persistence</Specification-Title>\n-                        <Specification-Vendor>Sun Microsystems, Inc.</Specification-Vendor>\n-                        <Specification-Version>2.0</Specification-Version>\n                         <!-- OSGi Bundle Metadata -->\n-                        <Private-Package>org.openjpa.lib.ant*,org.apache.jdbc.ant*,META-INF*</Private-Package>\n-                        <Export-Package>!META-INF*,!org.openjpa.lib.ant*,!org.apache.jdbc.ant*,org.apache.openjpa*</Export-Package>\n-                        <Import-Package>com.ibm.*;resolution:=optional,org.postgresql.*;resolution:=optional,org.apache.tools.ant.*;resolution:=optional,org.apache.log4j.*;resolution:=optional,javax.activation.xa*;resolution:=optional,javax.jms.*;resolution:=optional,javax.transaction.*;resolution:=optional,javax.validation.*;resolution:=optional,javax.xml.bind.*;resolution:=optional,serp.*;resolution:=optional,*</Import-Package>\n-                        <Require-Bundle>org.apache.geronimo.specs.geronimo-jpa_2.0_spec;bundle-version=\"[1.0.0,2.0.0)\"</Require-Bundle>\n-                        <!-- Eclipse metadata\n+                        <Bundle-DocURL>${project.url}</Bundle-DocURL>\n+                        <Bundle-Activator>org.apache.openjpa.osgi.PersistenceActivator</Bundle-Activator>\n+                        <Private-Package />\n+                        <Export-Package>org.apache.openjpa.*;version=${pom.version}</Export-Package>\n+                        <Import-Package>com.ibm.*;resolution:=optional,org.postgresql.*;resolution:=optional,org.apache.tools.ant.*;resolution:=optional,org.apache.log4j.*;resolution:=optional,javax.activation.xa*;resolution:=optional,javax.jms.*;version=\"[1.1.0,1.2)\";resolution:=optional,javax.transaction.*;version=\"[1.1.0,1.2)\";resolution:=optional,javax.validation.*;version=\"[1.0.0,1.1)\";resolution:=optional,javax.xml.bind.*;resolution:=optional,serp.*;resolution:=optional,javax.persistence.*;version=\"[2.0.0,2.1)\",*</Import-Package>\n+                        <!-- Eclipse metadata -->\n                         <Eclipse-Autostart>false</Eclipse-Autostart>\n                         <Bundle-ClassPath>.</Bundle-ClassPath>\n-                        -->\n                     </instructions>\n-                    <unpackBundle>true</unpackBundle>\n                 </configuration>\n-                <executions>\n-                    <execution>\n-                        <id>bundle-manifest</id>\n-                        <phase>process-classes</phase>\n-                        <goals>\n-                            <goal>manifest</goal>\n-                        </goals>\n-                    </execution>\n-                </executions>\n             </plugin>\n         </plugins>\n     </build>\n+\n     <dependencies>\n-        <dependency>\n-            <groupId>org.apache.felix</groupId>\n-            <artifactId>org.osgi.core</artifactId>\n-            <version>1.4.0</version>\n-            <scope>provided</scope>\n-            <exclusions>\n-                <exclusion>\n-                    <groupId>org.apache.felix</groupId>\n-                    <artifactId>org.osgi.foundation</artifactId>\n-                </exclusion>\n-            </exclusions>\n-        </dependency>\n+        <!-- JARs to include in aggregate JAR via maven-shade-plugin -->\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-lib</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n         </dependency>\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-kernel</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n         </dependency>\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-jdbc</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n+            <!-- \n+                 Need to exclude jaxb, so the following will not get included\n+                 as compile depends in the aggregate JAR by the shade plugin:\n+                     javax.xml.bind:jaxb-api:jar:2.0\n+                     javax.xml.bind:jsr173_api:jar:1.0\n+                     javax.activation:activation:jar:1.1\n+                     com.sun.xml.bind:jaxb-impl:jar:2.0.5\n+            -->\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>javax.xml.bind</groupId>\n+                    <artifactId>jaxb-api</artifactId>\n+                </exclusion>\n+                <exclusion>\n+                    <groupId>com.sun.xml.bind</groupId>\n+                    <artifactId>jaxb-impl</artifactId>\n+                </exclusion>\n+            </exclusions>\n+        </dependency>\n+        <!-- Need to manually add back optional openjpa-jdbc depends -->\n+        <dependency>\n+            <groupId>javax.xml.bind</groupId>\n+            <artifactId>jaxb-api</artifactId>\n+            <scope>compile</scope>\n+            <optional>true</optional>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>javax.xml.bind</groupId>\n+                    <artifactId>jsr173_api</artifactId>\n+                </exclusion>\n+                <exclusion>\n+                    <groupId>javax.activation</groupId>\n+                    <artifactId>activation</artifactId>\n+                </exclusion>\n+            </exclusions>\n+        </dependency>\n+        <dependency>\n+            <groupId>com.sun.xml.bind</groupId>\n+            <artifactId>jaxb-impl</artifactId>\n+            <scope>compile</scope>\n+            <optional>true</optional>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>javax.xml.bind</groupId>\n+                    <artifactId>jsr173_api</artifactId>\n+                </exclusion>\n+                <exclusion>\n+                    <groupId>javax.activation</groupId>\n+                    <artifactId>activation</artifactId>\n+                </exclusion>\n+            </exclusions>\n         </dependency>\n+        <!-- end optional openjpa-jdbc depends -->\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-persistence</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n         </dependency>\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-persistence-jdbc</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n         </dependency>\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-xmlstore</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n         </dependency>\n         <dependency>\n             <groupId>org.apache.openjpa</groupId>\n             <artifactId>openjpa-slice</artifactId>\n             <version>${pom.version}</version>\n-            <scope>provided</scope>\n-        </dependency>\n-        <dependency>\n-            <groupId>net.sourceforge.serp</groupId>\n-            <artifactId>serp</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>commons-logging</groupId>\n-            <artifactId>commons-logging</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>commons-lang</groupId>\n-            <artifactId>commons-lang</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>commons-collections</groupId>\n-            <artifactId>commons-collections</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>commons-pool</groupId>\n-            <artifactId>commons-pool</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>org.apache.geronimo.specs</groupId>\n-            <artifactId>geronimo-jta_1.1_spec</artifactId>\n         </dependency>\n         <dependency>\n-            <groupId>org.apache.geronimo.specs</groupId>\n-            <artifactId>geronimo-jpa_2.0_spec</artifactId>\n-        </dependency>\n-        <!-- optional dependencies -->\n-        <dependency>\n-            <groupId>org.apache.geronimo.specs</groupId>\n-            <artifactId>geronimo-jms_1.1_spec</artifactId>\n-        </dependency>\n-        <dependency>\n-            <groupId>org.apache.geronimo.specs</groupId>\n-            <artifactId>geronimo-validation_1.0_spec</artifactId>\n+            <groupId>org.apache.felix</groupId>\n+            <artifactId>org.osgi.core</artifactId>\n+            <version>1.4.0</version>\n             <scope>provided</scope>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>org.apache.felix</groupId>\n+                    <artifactId>org.osgi.foundation</artifactId>\n+                </exclusion>\n+            </exclusions>\n         </dependency>\n     </dependencies>\n </project>"}]}

