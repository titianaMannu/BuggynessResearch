{"sha":"366406216fec9f3b0afd9371c1950b49d7dd3ba3","node_id":"MDY6Q29tbWl0MjA2MzY0OjM2NjQwNjIxNmZlYzlmM2IwYWZkOTM3MWMxOTUwYjQ5ZDdkZDNiYTM=","commit":{"author":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-04-08T19:17:53Z"},"committer":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-04-08T19:17:53Z"},"message":"OPENJPA-1616 Fix TestTimeoutException test failures on MySQL\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/2.0.x@932068 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"622f1fab4aa66acf42cd927696f8203414195f95","url":"https://api.github.com/repos/apache/openjpa/git/trees/622f1fab4aa66acf42cd927696f8203414195f95"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/366406216fec9f3b0afd9371c1950b49d7dd3ba3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/366406216fec9f3b0afd9371c1950b49d7dd3ba3","html_url":"https://github.com/apache/openjpa/commit/366406216fec9f3b0afd9371c1950b49d7dd3ba3","comments_url":"https://api.github.com/repos/apache/openjpa/commits/366406216fec9f3b0afd9371c1950b49d7dd3ba3/comments","author":null,"committer":null,"parents":[{"sha":"bb8ef003acb107ca4cbb59a79a2c542552a97a9b","url":"https://api.github.com/repos/apache/openjpa/commits/bb8ef003acb107ca4cbb59a79a2c542552a97a9b","html_url":"https://github.com/apache/openjpa/commit/bb8ef003acb107ca4cbb59a79a2c542552a97a9b"}],"stats":{"total":19,"additions":19,"deletions":0},"files":[{"sha":"ba30cb0e70f12c84a14623977a6703701fa80352","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","status":"modified","additions":19,"deletions":0,"changes":19,"blob_url":"https://github.com/apache/openjpa/blob/366406216fec9f3b0afd9371c1950b49d7dd3ba3/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/366406216fec9f3b0afd9371c1950b49d7dd3ba3/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java?ref=366406216fec9f3b0afd9371c1950b49d7dd3ba3","patch":"@@ -27,6 +27,7 @@\n import java.util.Collection;\n import java.util.HashSet;\n import java.util.List;\n+import java.util.Map;\n import java.util.Set;\n \n import org.apache.commons.lang.StringUtils;\n@@ -422,6 +423,24 @@ public String getSelectOperation(JDBCFetchConfiguration fetch) {\n         return result;\n     }\n     \n+    @Override\n+    protected int matchErrorState(Map<Integer,Set<String>> errorStates, SQLException ex) {\n+        int state = super.matchErrorState(errorStates, ex);\n+        // OPENJPA-1616 - Special case for MySQL not returning a SQLState for timeouts\n+        if (state == StoreException.GENERAL && ex.getErrorCode() == 0 && ex.getSQLState() == null) {\n+            // look at the nested MySQL exception for more details\n+            SQLException sqle = ex.getNextException();\n+            if (sqle != null && sqle.toString().startsWith(\"com.mysql.jdbc.exceptions.MySQLTimeoutException\")) {\n+                if (conf != null && conf.getLockTimeout() != -1) {\n+                    state = StoreException.LOCK;\n+                } else {\n+                    state = StoreException.QUERY;\n+                }\n+            }\n+        }\n+        return state;\n+    }\n+\n     @Override\n     public boolean isFatalException(int subtype, SQLException ex) {\n         if ((subtype == StoreException.LOCK  && ex.getErrorCode() == 1205)"}]}

