{"sha":"39a48606417d3cf9fbd907477275646199bb78a3","node_id":"MDY6Q29tbWl0MjA2MzY0OjM5YTQ4NjA2NDE3ZDNjZjlmYmQ5MDc0NzcyNzU2NDYxOTliYjc4YTM=","commit":{"author":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2009-02-24T16:37:41Z"},"committer":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2009-02-24T16:37:41Z"},"message":"OPENJPA-917. Merging B.J.'s changes\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.0.x@747421 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"4e5d62c8f2e34f972c6687098b0a2f7c98df0738","url":"https://api.github.com/repos/apache/openjpa/git/trees/4e5d62c8f2e34f972c6687098b0a2f7c98df0738"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/39a48606417d3cf9fbd907477275646199bb78a3","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/39a48606417d3cf9fbd907477275646199bb78a3","html_url":"https://github.com/apache/openjpa/commit/39a48606417d3cf9fbd907477275646199bb78a3","comments_url":"https://api.github.com/repos/apache/openjpa/commits/39a48606417d3cf9fbd907477275646199bb78a3/comments","author":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"committer":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"parents":[{"sha":"1e8d38ed9ce8fdbaf0dfaea31e2ee5e01ddce0e3","url":"https://api.github.com/repos/apache/openjpa/commits/1e8d38ed9ce8fdbaf0dfaea31e2ee5e01ddce0e3","html_url":"https://github.com/apache/openjpa/commit/1e8d38ed9ce8fdbaf0dfaea31e2ee5e01ddce0e3"}],"stats":{"total":332,"additions":331,"deletions":1},"files":[{"sha":"636f14afd0129814b50f991b78e1edc4dbd3ec02","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestNativeQueryProcedures.java","status":"added","additions":168,"deletions":0,"changes":168,"blob_url":"https://github.com/apache/openjpa/blob/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestNativeQueryProcedures.java","raw_url":"https://github.com/apache/openjpa/raw/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestNativeQueryProcedures.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestNativeQueryProcedures.java?ref=39a48606417d3cf9fbd907477275646199bb78a3","patch":"@@ -0,0 +1,168 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.openjpa.persistence.jdbc.query;\n+\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.Query;\n+\n+import org.apache.openjpa.jdbc.conf.JDBCConfiguration;\n+import org.apache.openjpa.jdbc.sql.DerbyDictionary;\n+import org.apache.openjpa.persistence.OpenJPAEntityManagerFactorySPI;\n+import org.apache.openjpa.persistence.jdbc.query.domain.Applicant;\n+import org.apache.openjpa.persistence.jdbc.query.procedure.DerbyProcedureList;\n+import org.apache.openjpa.persistence.jdbc.query.procedure.ProcedureList;\n+import org.apache.openjpa.persistence.test.SingleEMFTestCase;\n+\n+/**\n+ * Tests that Native queries use only 1-based positional parameters and \n+ * disallows named parameters.\n+ * \n+ * Originally reported in \n+ * <A HRE=\"http://issues.apache.org/jira/browse/OPENJPA-112>OPENJPA-112</A>\n+ *  \n+ * @author B.J. Reed\n+ *\n+ */\n+public class TestNativeQueryProcedures extends SingleEMFTestCase {\n+    ProcedureList procedureList = null;\n+    \n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp(Applicant.class, CLEAR_TABLES);\n+\n+        // Figure out which DB we have and get the proper DB Procedure List\n+        OpenJPAEntityManagerFactorySPI ojpaEmf = \n+            (OpenJPAEntityManagerFactorySPI) emf;\n+        JDBCConfiguration conf = (JDBCConfiguration) ojpaEmf.getConfiguration();\n+        \n+        if (conf.getDBDictionaryInstance() instanceof DerbyDictionary) {\n+            procedureList = new DerbyProcedureList();\n+        }\n+\n+        if (procedureList != null) {\n+            EntityManager em = emf.createEntityManager();\n+            List<String> createList = procedureList.getCreateProcedureList();\n+            try {\n+                for (String createProcedure : createList) {\n+                    em.getTransaction().begin();\n+                    Query query = em.createNativeQuery(createProcedure);\n+                    query.executeUpdate();\n+                    em.getTransaction().commit();\n+                }\n+            } catch (Exception e) {\n+                e.printStackTrace();\n+                em.getTransaction().commit();\n+            }\n+            em.clear();\n+            em.close();\n+        }\n+    }\n+\n+    public void tearDown() throws Exception {\n+        if (procedureList != null) {\n+            EntityManager em = emf.createEntityManager();\n+            List<String> dropList = procedureList.getDropProcedureList();\n+            try {\n+                for (String dropProcedure : dropList) {\n+                    em.getTransaction().begin();\n+                    Query query = em.createNativeQuery(dropProcedure);\n+                    query.executeUpdate();\n+                    em.getTransaction().commit();\n+                }\n+            } catch (Exception e) {\n+                e.printStackTrace();\n+                em.getTransaction().commit();\n+            }\n+            em.clear();\n+            em.close();\n+        }\n+        super.tearDown();\n+    }\n+    \n+    public void testNoReturnNoParamProcedure() {\n+        if (procedureList != null) {\n+            EntityManager em = emf.createEntityManager();\n+\n+            Applicant applicant1 = new Applicant();\n+            applicant1.setName(\"Charlie\");\n+            Applicant applicant2 = new Applicant();\n+            applicant2.setName(\"Snoopy\");\n+\n+            em.getTransaction().begin();\n+            em.persist(applicant1);\n+            em.persist(applicant2);\n+            em.getTransaction().commit();\n+\n+            String sql = procedureList.callAddXToCharlie();\n+\n+            // query.getSingleResult() and query.getResultList() both throw an\n+            // exception: Statement.executeQuery() cannot be called with a\n+            // statement that returns a row count\n+            try {\n+                em.getTransaction().begin();\n+                Query query = em.createNativeQuery(sql);\n+                query.getSingleResult();\n+                em.getTransaction().commit();\n+                fail(\"Expected exception. getSingleResult() with no returns \"+ \n+                    \"should fail.\");\n+            } catch (Exception e) {\n+                //Expected exception\n+                em.getTransaction().rollback();\n+            }\n+            try {\n+                em.getTransaction().begin();\n+                Query query = em.createNativeQuery(sql);\n+                query.getResultList();\n+                em.getTransaction().commit();\n+                fail(\"Expected exception. getResultList() with no returns \" + \n+                    \"should fail.\");\n+            } catch (Exception e) {\n+                //Expected exception\n+                em.getTransaction().rollback();\n+            }\n+\n+            // This one should work properly\n+            try {\n+                em.getTransaction().begin();\n+                Query query = em.createNativeQuery(sql);\n+                query.executeUpdate();\n+                em.getTransaction().commit();\n+            } catch (Exception e) {\n+                fail(\"Caught unexpected exception executing stored procedure: \"\n+                    + e.getMessage());\n+                em.getTransaction().commit();\n+            }\n+        \n+            em.clear();\n+            em.close();\n+            em = emf.createEntityManager();\n+            applicant1 = em.find(Applicant.class, applicant1.getId());\n+            applicant2 = em.find(Applicant.class, applicant2.getId());\n+\n+            // verify one changed and one didn't\n+            assertEquals(\"Charliex\", applicant1.getName());\n+            assertEquals(\"Snoopy\", applicant2.getName());\n+        \n+            em.clear();\n+            em.close();\n+        }\n+    }\n+}\n\\ No newline at end of file"},{"sha":"24d379a069a1a8be1f48397b51908e9e01ba3ec1","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Applicant.java","status":"added","additions":50,"deletions":0,"changes":50,"blob_url":"https://github.com/apache/openjpa/blob/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Applicant.java","raw_url":"https://github.com/apache/openjpa/raw/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Applicant.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Applicant.java?ref=39a48606417d3cf9fbd907477275646199bb78a3","patch":"@@ -0,0 +1,50 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query.domain;\r\n+\r\n+import javax.persistence.*;\r\n+\r\n+/**\r\n+ * Simple persistent entity as a target of uni-directional one-to-one \r\n+ * association.\r\n+ * \r\n+ * @author Pinaki Poddar\r\n+ *\r\n+ */\r\n+@Entity\r\n+public class Applicant {\r\n+\t@Id\r\n+\t@GeneratedValue\r\n+\tprivate long id;\r\n+\r\n+\tprivate String name;\r\n+\r\n+\tpublic String getName() {\r\n+\t\treturn name;\r\n+\t}\r\n+\r\n+\tpublic void setName(String name) {\r\n+\t\tthis.name = name;\r\n+\t}\r\n+\r\n+\tpublic long getId() {\r\n+\t\treturn id;\r\n+\t}\r\n+\r\n+}\r"},{"sha":"d3ad3c153f673864cdb77f788cf50c35242bfafc","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/DerbyProcedureList.java","status":"added","additions":66,"deletions":0,"changes":66,"blob_url":"https://github.com/apache/openjpa/blob/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/DerbyProcedureList.java","raw_url":"https://github.com/apache/openjpa/raw/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/DerbyProcedureList.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/DerbyProcedureList.java?ref=39a48606417d3cf9fbd907477275646199bb78a3","patch":"@@ -0,0 +1,66 @@\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.jdbc.query.procedure;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.PreparedStatement;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/*\n+ * holds the stored procedures that will be used by test cases\n+ */\n+public class DerbyProcedureList extends ProcedureList {\n+\n+    public List<String> getCreateProcedureList () {\n+        ArrayList<String> retList = new ArrayList<String>();\n+\n+        retList.add (\"create procedure ADD_X_TO_CHARLIE () \" +\n+                     \"PARAMETER STYLE JAVA LANGUAGE JAVA MODIFIES SQL DATA \" +\n+                     \"EXTERNAL NAME 'org.apache.openjpa.persistence.jdbc.\" + \n+                     \"query.procedure.DerbyProcedureList.addXToCharlie'\");\n+        \n+\n+        return retList;\n+    }\n+\n+    public List<String> getDropProcedureList () {\n+        ArrayList<String> retList = new ArrayList<String>();\n+\n+        retList.add (\"drop procedure ADD_X_TO_CHARLIE\");\n+\n+        return retList;\n+    }\n+\n+    public String callAddXToCharlie () {\n+        return \"{ call ADD_X_TO_CHARLIE () }\";\n+    }\n+\n+    public static void addXToCharlie () throws Exception {\n+        Connection conn = DriverManager.getConnection(\n+            \"jdbc:default:connection\");\n+        PreparedStatement ps1 = conn.prepareStatement(\"update APPLICANT set \" + \n+            \"name = 'Charliex' where name = 'Charlie'\");\n+        ps1.executeUpdate();\n+\n+        conn.close();\n+    }\n+}"},{"sha":"e23b64816e5143bbf3a7e830a2f4eedae5da869c","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/ProcedureList.java","status":"added","additions":41,"deletions":0,"changes":41,"blob_url":"https://github.com/apache/openjpa/blob/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/ProcedureList.java","raw_url":"https://github.com/apache/openjpa/raw/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/ProcedureList.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/procedure/ProcedureList.java?ref=39a48606417d3cf9fbd907477275646199bb78a3","patch":"@@ -0,0 +1,41 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.jdbc.query.procedure;\n+\n+import java.util.List;\n+\n+/*\n+ * holds the stored procedures that will be used by test cases\n+ */\n+public abstract class ProcedureList {\n+\n+    abstract public List<String> getCreateProcedureList ();\n+\n+    abstract public List<String> getDropProcedureList ();\n+\n+    abstract public String callAddXToCharlie ();\n+\n+    // This method should also be overriden, but it needs to be static so \n+    // that it can be called as a stored procedure\n+    public static void addXToCharlie () throws Exception {\n+        Exception e = new Exception (\"Method not implemented by inheriting \" + \n+            \"class\");\n+        throw e;\n+    }\n+}"},{"sha":"06a2863c8a8301f32b2bf25ee8545e815a59fa57","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","status":"modified","additions":6,"deletions":1,"changes":7,"blob_url":"https://github.com/apache/openjpa/blob/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","raw_url":"https://github.com/apache/openjpa/raw/39a48606417d3cf9fbd907477275646199bb78a3/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java?ref=39a48606417d3cf9fbd907477275646199bb78a3","patch":"@@ -39,6 +39,7 @@\n import org.apache.openjpa.kernel.DelegatingQuery;\n import org.apache.openjpa.kernel.DelegatingResultList;\n import org.apache.openjpa.kernel.Filters;\n+import org.apache.openjpa.kernel.QueryLanguages;\n import org.apache.openjpa.kernel.QueryOperations;\n import org.apache.openjpa.kernel.exps.AggregateListener;\n import org.apache.openjpa.kernel.exps.FilterListener;\n@@ -224,7 +225,7 @@ public OpenJPAQuery compile() {\n     }\n \n     private Object execute() {\n-        if (_query.getOperation() != QueryOperations.OP_SELECT)\n+        if (! isNative() && _query.getOperation() != QueryOperations.OP_SELECT)\n             throw new InvalidStateException(_loc.get(\"not-select-query\",\n                 _query.getQueryString()), null, null, false);\n \n@@ -485,6 +486,10 @@ public OpenJPAQuery setParameter(String name, Object value) {\n             _query.unlock();\n         }\n     }\n+    \n+    public boolean isNative() {\n+        return QueryLanguages.LANG_SQL.equals(getLanguage());\n+    }\n \n     public boolean hasPositionalParameters() {\n         return _positional != null;"}]}

