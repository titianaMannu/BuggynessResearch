{"sha":"3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4","node_id":"MDY6Q29tbWl0MjA2MzY0OjNlYzBmYmY2NmZkNmZkNDMzZDI1ZTk4ODRlMmJkMzQ1M2U3OGYxZjQ=","commit":{"author":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2009-10-28T03:00:17Z"},"committer":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2009-10-28T03:00:17Z"},"message":"OPENJPA-1354: DBCP getConnection with user/password\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@830426 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"3cab60015d2b306e846a70474296f23782529be7","url":"https://api.github.com/repos/apache/openjpa/git/trees/3cab60015d2b306e846a70474296f23782529be7"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4","html_url":"https://github.com/apache/openjpa/commit/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4","comments_url":"https://api.github.com/repos/apache/openjpa/commits/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4/comments","author":null,"committer":null,"parents":[{"sha":"ad1029fde49253d5e97f880c57665b6ce8dcab44","url":"https://api.github.com/repos/apache/openjpa/commits/ad1029fde49253d5e97f880c57665b6ce8dcab44","html_url":"https://github.com/apache/openjpa/commit/ad1029fde49253d5e97f880c57665b6ce8dcab44"}],"stats":{"total":29,"additions":28,"deletions":1},"files":[{"sha":"c8883ff11a862ad47ccd3b370c20f1c2dac34433","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/jdbc/DelegatingDataSource.java","status":"modified","additions":28,"deletions":1,"changes":29,"blob_url":"https://github.com/apache/openjpa/blob/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4/openjpa-lib/src/main/java/org/apache/openjpa/lib/jdbc/DelegatingDataSource.java","raw_url":"https://github.com/apache/openjpa/raw/3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4/openjpa-lib/src/main/java/org/apache/openjpa/lib/jdbc/DelegatingDataSource.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/jdbc/DelegatingDataSource.java?ref=3ec0fbf66fd6fd433d25e9884e2bd3453e78f1f4","patch":"@@ -20,6 +20,7 @@\n \n import java.io.PrintWriter;\n import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n import java.sql.Connection;\n import java.sql.SQLException;\n import javax.sql.DataSource;\n@@ -134,7 +135,23 @@ public Connection getConnection(String user, String pass)\n         throws SQLException {\n         if (user == null && pass == null)\n             return _ds.getConnection();\n-        return _ds.getConnection(user, pass);\n+        try {\n+            return _ds.getConnection(user, pass);\n+        } catch (UnsupportedOperationException ex) {\n+            // OPENJPA-1354\n+            // under some configuration _ds is Commons DBCP Basic/Poolable DataSource\n+            // that does not support getConnection(user, password)\n+            // see http://commons.apache.org/dbcp/apidocs/org/apache/commons/dbcp/BasicDataSource.html\n+            // hence this workaround\n+            try {\n+                if (setBeanProperty(_ds, \"setUsername\", user)\n+                 && setBeanProperty(_ds, \"setPassword\", pass))\n+                    return _ds.getConnection();\n+            } catch (Exception e) {\n+                throw ex;\n+            }\n+        }\n+        return null;\n     }\n \n     public void close() throws Exception {\n@@ -153,4 +170,14 @@ public Object unwrap(Class iface) {\n         else\n             return null;\n     }\n+    \n+    private boolean setBeanProperty(Object target, String method, Object val) {\n+        try {\n+            Method setter = target.getClass().getMethod(method, new Class[]{});\n+            setter.invoke(target, val);\n+            return true;\n+        } catch (Throwable t) {\n+            return false;\n+        }\n+    }\n }"}]}

