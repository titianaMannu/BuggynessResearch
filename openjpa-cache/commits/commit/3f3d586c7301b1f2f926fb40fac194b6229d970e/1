{"sha":"3f3d586c7301b1f2f926fb40fac194b6229d970e","node_id":"MDY6Q29tbWl0MjA2MzY0OjNmM2Q1ODZjNzMwMWIxZjJmOTI2ZmI0MGZhYzE5NGI2MjI5ZDk3MGU=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-12-03T23:42:00Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-12-03T23:42:00Z"},"message":"OPENJPA-1413: fix NPE when update using CASE expression on Derby\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@886991 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"f1288302f1edd852153fc683b4d8271e88917cbc","url":"https://api.github.com/repos/apache/openjpa/git/trees/f1288302f1edd852153fc683b4d8271e88917cbc"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/3f3d586c7301b1f2f926fb40fac194b6229d970e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/3f3d586c7301b1f2f926fb40fac194b6229d970e","html_url":"https://github.com/apache/openjpa/commit/3f3d586c7301b1f2f926fb40fac194b6229d970e","comments_url":"https://api.github.com/repos/apache/openjpa/commits/3f3d586c7301b1f2f926fb40fac194b6229d970e/comments","author":null,"committer":null,"parents":[{"sha":"f697798fd8dac5c9567ecdbd2bd768169cbcc2ef","url":"https://api.github.com/repos/apache/openjpa/commits/f697798fd8dac5c9567ecdbd2bd768169cbcc2ef","html_url":"https://github.com/apache/openjpa/commit/f697798fd8dac5c9567ecdbd2bd768169cbcc2ef"}],"stats":{"total":26,"additions":12,"deletions":14},"files":[{"sha":"efe1ba3fd7908a6bcf97f2e42496ac1b8806edbf","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CompareEqualExpression.java","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/3f3d586c7301b1f2f926fb40fac194b6229d970e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CompareEqualExpression.java","raw_url":"https://github.com/apache/openjpa/raw/3f3d586c7301b1f2f926fb40fac194b6229d970e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CompareEqualExpression.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/CompareEqualExpression.java?ref=3f3d586c7301b1f2f926fb40fac194b6229d970e","patch":"@@ -106,7 +106,8 @@ public void appendTo(Select sel, ExpContext ctx, ExpState state,\n         boolean val2Null = _val2 instanceof Const\n             && ((Const) _val2).isSQLValueNull(sel, ctx, bstate.state2);\n         appendTo(sel, ctx, bstate, buf, val1Null, val2Null);\n-        sel.append(buf, state.joins);\n+        if (sel != null)\n+            sel.append(buf, state.joins);\n     }\n \n     public void selectColumns(Select sel, ExpContext ctx, ExpState state, "},{"sha":"8c884949a0f576f9d7f0d49f8497ffdcaaa18f9e","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jpql/expressions/TestJPQLScalarExpressions.java","status":"modified","additions":10,"deletions":13,"changes":23,"blob_url":"https://github.com/apache/openjpa/blob/3f3d586c7301b1f2f926fb40fac194b6229d970e/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jpql/expressions/TestJPQLScalarExpressions.java","raw_url":"https://github.com/apache/openjpa/raw/3f3d586c7301b1f2f926fb40fac194b6229d970e/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jpql/expressions/TestJPQLScalarExpressions.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jpql/expressions/TestJPQLScalarExpressions.java?ref=3f3d586c7301b1f2f926fb40fac194b6229d970e","patch":"@@ -249,22 +249,19 @@ public void testGeneralCaseExpressions() {\n         assertEquals(\"the name is not Jacob\", \"Jacob\", result3[0]);\n         assertEquals(\"the credit rating is not 'POOR'\", \"POOR\", result3[1]);\n \n-        /*\n-        // this jpql fail with NPE in Derby. It works with DB2 \n         String update2 = \"update CompUser c set c.creditRating = \" +\n             \" CASE WHEN c.name ='Jacob' THEN \" +\n-            \"org.apache.openjpa.persistence.common.apps.CompUser$\n-            CreditRating.POOR\" + \n+            \"org.apache.openjpa.persistence.common.apps.CompUser$CreditRating.POOR\" + \n             \" WHEN c.name = 'Ugo' THEN \" + \n-            \"org.apache.openjpa.persistence.common.apps.CompUser$\n-            CreditRating.GOOD \" +\n+            \"org.apache.openjpa.persistence.common.apps.CompUser$CreditRating.GOOD \" +\n             \" ELSE \" + \n-            \"org.apache.openjpa.persistence.common.apps.CompUser$\n-            CreditRating.EXCELLENT \" +\n+            \"org.apache.openjpa.persistence.common.apps.CompUser$CreditRating.EXCELLENT \" +\n             \" END \";\n-        */\n+        int updateCount = em.createQuery(update2).executeUpdate();\n+        assertEquals(\"the result is not 6\", 6, updateCount);\n         \n-        String update2 = \"update CompUser c set c.creditRating = \" +\n+        \n+        String update3 = \"update CompUser c set c.creditRating = \" +\n             \" CASE WHEN c.age > 30 THEN \" +\n             \"org.apache.openjpa.persistence.common.apps.\" +\n             \"CompUser$CreditRating.POOR\" + \n@@ -275,7 +272,7 @@ public void testGeneralCaseExpressions() {\n             \"org.apache.openjpa.persistence.common.apps.\" +\n             \"CompUser$CreditRating.EXCELLENT \" +\n             \" END \"; \n-        int updateCount = em.createQuery(update2).executeUpdate();\n+        updateCount = em.createQuery(update3).executeUpdate();\n         assertEquals(\"the result is not 6\", 6, updateCount);\n         \n         String query4 = \"select e.name, e.creditRating from CompUser e \" + \n@@ -300,7 +297,7 @@ public void testGeneralCaseExpressions() {\n             ((org.apache.openjpa.persistence.common.apps.CompUser.CreditRating)\n             result4[1]).name());\n         \n-        String update3 = \"update CompUser c set c.creditRating = \" +\n+        String update4 = \"update CompUser c set c.creditRating = \" +\n             \" CASE c.age WHEN 35 THEN \" +\n             \"org.apache.openjpa.persistence.common.apps.\" +\n             \"CompUser$CreditRating.POOR\" + \n@@ -311,7 +308,7 @@ public void testGeneralCaseExpressions() {\n             \"org.apache.openjpa.persistence.common.apps.\" +\n             \"CompUser$CreditRating.EXCELLENT \" +\n             \" END \"; \n-        result = em.createQuery(update3).executeUpdate();\n+        result = em.createQuery(update4).executeUpdate();\n         assertEquals(\"the result is not 6\", 6, result);\n \n         // Derby fails but DB2 works "}]}

