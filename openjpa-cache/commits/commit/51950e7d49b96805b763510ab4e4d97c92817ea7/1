{"sha":"51950e7d49b96805b763510ab4e4d97c92817ea7","node_id":"MDY6Q29tbWl0MjA2MzY0OjUxOTUwZTdkNDliOTY4MDViNzYzNTEwYWI0ZTRkOTdjOTI4MTdlYTc=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-05-12T18:41:33Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-05-12T18:41:33Z"},"message":"OPENJPA-591. Porting Mike's work to 1.1.x.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.1.x@655595 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"0781fcd318e8ceee509171bfee5cc630e5bbdcf9","url":"https://api.github.com/repos/apache/openjpa/git/trees/0781fcd318e8ceee509171bfee5cc630e5bbdcf9"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/51950e7d49b96805b763510ab4e4d97c92817ea7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/51950e7d49b96805b763510ab4e4d97c92817ea7","html_url":"https://github.com/apache/openjpa/commit/51950e7d49b96805b763510ab4e4d97c92817ea7","comments_url":"https://api.github.com/repos/apache/openjpa/commits/51950e7d49b96805b763510ab4e4d97c92817ea7/comments","author":null,"committer":null,"parents":[{"sha":"07d65dcfa4546d0f3fa87da46317295dbbad7f1e","url":"https://api.github.com/repos/apache/openjpa/commits/07d65dcfa4546d0f3fa87da46317295dbbad7f1e","html_url":"https://github.com/apache/openjpa/commit/07d65dcfa4546d0f3fa87da46317295dbbad7f1e"}],"stats":{"total":239,"additions":227,"deletions":12},"files":[{"sha":"c054895ecb40c7a907af6da793301a412dde9dc3","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/conf/Compatibility.java","status":"modified","additions":32,"deletions":0,"changes":32,"blob_url":"https://github.com/apache/openjpa/blob/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-kernel/src/main/java/org/apache/openjpa/conf/Compatibility.java","raw_url":"https://github.com/apache/openjpa/raw/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-kernel/src/main/java/org/apache/openjpa/conf/Compatibility.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/conf/Compatibility.java?ref=51950e7d49b96805b763510ab4e4d97c92817ea7","patch":"@@ -55,6 +55,7 @@\n     private boolean _nonOptimisticVersionCheck = false;\n     private int _jpql = JPQL_WARN;\n     private boolean _storeMapCollectionInEntityAsBlob = false;\n+    private boolean _flushBeforeDetach = true; \n \n     /**\n      * Whether to require exact identity value types when creating object\n@@ -237,4 +238,35 @@ public boolean getStoreMapCollectionInEntityAsBlob() {\n     public void setStoreMapCollectionInEntityAsBlob(boolean storeAsBlob) {\n         _storeMapCollectionInEntityAsBlob = storeAsBlob;\n     }\n+    \n+    /**\n+     * Whether OpenJPA should flush changes before detaching or serializing an\n+     * entity. In JPA this is usually false, but other persistence frameworks\n+     * (ie JDO) may expect it to be true.\n+     * <P>Prior to version 1.0.3 and 1.2.0 changes were always flushed.\n+     * \n+     * @since 1.0.3\n+     * @since 1.2.0\n+     * @return true if changes should be flushed, otherwise false.\n+     */\n+    public boolean getFlushBeforeDetach() {\n+        return _flushBeforeDetach;\n+    }\n+\n+    /**\n+     * Whether OpenJPA should flush changes before detaching or serializing an\n+     * entity. In JPA this is usually false, but other persistence frameworks\n+     * (ie JDO) may expect it to be true.\n+     * <P>Prior to version 1.0.3 and 1.2.0 changes were always flushed.\n+     * \n+     * @param beforeDetach if true changes will be flushed before detaching or \n+     * serializing an entity.\n+     * \n+     * @since 1.0.3\n+     * @since 1.2.0\n+     */\n+    public void setFlushBeforeDetach(boolean beforeDetach) {\n+        _flushBeforeDetach = beforeDetach;\n+    }\n+\n }"},{"sha":"b821825c8b4aa5e713249658d476416517d7f007","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManager.java","status":"modified","additions":16,"deletions":3,"changes":19,"blob_url":"https://github.com/apache/openjpa/blob/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManager.java","raw_url":"https://github.com/apache/openjpa/raw/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/DetachManager.java?ref=51950e7d49b96805b763510ab4e4d97c92817ea7","patch":"@@ -67,6 +67,7 @@\n     private final OpCallbacks _call;\n     private final boolean _failFast;\n     private boolean _flushed = false;\n+    private boolean _flushBeforeDetach;\n \n     // if we're not detaching full, we need to track all detached objects;\n     // if we are, then we use a special field manager for more efficient\n@@ -82,7 +83,10 @@ static boolean preSerialize(StateManagerImpl sm) {\n         if (!sm.isPersistent())\n             return false;\n \n-        flushDirty(sm);\n+        if (sm.getBroker().getConfiguration().getCompatibilityInstance()\n+                .getFlushBeforeDetach()) {\n+            flushDirty(sm);\n+        }\n \n         ClassMetaData meta = sm.getMetaData();\n         boolean setState = meta.getDetachedState() != null\n@@ -270,6 +274,9 @@ public DetachManager(BrokerImpl broker, boolean full, OpCallbacks call) {\n             _detached = new IdentityMap();\n             _fullFM = null;\n         }\n+        _flushBeforeDetach =\n+                broker.getConfiguration().getCompatibilityInstance()\n+                        .getFlushBeforeDetach();\n     }\n \n     /**\n@@ -415,8 +422,14 @@ private Object detachInternal(Object toDetach) {\n         _broker.fireLifecycleEvent(toDetach, null, sm.getMetaData(),\n             LifecycleEvent.BEFORE_DETACH);\n \n-        // any dirty instances cause a flush to occur\n-        _flushed = _flushed || flushDirty(sm);\n+        if(! _flushed)  {\n+            if(_flushBeforeDetach) {\n+                // any dirty instances cause a flush to occur\n+                flushDirty(sm);\n+            }\n+            _flushed = true;\n+        }\n+        \n         BitSet fields = new BitSet();\n         preDetach(_broker, sm, fields);\n "},{"sha":"eca1165628d439f966966f6d6383869547262c60","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/Item.java","status":"modified","additions":5,"deletions":1,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/Item.java","raw_url":"https://github.com/apache/openjpa/raw/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/Item.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/Item.java?ref=51950e7d49b96805b763510ab4e4d97c92817ea7","patch":"@@ -18,6 +18,8 @@\n  */\n package org.apache.openjpa.persistence.simple;\n \n+import java.io.Serializable;\n+\n import javax.persistence.Basic;\n import javax.persistence.Column;\n import javax.persistence.Entity;\n@@ -28,8 +30,10 @@\n \n @Entity\n @Table(name = \"ITEM\")\n-public class Item {\n+public class Item implements Serializable {\n \n+    private static final long serialVersionUID = 489786296539819572L;\n+    \n     public int itemId;\n     public String itemName;\n     public java.math.BigDecimal itemPrice;"},{"sha":"f8bf6e4b96f30d488a223ef42b63ab2f8615dc80","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/TestFlushBeforeDetach.java","status":"added","additions":144,"deletions":0,"changes":144,"blob_url":"https://github.com/apache/openjpa/blob/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/TestFlushBeforeDetach.java","raw_url":"https://github.com/apache/openjpa/raw/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/TestFlushBeforeDetach.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/simple/TestFlushBeforeDetach.java?ref=51950e7d49b96805b763510ab4e4d97c92817ea7","patch":"@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.simple;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.ObjectInputStream;\n+import java.io.ObjectOutputStream;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+\n+import javax.persistence.EntityManager;\n+\n+import org.apache.openjpa.persistence.OpenJPAPersistence;\n+import org.apache.openjpa.persistence.test.SQLListenerTestCase;\n+\n+public class TestFlushBeforeDetach extends SQLListenerTestCase {\n+\n+    private int _id;\n+    \n+    public void setUp() {\n+      setUp(Item.class,\"openjpa.Compatibility\", \n+                \"default(flushBeforeDetach=false)\");\n+        persistSampleEntity();\n+    }\n+    \n+    private void persistSampleEntity() {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+        Item i = new Item();\n+        em.persist(i);\n+        em.getTransaction().commit();\n+        em.refresh(i);\n+        _id = i.getItemId();\n+        em.close();\n+    }\n+\n+    public void testClear() {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+\n+        Item i = em.find(Item.class, _id);\n+\n+        i.setItemData(\"ABCD\");\n+\n+        em.clear();\n+        em.getTransaction().rollback();\n+        assertNotSQL(\"UPDATE ITEM.*\");\n+        em.close();\n+    }\n+\n+    public void testDetach() {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+\n+        Item i = em.find(Item.class, _id);\n+\n+        i.setItemData(\"EFGH\");\n+\n+        OpenJPAPersistence.cast(em).detach(i);\n+        em.getTransaction().rollback();\n+        assertNotSQL(\"UPDATE ITEM SET.*\");\n+        em.close();\n+    }\n+    \n+    public void testDetachAll() {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+\n+        Item i = em.find(Item.class, _id);\n+\n+        i.setItemData(\"IJKL\");\n+\n+        OpenJPAPersistence.cast(em).detachAll(i);\n+        em.getTransaction().rollback();\n+        assertNotSQL(\"UPDATE ITEM SET.*\");\n+        em.close();\n+    }\n+    \n+    public void testDetachAllCollection() {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+\n+        Item i = em.find(Item.class, _id);\n+\n+        i.setItemData(\"MNOP\");\n+\n+        Collection<Item> c = new ArrayList<Item>();\n+        c.add(i);\n+        OpenJPAPersistence.cast(em).detachAll(c);\n+        em.getTransaction().rollback();\n+        assertNotSQL(\"UPDATE ITEM SET.*\");\n+        em.close();\n+    }\n+\n+    public void testSerialize() throws Exception {\n+        EntityManager em = emf.createEntityManager();\n+        em.getTransaction().begin();\n+\n+        Item i = em.find(Item.class, _id);\n+\n+        i.setItemData(\"QRSTU\");\n+\n+        serializeObject(i);\n+\n+        em.getTransaction().rollback();\n+        assertNotSQL(\"UPDATE ITEM SET.*\");\n+        em.close();\n+    }\n+\n+    /**\n+     * Helper to serialize an object to a byte[]\n+     */\n+    private Object serializeObject(Object orig) throws Exception {\n+        Object deserialized = null;\n+\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        ObjectOutputStream oos = new ObjectOutputStream(baos);\n+        oos.writeObject(orig);\n+\n+        ByteArrayInputStream bais =\n+                new ByteArrayInputStream(baos.toByteArray());\n+        ObjectInputStream ois = new ObjectInputStream(bais);\n+\n+        deserialized = ois.readObject();\n+        return deserialized;\n+    }\n+}"},{"sha":"d0dc4bac6ee18a945da7a036a519bfc446ae2c0b","filename":"openjpa-project/src/doc/manual/ref_guide_remote.xml","status":"modified","additions":30,"deletions":8,"changes":38,"blob_url":"https://github.com/apache/openjpa/blob/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-project/src/doc/manual/ref_guide_remote.xml","raw_url":"https://github.com/apache/openjpa/raw/51950e7d49b96805b763510ab4e4d97c92817ea7/openjpa-project/src/doc/manual/ref_guide_remote.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-project/src/doc/manual/ref_guide_remote.xml?ref=51950e7d49b96805b763510ab4e4d97c92817ea7","patch":"@@ -124,21 +124,43 @@ been rolled back, then the re-attachment process will throw an optimistic\n concurrency exception.\n             </para>\n             <para>\n-You can stop OpenJPA from assuming the transaction will commit by invoking\n-<methodname>EntityTransaction.setRollbackOnly</methodname> prior to detaching\n-your objects. Setting the <literal>RollbackOnly</literal> flag prevents OpenJPA\n-from flushing when detaching dirty objects; instead OpenJPA just runs its\n-pre-flush actions (see the <methodname>OpenJPAEntityManager.preFlush\n-</methodname>\n+You can stop OpenJPA from assuming the transaction will commit in the following\n+ways :\n+    <itemizedlist>\n+        <listitem>\n+            <para>\n+                Invoke <methodname>EntityTransaction.setRollbackOnly\n+                </methodname> prior to detachingyour objects. Setting the \n+                <literal>RollbackOnly</literal> flag prevents OpenJPA from \n+                flushing when detaching dirty objects; instead OpenJPA just \n+                runs its pre-flush actions (see the \n+                <methodname>OpenJPAEntityManager.preFlush</methodname>\n <ulink url=\"../javadoc/org/apache/openjpa/persistence/OpenJPAEntityManager.html\">\n Javadoc</ulink> for details).\n             </para>\n             <para>\n This allows you to use the same instances in multiple\n-attach/modify/detach/rollback cycles. Alternatively, you might also prevent a\n-flush by making your modifications outside of a transaction (with <literal>\n+attach/modify/detach/rollback cycles. \n+            </para>\n+        </listitem>\n+        <listitem>\n+            <para>\n+                Make your modifications outside of a transaction (with <literal>\n NontransactionalWrite</literal> enabled) before detaching.\n             </para>\n+        </listitem>\n+        <listitem>\n+            <para>\n+            Set <literal>flushBeforeDetach</literal> \n+            to false (see <methodname>Compatibility.setFlushBeforeDetach\n+            </methodname>\n+            <ulink url=\"../javadoc/org/apache/openjpa/conf/Compatibility.html\">\n+Javadoc</ulink> ). This option is similar to the first option, but does not\n+            affect the current transaction.\n+            </para>\n+        </listitem>\n+    </itemizedlist>\n+    </para>\n         </section>\n         <section id=\"ref_guide_attach_behavior\">\n             <title>"}]}

