{"sha":"57f9f3af1da42be60f8d73594d4d1300909a83d9","node_id":"MDY6Q29tbWl0MjA2MzY0OjU3ZjlmM2FmMWRhNDJiZTYwZjhkNzM1OTRkNGQxMzAwOTA5YTgzZDk=","commit":{"author":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2007-04-02T21:14:48Z"},"committer":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2007-04-02T21:14:48Z"},"message":"OpenJPA-185 allow optional to be overriden by xml descriptor.\n\ngit-svn-id: https://svn.apache.org/repos/asf/incubator/openjpa/trunk@524921 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"2594b8fa05e828f5bd06d749b528dfd595cc9bba","url":"https://api.github.com/repos/apache/openjpa/git/trees/2594b8fa05e828f5bd06d749b528dfd595cc9bba"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/57f9f3af1da42be60f8d73594d4d1300909a83d9","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/57f9f3af1da42be60f8d73594d4d1300909a83d9","html_url":"https://github.com/apache/openjpa/commit/57f9f3af1da42be60f8d73594d4d1300909a83d9","comments_url":"https://api.github.com/repos/apache/openjpa/commits/57f9f3af1da42be60f8d73594d4d1300909a83d9/comments","author":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"committer":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"parents":[{"sha":"8167400e51e6148aed5f4bef1c9fb737b659abd3","url":"https://api.github.com/repos/apache/openjpa/commits/8167400e51e6148aed5f4bef1c9fb737b659abd3","html_url":"https://github.com/apache/openjpa/commit/8167400e51e6148aed5f4bef1c9fb737b659abd3"}],"stats":{"total":109,"additions":108,"deletions":1},"files":[{"sha":"e2088c8f894ef883df2764240cc4a53de0704b42","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/TestXmlOverrideEntity.java","status":"added","additions":49,"deletions":0,"changes":49,"blob_url":"https://github.com/apache/openjpa/blob/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/TestXmlOverrideEntity.java","raw_url":"https://github.com/apache/openjpa/raw/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/TestXmlOverrideEntity.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/TestXmlOverrideEntity.java?ref=57f9f3af1da42be60f8d73594d4d1300909a83d9","patch":"@@ -0,0 +1,49 @@\n+package org.apache.openjpa.persistence.xml;\n+\n+import javax.persistence.EntityManager;\n+\n+import org.apache.openjpa.persistence.InvalidStateException;\n+import org.apache.openjpa.persistence.test.SingleEMFTestCase;\n+\n+public class TestXmlOverrideEntity extends SingleEMFTestCase {\n+\n+    public void setUp() {\n+        setUp(XmlOverrideEntity.class);\n+    }\n+\n+    /**\n+     * Tests that the optional attribute on a basic field can be overrided by\n+     * an xml descriptor. \n+     * \n+     * XmlOverrideEntity.name is annotated with optional=false\n+     * XmlOverrideEntity.description is annotated with optional=true. \n+     * \n+     * The optional attributes are reversed in orm.xml. \n+     */\n+    public void testOptionalAttributeOverride() {\n+        EntityManager em = emf.createEntityManager();\n+\n+        XmlOverrideEntity optional = new XmlOverrideEntity();\n+\n+        optional.setName(null);\n+        optional.setDescription(\"description\");\n+\n+        em.getTransaction().begin();\n+        em.persist(optional);\n+        em.getTransaction().commit();\n+\n+        try {\n+            em.getTransaction().begin();\n+            optional.setDescription(null);\n+            em.getTransaction().commit();\n+            fail(\"XmlOrverrideEntity.description should not be optional. \"\n+                    + \"Expecting an InvalidStateException.\");\n+        } catch (InvalidStateException e) {\n+        }\n+\n+        em.getTransaction().begin();\n+        em.remove(em.find(XmlOverrideEntity.class, optional.getId()));\n+        em.getTransaction().commit();\n+    }\n+}\n+"},{"sha":"0d5f96e2f238ddbf90334f16ce4666c3e92b5933","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/XmlOverrideEntity.java","status":"added","additions":45,"deletions":0,"changes":45,"blob_url":"https://github.com/apache/openjpa/blob/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/XmlOverrideEntity.java","raw_url":"https://github.com/apache/openjpa/raw/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/XmlOverrideEntity.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/xml/XmlOverrideEntity.java?ref=57f9f3af1da42be60f8d73594d4d1300909a83d9","patch":"@@ -0,0 +1,45 @@\n+package org.apache.openjpa.persistence.xml;\n+\n+import javax.persistence.Basic;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+\n+@Entity\n+public class XmlOverrideEntity {\n+\n+    @Id\n+    @GeneratedValue\n+    int id;\n+    \n+    @Basic(optional=false)\n+    String name;\n+    \n+    @Basic(optional=true)\n+    String description;\n+\n+    public int getId() {\n+        return id;\n+    }\n+\n+    public void setId(int id) {\n+        this.id = id;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public void setName(String name) {\n+        this.name = name;\n+    }\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public void setDescription(String description) {\n+        this.description = description;\n+    } \n+}\n+"},{"sha":"aeca9a6f649225d2ee1ff667e991bd5c9751a373","filename":"openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/xml/orm.xml","status":"modified","additions":8,"deletions":1,"changes":9,"blob_url":"https://github.com/apache/openjpa/blob/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/xml/orm.xml","raw_url":"https://github.com/apache/openjpa/raw/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/xml/orm.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/xml/orm.xml?ref=57f9f3af1da42be60f8d73594d4d1300909a83d9","patch":"@@ -20,4 +20,11 @@\n             <version name=\"version\"/>\n         </attributes>\n     </entity>\n-</entity-mappings>\n\\ No newline at end of file\n+    <entity name=\"XmlOverride\" class=\"XmlOverrideEntity\">\n+    \t<attributes>\n+\t    <basic name=\"name\" optional=\"true\"></basic>\n+\t    <basic name=\"description\" optional=\"false\"></basic>\n+    \t</attributes>\n+    </entity>\n+</entity-mappings>\n+"},{"sha":"03a975cdb209e136ec0f0eed14a855863db3c099","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","raw_url":"https://github.com/apache/openjpa/raw/57f9f3af1da42be60f8d73594d4d1300909a83d9/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java?ref=57f9f3af1da42be60f8d73594d4d1300909a83d9","patch":"@@ -1196,6 +1196,12 @@ private boolean startStrategy(PersistenceStrategy strategy,\n         val = attrs.getValue(\"optional\");\n         if (\"false\".equals(val))\n             fmd.setNullValue(FieldMetaData.NULL_EXCEPTION);\n+        else if (\"true\".equals(val)\n+                && fmd.getNullValue() == FieldMetaData.NULL_EXCEPTION) {\n+            // Reset value if the field was annotated with optional=false. \n+            // Otherwise leave it alone.\n+            fmd.setNullValue(FieldMetaData.NULL_UNSET);\n+        }\n         if (isMappingOverrideMode()) {\n             val = attrs.getValue(\"mapped-by\");\n             if (val != null)"}]}

