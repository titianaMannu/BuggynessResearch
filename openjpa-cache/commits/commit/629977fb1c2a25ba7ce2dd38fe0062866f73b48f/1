{"sha":"629977fb1c2a25ba7ce2dd38fe0062866f73b48f","node_id":"MDY6Q29tbWl0MjA2MzY0OjYyOTk3N2ZiMWMyYTI1YmE3Y2UyZGQzOGZlMDA2Mjg2NmY3M2I0OGY=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-06-11T23:55:46Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-06-11T23:55:46Z"},"message":"OPENJPA-597. Merge from ../branches/1.1.x. svn merge -c 655600 ../branches/1.1.x\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@666915 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"70f0299e3aa4997f56e0848ab6ef71882a91396a","url":"https://api.github.com/repos/apache/openjpa/git/trees/70f0299e3aa4997f56e0848ab6ef71882a91396a"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/629977fb1c2a25ba7ce2dd38fe0062866f73b48f","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/629977fb1c2a25ba7ce2dd38fe0062866f73b48f","html_url":"https://github.com/apache/openjpa/commit/629977fb1c2a25ba7ce2dd38fe0062866f73b48f","comments_url":"https://api.github.com/repos/apache/openjpa/commits/629977fb1c2a25ba7ce2dd38fe0062866f73b48f/comments","author":null,"committer":null,"parents":[{"sha":"1a45d110a24eb8b2d8f1189100bff289201b3b12","url":"https://api.github.com/repos/apache/openjpa/commits/1a45d110a24eb8b2d8f1189100bff289201b3b12","html_url":"https://github.com/apache/openjpa/commit/1a45d110a24eb8b2d8f1189100bff289201b3b12"}],"stats":{"total":40,"additions":38,"deletions":2},"files":[{"sha":"ffd766a1331e67c0cb6372ce0db33ec6cc14b392","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","status":"modified","additions":37,"deletions":2,"changes":39,"blob_url":"https://github.com/apache/openjpa/blob/629977fb1c2a25ba7ce2dd38fe0062866f73b48f/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/629977fb1c2a25ba7ce2dd38fe0062866f73b48f/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java?ref=629977fb1c2a25ba7ce2dd38fe0062866f73b48f","patch":"@@ -232,6 +232,7 @@\n     public boolean supportsSelectEndIndex = false;\n     public int rangePosition = RANGE_POST_SELECT;\n     public boolean requiresAliasForSubselect = false;\n+    public boolean requiresTargetForDelete = false;\n     public boolean allowsAliasInBulkClause = true;\n     public boolean supportsMultipleNontransactionalResultSets = true;\n     public String searchStringEscape = \"\\\\\";\n@@ -1896,8 +1897,16 @@ public SQLBuffer toUpdate(ClassMapping mapping, Select sel,\n     protected SQLBuffer toBulkOperation(ClassMapping mapping, Select sel,\n         JDBCStore store, Object[] params, Map updateParams) {\n         SQLBuffer sql = new SQLBuffer(this);\n-        if (updateParams == null)\n+        if (updateParams == null) {\n+          if (requiresTargetForDelete) {\n+            sql.append(\"DELETE \");\n+            SQLBuffer deleteTargets = getDeleteTargets(sel);\n+            sql.append(deleteTargets);\n+            sql.append(\" FROM \");\n+          } else {\n             sql.append(\"DELETE FROM \");\n+          }\n+        }\n         else\n             sql.append(\"UPDATE \");\n         sel.addJoinClassConditions();\n@@ -1993,6 +2002,28 @@ protected SQLBuffer toBulkOperation(ClassMapping mapping, Select sel,\n         return sql;\n     }\n \n+    protected SQLBuffer getDeleteTargets(Select sel) {\n+      SQLBuffer deleteTargets = new SQLBuffer(this);\n+      Collection aliases = sel.getTableAliases();\n+      // Assumes aliases are of the form \"TABLENAME t0\"\n+      for (Iterator itr = aliases.iterator(); itr.hasNext();) {\n+        String tableAlias = itr.next().toString();\n+        int spaceIndex = tableAlias.indexOf(' ');\n+        if (spaceIndex > 0 && spaceIndex < tableAlias.length() - 1) {\n+          if (allowsAliasInBulkClause) {\n+            deleteTargets.append(tableAlias.substring(spaceIndex + 1));\n+          } else {\n+            deleteTargets.append(tableAlias.substring(0, spaceIndex));\n+          }\n+        } else {\n+          deleteTargets.append(tableAlias);\n+        }\n+        if (itr.hasNext())\n+          deleteTargets.append(\", \");\n+      }      \n+      return deleteTargets;      \n+    }\n+\n     protected void appendUpdates(Select sel, JDBCStore store, SQLBuffer sql,\n         Object[] params, Map updateParams, boolean allowAlias) {\n         if (updateParams == null || updateParams.size() == 0)\n@@ -2020,7 +2051,11 @@ protected void appendUpdates(Select sel, JDBCStore store, SQLBuffer sql,\n             Val val = (Val) next.getValue();\n \n             Column col = fmd.getColumns()[0];\n-            sql.append(col.getName());\n+            if (allowAlias) {\n+              sql.append(sel.getColumnAlias(col));\n+            } else {\n+              sql.append(col.getName());  \n+            }            \n             sql.append(\" = \");\n \n             ExpState state = val.initialize(sel, ctx, 0);"},{"sha":"d3e98abb404827ddd18aa74ba177195e3aee6d20","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/629977fb1c2a25ba7ce2dd38fe0062866f73b48f/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/629977fb1c2a25ba7ce2dd38fe0062866f73b48f/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MySQLDictionary.java?ref=629977fb1c2a25ba7ce2dd38fe0062866f73b48f","patch":"@@ -73,6 +73,7 @@ public MySQLDictionary() {\n         constraintNameMode = CONS_NAME_MID;\n         supportsMultipleNontransactionalResultSets = false;\n         requiresAliasForSubselect = true; // new versions\n+        requiresTargetForDelete = true;\n         supportsSelectStartIndex = true;\n         supportsSelectEndIndex = true;\n "}]}

