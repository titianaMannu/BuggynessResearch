{"sha":"6f6e94df7614a48410abe9366e375abbce7bf312","node_id":"MDY6Q29tbWl0MjA2MzY0OjZmNmU5NGRmNzYxNGE0ODQxMGFiZTkzNjZlMzc1YWJiY2U3YmYzMTI=","commit":{"author":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-04-01T13:44:38Z"},"committer":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-04-01T13:44:38Z"},"message":"OPENJPA-1604: Add lock mode to QueryMetaData\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@929971 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"2dbeeb0525165ab2bf8a4b81f75fd038d155dc43","url":"https://api.github.com/repos/apache/openjpa/git/trees/2dbeeb0525165ab2bf8a4b81f75fd038d155dc43"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/6f6e94df7614a48410abe9366e375abbce7bf312","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/6f6e94df7614a48410abe9366e375abbce7bf312","html_url":"https://github.com/apache/openjpa/commit/6f6e94df7614a48410abe9366e375abbce7bf312","comments_url":"https://api.github.com/repos/apache/openjpa/commits/6f6e94df7614a48410abe9366e375abbce7bf312/comments","author":null,"committer":null,"parents":[{"sha":"709bf862abc3207f3b13be381acebd297abb42a2","url":"https://api.github.com/repos/apache/openjpa/commits/709bf862abc3207f3b13be381acebd297abb42a2","html_url":"https://github.com/apache/openjpa/commit/709bf862abc3207f3b13be381acebd297abb42a2"}],"stats":{"total":23,"additions":17,"deletions":6},"files":[{"sha":"7aba5fd3e2881e907be05e2bb29ea387187520e2","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/meta/QueryMetaData.java","status":"modified","additions":11,"deletions":1,"changes":12,"blob_url":"https://github.com/apache/openjpa/blob/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-kernel/src/main/java/org/apache/openjpa/meta/QueryMetaData.java","raw_url":"https://github.com/apache/openjpa/raw/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-kernel/src/main/java/org/apache/openjpa/meta/QueryMetaData.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/meta/QueryMetaData.java?ref=6f6e94df7614a48410abe9366e375abbce7bf312","patch":"@@ -58,7 +58,8 @@\n     private String _resultSetMappingName;\n     private int _lineNum;  \n     private int _colNum;  \n-\n+    private int _lockMode;\n+    \n     /**\n      * Construct with the given name.\n      */\n@@ -156,6 +157,14 @@ public String getQueryString() {\n     public void setQueryString(String query) {\n         _query = query;\n     }\n+    \n+    public void setLockMode(int mode) {\n+        _lockMode = mode;\n+    }\n+    \n+    public int getLockMode() {\n+        return _lockMode;\n+    }\n \n     /**\n      * Query hints.\n@@ -209,6 +218,7 @@ public void setInto(Query query) {\n             query.setReadOnly(_readOnly.booleanValue());\n         if (_resultSetMappingName != null)\n             query.setResultMapping(null, _resultSetMappingName);\n+        query.getFetchConfiguration().setReadLockLevel(_lockMode);\n     }\n \n     /**"},{"sha":"cb6d687b30e7b0354dc1cf7faf3719cb54dc8311","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/AnnotationPersistenceMetaDataParser.java","status":"modified","additions":3,"deletions":3,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/AnnotationPersistenceMetaDataParser.java","raw_url":"https://github.com/apache/openjpa/raw/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/AnnotationPersistenceMetaDataParser.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/AnnotationPersistenceMetaDataParser.java?ref=6f6e94df7614a48410abe9366e375abbce7bf312","patch":"@@ -94,6 +94,7 @@\n import org.apache.openjpa.event.LifecycleCallbacks;\n import org.apache.openjpa.event.LifecycleEvent;\n import org.apache.openjpa.event.MethodLifecycleCallbacks;\n+import org.apache.openjpa.kernel.LockLevels;\n import org.apache.openjpa.kernel.QueryLanguages;\n import org.apache.openjpa.kernel.jpql.JPQLParser;\n import org.apache.openjpa.lib.conf.Configurations;\n@@ -1775,11 +1776,10 @@ private void parseNamedQueries(AnnotatedElement el, NamedQuery... queries) {\n             meta = getRepository().addQueryMetaData(_cls, query.name());\n             meta.setQueryString(query.query());\n             meta.setLanguage(JPQLParser.LANG_JPQL);\n+            meta.setLockMode(MixedLockLevelsHelper.toLockLevel(query.lockMode()));\n             for (QueryHint hint : query.hints())\n                 meta.addHint(hint.name(), hint.value());\n-            if (query.lockMode() != null) {\n-                meta.addHint(\"openjpa.FetchPlan.ReadLockMode\", query.lockMode());\n-            }\n+            \n             meta.setSource(getSourceFile(), (el instanceof Class) ? el : null,\n                 SourceTracker.SRC_ANNOTATIONS);\n             if (isMetaDataMode())"},{"sha":"957cba62637ce9e49106d7d9b0b52dfba8576aeb","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","raw_url":"https://github.com/apache/openjpa/raw/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java?ref=6f6e94df7614a48410abe9366e375abbce7bf312","patch":"@@ -50,6 +50,7 @@\n import org.apache.openjpa.kernel.DelegatingResultList;\n import org.apache.openjpa.kernel.FetchConfiguration;\n import org.apache.openjpa.kernel.Filters;\n+import org.apache.openjpa.kernel.LockLevels;\n import org.apache.openjpa.kernel.PreparedQuery;\n import org.apache.openjpa.kernel.PreparedQueryCache;\n import org.apache.openjpa.kernel.QueryLanguages;\n@@ -508,7 +509,7 @@ private boolean preExecute(Map params) {\n             return false;\n         }\n         FetchConfiguration fetch = _query.getFetchConfiguration();\n-        if (fetch.getReadLockLevel() != 0)\n+        if (fetch.getReadLockLevel() != LockLevels.LOCK_NONE)\n             return false;\n         Boolean registered = cache.register(_id, _query, fetch);\n         boolean alreadyCached = (registered == null);"},{"sha":"b71e28d6685042ee62926ecb59bcfdfa48590293","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","raw_url":"https://github.com/apache/openjpa/raw/6f6e94df7614a48410abe9366e375abbce7bf312/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/XMLPersistenceMetaDataParser.java?ref=6f6e94df7614a48410abe9366e375abbce7bf312","patch":"@@ -1674,7 +1674,7 @@ protected boolean startNamedQuery(Attributes attrs)\n         meta.setLanguage(JPQLParser.LANG_JPQL);\n         String lockModeStr = attrs.getValue(\"lock-mode\");\n         if (lockModeStr != null) {\n-            meta.addHint(\"openjpa.FetchPlan.ReadLockMode\", LockModeType.valueOf(lockModeStr));\n+            meta.setLockMode(MixedLockLevelsHelper.toLockLevel(LockModeType.valueOf(lockModeStr)));\n         }\n         Locator locator = getLocation().getLocator();\n         if (locator != null) {"}]}

