{"sha":"773eefc3135294aa18d1122483e8a1d1b82f0c53","node_id":"MDY6Q29tbWl0MjA2MzY0Ojc3M2VlZmMzMTM1Mjk0YWExOGQxMTIyNDgzZThhMWQxYjgyZjBjNTM=","commit":{"author":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-03-22T14:25:22Z"},"committer":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-03-22T14:25:22Z"},"message":"OPENJPA-1097 Cleanup imports and add more comments on the before/after behavior of writeReplace().\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@926104 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"4e0ff526f424e9d65df8c936a0e830f220eaa6fa","url":"https://api.github.com/repos/apache/openjpa/git/trees/4e0ff526f424e9d65df8c936a0e830f220eaa6fa"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/773eefc3135294aa18d1122483e8a1d1b82f0c53","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/773eefc3135294aa18d1122483e8a1d1b82f0c53","html_url":"https://github.com/apache/openjpa/commit/773eefc3135294aa18d1122483e8a1d1b82f0c53","comments_url":"https://api.github.com/repos/apache/openjpa/commits/773eefc3135294aa18d1122483e8a1d1b82f0c53/comments","author":null,"committer":null,"parents":[{"sha":"c20a4ef30344f65b02a4b64be39cc303a07b0b5c","url":"https://api.github.com/repos/apache/openjpa/commits/c20a4ef30344f65b02a4b64be39cc303a07b0b5c","html_url":"https://github.com/apache/openjpa/commit/c20a4ef30344f65b02a4b64be39cc303a07b0b5c"}],"stats":{"total":18,"additions":14,"deletions":4},"files":[{"sha":"70f020a9f41a3cd06f8ddfb3dfa0943d6bc76c70","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/util/Proxies.java","status":"modified","additions":14,"deletions":4,"changes":18,"blob_url":"https://github.com/apache/openjpa/blob/773eefc3135294aa18d1122483e8a1d1b82f0c53/openjpa-kernel/src/main/java/org/apache/openjpa/util/Proxies.java","raw_url":"https://github.com/apache/openjpa/raw/773eefc3135294aa18d1122483e8a1d1b82f0c53/openjpa-kernel/src/main/java/org/apache/openjpa/util/Proxies.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/util/Proxies.java?ref=773eefc3135294aa18d1122483e8a1d1b82f0c53","patch":"@@ -20,9 +20,6 @@\n \n import java.security.AccessController;\n \n-import org.apache.openjpa.conf.DetachOptions;\n-import org.apache.openjpa.enhance.PersistenceCapable;\n-import org.apache.openjpa.kernel.DetachedStateManager;\n import org.apache.openjpa.kernel.OpenJPAStateManager;\n import org.apache.openjpa.lib.util.J2DoPrivHelper;\n import org.apache.openjpa.lib.util.Localizer;\n@@ -84,9 +81,22 @@ public static void removed(Proxy proxy, Object removed, boolean key) {\n      * Used by proxy types to serialize non-proxy versions.\n      */\n     public static Object writeReplace(Proxy proxy, boolean detachable) {\n-        /* OPENJPA-1097 Always remove $proxy classes during serialization if detachable\n+        /* OPENJPA-1097 Remove $proxy classes during serialization based on:\n+         *   1) No Proxy, then return as-is\n+         *   2) Runtime created proxy (!detachable), then unproxy\n+         *   3) No StateManager (DetachedStateField==false), then return as-is\n+         *   4) If detached, then unproxy\n+         *   5) If ClassMetaData exists and DetachedStateField != TRUE\n+         *      (default of DetachedStateField==transient), then unproxy\n+         *   6) Else, return as-is\n          * \n          * Original code -\n+         *   1) Runtime created proxy (!detachable), then unproxy\n+         *   2) No Proxy, then return as-is\n+         *   3) No StateManager (DetachedStateField==false), then return as-is\n+         *   4) If detached, then return as-is <--- ERROR as EM.clear() marks\n+         *      entity as detached but doesn't remove any $proxy usage\n+         *   5) Else, unproxy\n          * \n          *  if (detachable && (proxy == null || proxy.getOwner() == null \n          *      || proxy.getOwner().isDetached()))"}]}

