{"sha":"777818d28332d67a9716d91b1dc8ec900d986b2d","node_id":"MDY6Q29tbWl0MjA2MzY0Ojc3NzgxOGQyODMzMmQ2N2E5NzE2ZDkxYjFkYzhlYzkwMGQ5ODZiMmQ=","commit":{"author":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-03-05T00:24:45Z"},"committer":{"name":"Patrick Linskey","email":"pcl@apache.org","date":"2008-03-05T00:24:45Z"},"message":"OPENJPA-520. Committing on behalf of Qin Feng.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@633723 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"0dd0bbd91f3f1d92e68be55263f1a644edd9a2cb","url":"https://api.github.com/repos/apache/openjpa/git/trees/0dd0bbd91f3f1d92e68be55263f1a644edd9a2cb"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/777818d28332d67a9716d91b1dc8ec900d986b2d","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/777818d28332d67a9716d91b1dc8ec900d986b2d","html_url":"https://github.com/apache/openjpa/commit/777818d28332d67a9716d91b1dc8ec900d986b2d","comments_url":"https://api.github.com/repos/apache/openjpa/commits/777818d28332d67a9716d91b1dc8ec900d986b2d/comments","author":null,"committer":null,"parents":[{"sha":"86e17fc21069e755f498ac6cc30c3aa687cc7960","url":"https://api.github.com/repos/apache/openjpa/commits/86e17fc21069e755f498ac6cc30c3aa687cc7960","html_url":"https://github.com/apache/openjpa/commit/86e17fc21069e755f498ac6cc30c3aa687cc7960"}],"stats":{"total":45,"additions":27,"deletions":18},"files":[{"sha":"39ada6c18bcae64908600bd1d911d3c3a924378e","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/event/JMSRemoteCommitProvider.java","status":"modified","additions":27,"deletions":18,"changes":45,"blob_url":"https://github.com/apache/openjpa/blob/777818d28332d67a9716d91b1dc8ec900d986b2d/openjpa-kernel/src/main/java/org/apache/openjpa/event/JMSRemoteCommitProvider.java","raw_url":"https://github.com/apache/openjpa/raw/777818d28332d67a9716d91b1dc8ec900d986b2d/openjpa-kernel/src/main/java/org/apache/openjpa/event/JMSRemoteCommitProvider.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/event/JMSRemoteCommitProvider.java?ref=777818d28332d67a9716d91b1dc8ec900d986b2d","patch":"@@ -64,7 +64,8 @@\n     private TopicConnection _connection;\n     private TopicSession _session;\n     private TopicPublisher _publisher;\n-\n+    private ClassLoader _appClassLoader;\n+    \n     /**\n      * Sets the JMS Topic name. Defaults to\n      * <code>topic/OpenJPACommitProviderTopic</code>.\n@@ -151,6 +152,7 @@ public void close() {\n      */\n     public void endConfiguration() {\n         super.endConfiguration();\n+        _appClassLoader = Thread.currentThread().getContextClassLoader();\n         connect();\n     }\n \n@@ -204,29 +206,36 @@ public void onMessage(Message m) {\n                             _topicName, m.getClass().getName()));\n                     return;\n                 }\n-\n-                ObjectMessage om = (ObjectMessage) m;\n-                Object o;\n+                \n+                ClassLoader saveCls = Thread.currentThread()\n+                    .getContextClassLoader();\n                 try {\n-                    o = om.getObject();\n+                    if (saveCls != _appClassLoader)\n+                        Thread.currentThread().setContextClassLoader(\n+                            _appClassLoader);\n+                    ObjectMessage om = (ObjectMessage) m;\n+                    Object o = om.getObject();\n+\n+                    if (o instanceof RemoteCommitEvent) {\n+                    \tif (log.isTraceEnabled())\n+                    \t\tlog.trace(s_loc.get(\"jms-received-update\",\n+                    \t\t\t\t_topicName));\n+\n+                    \tRemoteCommitEvent rce = (RemoteCommitEvent) o;\n+                    \tfireEvent(rce);\n+                    } else {\n+                    \tif (log.isWarnEnabled())\n+                    \t\tlog.warn(s_loc.get(\"jms-receive-error-2\",\n+                    \t\t\t\to.getClass().getName(), _topicName));\n+                    }\n                 } catch (JMSException jmse) {\n                     if (log.isWarnEnabled())\n                         log.warn(s_loc.get(\"jms-receive-error-1\"), jmse);\n-                    return;\n+                } finally {\n+                    if (saveCls != _appClassLoader)\n+                        Thread.currentThread().setContextClassLoader(saveCls);\n                 }\n \n-                if (o instanceof RemoteCommitEvent) {\n-                    if (log.isTraceEnabled())\n-                        log.trace(s_loc.get(\"jms-received-update\",\n-                            _topicName));\n-\n-                    RemoteCommitEvent rce = (RemoteCommitEvent) o;\n-                    fireEvent(rce);\n-                } else {\n-                    if (log.isWarnEnabled())\n-                        log.warn(s_loc.get(\"jms-receive-error-2\",\n-                            o.getClass().getName(), _topicName));\n-                }\n             }\n         };\n     }"}]}

