{"sha":"784e4560db9ed097c77b23d50eee4731d49510b2","node_id":"MDY6Q29tbWl0MjA2MzY0Ojc4NGU0NTYwZGI5ZWQwOTdjNzdiMjNkNTBlZWU0NzMxZDQ5NTEwYjI=","commit":{"author":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-02-01T18:28:18Z"},"committer":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-02-01T18:28:18Z"},"message":"OPENJPA-960: Block unwrap for Object.class or null argument \n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@905355 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"56500222aa925db3c3c691f978cf9faca1c855b4","url":"https://api.github.com/repos/apache/openjpa/git/trees/56500222aa925db3c3c691f978cf9faca1c855b4"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/784e4560db9ed097c77b23d50eee4731d49510b2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/784e4560db9ed097c77b23d50eee4731d49510b2","html_url":"https://github.com/apache/openjpa/commit/784e4560db9ed097c77b23d50eee4731d49510b2","comments_url":"https://api.github.com/repos/apache/openjpa/commits/784e4560db9ed097c77b23d50eee4731d49510b2/comments","author":null,"committer":null,"parents":[{"sha":"97496b0bd6fe8d7471c3b3495ecab01614b8dfd9","url":"https://api.github.com/repos/apache/openjpa/commits/97496b0bd6fe8d7471c3b3495ecab01614b8dfd9","html_url":"https://github.com/apache/openjpa/commit/97496b0bd6fe8d7471c3b3495ecab01614b8dfd9"}],"stats":{"total":42,"additions":40,"deletions":2},"files":[{"sha":"c5f5fd1ef50eddd0193f6b481582cf554b75daf0","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/TestUnwrap.java","status":"modified","additions":32,"deletions":2,"changes":34,"blob_url":"https://github.com/apache/openjpa/blob/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/TestUnwrap.java","raw_url":"https://github.com/apache/openjpa/raw/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/TestUnwrap.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/TestUnwrap.java?ref=784e4560db9ed097c77b23d50eee4731d49510b2","patch":"@@ -18,7 +18,10 @@\n  */\n package org.apache.openjpa.persistence;\n \n+import java.util.Properties;\n+\n import javax.persistence.EntityManager;\n+import javax.persistence.EntityTransaction;\n import javax.persistence.Query;\n \n import org.apache.openjpa.kernel.QueryLanguages;\n@@ -54,15 +57,42 @@ public void testValidQueryUnwrap() {\n     public void testValidEntityManagerUnwrap() {\n         EntityManager em = emf.createEntityManager();\n         \n-        Class[] validCasts = new Class[] {\n+        Class<?>[] validCasts = new Class[] {\n             org.apache.openjpa.persistence.OpenJPAEntityManager.class,\n             org.apache.openjpa.persistence.OpenJPAEntityManagerSPI.class,\n             org.apache.openjpa.kernel.DelegatingBroker.class,\n             org.apache.openjpa.kernel.Broker.class\n         };\n-        for (Class c : validCasts) {\n+        for (Class<?> c : validCasts) {\n             Object unwrapped = em.unwrap(c);\n             assertTrue(c.isInstance(unwrapped));\n         }\n     }\n+    \n+    /**\n+     * Tests a EntityManager can be unwrapped as an instance of a series of \n+     * class or interface. \n+     */\n+    public void testInvalidEntityManagerUnwrap() {\n+        EntityManager em = emf.createEntityManager();\n+        \n+        Class<?>[] validCasts = new Class[] {\n+            Object.class,\n+            Properties.class,\n+            null,\n+        };\n+        for (Class<?> c : validCasts) {\n+            try {\n+                em.unwrap(c);\n+                fail(\"Expected to fail to unwarp with \" + c);\n+            } catch (PersistenceException e) {\n+                EntityTransaction txn = em.getTransaction();\n+                assertFalse(txn.isActive());\n+            } catch (Exception ex) {\n+                ex.printStackTrace();\n+                fail(\"Unexpected exception while unwrapping \" + c);\n+            }\n+        }\n+    }\n+\n }"},{"sha":"3bd50c1f1d4aa2e540df58254e65ccfb20034285","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","status":"modified","additions":4,"deletions":0,"changes":4,"blob_url":"https://github.com/apache/openjpa/blob/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","raw_url":"https://github.com/apache/openjpa/raw/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java?ref=784e4560db9ed097c77b23d50eee4731d49510b2","patch":"@@ -1605,6 +1605,10 @@ public OpenJPACriteriaBuilder getCriteriaBuilder() {\n     public <T> T unwrap(Class<T> cls) {\n         Object[] delegates = new Object[]{_broker.getInnermostDelegate(),\n             _broker.getDelegate(), _broker, this};\n+        if (cls == null || cls == Object.class) {\n+            throw new PersistenceException(_loc.get(\"unwrap-em-invalid\", cls)\n+                    .toString(), null, this, false);\n+        }\n         for (Object o : delegates) {\n             if (cls.isInstance(o))\n                 return (T)o;"},{"sha":"df2f0289a2d5da60623f1219307936c3c986fb8e","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","status":"modified","additions":4,"deletions":0,"changes":4,"blob_url":"https://github.com/apache/openjpa/blob/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","raw_url":"https://github.com/apache/openjpa/raw/784e4560db9ed097c77b23d50eee4731d49510b2/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/QueryImpl.java?ref=784e4560db9ed097c77b23d50eee4731d49510b2","patch":"@@ -473,6 +473,10 @@ public boolean equals(Object other) {\n     public <T> T unwrap(Class<T> cls) {\n         Object[] delegates = new Object[]{_query.getInnermostDelegate(), \n             _query.getDelegate(), _query, this};\n+        if (cls == null || cls == Object.class) {\n+            throw new PersistenceException(_loc.get(\"unwrap-em-invalid\", cls)\n+                    .toString(), null, this, false);\n+        }\n         for (Object o : delegates) {\n             if (cls.isInstance(o))\n                 return (T)o;"}]}

