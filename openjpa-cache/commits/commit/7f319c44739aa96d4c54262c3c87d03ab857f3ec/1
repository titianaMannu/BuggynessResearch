{"sha":"7f319c44739aa96d4c54262c3c87d03ab857f3ec","node_id":"MDY6Q29tbWl0MjA2MzY0OjdmMzE5YzQ0NzM5YWE5NmQ0YzU0MjYyYzNjODdkMDNhYjg1N2YzZWM=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-02-23T23:46:26Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-02-23T23:46:26Z"},"message":"OPENJPA-1527: fix AssociationOverride on the key of map where the key is an embeddable via orm.xml. \n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@915593 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5ad40430da85dda6f4717a4b46da797428daac92","url":"https://api.github.com/repos/apache/openjpa/git/trees/5ad40430da85dda6f4717a4b46da797428daac92"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/7f319c44739aa96d4c54262c3c87d03ab857f3ec","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/7f319c44739aa96d4c54262c3c87d03ab857f3ec","html_url":"https://github.com/apache/openjpa/commit/7f319c44739aa96d4c54262c3c87d03ab857f3ec","comments_url":"https://api.github.com/repos/apache/openjpa/commits/7f319c44739aa96d4c54262c3c87d03ab857f3ec/comments","author":null,"committer":null,"parents":[{"sha":"11c299d895387ddeb9a89d22f50fed7ced69f2c1","url":"https://api.github.com/repos/apache/openjpa/commits/11c299d895387ddeb9a89d22f50fed7ced69f2c1","html_url":"https://github.com/apache/openjpa/commit/11c299d895387ddeb9a89d22f50fed7ced69f2c1"}],"stats":{"total":125,"additions":125,"deletions":0},"files":[{"sha":"40b0b53e0680d2dafb34dae867404290cefc4fb9","filename":"openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","status":"modified","additions":25,"deletions":0,"changes":25,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -26,6 +26,8 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n+\n import javax.persistence.DiscriminatorType;\n import javax.persistence.EnumType;\n import javax.persistence.InheritanceType;\n@@ -56,11 +58,13 @@\n import org.apache.openjpa.lib.log.Log;\n import org.apache.openjpa.lib.meta.SourceTracker;\n import org.apache.openjpa.lib.util.Localizer;\n+import org.apache.openjpa.meta.AccessCode;\n import org.apache.openjpa.meta.ClassMetaData;\n import org.apache.openjpa.meta.FieldMetaData;\n import org.apache.openjpa.meta.JavaTypes;\n import org.apache.openjpa.persistence.XMLPersistenceMetaDataParser;\n import org.apache.openjpa.util.InternalException;\n+import org.apache.openjpa.util.MetaDataException;\n import org.apache.openjpa.util.UserException;\n import org.xml.sax.Attributes;\n import org.xml.sax.Locator;\n@@ -1390,6 +1394,27 @@ private DeferredEmbeddableOverrides findDeferredMapping(Class<?> cls,\n         }\n         return null;\n     }\n+\n+    /**\n+     * Process all deferred embeddables using an unknown access type.\n+     */\n+    protected void addDeferredEmbeddableMetaData() {\n+        super.addDeferredEmbeddableMetaData();\n+        if (_deferredMappings.size() > 0) {\n+            Set<Class<?>> keys = _deferredMappings.keySet();\n+            Class[] classes = keys.toArray(new Class[0]);\n+            for (int i = 0; i < classes.length; i++) {\n+                try {\n+                    applyDeferredEmbeddableOverrides(classes[i]);\n+                } catch (Exception e) {\n+                    throw new MetaDataException(\n+                            _loc.get(\"no-embeddable-metadata\",\n+                                classes[i].getName()), e);\n+                }\n+            }\n+        }\n+        \n+    }    \n     \n     // Inner class for storing override information\n     class DeferredEmbeddableOverrides {"},{"sha":"5af6e9dfa072b89a827a1fb095f11f90f3552def","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/TestAssocOverridesXML.java","status":"modified","additions":3,"deletions":0,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/TestAssocOverridesXML.java","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/TestAssocOverridesXML.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/TestAssocOverridesXML.java?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -82,6 +82,9 @@ public void testElementCollectionAssocOverrides() {\n             assertSQLFragnments(_sql, \"CREATE TABLE XML_EMBALIST .*\" +\n                 \" .*emba_entb.*emba_mentb\");\n         \n+            assertSQLFragnments(_sql, \"CREATE TABLE XML_EMBAMAP_1 .*\" +\n+                \" .*key_emba_entb.*key_emba_mentb\" + \n+                \" .*value_emba_entb.*value_emba_mentb\");\n         } \n         finally {\n             try {"},{"sha":"f08ae2cf3df0b5c0711a9f4b36de7204f238f2bf","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEmbedB.java","status":"added","additions":52,"deletions":0,"changes":52,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEmbedB.java","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEmbedB.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEmbedB.java?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.openjpa.persistence.embed.attrOverrides;\n+\n+public class XMLAssocOverEmbedB {\n+    \n+    private String name;\n+    \n+    private XMLAssocOverEntityB eb;\n+\n+    private XMLAssocOverEntityB meb;\n+    \n+    public void setName(String name) {\n+        this.name = name;\n+    }\n+\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public void setEb(XMLAssocOverEntityB eb) {\n+        this.eb = eb;\n+    }\n+\n+    public XMLAssocOverEntityB getEb() {\n+        return eb;\n+    }\n+\n+    public void setMeb(XMLAssocOverEntityB meb) {\n+        this.meb = meb;\n+    }\n+\n+    public XMLAssocOverEntityB getMeb() {\n+        return meb;\n+    }\n+}"},{"sha":"bfbed7d7a76876cc55e4a6b59ffe9a227b787af3","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEntityA.java","status":"modified","additions":12,"deletions":0,"changes":12,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEntityA.java","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEntityA.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/attrOverrides/XMLAssocOverEntityA.java?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -19,12 +19,16 @@\n package org.apache.openjpa.persistence.embed.attrOverrides;\n \n import java.util.List;\n+import java.util.Map;\n \n public class XMLAssocOverEntityA {\n \n     private int id;\n     \n     private List<XMLAssocOverEmbed> embaList;\n+    \n+    private Map<XMLAssocOverEmbedB, XMLAssocOverEmbed> embaMap;\n+    \n \n     public void setEmbA(List<XMLAssocOverEmbed> embA) {\n         this.embaList = embA;\n@@ -34,6 +38,14 @@ public void setEmbA(List<XMLAssocOverEmbed> embA) {\n         return embaList;\n     }\n \n+    public void setEmbAMap(Map<XMLAssocOverEmbedB, XMLAssocOverEmbed> embAMap) {\n+        this.embaMap = embAMap;\n+    }\n+\n+    public Map<XMLAssocOverEmbedB, XMLAssocOverEmbed> getEmbAMap() {\n+        return embaMap;\n+    }\n+\n     public void setId(int id) {\n         this.id = id;\n     }"},{"sha":"87e3d4998d76ae0a22f554bd5ce47a3367010938","filename":"openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-assoc-over-orm.xml","status":"modified","additions":32,"deletions":0,"changes":32,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-assoc-over-orm.xml","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-assoc-over-orm.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-assoc-over-orm.xml?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -37,6 +37,21 @@\n                 </association-override>\n                 <collection-table name=\"XML_EMBALIST\"/>\n             </element-collection>\n+            <element-collection name=\"embaMap\">\n+                <association-override name=\"key.eb\">\n+                    <join-column name=\"key_emba_entb\" />\n+                </association-override>\n+                <association-override name=\"key.meb\">\n+                    <join-column name=\"key_emba_mentb\" />\n+                </association-override>\n+                <association-override name=\"value.eb\">\n+                    <join-column name=\"value_emba_entb\" />\n+                </association-override>\n+                <association-override name=\"value.meb\">\n+                    <join-column name=\"value_emba_mentb\" />\n+                </association-override>\n+                <collection-table name=\"XML_EMBAMAP_3\"/>\n+            </element-collection>\n         </attributes>\n     </entity>\n     \n@@ -69,4 +84,21 @@\n             </one-to-one>\n         </attributes>\n     </embeddable>    \n+    \n+    <embeddable class=\"org.apache.openjpa.persistence.embed.attrOverrides.XMLAssocOverEmbedB\">\n+        <attributes>\n+            <basic name=\"name\"/>\n+            <many-to-one name=\"meb\">\n+                <cascade>\n+                    <cascade-all />\n+                </cascade>\n+            </many-to-one>\n+            <one-to-one name=\"eb\">\n+                <cascade>\n+                    <cascade-all />\n+                </cascade>\n+            </one-to-one>\n+        </attributes>\n+    </embeddable>    \n+    \n </entity-mappings>\n\\ No newline at end of file"},{"sha":"914eb423493a7fea1fa9495bb909a509d76d29c5","filename":"openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-persistence.xml","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-persistence.xml","raw_url":"https://github.com/apache/openjpa/raw/7f319c44739aa96d4c54262c3c87d03ab857f3ec/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-persistence.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-persistence.xml?ref=7f319c44739aa96d4c54262c3c87d03ab857f3ec","patch":"@@ -23,6 +23,7 @@\n     <persistence-unit name=\"AssocOverPU\">\n         <mapping-file>org/apache/openjpa/persistence/embed/embed-assoc-over-orm.xml</mapping-file>\n         <class>org.apache.openjpa.persistence.embed.attrOverrides.XMLAssocOverEmbed</class>\n+        <class>org.apache.openjpa.persistence.embed.attrOverrides.XMLAssocOverEmbedB</class>\n         <class>org.apache.openjpa.persistence.embed.attrOverrides.XMLAssocOverEntityA</class>\n         <class>org.apache.openjpa.persistence.embed.attrOverrides.XMLAssocOverEntityB</class>\n             <properties>"}]}

