{"sha":"83a41e6f714aa26b749ae0282b44bd72e4482d04","node_id":"MDY6Q29tbWl0MjA2MzY0OjgzYTQxZTZmNzE0YWEyNmI3NDlhZTAyODJiNDRiZDcyZTQ0ODJkMDQ=","commit":{"author":{"name":"Kevin W. Sutter","email":"kwsutter@apache.org","date":"2008-08-14T22:36:22Z"},"committer":{"name":"Kevin W. Sutter","email":"kwsutter@apache.org","date":"2008-08-14T22:36:22Z"},"message":"OPENJPA-646.  Integrating the original patch which bypasses the enum types in our TemporaryClassLoader.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.2.x@686069 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"43e0185e130db6b0c97be937371ab500056b6a62","url":"https://api.github.com/repos/apache/openjpa/git/trees/43e0185e130db6b0c97be937371ab500056b6a62"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/83a41e6f714aa26b749ae0282b44bd72e4482d04","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/83a41e6f714aa26b749ae0282b44bd72e4482d04","html_url":"https://github.com/apache/openjpa/commit/83a41e6f714aa26b749ae0282b44bd72e4482d04","comments_url":"https://api.github.com/repos/apache/openjpa/commits/83a41e6f714aa26b749ae0282b44bd72e4482d04/comments","author":null,"committer":null,"parents":[{"sha":"9bd5b8d39614b6fe14d4dd35730b8618207174f5","url":"https://api.github.com/repos/apache/openjpa/commits/9bd5b8d39614b6fe14d4dd35730b8618207174f5","html_url":"https://github.com/apache/openjpa/commit/9bd5b8d39614b6fe14d4dd35730b8618207174f5"}],"stats":{"total":17,"additions":16,"deletions":1},"files":[{"sha":"b8cefc0befad8b0d74b911ba1bd8ec9a67d4267a","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","status":"modified","additions":16,"deletions":1,"changes":17,"blob_url":"https://github.com/apache/openjpa/blob/83a41e6f714aa26b749ae0282b44bd72e4482d04/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","raw_url":"https://github.com/apache/openjpa/raw/83a41e6f714aa26b749ae0282b44bd72e4482d04/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/TemporaryClassLoader.java?ref=83a41e6f714aa26b749ae0282b44bd72e4482d04","patch":"@@ -70,7 +70,10 @@ protected Class loadClass(String name, boolean resolve)\n                 bout.write(b, 0, n))\n                 ;\n             byte[] classBytes = bout.toByteArray();\n-            if (isAnnotation(classBytes))\n+            // To avoid classloader issues with the JVM (Sun and IBM), we\n+            // will not load Enums via the TemporaryClassLoader either.\n+            // Reference JIRA Issue OPENJPA-646 for more information.\n+            if (isAnnotation(classBytes) || isEnum(classBytes))\n                 return Class.forName(name, resolve, getClass().\n                     getClassLoader());\n \n@@ -97,4 +100,16 @@ private static boolean isAnnotation(byte[] b) {\n         int access = ConstantPoolTable.readUnsignedShort(b, idx);\n         return (access & 0x2000) != 0; // access constant for annotation type\n     }\n+\n+    /**\n+     * Fast-parse the given class bytecode to determine if it is an\n+     * enum class.\n+     */\n+    private static boolean isEnum(byte[] b) {\n+        if (JavaVersions.VERSION < 5)\n+            return false;\n+        int idx = ConstantPoolTable.getEndIndex(b);\n+        int access = ConstantPoolTable.readUnsignedShort(b, idx);\n+        return (access & 0x4000) != 0; // access constant for enum type\n+    }\n }"}]}

