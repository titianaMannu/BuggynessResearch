{"sha":"93417f99e370124cf2e4dfc5a8988b14ae061eaf","node_id":"MDY6Q29tbWl0MjA2MzY0OjkzNDE3Zjk5ZTM3MDEyNGNmMmU0ZGZjNWE4OTg4YjE0YWUwNjFlYWY=","commit":{"author":{"name":"Catalina Wei","email":"fancy@apache.org","date":"2008-05-29T03:51:34Z"},"committer":{"name":"Catalina Wei","email":"fancy@apache.org","date":"2008-05-29T03:51:34Z"},"message":"OPENJPA-617 Removed hardcoding platform string.\nalso relocated 2 jdbc trace messages.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@661200 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5b86bae2d763743cbabdda41f039f8b4af7e1ce8","url":"https://api.github.com/repos/apache/openjpa/git/trees/5b86bae2d763743cbabdda41f039f8b4af7e1ce8"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/93417f99e370124cf2e4dfc5a8988b14ae061eaf","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/93417f99e370124cf2e4dfc5a8988b14ae061eaf","html_url":"https://github.com/apache/openjpa/commit/93417f99e370124cf2e4dfc5a8988b14ae061eaf","comments_url":"https://api.github.com/repos/apache/openjpa/commits/93417f99e370124cf2e4dfc5a8988b14ae061eaf/comments","author":null,"committer":null,"parents":[{"sha":"faa0f26cddae6869271257634c6b5b74689fc345","url":"https://api.github.com/repos/apache/openjpa/commits/faa0f26cddae6869271257634c6b5b74689fc345","html_url":"https://github.com/apache/openjpa/commit/faa0f26cddae6869271257634c6b5b74689fc345"}],"stats":{"total":63,"additions":45,"deletions":18},"files":[{"sha":"adf87cdbd794e2f40838b9b0a2af701b86d6c543","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/BatchingPreparedStatementManagerImpl.java","status":"modified","additions":2,"deletions":8,"changes":10,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/BatchingPreparedStatementManagerImpl.java","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/BatchingPreparedStatementManagerImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/BatchingPreparedStatementManagerImpl.java?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -238,13 +238,7 @@ private void checkUpdateCount(int[] count, int batchedRowsBaseIndex,\n         // DB2/ZOS        1 / 0           1 / 0        -2 / SQLException\n         // Oracle        -2 / -2         -2 / -2       -2 / SQLException\n         int cnt = 0;\n-        int updateSuccessCnt = 0;\n-        if (ps != null && _dict.platform.indexOf(\"Oracle\") > -1)\n-            updateSuccessCnt = ps.getUpdateCount();\n-        if (_log.isTraceEnabled() &&\n-            _dict.platform.indexOf(\"Oracle\") > -1)\n-            _log.trace(_loc.get(\"batch_update_success_count\",\n-                    updateSuccessCnt));\n+        int updateSuccessCnt = _dict.getBatchUpdateCount(ps);\n         Object failed = null;\n         List batchedRows = getBatchedRows();\n         for (int i = 0; i < count.length; i++) {\n@@ -262,7 +256,7 @@ else if (row.getAction() == Row.ACTION_INSERT)\n                         row.getSQL(_dict)).getMessage());\n                 break;\n             case Statement.SUCCESS_NO_INFO: // -2\n-                if (_dict.platform.indexOf(\"Oracle\") > -1 &&\n+                if (_dict.reportsSuccessNoInfoOnBatchUpdates &&                    \n                     updateSuccessCnt != count.length) {\n                     // Oracle batching specifics:\n                     // treat update/delete of SUCCESS_NO_INFO as failed case"},{"sha":"d8e2b664e5020901fba490eadb6be75a6493aa9b","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","status":"modified","additions":0,"deletions":4,"changes":4,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/schema/DataSourceFactory.java?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -235,10 +235,6 @@ public static DecoratingDataSource installDBDictionary(DBDictionary dict,\n                 conn = ds.getConnection(conf.getConnection2UserName(), conf\n                         .getConnection2Password());\n \n-            if (log.isTraceEnabled())\n-                log.trace(_loc.get(\"connection-defaults\", new Object[]{\n-                    conn.getAutoCommit(), conn.getHoldability(),\n-                    conn.getTransactionIsolation()})); \n             return ds;\n         } catch (Exception e) {\n             throw new StoreException(e).setFatal(true);"},{"sha":"a5e09e94a3a73c22cd45568f2b44056333c1625d","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","status":"modified","additions":27,"deletions":2,"changes":29,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -236,6 +236,7 @@\n     public boolean requiresCastForComparisons = false;\n     public boolean supportsModOperator = false;\n     public boolean supportsXMLColumn = false;\n+    public boolean reportsSuccessNoInfoOnBatchUpdates = false;\n \n     // functions\n     public String castFunction = \"CAST({0} AS {1})\";\n@@ -373,10 +374,25 @@ public DBDictionary() {\n     public void connectedConfiguration(Connection conn)\n         throws SQLException {\n         if (!connected) {\n+            DatabaseMetaData metaData = null;            \n             try {\n-                if (log.isTraceEnabled())\n+                if (log.isTraceEnabled()) {\n+                    metaData = conn.getMetaData();\n+                    boolean isJDBC3 = false;\n                     log.trace(DBDictionaryFactory.toString\n-                        (conn.getMetaData()));\n+                        (metaData));\n+                    try {\n+                        // JDBC3-only method, so it might throw a \n+                        // AbstractMethodError\n+                        isJDBC3 = metaData.getJDBCMajorVersion() >= 3;\n+                    } catch (Throwable t) {\n+                        // ignore if not JDBC3\n+                    }\n+                    if (isJDBC3)\n+                        log.trace(_loc.get(\"connection-defaults\", new Object[]{\n+                            conn.getAutoCommit(), conn.getHoldability(),\n+                            conn.getTransactionIsolation()}));\n+                }\n             } catch (Exception e) {\n                 log.trace(e.toString(), e);\n             }\n@@ -4411,4 +4427,13 @@ public boolean isSelect(String sql) {\n     public boolean needsToCreateIndex(Index idx, Table table) {\n         return true;\n     }\n+\n+    /**\n+     * Return batched statements update succes count\n+     * @param ps A PreparedStatement\n+     * @return return update count\n+     */\n+    public int getBatchUpdateCount(PreparedStatement ps) throws SQLException {\n+        return 0;\n+    }\n }"},{"sha":"4f727c72e58949cc01d0566892629d6344d147c2","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/OracleDictionary.java","status":"modified","additions":12,"deletions":0,"changes":12,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/OracleDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/OracleDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/OracleDictionary.java?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -165,6 +165,7 @@ public OracleDictionary() {\n         substringFunctionName = \"SUBSTR\";\n         super.setBatchLimit(defaultBatchLimit);\n         selectWordSet.add(\"WITH\");\n+        reportsSuccessNoInfoOnBatchUpdates = true;\n     }\n \n     public void endConfiguration() {\n@@ -1104,4 +1105,15 @@ public void insertClobForStreamingLoad(Row row, Column col)\n         throws SQLException {\n         row.setNull(col);\n     }\n+\n+    public int getBatchUpdateCount(PreparedStatement ps) throws SQLException {\n+        int updateSuccessCnt = 0;\n+        if (batchLimit > 0 && ps != null) {\n+            updateSuccessCnt = ps.getUpdateCount();\n+            if (log.isTraceEnabled())\n+                log.trace(_loc.get(\"batch_update_success_count\",\n+                    updateSuccessCnt));\n+        }\n+        return updateSuccessCnt;\n+    }\n }"},{"sha":"5c918cd85318cbd7821ef97cce57a87f0a12d686","filename":"openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/kernel/localizer.properties","status":"modified","additions":0,"deletions":1,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/kernel/localizer.properties","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/kernel/localizer.properties","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/kernel/localizer.properties?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -115,4 +115,3 @@ batch_update_info: ExecuteBatch command returns update count {0} for \\\n \tstatement {1}.\n cache-hit: SQL Cache hit with key: {0} in {1}\n cache-missed: SQL Cache missed with key: {0} in {1}    \n-batch_update_success_count: ExecuteBatch command returns update success count {0}\n\\ No newline at end of file"},{"sha":"135fb33dfbab1acc8afc47f6eea80b933fc00126","filename":"openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/schema/localizer.properties","status":"modified","additions":0,"deletions":2,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/schema/localizer.properties","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/schema/localizer.properties","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/schema/localizer.properties?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -148,6 +148,4 @@ no-custom-ds: use a custom DataSource\n delete-table-contents: An error occurred while attempting to delete all \\\n     records from all mapped tables.\n set-auto-commit: DataSource connection setAutoCommit to \"{0}\"\n-connection-defaults: Initial connection autoCommit: {0}, holdability: {1}, \\\n-    TransactionIsolation: {2}\n "},{"sha":"a6d8dfd03a661fce5eaaa6eb05d599bcd15193db","filename":"openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/sql/localizer.properties","status":"modified","additions":4,"deletions":1,"changes":5,"blob_url":"https://github.com/apache/openjpa/blob/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/sql/localizer.properties","raw_url":"https://github.com/apache/openjpa/raw/93417f99e370124cf2e4dfc5a8988b14ae061eaf/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/sql/localizer.properties","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/resources/org/apache/openjpa/jdbc/sql/localizer.properties?ref=93417f99e370124cf2e4dfc5a8988b14ae061eaf","patch":"@@ -171,4 +171,7 @@ db-not-supported: The database product \"{0}\", version \"{1}\" is not officially su\n stream-exception: Unexpected error recovering the row to stream the LOB.\n batch_unlimit: The batch limit was changed from unlimit (-1) to {0}.\n function-not-supported: The database dictionary in use (\"{0}\") \\\n-\tdoes not support \"{1}\" function.\n\\ No newline at end of file\n+\tdoes not support \"{1}\" function.\n+batch_update_success_count: ExecuteBatch command returns update success count {0}\n+connection-defaults: Initial connection autoCommit: {0}, holdability: {1}, \\\n+    TransactionIsolation: {2}"}]}

