{"sha":"983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","node_id":"MDY6Q29tbWl0MjA2MzY0Ojk4M2IzNGI2OGU5YjVjZjJmYjViNzg3NDRmNmJiMmZjYjY1NDM4OWM=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-11-11T20:40:18Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-11-11T20:40:18Z"},"message":"OPENJPA-1380: queryCache is not refreshed for cross-join jpql.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@835054 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"80454d515a31f217e8bd63830ab2f9673acf4b65","url":"https://api.github.com/repos/apache/openjpa/git/trees/80454d515a31f217e8bd63830ab2f9673acf4b65"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","html_url":"https://github.com/apache/openjpa/commit/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","comments_url":"https://api.github.com/repos/apache/openjpa/commits/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/comments","author":null,"committer":null,"parents":[{"sha":"ab18db113b1fcdef7db9e96d8dcd6728cda576d8","url":"https://api.github.com/repos/apache/openjpa/commits/ab18db113b1fcdef7db9e96d8dcd6728cda576d8","html_url":"https://github.com/apache/openjpa/commit/ab18db113b1fcdef7db9e96d8dcd6728cda576d8"}],"stats":{"total":52,"additions":44,"deletions":8},"files":[{"sha":"b03c4b4ee11eec5c9e073a577e91539b1f793afa","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","raw_url":"https://github.com/apache/openjpa/raw/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java?ref=983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","patch":"@@ -827,6 +827,8 @@ private Expression evalFromItem(Expression exp, JPQLNode node,\n         // which is the desired candidate\n         if (ctx().schemaAlias == null)\n             setCandidate(cmd, alias);\n+        else  \n+            addAccessPath(cmd);\n \n         return exp;\n     }"},{"sha":"791776e634046fc81db28d1735e1c6399011df08","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestBulkJPQLAndDataCache.java","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/apache/openjpa/blob/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestBulkJPQLAndDataCache.java","raw_url":"https://github.com/apache/openjpa/raw/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestBulkJPQLAndDataCache.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestBulkJPQLAndDataCache.java?ref=983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","patch":"@@ -35,6 +35,7 @@\n     public void setUp() throws Exception {\n         setUp(\"openjpa.DataCache\", \"true\",\n             \"openjpa.RemoteCommitProvider\", \"sjvm\",\n+            CLEAR_TABLES,\n             AllFieldTypes.class, CascadeParent.class, CascadeChild.class);\n \n         OpenJPAEntityManager em = emf.createEntityManager();"},{"sha":"e6f1300e55964437ece0a64c689c5f221e1769af","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestQueryResultSize.java","status":"modified","additions":39,"deletions":8,"changes":47,"blob_url":"https://github.com/apache/openjpa/blob/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestQueryResultSize.java","raw_url":"https://github.com/apache/openjpa/raw/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestQueryResultSize.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/datacache/TestQueryResultSize.java?ref=983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","patch":"@@ -19,20 +19,17 @@\n package org.apache.openjpa.persistence.datacache;\n \n import java.util.HashMap;\n-import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n-import javax.persistence.EntityManagerFactory;\n-import org.apache.openjpa.datacache.*;\n-import javax.persistence.*;\n-import org.apache.openjpa.persistence.*;\n-\n \n-import org.apache.openjpa.persistence.datacache.common.apps.CacheObjectE;\n-import org.apache.openjpa.persistence.common.utils.AbstractTestCase;\n+import javax.persistence.EntityManagerFactory;\n \n+import org.apache.openjpa.datacache.ConcurrentQueryCache;\n import org.apache.openjpa.persistence.OpenJPAEntityManager;\n+import org.apache.openjpa.persistence.OpenJPAPersistence;\n import org.apache.openjpa.persistence.OpenJPAQuery;\n+import org.apache.openjpa.persistence.common.utils.AbstractTestCase;\n+import org.apache.openjpa.persistence.datacache.common.apps.CacheObjectE;\n \n public class TestQueryResultSize\n     extends AbstractTestCase {\n@@ -47,6 +44,8 @@ public TestQueryResultSize(String test) {\n     public void setUp() {\n         System.out.println(\"****Deleted Records \"\n             + deleteAll(CacheObjectE.class));\n+        deleteAll(CascadeParent.class);\n+        deleteAll(CascadeChild.class);\n         Map propsMap = new HashMap();\n         propsMap.put(\"openjpa.DataCache\", \"true\");\n         propsMap.put(\"openjpa.QueryCache\", \"true\");\n@@ -81,4 +80,36 @@ private int getQueryCacheSize() {\n             pm.getEntityManagerFactory()).getQueryResultCache().getDelegate())).\n             getCacheMap().size());\n     }\n+\n+    public void testCrossJoinQueryCache() {\n+        pm = (OpenJPAEntityManager) _pmf.createEntityManager();\n+        // create\n+        startTx(pm);\n+        CascadeParent p = new CascadeParent();\n+        p.setName(\"p1\");\n+        CascadeChild c = new CascadeChild();\n+        c.setName(\"p1\");\n+        p.setChild(c);\n+        pm.persist(p);\n+        endTx(pm);\n+\n+        // query\n+        String jpql = \"select p.name, c.name from CascadeParent p, CascadeChild c where p.name = c.name \"\n+                + \"and p.name = 'p1'\";\n+        javax.persistence.Query query = pm.createQuery(jpql);\n+        List result1 = query.getResultList();\n+        assertEquals(1, result1.size());\n+\n+        // update\n+        startTx(pm);\n+        c.setName(\"c1\");\n+        endTx(pm);\n+\n+        // query again\n+        List result2 = query.getResultList();\n+        assertEquals(0, result2.size());\n+        endEm(pm);\n+    }\n+\n+\n }"},{"sha":"51f6083215b9d73043bdc11ecb91f0ee5806b085","filename":"openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/datacache/common/apps/META-INF/persistence.xml","status":"modified","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/datacache/common/apps/META-INF/persistence.xml","raw_url":"https://github.com/apache/openjpa/raw/983b34b68e9b5cf2fb5b78744f6bb2fcb654389c/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/datacache/common/apps/META-INF/persistence.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/datacache/common/apps/META-INF/persistence.xml?ref=983b34b68e9b5cf2fb5b78744f6bb2fcb654389c","patch":"@@ -22,6 +22,8 @@\n \t<persistence-unit name=\"TestConv\" transaction-type=\"RESOURCE_LOCAL\">\n \t\t<provider>org.apache.openjpa.persistence.PersistenceProviderImpl</provider>\n \t\t\n+\t\t<class>org.apache.openjpa.persistence.datacache.CascadeChild</class>\n+\t\t<class>org.apache.openjpa.persistence.datacache.CascadeParent</class>\n \t\t<class>org.apache.openjpa.persistence.datacache.common.apps.AppIdCacheObject</class>\n \t\t<class>org.apache.openjpa.persistence.datacache.common.apps.AttachA</class>\n \t\t<class>org.apache.openjpa.persistence.datacache.common.apps.AttachB</class>"}]}

