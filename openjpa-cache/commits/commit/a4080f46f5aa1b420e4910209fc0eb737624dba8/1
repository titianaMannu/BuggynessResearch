{"sha":"a4080f46f5aa1b420e4910209fc0eb737624dba8","node_id":"MDY6Q29tbWl0MjA2MzY0OmE0MDgwZjQ2ZjVhYTFiNDIwZTQ5MTAyMDlmYzBlYjczNzYyNGRiYTg=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-09-30T22:07:11Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-09-30T22:07:11Z"},"message":"OPENJPA-1819: if there is a group-by clause, orderby_item must be in the group-by list\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1003317 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"9eb006b6ff96f37d363565c9676c64ba4e2e5227","url":"https://api.github.com/repos/apache/openjpa/git/trees/9eb006b6ff96f37d363565c9676c64ba4e2e5227"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/a4080f46f5aa1b420e4910209fc0eb737624dba8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/a4080f46f5aa1b420e4910209fc0eb737624dba8","html_url":"https://github.com/apache/openjpa/commit/a4080f46f5aa1b420e4910209fc0eb737624dba8","comments_url":"https://api.github.com/repos/apache/openjpa/commits/a4080f46f5aa1b420e4910209fc0eb737624dba8/comments","author":null,"committer":null,"parents":[{"sha":"1f64b37ec51ac86c953aceb5288bbe2a2237e2a2","url":"https://api.github.com/repos/apache/openjpa/commits/1f64b37ec51ac86c953aceb5288bbe2a2237e2a2","html_url":"https://github.com/apache/openjpa/commit/1f64b37ec51ac86c953aceb5288bbe2a2237e2a2"}],"stats":{"total":28,"additions":26,"deletions":2},"files":[{"sha":"1182bcbc7f5c155c5defbd936f7d8b397410b549","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/SelectConstructor.java","status":"modified","additions":14,"deletions":1,"changes":15,"blob_url":"https://github.com/apache/openjpa/blob/a4080f46f5aa1b420e4910209fc0eb737624dba8/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/SelectConstructor.java","raw_url":"https://github.com/apache/openjpa/raw/a4080f46f5aa1b420e4910209fc0eb737624dba8/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/SelectConstructor.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/exps/SelectConstructor.java?ref=a4080f46f5aa1b420e4910209fc0eb737624dba8","patch":"@@ -280,12 +280,25 @@ private void initialize(Select sel, ExpContext ctx, QueryExpressions exps,\n             Val orderVal;\n             for (int i = 0; i < exps.ordering.length; i++) {\n                 orderVal = (Val) exps.ordering[i];\n-                state.ordering[i] = orderVal.initialize(sel, ctx, 0);\n+                if (contains(orderVal, exps.grouping)) \n+                    state.ordering[i] = orderVal.initialize(sel, ctx, Val.JOIN_REL);\n+                else\n+                    state.ordering[i] = orderVal.initialize(sel, ctx, 0);\n+                    \n                 joins = sel.and(joins, state.ordering[i].joins);\n             }\n         }\n         sel.where(joins);\n     }\n+    \n+    private boolean contains(Val orderVal, Value[] grouping) {\n+        for (int i = 0; i < grouping.length; i++) {\n+            Val groupVal = (Val) grouping[i];\n+            if (orderVal.equals(groupVal))\n+                return true;\n+        }\n+        return false;\n+    }\n \n     /**\n      * Create the where sql."},{"sha":"22770ad6ea691ec4b2b9dcb9adf2ca6a5b861c99","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/query/TestEJBQueryInterface.java","status":"modified","additions":12,"deletions":1,"changes":13,"blob_url":"https://github.com/apache/openjpa/blob/a4080f46f5aa1b420e4910209fc0eb737624dba8/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/query/TestEJBQueryInterface.java","raw_url":"https://github.com/apache/openjpa/raw/a4080f46f5aa1b420e4910209fc0eb737624dba8/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/query/TestEJBQueryInterface.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/query/TestEJBQueryInterface.java?ref=a4080f46f5aa1b420e4910209fc0eb737624dba8","patch":"@@ -33,7 +33,7 @@ public TestEJBQueryInterface(String name) {\n     }\n \n     public void setUp() throws Exception {\n-        super.setUp(Entity1.class, Entity2.class);\n+        super.setUp(Entity1.class, Entity2.class, Order.class, OrderItem.class);\n \n         int instNum = 10;\n \n@@ -147,5 +147,16 @@ public void testSetParameter1() {\n         endEm(em);\n     }\n \n+    public void testOrderBy() {\n+        EntityManager em = currentEntityManager();\n+        startTx(em);\n+        String jpql = \"SELECT o.oid FROM OrderItem l LEFT JOIN l.order o GROUP BY o.oid ORDER BY o.oid \";\n+        try {\n+            List ret = em.createQuery(jpql).getResultList();\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            fail(e.getMessage());\n+        }\n+    }\n     //rest of the interface is tested by the CTS\n }"}]}

