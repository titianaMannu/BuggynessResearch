{"sha":"a488a122cf639eb23b37ba23670758ce6b2eef40","node_id":"MDY6Q29tbWl0MjA2MzY0OmE0ODhhMTIyY2Y2MzllYjIzYjM3YmEyMzY3MDc1OGNlNmIyZWVmNDA=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-08-13T03:08:55Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-08-13T03:08:55Z"},"message":"OPENJPA-1242: fix cascade delete for 1-1 relation in an embeddable \n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@803763 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"6e21535c8d6ab332d1ba08046752598298a56a88","url":"https://api.github.com/repos/apache/openjpa/git/trees/6e21535c8d6ab332d1ba08046752598298a56a88"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/a488a122cf639eb23b37ba23670758ce6b2eef40","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/a488a122cf639eb23b37ba23670758ce6b2eef40","html_url":"https://github.com/apache/openjpa/commit/a488a122cf639eb23b37ba23670758ce6b2eef40","comments_url":"https://api.github.com/repos/apache/openjpa/commits/a488a122cf639eb23b37ba23670758ce6b2eef40/comments","author":null,"committer":null,"parents":[{"sha":"6c2e3e2d03e22f0d0f9ffc4a35aef186f1070928","url":"https://api.github.com/repos/apache/openjpa/commits/6c2e3e2d03e22f0d0f9ffc4a35aef186f1070928","html_url":"https://github.com/apache/openjpa/commit/6c2e3e2d03e22f0d0f9ffc4a35aef186f1070928"}],"stats":{"total":23,"additions":17,"deletions":6},"files":[{"sha":"9e972893bc392762a3423116994c94679e85ae14","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/SingleFieldManager.java","status":"modified","additions":8,"deletions":4,"changes":12,"blob_url":"https://github.com/apache/openjpa/blob/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/SingleFieldManager.java","raw_url":"https://github.com/apache/openjpa/raw/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/SingleFieldManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/SingleFieldManager.java?ref=a488a122cf639eb23b37ba23670758ce6b2eef40","patch":"@@ -289,13 +289,17 @@ public void delete(OpCallbacks call) {\n      * Dereference field values.\n      */\n     public void dereferenceDependent() {\n-        delete(false, null);\n+        delete(false, null, true);\n     }\n \n+    private void delete(boolean immediate, OpCallbacks call) {\n+        delete(immediate, call, false);\n+    }\n+        \n     /**\n      * Delete or dereference the stored field as necessary.\n      */\n-    private void delete(boolean immediate, OpCallbacks call) {\n+    private void delete(boolean immediate, OpCallbacks call, boolean deref) {\n         if (objval == null)\n             return;\n \n@@ -305,8 +309,8 @@ private void delete(boolean immediate, OpCallbacks call) {\n             // works on external value\n             if ((immediate || fmd.isEmbeddedPC())\n                 && fmd.getCascadeDelete() == ValueMetaData.CASCADE_IMMEDIATE) {\n-                if (fmd.isEmbeddedPC())\n-                    dereferenceEmbedDependent(_sm);\n+                if (fmd.isEmbeddedPC() && deref)\n+                    dereferenceEmbedDependent(_broker.getStateManagerImpl(objval, false));\n                 delete(fmd, objval, call);\n             }\n             else if (fmd.getCascadeDelete() == ValueMetaData.CASCADE_AUTO)"},{"sha":"403f11f9c0784cafe67c302aacac3cbed163a2b0","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/StateManagerImpl.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/StateManagerImpl.java","raw_url":"https://github.com/apache/openjpa/raw/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/StateManagerImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/StateManagerImpl.java?ref=a488a122cf639eb23b37ba23670758ce6b2eef40","patch":"@@ -1357,7 +1357,7 @@ void setDereferencedEmbedDependent(boolean deref) {\n     }\n     \n     public boolean getDereferencedEmbedDependent() {\n-        return ((_flags |= FLAG_EMBED_DEREF) == 0 ? false : true);\n+        return ((_flags & FLAG_EMBED_DEREF) == 0 ? false : true);\n     }\n \n     ///////////"},{"sha":"82315315605eb3f16936e34e644c8c817cfa1b87","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/Embed_ToOne.java","status":"modified","additions":2,"deletions":1,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/Embed_ToOne.java","raw_url":"https://github.com/apache/openjpa/raw/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/Embed_ToOne.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/Embed_ToOne.java?ref=a488a122cf639eb23b37ba23670758ce6b2eef40","patch":"@@ -18,6 +18,7 @@\n  */\n package org.apache.openjpa.persistence.embed;\n \n+import javax.persistence.CascadeType;\n import javax.persistence.Embeddable;\n import javax.persistence.OneToOne;\n \n@@ -26,7 +27,7 @@\n     protected String name1;\n     protected String name2;\n     protected String name3;\n-    @OneToOne\n+    @OneToOne(cascade=CascadeType.ALL)\n     protected EntityB1 b;\n     \n     public String getName1() {"},{"sha":"d8415423f5be3a2fcfe9c1cafa674dca762a27b5","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddable.java","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddable.java","raw_url":"https://github.com/apache/openjpa/raw/a488a122cf639eb23b37ba23670758ce6b2eef40/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddable.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddable.java?ref=a488a122cf639eb23b37ba23670758ce6b2eef40","patch":"@@ -825,6 +825,12 @@ public void findEntityA_Embed_ToOne() {\n         EntityManager em = emf.createEntityManager();\n         EntityA_Embed_ToOne a = em.find(EntityA_Embed_ToOne.class, ID);\n         checkEntityA_Embed_ToOne(a);\n+        em.getTransaction().begin();\n+        em.remove(a);\n+        em.getTransaction().commit();\n+        //delete cascade\n+        EntityB1 b = em.find(EntityB1.class, ID);\n+        assertNull(b);\n         em.close();\n     }\n "}]}

