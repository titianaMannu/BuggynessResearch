{"sha":"ab8090f5566c68fd3d46600158527de14ce622f2","node_id":"MDY6Q29tbWl0MjA2MzY0OmFiODA5MGY1NTY2YzY4ZmQzZDQ2NjAwMTU4NTI3ZGUxNGNlNjIyZjI=","commit":{"author":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-03T06:42:28Z"},"committer":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-03T06:42:28Z"},"message":"OPENJPA-2856 improve MariaDB TIME handling\n\n* java.sql.Time parameters must be on date Jan 1st 1970, otherwise MariaDB won't find anything in the DB\n* from > 10 onwards MariaDB supports up to 6 fractions in TIME as well.","tree":{"sha":"d1bbb9cbebae8130a67b0155aa3ff6ee0358fd4c","url":"https://api.github.com/repos/apache/openjpa/git/trees/d1bbb9cbebae8130a67b0155aa3ff6ee0358fd4c"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/ab8090f5566c68fd3d46600158527de14ce622f2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/ab8090f5566c68fd3d46600158527de14ce622f2","html_url":"https://github.com/apache/openjpa/commit/ab8090f5566c68fd3d46600158527de14ce622f2","comments_url":"https://api.github.com/repos/apache/openjpa/commits/ab8090f5566c68fd3d46600158527de14ce622f2/comments","author":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"committer":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"parents":[{"sha":"76225267d90f9abe559dc63a7f5f74a1aa5bcd93","url":"https://api.github.com/repos/apache/openjpa/commits/76225267d90f9abe559dc63a7f5f74a1aa5bcd93","html_url":"https://github.com/apache/openjpa/commit/76225267d90f9abe559dc63a7f5f74a1aa5bcd93"}],"stats":{"total":29,"additions":26,"deletions":3},"files":[{"sha":"30adc89a13c58ec1277d6c5dc0dae8eed84eabb4","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MariaDBDictionary.java","status":"modified","additions":23,"deletions":0,"changes":23,"blob_url":"https://github.com/apache/openjpa/blob/ab8090f5566c68fd3d46600158527de14ce622f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MariaDBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/ab8090f5566c68fd3d46600158527de14ce622f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MariaDBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/MariaDBDictionary.java?ref=ab8090f5566c68fd3d46600158527de14ce622f2","patch":"@@ -20,11 +20,15 @@\n \n import java.sql.Connection;\n import java.sql.DatabaseMetaData;\n+import java.sql.PreparedStatement;\n import java.sql.ResultSet;\n import java.sql.SQLException;\n+import java.sql.Time;\n import java.sql.Types;\n import java.util.Arrays;\n+import java.util.Calendar;\n import java.util.Collection;\n+import java.util.Date;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n@@ -196,6 +200,13 @@ public void connectedConfiguration(Connection conn) throws SQLException {\n             timestampTypeName = \"DATETIME{0}\";\n             fixedSizeTypeNameSet.remove(timestampTypeName);\n             fractionalTypeNameSet.add(timestampTypeName);\n+\n+            // also TIME type now has optional fraction digits\n+\n+            if (dateFractionDigits > 0 ) {\n+                timeTypeName = \"TIME{0}\";\n+                fractionalTypeNameSet.add(timeTypeName);\n+            }\n         }\n     }\n \n@@ -516,4 +527,16 @@ public void indexOf(SQLBuffer buf, FilterValue str, FilterValue find,\n         }\n         buf.append(\")\");\n     }\n+\n+    @Override\n+    public void setTime(PreparedStatement stmnt, int idx, Time val, Calendar cal, Column col) throws SQLException {\n+        // nail down to Jan 1st 1970, because MariaDB uses getTime LONG  and freaks out.\n+        final Date date = new Date(val.getTime());\n+        date.setYear(70);\n+        date.setMonth(0);\n+        date.setDate(1);\n+        val = new Time(date.getTime());\n+\n+        super.setTime(stmnt, idx, val, cal, col);\n+    }\n }"},{"sha":"634c7c7132aa23a0f0536d6fb515aed3f8e5a1e2","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestTemporalTypeQueryParameterBinding.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/ab8090f5566c68fd3d46600158527de14ce622f2/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestTemporalTypeQueryParameterBinding.java","raw_url":"https://github.com/apache/openjpa/raw/ab8090f5566c68fd3d46600158527de14ce622f2/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestTemporalTypeQueryParameterBinding.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestTemporalTypeQueryParameterBinding.java?ref=ab8090f5566c68fd3d46600158527de14ce622f2","patch":"@@ -67,6 +67,7 @@ public void setUp() throws Exception {\n                 \"openjpa.jdbc.DBDictionary\", \"(dateFractionDigits=6)\",\n                 TimeKeeper.class, TimeEntity.class);\n         em = emf.createEntityManager();\n+        em.getTransaction().begin();\n \n         TimeKeeper pc = new TimeKeeper();\n         pc.setDate(VALUE_DATE);\n@@ -83,7 +84,6 @@ public void setUp() throws Exception {\n         te.setUDate2Time(VALUE_DATE);\n         te.setUDate2Timestamp(VALUE_DATE);\n \n-        em.getTransaction().begin();\n         em.persist(pc);\n         em.persist(te);\n         em.getTransaction().commit();"},{"sha":"139b31f15ba8a31b6c76e1190024f8954d6bd0b7","filename":"pom.xml","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/apache/openjpa/blob/ab8090f5566c68fd3d46600158527de14ce622f2/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/ab8090f5566c68fd3d46600158527de14ce622f2/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/pom.xml?ref=ab8090f5566c68fd3d46600158527de14ce622f2","patch":"@@ -77,7 +77,7 @@\n         <derby.version>10.14.2.0</derby.version>\n         <hsqldb.version>2.4.1</hsqldb.version>\n         <mysql.connector.version>5.1.47</mysql.connector.version>\n-        <mariadb.connector.version>2.2.0</mariadb.connector.version>\n+        <mariadb.connector.version>2.7.2</mariadb.connector.version>\n         <postgresql.connector.version>42.2.9</postgresql.connector.version>\n         <mssql.connector.version>9.2.1.jre8</mssql.connector.version>\n \n@@ -718,7 +718,7 @@\n                 <dbcp.maxIdle>5</dbcp.maxIdle>\n                 <dbcp.minIdle>0</dbcp.minIdle>\n \n-                <mariadb.server.version>10.3</mariadb.server.version>\n+                <mariadb.server.version>10.5</mariadb.server.version>\n             </properties>\n \n             <build>"}]}

