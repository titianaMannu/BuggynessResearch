{"sha":"b48106b0720d6ae199da5391aadcf3d4b40c5d13","node_id":"MDY6Q29tbWl0MjA2MzY0OmI0ODEwNmIwNzIwZDZhZTE5OWRhNTM5MWFhZGNmM2Q0YjQwYzVkMTM=","commit":{"author":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2014-12-10T14:11:45Z"},"committer":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2014-12-10T14:11:45Z"},"message":"OPENJPA-2542: Use bundle classloader AND PersistenceUnitInfo classloader when creating a BrokerFactory.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1644414 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"09c50822dda442d0e44da24138f2d5cb16bd6400","url":"https://api.github.com/repos/apache/openjpa/git/trees/09c50822dda442d0e44da24138f2d5cb16bd6400"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/b48106b0720d6ae199da5391aadcf3d4b40c5d13","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/b48106b0720d6ae199da5391aadcf3d4b40c5d13","html_url":"https://github.com/apache/openjpa/commit/b48106b0720d6ae199da5391aadcf3d4b40c5d13","comments_url":"https://api.github.com/repos/apache/openjpa/commits/b48106b0720d6ae199da5391aadcf3d4b40c5d13/comments","author":null,"committer":null,"parents":[{"sha":"7c0e7f2efda611890d8ce348be401a585627350c","url":"https://api.github.com/repos/apache/openjpa/commits/7c0e7f2efda611890d8ce348be401a585627350c","html_url":"https://github.com/apache/openjpa/commit/7c0e7f2efda611890d8ce348be401a585627350c"}],"stats":{"total":19,"additions":13,"deletions":6},"files":[{"sha":"4d5028cce730ca42578b6e18ea7734dc9de52baa","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java","status":"modified","additions":6,"deletions":0,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/b48106b0720d6ae199da5391aadcf3d4b40c5d13/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java","raw_url":"https://github.com/apache/openjpa/raw/b48106b0720d6ae199da5391aadcf3d4b40c5d13/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java?ref=b48106b0720d6ae199da5391aadcf3d4b40c5d13","patch":"@@ -68,6 +68,12 @@ public MultiClassLoader(MultiClassLoader other) {\n         addClassLoaders(other);\n     }\n \n+    public MultiClassLoader(ClassLoader... loaders) {\n+        for (ClassLoader loader : loaders) {\n+            addClassLoader(loader);\n+        }\n+    }\n+\n     /**\n      * Returns true if the list contains the given class loader or marker.\n      */"},{"sha":"e62fdc8f302c0cca3d7df3c2a2df4eebe2af6cb4","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java","status":"modified","additions":7,"deletions":6,"changes":13,"blob_url":"https://github.com/apache/openjpa/blob/b48106b0720d6ae199da5391aadcf3d4b40c5d13/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java","raw_url":"https://github.com/apache/openjpa/raw/b48106b0720d6ae199da5391aadcf3d4b40c5d13/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java?ref=b48106b0720d6ae199da5391aadcf3d4b40c5d13","patch":"@@ -44,6 +44,7 @@\n import org.apache.openjpa.lib.conf.Configurations;\n import org.apache.openjpa.lib.log.Log;\n import org.apache.openjpa.lib.util.Localizer;\n+import org.apache.openjpa.lib.util.MultiClassLoader;\n import org.apache.openjpa.meta.AbstractCFMetaDataFactory;\n import org.apache.openjpa.meta.MetaDataModes;\n import org.apache.openjpa.meta.MetaDataRepository;\n@@ -180,14 +181,14 @@ public OpenJPAEntityManagerFactory createContainerEntityManagerFactory(Persisten\n                 cp.addProperty(\"openjpa.\" + BrokerValue.KEY, getDefaultBrokerAlias());\n             }\n \n-            // OPENJPA-1491 If running under OSGi, use the Bundle's ClassLoader instead of the application one\n-            BrokerFactory factory;\n+\n+            ClassLoader loader = pui.getClassLoader();\n             if (BundleUtils.runningUnderOSGi()) {\n-                factory = getBrokerFactory(cp, poolValue, BundleUtils.getBundleClassLoader());\n-            } else {\n-                factory = getBrokerFactory(cp, poolValue, pui.getClassLoader());\n+                // OPENJPA-1491 : If running under OSGi, use the Bundle's ClassLoader instead of the application one\n+                // OPENJPA-2542 : Also try to load from app loader in the case of a user implemented interface/config \n+                loader = new MultiClassLoader(BundleUtils.getBundleClassLoader(), loader);\n             }\n-\n+            BrokerFactory factory = getBrokerFactory(cp, poolValue, loader);\n             OpenJPAConfiguration conf = factory.getConfiguration();\n             setPersistenceEnvironmentInfo(conf, pui);\n             _log = conf.getLog(OpenJPAConfiguration.LOG_RUNTIME);"}]}

