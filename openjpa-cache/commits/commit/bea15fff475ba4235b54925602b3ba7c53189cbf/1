{"sha":"bea15fff475ba4235b54925602b3ba7c53189cbf","node_id":"MDY6Q29tbWl0MjA2MzY0OmJlYTE1ZmZmNDc1YmE0MjM1YjU0OTI1NjAyYjNiYTdjNTMxODljYmY=","commit":{"author":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2008-08-01T23:42:01Z"},"committer":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2008-08-01T23:42:01Z"},"message":"OPENJPA-28: GROUP BY clause on nested sub query should not appear on top-level query\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@681904 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"96ea5ef2c4859e52384759f18d5aeda43f461806","url":"https://api.github.com/repos/apache/openjpa/git/trees/96ea5ef2c4859e52384759f18d5aeda43f461806"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/bea15fff475ba4235b54925602b3ba7c53189cbf","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/bea15fff475ba4235b54925602b3ba7c53189cbf","html_url":"https://github.com/apache/openjpa/commit/bea15fff475ba4235b54925602b3ba7c53189cbf","comments_url":"https://api.github.com/repos/apache/openjpa/commits/bea15fff475ba4235b54925602b3ba7c53189cbf/comments","author":null,"committer":null,"parents":[{"sha":"b29b9b6c7619e5785d80769881a16a95503bf79c","url":"https://api.github.com/repos/apache/openjpa/commits/b29b9b6c7619e5785d80769881a16a95503bf79c","html_url":"https://github.com/apache/openjpa/commit/b29b9b6c7619e5785d80769881a16a95503bf79c"}],"stats":{"total":283,"additions":281,"deletions":2},"files":[{"sha":"1bf5af3824a9c71b765c664b3952dd00dddd5ec5","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","status":"modified","additions":2,"deletions":2,"changes":4,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/jpql/JPQLExpressionBuilder.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -345,7 +345,7 @@ else if (root().id == JJTUPDATE)\n \n     private void evalGroupingClause(QueryExpressions exps) {\n         // handle GROUP BY clauses\n-        JPQLNode groupByNode = root().findChildByID(JJTGROUPBY, true);\n+        JPQLNode groupByNode = root().findChildByID(JJTGROUPBY, false);\n \n         if (groupByNode == null)\n             return;\n@@ -362,7 +362,7 @@ private void evalGroupingClause(QueryExpressions exps) {\n \n     private void evalHavingClause(QueryExpressions exps) {\n         // handle HAVING clauses\n-        JPQLNode havingNode = root().findChildByID(JJTHAVING, true);\n+        JPQLNode havingNode = root().findChildByID(JJTHAVING, false);\n \n         if (havingNode == null)\n             return;"},{"sha":"0af73218cf944bed18753f4eebca16c14c541bae","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestGroupByQuery.java","status":"added","additions":84,"deletions":0,"changes":84,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestGroupByQuery.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestGroupByQuery.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/TestGroupByQuery.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -0,0 +1,84 @@\n+/*\r\n+ * TestLockGroupsWithHorizontalBaseType.java\r\n+ *\r\n+ * Created on October 4, 2006, 5:03 PM\r\n+ *\r\n+ * To change this template, choose Tools | Template Manager\r\n+ * and open the template in the editor.\r\n+ */\r\n+\r\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query;\r\n+\r\n+import java.util.List;\r\n+\r\n+import javax.persistence.EntityManager;\r\n+\r\n+import org.apache.openjpa.persistence.jdbc.query.domain.IndoorGame;\r\n+import org.apache.openjpa.persistence.jdbc.query.domain.Scrabble;\r\n+import org.apache.openjpa.persistence.jdbc.query.domain.Chess;\r\n+import org.apache.openjpa.persistence.jdbc.query.domain.Game;\r\n+import org.apache.openjpa.persistence.test.SingleEMFTestCase;\r\n+\r\n+/**\r\n+ * Tests GROUP BY in sub query does not get parsed by owning query.\r\n+ * \r\n+ * Further details can be found in <A\r\n+ * HREF=\"https://issues.apache.org/jira/browse/OPENJPA-28\">OPENJPA-28</A>\r\n+ * \r\n+ * @author Pinaki Poddar\r\n+ * \r\n+ */\r\n+public class TestGroupByQuery extends SingleEMFTestCase {\r\n+\tpublic void setUp() {\r\n+\t\tsuper.setUp(DROP_TABLES, Game.class, IndoorGame.class, Scrabble.class,\r\n+\t\t\t\tChess.class);\r\n+\t\ttry {\r\n+\t\t\tcreateData();\r\n+\t\t} catch (Exception e) {\r\n+\t\t\tthrow new RuntimeException(e);\r\n+\t\t}\r\n+\t}\r\n+\r\n+\tvoid createData() throws Exception {\r\n+\t\tEntityManager em = emf.createEntityManager();\r\n+\t\tem.getTransaction().begin();\r\n+\t\tClass[] classes = { Game.class, IndoorGame.class, Scrabble.class,\r\n+\t\t\t\tChess.class };\r\n+\t\tfor (Class cls : classes) {\r\n+\t\t\tfor (int i = 1; i <= 4; i++) {\r\n+\t\t\t\tGame p = (Game) cls.newInstance();\r\n+\t\t\t\tp.setName(cls.getSimpleName() + \"-\" + i);\r\n+\t\t\t\tem.persist(p);\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\tem.getTransaction().commit();\r\n+\t}\r\n+\r\n+\tpublic void testGroupBy() {\r\n+\t\tString jpql = \"SELECT g.name, g.nTile FROM Scrabble g WHERE \"\r\n+\t\t\t\t+ \"(g.name = ANY(SELECT g1.name FROM Scrabble g1 \"\r\n+\t\t\t\t+ \"GROUP BY g1.name )) ORDER BY g.name\";\r\n+\t\tEntityManager em = emf.createEntityManager();\r\n+\r\n+\t\tList<IndoorGame> employees = em.createQuery(jpql).getResultList();\r\n+\r\n+\t}\r\n+}\r"},{"sha":"4d7a5bdff2a6314ae707b47a0ecb8bc23d2159e7","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Chess.java","status":"added","additions":43,"deletions":0,"changes":43,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Chess.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Chess.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Chess.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -0,0 +1,43 @@\n+/*\r\n+ * TestLockGroupsWithHorizontalBaseType.java\r\n+ *\r\n+ * Created on October 4, 2006, 5:03 PM\r\n+ *\r\n+ * To change this template, choose Tools | Template Manager\r\n+ * and open the template in the editor.\r\n+ */\r\n+\r\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query.domain;\r\n+\r\n+import javax.persistence.Entity;\r\n+\r\n+@Entity\r\n+public class Chess extends IndoorGame {\r\n+\tprivate int nPiece;\r\n+\r\n+\tpublic int getPiece() {\r\n+\t\treturn nPiece;\r\n+\t}\r\n+\r\n+\tpublic void setPiece(int n) {\r\n+\t\tthis.nPiece = n;\r\n+\t}\r\n+}\r"},{"sha":"de133a07d82770c9680eaabde101fdb79bbdfecf","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Game.java","status":"added","additions":65,"deletions":0,"changes":65,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Game.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Game.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Game.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -0,0 +1,65 @@\n+/*\r\n+ * TestLockGroupsWithHorizontalBaseType.java\r\n+ *\r\n+ * Created on October 4, 2006, 5:03 PM\r\n+ *\r\n+ * To change this template, choose Tools | Template Manager\r\n+ * and open the template in the editor.\r\n+ */\r\n+\r\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query.domain;\r\n+\r\n+import javax.persistence.Entity;\r\n+import javax.persistence.GeneratedValue;\r\n+import javax.persistence.Id;\r\n+import javax.persistence.Inheritance;\r\n+import javax.persistence.InheritanceType;\r\n+\r\n+/**\r\n+ * Simple unrelated persistent entity used to test logically union queries. \r\n+ * This class is root of an inheritance hierarchy using TABLE PER CLASS \r\n+ * strategy. Polymorphic queries on this class needs to run logical union\r\n+ * of queries on all known subclasses. \r\n+ * \r\n+ * @author Pinaki Poddar\r\n+ *\r\n+ */\r\n+@Entity\r\n+@Inheritance(strategy=InheritanceType.TABLE_PER_CLASS)\r\n+public class Game {\r\n+\t@Id\r\n+\t@GeneratedValue\r\n+\tprivate long id;\r\n+\t\r\n+\tprivate String name;\r\n+\r\n+\tpublic long getId() {\r\n+\t\treturn id;\r\n+\t}\r\n+\r\n+\tpublic String getName() {\r\n+\t\treturn name;\r\n+\t}\r\n+\r\n+\tpublic void setName(String name) {\r\n+\t\tthis.name = name;\r\n+\t}\r\n+}\r"},{"sha":"ffe7384d67308f0e422951ed21aeca3f96943114","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/IndoorGame.java","status":"added","additions":43,"deletions":0,"changes":43,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/IndoorGame.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/IndoorGame.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/IndoorGame.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -0,0 +1,43 @@\n+/*\r\n+ * TestLockGroupsWithHorizontalBaseType.java\r\n+ *\r\n+ * Created on October 4, 2006, 5:03 PM\r\n+ *\r\n+ * To change this template, choose Tools | Template Manager\r\n+ * and open the template in the editor.\r\n+ */\r\n+\r\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query.domain;\r\n+\r\n+import javax.persistence.Entity;\r\n+\r\n+@Entity\r\n+public class IndoorGame extends Game {\r\n+\tprivate int nPlayer;\r\n+\r\n+\tpublic int getPlayer() {\r\n+\t\treturn nPlayer;\r\n+\t}\r\n+\r\n+\tpublic void setPlayer(int n) {\r\n+\t\tthis.nPlayer = n;\r\n+\t}\r\n+}\r"},{"sha":"fd03563726798005f4f321cd842e355812938a0b","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Scrabble.java","status":"added","additions":44,"deletions":0,"changes":44,"blob_url":"https://github.com/apache/openjpa/blob/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Scrabble.java","raw_url":"https://github.com/apache/openjpa/raw/bea15fff475ba4235b54925602b3ba7c53189cbf/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Scrabble.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/jdbc/query/domain/Scrabble.java?ref=bea15fff475ba4235b54925602b3ba7c53189cbf","patch":"@@ -0,0 +1,44 @@\n+/*\r\n+ * TestLockGroupsWithHorizontalBaseType.java\r\n+ *\r\n+ * Created on October 4, 2006, 5:03 PM\r\n+ *\r\n+ * To change this template, choose Tools | Template Manager\r\n+ * and open the template in the editor.\r\n+ */\r\n+\r\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ * http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing,\r\n+ * software distributed under the License is distributed on an\r\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n+ * KIND, either express or implied.  See the License for the\r\n+ * specific language governing permissions and limitations\r\n+ * under the License.    \r\n+ */\r\n+package org.apache.openjpa.persistence.jdbc.query.domain;\r\n+\r\n+import javax.persistence.Entity;\r\n+\r\n+@Entity\r\n+public class Scrabble extends IndoorGame {\r\n+\tprivate int nTile;\r\n+\r\n+\tpublic int getTile() {\r\n+\t\treturn nTile;\r\n+\t}\r\n+\r\n+\tpublic void setTile(int n) {\r\n+\t\tthis.nTile = n;\r\n+\t}\r\n+\r\n+}\r"}]}

