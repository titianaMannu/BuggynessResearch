{"sha":"c043302e1e6c90d2859ae5833f455a53a3c62bd8","node_id":"MDY6Q29tbWl0MjA2MzY0OmMwNDMzMDJlMWU2YzkwZDI4NTlhZTU4MzNmNDU1YTUzYTNjNjJiZDg=","commit":{"author":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-02-18T01:28:00Z"},"committer":{"name":"Pinaki Poddar","email":"ppoddar@apache.org","date":"2010-02-18T01:28:00Z"},"message":"OPENJPA-1503: Set txn for rollback directly on illegal argument\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@911241 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"19469632b3f964a21378bd95019d89e0453ee183","url":"https://api.github.com/repos/apache/openjpa/git/trees/19469632b3f964a21378bd95019d89e0453ee183"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c043302e1e6c90d2859ae5833f455a53a3c62bd8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c043302e1e6c90d2859ae5833f455a53a3c62bd8","html_url":"https://github.com/apache/openjpa/commit/c043302e1e6c90d2859ae5833f455a53a3c62bd8","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c043302e1e6c90d2859ae5833f455a53a3c62bd8/comments","author":null,"committer":null,"parents":[{"sha":"bdb1e5d6f2984ec3b7e5e6c84c9595bba25e693b","url":"https://api.github.com/repos/apache/openjpa/commits/bdb1e5d6f2984ec3b7e5e6c84c9595bba25e693b","html_url":"https://github.com/apache/openjpa/commit/bdb1e5d6f2984ec3b7e5e6c84c9595bba25e693b"}],"stats":{"total":19,"additions":12,"deletions":7},"files":[{"sha":"aeb3e999884945e180a6fbde63eb384a2da3157c","filename":"openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","status":"modified","additions":12,"deletions":7,"changes":19,"blob_url":"https://github.com/apache/openjpa/blob/c043302e1e6c90d2859ae5833f455a53a3c62bd8/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","raw_url":"https://github.com/apache/openjpa/raw/c043302e1e6c90d2859ae5833f455a53a3c62bd8/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/EntityManagerImpl.java?ref=c043302e1e6c90d2859ae5833f455a53a3c62bd8","patch":"@@ -1602,19 +1602,24 @@ public OpenJPACriteriaBuilder getCriteriaBuilder() {\n         return _broker.getSupportedProperties();\n     }\n \n+    /**\n+     * Unwraps this receiver to an instance of the given class, if possible.\n+     * \n+     * @exception if the given class is null, generic <code>Object.class</code> or a class\n+     * that is not wrapped by this receiver.  \n+     */\n     public <T> T unwrap(Class<T> cls) {\n         Object[] delegates = new Object[]{_broker.getInnermostDelegate(),\n             _broker.getDelegate(), _broker, this};\n-        if (cls == null || cls == Object.class) {\n-            throw new PersistenceException(_loc.get(\"unwrap-em-invalid\", cls)\n-                    .toString(), null, this, false);\n-        }\n         for (Object o : delegates) {\n-            if (cls.isInstance(o))\n+            if (cls != null && cls != Object.class && cls.isInstance(o))\n                 return (T)o;\n         }\n-        throw new PersistenceException(_loc.get(\"unwrap-em-invalid\", cls)\n-            .toString(), null, this, false);\n+        // Set this transaction to rollback only (as per spec) here because the raised exception \n+        // does not go through normal exception translation pathways\n+        RuntimeException ex = new IllegalArgumentException(_loc.get(\"unwrap-em-invalid\", cls).toString());\n+        setRollbackOnly(ex);\n+        throw ex;\n     }\n \n     public void setQuerySQLCache(boolean flag) {"}]}

