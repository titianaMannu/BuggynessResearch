{"sha":"c275da64abe546a9af2c28bb6245cb8a95754e96","node_id":"MDY6Q29tbWl0MjA2MzY0OmMyNzVkYTY0YWJlNTQ2YTlhZjJjMjhiYjYyNDVjYjhhOTU3NTRlOTY=","commit":{"author":{"name":"Dianne E. Richards","email":"dianner@apache.org","date":"2012-02-24T16:09:31Z"},"committer":{"name":"Dianne E. Richards","email":"dianner@apache.org","date":"2012-02-24T16:09:31Z"},"message":"OPENJPA-2142 Handle merge of new object with Entity Id field \n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1293315 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"5437dfd0f5f2e75026d1b26de3262a3b267a8ad7","url":"https://api.github.com/repos/apache/openjpa/git/trees/5437dfd0f5f2e75026d1b26de3262a3b267a8ad7"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c275da64abe546a9af2c28bb6245cb8a95754e96","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c275da64abe546a9af2c28bb6245cb8a95754e96","html_url":"https://github.com/apache/openjpa/commit/c275da64abe546a9af2c28bb6245cb8a95754e96","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c275da64abe546a9af2c28bb6245cb8a95754e96/comments","author":null,"committer":null,"parents":[{"sha":"d03434b5576f028adb1781cb0ff659ebd34e105b","url":"https://api.github.com/repos/apache/openjpa/commits/d03434b5576f028adb1781cb0ff659ebd34e105b","html_url":"https://github.com/apache/openjpa/commit/d03434b5576f028adb1781cb0ff659ebd34e105b"}],"stats":{"total":24,"additions":23,"deletions":1},"files":[{"sha":"ff43b29725eaf55b828df9806b8476de110d59b2","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachStrategy.java","status":"modified","additions":23,"deletions":1,"changes":24,"blob_url":"https://github.com/apache/openjpa/blob/c275da64abe546a9af2c28bb6245cb8a95754e96/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachStrategy.java","raw_url":"https://github.com/apache/openjpa/raw/c275da64abe546a9af2c28bb6245cb8a95754e96/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachStrategy.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/kernel/AttachStrategy.java?ref=c275da64abe546a9af2c28bb6245cb8a95754e96","patch":"@@ -92,8 +92,30 @@ else if (appId == null)\n         else // application identity: use existing fields\n             newInstance = pc.pcNewInstance(null, appId, false);\n \n-        return (StateManagerImpl) manager.getBroker().persist\n+        StateManagerImpl sm = (StateManagerImpl) manager.getBroker().persist\n             (newInstance, appId, explicit, manager.getBehavior(), !manager.getCopyNew());\n+        \n+        attachPCKeyFields(pc, sm, meta, manager);\n+        \n+        return sm;\n+    }\n+    \n+    private void attachPCKeyFields(PersistenceCapable fromPC, \n+        StateManagerImpl sm, ClassMetaData meta, AttachManager manager) {\n+        \n+        \n+        if (fromPC.pcGetStateManager() == null) {\n+            fromPC.pcReplaceStateManager(sm);\n+        \n+            FieldMetaData[] fmds = meta.getDefinedFields();\n+            for (FieldMetaData fmd : fmds) {\n+                if (fmd.isPrimaryKey() && fmd.getDeclaredTypeCode() == JavaTypes.PC) {\n+                    attachField(manager, fromPC, sm, fmd, true);\n+                }\n+            }\n+        \n+            fromPC.pcReplaceStateManager(null);\n+        }\n     }\n \n     /**"}]}

