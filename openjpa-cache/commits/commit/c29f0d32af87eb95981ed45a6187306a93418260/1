{"sha":"c29f0d32af87eb95981ed45a6187306a93418260","node_id":"MDY6Q29tbWl0MjA2MzY0OmMyOWYwZDMyYWY4N2ViOTU5ODFlZDQ1YTYxODczMDZhOTM0MTgyNjA=","commit":{"author":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2008-08-06T15:32:26Z"},"committer":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2008-08-06T15:32:26Z"},"message":"OPENJPA-676 close connection used for CONTIGUOUS or TRANSACTIONAL sequences\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.2.x@683298 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b7fad0cd8e9d7f90ba1d9ee4330e94c59a6b4d03","url":"https://api.github.com/repos/apache/openjpa/git/trees/b7fad0cd8e9d7f90ba1d9ee4330e94c59a6b4d03"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c29f0d32af87eb95981ed45a6187306a93418260","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c29f0d32af87eb95981ed45a6187306a93418260","html_url":"https://github.com/apache/openjpa/commit/c29f0d32af87eb95981ed45a6187306a93418260","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c29f0d32af87eb95981ed45a6187306a93418260/comments","author":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"committer":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"parents":[{"sha":"b1d18a3556f278fd5b2f198393e0e6869980bb5e","url":"https://api.github.com/repos/apache/openjpa/commits/b1d18a3556f278fd5b2f198393e0e6869980bb5e","html_url":"https://github.com/apache/openjpa/commit/b1d18a3556f278fd5b2f198393e0e6869980bb5e"}],"stats":{"total":22,"additions":18,"deletions":4},"files":[{"sha":"de0886da359355fdd43e348d9340ff88ad27b622","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","status":"modified","additions":17,"deletions":3,"changes":20,"blob_url":"https://github.com/apache/openjpa/blob/c29f0d32af87eb95981ed45a6187306a93418260/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","raw_url":"https://github.com/apache/openjpa/raw/c29f0d32af87eb95981ed45a6187306a93418260/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java?ref=c29f0d32af87eb95981ed45a6187306a93418260","patch":"@@ -25,6 +25,7 @@\n import javax.transaction.TransactionManager;\n \n import org.apache.openjpa.jdbc.conf.JDBCConfiguration;\n+import org.apache.openjpa.jdbc.kernel.JDBCStoreManager.RefCountConnection;\n import org.apache.openjpa.jdbc.meta.ClassMapping;\n import org.apache.openjpa.jdbc.schema.SchemaGroup;\n import org.apache.openjpa.jdbc.sql.SQLExceptions;\n@@ -156,8 +157,10 @@ private JDBCStore getStore(StoreContext ctx) {\n      */\n     protected Connection getConnection(JDBCStore store)\n         throws SQLException {\n-        if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS)\n+        if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS) {\n+            // Also increments ref count.\n             return store.getConnection();\n+        }\n         else {\n             JDBCConfiguration conf = store.getConfiguration();\n             DataSource ds = conf.getDataSource2(store.getContext());\n@@ -171,13 +174,24 @@ protected Connection getConnection(JDBCStore store)\n     /**\n      * Close the current connection. If the sequence is\n      * <code>TYPE_TRANSACTIONAL</code> or <code>TYPE_CONTIGUOUS</code>\n-     * nothing will be done. Otherwise the connection will be closed.\n+     * we will decrement the ref count. Otherwise the connection will be\n+     * committed and then closed. \n      */\n     protected void closeConnection(Connection conn) {\n         if (conn == null)\n             return;\n         if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS) {\n-            // do nothing; this seq is part of the business transaction\n+            // The seq is part of the business transaction however we need\n+            // to decrement the ref count so that the connection may be \n+            // closed appropriately.\n+            if(conn instanceof RefCountConnection) { \n+            \ttry { \n+            \t\t((RefCountConnection)conn).close();\n+            \t}\n+            \tcatch(SQLException se) { \n+            \t\tthrow SQLExceptions.getStore(se);\n+            \t}\n+            }\n             return;\n         }\n         else {"},{"sha":"4189e46016403a5651ecc4d59bd41b560c3bc77d","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/c29f0d32af87eb95981ed45a6187306a93418260/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/c29f0d32af87eb95981ed45a6187306a93418260/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/DBDictionary.java?ref=c29f0d32af87eb95981ed45a6187306a93418260","patch":"@@ -329,7 +329,7 @@\n     public String sequenceSchemaSQL = null;\n     public String sequenceNameSQL = null;\n     // most native sequences can be run inside the business transaction\n-    public int nativeSequenceType= Seq.TYPE_CONTIGUOUS;\n+    public int nativeSequenceType= Seq.TYPE_TRANSACTIONAL;\n \n     protected JDBCConfiguration conf = null;\n     protected Log log = null;"}]}

