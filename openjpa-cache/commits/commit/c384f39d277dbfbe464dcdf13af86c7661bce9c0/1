{"sha":"c384f39d277dbfbe464dcdf13af86c7661bce9c0","node_id":"MDY6Q29tbWl0MjA2MzY0OmMzODRmMzlkMjc3ZGJmYmU0NjRkY2RmMTNhZjg2Yzc2NjFiY2U5YzA=","commit":{"author":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-04-08T02:15:59Z"},"committer":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-04-08T02:15:59Z"},"message":"OPENJPA-1602: check in test case from trunk r931628 by Fay\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/2.0.x@931756 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"9174eb8b45fa641dea3dfbe93713b3af978ef84f","url":"https://api.github.com/repos/apache/openjpa/git/trees/9174eb8b45fa641dea3dfbe93713b3af978ef84f"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c384f39d277dbfbe464dcdf13af86c7661bce9c0","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c384f39d277dbfbe464dcdf13af86c7661bce9c0","html_url":"https://github.com/apache/openjpa/commit/c384f39d277dbfbe464dcdf13af86c7661bce9c0","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c384f39d277dbfbe464dcdf13af86c7661bce9c0/comments","author":null,"committer":null,"parents":[{"sha":"0cbc402296524c8725c51f6cec21b419b1dc36db","url":"https://api.github.com/repos/apache/openjpa/commits/0cbc402296524c8725c51f6cec21b419b1dc36db","html_url":"https://github.com/apache/openjpa/commit/0cbc402296524c8725c51f6cec21b419b1dc36db"}],"stats":{"total":25,"additions":25,"deletions":0},"files":[{"sha":"0f91668d3b9e17059c437e53b9d54ec8c30a8e90","filename":"openjpa-persistence-locking/src/test/java/org/apache/openjpa/persistence/lockmgr/TestPessimisticLocks.java","status":"modified","additions":25,"deletions":0,"changes":25,"blob_url":"https://github.com/apache/openjpa/blob/c384f39d277dbfbe464dcdf13af86c7661bce9c0/openjpa-persistence-locking/src/test/java/org/apache/openjpa/persistence/lockmgr/TestPessimisticLocks.java","raw_url":"https://github.com/apache/openjpa/raw/c384f39d277dbfbe464dcdf13af86c7661bce9c0/openjpa-persistence-locking/src/test/java/org/apache/openjpa/persistence/lockmgr/TestPessimisticLocks.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-locking/src/test/java/org/apache/openjpa/persistence/lockmgr/TestPessimisticLocks.java?ref=c384f39d277dbfbe464dcdf13af86c7661bce9c0","patch":"@@ -334,6 +334,31 @@ public void testQueryOrderByAfterFindWithPessimisticLocks() {\n         em2.close();\n     }\n \n+    /*\n+     * Test multiple execution of the same query with pessimistic lock.\n+     */\n+    public void testRepeatedQueryWithPessimisticLocks() {\n+        EntityManager em = emf.createEntityManager();\n+        resetSQL();\n+        em.getTransaction().begin();\n+        String jpql = \"select e.firstName from Employee e where e.id = 1\";\n+        Query q1 = em.createQuery(jpql);\n+        q1.setLockMode(LockModeType.PESSIMISTIC_WRITE);\n+        String firstName1 = (String) q1.getSingleResult();\n+        //Expected sql for Derby is:\n+        //SELECT t0.firstName FROM Employee t0 WHERE (t0.id = CAST(? AS BIGINT)) FOR UPDATE WITH RR\n+        String SQL1 = toString(sql);\n+        \n+        // run the second time\n+        resetSQL();\n+        Query q2 = em.createQuery(jpql);\n+        q2.setLockMode(LockModeType.PESSIMISTIC_WRITE);\n+        String firstName2 = (String) q2.getSingleResult();\n+        String SQL2 = toString(sql);\n+        assertEquals(SQL1, SQL2);\n+        em.getTransaction().commit();\n+    }\n+\n     /**\n      * Assert that an exception of proper type has been thrown. Also checks that\n      * that the exception has populated the failed object."}]}

