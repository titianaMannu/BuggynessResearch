{"sha":"c3bbb92557743928d045e1061360f3bfd48b182e","node_id":"MDY6Q29tbWl0MjA2MzY0OmMzYmJiOTI1NTc3NDM5MjhkMDQ1ZTEwNjEzNjBmM2JmZDQ4YjE4MmU=","commit":{"author":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-01T15:02:25Z"},"committer":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-01T15:02:25Z"},"message":"OPENJPA-2854 fix OffsetTime handling for PostgreSQL\n\nPostgreSQL doesn't natively support OffsetTime. While it has a column type\ntime with time zone it actually only stores the time as UTC time.","tree":{"sha":"a0b32471df08fa8115c3c1095ff07e32d41da339","url":"https://api.github.com/repos/apache/openjpa/git/trees/a0b32471df08fa8115c3c1095ff07e32d41da339"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c3bbb92557743928d045e1061360f3bfd48b182e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c3bbb92557743928d045e1061360f3bfd48b182e","html_url":"https://github.com/apache/openjpa/commit/c3bbb92557743928d045e1061360f3bfd48b182e","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c3bbb92557743928d045e1061360f3bfd48b182e/comments","author":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"committer":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"parents":[{"sha":"20faa3692c701052d510909d09c00abeae9a468a","url":"https://api.github.com/repos/apache/openjpa/commits/20faa3692c701052d510909d09c00abeae9a468a","html_url":"https://github.com/apache/openjpa/commit/20faa3692c701052d510909d09c00abeae9a468a"}],"stats":{"total":26,"additions":26,"deletions":0},"files":[{"sha":"a1d6ce99f24f5e5420a2f17106ecd2889c45010d","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java","status":"modified","additions":26,"deletions":0,"changes":26,"blob_url":"https://github.com/apache/openjpa/blob/c3bbb92557743928d045e1061360f3bfd48b182e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/c3bbb92557743928d045e1061360f3bfd48b182e/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java?ref=c3bbb92557743928d045e1061360f3bfd48b182e","patch":"@@ -38,6 +38,8 @@\n import java.time.LocalDateTime;\n import java.time.LocalTime;\n import java.time.OffsetDateTime;\n+import java.time.OffsetTime;\n+import java.time.ZoneOffset;\n import java.util.Arrays;\n import java.util.Date;\n import java.util.HashSet;\n@@ -750,6 +752,30 @@ public OffsetDateTime getOffsetDateTime(ResultSet rs, int column) throws SQLExce\n         return rs.getObject(column, OffsetDateTime.class);\n     }\n \n+    /**\n+     * default column type for OffsetTime is 'time with time zone'.\n+     * But opposed to the name PostgreSQL internally stores those values in UTC time\n+     * without any timezone.\n+     */\n+    @Override\n+    public void setOffsetTime(PreparedStatement stmnt, int idx, OffsetTime val, Column col) throws SQLException {\n+        // this is really a whacky hack somehow\n+        // PostgreSQL doesn't support OffsetTime natively.\n+        // The JDBC driver will automatically convert this to UTC which is the\n+        // internal normalised TimeZone PostgreSQL uses.\n+        LocalTime utcTime = val.withOffsetSameInstant(OffsetDateTime.now().getOffset()).toLocalTime();\n+        stmnt.setTime(idx, java.sql.Time.valueOf(utcTime));\n+    }\n+\n+    @Override\n+    public OffsetTime getOffsetTime(ResultSet rs, int column) throws SQLException {\n+        final java.sql.Time utcTime = rs.getTime(column);\n+        if (utcTime != null) {\n+            return utcTime.toLocalTime().atOffset(OffsetDateTime.now().getOffset());\n+        }\n+        return null;\n+    }\n+\n     @Override\n     public void setLocalDate(PreparedStatement stmnt, int idx, LocalDate val, Column col) throws SQLException {\n         stmnt.setObject(idx, val);"}]}

