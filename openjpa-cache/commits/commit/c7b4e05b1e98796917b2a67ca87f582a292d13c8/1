{"sha":"c7b4e05b1e98796917b2a67ca87f582a292d13c8","node_id":"MDY6Q29tbWl0MjA2MzY0OmM3YjRlMDViMWU5ODc5NjkxN2IyYTY3Y2E4N2Y1ODJhMjkyZDEzYzg=","commit":{"author":{"name":"Albert Lee","email":"allee8285@apache.org","date":"2013-06-24T17:23:56Z"},"committer":{"name":"Albert Lee","email":"allee8285@apache.org","date":"2013-06-24T17:23:56Z"},"message":"OPENJPA-2391 - commit patch contributed by Di Lau.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1496128 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"a295d94912eda4b3cd758b6eba92f9ed2d0dd85f","url":"https://api.github.com/repos/apache/openjpa/git/trees/a295d94912eda4b3cd758b6eba92f9ed2d0dd85f"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/c7b4e05b1e98796917b2a67ca87f582a292d13c8","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/c7b4e05b1e98796917b2a67ca87f582a292d13c8","html_url":"https://github.com/apache/openjpa/commit/c7b4e05b1e98796917b2a67ca87f582a292d13c8","comments_url":"https://api.github.com/repos/apache/openjpa/commits/c7b4e05b1e98796917b2a67ca87f582a292d13c8/comments","author":null,"committer":null,"parents":[{"sha":"123e28821e0f7a9850ae1d08b3934502b5030429","url":"https://api.github.com/repos/apache/openjpa/commits/123e28821e0f7a9850ae1d08b3934502b5030429","html_url":"https://github.com/apache/openjpa/commit/123e28821e0f7a9850ae1d08b3934502b5030429"}],"stats":{"total":24,"additions":22,"deletions":2},"files":[{"sha":"ba9d053ed73e41e7a6b3444924a34e5c384900e8","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/HSQLDictionary.java","status":"modified","additions":22,"deletions":2,"changes":24,"blob_url":"https://github.com/apache/openjpa/blob/c7b4e05b1e98796917b2a67ca87f582a292d13c8/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/HSQLDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/c7b4e05b1e98796917b2a67ca87f582a292d13c8/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/HSQLDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/HSQLDictionary.java?ref=c7b4e05b1e98796917b2a67ca87f582a292d13c8","patch":"@@ -18,6 +18,7 @@\n  */\n package org.apache.openjpa.jdbc.sql;\n \n+import java.lang.reflect.Field;\n import java.math.BigDecimal;\n import java.sql.Connection;\n import java.sql.DatabaseMetaData;\n@@ -27,7 +28,6 @@\n import java.util.Arrays;\n \n import org.apache.commons.lang.StringUtils;\n-import org.hsqldb.Trace;\n import org.apache.openjpa.jdbc.identifier.DBIdentifier;\n import org.apache.openjpa.jdbc.kernel.exps.FilterValue;\n import org.apache.openjpa.jdbc.schema.Column;\n@@ -51,6 +51,7 @@\n \n     private int dbMajorVersion;\n     private int dbMinorVersion;\n+    private int violation_of_unique_index_or_constraint;\n \n     private SQLBuffer _oneBuffer = new SQLBuffer(this).append(\"1\");\n \n@@ -118,6 +119,25 @@ public void connectedConfiguration(Connection conn) throws SQLException {\n         if (dbMajorVersion > 1 && dbMinorVersion > 0) {\n             nextSequenceQuery += \" LIMIT 1\";\n         }\n+        String packageName;\n+        String fieldName;\n+        if (dbMajorVersion > 1) {\n+            // default value for \"X_23505\"\n+            violation_of_unique_index_or_constraint = 104;\n+            packageName = \"org.hsqldb.error.ErrorCode\";\n+            fieldName = \"X_23505\";\n+        } else {\n+            // default value for \"VIOLATION_OF_UNIQUE_INDEX\"\n+            violation_of_unique_index_or_constraint = 9; \n+            packageName = \"org.hsqldb.Trace\";\n+            fieldName = \"VIOLATION_OF_UNIQUE_INDEX\";\n+        }\n+        try {\n+            Class<?> cls = Class.forName(packageName);\n+            Field fld = cls.getField(fieldName);\n+            violation_of_unique_index_or_constraint = fld.getInt(null);\n+        } catch (Exception e) {\n+        }\n     }\n \n     /**\n@@ -381,7 +401,7 @@ public OpenJPAException newStoreException(String msg, SQLException[] causes,\n         Object failed) {\n         OpenJPAException ke = super.newStoreException(msg, causes, failed);\n         if (ke instanceof ReferentialIntegrityException\n-            && causes[0].getErrorCode() == -Trace.VIOLATION_OF_UNIQUE_INDEX) {\n+            && causes[0].getErrorCode() == -violation_of_unique_index_or_constraint) {\n             ((ReferentialIntegrityException) ke).setIntegrityViolation\n                 (ReferentialIntegrityException.IV_UNIQUE);\n         }"}]}

