{"sha":"ce3f368ab0b7e56515803e55a399dc3f94e0f0b4","node_id":"MDY6Q29tbWl0MjA2MzY0OmNlM2YzNjhhYjBiN2U1NjUxNTgwM2U1NWEzOTlkYzNmOTRlMGYwYjQ=","commit":{"author":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2008-08-06T15:31:01Z"},"committer":{"name":"Michael Dick","email":"mikedd@apache.org","date":"2008-08-06T15:31:01Z"},"message":"OPENJPA-676 close connection used for CONTIGUOUS or TRANSACTIONAL sequences\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@683296 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"2c6a33016b21fcf89da538e0ef199381bfda5695","url":"https://api.github.com/repos/apache/openjpa/git/trees/2c6a33016b21fcf89da538e0ef199381bfda5695"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4","html_url":"https://github.com/apache/openjpa/commit/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4","comments_url":"https://api.github.com/repos/apache/openjpa/commits/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4/comments","author":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"committer":{"login":"mikedd","id":669432,"node_id":"MDQ6VXNlcjY2OTQzMg==","avatar_url":"https://avatars.githubusercontent.com/u/669432?v=4","gravatar_id":"","url":"https://api.github.com/users/mikedd","html_url":"https://github.com/mikedd","followers_url":"https://api.github.com/users/mikedd/followers","following_url":"https://api.github.com/users/mikedd/following{/other_user}","gists_url":"https://api.github.com/users/mikedd/gists{/gist_id}","starred_url":"https://api.github.com/users/mikedd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikedd/subscriptions","organizations_url":"https://api.github.com/users/mikedd/orgs","repos_url":"https://api.github.com/users/mikedd/repos","events_url":"https://api.github.com/users/mikedd/events{/privacy}","received_events_url":"https://api.github.com/users/mikedd/received_events","type":"User","site_admin":false},"parents":[{"sha":"e97d6d15985fa8f0100ee1e4931e5337ed497d65","url":"https://api.github.com/repos/apache/openjpa/commits/e97d6d15985fa8f0100ee1e4931e5337ed497d65","html_url":"https://github.com/apache/openjpa/commit/e97d6d15985fa8f0100ee1e4931e5337ed497d65"}],"stats":{"total":20,"additions":17,"deletions":3},"files":[{"sha":"de0886da359355fdd43e348d9340ff88ad27b622","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","status":"modified","additions":17,"deletions":3,"changes":20,"blob_url":"https://github.com/apache/openjpa/blob/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","raw_url":"https://github.com/apache/openjpa/raw/ce3f368ab0b7e56515803e55a399dc3f94e0f0b4/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/AbstractJDBCSeq.java?ref=ce3f368ab0b7e56515803e55a399dc3f94e0f0b4","patch":"@@ -25,6 +25,7 @@\n import javax.transaction.TransactionManager;\n \n import org.apache.openjpa.jdbc.conf.JDBCConfiguration;\n+import org.apache.openjpa.jdbc.kernel.JDBCStoreManager.RefCountConnection;\n import org.apache.openjpa.jdbc.meta.ClassMapping;\n import org.apache.openjpa.jdbc.schema.SchemaGroup;\n import org.apache.openjpa.jdbc.sql.SQLExceptions;\n@@ -156,8 +157,10 @@ private JDBCStore getStore(StoreContext ctx) {\n      */\n     protected Connection getConnection(JDBCStore store)\n         throws SQLException {\n-        if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS)\n+        if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS) {\n+            // Also increments ref count.\n             return store.getConnection();\n+        }\n         else {\n             JDBCConfiguration conf = store.getConfiguration();\n             DataSource ds = conf.getDataSource2(store.getContext());\n@@ -171,13 +174,24 @@ protected Connection getConnection(JDBCStore store)\n     /**\n      * Close the current connection. If the sequence is\n      * <code>TYPE_TRANSACTIONAL</code> or <code>TYPE_CONTIGUOUS</code>\n-     * nothing will be done. Otherwise the connection will be closed.\n+     * we will decrement the ref count. Otherwise the connection will be\n+     * committed and then closed. \n      */\n     protected void closeConnection(Connection conn) {\n         if (conn == null)\n             return;\n         if (type == TYPE_TRANSACTIONAL || type == TYPE_CONTIGUOUS) {\n-            // do nothing; this seq is part of the business transaction\n+            // The seq is part of the business transaction however we need\n+            // to decrement the ref count so that the connection may be \n+            // closed appropriately.\n+            if(conn instanceof RefCountConnection) { \n+            \ttry { \n+            \t\t((RefCountConnection)conn).close();\n+            \t}\n+            \tcatch(SQLException se) { \n+            \t\tthrow SQLExceptions.getStore(se);\n+            \t}\n+            }\n             return;\n         }\n         else {"}]}

