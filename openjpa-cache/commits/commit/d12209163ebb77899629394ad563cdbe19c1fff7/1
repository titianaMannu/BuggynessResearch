{"sha":"d12209163ebb77899629394ad563cdbe19c1fff7","node_id":"MDY6Q29tbWl0MjA2MzY0OmQxMjIwOTE2M2ViYjc3ODk5NjI5Mzk0YWQ1NjNjZGJlMTljMWZmZjc=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-11-22T21:47:18Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2010-11-22T21:47:18Z"},"message":"OPENJPA-1893: handle more than one join-column tag inside collection-table tag\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@1037899 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"143b6e4c5f8ea3b1609d89c4254099787b17394d","url":"https://api.github.com/repos/apache/openjpa/git/trees/143b6e4c5f8ea3b1609d89c4254099787b17394d"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/d12209163ebb77899629394ad563cdbe19c1fff7","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/d12209163ebb77899629394ad563cdbe19c1fff7","html_url":"https://github.com/apache/openjpa/commit/d12209163ebb77899629394ad563cdbe19c1fff7","comments_url":"https://api.github.com/repos/apache/openjpa/commits/d12209163ebb77899629394ad563cdbe19c1fff7/comments","author":null,"committer":null,"parents":[{"sha":"06f8dc4c96e94d4c6835d6722282759dde881acd","url":"https://api.github.com/repos/apache/openjpa/commits/06f8dc4c96e94d4c6835d6722282759dde881acd","html_url":"https://github.com/apache/openjpa/commit/06f8dc4c96e94d4c6835d6722282759dde881acd"}],"stats":{"total":242,"additions":241,"deletions":1},"files":[{"sha":"702d245dc5ef03f4821506b4862c1720130cbec3","filename":"openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","status":"modified","additions":5,"deletions":1,"changes":6,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/main/java/org/apache/openjpa/persistence/jdbc/XMLPersistenceMappingParser.java?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -907,7 +907,11 @@ private boolean startJoinColumn(Attributes attrs)\n         if (currentParent == COLLECTION_TABLE) {\n             FieldMapping fm = (FieldMapping) peekElement();\n             Column col = parseColumn(attrs);\n-            List<Column> colList = new ArrayList<Column>();\n+            List<Column> colList = fm.getMappingInfo().getColumns();\n+            if (colList.isEmpty()) {\n+                colList = new ArrayList<Column>();\n+                fm.getMappingInfo().setColumns(colList);\n+            }\n             colList.add(col);\n             fm.getMappingInfo().setColumns(colList);\n             return true;"},{"sha":"db2299357488c725304f53d89b317be5bd6d3e99","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/AttributeXml.java","status":"added","additions":44,"deletions":0,"changes":44,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/AttributeXml.java","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/AttributeXml.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/AttributeXml.java?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.embed;\n+\n+public class AttributeXml {\n+\tprivate String name;\n+\n+\tpublic String getName() {\n+\t\treturn name;\n+\t}\n+\n+\tpublic void setName(String id) {\n+\t\tthis.name = id;\n+\t}\n+\n+\tprivate String value;\n+\n+\tpublic String getValue() {\n+\t\treturn value;\n+\t}\n+\n+\tpublic void setValue(String value) {\n+\t\tthis.value = value;\n+\t}\n+\n+\tpublic AttributeXml() {\n+\t}\n+}"},{"sha":"5a83fdacddf17b1ee53a603254973da411a6ea64","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureIdXml.java","status":"added","additions":70,"deletions":0,"changes":70,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureIdXml.java","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureIdXml.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureIdXml.java?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.embed;\n+\n+import java.io.Serializable;\n+\n+public class FeatureIdXml implements Serializable {\n+\tprivate String oid;\n+\n+\tpublic String getOid() {\n+\t\treturn oid;\n+\t}\n+\n+\tpublic void setOid(String oid) {\n+\t\tthis.oid = oid;\n+\t}\n+\n+\tprivate int index;\n+\n+\tpublic int getIndex() {\n+\t\treturn index;\n+\t}\n+\n+\tpublic void setIndex(int feanum) {\n+\t\tthis.index = feanum;\n+\t}\n+\n+\tpublic boolean equals(Object other) {\n+\t\tif (this == other)\n+\t\t\treturn true;\n+\t\tif (other instanceof FeatureIdXml) {\n+\t\t\tFeatureIdXml castOther = (FeatureIdXml) other;\n+\t\t\treturn getIndex() == castOther.getIndex()\n+\t\t\t\t\t&& getOid().equals(castOther.getOid());\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n+\tpublic int hashCode() {\n+\t\treturn getIndex() + getOid().hashCode();\n+\t}\n+\n+\tpublic String toString() {\n+\t\treturn getOid() + \"#\" + getIndex();\n+\t}\n+\n+\tpublic FeatureIdXml() {\n+\t}\n+\n+    public FeatureIdXml(int idx, String oid) {\n+        index = idx;\n+        this.oid = oid;\n+    }\n+}"},{"sha":"56969822720a8ca2801246fb1b28a82ae9d95b2f","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureXml.java","status":"added","additions":47,"deletions":0,"changes":47,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureXml.java","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureXml.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/FeatureXml.java?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -0,0 +1,47 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.    \n+ */\n+package org.apache.openjpa.persistence.embed;\n+\n+import java.util.List;\n+\n+public class FeatureXml {\n+\n+\tprivate FeatureIdXml id;\n+\n+\tpublic FeatureIdXml getId() {\n+\t\treturn id;\n+\t}\n+\n+\tpublic void setId(FeatureIdXml id) {\n+\t\tthis.id = id;\n+\t}\n+\n+\tprivate List<AttributeXml> attributes;\n+\n+\tpublic List<AttributeXml> getAttributes() {\n+\t\treturn attributes;\n+\t}\n+\n+\tpublic void setAttributes(List<AttributeXml> attributes) {\n+\t\tthis.attributes = attributes;\n+\t}\n+\n+\tpublic FeatureXml() {\n+\t}\n+}"},{"sha":"681d58906d71f694a7dcab196b62ace1df00a248","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddableXml.java","status":"modified","additions":48,"deletions":0,"changes":48,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddableXml.java","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddableXml.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/embed/TestEmbeddableXml.java?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -18,6 +18,7 @@\n  */\n package org.apache.openjpa.persistence.embed;\n \n+import java.util.ArrayList;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n@@ -70,6 +71,53 @@ protected String getPersistenceUnitName() {\n         return \"embed-pu\";\n     }\n     \n+    public void testJoinColumns() {\n+        createFeatureXml();\n+        EntityManager em = emf.createEntityManager();\n+        String jpql = \"Select f from Feature f Join fetch f.attributes\";\n+        Query q = em.createQuery(jpql);\n+        List<FeatureXml> fList = (List<FeatureXml>) q.getResultList();\n+        for (FeatureXml f : fList) {\n+            List<AttributeXml> aList = f.getAttributes();;\n+            assertEquals(1, aList.size());\n+        }\n+        em.close();\n+    }\n+    \n+    public void createFeatureXml() {\n+        EntityManager em = emf.createEntityManager();\n+        EntityTransaction tran = em.getTransaction();\n+        tran.begin();\n+        FeatureXml f = new FeatureXml();\n+        FeatureIdXml fid = new FeatureIdXml();\n+        fid.setIndex(1);\n+        fid.setOid(\"oid\");\n+        f.setId(fid);\n+        AttributeXml a = new AttributeXml();\n+        a.setName(\"name1\");\n+        a.setValue(\"value1\");\n+        List<AttributeXml> aList = new ArrayList<AttributeXml>();\n+        aList.add(a);\n+        f.setAttributes(aList);\n+        em.persist(f);\n+        \n+        FeatureXml f1 = new FeatureXml();\n+        FeatureIdXml fid1 = new FeatureIdXml();\n+        fid1.setIndex(1);\n+        fid1.setOid(\"oid1\");\n+        f1.setId(fid1);\n+        AttributeXml a1 = new AttributeXml();\n+        a1.setName(\"name1\");\n+        a1.setValue(\"value1\");\n+        List<AttributeXml> aList1 = new ArrayList<AttributeXml>();\n+        aList1.add(a1);\n+        f1.setAttributes(aList1);\n+        em.persist(f1);\n+        \n+        tran.commit();       \n+        em.close();\n+    }\n+    \n     public void testEntityA_Coll_StringXml() {\n         createEntityA_Coll_StringXml();\n         queryEntityA_Coll_StringXml();"},{"sha":"7e2ba7c25cc086ef428c3abad24b5abc236b11af","filename":"openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-orm.xml","status":"modified","additions":27,"deletions":0,"changes":27,"blob_url":"https://github.com/apache/openjpa/blob/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-orm.xml","raw_url":"https://github.com/apache/openjpa/raw/d12209163ebb77899629394ad563cdbe19c1fff7/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-orm.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/resources/org/apache/openjpa/persistence/embed/embed-orm.xml?ref=d12209163ebb77899629394ad563cdbe19c1fff7","patch":"@@ -216,6 +216,33 @@ version=\"2.0\">\n         </attributes>\n     </entity>    \n \n+\t<entity class=\"org.apache.openjpa.persistence.embed.FeatureXml\">\n+\t\t<table name=\"features\" />\n+\t\t<attributes>\n+\t\t\t<embedded-id name=\"id\" />\n+\t\t\t<element-collection name=\"attributes\">\n+\t\t\t\t<collection-table name=\"qualifiers\">\n+\t\t\t\t\t<join-column name=\"FEATURE_INDEX\" referenced-column-name = \"index\"/>\n+\t\t\t\t\t<join-column name=\"FEATURE_OID\" referenced-column-name=\"oid\"  />\n+\t\t\t\t</collection-table>\n+\t\t\t</element-collection>\n+\t\t</attributes>\n+\t</entity>     \n+\n+\t<embeddable class=\"org.apache.openjpa.persistence.embed.AttributeXml\">\n+\t\t<attributes>\n+\t\t\t<basic name=\"name\"></basic>\n+\t\t\t<basic name=\"value\"></basic>\n+\t\t</attributes>\n+\t</embeddable>\n+\n+\t<embeddable class=\"org.apache.openjpa.persistence.embed.FeatureIdXml\">\n+\t\t<attributes>\n+\t\t\t<basic name=\"oid\"></basic>\n+\t\t\t<basic name=\"index\"></basic>\n+\t\t</attributes>\n+\t</embeddable>\n+\n     <embeddable \n         class=\"org.apache.openjpa.persistence.embed.attrOverrides.AddressXml\" \n         access=\"FIELD\">"}]}

