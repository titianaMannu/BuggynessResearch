{"sha":"d9039ca64064c99558efd6db6d15c4028ad63236","node_id":"MDY6Q29tbWl0MjA2MzY0OmQ5MDM5Y2E2NDA2NGM5OTU1OGVmZDZkYjZkMTVjNDAyOGFkNjMyMzY=","commit":{"author":{"name":"Jeremy Bauer","email":"jrbauer@apache.org","date":"2009-04-17T03:15:38Z"},"committer":{"name":"Jeremy Bauer","email":"jrbauer@apache.org","date":"2009-04-17T03:15:38Z"},"message":"OPENJPA-1029 SQLServerDictionary updates contributed by Donald Woods\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@765841 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"dfb8aec1d4b9f7480fb31bfef785e7d44e36bdbc","url":"https://api.github.com/repos/apache/openjpa/git/trees/dfb8aec1d4b9f7480fb31bfef785e7d44e36bdbc"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/d9039ca64064c99558efd6db6d15c4028ad63236","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/d9039ca64064c99558efd6db6d15c4028ad63236","html_url":"https://github.com/apache/openjpa/commit/d9039ca64064c99558efd6db6d15c4028ad63236","comments_url":"https://api.github.com/repos/apache/openjpa/commits/d9039ca64064c99558efd6db6d15c4028ad63236/comments","author":null,"committer":null,"parents":[{"sha":"e4b87fd6b34dfb2b508b387bf8e365507509eb4f","url":"https://api.github.com/repos/apache/openjpa/commits/e4b87fd6b34dfb2b508b387bf8e365507509eb4f","html_url":"https://github.com/apache/openjpa/commit/e4b87fd6b34dfb2b508b387bf8e365507509eb4f"}],"stats":{"total":86,"additions":55,"deletions":31},"files":[{"sha":"e83cd000162b1246ee1f7c054ac719780e924d05","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLServerDictionary.java","status":"modified","additions":55,"deletions":31,"changes":86,"blob_url":"https://github.com/apache/openjpa/blob/d9039ca64064c99558efd6db6d15c4028ad63236/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLServerDictionary.java","raw_url":"https://github.com/apache/openjpa/raw/d9039ca64064c99558efd6db6d15c4028ad63236/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLServerDictionary.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/SQLServerDictionary.java?ref=d9039ca64064c99558efd6db6d15c4028ad63236","patch":"@@ -64,49 +64,73 @@ public SQLServerDictionary() {\n     public void connectedConfiguration(Connection conn)\n         throws SQLException {\n         super.connectedConfiguration(conn);\n-\n+        boolean requiresWarnings = true;\n         DatabaseMetaData meta = conn.getMetaData();\n         String driverName = meta.getDriverName();\n         String url = meta.getURL();\n         if (driverVendor == null) {\n-            if (\"NetDirect JSQLConnect\".equals(driverName))\n-                driverVendor = VENDOR_NETDIRECT;\n-            else if (driverName != null && driverName.startsWith(\"jTDS\"))\n-                driverVendor = VENDOR_JTDS;\n-            else if (\"SQLServer\".equals(driverName)) {\n-                if (url != null && url.startsWith(\"jdbc:microsoft:sqlserver:\"))\n-                    driverVendor = VENDOR_MICROSOFT;\n-                else if (url != null\n-                    && url.startsWith(\"jdbc:datadirect:sqlserver:\"))\n-                    driverVendor = VENDOR_DATADIRECT;\n-                else\n-                    driverVendor = VENDOR_OTHER;\n-            } else\n+            if (driverName != null) {\n+                if (driverName.startsWith(\"Microsoft SQL Server\")) {\n+                    // v1.1, 1.2 or 2.0 driver\n+                    driverVendor = VENDOR_MICROSOFT;                \n+                    // serverMajorVersion of 8==2000, 9==2005, 10==2008\n+                    if (meta.getDatabaseMajorVersion() >= 9)\n+                        supportsXMLColumn = true;\n+                    if (meta.getDriverMajorVersion() >= 2) {\n+                        // see http://blogs.msdn.com/jdbcteam/archive/2007/05/\\\n+                        // 02/what-is-adaptive-response-buffering-and-why-\\\n+                        // should-i-use-it.aspx\n+                        // 2.0 driver connectURL automatically includes \n+                        // responseBuffering=adaptive\n+                        // and disableStatementPooling=true\n+                        requiresWarnings = false;\n+                    }\n+                } else {\n+                    if (\"NetDirect JSQLConnect\".equals(driverName))\n+                        driverVendor = VENDOR_NETDIRECT;\n+                    else if (driverName.startsWith(\"jTDS\"))\n+                        driverVendor = VENDOR_JTDS;\n+                    else if (\"SQLServer\".equals(driverName)) {\n+                        if (url != null &&\n+                            url.startsWith(\"jdbc:microsoft:sqlserver:\"))\n+                            driverVendor = VENDOR_MICROSOFT;\n+                        else if (url != null\n+                            && url.startsWith(\"jdbc:datadirect:sqlserver:\"))\n+                            driverVendor = VENDOR_DATADIRECT;\n+                        else\n+                            driverVendor = VENDOR_OTHER;\n+                    }\n+                    // old way of determining xml support\n+                    if (driverName.indexOf(platform) != -1) {\n+                        String versionString = driverName.\n+                            substring(platform.length() + 1);\n+                        if (versionString.indexOf(\" \") != -1)\n+                            versionString = versionString.substring(0,\n+                                versionString.indexOf(\" \"));\n+                        int version = Integer.parseInt(versionString);\n+                        if (version >= 2005)\n+                            supportsXMLColumn = true;\n+                    }\n+                }\n+            } else {\n                 driverVendor = VENDOR_OTHER;\n-            if (driverName.indexOf(platform) != -1) {\n-                String versionString = driverName.\n-                    substring(platform.length() + 1);\n-                if (versionString.indexOf(\" \") != -1)\n-                    versionString = versionString.substring(0,\n-                        versionString.indexOf(\" \"));\n-                int version = Integer.parseInt(versionString);\n-                if (version >= 2005)\n-                    supportsXMLColumn = true;\n             }\n         }\n \n-        // warn about using cursors\n-        if ((VENDOR_MICROSOFT.equalsIgnoreCase(driverVendor)\n+        // warn about not using cursors for pre-2.0 MS driver\n+        // as connectURL includes selectMethod=direct\n+        if (((VENDOR_MICROSOFT.equalsIgnoreCase(driverVendor)\n+            && requiresWarnings) \n             || VENDOR_DATADIRECT.equalsIgnoreCase(driverVendor))\n-            && url.toLowerCase().indexOf(\"selectmethod=cursor\") == -1)\n+            && (url.toLowerCase().indexOf(\"selectmethod=cursor\") == -1))\n             log.warn(_loc.get(\"sqlserver-cursor\", url));\n \n-        // warn about prepared statement caching if using ms driver\n+        // warn about prepared statement caching if using pre-2.0 MS drivers\n+        // as connectURL includes responseBuffering=full\n         String props = conf.getConnectionFactoryProperties();\n-        if (props == null)\n-            props = \"\";\n-        if (VENDOR_MICROSOFT.equalsIgnoreCase(driverVendor)\n-            && props.toLowerCase().indexOf(\"maxcachedstatements=0\") == -1)\n+        if ((props != null) && \n+            VENDOR_MICROSOFT.equalsIgnoreCase(driverVendor) && requiresWarnings\n+            && (props.toLowerCase().indexOf(\"maxcachedstatements=0\") == -1))\n             log.warn(_loc.get(\"sqlserver-cachedstmnts\"));\n     }\n "}]}

