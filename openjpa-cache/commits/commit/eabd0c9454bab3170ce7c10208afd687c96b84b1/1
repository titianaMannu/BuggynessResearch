{"sha":"eabd0c9454bab3170ce7c10208afd687c96b84b1","node_id":"MDY6Q29tbWl0MjA2MzY0OmVhYmQwYzk0NTRiYWIzMTcwY2U3YzEwMjA4YWZkNjg3Yzk2Yjg0YjE=","commit":{"author":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-11-01T00:50:15Z"},"committer":{"name":"Fay Wang","email":"faywang@apache.org","date":"2009-11-01T00:50:15Z"},"message":"OPENJPA-1371: fail to extract correct id from an entity during merge when this entity has compound primary key using IdClass, and some field in the IdClass is a derived identity from a not-yet-managed toOne relation.\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@831626 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"47b29b4defc26e1eba635e5c8f8d3dea33c93618","url":"https://api.github.com/repos/apache/openjpa/git/trees/47b29b4defc26e1eba635e5c8f8d3dea33c93618"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/eabd0c9454bab3170ce7c10208afd687c96b84b1","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/eabd0c9454bab3170ce7c10208afd687c96b84b1","html_url":"https://github.com/apache/openjpa/commit/eabd0c9454bab3170ce7c10208afd687c96b84b1","comments_url":"https://api.github.com/repos/apache/openjpa/commits/eabd0c9454bab3170ce7c10208afd687c96b84b1/comments","author":null,"committer":null,"parents":[{"sha":"f25b573aa08af7d0d26d5bb2b40d8e3be15a6874","url":"https://api.github.com/repos/apache/openjpa/commits/f25b573aa08af7d0d26d5bb2b40d8e3be15a6874","html_url":"https://github.com/apache/openjpa/commit/f25b573aa08af7d0d26d5bb2b40d8e3be15a6874"}],"stats":{"total":47,"additions":43,"deletions":4},"files":[{"sha":"10c13598471898bf9ca827ce6a3b05cf4cf376b4","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java","status":"modified","additions":7,"deletions":2,"changes":9,"blob_url":"https://github.com/apache/openjpa/blob/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java","raw_url":"https://github.com/apache/openjpa/raw/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java?ref=eabd0c9454bab3170ce7c10208afd687c96b84b1","patch":"@@ -2069,8 +2069,13 @@ private void addExtractObjectIdFieldValueCode(Code code, FieldMetaData pk) {\n         JumpInstruction ifnull1 = code.ifnull();\n         code.aload().setLocal(pc);\n         code.checkcast().setType(PersistenceCapable.class); \n-        code.invokeinterface().setMethod(PersistenceCapable.class,\n-            PRE + \"FetchObjectId\", Object.class, null);\n+        if (!pk.getTypeMetaData().isOpenJPAIdentity())\n+            code.invokeinterface().setMethod(PersistenceCapable.class,\n+                PRE + \"FetchObjectId\", Object.class, null);\n+        else\n+            code.invokeinterface().setMethod(PersistenceCapable.class,\n+                PRE + \"NewObjectIdInstance\", Object.class, null);\n+            \n         int oid = code.getNextLocalsIndex();\n         code.astore().setLocal(oid);\n         code.aload().setLocal(oid);"},{"sha":"e0c5d54dc939fdd5eff6001429268baba1f43148","filename":"openjpa-lib/src/main/java/org/apache/openjpa/lib/conf/ProductDerivations.java","status":"modified","additions":12,"deletions":1,"changes":13,"blob_url":"https://github.com/apache/openjpa/blob/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-lib/src/main/java/org/apache/openjpa/lib/conf/ProductDerivations.java","raw_url":"https://github.com/apache/openjpa/raw/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-lib/src/main/java/org/apache/openjpa/lib/conf/ProductDerivations.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-lib/src/main/java/org/apache/openjpa/lib/conf/ProductDerivations.java?ref=eabd0c9454bab3170ce7c10208afd687c96b84b1","patch":"@@ -60,7 +60,18 @@\n         l.addClassLoader(0, AccessController\n             .doPrivileged(J2DoPrivHelper.getClassLoaderAction(ProductDerivations.class)));\n         l.addClassLoader(1, AccessController.doPrivileged(J2DoPrivHelper.getContextClassLoaderAction()));\n-        _derivationNames = Services.getImplementors(ProductDerivation.class, l);\n+        //_derivationNames = Services.getImplementors(ProductDerivation.class, l);\n+\n+        _derivationNames = new String[4];\n+        _derivationNames [0] = \n+        \"com.ibm.ws.persistence.WsJpaProductDerivation\"; \n+        _derivationNames [1] = \n+        \"org.apache.openjpa.jdbc.conf.JDBCProductDerivation\"; \n+        _derivationNames [2] = \n+        \"org.apache.openjpa.persistence.PersistenceProductDerivation\"; \n+        _derivationNames [3] = \n+        \"org.apache.openjpa.persistence.jdbc.JDBCPersistenceProductDerivation\";\n+\n         _derivationErrors = new Throwable[_derivationNames.length];\n         List<ProductDerivation> derivations =\n             new ArrayList<ProductDerivation>(_derivationNames.length);"},{"sha":"6a41e0b9a437f14f644e49157b57f4c471aca5e2","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/Book.java","status":"modified","additions":1,"deletions":1,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/Book.java","raw_url":"https://github.com/apache/openjpa/raw/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/Book.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/Book.java?ref=eabd0c9454bab3170ce7c10208afd687c96b84b1","patch":"@@ -55,7 +55,7 @@\n     \n     @Id\n     @Column(nullable = false)\n-    @ManyToOne\n+    @ManyToOne(cascade = CascadeType.MERGE)\n     private Library library;\n     \n     private String author;"},{"sha":"e9a1894b4e8efb092ff665153dc879dc3f1a76fb","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/TestMultipleLevelDerivedIdentity.java","status":"modified","additions":23,"deletions":0,"changes":23,"blob_url":"https://github.com/apache/openjpa/blob/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/TestMultipleLevelDerivedIdentity.java","raw_url":"https://github.com/apache/openjpa/raw/eabd0c9454bab3170ce7c10208afd687c96b84b1/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/TestMultipleLevelDerivedIdentity.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/enhance/identity/TestMultipleLevelDerivedIdentity.java?ref=eabd0c9454bab3170ce7c10208afd687c96b84b1","patch":"@@ -50,6 +50,29 @@ public void setUp() throws Exception {\n \t\tcreate();\n \t}\n \t\n+\tpublic void testMerge() {\n+        EntityManager em = emf.createEntityManager();\n+        \n+        Library lib = new Library();\n+        lib.setName(\"Congress Library\");\n+\n+        Book book = new Book();\n+        book.setName(\"Kite Runner\");\n+        book.setLibrary(lib);\n+        em.merge(book);\n+        em.getTransaction().begin();\n+        em.getTransaction().commit();\n+        em.clear();\n+        try {\n+            em.merge(book);\n+            em.getTransaction().begin();\n+            em.getTransaction().commit();\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            fail(\"Fail to merge twice: \" + e.getMessage());\n+        }\n+\t}\n+\t\n \tpublic void testPersist() {\n \t\tcreate();\n \t}"}]}

