{"sha":"eaf25282aa910886487e42e3b9c835bb461887f2","node_id":"MDY6Q29tbWl0MjA2MzY0OmVhZjI1MjgyYWE5MTA4ODY0ODdlNDJlM2I5YzgzNWJiNDYxODg3ZjI=","commit":{"author":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2009-12-08T18:46:40Z"},"committer":{"name":"Richard G. Curtis","email":"curtisr7@apache.org","date":"2009-12-08T18:46:40Z"},"message":"OPENJPA-1421: Reduce lock contention in JDBCStoreManager\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/branches/1.2.x@888513 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"b41ff773dd7db2e238ab51fc58486d48b60240a5","url":"https://api.github.com/repos/apache/openjpa/git/trees/b41ff773dd7db2e238ab51fc58486d48b60240a5"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/eaf25282aa910886487e42e3b9c835bb461887f2","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/eaf25282aa910886487e42e3b9c835bb461887f2","html_url":"https://github.com/apache/openjpa/commit/eaf25282aa910886487e42e3b9c835bb461887f2","comments_url":"https://api.github.com/repos/apache/openjpa/commits/eaf25282aa910886487e42e3b9c835bb461887f2/comments","author":null,"committer":null,"parents":[{"sha":"f2e51da5971b1840fd78cb9f8ef267f103dd64b7","url":"https://api.github.com/repos/apache/openjpa/commits/f2e51da5971b1840fd78cb9f8ef267f103dd64b7","html_url":"https://github.com/apache/openjpa/commit/f2e51da5971b1840fd78cb9f8ef267f103dd64b7"}],"stats":{"total":21,"additions":14,"deletions":7},"files":[{"sha":"d1eda4e92084551003ff194530a53dfeb60652df","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreManager.java","status":"modified","additions":7,"deletions":3,"changes":10,"blob_url":"https://github.com/apache/openjpa/blob/eaf25282aa910886487e42e3b9c835bb461887f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreManager.java","raw_url":"https://github.com/apache/openjpa/raw/eaf25282aa910886487e42e3b9c835bb461887f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreManager.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreManager.java?ref=eaf25282aa910886487e42e3b9c835bb461887f2","patch":"@@ -502,15 +502,19 @@ private Result getInitializeStateResult(OpenJPAStateManager sm,\n         if (sel == null) return null;\n         return sel.execute(this, fetch, params);\n     }\n-\n+    \n+    Map<SelectKey, Select> selectImplCacheMap = null;\n     private Select newSelect(OpenJPAStateManager sm,\n         ClassMapping mapping, JDBCFetchConfiguration fetch, int subs,\n         List params) {\n         if (!_isQuerySQLCache) \n             return newSelect(sm, mapping, fetch, subs);       \n            \n-        Map<SelectKey, Select> selectImplCacheMap = \n-            getCacheMapFromQuerySQLCache(JDBCStoreManager.class);\n+        if (selectImplCacheMap == null) {\n+            selectImplCacheMap =\n+                getCacheMapFromQuerySQLCache(JDBCStoreManager.class);\n+        }\n+         \n         JDBCFetchConfiguration fetchClone = new JDBCFetchConfigurationImpl();\n         fetchClone.copy(fetch);\n         SelectKey selKey = new SelectKey(mapping, null, fetchClone);"},{"sha":"2ef9aa273cf75cfd5d0599e2a12a8a4f14c46682","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/meta/strats/RelationFieldStrategy.java","status":"modified","additions":7,"deletions":4,"changes":11,"blob_url":"https://github.com/apache/openjpa/blob/eaf25282aa910886487e42e3b9c835bb461887f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/meta/strats/RelationFieldStrategy.java","raw_url":"https://github.com/apache/openjpa/raw/eaf25282aa910886487e42e3b9c835bb461887f2/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/meta/strats/RelationFieldStrategy.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/meta/strats/RelationFieldStrategy.java?ref=eaf25282aa910886487e42e3b9c835bb461887f2","patch":"@@ -598,7 +598,8 @@ public void load(OpenJPAStateManager sm, JDBCStore store,\n         else\n             sm.setIntermediate(field.getIndex(), oid);\n     }\n-\n+    \n+    Map<JDBCStoreManager.SelectKey, Object[]> relationFieldUnionCache = null;\n     public void load(final OpenJPAStateManager sm, final JDBCStore store,\n         final JDBCFetchConfiguration fetch)\n         throws SQLException {\n@@ -625,9 +626,11 @@ public void load(final OpenJPAStateManager sm, final JDBCStore store,\n         if (!((JDBCStoreManager)store).isQuerySQLCacheOn())\n             union = newUnion(sm, store, fetch, rels, subs, resJoins);\n         else {\n-            Map<JDBCStoreManager.SelectKey, Object[]> relationFieldUnionCache = \n-                ((JDBCStoreManager)store).getCacheMapFromQuerySQLCache(\n-                RelationFieldStrategy.class);\n+            if (relationFieldUnionCache == null) {\n+                relationFieldUnionCache =\n+                    ((JDBCStoreManager) store)\n+                        .getCacheMapFromQuerySQLCache(RelationFieldStrategy.class);\n+            }\n             boolean found = true;\n             JDBCFetchConfiguration fetchClone = new JDBCFetchConfigurationImpl();\n             fetchClone.copy(fetch);"}]}

