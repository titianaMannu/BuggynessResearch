{"sha":"eb2dbec1273e52d4258ed2b183106ca8d098ed94","node_id":"MDY6Q29tbWl0MjA2MzY0OmViMmRiZWMxMjczZTUyZDQyNThlZDJiMTgzMTA2Y2E4ZDA5OGVkOTQ=","commit":{"author":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-18T21:05:50Z"},"committer":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-04-18T21:05:50Z"},"message":"OPENJPA-2789 close connection after bulk delete\n\nwhile ResultSetResult closes the underlying connection we did loose this handling in\nJDBCStoreQuery when XROP sharding got added.","tree":{"sha":"0d3f9ce63f5893dbc5aeec47d7ef2744ebfbdf2b","url":"https://api.github.com/repos/apache/openjpa/git/trees/0d3f9ce63f5893dbc5aeec47d7ef2744ebfbdf2b"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/eb2dbec1273e52d4258ed2b183106ca8d098ed94","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/eb2dbec1273e52d4258ed2b183106ca8d098ed94","html_url":"https://github.com/apache/openjpa/commit/eb2dbec1273e52d4258ed2b183106ca8d098ed94","comments_url":"https://api.github.com/repos/apache/openjpa/commits/eb2dbec1273e52d4258ed2b183106ca8d098ed94/comments","author":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"committer":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"parents":[{"sha":"d5ac99d402df5129e686deee563106f9e66c11c1","url":"https://api.github.com/repos/apache/openjpa/commits/d5ac99d402df5129e686deee563106f9e66c11c1","html_url":"https://github.com/apache/openjpa/commit/d5ac99d402df5129e686deee563106f9e66c11c1"}],"stats":{"total":53,"additions":51,"deletions":2},"files":[{"sha":"ce69d3634bd2d872d560b5d96d658baa5bf78980","filename":"openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreQuery.java","status":"modified","additions":1,"deletions":2,"changes":3,"blob_url":"https://github.com/apache/openjpa/blob/eb2dbec1273e52d4258ed2b183106ca8d098ed94/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreQuery.java","raw_url":"https://github.com/apache/openjpa/raw/eb2dbec1273e52d4258ed2b183106ca8d098ed94/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreQuery.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/kernel/JDBCStoreQuery.java?ref=eb2dbec1273e52d4258ed2b183106ca8d098ed94","patch":"@@ -603,8 +603,7 @@ private Number executeBulkOperation(ClassMetaData[] metas,\n             }\n         } finally {\n             try {\n-            \tif (conn.getAutoCommit())\n-            \t\tconn.close();\n+                conn.close();\n             } catch (SQLException se) {\n \n             }"},{"sha":"9d4586305b550d164e106e881f896a678299d681","filename":"openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestBulkDelete.java","status":"added","additions":50,"deletions":0,"changes":50,"blob_url":"https://github.com/apache/openjpa/blob/eb2dbec1273e52d4258ed2b183106ca8d098ed94/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestBulkDelete.java","raw_url":"https://github.com/apache/openjpa/raw/eb2dbec1273e52d4258ed2b183106ca8d098ed94/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestBulkDelete.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-persistence-jdbc/src/test/java/org/apache/openjpa/persistence/kernel/TestBulkDelete.java?ref=eb2dbec1273e52d4258ed2b183106ca8d098ed94","patch":"@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.openjpa.persistence.kernel;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.TypedQuery;\n+\n+import org.apache.openjpa.persistence.common.utils.AbstractTestCase;\n+import org.apache.openjpa.persistence.kernel.common.apps.CalendarFields;\n+import org.apache.openjpa.persistence.kernel.common.apps.RuntimeTest1;\n+\n+/**\n+ * OPENJPA-2789 connection didn't get closed properly\n+ */\n+public class TestBulkDelete extends AbstractTestCase {\n+\n+\n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp(CalendarFields.class);\n+    }\n+\n+    public void testConnectionClosing() throws Exception {\n+        for (int i = 0; i < 30; i++) {\n+            EntityManager em = getEmf().createEntityManager();\n+            em.getTransaction().begin();\n+            final TypedQuery<CalendarFields> qry\n+                        = em.createQuery(\"delete from CalendarFields e where e.id = :val\", CalendarFields.class);\n+            qry.setParameter(\"val\", 12345);\n+            qry.executeUpdate();\n+\n+            em.getTransaction().commit();\n+            em.close();\n+        }\n+    }\n+}"}]}

