{"sha":"eef64ccd69c48ba8c7193509f6f621c6315bc74e","node_id":"MDY6Q29tbWl0MjA2MzY0OmVlZjY0Y2NkNjljNDhiYThjNzE5MzUwOWY2ZjYyMWM2MzE1YmM3NGU=","commit":{"author":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2020-12-02T11:12:13Z"},"committer":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2020-12-02T11:12:13Z"},"message":"OPENJPA-2843 remove ibm specific dependencies\n\nWe now hav a single interface which I've implemented clean-room from the bytecode.\nThis class will NOT get packaged into the jar but will be excluded.","tree":{"sha":"4ceb873c4af42c7b72997b69073279ff0b8e021c","url":"https://api.github.com/repos/apache/openjpa/git/trees/4ceb873c4af42c7b72997b69073279ff0b8e021c"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/eef64ccd69c48ba8c7193509f6f621c6315bc74e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/eef64ccd69c48ba8c7193509f6f621c6315bc74e","html_url":"https://github.com/apache/openjpa/commit/eef64ccd69c48ba8c7193509f6f621c6315bc74e","comments_url":"https://api.github.com/repos/apache/openjpa/commits/eef64ccd69c48ba8c7193509f6f621c6315bc74e/comments","author":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"committer":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"parents":[{"sha":"939f754e373cb723699b7c36166f9fea1e98dcc8","url":"https://api.github.com/repos/apache/openjpa/commits/939f754e373cb723699b7c36166f9fea1e98dcc8","html_url":"https://github.com/apache/openjpa/commit/939f754e373cb723699b7c36166f9fea1e98dcc8"}],"stats":{"total":88,"additions":62,"deletions":26},"files":[{"sha":"9168694a9c71424501402bdafdd17d142893ea3f","filename":"openjpa-kernel/pom.xml","status":"modified","additions":5,"deletions":13,"changes":18,"blob_url":"https://github.com/apache/openjpa/blob/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/pom.xml?ref=eef64ccd69c48ba8c7193509f6f621c6315bc74e","patch":"@@ -56,12 +56,6 @@\n             <groupId>org.apache.commons</groupId>\n             <artifactId>commons-pool2</artifactId>\n         </dependency>\n-        <dependency>\n-            <groupId>com.ibm.websphere</groupId>\n-            <artifactId>uow_api</artifactId>\n-            <version>6</version>\n-            <scope>provided</scope>\n-        </dependency>\n         <dependency>\n             <groupId>org.apache.ant</groupId>\n             <artifactId>ant</artifactId>\n@@ -144,6 +138,11 @@\n                             <goal>jar</goal>\n                         </goals>\n                         <configuration>\n+                            <excludes>\n+                                <!-- do not include com/ibm UOW classes in the jar! -->\n+                                <exclude>com</exclude>\n+                                <exclude>com/**/*</exclude>\n+                            </excludes>\n                             <archive>\n                                 <manifest>\n                                    <addDefaultImplementationEntries>true</addDefaultImplementationEntries>\n@@ -166,11 +165,4 @@\n         </plugins>\n     </build>\n \n-    <repositories>\n-        <repository>\n-            <id>seasar-repo</id>\n-            <name>seasar repository</name>\n-            <url>https://www.seasar.org/maven/maven2</url>\n-        </repository>\n-    </repositories>\n </project>"},{"sha":"d2c1951ebe847c2127e9ce77ae98ce157e0f1510","filename":"openjpa-kernel/src/main/java/com/ibm/wsspi/uow/UOWAction.java","status":"added","additions":30,"deletions":0,"changes":30,"blob_url":"https://github.com/apache/openjpa/blob/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/src/main/java/com/ibm/wsspi/uow/UOWAction.java","raw_url":"https://github.com/apache/openjpa/raw/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/src/main/java/com/ibm/wsspi/uow/UOWAction.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/com/ibm/wsspi/uow/UOWAction.java?ref=eef64ccd69c48ba8c7193509f6f621c6315bc74e","patch":"@@ -0,0 +1,30 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.ibm.wsspi.uow;\n+\n+/**\n+ * This is a clean room re-implementation of the IBM UOWAction API from the existing bytecode API.\n+ * This will not be shipped in any distribution but excluded from the packaged JAR file.\n+ * It purely exists for compiling against it.\n+ *\n+ * @author <a href=\"mailto:struberg@yahoo.de\">Mark Struberg</a>\n+ */\n+public interface UOWAction {\n+    void run() throws Exception;\n+}"},{"sha":"81fad5188c769b8f75c4d2d7a6c72fda18e23db1","filename":"openjpa-kernel/src/main/java/org/apache/openjpa/ee/WASRegistryManagedRuntime.java","status":"modified","additions":27,"deletions":13,"changes":40,"blob_url":"https://github.com/apache/openjpa/blob/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/src/main/java/org/apache/openjpa/ee/WASRegistryManagedRuntime.java","raw_url":"https://github.com/apache/openjpa/raw/eef64ccd69c48ba8c7193509f6f621c6315bc74e/openjpa-kernel/src/main/java/org/apache/openjpa/ee/WASRegistryManagedRuntime.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-kernel/src/main/java/org/apache/openjpa/ee/WASRegistryManagedRuntime.java?ref=eef64ccd69c48ba8c7193509f6f621c6315bc74e","patch":"@@ -18,18 +18,36 @@\n  */\n package org.apache.openjpa.ee;\n \n-import com.ibm.websphere.uow.UOWSynchronizationRegistry;\n import com.ibm.wsspi.uow.UOWAction;\n-import com.ibm.wsspi.uow.UOWActionException;\n-import com.ibm.wsspi.uow.UOWException;\n-import com.ibm.wsspi.uow.UOWManagerFactory;\n+\n+import java.lang.reflect.Method;\n \n /**\n  * WASRegistryManagedRuntime provides WebSphere specific extensions to\n  * {@link RegistryManagedRuntime}. Currently these extensions consist of using\n  * the WebSphere UOWManager interface to submit non transactional work.\n  */\n public class WASRegistryManagedRuntime extends RegistryManagedRuntime {\n+\n+    // value taken from com.ibm.websphere.uow.UOWSynchronizationRegistry\n+    private static final int WEBSPHERE_UOW_TYPE_LOCAL_TRANSACTION = 0;\n+\n+    private final Method getUOWManager;\n+    private final Method runUnderUOW;\n+\n+    public WASRegistryManagedRuntime() {\n+        try {\n+            Class classUOWManagerFactory = Class.forName(\"com.ibm.wsspi.uow.UOWManagerFactory\");\n+            getUOWManager = classUOWManagerFactory.getMethod(\"getUOWManager\");\n+\n+            Class classUOWManager = Class.forName(\"com.ibm.wsspi.uow.UOWManager\");\n+            runUnderUOW = classUOWManager.getMethod(\"runUnderUOW\");\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Problem while creating WASManagedRuntime\", e);\n+        }\n+    }\n+\n     /**\n      * <P>\n      * RegistryManagedRuntime cannot suspend transactions, but WebSphere\n@@ -40,16 +58,12 @@\n     public void doNonTransactionalWork(Runnable runnable)\n             throws RuntimeException, UnsupportedOperationException {\n         try {\n-            UOWManagerFactory.getUOWManager().runUnderUOW(\n-                UOWSynchronizationRegistry.UOW_TYPE_LOCAL_TRANSACTION, false,\n-                new DelegatingUOWAction(runnable));\n-        }\n-        catch(UOWActionException e ) {\n-            RuntimeException re = new RuntimeException(e.getMessage());\n-            re.initCause(e);\n-            throw re;\n+            Object uowManager = getUOWManager.invoke(null);\n+\n+            runUnderUOW.invoke(uowManager, WEBSPHERE_UOW_TYPE_LOCAL_TRANSACTION, false, new DelegatingUOWAction(runnable));\n+\n         }\n-        catch(UOWException e ) {\n+        catch(Exception e ) {\n             RuntimeException re = new RuntimeException(e.getMessage());\n             re.initCause(e);\n             throw re;"}]}

