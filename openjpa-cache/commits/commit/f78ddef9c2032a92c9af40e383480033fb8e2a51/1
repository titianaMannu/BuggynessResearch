{"sha":"f78ddef9c2032a92c9af40e383480033fb8e2a51","node_id":"MDY6Q29tbWl0MjA2MzY0OmY3OGRkZWY5YzIwMzJhOTJjOWFmNDBlMzgzNDgwMDMzZmI4ZTJhNTE=","commit":{"author":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-01-04T21:10:09Z"},"committer":{"name":"Donald Woods","email":"dwoods@apache.org","date":"2010-01-04T21:10:09Z"},"message":"OPENJPA-1453 Updates to add javaagent and pass/fail counts for JPA2 runs\n\ngit-svn-id: https://svn.apache.org/repos/asf/openjpa/trunk@895783 13f79535-47bb-0310-9956-ffa450edef68","tree":{"sha":"01e78069ca55c157902955d4d942a7c5ceabe174","url":"https://api.github.com/repos/apache/openjpa/git/trees/01e78069ca55c157902955d4d942a7c5ceabe174"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/f78ddef9c2032a92c9af40e383480033fb8e2a51","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/f78ddef9c2032a92c9af40e383480033fb8e2a51","html_url":"https://github.com/apache/openjpa/commit/f78ddef9c2032a92c9af40e383480033fb8e2a51","comments_url":"https://api.github.com/repos/apache/openjpa/commits/f78ddef9c2032a92c9af40e383480033fb8e2a51/comments","author":null,"committer":null,"parents":[{"sha":"02b5554036db444d4f7cb7463c3fe469edb29e87","url":"https://api.github.com/repos/apache/openjpa/commits/02b5554036db444d4f7cb7463c3fe469edb29e87","html_url":"https://github.com/apache/openjpa/commit/02b5554036db444d4f7cb7463c3fe469edb29e87"}],"stats":{"total":152,"additions":111,"deletions":41},"files":[{"sha":"e71804c303ee5f37aaa21cc1492bb4298111aae0","filename":"openjpa-integration/tck/pom.xml","status":"modified","additions":111,"deletions":41,"changes":152,"blob_url":"https://github.com/apache/openjpa/blob/f78ddef9c2032a92c9af40e383480033fb8e2a51/openjpa-integration/tck/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/f78ddef9c2032a92c9af40e383480033fb8e2a51/openjpa-integration/tck/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-integration/tck/pom.xml?ref=f78ddef9c2032a92c9af40e383480033fb8e2a51","patch":"@@ -81,13 +81,32 @@\n           <plugins>\n             <plugin>\n                 <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-antrun-plugin</artifactId>\n+                <artifactId>maven-enforcer-plugin</artifactId>\n                 <executions>\n                     <execution>\n-                        <id>run-tck</id>\n-                        <phase>integration-test</phase>\n+                        <phase>validate</phase>\n+                        <goals>\n+                            <goal>enforce</goal>\n+                        </goals>\n                         <configuration>\n-                        <tasks>\n+                            <rules>\n+                                <requireJavaVersion>\n+                                    <version>[1.6,)</version>\n+                                </requireJavaVersion>\n+                            </rules>\n+                        </configuration>\n+                    </execution>\n+                </executions>\n+            </plugin>\n+            <plugin>\n+              <groupId>org.apache.maven.plugins</groupId>\n+              <artifactId>maven-antrun-plugin</artifactId>\n+              <executions>\n+                <execution>\n+                  <id>run-tck</id>\n+                  <phase>integration-test</phase>\n+                  <configuration>\n+                    <tasks>\n                         <echo>Running Sun JPA 2.0 TCK</echo>\n \n                         <property name=\"tck.zip\" value=\"${settings.localRepository}/../privaterepos/jpatck-2.0_09-Dec-2009.zip\" />\n@@ -127,6 +146,7 @@\n                         <property name=\"jpatck.pkg.dir\" value=\"com\" />\n                         <property name=\"jpatck.test\" value=\"\" />\n \n+                        <property name=\"jpatck.reports.dir\" value=\"${tck.dir}/../reports\" />\n                         <property name=\"jpatck.work.dir\" value=\"${tck.dir}/../work\" />\n                         <property name=\"tck.log\" value=\"${tck.base}/openjpa-tck.log\" />\n \n@@ -159,7 +179,7 @@ openjpa.jdbc.SchemaFactory: native(ForeignKeys=true)\n \n jpa.home=${tck.dir}\n work.dir=${jpatck.work.dir}\n-report.dir=${tck.dir}/../reports\n+report.dir=${jpatck.reports.dir}\n jpa.classes=${cp.property}\n database.classes=${jpa.classes}\n # Need to specify java.* classes, both in Windows/UNIX locations as well as Mac.\n@@ -197,14 +217,13 @@ databaseName=${db.name}\n                         <echo>AGENT: ${agent}${agent.properties}</echo>\n \n                         <!--\n-                            Replace the existing javaagent argument (which\n-                            uses Toplink's enhancer) with our own. Also, we\n-                            need to specify the default MetaDataFactory in\n-                            order to allow tests that don't have any\n+                            Add in a javaagent argument (optional in JPA2 TCK.)\n+                            Also, we need to specify the default MetaDataFactory\n+                            inorder to allow tests that don't have any\n                             persistent classes to work (like the SignatureTest)\n                         -->\n                         <replace file=\"${jpatck.config}\">\n-                            <replacefilter token=\"-javaagent:${jpa.home}/lib/toplink-essentials-agent.jar\" value=\"-javaagent:${agent}${agent.properties} -Dopenjpa.MetaDataFactory=jpa(DefaultAccessType=PROPERTY)\" />\n+                            <replacefilter token=\"${JAVA_HOME}/bin/java\" value=\"${JAVA_HOME}/bin/java -javaagent:${agent}${agent.properties} -Dopenjpa.MetaDataFactory=jpa(DefaultAccessType=PROPERTY)\" />\n                         </replace>\n \n                         <!-- make a macro for the TCK harness launcher -->\n@@ -251,6 +270,41 @@ databaseName=${db.name}\n                         <!-- now run the TCK -->\n                         <tsant buildfile=\"${tck.dir}/bin/build.xml\" target=\"runclient\" />\n \n+                        <!-- archive the results -->\n+                        <property name=\"tck.results.archive\" value=\"${tck.base}/openjpa-tck-results.zip\" />\n+                        <zip destfile=\"${tck.results.archive}\">\n+                            <fileset dir=\"${jpatck.work.dir}\" />\n+                            <fileset dir=\"${jpatck.reports.dir}\" />\n+                        </zip>\n+                        <echo>Results archive at: ${tck.results.archive}</echo>\n+\n+                        <!-- Figure out the Passed/Failed counts -->\n+                        <resourcecount property=\"count.passed\">\n+                          <tokens>\n+                            <concat>\n+                              <filterchain>\n+                                <tokenfilter>\n+                                  <containsstring contains=\"Passed.\"/>\n+                                </tokenfilter>\n+                              </filterchain>\n+                              <fileset dir=\"${jpatck.reports.dir}\" includes=\"summary.txt\" />\n+                            </concat>\n+                          </tokens>\n+                        </resourcecount>\n+                        <resourcecount property=\"count.failed\">\n+                          <tokens>\n+                            <concat>\n+                              <filterchain>\n+                                <tokenfilter>\n+                                  <containsstring contains=\"Failed.\"/>\n+                                </tokenfilter>\n+                              </filterchain>\n+                              <fileset dir=\"${jpatck.reports.dir}\" includes=\"summary.txt\" />\n+                            </concat>\n+                          </tokens>\n+                        </resourcecount>\n+                        <echo>TCK Results - Passed: ${count.passed}, Failed: ${count.failed}</echo>\n+\n                         <!--\n                             The TCK's Java process doesn't actually fail when\n                             tests fail, so we need to parse the results file\n@@ -260,21 +314,17 @@ databaseName=${db.name}\n                         <condition property=\"jpatck.failed\">\n                             <contains string=\"${jpatck.results}\" substring=\"Completed test run: not ok\" />\n                         </condition>\n-                        <fail if=\"jpatck.failed\">Some tests failed</fail>\n-\n-                        <echo>JPA TCK Passed 100%!</echo>\n-\n-                        <property name=\"tck.results.archive\" value=\"${tck.base}/openjpa-tck-results.zip\" />\n-                        <zip destfile=\"${tck.results.archive}\" basedir=\"${jpatck.work.dir}\" />\n-                        <echo>Results archive at: ${tck.results.archive}</echo>\n-\n-                        </tasks>\n-                        </configuration>\n-                        <goals>\n-                            <goal>run</goal>\n-                        </goals>\n-                    </execution>\n-                </executions>\n+                        <fail if=\"jpatck.failed\">${count.failed} tests failed</fail>\n+                        <!-- else -->\n+                        <echo>Passed JPA 2.0 TCK!</echo>\n+\n+                    </tasks>\n+                  </configuration>\n+                  <goals>\n+                    <goal>run</goal>\n+                  </goals>\n+                </execution>\n+              </executions>\n             </plugin>\n           </plugins>\n         </build>\n@@ -295,13 +345,32 @@ databaseName=${db.name}\n           <plugins>\n             <plugin>\n                 <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-antrun-plugin</artifactId>\n+                <artifactId>maven-enforcer-plugin</artifactId>\n                 <executions>\n                     <execution>\n-                        <id>run-tck</id>\n-                        <phase>integration-test</phase>\n+                        <phase>validate</phase>\n+                        <goals>\n+                            <goal>enforce</goal>\n+                        </goals>\n                         <configuration>\n-                        <tasks>\n+                            <rules>\n+                                <requireJavaVersion>\n+                                    <version>[1.5,)</version>\n+                                </requireJavaVersion>\n+                            </rules>\n+                        </configuration>\n+                    </execution>\n+                </executions>\n+            </plugin>\n+            <plugin>\n+              <groupId>org.apache.maven.plugins</groupId>\n+              <artifactId>maven-antrun-plugin</artifactId>\n+              <executions>\n+                <execution>\n+                  <id>run-tck</id>\n+                  <phase>integration-test</phase>\n+                  <configuration>\n+                    <tasks>\n                         <echo>Running Sun JPA TCK</echo>\n \n                         <property name=\"tck.zip\" value=\"${settings.localRepository}/../privaterepos/jpa-1_0b-tck.zip\" />\n@@ -466,6 +535,11 @@ databaseName=${db.name}\n                         <!-- now run the TCK -->\n                         <tsant buildfile=\"${tck.dir}/bin/build.xml\" target=\"runclient\" />\n \n+                        <!-- archive the results -->\n+                        <property name=\"tck.results.archive\" value=\"${tck.base}/openjpa-tck-results.zip\" />\n+                        <zip destfile=\"${tck.results.archive}\" basedir=\"${jpatck.work.dir}\" />\n+                        <echo>Results archive at: ${tck.results.archive}</echo>\n+\n                         <!--\n                             The TCK's Java process doesn't actually fail when\n                             tests fail, so we need to parse the results file\n@@ -476,20 +550,16 @@ databaseName=${db.name}\n                             <contains string=\"${jpatck.results}\" substring=\"Completed test run: not ok\" />\n                         </condition>\n                         <fail if=\"jpatck.failed\">Some tests failed</fail>\n-\n+                        <!-- else -->\n                         <echo>JPA TCK Passed 100%!</echo>\n \n-                        <property name=\"tck.results.archive\" value=\"${tck.base}/openjpa-tck-results.zip\" />\n-                        <zip destfile=\"${tck.results.archive}\" basedir=\"${jpatck.work.dir}\" />\n-                        <echo>Results archive at: ${tck.results.archive}</echo>\n-\n-                        </tasks>\n-                        </configuration>\n-                        <goals>\n-                            <goal>run</goal>\n-                        </goals>\n-                    </execution>\n-                </executions>\n+                    </tasks>\n+                  </configuration>\n+                  <goals>\n+                    <goal>run</goal>\n+                  </goals>\n+                </execution>\n+              </executions>\n             </plugin>\n           </plugins>\n         </build>"}]}

