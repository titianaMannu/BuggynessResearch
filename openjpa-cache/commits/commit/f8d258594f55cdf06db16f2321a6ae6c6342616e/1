{"sha":"f8d258594f55cdf06db16f2321a6ae6c6342616e","node_id":"MDY6Q29tbWl0MjA2MzY0OmY4ZDI1ODU5NGY1NWNkZjA2ZGIxNmYyMzIxYTZhZTZjNjM0MjYxNmU=","commit":{"author":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-06-16T10:25:45Z"},"committer":{"name":"Mark Struberg","email":"struberg@apache.org","date":"2021-06-16T10:44:15Z"},"message":"OPENJPA-2876 unit test to show wrong SQL\n\nsqlAction=refresh right now also generates the full DB.","tree":{"sha":"f6c7c65523be4992fc0292b9d552d983446d720c","url":"https://api.github.com/repos/apache/openjpa/git/trees/f6c7c65523be4992fc0292b9d552d983446d720c"},"url":"https://api.github.com/repos/apache/openjpa/git/commits/f8d258594f55cdf06db16f2321a6ae6c6342616e","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/apache/openjpa/commits/f8d258594f55cdf06db16f2321a6ae6c6342616e","html_url":"https://github.com/apache/openjpa/commit/f8d258594f55cdf06db16f2321a6ae6c6342616e","comments_url":"https://api.github.com/repos/apache/openjpa/commits/f8d258594f55cdf06db16f2321a6ae6c6342616e/comments","author":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"committer":{"login":"struberg","id":79310,"node_id":"MDQ6VXNlcjc5MzEw","avatar_url":"https://avatars.githubusercontent.com/u/79310?v=4","gravatar_id":"","url":"https://api.github.com/users/struberg","html_url":"https://github.com/struberg","followers_url":"https://api.github.com/users/struberg/followers","following_url":"https://api.github.com/users/struberg/following{/other_user}","gists_url":"https://api.github.com/users/struberg/gists{/gist_id}","starred_url":"https://api.github.com/users/struberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/struberg/subscriptions","organizations_url":"https://api.github.com/users/struberg/orgs","repos_url":"https://api.github.com/users/struberg/repos","events_url":"https://api.github.com/users/struberg/events{/privacy}","received_events_url":"https://api.github.com/users/struberg/received_events","type":"User","site_admin":false},"parents":[{"sha":"1742f62032e669b65790e6e9bef28307fc8d2cab","url":"https://api.github.com/repos/apache/openjpa/commits/1742f62032e669b65790e6e9bef28307fc8d2cab","html_url":"https://github.com/apache/openjpa/commit/1742f62032e669b65790e6e9bef28307fc8d2cab"}],"stats":{"total":214,"additions":114,"deletions":100},"files":[{"sha":"4e8b408707b6b1d221e5fa2e13fa22472cefa1c6","filename":"openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/test/java/org/apache/openjpa/tools/maven/test/ModifyDatabaseTest.java","status":"removed","additions":0,"deletions":70,"changes":70,"blob_url":"https://github.com/apache/openjpa/blob/1742f62032e669b65790e6e9bef28307fc8d2cab/openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/test/java/org/apache/openjpa/tools/maven/test/ModifyDatabaseTest.java","raw_url":"https://github.com/apache/openjpa/raw/1742f62032e669b65790e6e9bef28307fc8d2cab/openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/test/java/org/apache/openjpa/tools/maven/test/ModifyDatabaseTest.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/test/java/org/apache/openjpa/tools/maven/test/ModifyDatabaseTest.java?ref=1742f62032e669b65790e6e9bef28307fc8d2cab","patch":"@@ -1,70 +0,0 @@\n-package org.apache.openjpa.tools.maven.test;\n-\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-import java.io.BufferedReader;\n-import java.io.File;\n-import java.io.FileReader;\n-import java.io.InputStream;\n-import java.io.InputStreamReader;\n-import java.util.Arrays;\n-\n-import javax.persistence.EntityManager;\n-import javax.persistence.EntityManagerFactory;\n-import javax.persistence.Persistence;\n-\n-import org.apache.openjpa.enhance.PersistenceCapable;\n-import org.apache.openjpa.tools.maven.testentity.TestEntity;\n-\n-import junit.framework.TestCase;\n-\n-public class ModifyDatabaseTest extends TestCase {\n-\n-\n-    /**\n-     * check if the generated classes have been enhanced.\n-     * @throws Exception\n-     */\n-    public void testDatabaseWrite() throws Exception\n-    {\n-        EntityManagerFactory emf = Persistence.createEntityManagerFactory( \"TestUnit\" );\n-        assertNotNull( emf );\n-\n-        EntityManager em = emf.createEntityManager();\n-        assertNotNull( em );\n-\n-        try\n-        {\n-            em.getTransaction().begin();\n-\n-            TestEntity entity = new TestEntity();\n-            entity.setInt1( 4711 );\n-            entity.setString1( \"myVal\" );\n-\n-            em.persist( entity );\n-            em.getTransaction().commit();\n-        }\n-        finally\n-        {\n-            em.close();\n-        }\n-    }\n-\n-}"},{"sha":"2ec2d61620cd6312bbc091b0541ff41a63eba247","filename":"openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/pom.xml","status":"renamed","additions":42,"deletions":22,"changes":64,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/pom.xml?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -24,14 +24,17 @@\n \n     <modelVersion>4.0.0</modelVersion>\n \n+\n     <groupId>org.apache.openjpa.tools.openjpa-maven-plugin.testing</groupId>\n     <artifactId>modifyDatabase</artifactId>\n     <version>1.0-SNAPSHOT</version>\n+\n     <dependencies>\n         <dependency>\n             <groupId>junit</groupId>\n             <artifactId>junit</artifactId>\n-            <version>3.8.2</version>\n+            <version>4.13.2</version>\n+            <scope>test</scope>\n         </dependency>\n \n         <dependency>\n@@ -41,16 +44,23 @@\n         </dependency>\n \n         <dependency>\n-            <groupId>mysql</groupId>\n-            <artifactId>mysql-connector-java</artifactId>\n-            <version>5.1.11</version>\n+            <groupId>org.hsqldb</groupId>\n+            <artifactId>hsqldb</artifactId>\n+            <version>@hsqldb.version@</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.commons</groupId>\n+            <artifactId>commons-dbcp2</artifactId>\n+            <version>@dbcp2.version@</version>\n         </dependency>\n     </dependencies>\n \n     <build>\n         <plugins>\n             <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n                 <artifactId>maven-compiler-plugin</artifactId>\n+                <version>3.5.1</version>\n                 <configuration>\n                     <source>1.8</source>\n                     <target>1.8</target>\n@@ -60,28 +70,31 @@\n             <plugin>\n                 <groupId>org.codehaus.mojo</groupId>\n                 <artifactId>sql-maven-plugin</artifactId>\n-                <version>1.4</version>\n+                <version>1.5</version>\n                 <executions>\n                     <execution>\n-                        <id>dropdatabase</id>\n+                        <id>initialdb</id>\n                         <phase>process-resources</phase>\n                         <goals>\n                             <goal>execute</goal>\n                         </goals>\n                     </execution>\n                 </executions>\n                 <configuration>\n-                    <driver>com.mysql.jdbc.Driver</driver>\n-                    <url>jdbc:mysql://localhost/testdb</url>\n-                    <username>root</username>\n-                    <enableAnonymousPassword>true</enableAnonymousPassword>\n-                    <sqlCommand>DROP TABLE TestEntity;</sqlCommand>\n+                    <driver>org.hsqldb.jdbcDriver</driver>\n+                    <url>jdbc:hsqldb:file:target/openjpa-hsqldb;hsqldb.lock_file=false</url>\n+                    <username>SA</username>\n+                    <password></password>\n+                    <srcFiles>\n+                        <srcFile>src/main/sql/database.sql</srcFile>\n+                    </srcFiles>\n+                    <escapeProcessing>false</escapeProcessing>\n                 </configuration>\n                 <dependencies>\n                     <dependency>\n-                        <groupId>mysql</groupId>\n-                        <artifactId>mysql-connector-java</artifactId>\n-                        <version>5.1.11</version>\n+                        <groupId>org.hsqldb</groupId>\n+                        <artifactId>hsqldb</artifactId>\n+                        <version>@hsqldb.version@</version>\n                     </dependency>\n                 </dependencies>\n             </plugin>\n@@ -96,14 +109,16 @@\n                         org/apache/openjpa/tools/maven/testentity/TestEntity.class\n                     </include>\n                     <sqlAction>refresh</sqlAction>\n-                    <modifyDatabase>true</modifyDatabase>\n+                    <connectionDriverName>org.apache.commons.dbcp2.BasicDataSource</connectionDriverName>\n                     <connectionProperties>\n-                        driverClass=com.mysql.jdbc.Driver,\n-                        jdbcUrl=jdbc:mysql://localhost/testdb,\n-                        user=root,\n+                        driverClassName=org.hsqldb.jdbcDriver,\n+                        url=jdbc:hsqldb:file:target/openjpa-hsqldb;hsqldb.lock_file=false,\n+                        username=SA,\n                         password=\n                     </connectionProperties>\n-\n+                    <toolProperties>\n+                        <DBDictionary>org.apache.openjpa.jdbc.sql.HSQLDictionary</DBDictionary>\n+                    </toolProperties>\n                 </configuration>\n                 <executions>\n                     <execution>\n@@ -117,9 +132,14 @@\n                 </executions>\n                 <dependencies>\n                     <dependency>\n-                        <groupId>mysql</groupId>\n-                        <artifactId>mysql-connector-java</artifactId>\n-                        <version>5.1.11</version>\n+                        <groupId>org.hsqldb</groupId>\n+                        <artifactId>hsqldb</artifactId>\n+                        <version>@hsqldb.version@</version>\n+                    </dependency>\n+                    <dependency>\n+                        <groupId>org.apache.commons</groupId>\n+                        <artifactId>commons-dbcp2</artifactId>\n+                        <version>@dbcp2.version@</version>\n                     </dependency>\n                 </dependencies>\n             </plugin>","previous_filename":"openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/pom.xml.disabled"},{"sha":"285324b0042174d79eddb2369596cf0f79d98e80","filename":"openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/java/org/apache/openjpa/tools/maven/testentity/TestEntity.java","status":"renamed","additions":7,"deletions":0,"changes":7,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/java/org/apache/openjpa/tools/maven/testentity/TestEntity.java","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/java/org/apache/openjpa/tools/maven/testentity/TestEntity.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/java/org/apache/openjpa/tools/maven/testentity/TestEntity.java?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -19,18 +19,25 @@\n  * under the License.\n  */\n \n+import javax.persistence.Column;\n import javax.persistence.Entity;\n import javax.persistence.Id;\n+import javax.persistence.Table;\n \n \n @Entity\n+@Table(name=\"TEST_ENTITY\")\n public class TestEntity {\n \n   @Id\n   private int xint1;\n \n+  @Column(name=\"SOME_VALUE\")\n   private String string1;\n \n+  @Column(name=\"VAL2\", length=100)\n+  private String val2;\n+\n   public int getInt1() {\n     return xint1;\n   }","previous_filename":"openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/main/java/org/apache/openjpa/tools/maven/testentity/TestEntity.java"},{"sha":"6bdeabbf388abc6f04bfae8cf9cad41f243ac74c","filename":"openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/resources/META-INF/persistence.xml","status":"renamed","additions":6,"deletions":6,"changes":12,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/resources/META-INF/persistence.xml","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/resources/META-INF/persistence.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/resources/META-INF/persistence.xml?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -19,15 +19,15 @@\n \n     <!-- simply all annotated persistent entities will be part of this unit-->\n     <persistence-unit name=\"TestUnit\">\n-\n+        <class>org.apache.openjpa.tools.maven.testentity.TestEntity</class>\n+<!-- TODO REMOVE\n         <properties>\n-            <property name=\"openjpa.jdbc.DBDictionary\" value=\"mysql\" />\n-            <property name=\"openjpa.ConnectionDriverName\" value=\"com.mysql.jdbc.Driver\" />\n-            <property name=\"openjpa.ConnectionURL\" value=\"jdbc:mysql://localhost/testdb\" />\n-            <property name=\"openjpa.ConnectionUserName\" value=\"root\" />\n+            <property name=\"openjpa.ConnectionDriverName\" value=\"org.hsqldb.jdbcDriver\" />\n+            <property name=\"openjpa.ConnectionURL\" value=\"jdbc:hsqldb:file:openjpa-hsqldb\" />\n+            <property name=\"openjpa.ConnectionUserName\" value=\"SA\" />\n             <property name=\"openjpa.ConnectionPassword\" value=\"\" />\n-\n         </properties>\n+-->\n \n     </persistence-unit>\n ","previous_filename":"openjpa-tools/openjpa-maven-plugin/src/it/modifyDatabase/src/main/resources/META-INF/persistence.xml"},{"sha":"3aa8daaf50ec97db9adcde20ac28932492a9cb06","filename":"openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/sql/database.sql","status":"added","additions":2,"deletions":0,"changes":2,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/sql/database.sql","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/sql/database.sql","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/main/sql/database.sql?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -0,0 +1,2 @@\n+CREATE TABLE TEST_ENTITY -- TestEntity\n+(xint1 INTEGER NOT NULL, SOME_VALUE VARCHAR(255), PRIMARY KEY (xint1));"},{"sha":"d89037b09b111a05729d73bfb9dd75fb174e7588","filename":"openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/test/java/org/apache/openjpa/tools/maven/test/ItRefreshSchemaTest.java","status":"added","additions":54,"deletions":0,"changes":54,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/test/java/org/apache/openjpa/tools/maven/test/ItRefreshSchemaTest.java","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/test/java/org/apache/openjpa/tools/maven/test/ItRefreshSchemaTest.java","contents_url":"https://api.github.com/repos/apache/openjpa/contents/openjpa-tools/openjpa-maven-plugin/src/it/sqlActionRefresh/src/test/java/org/apache/openjpa/tools/maven/test/ItRefreshSchemaTest.java?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.openjpa.tools.maven.test;\n+\n+\n+import java.io.BufferedReader;\n+import java.io.File;\n+import java.io.FileReader;\n+import org.junit.Test;\n+import static org.junit.Assert.*;\n+\n+public class ItRefreshSchemaTest {\n+\n+    /** contains the directory where all generated results are placed */\n+    private final static String TARGET_DIR = \"target\";\n+\n+    /** the file containing the generated SQL syntax */\n+    private final static String SQL_FILE = \"database.sql\";\n+\n+    /** if the SQL generation has been successful, the following result should be in the SQL file */\n+    private final static String VALID_SQL = \"ALTER TABLE TEST_ENTITY ADD COLUMN VAL2 VARCHAR(100);\";\n+\n+    /**\n+     * check if the generated SQL script is correct.\n+     * @throws Exception\n+     */\n+    @Test\n+    public void testSqlGeneration() throws Exception\n+    {\n+        File sqlFile = new File( TARGET_DIR, SQL_FILE );\n+        BufferedReader in = new BufferedReader( new FileReader( sqlFile ) );\n+        String sqlIn = in.readLine();\n+        assertEquals( VALID_SQL, sqlIn );\n+        sqlIn = in.readLine();\n+        assertTrue(sqlIn == null || sqlIn.trim().length() == 0);\n+    }\n+\n+}"},{"sha":"90f61baa91c039b15a145b1ff31e935babb8f8b1","filename":"pom.xml","status":"modified","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/apache/openjpa/blob/f8d258594f55cdf06db16f2321a6ae6c6342616e/pom.xml","raw_url":"https://github.com/apache/openjpa/raw/f8d258594f55cdf06db16f2321a6ae6c6342616e/pom.xml","contents_url":"https://api.github.com/repos/apache/openjpa/contents/pom.xml?ref=f8d258594f55cdf06db16f2321a6ae6c6342616e","patch":"@@ -86,7 +86,7 @@\n         <mssql.connector.version>9.2.1.jre8</mssql.connector.version>\n \n         <!-- other common versions -->\n-        <kubernetes-client.version>4.7.0</kubernetes-client.version>\n+        <kubernetes-client.version>5.4.1</kubernetes-client.version>\n         <slf4j.version>1.7.23</slf4j.version>\n         <!-- Compile Java source/target class level -->\n         <compile.class.source>${java.class.version}</compile.class.source>\n@@ -105,6 +105,7 @@\n \n         <jmock.version>2.9.0</jmock.version>\n         <automatic-module-name>-SUBMODULES-NEED-TO-OVERRIDE-THIS-</automatic-module-name>\n+        <dbcp2.version>2.8.0</dbcp2.version>\n     </properties>\n \n     <licenses>\n@@ -1786,7 +1787,7 @@\n             <dependency>\n                 <groupId>org.apache.commons</groupId>\n                 <artifactId>commons-dbcp2</artifactId>\n-                <version>2.8.0</version>\n+                <version>${dbcp2.version}</version>\n             </dependency>\n             <dependency>\n                 <groupId>javax.xml.bind</groupId>"}]}

