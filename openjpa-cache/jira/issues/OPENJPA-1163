{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12429818","self":"https://issues.apache.org/jira/rest/api/2/issue/12429818","key":"OPENJPA-1163","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313102","id":"12313102","description":"","name":"1.2.0","archived":false,"released":true,"releaseDate":"2008-08-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314148","id":"12314148","description":"Early Access 3","name":"2.0.0-M3","archived":false,"released":true,"releaseDate":"2009-10-12"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"38636","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":0,"timeestimate":0,"customfield_12312330":null,"versions":[],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[{"id":"12326079","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12326079","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12432095","key":"OPENJPA-1223","self":"https://issues.apache.org/jira/rest/api/2/issue/12432095","fields":{"summary":"Update documentation for autoOff config option","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311302","id":"12311302","name":"kernel","description":"Kernel"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":0,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"203623","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1163/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@676f8477[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3f7fb931[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3882f558[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@7a767548[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@b611c09[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@4301ac5[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2b37072e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6222eb35[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6120222c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@6542faff[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@76df9f0e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@351a9a3[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2009-08-03T21:07:10.358+0000","workratio":0,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1163/watchers","watchCount":0,"isWatching":false},"created":"2009-07-08T15:31:56.799+0000","updated":"2016-09-21T14:21:14.230+0000","timeoriginalestimate":0,"description":"There are data consistency issues when modifying more number of elements in a collection Vs less number of elements.\n\nFollowing is a detailed explanation about the issue with example:\n \n- Entity A has a collection of Entities AItems with cascade ALL.\n- Test case :\n  Clear all the data inside tables representing Entity A and AItems.  \n  Create 3 entity managers em1,em2 and em3.\n   \n  em1.begin()\n      create A on em1 with id \"1\"\n      add 10 elements of AItems (id's from 0-9) to the created A(id 1).\n      persist A.\n  em1.commit()\n \n  em1.begin()\n      merge A ( created in the previous step)\n      Remove 3 elements of AItems from the merged A.\n      Add 3 elements of AItems ( id's 10,11,12) to the merged A (id 1).\n   \nWith out committing em1\n   \n  em2.begin()\n      query database to fetch A and construct object result2 of entity A.\n      Add 3 elements of AItems ( id's 13,14,15) to fetched A ( result2)      \n\n   em2.commit ()\n   em1.commit()\n   \n  em3.begin()\n     query database to check the size of AItems that are related to A ( id 1)\n  em3.commit()\n   \n  The result on em3's query for AItems related to A, returns 13 as expected.\n  13 ( Initial 10 - em1's 3 + em1's 3 + em2's 3).\n   \nWhen the same test case is repeated with removing and adding 10 elements instead of 3 as before then I get wrong results.\n   \n    Add initial 10 AItems (id's 0-9) for A.\n    commit()\n   \n    em1 will remove 10 AItems from the collection of A.\n    em1 will add 10 AItems (id's 10-19) to collection of A.\n   \n    em2 will add 10 AItems (id's 20-29) to collection of A.\n   \n    Commit em2.\n    Commit em1.\n   \n    Then instead of 20 elements ( Initial 10 - em1's 10 + em1's 10 + em2's 10), I see only 10 elements.\n   \n    The 10 elements that I see are from em1's added AItems ( id's 10-19).\n\n\nI think the cause of the issue is that, when more number of elements (compared to initial element count of collection) in a collection are modified then collection tracking is disabled and openJPA tries to do the following:\n -- Delete every thing from the collection\n -- Insert data back to collection.\nWhile Inserting the data back it does not consider adding the dirty records ( em2's 10 added elements ) because the collection tracking is disabled.","customfield_10010":null,"timetracking":{"originalEstimate":"0h","remainingEstimate":"0h","originalEstimateSeconds":0,"remainingEstimateSeconds":0},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12415375","id":"12415375","filename":"OPENJPA-1163_trunk.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-08-03T17:33:20.521+0000","size":32565,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12415375/OPENJPA-1163_trunk.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042","disabled":false}],"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Data consistency issues while modifying collections.","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"openJPA trunk. Derby DB.","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12728756","id":"12728756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"Attached is a test case and fix for the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-07-08T16:01:36.250+0000","updated":"2009-07-08T16:01:36.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12733454","id":"12733454","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Hi Ravi,\n\nThanks for the patch. I think this sort of change needs a corresponding configuration option in the Compatibility class (maybe called limitChangesTracked?). The javadoc for org.apache.openjpa.conf.Compatibility can contain the information on when we changed the default behavior and why we made the change. If that isn't enough to go on just let me know and I'll provide some more pointers. \n\nI think that changing the default is the correct way to go, but I can also see existing applications that are unknowingly coded to the old behavior so I'd like to give them an option to move forward. I'll take a closer look at the testcase tomorrow (might be evening) but at first glance the patch looks good. \n\nThanks very much for finding and debugging this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2009-07-21T03:18:49.997+0000","updated":"2009-07-21T03:18:49.997+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12733960","id":"12733960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Hi Ravi,\n\nThis patch demonstrates a race condition more than anything else. You have two transactions. Tran 1 gets a copy of the entity, removes everything from its collection, then adds ten more items. Tran 2 gets a copy of the entity and just adds ten items. To show this just print out the size of newA.getAItems() before committing tran 1.\n\nIn Tran 1 the entity has only 10 items , in tran 2 the entity has 20. The last one to commit wins. It's a unidirectional relationship - I'm guessing this is because it's a uni-directional relationship and A is the owner (even though the updates are in the AItem table) and therefore the state in A trumps the state in AItem. \n\nInterestingly enough if you updated any field in A you should see an OptimisticLockException which would explain the problem better. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2009-07-22T02:57:14.648+0000","updated":"2009-07-22T02:57:14.648+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12734736","id":"12734736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"Hi Mike,\n\nIn my example, data dealt with Trans1 and Trans2 is not interfering with each other.\nBoth Trans1 and Trans2 are working on different objects and different rows of table.\nHence I fail to understand what you meant by \"This patch demonstrates a race condition more than anything else.\"\n\nThe whole idea of my testcase is to demonstrate that the results in database are different if I execute same code but the number of rows updates are different.\n\nA Item has 10 rows.\nTrans1 --> deletes 10 rows. (0 to 9)\n                   Adds 10 rows.(10 to 19)\nTrans2 --> Adds 10 rows.(20 to 29)\nCommit Trans2.\nCommit Trans1.\n\nRows in talbe AItems after above execution : ( 10 to 19) = 10 rows in total.\n\nThe same code when I manipulate only 3 rows.\nA Item has 10 rows.\nTrans1 --> deletes 3 rows. (0 to 6)\n                   Adds 3 rows.(10 to 12)\nTrans2 --> Adds 3 rows.(20 to 22)\nCommit Trans2.\nCommit Trans1.\nRows in talbe AItems after above execution : (0 to 6 , 10 to 12 , 20 to 22) = 13 rows in total\n\nIf only Trans1 has to win , then the results should be ( 0 to 6 ,10 to 12 = 10 in total) rather than 13.\n\nSo the results in AItems are different even though the same code is executed.\n\n>> You mentioned \"The last one to commit wins.\"\nWhen the data in both the transactions are not interfering with each other then both the transactions has to win , isn't it ?\n\nPlease correct me if I am loosing the track.\n\nThanks,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-07-23T19:16:58.602+0000","updated":"2009-07-23T19:16:58.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12734774","id":"12734774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Hi Ravi,\n\nI'm sorry, I misread the test results I'd made some changes and may have changed the testcase.\n\nI believe that both times the expected result should be 10 AItems (pretend A is unversioned). The last commit contains an instance of A, which is related to 10 AItems. A has a OneToMany unidirectional relationship with AItem. Since AItem does not have a relationship with A, A is the owner of the relationship. So the last transaction to update A:id=1 wins (or at least so I thought).\n\nIt's very interesting that the behavior is different when you add more changes (exceed 10).\n\nWhat bothers me about it is that you've updated a versioned entity (newA and result2) twice but didn't get an Optimistic Lock Exception. I'd think this is the correct behavior in this case (because A owns the relationship, it's really A that gets updated). That won't help for unversioned entities though - they'll still get the odd behavior you've found.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2009-07-23T20:43:52.135+0000","updated":"2009-07-23T20:43:52.135+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12734861","id":"12734861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"Hi Mike,\n\nThanks a lot for spending your time on this.\n\n>> It's very interesting that the behavior is different when you add more changes (exceed 10).\n\nCollectionChangeTrackerImpl.add() and remove() methods should give more info about this.\nIf the number of added objects plus the number of removed objects are greater than collection size, ChangeTracker is forcefully disabled.\nIf ChangeTracker is disabled, OpenJPA update strategy is delete all and re-insert all objects.\nSo while insert-all it can not see the objects inserted as part of em2 ( in my sample).\nHence this bug.\n\n>> What bothers me about it is that you've updated a versioned entity (newA and result2) twice but didn't get an Optimistic Lock Exception. \n\nExcellent concern.\nI was thinking previously that AItem objects modified in tran 1 and tran 2 does not interfere with each other and hence should not result in optimistic lock excpetion.\nNow I understand that both tran 1 and tran 2 are working on same row of A , which mean at the time of tran1 commit I should get optimistic lock exception.\n\nI verified the reason why I am not getting optimistic lock exception and I changed the method level version annotation to field level.\nNow I got optimistic lock errors when I set the version annotation on field rather than on method.\nI think version annotation on methods has some issue.\n\nWith version annotation on method, when I check the db tables then I do not see the corresponding version column.\nAfter adding version attribute to the field I can see version column on the table and getting optimistic lock exception.\n\nSo in my example, both A and AItems are treated as non versioned entities.\n\nIn the process of answering your concerns, I realized that I definitely have to revisit my testcase.\nI will try to modify the test case such that it properly demonstrates the current issue.\nI think the issue defined in this JIRA is valid but my test case needs to be revisited.\nDo you agree with this ?\n\nThanks again,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-07-24T01:10:59.475+0000","updated":"2009-07-24T01:10:59.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12735217","id":"12735217","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"Hi,\n\nI simplified the test case now.\nIt has only one entity \"A\".\nA in unversioned and it has an id ( primary key), name, age and a map.\n\nA's initialValues :\n    A(id,age,name,map) =     A (1, 30, \"Initial\", 0-9 ( size of 10).\n\nTrans1 :\n    A.Age = 40;\n    Remove 8 elements in Map.\n    Add 8 elements to Map (10 - 17)\nTrans2: \n    A.Name = \"Changed\"\n    Add 8 elements to Map (20 - 27)\n\nCommit Trans2 .\nCommit Trans1.\n\nResults :\n\nA's values :\n    A(id,age,name,map) =     A (1, 40, \"Changed Name\", 8,9,10-17 ( size of 10).\n\nThe same when repeated with adding & removing 3 elements ( instead of 8)\nthen A's values :\n    A(id,age,name,map) =     A (1, 40, \"Changed Name\", 3-9,10-12,20-22 ( size of 13).\n    \nThe question is which behavior in the above is true ?\n\nShould the whole Map be replaced by Trans 1 ( as it is last committed) (or)\nShould the Map be a combination of changes made in Trans1 and Trans2 ?\n\nIf you see the other values of A; the changes made to age and name by Trans1 and 2 are both considered.\nWhen it comes to map the results are different.\n\nRegards,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-07-25T00:30:12.567+0000","updated":"2009-07-25T00:30:12.567+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12738175","id":"12738175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"The attached patch contains fix along with the testcase.\nThis will take autoOff parameter from openjpa.compatibility option.\nThe default option is what ever existing currently with out the patch.\n\nRegards,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-08-03T03:00:29.683+0000","updated":"2009-08-03T03:00:29.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12738444","id":"12738444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":"Forgot to attach the testcase.\nThe current patch contains both the test case and fix.\n\nRegards,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-08-03T17:33:20.557+0000","updated":"2009-08-03T17:33:20.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12738586","id":"12738586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Hi Ravi,\n\nGreat testcases (sorry this was a long time coming). I wouldn't recommend using this approach for relationships but the PersistentCollection is an interesting wrinkle.\n\nThanks very much for your hard work on this issue. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2009-08-03T21:06:05.098+0000","updated":"2009-08-03T21:06:05.098+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12739308","id":"12739308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ppoddar%40apache.org","name":"ppoddar@apache.org","key":"ppoddar@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pinaki Poddar","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi/Mike, \nAs you have analyzed the issue, do you think\n  1. is this earlier value of autoOff considered a defect? Or a behavior that we must retain with a Compatibility option?\n\nIf it is ony a defect that was not exposed till this issue then there may not be a strong case for a compatibility option.\n\nIf it not a defect and we need to retain both the old value and the new value, then instead of adding a separate compatibility option, consider \nautooff as one more configurable option of ProxyManager. ProxyManager already have few boolean configurable properties so this new\nchoice will fit neatly (also the patch footprint will reduce). \nIf this issue is not a defect then the default value should remain as before. But documentation should explain when the configuration should be switched.\nIf this issue is a defect then the default value should flip. But documentation should explain how the configuration could be switched to backward compatible behavior\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ppoddar%40apache.org","name":"ppoddar@apache.org","key":"ppoddar@apache.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pinaki Poddar","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-08-05T01:51:32.333+0000","updated":"2009-08-05T01:51:32.333+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12739602","id":"12739602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"body":">> If this issue is a defect then the default value should flip.\n\nThe reason for not switching the default value is because I am not completely confident that the previous behavior is a defect. \nSo without confirmation of whether it is a defect or not, I felt it is convenient for existing applications using the current default\n value to upgrade to latest versions without the need for any additional properties. Also there is a doc JIRA (OPENJPA-1223) opened for documenting this.\n\nIn my opinion the previous value is a defect.\nMay be I am wrong but I think it is a defect based on the following :\n\n1)  The previous default behavior is as follows:\n    When the number of modifications(add/remove) to a collection exceeds the initial size of collection then the logic is to\n    remove everything from collection and re-insert the objects. In the process of re-inserting it will not consider data \n    that is modified as part of another transaction.\n    \n    So, the end result is that the data inserted into database is dependent on the number of modifications made on the collection.\n    I think it is bug as the data inserted into the database should be consistent irrespective of the number of modifications \n    made to the collection.\n    \n2)  When the data modified in two concurrent transactions does not interfere with each other then both the transactions should win.\n    For example, let's consider table A which has 5 rows ( primary key of int 1-5) and has row level locking. \n    Transaction 1 tries to modify rows 1 -3 and transaction 2 modifies 4-5 at the same time.\n    In this case I think both the transactions has to win.\n    The above is not possible with default value of autoOff, when the # of modifications to A exceeds 5.\n\nIf you think adding an option to ProxyManager is a better fit than compatibility configuration then I will modify my fix.\nCan I please ask, if there is any additional advantage with it other than patch footprint.\n\nRegards,\nRavi.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rpalache","name":"rpalache","key":"rpalache","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ravi Prakash Palacherla","active":true,"timeZone":"America/Denver"},"created":"2009-08-05T16:47:29.558+0000","updated":"2009-08-05T16:47:29.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12739687","id":"12739687","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":">    So, the end result is that the data inserted into database is dependent on the number of modifications made on the collection.\n>    I think it is bug as the data inserted into the database should be consistent irrespective of the number of modifications\n>    made to the collection. \n\nI agree, the number of modifications should not have an affect. \n\n> 2) When the data modified in two concurrent transactions does not interfere with each other then both the transactions should win.\n>    For example, let's consider table A which has 5 rows ( primary key of int 1-5) and has row level locking.\n>    Transaction 1 tries to modify rows 1 -3 and transaction 2 modifies 4-5 at the same time.\n>    In this case I think both the transactions has to win.\n\nIMO this really depends on who owns the relationship or the collection. \n\nFor example this featureSelection :\n@Entity \npublic class Manager {\n    @OneToMany(mappedBy=\"manager\")\n    private Collection<Employee> employees;\n}\n\n@Entity\npublic class Employee { \n    @ManyToOne\n    private Manager manager; \n}\n\nEmployee owns the relationship, and the employee table has a foreign key. Any Employees with a FK -> a particular manager are considered that manager's Employees. In this case we should see the behavior Ravi is advocating. \n\nThe following example is slightly different : \n@Entity \npublic class Manager {\n    @OneToMany\n    private Collection<Employee> employees;\n}\n\n@Entity\npublic class Employee { \n    // no reference to Manager.\n}\n\nIn this case Manager is the owner of the relationship and the Manager object owns the relationship and the set of Employees. In this case I'm less certain how we should behave. My original take was that the last to commit wins - Manager owns the state of the relationship and bears the sole burden of maintaining it. \n\nI'm not sure that's the ideal solution, but I didn't feel confident enough in the answer to change the default. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2009-08-05T19:23:13.176+0000","updated":"2009-08-05T19:23:13.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12740755","id":"12740755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dezzio","name":"dezzio","key":"dezzio","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Ezzio","active":true,"timeZone":"America/New_York"},"body":"From trunk, merged fix to 1.1.x branch at rev 802218","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dezzio","name":"dezzio","key":"dezzio","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Ezzio","active":true,"timeZone":"America/New_York"},"created":"2009-08-07T21:37:06.584+0000","updated":"2009-08-07T21:37:06.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12429818/comment/12756713","id":"12756713","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drwoods","name":"drwoods","key":"drwoods","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=drwoods&avatarId=20433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=drwoods&avatarId=20433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=drwoods&avatarId=20433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=drwoods&avatarId=20433"},"displayName":"Donald Woods","active":true,"timeZone":"America/New_York"},"body":"add missing Fix version for trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drwoods","name":"drwoods","key":"drwoods","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=drwoods&avatarId=20433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=drwoods&avatarId=20433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=drwoods&avatarId=20433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=drwoods&avatarId=20433"},"displayName":"Donald Woods","active":true,"timeZone":"America/New_York"},"created":"2009-09-17T19:15:33.925+0000","updated":"2009-09-17T19:15:33.925+0000"}],"maxResults":15,"total":15,"startAt":0},"customfield_12311820":"0|i0z85j:","customfield_12314139":null}}

