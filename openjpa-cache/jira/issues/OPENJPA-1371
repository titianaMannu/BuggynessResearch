{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12439580","self":"https://issues.apache.org/jira/rest/api/2/issue/12439580","key":"OPENJPA-1371","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314148","id":"12314148","description":"Early Access 3","name":"2.0.0-M3","archived":false,"released":true,"releaseDate":"2009-10-12"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"161640","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314148","id":"12314148","description":"Early Access 3","name":"2.0.0-M3","archived":false,"released":true,"releaseDate":"2009-10-12"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":null,"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311302","id":"12311302","name":"kernel","description":"Kernel"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"203564","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1371/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@236d2a21[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@59a0ef6b[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1a192244[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@441c4ddb[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3026756[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@2a764c9a[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@79ae5092[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@5ffab8e9[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4fd25c97[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@57d8db6b[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5cf93bc2[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@564efd44[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2010-03-24T17:47:55.085+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1371/watchers","watchCount":0,"isWatching":false},"created":"2009-10-30T22:51:47.369+0000","updated":"2010-04-22T20:33:00.389+0000","timeoriginalestimate":null,"description":"Insert is called instead of Update when merge() with derived Identity:","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Insert is called instead of Update when merge() with derived Identity","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12439580/comment/12772179","id":"12772179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"body":"The following test scenario is provided by Constantine Kulak <code@mail.by>:\n\nThere are three entities where PrognosisEntry has derived identity:\n\n***** Source for Prognosis.java:\n\n @Entity(name = \"Prognosis\")\n @Table(name = \"PROGNOSIS\")\n @IdClass(Prognosis.PrognosisId.class)\n @Inheritance(strategy = InheritanceType.JOINED)\n public class Prognosis {\n\n     protected List<PrognosisEntry> entries;\n    protected String station;\n    protected String type;\n\n    @OneToMany(targetEntity = PrognosisEntry.class, cascade = {CascadeType.MERGE}, mappedBy=\"prognosis\", fetch=FetchType.EAGER)\n    public List<PrognosisEntry> getEntries() {\n        if (entries == null) {\n            entries = new ArrayList<PrognosisEntry>();\n        }\n        return this.entries;\n    }\n\n    public void setEntries(List<PrognosisEntry> entries) {\n        this.entries = entries;\n    }\n\n    @Id\n    @Column(name = \"STATION\")\n    public String getStation() {\n        return station;\n    }\n\n    public void setStation(String value) {\n        this.station = value;\n    }\n\n    @Id\n    @Column(name = \"TYPE_\")\n    public String getType() {\n        return type;\n    }\n\n    public void setType(String value) {\n        this.type = value;\n    }\n\n    public boolean equals(Object object) { ... }\n    public int hashCode() { ... }\n\n    public static class PrognosisId {\n        protected String station;\n        protected String type;\n\n        public String getStation() {\n            return station;\n        }\n\n        public void setStation(String value) {\n            this.station = value;\n        }\n\n        public String getType() {\n            return type;\n        }\n\n        public void setType(String value) {\n            this.type = value;\n        }\n\n          public boolean equals(Object object) { ... }\n        public int hashCode() { ... }\n    }\n }\n\n\n ***** Source for PrognosisEntry.java:\n\n @Entity(name = \"PrognosisEntry\")\n @Table(name = \"PROGNOSISENTRY\")\n @Inheritance(strategy = InheritanceType.JOINED)\n @IdClass(PrognosisEntry.PrognosisEntryId.class)\n public class PrognosisEntry {\n\n    protected String timestamp;\n    protected String localState;\n    protected Prognosis prognosis;\n\n    protected Stock stock;\n\n    @Id\n    @ManyToOne(targetEntity = Stock.class, cascade = { CascadeType.MERGE }, fetch = FetchType.EAGER)\n    public Stock getStock() {\n        return stock;\n    }\n\n    public void setStock(Stock stock) {\n        this.stock = stock;\n    }\n\n    @Id\n    @ManyToOne(targetEntity = Prognosis.class, cascade = { CascadeType.MERGE }, fetch = FetchType.EAGER)\n    public Prognosis getPrognosis() {\n        return prognosis;\n    }\n\n    public void setPrognosis(Prognosis prognosis) {\n        this.prognosis = prognosis;\n    }\n\n    @Column(name = \"TIMESTAMP_\", length = 255)\n    public String getTimestamp() {\n        return timestamp;\n    }\n\n    public void setTimestamp(String value) {\n        this.timestamp = value;\n    }\n\n    @Basic\n    @Column(name = \"LOCALSTATE\", length = 255)\n    public String getLocalState() {\n        return localState;\n    }\n\n    public void setLocalState(String value) {\n        this.localState = value;\n    }\n\n    public boolean equals(Object object) { ... }\n    public int hashCode() { ... }\n\n    public static class PrognosisEntryId {\n\n        protected Prognosis.PrognosisId prognosis;\n        protected String stock;\n\n        public String getStock() {\n            return stock;\n        }\n\n        public void setStock(String stock) {\n            this.stock = stock;\n        }\n\n        public Prognosis.PrognosisId getPrognosis() {\n            return prognosis;\n        }\n\n        public void setPrognosis(Prognosis.PrognosisId prognosis) {\n            this.prognosis = prognosis;\n        }\n\n        public boolean equals(Object object) { ... }\n        public int hashCode() { ... }\n    }\n }\n\n\n ***** Source for Stock.java:\n\n @Entity(name = \"Stock\")\n @Table(name = \"STOCK\")\n @Inheritance(strategy = InheritanceType.JOINED)\n public class Stock {\n    protected String index;\n    protected String length;\n\n    @Id\n    @Column(name = \"INDEX_\")\n    public String getIndex() {\n        return index;\n    }\n\n    public void setIndex(String value) {\n        this.index = value;\n    }\n      @Basic\n    @Column(name = \"LENGTH_\", length = 255)\n    public String getLength() {\n        return length;\n    }\n\n    public void setLength(String value) {\n        this.length = value;\n    }\n\n    public boolean equals(Object object) { ... }\n    public int hashCode() { ... }\n}\n\nThe test scenario: \n(1) create a Prognosis entity with a list of PrognosisEntry.\n(2) call em.merge(newEntity) and commit\n(3) call em.clear()\n(4) call em.merge(newEntity)\n\nStep (4) generate insert statement to insert PrognosisEntry again, resulting in unique constraint violation from the database.\n\nIt appears that the ApplicationIds.create(pc, meta) where pc is PrognosisEntry, the oid does not have complete id values.\n\n\n\n\n\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-30T23:36:57.522+0000","updated":"2009-10-30T23:36:57.522+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12439580/comment/12772296","id":"12772296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"body":"During merge, openjpa needs to retrieve id from the entity to decide whether this is a new entity or a detached one. If it thinks it is a new entity, an INSERT will be perform. Otherwise, an Update statement will be executed. \nIf  (1) an entity has the compound primary key using IdClass, and \n    (2) some field in the IdClass is a derived identity from a OneToOne/ManyToOne field,\n    (3) that value in that field has not yet become managed (i.e., does not have the StateManagerImpl yet),\nthis field in the IdClass will not be populated, as the primary key of the OneToOne/ManyToOne field usually can not be fetched back without an associated StateManagerImpl, unless it has a single-value primary key. \n\nCurrently openjpa returns the null value for this field in the IdClass regardlessly in the above situation.  The patch provides a relief when this derived identity-relation field has a single value primary key. It should fix the problem reported by Constantine. However, the limitation for nested/multi-level compound primary (e.g. Stock entity has compound primary key using IdClass, and some value in the idClass is a derived-identity relation field, ...) during merge remains.   \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-01T00:43:56.820+0000","updated":"2009-11-01T00:43:56.820+0000"}],"maxResults":2,"total":2,"startAt":0},"customfield_12311820":"0|i0z7sf:","customfield_12314139":null}}

