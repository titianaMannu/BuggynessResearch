{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12459550","self":"https://issues.apache.org/jira/rest/api/2/issue/12459550","key":"OPENJPA-1584","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314542","id":"12314542","description":"","name":"2.1.0","archived":false,"released":true,"releaseDate":"2011-02-21"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"161847","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314019","id":"12314019","description":"JPA2 release","name":"2.0.0","archived":false,"released":true,"releaseDate":"2010-04-22"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312974","id":"12312974","name":"performance","description":"Performance improvements. Originally used to track changes in the performance sandbox. "}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"204220","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1584/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@7cb0b686[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@586db6d6[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6fa5c468[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@5acb144c[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7cf7ea41[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@285e5430[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@699953d7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6b7243dc[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@28141911[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@723137f7[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5195c58d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@288000c0[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2010-07-24T16:23:37.659+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1584/watchers","watchCount":1,"isWatching":false},"created":"2010-03-18T17:57:12.395+0000","updated":"2010-07-24T16:23:37.623+0000","timeoriginalestimate":null,"description":"a back-to-back of the following JPQL query providing different set of parameter values, \nthe second execution gives wrong answer.\n\n \"select o from OrderJPA o where o.OrderId in (select max(o1.OrderId) from OrderJPA o1 where ((o1.CustomerId = :customerId) and (o1.DistrictId = :districtId) and (o1.WarehouseId = :warehouseId))) and (o.CustomerId = :customerId) and (o.DistrictId = :districtId) and (o.WarehouseId = :warehouseId)\"\n\nSQL trace shown the first time query execution, let say customerId=339, districtId=3, warehouseId=23, then query returns 1 row:\n\nthe SQL trace looked fine:\n\n[3/16/10 17:40:36:831 CDT] 00000045 OpenJPA       3   openjpa.jdbc.SQL: Trace: <t 241897067, conn 1981117973> executing prepstmnt 1547852866 SELECT t0.O_D_ID, t0.O_ID, t0.O_W_ID, t0.VERSION, t0.O_ALL_LOCAL, t0.O_CARRIER_ID, t0.O_C_ID, t0.O_ENTRY_D, t0.O_OL_CNT FROM ORDERS t0 WHERE (t0.O_ID IN (SELECT MAX(t1.O_ID) FROM ORDERS t1 WHERE (t1.O_C_ID = ? AND t1.O_D_ID = ? AND t1.O_W_ID = ?) ) AND t0.O_C_ID = ? AND t0.O_D_ID = ? AND t0.O_W_ID = ?)  optimize for 1 row [params=(short) 339, (short) 3, (short) 23, (short) 339, (short) 3, (short) 23]\n\nOn the next execution of the same JPQL, the PreparedQueryImpl (which is cached before) gets reused.\nIn processing user provided parameters, for example, customerId=2967, districtId=5, warehouseId=22,\nIt is observed that the parameter values are incorrect: the last 3 values were incorrectly copied from the previously cached version.\n\n\n[3/16/10 17:45:42:411 CDT] 00000043 OpenJPA       3   openjpa.jdbc.SQL: Trace: <t 195496871, conn 1706649017> executing prepstmnt 1531796301 SELECT t0.O_D_ID, t0.O_ID, t0.O_W_ID, t0.VERSION, t0.O_ALL_LOCAL, t0.O_CARRIER_ID, t0.O_C_ID, t0.O_ENTRY_D, t0.O_OL_CNT FROM ORDERS t0 WHERE (t0.O_ID IN (SELECT MAX(t1.O_ID) FROM ORDERS t1 WHERE (t1.O_C_ID = ? AND t1.O_D_ID = ? AND t1.O_W_ID = ?) ) AND t0.O_C_ID = ? AND t0.O_D_ID = ? AND t0.O_W_ID = ?)  optimize for 1 row [params=(short) 2967, (short) 5, (short) 22, (short) 339, (short) 3, (short) 23]\n\n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450179","id":"12450179","filename":"OpenJPA-2.0.0_OJ1584.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-22T15:23:53.760+0000","size":1904,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12450179/OpenJPA-2.0.0_OJ1584.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"PreparedQuery gives wrong result if query has subquery and parameters are used in both main select and subselect","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12459550/comment/12891214","id":"12891214","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"body":"A modification to SQLBuffer has been committed in revision 925036 which supposedly corrected this issue. However, the committed change also has problems. The problem arises during the construction of a prepared statement when sub-selects are added to the main statement. In particular, the indexes of user parameters have to be adapted to their new positions within the resulting statement (which consists of the main statement and the sub-select). File org.apache.openjpa.jdbc.sql.SQLBuffer contains the following lines, which were committed with revision 925036 (lines 170++):\n\n            // modify this buffer's user parameter index\n            int otherSize = buf._userIndex.size()/2;\n            for (int i = 0; i < _userIndex.size(); i+=2) {\n                int newIndex = ((Integer)_userIndex.get(i)).intValue() + otherSize;\n                _userIndex.set(i, newIndex);\n            }\n            // append the other buffer's user parameters to this one\n            for (int i = 0; i < buf._userIndex.size(); i+=2) {\n                Object otherIndex = buf._userIndex.get(i);\n                Object otherParam = buf._userIndex.get(i+1);\n                _userIndex.add(otherIndex);\n                _userIndex.add(otherParam);\n            }            \n\nThis code assumes that the sub-select user parameters, which are stored in buf._userIndex, always reside at positions in the combined statement before all the parameters of the main statement. If this is the case, the above code works (almost) correctly: All user parameters of the main statement get their indexes adapted, all sub-select user parameters are just copied without change. The code is only almost correct in this case, because the index offset calculation done with\nint otherSize = buf._userIndex.size()/2;\nis misguided - the offset should really be the number of all parameters (including non-user parameters) of the sub-select, not only the user parameters.\n\nThe correct code is given below:\n\n            // modify this buffer's user parameter index for all parameters\n            // at or behind paramIndex, which is the insertion position\n            int otherSize = buf._params.size();\n            for (int i = 0; i < _userIndex.size(); i+=2) {\n                int oldIndex = ((Integer)_userIndex.get(i)).intValue();\n                if (oldIndex >= paramIndex)\n                    _userIndex.set(i, oldIndex + otherSize);\n            }\n            // append the other buffer's user parameters to this one, their\n            // position adapted according to the insertion position\n            for (int i = 0; i < buf._userIndex.size(); i+=2) {\n                int otherIndex = ((Integer) buf._userIndex.get(i)).intValue();\n                Object otherParam = buf._userIndex.get(i+1);\n                _userIndex.add(otherIndex + paramIndex);\n                _userIndex.add(otherParam);\n            }            \n\nHere, the insertion position at where the sub-select parameters get inserted into the main statement is propertly taken into account (paramIndex). User parameters of the main statement which reside before the insertion position remain unchanged, the position of all others gets offset by the number of parameters of the sub-select. The sub-select user parameters in turn are moved by an amount equal to the insertion position.\n\nA corresponding patch OpenJPA-2.0.0_OJ1584.patch containing the correct version of the code is attached. It would be better though to also add a new test method to TestPreparedQueryCache. If my help is welcome, I can create such a test case and supply it as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-22T15:23:53.817+0000","updated":"2010-07-22T15:23:53.817+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12459550/comment/12891251","id":"12891251","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drwoods","name":"drwoods","key":"drwoods","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=drwoods&avatarId=20433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=drwoods&avatarId=20433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=drwoods&avatarId=20433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=drwoods&avatarId=20433"},"displayName":"Donald Woods","active":true,"timeZone":"America/New_York"},"body":"Additional tests are always welcomed :-)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drwoods","name":"drwoods","key":"drwoods","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=drwoods&avatarId=20433","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=drwoods&avatarId=20433","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=drwoods&avatarId=20433","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=drwoods&avatarId=20433"},"displayName":"Donald Woods","active":true,"timeZone":"America/New_York"},"created":"2010-07-22T17:18:29.741+0000","updated":"2010-07-22T17:18:29.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12459550/comment/12891997","id":"12891997","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Resolved in  OPENJPA-1719 and OPENJPA-1738","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-24T16:23:37.595+0000","updated":"2010-07-24T16:23:37.595+0000"}],"maxResults":3,"total":3,"startAt":0},"customfield_12311820":"0|i0zbu7:","customfield_12314139":null}}

