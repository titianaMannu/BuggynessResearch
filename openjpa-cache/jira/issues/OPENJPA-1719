{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12468724","self":"https://issues.apache.org/jira/rest/api/2/issue/12468724","key":"OPENJPA-1719","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314532","id":"12314532","description":"2.0.1 Release","name":"2.0.1","archived":false,"released":true,"releaseDate":"2010-08-30"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314542","id":"12314542","description":"","name":"2.1.0","archived":false,"released":true,"releaseDate":"2011-02-21"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"161967","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314019","id":"12314019","description":"JPA2 release","name":"2.0.0","archived":false,"released":true,"releaseDate":"2010-04-22"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"204229","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1719/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@2c291c59[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@33da7df4[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5f23cfe9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@3ff62c24[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7920e6ed[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@24c92223[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@65d4fdd4[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6b4d6a46[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@15a4fe4c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@78110ee1[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3ae9766a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@3af6342b[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2010-07-26T15:42:27.551+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-1719/watchers","watchCount":2,"isWatching":false},"created":"2010-07-07T15:03:37.816+0000","updated":"2010-09-20T15:40:00.670+0000","timeoriginalestimate":null,"description":"I've found what appears to be an ordering issue with subqueries and the prepared SQL cache. The attached patch shows where I think the problem lies and adds a test method that shows the problem. \n\nTo summarize: When the prepared SQL cache is enabled we reorder the parameter values provided by the user. If a query contains named parameters and a subquery which also contains named parameters the placement of the subquery becomes important. \n\nThe following query will work : \nSELECT p FROM Person p WHERE p.id IN (SELECT p1.id FROM Person p1 WHERE p1.lastUpdated >= :date ) AND p.name = :name\n\nBut this one fails with a SQLDataException.\nSELECT p FROM Person p WHERE  p.name = :name AND p.id IN (SELECT p1.id FROM Person p1 WHERE p1.lastUpdated >= :date )\n\nAssuming that the query is executed something like this : \n        Query query = em.createQuery(query);\n        query.setParameter(\"name\", \"mike\");\n        query.setParameter(\"date\", new java.sql.Date(1005397));  \n\n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12450432","id":"12450432","filename":"OpenJPA-trunk_OJ1719.testcase.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-25T23:18:27.222+0000","size":1979,"mimeType":"text/x-diff","content":"https://issues.apache.org/jira/secure/attachment/12450432/OpenJPA-trunk_OJ1719.testcase.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12448882","id":"12448882","filename":"sql-cache-subqordering.diff.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2010-07-07T15:06:05.599+0000","size":4058,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12448882/sql-cache-subqordering.diff.txt"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042","disabled":false}],"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Prepared SQL cache ordering problem with subqueries. ","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12885962","id":"12885962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Attaching a patch that illustrates the problem using the existing TestPreparedQueryCache testcase. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2010-07-07T15:06:05.660+0000","updated":"2010-07-07T15:06:05.660+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12887224","id":"12887224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Fix checked in under trunk at revision 963139.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-11T20:09:09.432+0000","updated":"2010-07-11T20:09:09.432+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892018","id":"12892018","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"body":"The fix as committed with revision 963139 still has bugs. An IndexOutOfBoundsException\nis thrown caused by line 174 in SQLBuffer. Sample stack trace:\n\njava.util.ArrayList.addAll(ArrayList.java:497)\norg.apache.openjpa.jdbc.sql.SQLBuffer.append(SQLBuffer.java:174)\norg.apache.openjpa.jdbc.sql.SQLBuffer.resolveSubselects(SQLBuffer.java:521)\norg.apache.openjpa.jdbc.sql.SQLBuffer.getSQL(SQLBuffer.java:477)\norg.apache.openjpa.jdbc.sql.SQLBuffer.getSQL(SQLBuffer.java:467)\norg.apache.openjpa.jdbc.sql.SQLBuffer.prepareStatement(SQLBuffer.java:563)\norg.apache.openjpa.jdbc.sql.SQLBuffer.prepareStatement(SQLBuffer.java:543)\norg.apache.openjpa.jdbc.sql.SelectImpl.prepareStatement(SelectImpl.java:479)\norg.apache.openjpa.jdbc.sql.SelectImpl.execute(SelectImpl.java:420)\norg.apache.openjpa.jdbc.sql.SelectImpl.execute(SelectImpl.java:391)\norg.apache.openjpa.jdbc.sql.LogicalUnion$UnionSelect.execute(LogicalUnion.java:427)\norg.apache.openjpa.jdbc.sql.LogicalUnion.execute(LogicalUnion.java:230)\norg.apache.openjpa.jdbc.sql.LogicalUnion.execute(LogicalUnion.java:220)\norg.apache.openjpa.jdbc.kernel.SelectResultObjectProvider.open(SelectResultObjectProvider.java:94)\norg.apache.openjpa.kernel.QueryImpl$PackingResultObjectProvider.open(QueryImpl.java:2068)\norg.apache.openjpa.lib.rop.EagerResultList.<init>(EagerResultList.java:34)\norg.apache.openjpa.kernel.QueryImpl.toResult(QueryImpl.java:1246)\norg.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:1005)\norg.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:861)\norg.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:792)\norg.apache.openjpa.kernel.DelegatingQuery.execute(DelegatingQuery.java:542)\norg.apache.openjpa.persistence.QueryImpl.execute(QueryImpl.java:288)\norg.apache.openjpa.persistence.QueryImpl.getResultList(QueryImpl.java:302) \n... [code outside of OpenJPA)]\n\nThe problematic line in context is (lines 169++):\n\n                 if (buf._userIndex != null) {\n                     if (_userIndex == null) {\n                         _userIndex = new ArrayList();\n                         _userIndex.addAll(buf._userIndex);\n                     } else\n                         _userIndex.addAll(paramIndex*2, buf._userIndex); // Wrong index leads to exception\n                 }\n\nThese lines could be simplified to\n\n                 if (buf._userIndex != null) {\n                     if (_userIndex == null)\n                         _userIndex = new ArrayList();\n                       _userIndex.addAll(buf._userIndex);\n                 }\n\nbecause it always suffices to append the elements of buf._userIndex\nto this._userIndex no matter what the paramIndex is. The structure\nof _userIndex is a list where each parameter is already prepended\nby its position in the sql buffer. Thus, the order of parameters in\n_userIndex is unimportant.\n\nAlso, the code in line 184++ seems suspicious:\n\n        if (_userIndex != null) {\n            // fix up user parameter index\n            for (int i = 0; i < _userIndex.size(); i+=2) {\n                _userIndex.set(i, _userParams.indexOf(_userIndex.get(i+1)));\n            }\n        }\n\nHere, the indizes in _userIndex get corrected by looking into the\n_userParams - list, which contains the correct position. Not only\ndoes this implementation rely on a certain equals()-semantic when\nusing _userParams.indexOf(). As I understand it, the reason for\nstoring the user parameters in the list _userIndex with\n(position, parameter) pairs was that there may be multiple positions\nfor the same parameter in the resulting statement. Does the\ncode above really take into account these cases? I've not\ntested it, but it looks suspicious. You may have a look at my\npatch submitted with OPENJPA-1584 which takes a safer\napproach to adjust the positions in _userIndex.\n\nOn a side note, I was a bit surprised to see many\nif-statements such as in line 131:\n\n        if (sqlIndex == _sql.length())\n            _sql.append(buf._sql.toString());\n        else\n            _sql.insert(sqlIndex, buf._sql.toString());\n\nThis test is useless and these lines could just\nbe replaced with\n\n            _sql.insert(sqlIndex, buf._sql.toString());\n\nA similar if-statement is on line 145:\n\n            if (paramIndex == _params.size()) {\n                _params.addAll(buf._params);\n                [...] // code that is duplicated below\n            } else {\n                _params.addAll(paramIndex, buf._params);\n                [...] // mere duplication of code above\n            }\n\nThe resulting code duplication made it more\ntroublesome than necessary to review this fix.\n(Indeed, the reported IndexOutOfBounds-exception\nonly shows up in one branch of the line 145 if-statement,\nmaking it harder to replicate the bug.)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-24T20:02:21.670+0000","updated":"2010-07-24T20:02:21.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892032","id":"12892032","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Martin Dirichs,\nCould you provide a test case that reproduce the IndexOutOfBoundsException ?\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-24T21:22:20.031+0000","updated":"2010-07-24T21:22:20.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892128","id":"12892128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Some debugging work validates that in what order the parameters are added to _userIndex does not matter, because the positions of the parameters in _userIndex are corrected by look up the Param object  in _userParams.\n\nThe current code block in SQLBuffer.java  (lines 169++):\n(1)\n                 if (buf._userIndex != null) {\n                     if (_userIndex == null) {\n                         _userIndex = new ArrayList();\n                         _userIndex.addAll(buf._userIndex);\n                     } else\n                         _userIndex.addAll(paramIndex*2, buf._userIndex); // Wrong index leads to exception\n                 }\n\nCan be simplified to\n(2)\n                 if (buf._userIndex != null) {\n                     if (_userIndex == null)\n                          _userIndex = new ArrayList();\n                      _userIndex.addAll(buf._userIndex);\n                 } \n\nThere should be no IndexOutOfBoundException in (1). but (2) is more simplified code.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-25T17:53:44.227+0000","updated":"2010-07-25T17:53:44.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892151","id":"12892151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"body":"You find a test case attached in file OpenJPA-trunk_OJ1719.testcase.patch.\n\nYes, with lines 172-174 simplified the code should work correctly.\n\nPerhaps you also find value in my objections to code safety and code duplication stated above.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dirichs","name":"dirichs","key":"dirichs","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Dirichs","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-25T23:18:27.280+0000","updated":"2010-07-25T23:18:27.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892197","id":"12892197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Martin,\nThank you very much for the test case, it produced the IndexOutOfBoundException.\nI will commit the fix soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T06:48:35.484+0000","updated":"2010-07-26T06:48:35.484+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12892332","id":"12892332","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Fix checked in under trunk revision 979326.\nMike,\nCould you please apply  the same fix  to 2.0.x branch ?\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-26T15:42:27.505+0000","updated":"2010-07-26T15:42:27.505+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12468724/comment/12912527","id":"12912527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"body":"Closing issues which have been resolved for some time. If the problem persists, please reopen. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mikedd","name":"mikedd","key":"mikedd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Dick","active":true,"timeZone":"America/Chicago"},"created":"2010-09-20T15:40:00.651+0000","updated":"2010-09-20T15:40:00.651+0000"}],"maxResults":9,"total":9,"startAt":0},"customfield_12311820":"0|i0zbw7:","customfield_12314139":null}}

