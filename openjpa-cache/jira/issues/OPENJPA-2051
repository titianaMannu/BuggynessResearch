{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12523252","self":"https://issues.apache.org/jira/rest/api/2/issue/12523252","key":"OPENJPA-2051","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314517","id":"12314517","description":"OpenJPA 1.2.3 Release","name":"1.2.3","archived":false,"released":true,"releaseDate":"2013-04-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315257","id":"12315257","description":"OpenJPA 2.0.x Maintenance Release","name":"2.0.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315910","id":"12315910","description":"OpenJPA 2.2.0 Release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2012-02-20"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"2275","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314019","id":"12314019","description":"JPA2 release","name":"2.0.0","archived":false,"released":true,"releaseDate":"2010-04-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316191","id":"12316191","description":"OpenJPA 2.1.x maintenance release","name":"2.1.1","archived":false,"released":true,"releaseDate":"2011-07-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315910","id":"12315910","description":"OpenJPA 2.2.0 Release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2012-02-20"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[{"id":"12347057","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12347057","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12538078","key":"OPENJPA-2107","self":"https://issues.apache.org/jira/rest/api/2/issue/12538078","fields":{"summary":"ManagedCache conflict due adding an entity 2 times in the same query.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"289106","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2051/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@3dc6385a[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5408a0c2[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6f105914[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@7e8ffa84[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@32be2277[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@144e63e4[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@79fb5080[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@78a1cee1[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3bcfe618[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@5c79f3c6[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7f25c799[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@905c85a[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2012-06-01T17:47:35.527+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2051/watchers","watchCount":1,"isWatching":false},"created":"2011-09-15T21:12:58.451+0000","updated":"2013-03-06T20:28:39.781+0000","timeoriginalestimate":null,"description":"I've found a scenario where upon transaction commit, certain entities which should be persisted via a cascade operation are not present in the database.  To properly describe this issue, let me start by first introducing a few entities, and then list a snippet of a test which uses these entities to recreate an issue with cascading entities.  That said, take the following three entities:\n\npublic class Vertex {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.AUTO)\n    private long oid;\n\n    @OneToMany(mappedBy = \"source\", cascade = CascadeType.ALL)\n    private List<Edge> outgoing;\n\n    @OneToMany(mappedBy = \"target\", cascade = CascadeType.ALL)\n    private List<Edge> incoming;\n\n    @ManyToOne(cascade = CascadeType.ALL)\n    @JoinColumn(name = \"TYPE_OID\")\n    private VertexType type;\n\n    public Edge newEdge( Vertex target ) {\n        Edge t = new Edge( this );\n        outgoing.add( t );\n        t.setTarget( target );\n        return t;\n    }\n.........\n\n\npublic class VertexType {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.AUTO)    \n    private long oid;\n\n    @OneToMany(mappedBy = \"type\", cascade = CascadeType.ALL)\n    List<Vertex> instances;\n\n    private String name;\n.........\n\n\npublic class Edge {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.AUTO)\n    private long oid;\n\n    @ManyToOne(cascade = CascadeType.ALL)\n    @JoinColumn(name = \"SOURCE_OID\")\n    private Vertex source;\n\n    @ManyToOne(cascade = CascadeType.ALL)\n    @JoinColumn(name = \"TARGET_OID\")\n    private Vertex target;\n.........\n\n\n\nBefore describing the test case, let me point out a couple important things about these entities.  First you will notice that each entity contains a generated id.  Second, notice that there are multiple relationships between these entities. \n\nNow let me introduce the test: \n\nEntityManager em = emf.createEntityManager();\nEntityTransaction tx = em.getTransaction();\n\ntx.begin();\nem.flush();\n\nVertexType defaultType = new VertexType( \"default\" );\nVertexType specialType = new VertexType( \"special\" );\n\nem.persist(defaultType);\nem.persist(specialType);\n\nVertex src = new Vertex( defaultType );\nVertex target = new Vertex( specialType );\n\nEdge t = src.newEdge( target );\nassertNotNull( t );\n\nem.persist(src);\ntx.commit();\n\n\nNotice that one of the first things the test does is to perform a flush.  This may seem slightly odd, however this flush is important to cause the issue.  We could execute a query or some other operation which would cause a flush under the covers, however, calling a flush directly makes it clear that a flush has occurred when looking at the rest of the test.  \n\nWith the entities and test case in place, let me now describe the issue.  After this test case executes, there should exist in the database two Vertex, two VertexType, and one Edge given the cascade type defined in the entities.  However, I find that one of the Vertex is missing.  \n\nIn working with Rick Curtis on this issue, he found that the 'flush' at the beginning of the test had an effect on the cascade persist at the end of the test.  That is, when 'flush' is called, this causes the '_flags' variable in BrokerImpl to be set to flushed as follows:\n\n_flags |= FLAG_FLUSHED;\n\nThis of course effects the return value of the method BrokerImpl.hasFlushed:\n\n    private boolean hasFlushed() {\n        return (_flags & FLAG_FLUSHED) != 0;\n    }\n\nI will now describe how the return value of this method effects the outcome of the test.  However, in an effort of time I am going to skip over some details which I'll leave as an exercise for the reader to figure out (e.g. execute the test in a debugger).  Basically this has an effect on SingleFieldManager.persist when called by StateManagerImpl.cascadePersist.  That is, SingleFieldManager.persist makes a call to method 'isDetached' on the broker here:\n\n case JavaTypes.PC_UNTYPED:\n     if (!_broker.isDetachedNew() && _broker.isDetached(objval))\n         return; // allow but ignore\n     _broker.persist(objval, true, call);\n     break;\n\nCode within 'isDetached' eventually makes a call to 'hasFlushed'.  Given that 'hasFlushed' returns true, it ultimately effects the result of 'isDetached' and thus causing the persist method in the previously posted code block to be skipped.  Again, I'm glossing over some details, but the code path described is also affected by the fact that the ids in these entities are auto generated.\n\n\nIn order to resolve this problem, we feel the best solution is to change the '_flags' variable to indicate a flush has not occurred.  To that end, we propose adding the assignment '_flags &= ~FLAG_FLUSHED'\nto this portion of code in BrokerImpl.setStateManager:\n\n     case STATUS_INIT:\n     \t   _flags &= ~FLAG_FLUSHED;\n         _cache.add(sm);\n         break;\n\n\nIn addition, this new assignment will be gated by a compatibility property.\n\nI've included a test patch, named 'CascadePersistIssue.test.patch' which replicates the issue.\n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12494695","id":"12494695","filename":"CascadePersistIssue.test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2011-09-15T21:14:53.932+0000","size":11928,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12494695/CascadePersistIssue.test.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Entities in a relationship are not properly cascaded after a EntityManager.flush is executed.","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523252/comment/13105690","id":"13105690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"Attaching a test case which replicates the issue described.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2011-09-15T21:14:53.950+0000","updated":"2011-09-15T21:14:53.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12523252/comment/13595067","id":"13595067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"Note that prior to 2.2.1.x/2.2.x, the code of this fix is enabled with the following system property:\n\n<property name=\"openjpa.Compatibility\" value=\"resetFlushFlagForCascadePersist=true\"/>\n\nThanks,\n\nHeath","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2013-03-06T20:28:39.781+0000","updated":"2013-03-06T20:28:39.781+0000"}],"maxResults":2,"total":2,"startAt":0},"customfield_12311820":"0|i1dux3:","customfield_12314139":null}}

