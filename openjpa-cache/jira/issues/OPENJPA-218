{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12367383","self":"https://issues.apache.org/jira/rest/api/2/issue/12367383","key":"OPENJPA-218","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313483","id":"12313483","description":"Early Access 2","name":"2.0.0-M2","archived":false,"released":true,"releaseDate":"2009-06-03"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"160549","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312342","id":"12312342","description":"","name":"0.9.6","archived":true,"released":true,"releaseDate":"2006-11-29"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312340","id":"12312340","description":"","name":"0.9.7","archived":true,"released":true,"releaseDate":"2007-04-27"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":null,"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311302","id":"12311302","name":"kernel","description":"Kernel"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"202544","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knisterpeter","name":"knisterpeter","key":"knisterpeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Markus Wolf","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knisterpeter","name":"knisterpeter","key":"knisterpeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Markus Wolf","active":true,"timeZone":"Europe/Berlin"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-218/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@13219ddc[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5117d660[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@68edb77[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@6945a910[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2e31261b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@44522822[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@347706bc[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@703e340b[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5718d5e9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@25ee410[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@e105001[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@f8fb3a4[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2009-04-02T20:08:31.609+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-218/watchers","watchCount":1,"isWatching":false},"created":"2007-04-17T14:39:12.584+0000","updated":"2010-03-09T18:31:00.650+0000","timeoriginalestimate":null,"description":"When using an application id class containing a reference to another entity (example given below) a NPE is thrown when merging/reattaching the instance to an entity manager. \nThe problem is caused by the involved AttachStrategy where on line 89 (pc.pcNewInstance(null, appId, false);) the call to pcNewInstance is null for the first parameter (StateManager). This statemanager is used to retrieve the object reference when reattaching using the method pcCopyKeyFieldsFromObjectId in the pcNewInstance method.\n\nSource for this bug:\n\n@Entity\n@Table(name = \"domain_record\")\n@IdClass(DomainRecord.DomainRecordId.class)\npublic class DomainRecord implements Serializable {\n\n\tprivate static final long serialVersionUID = 2966781630801201103L;\n\n\tpublic static class DomainRecordId implements Serializable {\n\n\t\tprivate static final long serialVersionUID = 3629556841694516032L;\n\n\t\tprivate String zone;\n\n\t\tprivate String name;\n\n\t\tprivate Type type;\n\n\t\tprivate String data;\n\n\t\tpublic DomainRecordId() {\n\t\t}\n\n\t\tpublic DomainRecordId(DomainRecord record) {\n\t\t\tthis.zone = record.zone.getName();\n\t\t\tthis.name = record.name;\n\t\t\tthis.type = record.type;\n\t\t\tthis.data = record.data;\n\t\t}\n\n\t\tpublic DomainRecordId(String zone, String name, Type type, String data) {\n\t\t\tthis.zone = zone;\n\t\t\tthis.name = name;\n\t\t\tthis.type = type;\n\t\t\tthis.data = data;\n\t\t}\n\n\t\t/**\n\t\t * @see java.lang.Object#hashCode()\n\t\t */\n\t\t@Override\n\t\tpublic int hashCode() {\n\t\t\tfinal int PRIME = 31;\n\t\t\tint result = 1;\n\t\t\tresult = PRIME * result + ((data == null) ? 0 : data.hashCode());\n\t\t\tresult = PRIME * result + ((name == null) ? 0 : name.hashCode());\n\t\t\tresult = PRIME * result + ((type == null) ? 0 : type.hashCode());\n\t\t\tresult = PRIME * result + ((zone == null) ? 0 : zone.hashCode());\n\t\t\treturn result;\n\t\t}\n\n\t\t/**\n\t\t * @see java.lang.Object#equals(java.lang.Object)\n\t\t */\n\t\t@Override\n\t\tpublic boolean equals(Object obj) {\n\t\t\tif (this == obj)\n\t\t\t\treturn true;\n\t\t\tif (obj == null)\n\t\t\t\treturn false;\n\t\t\tif (getClass() != obj.getClass())\n\t\t\t\treturn false;\n\t\t\tfinal DomainRecordId other = (DomainRecordId) obj;\n\t\t\tif (data == null) {\n\t\t\t\tif (other.data != null)\n\t\t\t\t\treturn false;\n\t\t\t} else if (!data.equals(other.data))\n\t\t\t\treturn false;\n\t\t\tif (name == null) {\n\t\t\t\tif (other.name != null)\n\t\t\t\t\treturn false;\n\t\t\t} else if (!name.equals(other.name))\n\t\t\t\treturn false;\n\t\t\tif (type == null) {\n\t\t\t\tif (other.type != null)\n\t\t\t\t\treturn false;\n\t\t\t} else if (!type.equals(other.type))\n\t\t\t\treturn false;\n\t\t\tif (zone == null) {\n\t\t\t\tif (other.zone != null)\n\t\t\t\t\treturn false;\n\t\t\t} else if (!zone.equals(other.zone))\n\t\t\t\treturn false;\n\t\t\treturn true;\n\t\t}\n\n\t}\n\n\t/**\n\t * @author markusw\n\t * @version $Revision$\n\t */\n\tpublic enum Type {\n\t\tA, AAAA, ALIAS, CNAME, HINFO, MX, NAPTR, NS, PTR, RP, SRV, TXT\n\t}\n\n\t@Id\n\t@ManyToOne(fetch = FetchType.LAZY, cascade = { CascadeType.ALL })\n\t@JoinColumn(name = \"domain\", referencedColumnName = \"name\")\n\tprivate Domain zone;\n\n\t@Id\n\t@Column(length = 64)\n\tprivate String name;\n\n\t@Id\n\t@Enumerated(EnumType.STRING)\n\tprivate Type type;\n\n\t@Id\n\t@Column(length = 128)\n\tprivate String data;\n...\n}\n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12404377","id":"12404377","filename":"OPENJPA-218.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-01T20:52:29.014+0000","size":1116,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12404377/OPENJPA-218.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12404386","id":"12404386","filename":"OPENJPA-218-testcase.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-01T21:28:57.786+0000","size":13913,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12404386/OPENJPA-218-testcase.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"pcNewInstance and ApplicationId","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"Java 6","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367383/comment/12489418","id":"12489418","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knisterpeter","name":"knisterpeter","key":"knisterpeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Markus Wolf","active":true,"timeZone":"Europe/Berlin"},"body":"To be more complete I'll attach the NPE stacktrace:\n\njava.lang.NullPointerException\n\tat de.esw.services.featureSelection.DomainRecord.pcCopyKeyFieldsFromObjectId(DomainRecord.java)\n\tat de.esw.services.featureSelection.DomainRecord.pcNewInstance(DomainRecord.java)\n\tat org.apache.openjpa.kernel.AttachStrategy.persist(AttachStrategy.java:89)\n\tat org.apache.openjpa.kernel.VersionAttachStrategy.attach(VersionAttachStrategy.java:85)\n\tat org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:236)\n\tat org.apache.openjpa.kernel.AttachManager.attach(AttachManager.java:97)\n\tat org.apache.openjpa.kernel.BrokerImpl.attach(BrokerImpl.java:3124)\n\tat org.apache.openjpa.kernel.DelegatingBroker.attach(DelegatingBroker.java:1120)\n\tat org.apache.openjpa.persistence.EntityManagerImpl.merge(EntityManagerImpl.java:591)\n\tat org.springframework.orm.jpa.JpaTemplate$6.doInJpa(JpaTemplate.java:272)\n\tat org.springframework.orm.jpa.JpaTemplate.execute(JpaTemplate.java:191)\n\tat org.springframework.orm.jpa.JpaTemplate.merge(JpaTemplate.java:270)\n\tat de.esw.services.domain.DomainRecordProcessorImpl.update(DomainRecordProcessorImpl.java:53)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=knisterpeter","name":"knisterpeter","key":"knisterpeter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Markus Wolf","active":true,"timeZone":"Europe/Berlin"},"created":"2007-04-17T14:51:07.607+0000","updated":"2007-04-17T14:51:07.607+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367383/comment/12694622","id":"12694622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"body":"I tried the following scenario to reproduce this problem without success:\n\n(1) create an EntityManager: em\n(2) create a DomainRecord: record\n(3) call persist: em.persist(record)\n(4) em.flush()\n(5) commit\n(6) em.clear()\n(7) em.merge(record)\n\nThis situation can only be reproduced in the following scenario:\n(1) create an EntityManager: em\n(2) create a DomainRecord: record\n(3) em.merge(record)\n\nWhen merge is called on the record, this record does not have StateManagerImpl yet, causing NPE.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-01T17:09:12.346+0000","updated":"2009-04-01T18:53:38.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12367383/comment/12694732","id":"12694732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"body":"The patch is to fix PCEnhancer to guard against null StateManagerImpl:\n\nBefore the patch:\n-----------------------\n  public void pcCopyKeyFieldsFromObjectId(Object paramObject)\n  {\n    ChildId localChildId = (ChildId)((ObjectId)paramObject).getId();\n    this.id = localChildId.id;\n    Child tmp28_27 = this;\n    tmp28_27.parent = ((Parent)tmp28_27.pcStateManager.getPCPrimaryKey(localChildId, 2 + pcInheritedFieldCount));\n  }\n\nAfter the patch:\n--------------------\n  public void pcCopyKeyFieldsFromObjectId(Object paramObject)\n  {\n    ChildId localChildId = (ChildId)((ObjectId)paramObject).getId();\n    this.id = localChildId.id;\n    if (this.pcStateManager == null)\n      return;\n    Child tmp28_27 = this;\n    tmp28_27.parent = ((Parent)tmp28_27.pcStateManager.getPCPrimaryKey(localChildId, 2 + pcInheritedFieldCount));\n  }\n\nAfter the patch, the test case to merge new entity with IdClass works fine. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=faywang","name":"faywang","key":"faywang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fay Wang","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-01T20:52:29.084+0000","updated":"2009-04-01T20:52:29.084+0000"}],"maxResults":3,"total":3,"startAt":0},"customfield_12311820":"0|i0z1hr:","customfield_12314139":null}}

