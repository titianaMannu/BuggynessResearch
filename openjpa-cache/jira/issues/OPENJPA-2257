{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12605972","self":"https://issues.apache.org/jira/rest/api/2/issue/12605972","key":"OPENJPA-2257","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323356","id":"12323356","description":"OpenJPA 2.2.2 Release","name":"2.2.2","archived":false,"released":true,"releaseDate":"2013-04-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323484","id":"12323484","description":"OpenJPA 2.2.1.x Maintenance Release","name":"2.2.1.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12319463","id":"12319463","description":"OpenJPA 2.3.0","name":"2.3.0","archived":false,"released":true,"releaseDate":"2013-11-24"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"240109","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["concurrency","concurrentmodificationexception","nullpointerexception"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311304","id":"12311304","name":"jpa","description":"Java Persistence API interface"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"3342","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephan82","name":"stephan82","key":"stephan82","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephan Hagedorn","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephan82","name":"stephan82","key":"stephan82","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephan Hagedorn","active":true,"timeZone":"Etc/UTC"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2257/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@1dcd5504[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1ab7c7ef[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@670f572b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@43237c9a[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@42a12377[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@38ec8167[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@25c73f5e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@7d5840d0[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@36297e97[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@6a92268c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7633d94f[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@49525999[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2012-09-05T20:11:23.056+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2257/watchers","watchCount":3,"isWatching":false},"created":"2012-09-03T10:28:41.665+0000","updated":"2013-04-10T15:04:28.560+0000","timeoriginalestimate":null,"description":"A call of EntityManager.getProperties() can lead to NullPointer and ConcurrentModificationException. Issue occurs right after start up of the overlying JEE application if multiple EntityManager instance are created at same time.\n\nPlease find the issued stack trace below:\n\nCaused by: java.lang.NullPointerException\n        at java.lang.String.compareTo(String.java:482)\n        at java.lang.String.compareTo(String.java:31)\n        at java.util.TreeMap.cmp(TreeMap.java:4514)\n        at java.util.TreeMap.putImpl(TreeMap.java:4556)\n        at java.util.TreeMap.put(TreeMap.java:4536)\n        at java.util.TreeSet.add(TreeSet.java:122)\n        at\norg.apache.openjpa.lib.conf.ConfigurationImpl.getPropertyKeys(ConfigurationImpl.java:708)\n        at\norg.apache.openjpa.kernel.BrokerImpl.getSupportedProperties(BrokerImpl.java:729)\n        at\norg.apache.openjpa.kernel.DelegatingBroker.getSupportedProperties(DelegatingBroker.java:223)\n        at\norg.apache.openjpa.persistence.EntityManagerImpl.getProperties(EntityManagerImpl.java:1624)\n        ... 33 more","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12544051","id":"12544051","filename":"OPENJPA-2257.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2012-09-06T14:52:07.035+0000","size":4271,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12544051/OPENJPA-2257.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12543526","id":"12543526","filename":"OpenJPABugTest.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stephan82","name":"stephan82","key":"stephan82","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stephan Hagedorn","active":true,"timeZone":"Etc/UTC"},"created":"2012-09-03T10:32:18.788+0000","size":8121105,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12543526/OpenJPABugTest.zip"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Concurreny in org.apache.openjpa.persistence.EntityManagerImpl.getProperties leads to NullPointer and ConcurrentModificationException","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"AIX 6.1 (64-bit)\nWebSphere Application Server V8.0 (32-bit) ","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12605972/comment/13448979","id":"13448979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"The problem is caused by the assumption that the configurationImpl obtained from emf is threadsafe since all the configuration values are frozen once the emf is created. However the broker getProperty() implementation defers the building up of the property key collection (_supportedKeys) in the configurationImpl when it is needed, but the _supportedKeys is not synchronized( thread safe), hence the observed exceptions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2012-09-05T18:33:02.475+0000","updated":"2012-09-05T18:33:02.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12605972/comment/13449076","id":"13449076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Fixed only in trunk. To get fixes for 2.1.x, you'll need to request it from WebSphere service channel.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2012-09-05T20:11:23.066+0000","updated":"2012-09-05T20:11:23.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12605972/comment/13540513","id":"13540513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"In addition to Albert's changes, I've found that more changes were necessary.  That is, synchronizing on '_supportedKeys' in ConfigurationImpl.getPropertyKeys is necessary and fixes one ConcurrentModificationException/NPE, however, I found another spot which causes a ConcurrentModificationException when the returned '_supportedKeys' is added to by other areas of code.  The exception and stack I saw was the following:\n\njava.util.ConcurrentModification\n\tat java.util.TreeMap$AbstractMapIterator.makeNext(TreeMap.java:5794)\n            at java.util.TreeMap$UnboundedKeyIterator.next(TreeMap.java:5896)\n\tat org.apache.openjpa.persistence.EntityManagerImpl.getProperties(EntityManagerImpl.java:1624)\n\tat Test.run(Test.java:26)\n\n\nFrom the stack, EntityManagerImpl.getProperties is operating on the the set (i.e. '_supportedKeys') returned by ConfigurationImpl.getPropertyKeys.  In a single threaded environment, operating on the set is just fine.  However, in my test, I had found that if one thread is operating on the set (as shown in the stack above), yet another thread is adding to the set, the ConcurrentModification exception can occur.  While the details of my tests are rather long and nearly impossible to hit in a real world situation, let me basically state that I found that if a thread was in the 'EntityManagerImpl.getProperties' listed above, and another thread was in this portion of code in BrokerImpl:\n\n\n     public Set<String> getSupportedProperties() {\n         Set<String> keys = _conf.getPropertyKeys();\n        for (String s : _supportedPropertyNames)\n            keys.add(\"openjpa.\" + s);\n\nA ConcurrentModification exception could occur given that the one thread operating in 'getSupportedProperties' could add to 'keys' (which is really the '_supportedKeys'), and another thread could be iterating over this same set.  This issue seemed to be further complicated, and dependent on, the JDK in use.  I created the above exception by using an IBM JDK which appears to add some inner classes (e.g. .TreeMap$UnboundedKeyIterator) to a TreeMap which performs some additional checks for concurrent access.  Bottom line is that the fix appears to be to return a copy of '_supportedKeys' which is returned by ConfigurationImpl.getPropertyKeys.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2012-12-28T16:56:27.858+0000","updated":"2012-12-28T16:56:27.858+0000"}],"maxResults":3,"total":3,"startAt":0},"customfield_12311820":"0|i00xe7:","customfield_12314139":null}}

