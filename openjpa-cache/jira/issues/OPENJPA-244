{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12370109","self":"https://issues.apache.org/jira/rest/api/2/issue/12370109","key":"OPENJPA-244","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312341","id":"12312341","description":"","name":"1.0.0","archived":false,"released":true,"releaseDate":"2007-08-28"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"42029","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312341","id":"12312341","description":"","name":"1.0.0","archived":false,"released":true,"releaseDate":"2007-08-28"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"202568","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-244/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@7cf82842[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@8a97e45[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6e79de92[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@2de1de4e[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2d0a82c8[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@c61b390[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2c4c71c0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@ffcd9a9[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7699065c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@7765c62c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@38687b71[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@51b0cc44[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2007-08-10T13:05:33.299+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-244/watchers","watchCount":2,"isWatching":false},"created":"2007-05-24T02:48:54.928+0000","updated":"2008-04-15T18:16:52.141+0000","timeoriginalestimate":null,"description":"Via some testing with the WebSphere Application Server, it's been discovered that we're missing some doPriv blocks through out the OpenJPA code base.  This JIRA report will be used to resolve these issues.  More specific examples will be posted later.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12363452","id":"12363452","filename":"OPENJPA.244-2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-08-08T23:55:33.289+0000","size":92370,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12363452/OPENJPA.244-2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12361078","id":"12361078","filename":"OPENJPA-244.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-03T19:13:26.494+0000","size":211892,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12361078/OPENJPA-244.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Java 2 Security enablement","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501019","id":"12501019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"After looking into this Java 2 security issue, here is a proposal to correct the problem in openjpa.\n\nThe goals of the enhancements are:\n\n1) non-intrusive changes.\n2) easy readability and future usages\n3) sensitive to downstream security exposure\n4) maintanence of the additional code.\n\nApproach to the solution:\n1) Create a static helper class J2DoPrivHelper.java in openjpa-lib\\src\\main\\java\\org\\apache\\openjpa\\lib\\util. See attachment for the content. The purpose of this class is isolate Java 2 security related code in one place for control and maintenance.\n2) Each JDK functions that required doPrivileged encasement associated to a static method in the helper class. The name of the method is closely related to the JDK function. If it is an instance method, the first argument is the instance object. So far I have identified 24 JDK helper methods.\n3) Where there is a usage of the security sensitive method call, it can be translated to one of the helper method.\n    E.g.\n    a) From\n            return _url.openStream();\n         To\n            return J2DoPrivHelper.openStream(_url);\n    b) From\n           ClassLoader loader = cls.getClassLoader();\n         To\n           ClassLoader loader = J2DoPrivHelper.getClassLoader(cls);\n    c) From\n            loader = ClassLoader.getSystemClassLoader();\n         To\n            loader = J2DoPrivHelper.getSystemClassLoader();\n\n         To\n4) These method call translations will be to the closest place where the doPriv is needed. This will eliminate the possible security \"leak\" in the down stream code. E.g. callback to unsecured code inside the doPriv encasement.\n5) There are approximately 71 files affected, excluding test cases that use the same security sensitive methods.\n6) Document the permissions required by Java 2 security used in openjpa.\n    E.g.\n      permission java.lang.RuntimePermission  \"getClassLoader\";\n      permission java.io.FilePermission       \"<<ALL FILES>>\",        \"read\"; \n\nI have a prototype of these changes and it is working in the WebSphere environment.\n\nI am open for suggestions and ideas. I continue to work on this path unless I hear there is any objection otherwise.\n\nThanks.\nAlbert Lee","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-03T15:41:39.488+0000","updated":"2007-06-03T15:41:39.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501024","id":"12501024","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"Would it make any sense to, rather than having a class with static methods, having an interface/abstract class and a static INSTANCE?  Then some initialization (static) code could decide which implementation is appropriate for the environment: e.g. if no security manager is installed we wouldn't need the doPrivileged code?  I don't know if going through the doPrivileged code when it isn't doing anything incurs enough expense to make this worthwhile.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-03T16:12:12.716+0000","updated":"2007-06-03T16:12:12.716+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501065","id":"12501065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"If you choose not to have an interface and two classes selected by whether the security manager is active or not, I'd suggest adding a \nstatic final boolean isSecure = System.getSecurityManager() != null; \n\nand then testing it for each method, e.g. \n\n    public static final ClassLoader getClassLoader (final Class clazz)\n    {\nif(isSecure) {\n        return (ClassLoader) AccessController\n                .doPrivileged(new PrivilegedAction()\n                {\n                    public Object run ()\n                    {\n                        return clazz.getClassLoader();\n                    }\n                });\n} else {\nreturn clazz.getClassLoader();\n}\n    }\n\nIf the variable isSecure is static final we need to be sure that the class is never loaded before the security manager is activated, otherwise we will get the wrong answer.\n\nAs the patch is written as of June 3, each call will at minimum create a new object on the heap that needs to be garbage collected, and calling doPriv when there is no security manager is a waste.\n\nIn any case, it's good to isolate the calls to this class so I'm +1 on making the rest of the changes and we can worry about the implementation details when we see if there is any performance impact one way or the other.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-03T23:53:10.647+0000","updated":"2007-06-03T23:53:10.647+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501371","id":"12501371","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitesh","name":"mitesh","key":"mitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Meswani","active":true,"timeZone":"Etc/UTC"},"body":"Including a class like J2DoPrivHelper as part of trusted code might be dangerous from security point of view.  For example. some malicious code  that otherwise does not enough privileges can now call J2DoPrivHelper.getDeclaredFields() to get access to fields of a class. AFAIK, there is no easy way to completely factor out doPrivileged blocks without compromising secuity :(","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitesh","name":"mitesh","key":"mitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Meswani","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-04T21:23:27.871+0000","updated":"2007-06-04T21:23:27.871+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501590","id":"12501590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Mitesh, You bring up a very good point.\n\nI need to investigate more and see if there are alternatives other than in-lining doPrivileged in the openjpa code base.\n\nThanks for you insight into this matter.\nAlbert Lee","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-05T15:15:04.571+0000","updated":"2007-06-05T15:15:04.571+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501604","id":"12501604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"What is possible is to hide the nasty mechanical construction of a new instance of the anonymous inner class by a wrapper method. \n\nPerhaps Mitesh can post examples (used in CDDL-licensed TopLink Essentials) that preserve the doPrivileged method call in the correct place but delegates the construction of the instance to a wrapper. The resulting code is much more readable than the usual inline doPrivileged and avoids the security hole.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-05T16:05:50.708+0000","updated":"2007-06-05T16:05:50.708+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501617","id":"12501617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"I noticed that there are many openjpa classes have a static final caching the line.separator (or something similiar) from the system properties. This kind of general resource that required doPriv can be customized in the helper without any security exposure and still make the code readable.\n\nprivate static final String SEP = J2DoPrivHelper.getLineSeparator();\n\npublic static final String J2DoPrivHelper.getLineSeparator()\n{\n        if (System.getSecurityManager() != null)\n        {\n            return (Properties) AccessController\n                    .doPrivileged(new PrivilegedAction()\n                    {\n                        public Object run ()\n                        {\n                            return System.getProperty(\"line.separator\");\n                        }\n                    });\n        } else\n        {\n            return System.getProperty(\"line.separator\");\n        }\n}\n\nThese type of functions can also be cached in the helper for performance too.\n\nAlbert Lee.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-05T17:07:42.439+0000","updated":"2007-06-05T17:07:42.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501621","id":"12501621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"What the example code does is to allow any untrusted code with access to the J2DoPrivHelper class to get the value for the line separator. \n\nWhile this doesn't sound like a big deal, it's still violating the security featureSelection.\n\nA solution is to code this in the trusted code:\nprivate static final String SEP = (Properties) AccessController.doPrivileged(\n    J2DoPrivHelper.getLineSeparatorAction());\n\nAnd then the helper class is responsible for:\npublic static PrivilegedAction getLineSeparatorAction() {\n    return new PrivilegedAction() {\n                       public Object run () \n                        { \n                            return System.getProperty(\"line.separator\"); \n                        } \n                    }); \n}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-05T17:28:59.807+0000","updated":"2007-06-05T17:28:59.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12501638","id":"12501638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitesh","name":"mitesh","key":"mitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Meswani","active":true,"timeZone":"Etc/UTC"},"body":">What is possible is to hide the nasty mechanical construction of a new instance of the anonymous inner class by a wrapper method.\n\nHere is an example for invoking a method reflectively \n\n                try {\n                    AccessController.doPrivileged(new PrivilegedMethodInvoker(method, null, args));\n                } catch (PrivilegedActionException exception) {\n                    Exception throwableException = exception.getException();\n                }\n\nwhere PrivilegedMethodInvoker is as follows\n\npublic class PrivilegedMethodInvoker implements PrivilegedExceptionAction {\n\n    private Method method;\n    private Object target;\n    private Object[] args;\n    \n    public PrivilegedMethodInvoker(Method method, Object target, Object[] args){\n        this.method = method;\n        this.target = target;\n        this.args = args;\n    }\n    \n    public Object run() throws IllegalAccessException, InvocationTargetException {\n        return PrivilegedAccessHelper.invokeMethod(method, target, args);\n    }\n    \n}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mitesh","name":"mitesh","key":"mitesh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Meswani","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-05T18:02:45.286+0000","updated":"2007-06-05T18:02:45.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502379","id":"12502379","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Having specific function(s) in J2DoPrivHelp that required doPriv is to isolate common access function without security exposure and hopefully improve performance. Since there is no user parameters allowed by the helpers, even the getLineSeparator() is public, user is only allowed to get the lineSeparator string and no other resources security leak.\n\nThe wrapper method approach is to provide means to create the Privilege(Exception)Action object but the doPrivileged will still be in-lined in the openjpa code to avoid undesirable security exposure. \n\nHere is a new proposal:\n\n1) The J2DoPrivHelper defines the common security safe functions and PrivilegedAction getters (example):\n        \n       public static final String getLineSeparator();\n       public static final Object getOtherSpecificSecuritySafeResource();\n       .......\n \n       public static final PrivilegedAction getClassLoaderAction(final ClassLoader loader);\n       public static final PrivilegedExceptionAction getDeclaredMethodAction(final Class clazz, final String name, final Class[] parameterTypes);\n       .......\n\n2)  J2DoPrivHelper usage:\n\n       private static final String SEP = J2DoPrivHelper.getLineSeparator(); \n\n       ClassLoader loader = (ClassLoader) AccessController.doPrivileged( J2DoPrivHelper.getClassLoaderAction( clazz ) );\n\n        try {\n              AccessController.doPrivileged(J2DoPrivHelper.getDeclaredMethodAction( clazz, name, args));\n        } catch (PrivilegedActionException exception) {\n               NoSuchMethodException ex = (NoSuchMethodException)exception.getException();\n        } \n\n3) If there is any situation where testing security is enabled before the doPriv pattern is used, it will need to be in-lined in user code.\n\nPlease comment and indicate if this is an acceptable solution.\n\nThanks.\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-07T15:15:44.066+0000","updated":"2007-06-07T15:15:44.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502397","id":"12502397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"I think that an important design goal here is minimal invasiveness into the code. Java 2 security is something that many of us have never seen as an issue in practice, so ensuring that the security-friendly mechanisms are just as easy to use as the unfriendly versions is pretty important IMO.\n\nAdditionally, I'm concerned about the extra overhead incurred by these calls, which makes  me think that caching might be a good idea.\n\nGiven that you demonstrate in point 2 above that it is legit to cache the return values of the security-wrapping calls, can we achieve better encapsulation? For example, why not just have a J2DoPrivHelper.getDeclaredMethod() call that does the right thing internally?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-07T16:00:28.137+0000","updated":"2007-06-07T16:00:28.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502399","id":"12502399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"Additionally, from a performance standpoint, it seems like we should make the J2DoPrivHelper methods non-static, create an interface, and provide access to the instance via the OpenJPAConfiguration object. This will allow us to have an impl that doesn't do security checks at all and a separate impl that does the security checks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-07T16:01:52.510+0000","updated":"2007-06-07T16:01:52.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502455","id":"12502455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":">>  I think that an important design goal here is minimal invasiveness into the code. Java 2 security is something that many of us have never seen as an issue in practice, so ensuring that the security-friendly mechanisms are just as easy to use as the unfriendly versions is pretty important IMO. \n\nI agree with you.  This is one of the goal set right from the beginning. See the first comment .\n\n>>  Additionally, I'm concerned about the extra overhead incurred by these calls, which makes me think that caching might be a good idea. \n\nWe have also considered and discussed the performance aspects. There will be 2 extra calls, i.e. AccessController and PrivelegedAction.run if security is enabled.  This can not be avoid.  However the JIT may optimize/in-line the call as the runtime is stablized.  Architectually, I agree making the helper methods non-static to encapsulate the doPriv wrapper function for the security disable scenario is desirable. However this will sill incur a minimum of 1 and 3 method calls for security disable and enable scernario respectively. e.g.    helper.getDeclaredMethod()     and helper.getDeclaredMethod() -> AccessController -> run().\n\n>> Given that you demonstrate in point 2 above that it is legit to cache the return values of the security-wrapping calls, can we achieve better encapsulation? For example, why not just have a J2DoPrivHelper.getDeclaredMethod() call that does the right thing internally?\n\nIf I hear you right, the sugguestion is to have all the doPriv processing in the J2DoPrivHelper.getDeclaredMethod().   This was the original proposal and Mitesh has pointed out that this is a security leak. See previous comment.\n\n>> Additionally, from a performance standpoint, it seems like we should make the J2DoPrivHelper methods non-static, create an interface, and provide access to the instance via the OpenJPAConfiguration object. This will allow us to have an impl that doesn't do security checks at all and a separate impl that does the security checks.\n\nSounds good. \n\nI'll draft another proposal and post it back here soon.\n\nThanks.\nAlbert Lee","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-07T18:07:58.007+0000","updated":"2007-06-07T18:07:58.007+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502515","id":"12502515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"> > Given that you demonstrate in point 2 above that it is legit to cache the\n> > return values of the security-wrapping calls, can we achieve better \n> > encapsulation? For example, why not just have a J2DoPrivHelper.getDeclaredMethod()\n> > call that does the right thing internally?\n> \n> If I hear you right, the sugguestion is to have all the doPriv processing in the \n> J2DoPrivHelper.getDeclaredMethod().   This was the original proposal and Mitesh\n> has pointed out that this is a security leak. See previous comment.\n\n... but it looks like your most recent proposal shares this leak, since it has methods like getLineSeparator(). We should either make all of the methods secure and consider it a goal to not allow that leak, or make all of the helper methods behave the same, no?\n\n-Patrick","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-07T21:11:12.396+0000","updated":"2007-06-07T21:11:12.396+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12502647","id":"12502647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"The getLineSeparator() will not compromise security because this function only return specifically the line.separator String and nothing else, hence there is no side effect. This method may cache the value for performance and better code readability and maintenance.\n\nIn the original proposal, application can call one of the J2DoPrivHelper public methods which may grant user resource privileges on behalf of the caller, which is not good. If there is a resource requires privilege, the AccessController.doPrivileged() must be in-line in the openjpa code base, but the \"new Privilege(Exception)Action\" can be common or factor out.  Even if the doPrivilege() is inlined, one must also be careful not to allow any public method to be accessed by the application with user specified resource that eventually grant privilege to access the resource.\n\n>>> Additionally, from a performance standpoint, it seems like we should make the J2DoPrivHelper methods non-static, create an interface, and provide access to the instance via the OpenJPAConfiguration object. This will allow us to have an impl that doesn't do security checks at all and a separate impl that does the security checks.\n\n>Sounds good. \n\nAfter some thought on this topics, I just realized that use of interface will not work. The same reason as just described. The interface can only get the PrivilegedAction because the doPriv must be in-lined. E.g.\n\nThe use cases are:\n\n   private static final String SEP = J2DoPrivHelper.getLineSeparator();\n\n   ClassLoader loader = (ClassLoader) (System.getSecurityManager() == null)\n                            ? clazz.getClassLoader()\n                            : AccessController.doPrivileged( J2DoPrivHelper.getClassLoaderAction( clazz ) );\n\n   try\n   {\n       method = ( System.getSecurityManager() == null )\n                   ? clazz.getDeclaredMethod(name,parameterType)\n                   : (Method) AccessController.doPrivileged( J2DoPrivHelper.getDeclaredMethodAction( clazz, name, parameterType) );\n   } catch( PrivilegedActionException pae )\n   {\n           throws (NoSuchMethodException)pae.getException()\n   }\n\n\n       ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-08T05:03:52.113+0000","updated":"2007-06-08T05:03:52.113+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509131","id":"12509131","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Based on the previous design/implementation discussions. attached is a fix to enable Java 2 security in openjpa implementation.\n\nTested platforms\n----------------\nBasic tests runs on Win32 system and have verified on WebSphere Application Server with security both disabled/enabled.\n\nTest profile option\n-------------------\nA new profile 'enabled-security' is added to openjpa pom.xml to enable running tests with security on. The default is seourity off. \n\nE.g. To run test with security on, \n   mvn test -P enabled-security,test-derby\n\nTCK \n---\nTests passed and no regression.\n\nPerformance\n-----------\nOverall no difference when security is off but showed a 8.4% degradation with security on.\n\n1) Results: base revision run before any changes were made.\n            > mvn test \n[INFO] ------------------------------------------------------------------------\n[INFO] Reactor Summary:\n[INFO] ------------------------------------------------------------------------\n[INFO] OpenJPA ............................................... SUCCESS [0.016s]\n[INFO] OpenJPA Utilities ..................................... SUCCESS [6.718s]\n[INFO] OpenJPA Kernel ........................................ SUCCESS [3.532s]\n[INFO] OpenJPA JDBC .......................................... SUCCESS [0.328s]\n[INFO] OpenJPA XML Store ..................................... SUCCESS [0.047s]\n[INFO] OpenJPA Kernel 1.5 .................................... SUCCESS [0.078s]\n[INFO] OpenJPA JPA ........................................... SUCCESS [0.078s]\n[INFO] OpenJPA JDBC 1.5 ...................................... SUCCESS [0.031s]\n[INFO] OpenJPA JPA JDBC ...................................... SUCCESS [1:10.547s]\n[INFO] OpenJPA Aggregate Jar ................................. SUCCESS [1.547s]\n[INFO] OpenJPA Distribution .................................. SUCCESS [0.141s]\n[INFO] OpenJPA Integration Tests ............................. SUCCESS [0.000s]\n[INFO] OpenJPA Examples Integration Tests .................... SUCCESS [0.000s]\n[INFO] OpenJPA JPA TCK Integration Tests ..................... SUCCESS [0.000s]\n[INFO] OpenJPA Xmlmapping 1.5 ................................ SUCCESS [0.015s]\n[INFO] OpenJPA Persistence Examples .......................... SUCCESS [0.031s]\n[INFO] ------------------------------------------------------------------------\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESSFUL\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 1 minute 23 seconds\n[INFO] Finished at: Fri Jun 29 10:18:45 CDT 2007\n[INFO] Final Memory: 10M/28M\n[INFO] ------------------------------------------------------------------------\n\n2) Results: base revision plus patch applied, run with default security disabled.\n            > mvn test \n[INFO] ------------------------------------------------------------------------\n[INFO] Reactor Summary:\n[INFO] ------------------------------------------------------------------------\n[INFO] OpenJPA ............................................... SUCCESS [0.000s]\n[INFO] OpenJPA Utilities ..................................... SUCCESS [7.718s]\n[INFO] OpenJPA Kernel ........................................ SUCCESS [3.625s]\n[INFO] OpenJPA JDBC .......................................... SUCCESS [0.407s]\n[INFO] OpenJPA XML Store ..................................... SUCCESS [0.031s]\n[INFO] OpenJPA Kernel 1.5 .................................... SUCCESS [0.094s]\n[INFO] OpenJPA JPA ........................................... SUCCESS [0.093s]\n[INFO] OpenJPA JDBC 1.5 ...................................... SUCCESS [0.032s]\n[INFO] OpenJPA JPA JDBC ...................................... SUCCESS [1:09.453s]\n[INFO] OpenJPA Aggregate Jar ................................. SUCCESS [1.156s]\n[INFO] OpenJPA Distribution .................................. SUCCESS [0.125s]\n[INFO] OpenJPA Integration Tests ............................. SUCCESS [0.000s]\n[INFO] OpenJPA Examples Integration Tests .................... SUCCESS [0.000s]\n[INFO] OpenJPA JPA TCK Integration Tests ..................... SUCCESS [0.000s]\n[INFO] OpenJPA Xmlmapping 1.5 ................................ SUCCESS [0.031s]\n[INFO] OpenJPA Persistence Examples .......................... SUCCESS [0.032s]\n[INFO] ------------------------------------------------------------------------\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESSFUL\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 1 minute 23 seconds\n[INFO] Finished at: Fri Jun 29 09:30:18 CDT 2007\n[INFO] Final Memory: 10M/23M\n[INFO] ------------------------------------------------------------------------\n\n3) Results: base revision plus patch applied, run with security enabled.\n            > mvn test -P enable-security,test-derby\n\n[INFO] ------------------------------------------------------------------------\n[INFO] Reactor Summary:\n[INFO] ------------------------------------------------------------------------\n[INFO] OpenJPA ............................................... SUCCESS [0.016s]\n[INFO] OpenJPA Utilities ..................................... SUCCESS [7.969s]\n[INFO] OpenJPA Kernel ........................................ SUCCESS [3.234s]\n[INFO] OpenJPA JDBC .......................................... SUCCESS [0.438s]\n[INFO] OpenJPA XML Store ..................................... SUCCESS [0.093s]\n[INFO] OpenJPA Kernel 1.5 .................................... SUCCESS [0.110s]\n[INFO] OpenJPA JPA ........................................... SUCCESS [0.078s]\n[INFO] OpenJPA JDBC 1.5 ...................................... SUCCESS [0.047s]\n[INFO] OpenJPA JPA JDBC ...................................... SUCCESS [1:16.312s]\n[INFO] OpenJPA Aggregate Jar ................................. SUCCESS [2.094s]\n[INFO] OpenJPA Distribution .................................. SUCCESS [0.125s]\n[INFO] OpenJPA Integration Tests ............................. SUCCESS [0.000s]\n[INFO] OpenJPA Examples Integration Tests .................... SUCCESS [0.000s]\n[INFO] OpenJPA JPA TCK Integration Tests ..................... SUCCESS [0.000s]\n[INFO] OpenJPA Xmlmapping 1.5 ................................ SUCCESS [0.016s]\n[INFO] OpenJPA Persistence Examples .......................... SUCCESS [0.046s]\n[INFO] ------------------------------------------------------------------------\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESSFUL\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time: 1 minute 30 seconds\n[INFO] Finished at: Fri Jun 29 09:39:55 CDT 2007\n[INFO] Final Memory: 10M/23M\n[INFO] ------------------------------------------------------------------------\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-06-29T15:37:23.673+0000","updated":"2007-06-29T15:37:23.673+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509204","id":"12509204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mprudhom","name":"mprudhom","key":"mprudhom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mprudhom&avatarId=45285","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mprudhom&avatarId=45285","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mprudhom&avatarId=45285","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mprudhom&avatarId=45285"},"displayName":"Marc Prud'hommeaux","active":true,"timeZone":"America/New_York"},"body":"After quick review, the patch looks good to me. Anyone else have any opinions an committing it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mprudhom","name":"mprudhom","key":"mprudhom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mprudhom&avatarId=45285","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mprudhom&avatarId=45285","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mprudhom&avatarId=45285","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mprudhom&avatarId=45285"},"displayName":"Marc Prud'hommeaux","active":true,"timeZone":"America/New_York"},"created":"2007-06-29T21:16:13.700+0000","updated":"2007-06-29T21:16:13.700+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509220","id":"12509220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm reviewing it right now. Will be done in an hour.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-29T23:24:42.050+0000","updated":"2007-06-29T23:24:42.050+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509227","id":"12509227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"Very nice piece of work, Albert.\n\nThe original patch should be removed since it's no longer valid.\n\nJust a few comments on the patch itself.\n\n1. Typos in javadoc for almost all the methods in J2DoPrivHelper, e.g. \nPrivilegeExceptionAction should be PrivilegedExceptionAction\n\n2. The cases where you call  this.getClass().getClassLoader()) don't need to be wrapped in a doPrivileged block. \n\n(From the javadoc of getClassLoader, If a security manager is present, and the caller's class loader is not null and the caller's class loader is not the same as or an ancestor of the class loader for the class whose class loader is requested, then this method calls the security manager's checkPermission method with a RuntimePermission(\"getClassLoader\") permission to ensure it's ok to access the class loader for the class.)\n\n3. In openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java\nyou might have missed this case:\n@@ -238,12 +246,18 @@\n             if (loader == THREAD_LOADER)\n                 loader = Thread.currentThread().getContextClassLoader();\n \n4. Several cases of try or catch with the { on the following line instead of on the same line.\n\n5. In openjpa-xmlstore/src/main/java/org/apache/openjpa/xmlstore/XMLFileHandler.java\n\ndon't you need to have a doPrivileged around f.length() ? The javadoc would suggest so.\n\n6. javadoc typos in newFIleOutputStreamAction methods in J2Helper class\n\n7. I don't understand the rationale for newInstanceOfAction. I guess I don't know what a BCClass is and why its behavior is different from Class.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-30T00:43:58.109+0000","updated":"2007-06-30T00:43:58.109+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509610","id":"12509610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Craig, Thanks for the detailed review.\n\n>> 1. Typos in javadoc for almost all the methods in J2DoPrivHelper, e.g.\nPrivilegeExceptionAction should be PrivilegedExceptionAction\n\nDone.\n\n>> 2. The cases where you call this.getClass().getClassLoader()) don't need to be wrapped in a doPrivileged block.\n>>\n>> (From the javadoc of getClassLoader, If a security manager is present, and the caller's class loader is not null and the caller's class loader is not the same as or an ancestor of the class loader for the class whose class loader is requested, then this method calls the security manager's checkPermission method with a RuntimePermission(\"getClassLoader\") permission to ensure it's ok to access the class loader for the class.)\n\nDone. There are 14 instances that can take advantage of these performance short-cut.\n\n>> 3. In openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java\nyou might have missed this case:\n>> @@ -238,12 +246,18 @@\n             if (loader == THREAD_LOADER)\n                 loader = Thread.currentThread().getContextClassLoader();\n \nGood eye.. Done.\n\n>> 4. Several cases of try or catch with the { on the following line instead of on the same line.\n\nAll fixed up\n\n>> 5. In openjpa-xmlstore/src/main/java/org/apache/openjpa/xmlstore/XMLFileHandler.java\n>> \n>> don't you need to have a doPrivileged around f.length() ? The javadoc would suggest so.\n\nYou are correct. Somehow I don't get any security exception even without the doPriv wrapping. I have added a new lengthAction and \"do the right thing\" now.\n\n>> 6. javadoc typos in newFIleOutputStreamAction methods in J2Helper class\n\nDone.\n\n>> 7. I don't understand the rationale for newInstanceOfAction. I guess I don't know what a BCClass is and why its behavior is different from Class. \n\nThe BCClass is from serp and it needs getClassLoader permission to perform some privileged operations. Since we cannot instrument the doPriv wrapping in Serp, we delegated and moved up the doPriv in OpenJPA code base, hence the need for the 2 newCodeAction and isInstanceOfAction.\n\nThank everyone's input to enable the security feature in openjpa. \n\nIf there is no further comments, we'll commit this changes. This completed and concluded Jira-244.\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-02T16:36:32.214+0000","updated":"2007-07-02T16:36:32.214+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509632","id":"12509632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":">> 3. In openjpa-lib/src/main/java/org/apache/openjpa/lib/util/MultiClassLoader.java you might have missed this case: \n>> @@ -238,12 +246,18 @@ \n>>             if (loader == THREAD_LOADER) \n>>                 loader = Thread.currentThread().getContextClassLoader(); \n  \n>Good eye.. Done. \n\n>> 5. In openjpa-xmlstore/src/main/java/org/apache/openjpa/xmlstore/XMLFileHandler.java don't you need to have a doPrivileged around f.length() ? The javadoc would suggest so. \n\n> You are correct. Somehow I don't get any security exception even without the doPriv wrapping. I have added a new lengthAction and \"do the right thing\" now. \n\nMy only concern now is that without the above changes, your tests ran correctly. Do you have a test bench where the caller is not privileged and the OpenJPA is privileged? One suspicious change is in the security permissions file: \n+// ================================================================\n+// The following permissions are needed to invoke the 'test' target in OpenJPA maven build.\n+grant {\n+  permission java.security.AllPermission;\n+};\n+\n\nThis would appear to grant everyone AllPermissions, which might explain why the tests all work. Can this be restricted to granting permission to just the test framework (javax.junit) and see what happens?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-07-02T17:52:15.486+0000","updated":"2007-07-02T17:52:15.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509647","id":"12509647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Craig,\n\nI wrote a small program to test the validity of the required permission for File.length() and it showed below that proper permission/doPriv is required for this method and it matches the javadoc description.\n\n------------------------------------------\n\npackage test;\nimport java.io.File;\npublic class TestFileLength {\n    public static void main(String[] args) {\n        File f = new File(\"C:\\\\a.workspace\\\\eclipse.workspace\\\\ejb3.serv1\\\\testSer\\\\src\\\\test\\\\TestFileLength.java\");\n        System.out.println(f.length());\n    }\n}\n\nC:\\a.workspace\\eclipse.workspace\\ejb3.serv1\\testSer\\build\\classes>type j2.security.test.policy\ngrant {\n     permission java.io.FilePermission       \"<<ALL FILES>>\",    \"read\";\n};\n\nC:\\a.workspace\\eclipse.workspace\\ejb3.serv1\\testSer\\build\\classes>java -cp . test.TestFileLength\n1266\n\nC:\\a.workspace\\eclipse.workspace\\ejb3.serv1\\testSer\\build\\classes>java -cp . -Djava.security.manager test.TestFileLength\n\nException in thread \"main\" java.security.AccessControlException: Access denied (java.io.FilePermission C:\\a.workspace\\ec\nlipse.workspace\\ejb3.serv1\\testSer\\src\\test\\TestFileLength.java read)\n        at java.security.AccessController.checkPermission(AccessController.java:104)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:547)\n        at java.lang.SecurityManager.checkRead(SecurityManager.java:886)\n        at java.io.File.length(File.java:839)\n        at test.TestFileLength.main(TestFileLength.java:38)\n\nC:\\a.workspace\\eclipse.workspace\\ejb3.serv1\\testSer\\build\\classes>java -cp . -Djava.security.manager -Djava.security.policy=j2.security.test.policy test.TestFileLength\n1266\n\nC:\\a.workspace\\eclipse.workspace\\ejb3.serv1\\testSer\\build\\classes>\n------------------------------------------\n\nMay be the reason the tests passed before is because the first condition of the expression in XMLFileHandler is false and the f.length() is not evaluated.\n\n-        if (!f.exists() || f.length() == 0)\n\nBTW, scanning for .length() in the source code one more time and I found another instance of _file.length() that needs the doPriv. I corrected the problem and a new patch is attached.\n\nAlbert Lee.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-02T19:25:59.114+0000","updated":"2007-07-02T19:25:59.114+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509685","id":"12509685","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for your attention to detail here. I'm still concerned that the patch to the security policy file that grants all permissions to all code bases masks the issues. See my comments from earlier today 10:52 AM.\n\nCraig","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-07-02T21:33:51.112+0000","updated":"2007-07-02T21:33:51.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509987","id":"12509987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Craig,\n\nAfter some experimentation to narrow down the code bases and permissions required  for the test bucket, here is the refined policy:\n\n// derby code base\ngrant CodeBase \"file:///${user.home}/.m2/repository/org/apache/derby/derby/-\" {\n\n    permission java.io.FilePermission           \"<<ALL FILES>>\",    \"read,write,delete\";\n    permission java.lang.RuntimePermission                          \"createClassLoader\";\n    permission java.util.PropertyPermission     \"derby.*\",          \"read\";\n};\n\n// openjpa code base.\ngrant CodeBase \"file:///${test.basedir}/-\" {\n\n    permission java.io.FilePermission           \"<<ALL FILES>>\",    \"read,write\";\n    permission java.io.SerializablePermission                       \"enableSubstitution\";\n    permission java.lang.RuntimePermission                          \"accessDeclaredMembers\";\n    permission java.lang.RuntimePermission                          \"createClassLoader\";\n    permission java.lang.RuntimePermission                          \"getClassLoader\";\n    permission java.lang.RuntimePermission                          \"setIO\";\n    permission java.lang.reflect.ReflectPermission                  \"suppressAccessChecks\";\n    permission java.util.PropertyPermission     \"*\",                \"read,write\";\n};\n\n// depending packages code base, e.g junit, surefire etc.\ngrant CodeBase \"file:///${user.home}/.m2/repository/-\" {\n\n    permission java.io.FilePermission           \"<<ALL FILES>>\",    \"read,write\";\n    permission java.io.SerializablePermission                       \"enableSubstitution\";\n    permission java.lang.RuntimePermission                          \"accessDeclaredMembers\";\n    permission java.lang.RuntimePermission                          \"createClassLoader\";\n    permission java.lang.RuntimePermission                          \"getClassLoader\";\n    permission java.lang.RuntimePermission                          \"setContextClassLoader\";\n    permission java.lang.RuntimePermission                          \"setIO\";\n    permission java.lang.reflect.ReflectPermission                  \"suppressAccessChecks\";\n    permission java.util.PropertyPermission     \"*\",                \"read,write\";\n};\n\nAttached is a new patch with this new policy.\n\nI hope this has addressed your concern.\n\nAlbert Lee,","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-03T19:13:26.649+0000","updated":"2007-07-03T19:13:26.649+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12509990","id":"12509990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"Nice job. Ship it.\n\nCraig","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-07-03T19:24:24.985+0000","updated":"2007-07-03T19:24:24.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12510015","id":"12510015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mprudhom","name":"mprudhom","key":"mprudhom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mprudhom&avatarId=45285","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mprudhom&avatarId=45285","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mprudhom&avatarId=45285","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mprudhom&avatarId=45285"},"displayName":"Marc Prud'hommeaux","active":true,"timeZone":"America/New_York"},"body":"I'm re-opening the issue because it looks like there are at least a few secure calls that were missed. I ran a test by building a new rt.jar with a java.lang.SecurityException that extends java.lang.Exception (instead of java.lang.RuntimeException), and then compiling the openjpa classes with the new rt.jar in the bootclasspath, which does a nice job at finding all the calls to methods that might throw SecutiryException.\n\nFor example, FieldMetaData.java:1477 contains the line \"Method[] methods = cls.getMethods()\".\n\nAre these oversights, or is there some reason that these calls don't need to be wrapped in doPriv blocks?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mprudhom","name":"mprudhom","key":"mprudhom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mprudhom&avatarId=45285","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mprudhom&avatarId=45285","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mprudhom&avatarId=45285","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mprudhom&avatarId=45285"},"displayName":"Marc Prud'hommeaux","active":true,"timeZone":"America/New_York"},"created":"2007-07-03T22:50:25.743+0000","updated":"2007-07-03T22:50:25.743+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12510020","id":"12510020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"I almost commented on this earlier. I'm not sure that the grant of CodeBase \"file:///${user.home}/.m2/repository/-\" { and grant CodeBase \"file:///${test.basedir}/-\" { are correct.\n\nThe grants might mask the required grants in OpenJPA by \"catching\" the illegal access by the test case or the framework. \n\nDo we know why the test.basedir needs e.g. suppressAccessChecks? Do the test cases themselves use reflection?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-07-03T23:36:45.739+0000","updated":"2007-07-03T23:36:45.739+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12510045","id":"12510045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Marc,\n\nFinding 'ALL' the security sensitive calls are tedious and error-prone. I probably have missed some along the way.\n\nI like your approach to get a more complete picture and catch them all.  I'll try to see if I can go through it one more time to be sure.\n\nStay tune.\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-04T02:29:04.093+0000","updated":"2007-07-04T02:29:04.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12510269","id":"12510269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":">> I'm re-opening the issue because it looks like there are at least a few secure calls that were missed. I ran a test by building a new rt.jar with a java.lang.SecurityException that extends java.lang.Exception (instead of java.lang.RuntimeException), and then compiling the openjpa classes with the new rt.jar in the bootclasspath, which does a nice job at finding all the calls to methods that might throw SecutiryException.\n\nThis is a reasonable technique to catch some/most of the methods.  If the calling method has a try {  } catch (Exception e)... bracket the security sensitive call, it will still compile without error.  I'll need to use some other means, in combination to this suggestion, to get a more complete picture.\n\n>> For example, FieldMetaData.java:1477 contains the line \"Method[] methods = cls.getMethods()\".\n\n>> Are these oversights, or is there some reason that these calls don't need to be wrapped in doPriv blocks?\n\nThere are a set of getter methods in Class.class, e.g. getMethod(s), getField(s), getClasses, getConstructor(s) etc.. documented to throw SecurityException. The contract for these methods are:\n\n-----------------------------\n    SecurityException - If a security manager, s, is present and any of the following conditions is met:\n\n        * invocation of s.checkMemberAccess(this, Member.PUBLIC) denies access to the field\n        * the caller's class loader is not the same as or an ancestor of the class loader for the current class and invocation of s.checkPackageAccess() denies access to the package of this class \n-----------------------------\n\nThe reason no doPriv is needed for these conditons are:\n1) Since all these methods returns public/visible constructs, s.CheckMemberAccess(PUBLIC) will always pass with no exception.\n2) If s.checkPackageAccess() is tested, we need to make sure the package of this class is not in java.security 's \"package.access\" list. If it is, explicit permission must be specified in the policy, Typically, I only see \"sun.\" package is in this \"package.access\" list, therefore, we do not see any security violation for this condition.\n\nI'm continuing to investigate and make sure no security sensitive method calls are missed. I'll leave the Jira report open for further required changes.\n\nThanks Marc.\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-05T03:24:39.466+0000","updated":"2007-07-05T03:24:39.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12510271","id":"12510271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":">> I almost commented on this earlier. I'm not sure that the grant of CodeBase \"file:///${user.home}/.m2/repository/-\" { and grant CodeBase \"file:///${test.basedir}/-\" { are correct.\n\nTypically a security exception stack looks something like this:\n\njava.security.AccessControlException: Access denied (java.util.PropertyPermission localRepository write)\n        at java.security.AccessController.checkPermission(AccessController.java:104)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:547)\n        at java.lang.System.setProperty(System.java:385)\n        at org.apache.maven.surefire.booter.SurefireBooter.setSystemProperties(SurefireBooter.java:624)\n        at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:692)\n\nor\n\njava.security.AccessControlException: Access denied (java.lang.reflect.ReflectPermission suppressAccessChecks)\n        at java.security.AccessController.checkPermission(AccessController.java:104)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:547)\n        at java.lang.reflect.AccessibleObject.setAccessible(AccessibleObject.java:119)\n        at org.apache.openjpa.event.MethodLifecycleCallbacks.makeCallback(MethodLifecycleCallbacks.java:87)\n        at org.apache.openjpa.event.LifecycleEventManager.makeCallbacks(LifecycleEventManager.java:329)\n        at org.apache.openjpa.event.LifecycleEventManager.fireEvent(LifecycleEventManager.java:291)\n        at org.apache.openjpa.kernel.BrokerImpl.fireLifecycleEvent(BrokerImpl.java:671)\n        at org.apache.openjpa.kernel.BrokerImpl.persist(BrokerImpl.java:2393)\n        at org.apache.openjpa.kernel.BrokerImpl.persist(BrokerImpl.java:2244)\n        at org.apache.openjpa.kernel.DelegatingBroker.persist(DelegatingBroker.java:1010)\n        at org.apache.openjpa.persistence.EntityManagerImpl.persist(EntityManagerImpl.java:541)\n        at org.apache.openjpa.persistence.callbacks.TestExceptionsFromCallbacks.testPrePersistException(TestExceptionsFromCallbacks.java:50)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:615)\n        at junit.framework.TestCase.runTest(TestCase.java:154)\n        at junit.framework.TestCase.runBare(TestCase.java:127)\n        at junit.framework.TestResult$1.protect(TestResult.java:106)\n        at junit.framework.TestResult.runProtected(TestResult.java:124)\n        at junit.framework.TestResult.run(TestResult.java:109)\n        at junit.framework.TestCase.run(TestCase.java:118)\n        at junit.framework.TestSuite.runTest(TestSuite.java:208)\n        at junit.framework.TestSuite.run(TestSuite.java:203)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:615)\n        at org.apache.maven.surefire.junit.JUnitTestSet.execute(JUnitTestSet.java:210)\n        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.executeTestSet(AbstractDirectoryTestSuite.java:135)\n        at org.apache.maven.surefire.suite.AbstractDirectoryTestSuite.execute(AbstractDirectoryTestSuite.java:122)\n        at org.apache.maven.surefire.Surefire.run(Surefire.java:129)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:64)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:615)\n        at org.apache.maven.surefire.booter.SurefireBooter.runSuitesInProcess(SurefireBooter.java:225)\n        at org.apache.maven.surefire.booter.SurefireBooter.main(SurefireBooter.java:747)\n\nThe 3 major packages that needs security permission are org.apache.maven.surefire.*, junit.* and org.apache.*.Test*. The CodeBase \"file:///${user.home}/.m2/repository/-\" is for the first 2 package category and CodeBase \"file:///${test.basedir}/-\" is for the openjpa test cases. So the 'grant's are needed for these CodeBase. \n\nI can further narrow down the surefire and junit. However some of the openjpa tests use the same packages as the code (e.g. org.apache.openjpa.persistence.jdbc), so the grant codebase for the tests may not be specific just to the test packages.\n\n>> The grants might mask the required grants in OpenJPA by \"catching\" the illegal access by the test case or the framework.\n\nI agree, see reason before.\n\n>> Do we know why the test.basedir needs e.g. suppressAccessChecks? Do the test cases themselves use reflection?\n\nThis is a oversight because AccessibleObject.setAccessible is not being bracketted with doPrive.  I'll get this fix.\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-07-05T03:42:19.569+0000","updated":"2007-07-05T03:42:19.569+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12518578","id":"12518578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"After a more comprehensive search, here is the second ( and hopefully last ) round of changes needed to enable Java 2 security.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-08-08T23:55:33.431+0000","updated":"2007-08-08T23:55:33.431+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12518583","id":"12518583","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"body":"Looks good. Just a couple of comments:\n\n1. Lots of cases of white space differences. Here's an example:\nIndex: openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java\n===================================================================\n--- openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java\t(revision 562121)\n+++ openjpa-kernel/src/main/java/org/apache/openjpa/enhance/PCEnhancer.java\t(working copy)\n@@ -14,7 +14,7 @@\n  * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n  * KIND, either express or implied.  See the License for the\n  * specific language governing permissions and limitations\n- * under the License.    \n+ * under the License.\n\nI have no objection to cleaning up white space (removing trailing spaces, converting tabs to spaces, etc.) but it should be a separate checkin with an innocuous \"Fixed white space\" comment.\n\n2. In file Index: openjpa-kernel/src/main/java/org/apache/openjpa/util/Serialization.java\nshould we define a new action for this case:\n@@ -104,7 +105,12 @@\n             throws IOException {\n             super(delegate);\n             _ctx = ctx;\n-            enableReplaceObject(true);\n+            AccessController.doPrivileged(new PrivilegedAction() {\n+                public Object run() {\n+                    enableReplaceObject(true);\n+                    return null;\n+                }\n+            });\n         }\nlike J2DoPrivHelper.replaceObject()?\n\n3. And the same for enableResolveObject?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clr","name":"clr","key":"clr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clr&avatarId=38583","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clr&avatarId=38583","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clr&avatarId=38583","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clr&avatarId=38583"},"displayName":"Craig L Russell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-09T00:22:07.268+0000","updated":"2007-08-09T00:22:07.268+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12518820","id":"12518820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Craig, \n\nThanks for reviewing the patch.\n\nRegarding the Serialization changes that the enableReplaceObject PrivilegedAction is created in-line in the code and not in J2DoPrivHelper, the reasons are:\n\n1) PersistentObjectOutputStream extends ObjectOutputStream.\n2) enabelReplaceObject is defined in ObjectOutputStream and is qualified as protected.\n3) enabelReplaceObject is called in the PersistentObjectOutputStream constructor.\n4) Initially, I had the following helper to get the enableReplaceObjectAction, \n\n    public static final PrivilegedAction enableReplaceObjectAction(\n        final ObjectOutputStream oos, final boolean enable) {\n        return new PrivilegedAction() {\n            public Object run() {\n                oos.enableReplaceObject(enable);\n                return null;\n            }\n        };\n    }\n\nbut this will not compile due to:\n\nJ2DoPrivHelper.java: enableReplaceObject(boolean) has protected access in java.io.ObjectOutputStream\n                oos.enableReplaceObject(enable);\n                   ^\n\nHence the in-line alternative is used to perform the doPrivlege call.\n\nThe same reason applies to the ObjectInputStream.enableResolveObject method call.\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-08-09T19:18:19.283+0000","updated":"2007-08-09T19:18:19.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12370109/comment/12519012","id":"12519012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"I believe Albert's patch that I just committed now resolves this Issue.  As Albert pointed out, hopefully we have found and fixed all of these java 2 security holes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2007-08-10T13:05:33.260+0000","updated":"2007-08-10T13:05:33.260+0000"}],"maxResults":34,"total":34,"startAt":0},"customfield_12311820":"0|i0z1n3:","customfield_12314139":null}}

