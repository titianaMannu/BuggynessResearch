{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12716905","self":"https://issues.apache.org/jira/rest/api/2/issue/12716905","key":"OPENJPA-2507","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325298","id":"12325298","description":"OpenJPA 2.4.0","name":"2.4.0","archived":false,"released":true,"releaseDate":"2015-04-22"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"395113","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":["criteria_api","openjpa"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315910","id":"12315910","description":"OpenJPA 2.2.0 Release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2012-02-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12319463","id":"12319463","description":"OpenJPA 2.3.0","name":"2.3.0","archived":false,"released":true,"releaseDate":"2013-11-24"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12325298","id":"12325298","description":"OpenJPA 2.4.0","name":"2.4.0","archived":false,"released":true,"releaseDate":"2015-04-22"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[{"id":"12388837","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12388837","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12536051","key":"OPENJPA-2098","self":"https://issues.apache.org/jira/rest/api/2/issue/12536051","fields":{"summary":"Criteria Query fails with empty context statck","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316305","id":"12316305","name":"criteria","description":"Issues relating to the JPA Criteria API and usage, as well as the associted MetaModel API and AnnotationProcessor."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"395247","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2507/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@441e8398[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4b9d8413[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@27a57a9d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@3fcf66[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3e704137[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@108405c4[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1c79f4db[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@62434ccd[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5e06c04b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@6e1c446a[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3d10aa5e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@454dac15[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2014-07-09T16:15:09.330+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2507/watchers","watchCount":6,"isWatching":false},"created":"2014-05-27T20:57:04.992+0000","updated":"2015-06-06T14:25:14.117+0000","timeoriginalestimate":null,"description":"Using spring-data-jpa with openjpa, I sometimes encounter a strange error (not all the times, but under heavy load it makes its appearance, sparsely though):\n....\nCaused by: java.util.EmptyStackException\n        at java.util.Stack.peek(Stack.java:<arbitrary line>)\n        at org.apache.openjpa.persistence.criteria.CriteriaQueryImpl.ctx(CriteriaQueryImpl.java:<arbitrary line>\n....\n\nI do not know which behaviour triggers it, however I think it would be an improvement to change (I did not know where exactly to file it, because it is both an improvement and a bug in my opinion), in org.apache.openjpa.persistence.criteria.CriteriaQueryImpl, method: Context ctx(), this:\nreturn _contexts == null || _contexts.isEmpty() ? null :  _contexts.peek();\nto something like this:\ntry {\n\treturn _contexts == null || _contexts.isEmpty() ? null :  _contexts.peek();\n} catch (EmptyStackException e) {\n    return null;\n}\n\n, in order to prevent a case where multiple threads modify the \"_contexts\" between the evaluation of the inline \"if\".\n\n\n\nI am not able to reproduce it all the time, thus I can't create a useful test, neither have I created a patch due to the simplicity of the 'fix'. However I believe it is a harmless fix which could be considered a minor improvement.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648117","id":"12648117","filename":"exceptions.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T10:47:11.306+0000","size":16797,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12648117/exceptions.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648132","id":"12648132","filename":"OPENJPA-2507-Wrap-ContextStack-in-ThreadLocal.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomasd","name":"thomasd","key":"thomasd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomasd&avatarId=40065","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomasd&avatarId=40065","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomasd&avatarId=40065","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomasd&avatarId=40065"},"displayName":"Thomas Darimont","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T12:05:47.553+0000","size":3472,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12648132/OPENJPA-2507-Wrap-ContextStack-in-ThreadLocal.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648116","id":"12648116","filename":"openjpa-exception-demo.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T10:47:11.301+0000","size":7285,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12648116/openjpa-exception-demo.zip"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Weird EmptyStackException in CriteriaQueryImpl","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"openjpa 2.2.0 & 2.3.0, spring-data-jpa up to 1.4.2","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14010628","id":"14010628","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"Although I understand the logic behind your suggestion -- to prevent the EmptyStackException -- I don't necessarily agree with the reasoning for this change.  If multiple threads are getting into this method, then I think we have bigger issues with this class. None of the instance variables are protected for multiple thread access.  So, if we're having issues with the Stacks, we should be hitting issues with the Maps, and Lists, and other collections.\n\nGiven that, I also found an older JIRA (openjpa-2098) which seems to have hit a similar issue.  Pinaki had resolved that issue by putting in the null and isEmpty() checks that you are referencing.  So, it seems we are putting band-aids on this issue without fully understanding the source.\n\nThe common link between the two scenarios is the use of the spring-data-jpa feature.  Not pointing fingers at this, just highlighting the common aspect of the two descriptions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2014-05-28T01:14:46.491+0000","updated":"2014-05-28T01:14:46.491+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14010860","id":"14010860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"body":"I have not seen the source of spring-data very closely to see if it caches CriteriaQueryImpl (even though after your comment I suspect that that is the case, or something of the sort, like modifying the contexts using get/setContexts), but since this class was never intended to be accessed by multiple threads, then there is no reason to protect that part of the class only.\n\nHowever, Stacks' methods are synchronized and there is only a setter for contexts (these are the main differences from the other Maps/Lists inside CriteriaQueryImpl), perhaps if there is an explanation to the problem would be related to those. I am not saying this is worth the effort, but I am just curious as to why we have a problem with the specific method (Context ctx()) in two tickets which are probably related.\n\nJust to mention it, since I tested the proposed fix myself, I haven't seen something related to CriteriaQueryImpl again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"created":"2014-05-28T07:02:54.303+0000","updated":"2014-05-28T07:02:54.303+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14011108","id":"14011108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"Interesting.  The more I look into this default Stack implementation, it doesn't look to be very solid.  Even in the Javadoc for Stack, it recommends the use of Deque instead:\n\n\"A more complete and consistent set of LIFO stack operations is provided by the Deque[1] interface and its implementations, which should be used in preference to this class. For example:\n\n   Deque<Integer> stack = new ArrayDeque<Integer>();\"\n\n[1]  http://docs.oracle.com/javase/7/docs/api/java/util/Deque.html\n\nAnd, looking at the Deque's peek operation, it doesn't throw an exception if it's empty, it just returns null.  It might be better to just use the Deque collection instead of Stack...  Of course, this would have a larger ripple effect in the code base...\n\nIt's good to know that your proposed hack seems to resolve the issue for you.  Maybe that's what we need to do for the time being and worry about the \"larger fish\" at a later time...  I have also reached out to Pinaki to see if he has any preference.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2014-05-28T13:57:46.866+0000","updated":"2014-05-28T13:57:46.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14011133","id":"14011133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"body":"My initial thought was that since the Deque interface was introduced in java 6, there might be compatibility reasons as to why someone would choose Stack over Deque.\n\nGlad to be (even of minor) help :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ialex","name":"ialex","key":"ialex","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ioannis Alexandrakis","active":true,"timeZone":"Europe/Helsinki"},"created":"2014-05-28T14:25:16.547+0000","updated":"2014-05-28T14:25:57.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14016290","id":"14016290","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oliver.gierke","name":"oliver.gierke","key":"oliver.gierke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oliver.gierke&avatarId=29138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oliver.gierke&avatarId=29138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oliver.gierke&avatarId=29138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oliver.gierke&avatarId=29138"},"displayName":"Oliver Drotbohm","active":true,"timeZone":"Europe/Berlin"},"body":"Just to confirm this: Spring Data JPA is caching {{CriteriaQuery}} instances as - in contrast to {{EntityManager}} and {{EntityManagerFactory}} - there's no hint in the spec about the {{CriteriaQuery}} instances to be allowed to not be thread safe, once constructed and equipped with predicates.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=oliver.gierke","name":"oliver.gierke","key":"oliver.gierke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=oliver.gierke&avatarId=29138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=oliver.gierke&avatarId=29138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=oliver.gierke&avatarId=29138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=oliver.gierke&avatarId=29138"},"displayName":"Oliver Drotbohm","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T07:25:49.035+0000","updated":"2014-06-03T07:26:06.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14016377","id":"14016377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"body":"I experienced this very bug and created a demo project (see attached {{openjpa-exception-demo.zip}}) - if that helps. Just execute {{LoadTest#parallelTest}} and invariably one of the exceptions in {{exceptions.txt}} will be thrown. One of those is the {{EmptyStackException}}.\n\nIt is easy to reproduce this without Spring Data by using this alternative implementation for the {{DemoRepository}} interface from the demo project:\n\n{code:java}\n@Component\npublic class ManualDemoRepository implements DemoRepository {\n\n\t@Autowired\n\tEntityManager entityManager;\n\n\tCriteriaQuery<DemoEntity> criteriaQuery;\n\n\t@PostConstruct\n\tpublic void initQuery() {\n\t\tCriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();\n\t\tcriteriaQuery = criteriaBuilder.createQuery(DemoEntity.class);\n\n\t\tRoot<DemoEntity> demoRoot = criteriaQuery.from(DemoEntity.class);\n\n\t\tcriteriaQuery.select(demoRoot).where(criteriaBuilder.equal(demoRoot.get(DemoEntity_.demoNumber), 42));\n\t}\n\n\t@Override\n\tpublic DemoEntity findByDemoNumber(int demoNumber) {\n\t\treturn entityManager.createQuery(criteriaQuery).getSingleResult();\n\t}\n}\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T10:47:11.311+0000","updated":"2014-06-03T10:50:59.042+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14016419","id":"14016419","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomasd","name":"thomasd","key":"thomasd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomasd&avatarId=40065","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomasd&avatarId=40065","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomasd&avatarId=40065","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomasd&avatarId=40065"},"displayName":"Thomas Darimont","active":true,"timeZone":"Europe/Berlin"},"body":"Hello,\n\nI just had a look at this and I think a solution that fixes this issue.\n\nI noticed by debugging the provided example app that an instance of {{org.apache.openjpa.persistence.criteria.CriteriaQueryImpl}} is shared between multiple instances of {{org.apache.openjpa.jdbc.kernel.JDBCStoreQuery}}. In {{CriteriaQueryImpl}} the {{_contexts}} field is read and written by multiple threads. \n\nI think the problem lies in {{org.apache.openjpa.persistence.criteria.CriteriaQueryImpl.getQueryExpressions(ExpressionFactory)}}:\n{code:java}\n   QueryExpressions getQueryExpressions(ExpressionFactory factory) {\n        _contexts = new Stack<Context>();\n        Context context = new Context(null, null, null);\n        _contexts.push(context);\n        return new CriteriaExpressionBuilder().getQueryExpressions(factory, this);\n    }   \n{code}\nSince the (shared) {{_context}} field is modified and read by multiple threads this causes the spurious NPE / EmptyStackExceptions to appear.\nOne (relatively easy) way to solve this would be to just wrap the {{_context}} in a {{ThreadLocal}} - I added a patch file that does exactly that. Note that we remove the stored ThreadLocal value when we leave {{getQueryExpressions}}\n\nWith this fixed I could run the provided example app without any problems. This patch would work for openjpa 2.3.0 as well as 2.4.0.\nI tested this with openjpa 2.3.0 directly. I created the patch from the latest svn head for 2.4.0.\n\nCheers,\nThomas","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomasd","name":"thomasd","key":"thomasd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomasd&avatarId=40065","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomasd&avatarId=40065","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomasd&avatarId=40065","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomasd&avatarId=40065"},"displayName":"Thomas Darimont","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T12:04:57.852+0000","updated":"2014-06-03T12:04:57.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14016420","id":"14016420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomasd","name":"thomasd","key":"thomasd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomasd&avatarId=40065","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomasd&avatarId=40065","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomasd&avatarId=40065","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomasd&avatarId=40065"},"displayName":"Thomas Darimont","active":true,"timeZone":"Europe/Berlin"},"body":"Patch that wraps the _context field in {{org.apache.openjpa.persistence.criteria.CriteriaQueryImpl<T>}} in a ThreadLocal.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomasd","name":"thomasd","key":"thomasd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomasd&avatarId=40065","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomasd&avatarId=40065","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomasd&avatarId=40065","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomasd&avatarId=40065"},"displayName":"Thomas Darimont","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-03T12:05:47.559+0000","updated":"2014-06-03T12:05:47.559+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14016505","id":"14016505","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"Thank you, Thomas.  I like this approach the best thus far.  I agree with where you think the problem originates.  And, I didn't like the idea of changing the data structure itself due to the ripple effect to other parts. But, wrapping the Stack in a ThreadLocal seems to be an easy, safe mechanism to overcome the problem.  I want to experiment and look at the patch a bit more to ensure that we're removing this ThreadLocal appropriately, otherwise we could end up with a leak.\n\nThanks, Kevin","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2014-06-03T13:39:25.456+0000","updated":"2014-06-03T13:39:25.456+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14027057","id":"14027057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"With some minor modifications, the patch provided by Thomas looks good.  I've reviewed the code and experimented with it and have not reproduced the problem either.  I plan to commit this change to trunk (2.4.0) shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2014-06-10T21:24:00.416+0000","updated":"2014-06-10T21:24:00.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14027079","id":"14027079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1601778 from [~kwsutter] in branch 'openjpa/trunk'\n[ https://svn.apache.org/r1601778 ]\n\nOPENJPA-2507.  Committing a variation of Thomas Darimont's patch that utilizes ThreadLocal storage to safeguard the _contexts in CriteriaQueryImpl.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2014-06-10T21:47:32.780+0000","updated":"2014-06-10T21:47:32.780+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14040572","id":"14040572","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"body":"That's great news! Are there any plans about when 2.4 will be released?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=viadavid","name":"viadavid","key":"viadavid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Bilge","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-23T09:40:26.562+0000","updated":"2014-06-23T09:40:43.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716905/comment/14056409","id":"14056409","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"body":"No plans currently.  We're working through some issues with Java 7, Java 8, ASM, and Serp on trunk (2.4.0)...  Once these items get addressed, then we could entertain a possible 2.4.0 release.  To be honest, if you require this change in a formal release, you might want to pursue this fix in one of the service streams and pushing for a service release.  Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kwsutter","name":"kwsutter","key":"kwsutter","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin W. Sutter","active":true,"timeZone":"America/Chicago"},"created":"2014-07-09T16:14:37.293+0000","updated":"2014-07-09T16:15:46.196+0000"}],"maxResults":13,"total":13,"startAt":0},"customfield_12311820":"0|i1w11j:","customfield_12314139":null}}

