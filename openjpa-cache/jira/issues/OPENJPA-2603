{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12852374","self":"https://issues.apache.org/jira/rest/api/2/issue/12852374","key":"OPENJPA-2603","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323484","id":"12323484","description":"OpenJPA 2.2.1.x Maintenance Release","name":"2.2.1.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324305","id":"12324305","description":"OpenJPA 2.2.x Maintenance Release","name":"2.2.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12332295","id":"12332295","description":"OpenJPA 2.4.1","name":"2.4.1","archived":false,"released":true,"releaseDate":"2016-02-21"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323484","id":"12323484","description":"OpenJPA 2.2.1.x Maintenance Release","name":"2.2.1.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324305","id":"12324305","description":"OpenJPA 2.2.x Maintenance Release","name":"2.2.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12332295","id":"12332295","description":"OpenJPA 2.4.1","name":"2.4.1","archived":false,"released":true,"releaseDate":"2016-02-21"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311304","id":"12311304","name":"jpa","description":"Java Persistence API interface"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2603/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@6e165919[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@40e8fdd2[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7c02e6c7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@7b8392f8[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@39070908[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@1cc83132[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7717d8b2[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@106480fa[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@11aa94b7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@4cb67611[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@52de57d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@31fad672[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2015-10-19T02:12:26.503+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2603/watchers","watchCount":2,"isWatching":false},"created":"2015-08-05T20:32:24.957+0000","updated":"2015-10-19T02:12:26.534+0000","timeoriginalestimate":null,"description":"I have a scenario, albeit a very odd one, where by doing multiple 'merge' calls on the same unmanaged entity causes an exception.  I say that it is an 'odd' case because of the fact that an 'unmanaged' entity is being merged multiple times.  The proper way to handle the scenario is to merge the managed instance.  I'll attach a test to recreate/demonstrate the issue, but for now here are code snippets we can use to explain the issue:\n\n@Entity\n@IdClass( LineItemPK.class )\npublic class LineItem {\n\t@Id\n\t@Column( name = \"ORDER_ID\", nullable = false )\n\tprivate Long orderId;\n\t\n\t@Id\n\t@Column( name = \"ITEM_ID\", nullable = false )\n\tprivate Long itemId;\n......\n\n@Embeddable\npublic class LineItemPK implements Serializable {\n\t@Column( name = \"ORDER_ID\", nullable = false )\n\tprivate Long orderId;\n\t\n\t@Column( name = \"ITEM_ID\", nullable = false )\n\tprivate Long itemId;\n......\n\n@Entity\n@Table( name = \"ORDER_TABLE\" )\npublic class Order {\n      @Id \n      @Column( name = \"ID\", nullable = false )\n      private Long id; \n\n      @OneToMany( fetch = FetchType.EAGER, cascade = CascadeType.ALL )\n      @JoinColumn( name = \"ORDER_ID\", referencedColumnName = \"ID\" )\n      private List<LineItem> items;\n......\n\n\nWith these classes, take this test:\n\nem.getTransaction().begin();\nOrder order = new Order( 1l );\n        \nLineItem item = new LineItem( \"my product\", 44, 4.99f );\norder.addItem(item);\n\n//NOTE: Notice that throughout the rest of the test the unmanaged order is //merged.  Throughout the rest of the test we should do a \n//'order = em.merge(order)', or something to that effect (i.e. use the //'managed' order).  However, technically speaking merging the unmanaged //order is not wrong, albeit odd and potentially error prone.        \nem.merge(order);\nem.getTransaction().commit();\n\nem.getTransaction().begin();\nLineItem additional = new LineItem( \"My second product\", 1, 999.95f );\norder.addItem(additional);\norder.setOrderEntry( new Date( System.currentTimeMillis() ) );\nem.merge(order);\n//NOTE: do a flush here and all works fine:\n//em.flush();\nem.merge(order);\nem.getTransaction().commit();\n\nAs you can see, the unmanaged order is merged.  As my comments above suggest this is odd, but technically not wrong.  What makes this case interesting is that if we change LineItem to use a single PK rather than a compound PK, all works fine!    The issue can also be resolve by performing a strategic 'flush' as commented above.  Furthermore, the exception the above test yields is:\n\nCaused by: <openjpa-2.1.2-SNAPSHOT-r422266:1686894M fatal general error> org.apache.openjpa.persistence.PersistenceException: Column 'ORDER_ID'  cannot accept a NULL value. {prepstmnt 27085446 UPDATE ITEM_TABLE SET ORDER_ID = ? WHERE ORDER_ID = ? [params=(null) null, (long) 1]} [code=20000, state=23502]\n\nThis is rather meaningless and is caused because OpenJPA executes this SQL when doing the third merge:\n\nopenjpa.jdbc.SQL - <t 3968441, conn 30267242> executing prepstmnt 27085446 UPDATE ITEM_TABLE SET ORDER_ID = ? WHERE ORDER_ID = ? [params=(null) null, (long) 1]\n\nGiven the odd message, and the fact that things work for the same exact scenario when a single PK is used, and the fact that it can be resolved iwth a 'flush', it makes sense to fix this issue.  \n\nFinally, I can't stress enough that the proper way to perform the above test is to use the MANAGED version of the 'order'.  In other words, replace all 'em.merge(order)' with 'order = em.merge(order)'.  The above scenario creates far more SQL statements because of merging an unmanaged entity than if you merged a managed entity.\n\nThanks,\n\nHeath","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12748936","id":"12748936","filename":"OPENJPA-2603-2.1.x.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2015-08-05T21:43:03.302+0000","size":16038,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12748936/OPENJPA-2603-2.1.x.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Merging an unmanaged entity multiple (3) times leads to an exception.","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12852374/comment/14962023","id":"14962023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1709201 from [~jpaheath] in branch 'openjpa/branches/2.1.x'\n[ https://svn.apache.org/r1709201 ]\n\nOPENJPA-2603: Merging an unmanaged entity multiple (3) times leads to an exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-10-17T18:29:12.640+0000","updated":"2015-10-17T18:29:12.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12852374/comment/14962030","id":"14962030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1709202 from [~jpaheath] in branch 'openjpa/branches/2.2.1.x'\n[ https://svn.apache.org/r1709202 ]\n\nOPENJPA-2603: Merging an unmanaged entity multiple (3) times leads to an exception.  Merged 2.1.x changes to 2.2.1.x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-10-17T18:33:28.069+0000","updated":"2015-10-17T18:33:28.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12852374/comment/14962031","id":"14962031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1709203 from [~jpaheath] in branch 'openjpa/branches/2.2.x'\n[ https://svn.apache.org/r1709203 ]\n\nOPENJPA-2603: Merging an unmanaged entity multiple (3) times leads to an exception.  Merged 2.1.x changes to 2.2.x.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-10-17T18:35:01.028+0000","updated":"2015-10-17T18:35:01.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12852374/comment/14962035","id":"14962035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1709205 from [~jpaheath] in branch 'openjpa/trunk'\n[ https://svn.apache.org/r1709205 ]\n\nOPENJPA-2603: Merging an unmanaged entity multiple (3) times leads to an exception.  Merged 2.1.x changes to trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-10-17T18:37:37.308+0000","updated":"2015-10-17T18:37:37.308+0000"}],"maxResults":4,"total":4,"startAt":0},"customfield_12311820":"0|i2idwv:","customfield_12314139":null}}

