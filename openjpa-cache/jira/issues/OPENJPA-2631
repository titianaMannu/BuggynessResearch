{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12938647","self":"https://issues.apache.org/jira/rest/api/2/issue/12938647","key":"OPENJPA-2631","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323484","id":"12323484","description":"OpenJPA 2.2.1.x Maintenance Release","name":"2.2.1.1","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324305","id":"12324305","description":"OpenJPA 2.2.x Maintenance Release","name":"2.2.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334871","id":"12334871","description":"OpenJPA-2.4.2","name":"2.4.2","archived":false,"released":true,"releaseDate":"2017-01-03"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317142","id":"12317142","description":"","name":"2.1.2","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324305","id":"12324305","description":"OpenJPA 2.2.x Maintenance Release","name":"2.2.3","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12332295","id":"12332295","description":"OpenJPA 2.4.1","name":"2.4.1","archived":false,"released":true,"releaseDate":"2016-02-21"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[{"id":"12459445","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12459445","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12436065","key":"OPENJPA-1307","self":"https://issues.apache.org/jira/rest/api/2/issue/12436065","fields":{"summary":"Problems with parameterized JPQLs and EmbeddedId","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316305","id":"12316305","name":"criteria","description":"Issues relating to the JPA Criteria API and usage, as well as the associted MetaModel API and AnnotationProcessor."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12311309","id":"12311309","name":"query","description":"Issues related to query execution, including the JPQL parser and internal query representation."},{"self":"https://issues.apache.org/jira/rest/api/2/component/12311310","id":"12311310","name":"sql","description":"Issues to do with SQL, including generation of SQL. Issues that have to do with JDBC (i.e., execution of SQL statements and result set processing) should be filed in the jdbc component."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2631/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@751afbc8[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@232205cf[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@655fc40e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@5660a917[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2817b9cf[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@22b8eab4[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@39dc2559[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@6a271b64[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7f6b1e2e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@1a63b63d[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@424dbec5[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@106371d3[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2016-06-24T03:44:49.106+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2631/watchers","watchCount":4,"isWatching":false},"created":"2016-02-11T23:28:57.831+0000","updated":"2017-07-20T20:33:59.365+0000","timeoriginalestimate":null,"description":"Take the following entity:\n\n@Entity\npublic class Subject implements Serializable {\n\n\t@EmbeddedId\n\tprivate SubjectKey key;\n.......\n\nWhere SubjectKey is as follows:\n\n@Embeddable\npublic class SubjectKey implements Serializable {\n\tprivate Integer subjectNummer;\n\n\tprivate String subjectTypeCode;\n......\n\n\nAs you can see we have a composite primary key.  With this, take this query:\n\nTypedQuery<Subject> query = em.createQuery(\"select s from Subject s where s = :subject\", Subject.class);\nquery.setParameter(\"subject\", s);\nSubject s2 = query.getSingleResult();\n\nThis query will yield the following exception:\n\njava.lang.ClassCastException: org.apache.openjpa.persistence.embed.compositepk.SubjectKey cannot be cast to \n[Ljava.lang.Object;]\nat org.apache.openjpa.jdbc.kernel.exps.Param.appendTo(Param.java:149)\n\n\nIf we execute a corresponding 'em.find' of Subject, this exception doesn't occur.  Furthermore, if you execute the same query for an entity with an @EmbeddedId that only contains one field, all will work as expected.  The issue here is with an equals query where the entity contains an @EmbeddableId with more than two fields.\n\nWhile investigating/debugging this issue, I've found further issues when creating the query using CriteriaBuilder; both with an @Embeddable and @IdClass composite PKs.  I will leave it as an exercise for the reader to view the attached test case to see how each issue can occur.  Each test method details what issue it recreated before the fixes to this issue.  I'm also attaching a patch with a proposed fix for the issues.  \n\nThanks,\n\nHeath Thomann","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12808830","id":"12808830","filename":"OPENJPA-2631-2.1.x.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2016-06-08T03:46:13.373+0000","size":51753,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12808830/OPENJPA-2631-2.1.x.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"ClassCastException occurs when an equals comparison query is executed on an entity with an @EmbeddedId that contains more than one field.","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15144007","id":"15144007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"For posterity's sake, and given this was a complex issue to debug/fix, I'd like to document some of the steps I took to debug this....sorry, it might be a bit awkward but better than nothing should I/we ever need to revisit this issue.  :)  This debug assumes knowledge of the attached test.  The issue occurs here:\n\n    public void appendTo(Select sel, ExpContext ctx, ExpState state, \n        SQLBuffer sql, int index) {\n        ParamExpState pstate = (ParamExpState) state;\n        if (pstate.otherLength > 1)\n            sql.appendValue(((Object[]) pstate.sqlValue)[index],    <------ line 149\n                pstate.getColumn(index), this);\n\nNote that I added a system out in this 'if' block, then I ran the OpenJPA JUnit bucket.  I found that ONLY one test method ever hits this 'if' statement.....so it seems this 'if' block is very rarely executed (which I suppose explains why we have yet to see this issue).  Anyway, in the debugger I notice that 'pstate.otherLength' was 2, which is the size of the number of columns in my PK (SubjectKey), yet 'pstate.sqlValue' contained 'Subject' (the entity in the attacked test).  So I suspected that this code expected to get at the column values of the PK (SubjectKey), not the entity (Subject) itself.  So I walked backwards to see where 'otherLength' and 'sqlValue' where set.  I found that here in Param:\n\n    public void calculateValue(Select sel, ExpContext ctx, ExpState state, \n        Val other, ExpState otherState) {\n        super.calculateValue(sel, ctx, state, other, otherState);\n        Object val = getValue(ctx.params);\n        ParamExpState pstate = (ParamExpState) state;\n        if (other != null && !_container) {\n            pstate.sqlValue = other.toDataStoreValue(sel, ctx, otherState, val);\n            pstate.otherLength = other.length(sel, ctx, otherState);\n\n\nother.toDataStoreValue calls to ClassMapping.toDataStoreValue....here is that code (note the javadoc):\n\n    /**\n     * Return the given column value(s) for the given object. The given\n     * columns will be primary key columns of this mapping, but may be in\n     * any order. If there is only one column, return its value. If there\n     * are multiple columns, return an object array of their values, in the\n     * same order the columns are given.\n     */\n    public Object toDataStoreValue(Object obj, Column[] cols, JDBCStore store) {\n        Object ret = (cols.length == 1) ? null : new Object[cols.length];\n\n        // in the past we've been lenient about being able to translate objects\n        // from other persistence contexts, so try to get sm directly from\n        // instance before asking our context\n        OpenJPAStateManager sm;\n        if (ImplHelper.isManageable(obj)) {\n        \tPersistenceCapable pc = ImplHelper.toPersistenceCapable(obj,\n                    getRepository().getConfiguration());\n            sm = (OpenJPAStateManager) pc.pcGetStateManager();\n            if (sm == null) {\n            \tret = getValueFromUnmanagedInstance(obj, cols, true);\n\n\nIn my scenario 'sm' is null so we take the block to 'ret = getValueFromUnmanagedInstance'.  Again, note that I added a system out in this 'if' block, then I ran the OpenJPA test bucket and only one test method ever hits this 'if' statement (again, nearly dead code).  :)  When I ran my test, I notice that 'ret' is assigned 'Subject' after a call to 'getValueFromUnmanagedInstance, not the PK values as promised by the javadoc listed above.  So I set off to figure out how to get the PKs columns from Subject, and their values.  To do this, I thought \"if we execute this query as a 'find' instead, how does that path extract the PK columns and values.\"  When running in a debugger, I saw that we go into this code in SelectImpl.where:\n\njoin = mapping.assertJoinable(toCols[i]);\nval = pks[mapping.getField(join.getFieldIndex()).\n    getPrimaryKeyIndex()];\nval = join.getJoinValue(val, toCols[i], store);\n\nFor a finder, this is where we get the PK of SubjectKey and get its individual values of the SubjectKey.....this is where I took my idea for the fix attached to this JIRA.  \n\nThanks,\n\nHeath\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2016-02-12T04:18:11.052+0000","updated":"2016-02-12T04:18:11.052+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15172974","id":"15172974","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"I'm attaching a patch which contains the proposed final fix and tests.\n\nThanks,\n\nHeath","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2016-03-01T00:29:05.566+0000","updated":"2016-03-01T00:29:05.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15320154","id":"15320154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"body":"Honestly, both the problem and the fix were not easy to understand, but I think I finally managed to do it :-)\n\nAFAICT, the patch looks very good and solves a very nasty problem.\n\nI have also applied your patch to trunk and verified that all tests are passing.\n\nOne question, though: I see this commented block in TestCompositePrimaryKeys:\n\n        // This works:\n        // Predicate subjectPredicate1 = builder.equal(subjectRoot.get(Subject_.key).get(SubjectKey_.subjectNummer),\n        // subject.getKey().getSubjectNummer());\n        // Predicate subjectPredicate2 = builder.equal(subjectRoot.get(Subject_.key).get(SubjectKey_.subjectTypeCode),\n        // subject.getKey().getSubjectTypeCode());\n        // Predicate subjectPredicate = builder.and(subjectPredicate1,subjectPredicate2);\n\nCan you explain why you have left it there? Or, alternatively, why haven't you uncommented it?\n\nFinally, minor stuff which can be easily adjusted:\n\n2013  test  WARN   [main] openjpa.MetaData - The composite identity class \"class org.apache.openjpa.persistence.embed.compositepk.SubjectIdClass\" for entity \"class org.apache.openjpa.persistence.embed.compositepk.SubjectWithIdClass\" is not serializable.\n2520  test  WARN   [main] openjpa.MetaData - The composite identity class \"class org.apache.openjpa.persistence.embed.compositepk.SubjectIdClass\" for entity \"class org.apache.openjpa.persistence.embed.compositepk.SubjectWithIdClass\" is not serializable.\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"created":"2016-06-08T07:05:45.468+0000","updated":"2016-06-08T07:05:45.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347591","id":"15347591","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"body":"Thanks for the review and comments Francesco!  Regarding that commented out code, it was deliberately commented out.  Prior to this fix, it was a work around.  In other words, if you created a Criteria which selected the individual fields of the PK then the test would work.  For history sake I left that commented code in the test case, but given your confusing I've added better comments about why I left it in there.\nFinally, I made SubjectIdClass Serializable.  Thanks again for the detailed review!\n\nThanks,\n\nHeath","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpaheath","name":"jpaheath","key":"jpaheath","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heath Thomann","active":true,"timeZone":"America/Denver"},"created":"2016-06-24T02:51:49.350+0000","updated":"2016-06-24T02:51:49.350+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347619","id":"15347619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1750036 from [~jpaheath] in branch 'openjpa/branches/2.1.x'\n[ https://svn.apache.org/r1750036 ]\n\nOPENJPA-2631: Fix for CriteriaBuilder issue with an @EmbeddedId that contains more than one field.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-24T03:28:08.496+0000","updated":"2016-06-24T03:28:08.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347627","id":"15347627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1750037 from [~jpaheath] in branch 'openjpa/branches/2.2.x'\n[ https://svn.apache.org/r1750037 ]\n\nOPENJPA-2631: Fix for CriteriaBuilder issue with an @EmbeddedId that contains more than one field.  Ported 2.1.x commit to 2.2.x","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-24T03:31:16.438+0000","updated":"2016-06-24T03:31:16.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347631","id":"15347631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1750038 from [~jpaheath] in branch 'openjpa/trunk'\n[ https://svn.apache.org/r1750038 ]\n\nOPENJPA-2631: Fix for CriteriaBuilder issue with an @EmbeddedId that contains more than one field.  Ported 2.1.x commit to trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-24T03:33:00.675+0000","updated":"2016-06-24T03:33:00.675+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347640","id":"15347640","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1750039 from [~jpaheath] in branch 'openjpa/branches/2.2.1.x'\n[ https://svn.apache.org/r1750039 ]\n\nOPENJPA-2631: Fix for CriteriaBuilder issue with an @EmbeddedId that contains more than one field.  Ported 2.1.x commit to 2.2.1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-06-24T03:43:52.163+0000","updated":"2016-06-24T03:43:52.163+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15347913","id":"15347913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"body":"You're welcome! Glad that you applied the patch to all recent branches, thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"created":"2016-06-24T07:32:39.121+0000","updated":"2016-06-24T07:32:39.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/15794416","id":"15794416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"body":"Bulk close for 2.4.2","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ilgrosso","name":"ilgrosso","key":"ilgrosso","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ilgrosso&avatarId=13240","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ilgrosso&avatarId=13240","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ilgrosso&avatarId=13240","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ilgrosso&avatarId=13240"},"displayName":"Francesco Chicchiriccò","active":true,"timeZone":"Europe/Rome"},"created":"2017-01-03T07:37:34.037+0000","updated":"2017-01-03T07:37:34.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/16082914","id":"16082914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dazeydev","name":"dazeydev","key":"dazeydev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dazeydev&avatarId=37311","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dazeydev&avatarId=37311","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dazeydev&avatarId=37311","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dazeydev&avatarId=37311"},"displayName":"Will Dazey","active":true,"timeZone":"Etc/UTC"},"body":"I believe this fix introduced a failure. org.apache.openjpa.jdbc.meta.ClassMapping throws an ArrayOutOfBoundsException if using an @EmbeddedId. getPrimaryKeyFieldMappings() on the Entity with the EmbeddedId will return an array with length = 0. A length check needs to be added.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dazeydev","name":"dazeydev","key":"dazeydev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dazeydev&avatarId=37311","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dazeydev&avatarId=37311","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dazeydev&avatarId=37311","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dazeydev&avatarId=37311"},"displayName":"Will Dazey","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-11T20:29:41.248+0000","updated":"2017-07-11T20:29:41.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12938647/comment/16095319","id":"16095319","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dazeydev","name":"dazeydev","key":"dazeydev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dazeydev&avatarId=37311","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dazeydev&avatarId=37311","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dazeydev&avatarId=37311","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dazeydev&avatarId=37311"},"displayName":"Will Dazey","active":true,"timeZone":"Etc/UTC"},"body":"Opened https://issues.apache.org/jira/browse/OPENJPA-2705 to fix this issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dazeydev","name":"dazeydev","key":"dazeydev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dazeydev&avatarId=37311","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dazeydev&avatarId=37311","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dazeydev&avatarId=37311","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dazeydev&avatarId=37311"},"displayName":"Will Dazey","active":true,"timeZone":"Etc/UTC"},"created":"2017-07-20T20:33:59.365+0000","updated":"2017-07-20T20:33:59.365+0000"}],"maxResults":12,"total":12,"startAt":0},"customfield_12311820":"0|i2squv:","customfield_12314139":null}}

