{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13227117","self":"https://issues.apache.org/jira/rest/api/2/issue/13227117","key":"OPENJPA-2785","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343421","id":"12343421","description":"","name":"3.1.0","archived":false,"released":true,"releaseDate":"2019-04-14"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343421","id":"12343421","description":"","name":"3.1.0","archived":false,"released":true,"releaseDate":"2019-04-14"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316305","id":"12316305","name":"criteria","description":"Issues relating to the JPA Criteria API and usage, as well as the associted MetaModel API and AnnotationProcessor."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2785/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@435818a7[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@42596fd7[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2e0f21bd[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@2721c47c[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@24e9d38b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@515c357[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@52c00881[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@7b6b3481[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1174c5ec[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@3ad0b3ee[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@68862035[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@4a6bde98[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2019-04-10T14:08:21.011+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2785/watchers","watchCount":2,"isWatching":false},"created":"2019-04-10T08:23:18.591+0000","updated":"2019-04-10T15:48:39.982+0000","timeoriginalestimate":null,"description":"When you invoke a query provided/built by spring data when it contains a parameter this fails.\r\n\r\nOnly affects version 3.1.0\r\n\r\n \r\n\r\nSee [https://github.com/michaelwiles/openjpa-spring-data-bug] for demo project.\r\n\r\nHere is the stack trace:\r\n\r\norg.springframework.dao.InvalidDataAccessApiUsageException: Cannot execute query; declared parameters \"ParameterExpression<String>\" were not given values. You must supply a value for each of the following parameters, in the given order: [ParameterExpression<String>]; nested exception is <openjpa-3.1.0-re2160a11145bd3b2a03d61a8752fb52febcec4cc nonfatal user error> org.apache.openjpa.persistence.ArgumentException: Cannot execute query; declared parameters \"ParameterExpression<String>\" were not given values. You must supply a value for each of the following parameters, in the given order: [ParameterExpression<String>]\r\n at org.springframework.orm.jpa.EntityManagerFactoryUtils.convertJpaAccessExceptionIfPossible(EntityManagerFactoryUtils.java:373)\r\n at org.springframework.orm.jpa.DefaultJpaDialect.translateExceptionIfPossible(DefaultJpaDialect.java:127)\r\n at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.translateExceptionIfPossible(AbstractEntityManagerFactoryBean.java:527)\r\n at org.springframework.dao.support.ChainedPersistenceExceptionTranslator.translateExceptionIfPossible(ChainedPersistenceExceptionTranslator.java:61)\r\n at org.springframework.dao.support.DataAccessUtils.translateIfNecessary(DataAccessUtils.java:242)\r\n at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:153)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:138)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:93)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.data.repository.core.support.SurroundingTransactionDetectorMethodInterceptor.invoke(SurroundingTransactionDetectorMethodInterceptor.java:61)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212)\r\n at com.sun.proxy.$Proxy64.findByName(Unknown Source)\r\n at com.afrozaar.bug.openjpa.OpenjpaSpringDataJpaApplicationTests.MemberByName(OpenjpaSpringDataJpaApplicationTests.java:30)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n at java.lang.reflect.Method.invoke(Method.java:498)\r\n at org.junit.runners.featureSelection.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\r\n at org.junit.internal.runners.featureSelection.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n at org.junit.runners.featureSelection.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\r\n at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n at org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:74)\r\n at org.springframework.test.context.junit4.statements.RunAfterTestExecutionCallbacks.evaluate(RunAfterTestExecutionCallbacks.java:84)\r\n at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)\r\n at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)\r\n at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)\r\n at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\r\n at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:251)\r\n at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)\r\n at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\r\n at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\r\n at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\r\n at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\r\n at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\r\n at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)\r\n at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)\r\n at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\r\n at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)\r\n at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:89)\r\n at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:41)\r\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:541)\r\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:763)\r\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:463)\r\n at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:209)\r\n Caused by: <openjpa-3.1.0-re2160a11145bd3b2a03d61a8752fb52febcec4cc nonfatal user error> org.apache.openjpa.persistence.ArgumentException: Cannot execute query; declared parameters \"ParameterExpression<String>\" were not given values. You must supply a value for each of the following parameters, in the given order: [ParameterExpression<String>]\r\n at org.apache.openjpa.kernel.QueryImpl.assertParameters(QueryImpl.java:1849)\r\n at org.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:905)\r\n at org.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:843)\r\n at org.apache.openjpa.kernel.DelegatingQuery.execute(DelegatingQuery.java:601)\r\n at org.apache.openjpa.persistence.QueryImpl.execute(QueryImpl.java:297)\r\n at org.apache.openjpa.persistence.QueryImpl.getResultList(QueryImpl.java:314)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n at java.lang.reflect.Method.invoke(Method.java:498)\r\n at org.springframework.orm.jpa.SharedEntityManagerCreator$DeferredQueryInvocationHandler.invoke(SharedEntityManagerCreator.java:402)\r\n at com.sun.proxy.$Proxy77.getResultList(Unknown Source)\r\n at org.springframework.data.jpa.repository.query.JpaQueryExecution$CollectionExecution.doExecute(JpaQueryExecution.java:129)\r\n at org.springframework.data.jpa.repository.query.JpaQueryExecution.execute(JpaQueryExecution.java:91)\r\n at org.springframework.data.jpa.repository.query.AbstractJpaQuery.doExecute(AbstractJpaQuery.java:136)\r\n at org.springframework.data.jpa.repository.query.AbstractJpaQuery.execute(AbstractJpaQuery.java:125)\r\n at org.springframework.data.repository.core.support.RepositoryFactorySupport$QueryExecutorMethodInterceptor.doInvoke(RepositoryFactorySupport.java:605)\r\n at org.springframework.data.repository.core.support.RepositoryFactorySupport$QueryExecutorMethodInterceptor.lambda$invoke$3(RepositoryFactorySupport.java:595)\r\n at org.springframework.data.repository.core.support.RepositoryFactorySupport$QueryExecutorMethodInterceptor.invoke(RepositoryFactorySupport.java:595)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.data.projection.DefaultMethodInvokingMethodInterceptor.invoke(DefaultMethodInvokingMethodInterceptor.java:59)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:294)\r\n at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:98)\r\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)\r\n at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:139)\r\n ... 41 more\r\n\r\n And some of my comments (originally from a reply to the mailing list:)\r\n\r\nI can't upgrade the 3.1 until this issue is fixed as basically, as far as I can tell, any parameterised call via spring data does not work.\r\n  \r\n Not sure it's the right place to discuss this but the way I see it the ParameterExpressionImpl ([https://github.com/apache/openjpa/blob/master/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/criteria/ParameterExpressionImpl.java]) has acquired a hashCode and equals with this release - [https://github.com/apache/openjpa/commit/0e4ec5b392b978c4515b26c60e485f2b610de94f#diff-e357856846fb8b88f15c08e60891cc35] and this is the code of the problem with spring data.\r\n  \r\n Now what's happening is that the compile is called - and this is called before the parameter expression has a value. All hashcode calcs are done and stuff is added to a set.\r\n  \r\n Then later on the value for the parameter is set. This causes changes to the hashCode and equals, resulting in the problem that I'm seeing.\r\n  \r\n Now I apologise if I'm completely out of line but I'm wondering why the value is included in the hashCode and equals of a Parameter as surely a value is a \"runtime\" concept and it not necessarily available at compile time.\r\n  \r\n Now the hashCode and equals were added for good reason I assume, and furthermore, the value is included in the hashCode/equals also for good reason. But we arguably need a mechanism to view the parameter purely from a metadata point of view (which is I think what we need here) as well as from a metadata+value point of view.\r\n  \r\n But I do wonder why the ParamterExpressionImpl does include the value in the hashCode and equals. My gut feel is that it's not necessary.\r\n  \r\n Relevant stack traces: first time hashCode is called - at this point the value is not specified in the ParameterExpressionImpl. Notice that the CriteriaQueryImpl.compile kicks this off.\r\n  \r\n org.apache.openjpa.persistence.criteria.ParameterExpressionImpl<T>.hashCode() line: 154\r\n java.util.HashMap<K,V>.hash(java.lang.Object) line: 338\r\n java.util.LinkedHashMap<K,V>(java.util.HashMap<K,V>).containsKey(java.lang.Object) line: 595\r\n org.apache.openjpa.lib.util.OrderedMap<K,V>.containsKey(java.lang.Object) line: 70\r\n org.apache.openjpa.persistence.criteria.CriteriaQueryImpl<T>.registerParameter(org.apache.openjpa.persistence.criteria.ParameterExpressionImpl<?>) line: 227\r\n org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor$ParameterVisitor.enter(org.apache.openjpa.persistence.criteria.CriteriaExpression) line: 106\r\n org.apache.openjpa.persistence.criteria.Expressions.acceptVisit(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor, org.apache.openjpa.persistence.criteria.CriteriaExpression, javax.persistence.criteria.Expression<?>...) line: 106\r\n org.apache.openjpa.persistence.criteria.ParameterExpressionImpl<T>(org.apache.openjpa.persistence.criteria.SelectionImpl<X>).acceptVisit(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor) line: 156\r\n org.apache.openjpa.persistence.criteria.Expressions.visitChildren(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor, javax.persistence.criteria.Expression<?>...) line: 121\r\n org.apache.openjpa.persistence.criteria.Expressions.acceptVisit(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor, org.apache.openjpa.persistence.criteria.CriteriaExpression, javax.persistence.criteria.Expression<?>...) line: 108\r\n org.apache.openjpa.persistence.criteria.Expressions$Equal(org.apache.openjpa.persistence.criteria.Expressions$BinaryLogicalExpression).acceptVisit(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor) line: 278\r\n org.apache.openjpa.persistence.criteria.CriteriaQueryImpl<T>.collectParameters(org.apache.openjpa.persistence.criteria.CriteriaExpressionVisitor) line: 681\r\n *org.apache.openjpa.persistence.criteria.CriteriaQueryImpl<T>.compile() line: 672* \r\n org.apache.openjpa.persistence.EntityManagerImpl.createQuery(javax.persistence.criteria.CriteriaQuery<T>) line: 1898\r\n  \r\n Then the error I get, occurs here - in org.apache.openjpa.kernel.QueryImpl\r\n  \r\n   protected void assertParameters(StoreQuery q, StoreQuery.Executor ex, Map params) {\r\n         if (!q.requiresParameterDeclarations())\r\n             return;\r\n  \r\n         OrderedMap<Object,Class<?>> paramTypes = ex.getOrderedParameterTypes(q);\r\n         *for (Object actual : params.keySet()) {*\r\n             *if (!paramTypes.containsKey(actual))*\r\n             throw new UserException(_loc.get(\"unbound-params\",\r\n                 actual, paramTypes.keySet()));\r\n         }\r\n         for (Object expected : paramTypes.keySet())\r\n\r\n{             if (!params.containsKey(expected))             throw new UserException(_loc.get(\"unbound-params\",                 expected, paramTypes.keySet()));         }\r\n\r\n \r\n         for (Entry<Object, Class<?>> entry : paramTypes.entrySet())\r\n\r\n{             if (entry.getValue().isPrimitive()                 && params.get(entry.getKey()) == null)                 throw new UserException(_loc.get(\"null-primitive-param\", entry.getKey()));         }\r\n\r\n    }\r\n  \r\n The error occurs in the bold stuff.\r\n  \r\n And the fundamental reason as far as I can tell is that the paramtypes map was populated when the value was set and then the *actual* reference in this code has the value set...\r\n  \r\n Iow, getOrderedParameterTypes returns the map created before the value was set and the params.keySet has parameterExpressionImpls that have their values set.\r\n  \r\n And you know what happens when you use a hashMap and you change the hashCode after you've populated the hashmap.\r\n  \r\n Error stack trace:\r\n at org.apache.openjpa.kernel.QueryImpl.assertParameters(QueryImpl.java:1849)\r\n at org.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:905)\r\n at org.apache.openjpa.kernel.QueryImpl.execute(QueryImpl.java:843)\r\n at org.apache.openjpa.kernel.DelegatingQuery.execute(DelegatingQuery.java:601)\r\n at org.apache.openjpa.persistence.QueryImpl.execute(QueryImpl.java:297)\r\n at org.apache.openjpa.persistence.QueryImpl.getResultList(QueryImpl.java:314)\r\n at org.apache.openjpa.persistence.QueryImpl.getSingleResult(QueryImpl.java:343)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n at java.lang.reflect.Method.invoke(Method.java:498)\r\n at org.springframework.orm.jpa.SharedEntityManagerCreat","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Queries invoked by Spring data that have parameters fail","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13227117/comment/16814476","id":"16814476","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit f9b59689d45fdc5615da6779ad097173e729616b in openjpa's branch refs/heads/master from Mark Struberg\n[ https://gitbox.apache.org/repos/asf?p=openjpa.git;h=f9b5968 ]\n\nOPENJPA-2733 OPENJPA-2785 fix broken spring data usage.\n\nspring-data potentially does something unspecified.\nThis hack now prevents duplicate ParameterExpressions with the same name\nwhile not having to implement equals + hashCode for it - which makes Spring happy.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2019-04-10T14:07:06.526+0000","updated":"2019-04-10T14:07:06.526+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13227117/comment/16814478","id":"16814478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for the report!\r\nI've just comitted a fix for this issue.\r\nCan you please give it a try and report back if it works or not? txs!\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"created":"2019-04-10T14:08:21.041+0000","updated":"2019-04-10T14:08:21.041+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13227117/comment/16814566","id":"16814566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"body":"Works for me. Test and my app now start. Happy that Spring Data JPA now works with Openjpa","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"created":"2019-04-10T15:46:20.634+0000","updated":"2019-04-10T15:46:20.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13227117/comment/16814571","id":"16814571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"body":"Cool, thanks for reporting this bug and for providing feedback!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"created":"2019-04-10T15:48:39.982+0000","updated":"2019-04-10T15:48:39.982+0000"}],"maxResults":4,"total":4,"startAt":0},"customfield_12311820":"0|z01mmw:","customfield_12314139":null}}

