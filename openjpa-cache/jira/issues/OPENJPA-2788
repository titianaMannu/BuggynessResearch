{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13228776","self":"https://issues.apache.org/jira/rest/api/2/issue/13228776","key":"OPENJPA-2788","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12348547","id":"12348547","description":"","name":"3.2.0","archived":false,"released":true,"releaseDate":"2021-05-14"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"9223372036854775807","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":0,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343421","id":"12343421","description":"","name":"3.1.0","archived":false,"released":true,"releaseDate":"2019-04-14"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316305","id":"12316305","name":"criteria","description":"Issues relating to the JPA Criteria API and usage, as well as the associted MetaModel API and AnnotationProcessor."}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":0,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"aggregateprogress":{"progress":600,"total":600,"percent":100},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":600,"total":600,"percent":100},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2788/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":1,"worklogs":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13228776/worklog/232364","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"comment":"michaelwiles commented on pull request #42: [OPENJPA-2788] addressing issue with anonymous parameters\nURL: https://github.com/apache/openjpa/pull/42\n \n \n   So a slight adjustment to the hashcode and equals method of the ParameterExpression.\r\n   \r\n   Not 100% sure it's right like this but it works.\r\n   \r\n   I guess I'm not too familiar with the reason for the addition of the hashCode and equals in the first place.\r\n   \r\n   The bottom line is that we must include in these hashCode and equals method the ability to handle the situation where the name is not specified.\n \n----------------------------------------------------------------\nThis is an automated message from the Apache Git Service.\nTo respond to the message, please log on to GitHub and use the\nURL above to go to the specific comment.\n \nFor queries about this service, please contact Infrastructure at:\nusers@infra.apache.org\n","created":"2019-04-24T20:45:33.053+0000","updated":"2019-04-24T20:45:33.053+0000","started":"2019-04-24T20:45:33.053+0000","timeSpent":"10m","timeSpentSeconds":600,"id":"232364","issueId":"13228776"}]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":600,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@39046421[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@26572462[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@561d6f5d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@49f635c8[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4641076b[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@1bc2ce28[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@26983d8a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@5e3804e4[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@108c2a17[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@1db205a0[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@7aa11ff1[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@64202b65[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":600,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2020-12-14T13:18:46.480+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-2788/watchers","watchCount":3,"isWatching":false},"created":"2019-04-18T07:46:06.923+0000","updated":"2021-05-14T08:16:33.757+0000","timeoriginalestimate":null,"description":"Something that is almost certainly introduced via fixes for OPENJPA-2785 and OPENJPA-2733 is that anonymous parameters are not picked up.\r\n\r\nThe following piece of code does not add the second parameter successfully and thus the test fails.\r\n\r\nWith a Member entity that has a place and a name field:\r\n{code:java}\r\n       Member m = new Member(1, \"dave\");\r\n        m.setAge(5);\r\n        m.setPlace(\"capetown\");\r\n        em.persist(m);\r\n\r\n        CriteriaBuilder cb = em.getCriteriaBuilder();\r\n\r\n        CriteriaQuery<Member> q = cb.createQuery(Member.class);\r\n        Root<Member> c = q.from(Member.class);\r\n        ParameterExpression<String> name = cb.parameter(String.class);\r\n        ParameterExpression<String> place = cb.parameter(String.class);\r\n        CriteriaQuery<Member> where = q.select(c).where(cb.equal(c.get(\"name\"), name), cb.equal(c.get(\"place\"), place));\r\n\r\n        TypedQuery<Member> query = em.createQuery(where);\r\n        query.setParameter(name, \"dave\");\r\n        query.setParameter(place, \"capetown\");\r\n        List<Member> results = query.getResultList();\r\n\r\n        assertThat(results).isNotEmpty();\r\n{code}\r\nWith query and parameter logging on you that the the sql call is made with the same parameter twice...\r\n{noformat}\r\n<t 346847161, conn 1824423245> executing prepstmnt 2078396010 SELECT t0.id, t0.age, t0.name, t0.place FROM Member t0 WHERE (t0.name = ? AND t0.place = ?) [params=(String) dave, (String) dave]\r\n{noformat}\r\nAnd this kinda makes sense as this is what the CriteriaQueryImpl.registerParameter looks like:\r\n{code:java}\r\n    /**\r\n     * Registers the given parameter.\r\n     */\r\n    void registerParameter(ParameterExpressionImpl<?> p) {\r\n        for (Object k : _params.keySet()) {\r\n            if (p.paramEquals(k)) {\r\n                // If a named ParameterExpressin did already get registered\r\n                // with that exact name, then we do ignore it.\r\n                // If we do a query.setParameter(\"someParamName\", Bla)\r\n                // then it must uniquely identify a Parameter.\r\n                return;\r\n            }\r\n        }\r\n\r\n        p.setIndex(_params.size());\r\n        _params.put(p, p.getJavaType());\r\n    }\r\n{code}\r\nAnd [paramEquals|https://github.com/apache/openjpa/blob/9f26ed29bf31b5c8ab68c5257d42e8c88765cf9b/openjpa-persistence/src/main/java/org/apache/openjpa/persistence/criteria/ParameterExpressionImpl.java#L142] will not differentiate between two anonymous parameters.\r\n\r\nSo I suspect we are going to need some mechanism for differentiating between two anonymous parameters - and if we did this then I suspect the issue that caused this in the first place might also be resolved. Possibly add some kind of counter or something that can give identity to anonymous parameters.\r\n\r\n Added test to [https://github.com/michaelwiles/openjpa-bugs]","customfield_10010":null,"timetracking":{"remainingEstimate":"0h","timeSpent":"10m","remainingEstimateSeconds":0,"timeSpentSeconds":600},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Anonymous parameters are not being picked when adding via CriteriaBuilder","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13228776/comment/16823811","id":"16823811","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"body":"Though I suspect another option would be to defer to object based equality when the parameter is anonymous - that has served the majority case fairly well so far...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=michaelwiles","name":"michaelwiles","key":"michaelwiles","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Wiles","active":true,"timeZone":"Africa/Johannesburg"},"created":"2019-04-23T08:17:57.688+0000","updated":"2019-04-23T08:17:57.688+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13228776/comment/17248988","id":"17248988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 00bd91cc2c858949486acb4e8063176be9a48842 in openjpa's branch refs/heads/master from Mark Struberg\n[ https://gitbox.apache.org/repos/asf?p=openjpa.git;h=00bd91c ]\n\nOPENJPA-2788 fix anynomous Criteria Parameters\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2020-12-14T13:16:33.182+0000","updated":"2020-12-14T13:16:33.182+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13228776/comment/17248990","id":"17248990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"body":"Solved in {{paramEquals}} by treating anonymous params the same only if they are the same instance.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"created":"2020-12-14T13:19:42.720+0000","updated":"2020-12-14T13:19:42.720+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13228776/comment/17344405","id":"17344405","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"body":"shipped with OpenJPA-3.2.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=struberg","name":"struberg","key":"struberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=struberg&avatarId=41313","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=struberg&avatarId=41313","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=struberg&avatarId=41313","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=struberg&avatarId=41313"},"displayName":"Mark Struberg","active":true,"timeZone":"Europe/Berlin"},"created":"2021-05-14T08:16:33.748+0000","updated":"2021-05-14T08:16:33.748+0000"}],"maxResults":4,"total":4,"startAt":0},"customfield_12311820":"0|z01wts:","customfield_12314139":null}}

