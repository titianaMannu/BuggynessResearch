{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12377801","self":"https://issues.apache.org/jira/rest/api/2/issue/12377801","key":"OPENJPA-359","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312344","id":"12312344","description":"","name":"1.1.0","archived":false,"released":true,"releaseDate":"2008-05-22"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"160682","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312341","id":"12312341","description":"","name":"1.0.0","archived":false,"released":true,"releaseDate":"2007-08-28"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311300","id":"12311300","name":"jdbc","description":"jdbc interface"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"288326","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-359/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@19b324ec[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1dceb514[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4631e7a9[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@2ebf8c6e[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3b23836d[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@5417d85b[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1d5261df[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@4f5c52e7[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6843888a[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@2fc50d9[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@cae95c0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@21c835d8[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2008-02-26T16:53:39.332+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-359/watchers","watchCount":0,"isWatching":false},"created":"2007-09-08T05:03:51.318+0000","updated":"2008-02-27T20:30:05.372+0000","timeoriginalestimate":null,"description":"We ran a test using Timestamp as the version field in an entity, the following (pseudo) test failed when an OptimisticLockException is expected:\n\n    em1.persist( e0(pk1) );\n\n    e1 = em1.find(pk1);\n    e2 = em2.find(pk1);\n\n    e1.setAttr( \"new1\");\n    e2.setAttr( \"new2\");\n\n    em1.merge( e1 );\n    em2.merge( e2 );    <<<< Expect an OptimisticLockException\n\nThe cause of this problem is because the TimestampVersionStrategy.nextVersion returns a java.sql.Timestamp(System.currentTimeMillis()); In the Wintel environment, the currentTimeMillis() only has approximately 15ms resolution. When 2 subsequent Timestamp version objects are requested within this 15ms interval, both has the same version value. Therefore the em2.merge does not detected the versions difference between o1 and o2, hence no exception is thrown.\n\nDue to this behavior, the same test case may failed intermittenly depends on the currentTimeMillis() resolution and the time when a timestamp version is created.  From some preliminary tests, the resolution for  wintel, linux and z/os are about 15ms, 2ms and 2ms respectively.\n    \n","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12376329","id":"12376329","filename":"OPENJPA-359.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2008-02-24T04:05:24.821+0000","size":8628,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12376329/OPENJPA-359.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12376380","id":"12376380","filename":"OPENJPA-359.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2008-02-25T00:34:48.939+0000","size":10648,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12376380/OPENJPA-359.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12365390","id":"12365390","filename":"OPENJPA-359.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-08T05:21:13.968+0000","size":3448,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12365390/OPENJPA-359.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"OptimisticLockException NOT thrown for entity using Timestamp Version when update from concurrent persistence contexts","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"WIntel 32 ","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12525890","id":"12525890","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"The solution is to create a java.sql.Timestamp based on the current time plus a unique counter within the same current time windows. Therefore the timestamp is not truely a time based timestamp but a unique timestamp for versioning purpose.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-08T05:21:14.167+0000","updated":"2007-09-08T05:21:14.167+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12525933","id":"12525933","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"We need to also consider clustered environments -- this patch doesn't do much for such environments. Of course, in a clustered environment, timestamp-based checks rely on clock synchronization, which is a hard problem.\n\nI've always seen this as an insoluble problem with timestamp versioning, and have just worked around it by putting sleeps in test cases that test concurrency and timestamp versioning.\n\nThe proposed change adds a synchronized block, which seems like a potential bottleneck; if we decide that we care about this problem, I think I'd rather see us just put a Thread.currentThread().wait(<15 | 2>) call into the versioning code. Note, of course, that this still won't solve the problem in a clustered environment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-08T18:02:39.832+0000","updated":"2007-09-08T18:02:39.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12525944","id":"12525944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":">> We need to also consider clustered environments -- this patch doesn't do much for such environments. Of course, in a clustered environment, timestamp-based checks rely on clock synchronization, which is a hard problem. \n\nWhen you say clustered environment, do you mean multiple appl servers (in a cluster) accessing the same db server? This patch refines the time stamp granularity and improves version uniqueness. It does not degrade the current implementation and will exhibit the exact behavior as far as \"clustering\" is concern.  I agree with you that Versioning support in cluster environment is a hard problem and it is not only for Timestamp but any type. Until there is a central \"server\" that hands out unique version id, it will remain to be a insoluble problem.\n\n>> The proposed change adds a synchronized block, which seems like a potential bottleneck; \nThe synchronized block is required to make sure the counter is updated correctly in multi-thread scenario. This follows a similar pattern as implemented in the UUIDGenerator.  I have considered the bottleneck condition and scaled down the instructions absolutely needed in the synchronized block to improve concurrency.\n\n>> I think I'd rather see us just put a Thread.currentThread().wait(<15 | 2>) call into the versioning code.\nDo you mean \"Thread.currentThread().sleep(<15|2>)\" ?  \nFirst, one has to determine the value to sleep. This value varies a lot and depends on the hardware platform and realistically should be determine at run-time.  Second, sleeping for 2ms per se is an artificial performance and concurrency inhibitors which I don't recommend.\n\nWe may be able to figure out other means to avoid the synchronized block but still get the same result.\n\n>> Note, of course, that this still won't solve the problem in a clustered environment.\nDistributed system synchronization is always a hard problem to solve.  The initial time stamp value is based on System.currentTimeMillis(), this means the first problem is to make sure this base value is synchronized between all servers in the cluster. The second problem is the increment value needs to be either synchronized and/or common between all servers.   \n\nIf we take a step back and say using Timestamp as version id is inherently problematic (the same argument as using float as primary key) in cluster environment, all we can do is to provide an implementation that can improve the possibility NOT to run into a problem condition, as we already have encountered in our test scenario.\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-08T19:48:20.224+0000","updated":"2007-09-08T19:48:20.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12526062","id":"12526062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"> When you say clustered environment, do you mean multiple appl servers \n> (in a cluster) accessing the same db server? \n\nYes.\n\n> I agree with you that Versioning support in cluster environment is a hard \n> problem and it is not only for Timestamp but any type. Until there is a central\n> \"server\" that hands out unique version id, it will remain to be a insoluble problem.\n\nI don't understand. IMO, versioning in a clustered environment is a trivial problem \nwhen using the monotonically-incrementing number approach. The only \"problems\"\narise when using timestamps, and arguably, these aren't problems, but rather just\nlimitations imposed by the timing needs of the application.\n\nFTR, with a monotonically-incrementing version number, the database itself acts\nas the central server.\n\n> sleeping for 2ms per se is an artificial performance and concurrency inhibitors \n> which I don't recommend. \n\nBy my definitions, sleeping for 2ms does incur a performance cost, but does not \nincur any concurrency problem at all. In fact, doing so avoids the concurrency \nproblem introduced by the new synchronized block.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-10T05:41:07.674+0000","updated":"2007-09-10T05:41:07.674+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12526171","id":"12526171","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"> I don't understand. IMO, versioning in a clustered environment is a trivial problem\nwhen using the monotonically-incrementing number approach. The only \"problems\"\narise when using timestamps, and arguably, these aren't problems, but rather just\nlimitations imposed by the timing needs of the application.\n>\n> FTR, with a monotonically-incrementing version number, the database itself acts\nas the central server. \n\nIf the version is handed off from the db server, then I agree with you that is is a trivial problem. However in our implementation the version is handed off from an instance of the persistence provider of app server (in a cluster). E.g. \n\nNumberVersionStrategy.nextVersion() { .... return Numbers.valueOf(((Number) version).intValue() + 1); }\nTimestampVersionStrategy.netxtVersion() { return TimestampHelper.getCurrentTimestamp(); }\n\nTImestamp is always problematic, regardless of how accurate the value is used. It also depends on how precise (how many fractional digits) the column in the db are being stored. I ran into a scenario where the Timestamp version is precise to the 100ns but the test still failed. It is because the version column in the db only holds up to ms.\n\n> By my definitions, sleeping for 2ms does incur a performance cost, but does not\nincur any concurrency problem at all. In fact, doing so avoids the concurrency\nproblem introduced by the new synchronized block.\n\nSleeping in a thread to avoid duplicate time stamp only solve its own problem. What about if there are 2 threads coming in at the same time (within the 15ms time window) and asking for a new version. Without the synchronized block to hand out the next value, the time stamp version created in both threads will be same if sleep is used, which does not solve the initial problem. Even with the current suggested solution, it does not guarantee to solve the cluster scenario.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-10T14:54:19.803+0000","updated":"2007-09-10T14:54:19.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12526257","id":"12526257","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"> If the version is handed off from the db server, then I agree with \n> you that is is a trivial problem. However in our implementation \n> the version is handed off from an instance of the persistence \n> provider of app server (in a cluster). E.g.\n> \n> NumberVersionStrategy.nextVersion() {\n>     ...\n>     return Numbers.valueOf(((Number) version).intValue() + 1);\n> } \n\nYes, but then, the previous number is used in an UPDATE or DELETE statement. If the row being updated / deleted has been changed by a different VM, then the database will have a different version value at that time, and the update / delete statement will fail (modified row count of 0). So, while we don't fetch the number from the database, the database always contains the most-recent clean version number, and updates only get into the database when the reader had read that value.\n\nTimestamps are more complicated, as has been discussed on this thread.\n\n> Sleeping in a thread to avoid duplicate time stamp only solve its own problem.\n> What about if there are 2 threads coming in at the same time (within the 15ms \n> time window) and asking for a new version. Without the synchronized block to \n> hand out the next value, the time stamp version created in both threads will be \n> same if sleep is used, which does not solve the initial problem. Even with the \n> current suggested solution, it does not guarantee to solve the cluster scenario.\n\nI agree -- this entire domain is rife with problems when transactions are shorter than the resolution available. I just do not think that adding synchronization to attempt to partially fix the situation is really worth the cost in all the use cases where transactions are known to be longer than the resolution.\n\nIn any event, I understand that there is some value to what you're proposing; I just don't think that we should change our current behavior, because it's good enough for many users, and has characteristics (lack of synchronization) that is advantageous over the incremental improvement that you're suggesting. So, I could see room for a new versioning strategy or some sort of option to configure how the timestamp behavior works.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-10T20:23:51.334+0000","updated":"2007-09-10T20:23:51.334+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12526286","id":"12526286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Patrick,\n\nI understand your concern of the proposed changed. \n\nI'll continue to find other implementation that does not require a synchronized block plus improving granularity of the version value (time-wise).\n\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-10T22:28:20.588+0000","updated":"2007-09-10T22:28:20.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12526297","id":"12526297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"One approach might be to just create an implementation that uses System.nanoTime(). This would only work in 1.5 environments, but that might be good enough.\n\nAn easy way to do this would be to make a new abstract superclass of TimestampVersionStrategy, and two implementations for providing a timestamp: one that uses the nano calls, and one that uses the milli calls. For extra credit, you could even make the Configuration framework choose which to use by default based on the value of JavaVersions.VERSION.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-10T23:06:20.295+0000","updated":"2007-09-10T23:06:20.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12571849","id":"12571849","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Attached is an alternative implementation of the nano precision timestamp versioning. This is based on the JRE 1.5 System.nanoTime() support. It does not use synchronization block and should be thread-safe.\n\nA new NanoPrecisionTimestampVersionStrategy is created using alias \"nano-timestamp\". This is the default date/timestamp version strategy if Java version >= 5.\n\nDue to the JRE 1.4 compilation requirement in the maven build process, the new TimestampHelper class in the openjpa-persistence module uses Reflection to invoke System.nanoTime() and TimeStamp.setNanos() methods.  If there is other alternative to get around the 1.4 maven compilation problem, I would prefer to call these methods directly but I don't have a good solution other than using Reflection. Suggestion is welcome.\n\nI'll wait until EOD Monday to commit this change.\n\nThanks,\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2008-02-24T04:03:20.389+0000","updated":"2008-02-24T04:03:20.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12571850","id":"12571850","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Attached again and grant ASF license.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2008-02-24T04:05:24.826+0000","updated":"2008-02-24T04:05:24.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12571876","id":"12571876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"We could get rid of at least some of the reflection, and push any remaining reflection to deploy-time only, by moving the new class to the openjpa-jdbc-5 module.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-24T08:12:32.125+0000","updated":"2008-02-24T08:12:32.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12377801/comment/12571994","id":"12571994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Patrick,\n\nThanks for the hint... I am able to get around the 1.4 compile and Reflection \"problems\" by new'ing a single instance of  TimestampHelper with an override to Timestamp5elper at runtime if run in Java 5.\n\nPlease review the current solution.\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2008-02-25T00:34:49.036+0000","updated":"2008-02-25T00:34:49.036+0000"}],"maxResults":12,"total":12,"startAt":0},"customfield_12311820":"0|i1dq3r:","customfield_12314139":null}}

