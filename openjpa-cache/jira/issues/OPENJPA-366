{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12378057","self":"https://issues.apache.org/jira/rest/api/2/issue/12378057","key":"OPENJPA-366","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312846","id":"12312846","description":"","name":"1.0.2","archived":false,"released":true,"releaseDate":"2008-02-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12312344","id":"12312344","description":"","name":"1.1.0","archived":false,"released":true,"releaseDate":"2008-05-22"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"160689","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312341","id":"12312341","description":"","name":"1.0.0","archived":false,"released":true,"releaseDate":"2007-08-28"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311302","id":"12311302","name":"kernel","description":"Kernel"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"203470","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-366/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@6877977e[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@6e425b86[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@5111a6c0[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@2d73490f[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@42364fe[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@498c4b4f[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@15f7c318[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@227bcb98[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3de04fbd[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@161dad7d[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3d5943a5[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@4102789d[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2008-01-31T00:45:29.972+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-366/watchers","watchCount":0,"isWatching":false},"created":"2007-09-12T14:27:11.401+0000","updated":"2008-02-27T20:30:42.348+0000","timeoriginalestimate":null,"description":"Under heavy load during stress test, the following exception is observed:\n\n<openjpa-1.0.0-SNAPSHOT-r420667:570288M fatal general error> org.apache.openjpa.persistence.PersistenceException: null\n        at org.apache.openjpa.kernel.BrokerImpl.endOperation(BrokerImpl.java:1728)\n        at org.apache.openjpa.kernel.BrokerImpl.isActive(BrokerImpl.java:1676)\n        at org.apache.openjpa.kernel.DelegatingBroker.isActive(DelegatingBroker.java:420)\n        at org.apache.openjpa.persistence.EntityManagerImpl.isActive(EntityManagerImpl.java:502)\n        at org.apache.openjpa.persistence.PersistenceExceptions$2.translate(PersistenceExceptions.java:66)\n        at org.apache.openjpa.kernel.DelegatingBroker.translate(DelegatingBroker.java:110)\n        at org.apache.openjpa.kernel.DelegatingBroker.newObjectId(DelegatingBroker.java:262)\n        at org.apache.openjpa.persistence.EntityManagerImpl.find(EntityManagerImpl.java:347)\n        at com.ibm.svt.shoppingcartModule.stationstore.StationStoreSessionBean.getListOrders(StationStoreSessionBean.java:603)\n        at com.ibm.svt.shoppingcartModule.stationstore.EJSRemoteStatelessStationStoreSession_5a5c538c.getListOrders(Unknown Source)\n        at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.getListOrders(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:244)\n        at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie._invoke(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:100)\n        at com.ibm.CORBA.iiop.ServerDelegate.dispatchInvokeHandler(ServerDelegate.java:613)\n        at com.ibm.CORBA.iiop.ServerDelegate.dispatch(ServerDelegate.java:466)\n        at com.ibm.rmi.iiop.ORB.process(ORB.java:503)\n        at com.ibm.CORBA.iiop.ORB.process(ORB.java:1553)\n        at com.ibm.rmi.iiop.Connection.respondTo(Connection.java:2680)\n        at com.ibm.rmi.iiop.Connection.doWork(Connection.java:2554)\n        at com.ibm.rmi.iiop.WorkUnitImpl.doWork(WorkUnitImpl.java:62)\n        at com.ibm.ejs.oa.pool.PooledThread.run(ThreadPool.java:118)\n        at com.ibm.ws.util.ThreadPool$Worker.run(ThreadPool.java:1469)\n\n[8/31/07 22:45:26:265 EDT] 000000c1 SystemOut     O   MDD Translating exception: <openjpa-0.0.0-r420667:570288 fatal internal error> org.apache.openjpa.util.InternalException: null\n[8/31/07 22:45:26:265 EDT] 000000c1 SystemErr     R   <openjpa-0.0.0-r420667:570288 fatal internal error> org.apache.openjpa.util.InternalException: null\n[8/31/07 22:45:26:265 EDT] 000000c1 SystemErr     R   \tat org.apache.openjpa.kernel.BrokerImpl.endOperation(BrokerImpl.java:1728)\n\nAfter some investigation, it was determined that the internal exception is caused by\n             if (_operationCount < 1)\n                throw new InternalException();\nin BrokerImpl.endOperation();\n\nWe believe the cause of the problem is a lock() method call is missing in the endOperation()\n\n    public boolean endOperation() {\n        lock();   <<<<<  This is the missing lock() call since BrokerImpl.java was created\n        try {\n            if (_operationCount == 1 && (_autoDetach & DETACH_NONTXREAD) != 0\n                && (_flags & FLAG_ACTIVE) == 0) {\n                detachAllInternal(null);\n            }\n            if (_operationCount < 1)\n                throw new InternalException();\n            return _operationCount == 1;\n        } catch (OpenJPAException ke) {\n            throw ke;\n        } catch (RuntimeException re) {\n            throw new GeneralException(re);\n        } finally {\n            _operationCount--;\n            if (_operationCount == 0)\n                _operating.clear();\n            unlock();\n        }\n    }\n\nOnce we have done more tests and verify the fix, I'll submit a patch for this problem.\n\nIf anyone doesn't think this is the solution. please response.\n\nAlbert Lee.","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12366960","id":"12366960","filename":"OPENJPA-366.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-10-02T22:02:23.976+0000","size":1713,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12366960/OPENJPA-366.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"InternalException thrown in BrokerImpl.endOperation","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":"All platforms","customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12527179","id":"12527179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Add lock() in BrokerImpl.endOperation().\n\nStress test ran for 24 hours and still have not observed the reported problem. Continue to test with increasing workloads and clients for a 48 hours run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-13T17:10:41.477+0000","updated":"2007-09-13T17:10:41.477+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12527669","id":"12527669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"The hypothesis that the lock() is missing in endOperation() is incorrect. It was not there by design. Can some administrator remove the attached patch in this report.\n\nWe'll continue to investigate this issue and appreciate if anyone has any clues or ideas on where the problem is or how to attach the problem.\n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-15T01:23:07.271+0000","updated":"2007-09-15T01:23:07.271+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12529474","id":"12529474","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"An update to this issue:\n\n1) The test scenario is a simple Sale - 1toM - Order processing\n2) A EJB 2.1 stateless session bean StationBean is used to drive the Sale. It uses JSE style access to JPA functions.\n\n    public void ejbCreate() throws javax.ejb.CreateException {\n        ut = (UserTransaction) getSessionContext().getUserTransaction();\n        saleFactory = Persistence.createEntityManagerFactory(\"StationSale\");\n        saleManager = saleFactory.createEntityManager();\n    }\n  \n3) This bean has a getListOrder() method returns Vector<Order>.\n\n    public Vector getListOrders(int saleid) throws Exception {\n        String methodName = \"getListOrders\";\n        Vector v = new Vector();\n        try {\n            ut.begin();\n            saleManager.joinTransaction();\n            Sale sl = saleManager.find(Sale.class, saleid);\n            if (sl != null) {\n                saleManager.refresh(sl);\n                Collection c = sl.getOrders();\n                if (c != null) {\n                    Iterator ids = c.iterator();\n                    while (ids.hasNext()) {\n                        Order o = (Order) ids.next();\n                        if (o != null) {\n                            v.add(o);\n                        }\n                    }\n                }\n                ut.commit();\n            } else {\n                throw new Exception(\"getListOrders, Unable to find Sale , returned null for saleid = \"  + saleid);\n            }\n        } catch (Exception e1) {\n            ut.rollback();\n            throw e1;\n        }\n        return v;\n    }\n    \n4) A test driver accesses the StationBean in multiple clients under heavy load. As a result, the observed exception as report in the original comment occurs.\n5) Re-run the test with \"openjpa.Multithreaded=true\" property resolved the problem. It is due to the fact that this property installed a ReentrantLock in the BrokerImpl to synchronize multiple invocations to the same BrokerImpl.\n6) After further analysis of the problem, the following stacks revealed the sources of the multiple invocations to the same broker:\n\n   >>> Thread 1 : Thread[ORB.thread.pool : 3,5,main]\n java.lang.Exception: curThread=Thread[ORB.thread.pool : 3,5,main]:lock={noLock}:threadCnt=2:_operationCount=0\n   at org.apache.openjpa.kernel.BrokerImpl.beginOperation(BrokerImpl.java:1723)\n   at org.apache.openjpa.kernel.BrokerImpl.newObjectId(BrokerImpl.java:1060)\n   at org.apache.openjpa.kernel.DelegatingBroker.newObjectId(DelegatingBroker.java:252)\n   at org.apache.openjpa.persistence.EntityManagerImpl.find(EntityManagerImpl.java:347)\n   at com.ibm.svt.shoppingcartModule.stationstore.StationStoreSessionBean.getListOrders(StationStoreSessionBean.java:603)\n   at com.ibm.svt.shoppingcartModule.stationstore.EJSRemoteStatelessStationStoreSession_5a5c538c.getListOrders(Unknown Source)\n   at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.getListOrders(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:244)\n   at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie._invoke(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:100)\n   at com.ibm.CORBA.iiop.ServerDelegate.dispatchInvokeHandler(ServerDelegate.java:613)\n   at com.ibm.CORBA.iiop.ServerDelegate.dispatch(ServerDelegate.java:466)\n   at com.ibm.rmi.iiop.ORB.process(ORB.java:503)\n   at com.ibm.CORBA.iiop.ORB.process(ORB.java:1553)\n   at com.ibm.rmi.iiop.Connection.respondTo(Connection.java:2680)\n   at com.ibm.rmi.iiop.Connection.doWork(Connection.java:2554)\n   at com.ibm.rmi.iiop.WorkUnitImpl.doWork(WorkUnitImpl.java:62)\n   at com.ibm.ejs.oa.pool.PooledThread.run(ThreadPool.java:118)\n   at com.ibm.ws.util.ThreadPool$Worker.run(ThreadPool.java:1469)\n\n   >>> Thread 2 : Thread[ORB.thread.pool : 2,5,main]\n java.lang.Exception: curThread=Thread[ORB.thread.pool : 2,5,main]:lock={noLock}:threadCnt=1:_operationCount=0\n   at org.apache.openjpa.kernel.BrokerImpl.beginOperation(BrokerImpl.java:1723)\n   at org.apache.openjpa.kernel.BrokerImpl.isActive(BrokerImpl.java:1683)\n   at org.apache.openjpa.kernel.StateManagerImpl.load(StateManagerImpl.java:352)\n   at org.apache.openjpa.kernel.DetachManager.preDetach(DetachManager.java:156)\n   at org.apache.openjpa.kernel.DetachManager.preSerialize(DetachManager.java:91)\n   at org.apache.openjpa.kernel.StateManagerImpl.serializing(StateManagerImpl.java:1310)\n   at com.ibm.svt.shoppingcartModule.storeEntities.Order.pcSerializing(Order.java)\n   at com.ibm.svt.shoppingcartModule.storeEntities.Order.writeObject(Order.java)\n   at sun.reflect.GeneratedMethodAccessor57.invoke(Unknown Source)\n   at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   at java.lang.reflect.Method.invoke(Method.java:615)\n   at com.ibm.rmi.io.IIOPOutputStream.invokeObjectWriter(IIOPOutputStream.java:966)\n   at com.ibm.rmi.io.IIOPOutputStream.outputObject(IIOPOutputStream.java:1002)\n   at com.ibm.rmi.io.IIOPOutputStream.writeSerializable(IIOPOutputStream.java:1050)\n   at com.ibm.rmi.io.IIOPOutputStream.simpleWriteObjectInternal(IIOPOutputStream.java:427)\n   at com.ibm.rmi.io.IIOPOutputStream.simpleWriteObjectLoop(IIOPOutputStream.java:455)\n   at com.ibm.rmi.io.IIOPOutputStream.defaultWriteObjectDelegate(IIOPOutputStream.java:566)\n   at com.ibm.rmi.io.OutputStreamHook.defaultWriteObject(OutputStreamHook.java:132)\n   at java.util.Vector.writeObject(Vector.java:869)\n   at sun.reflect.GeneratedMethodAccessor10.invoke(Unknown Source)\n   at java.util.Vector.writeObject(Vector.java:869)\n   at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n   at sun.reflect.GeneratedMethodAccessor10.invoke(Unknown Source)\n   at java.lang.reflect.Method.invoke(Method.java:615)\n   at com.ibm.rmi.io.IIOPOutputStream.invokeObjectWriter(IIOPOutputStream.java:966)\n   at com.ibm.rmi.io.IIOPOutputStream.outputObject(IIOPOutputStream.java:1002)\n   at com.ibm.rmi.io.IIOPOutputStream.writeSerializable(IIOPOutputStream.java:1050)\n   at com.ibm.rmi.io.IIOPOutputStream.simpleWriteObjectInternal(IIOPOutputStream.java:427)\n   at com.ibm.rmi.io.IIOPOutputStream.simpleWriteObjectLoop(IIOPOutputStream.java:455)\n   at com.ibm.rmi.io.IIOPOutputStream.simpleWriteObject(IIOPOutputStream.java:512)\n   at com.ibm.rmi.io.ValueHandlerImpl.writeValue(ValueHandlerImpl.java:159)\n   at com.ibm.rmi.iiop.CDROutputStream.write_value(CDROutputStream.java:1477)\n   at com.ibm.rmi.iiop.CDROutputStream.write_value(CDROutputStream.java:1497)\n   at com.ibm.rmi.iiop.CDROutputStream.write_value(CDROutputStream.java:1459)\n   at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.getListOrders(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:256)\n   at com.ibm.svt.shoppingcartModule.stationstore._EJSRemoteStatelessStationStoreSession_5a5c538c_Tie._invoke(_EJSRemoteStatelessStationStoreSession_5a5c538c_Tie.java:100)\n   at com.ibm.CORBA.iiop.ServerDelegate.dispatchInvokeHandler(ServerDelegate.java:613)\n   at com.ibm.CORBA.iiop.ServerDelegate.dispatch(ServerDelegate.java:466)\n   at com.ibm.rmi.iiop.ORB.process(ORB.java:503)\n   at com.ibm.CORBA.iiop.ORB.process(ORB.java:1553)\n   at com.ibm.rmi.iiop.Connection.respondTo(Connection.java:2680)\n   at com.ibm.rmi.iiop.Connection.doWork(Connection.java:2554)\n   at com.ibm.rmi.iiop.WorkUnitImpl.doWork(WorkUnitImpl.java:62)\n   at com.ibm.ejs.oa.pool.PooledThread.run(ThreadPool.java:118)\n   at com.ibm.ws.util.ThreadPool$Worker.run(ThreadPool.java:1469)\n\n7) Thread #1 is doing the normal em.find processing and hits the BrokerImpl.beginOperation().\n8) Thread #2 has completed the em.find processing and the Vector<Order> is collected properly in the getListOrder() method. ORB/CORBA is trying to serialize the return Vector<Order> back to the remote client.\n9) During this processing, it is getting back to openjpa to serialize an Order in the returning collection:\n\n   at org.apache.openjpa.kernel.StateManagerImpl.serializing(StateManagerImpl.java:1310)\n   at com.ibm.svt.shoppingcartModule.storeEntities.Order.pcSerializing(Order.java)\n   at com.ibm.svt.shoppingcartModule.storeEntities.Order.writeObject(Order.java)\n   at sun.reflect.GeneratedMethodAccessor57.invoke(Unknown Source)\n\n10) The EJB container guarantees a different StationBean instance is invoked from getListOrders() method call which initiated from different threads/clients, and since the em in each StationBean instance is obtained independently from Persistence class, we can concluded the em.find() in each bean invocation must use a different broker for the em.find() call.\n11) Therefore we suspect somehow a incorrect broker (same broker used by Thread #1) is used during the pcSerializing invocation in Thread #2.\n12) Another supporting fact for the hypothesis is we have observed scenario where there are up to 6 threads accessing the same BrokerImpl. Out of these call stacks, there is always only one thread exhibits the same stack pattern as in Thread #1 and the other threads have the Thread #2 call stack pattern.\n\n\nQuestions:\n1) What is(are) the conditions (e.g. openjpa features/property) that trigger the Order.pcSerializing() processing? I wrote a simplier test that mimic the test case and was unable to drive the Order.pcSerializing() method call.\n2) How is the Order.pcSerilizing() determine which BrokerImpl to use to perform the serialization?\n3) Any suggestings or insight into how to identify the culprit of this problem?\n\nAny help on this matter is greatly appreciated.\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-21T15:42:09.724+0000","updated":"2007-09-21T15:42:09.724+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12531042","id":"12531042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"After a lengthy investigation to this problem, it turns out there are a few problems in this application/ejb usage scenario:\n\n1) Problem #1 - Application\n\nThe appl uses stateless session bean (SLSB) and JSE style JPA access, therefore the persistence context is extended. In each bean method call, the appl uses the persistence context to access JPA functions but did not clear the context upon method return. This leaves managed entities in the context propagates to the next client/thread who just happens to use the same session bean instance allocated by the EJB container from its slsb pool. \n\n2) Problem #2 - EJBContainer\n\nTypically, an application server generates EJB deployment code (GenCode), either statically or at runtime, for an application(.ear) in order to implement EJB Container semantics in the application server. This generated code sits between the ORB/COBRA and the EJB Container. It redirects calls from the client to the EJB Container. Here is a brief sequence of events during this call path:\n\n  a) ORB directs the client method call to the GenCode\n  b) GenCode invokes the EJB Container to performs EJB semantics. E.g. start a transaction, CMP/BMP processing.  One of the function in this step is to allocate an user-defined bean instance.\n  c) GenCode invokes the user define bean method.\n  d) GenCode invokes the EJB Container to performs EJB clean up semantics. E.g. commit/rollback transaction, exception handling etc.  When this step is finished, the user-defined bean instance is returned back to the bean pool maintained by the EJB Container.\n  e) GenCode returns the bean method returned object to ORB\n   f) ORB serializes the returned object to an output stream which will be streamed back to the client.\n\nIn the reported problem scenario, the method being calls return a Vector<OrderEntity>. Everything functions normally until step d) to f). After step d), the SLSB instance is returned back to the EJB pool and is available for use by the next client while the current thread is still processing step f).  If the returned object contains a managed entity, the serialization process will eventually invocate its owning EntityManager/broker. Since step d) to f) are not synchronized, in a high load environment, EJB Container may allocate the same SLSB instance to a client in another thread. Now there are 2 threads using managed entities in the same persistence context. Since EntityManager is not thread-safe (per JPA spec), the reported exception is observed.\n\n3) Problem #3 - OpenJPA\n\nOpenJPA is doing whatever it can to detect the multiple access to the same thread/broker. However when this happens, only a InternalException() with a \"null\" message is thrown and this percolates back to the user with an PersistenceException with no meaningful message to isolate the problem. This is a critical usability issues.\n\n\nSolutions for this Jira report:\n\n1) Application must clear all Persistence Context upon return for each bean method call. There are explicit example in the JPA spec demonstrates these usage. (JPA spec 5.7.1.1 and 5.7.1.2)\n2) Proposed to enhance the error message when this error condition occurs to explain the cause of the problem and suggested the following possible solutions:\n      a) set \"openjpa.Multithreaded=true\", if the application requires and intent to support this particular usage. Application must fully responsible for the behavior of this undefined semantics.\n      b) request application to make sure entity manager defines as attribute(s) in SLSB must be cleared upon each bean method invocation.\n\nI'll use this Jira report to addess solution 2).\n\nAlbert Lee.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-09-28T15:27:53.255+0000","updated":"2007-09-28T15:27:53.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12531927","id":"12531927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"Add a new message text for InternalException().\n\nThis patch is tested against both 1.1.0 trunk and 1.0.x branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-10-02T22:02:24.319+0000","updated":"2007-10-02T22:02:24.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12538815","id":"12538815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"body":"There are still other issues need to be resolved. Defer to next release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=allee8285","name":"allee8285","key":"allee8285","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Lee","active":true,"timeZone":"America/Chicago"},"created":"2007-10-30T15:44:00.917+0000","updated":"2007-10-30T15:44:00.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12378057/comment/12564246","id":"12564246","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"body":"Marking as resolved, as I do not understand what additional issues remain for this issue. If there are any, please expand on them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pcl","name":"pcl","key":"pcl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Linskey","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-01-31T00:45:29.956+0000","updated":"2008-01-31T00:45:29.956+0000"}],"maxResults":7,"total":7,"startAt":0},"customfield_12311820":"0|i0z77j:","customfield_12314139":null}}

