{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12393093","self":"https://issues.apache.org/jira/rest/api/2/issue/12393093","key":"OPENJPA-557","fields":{"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12313326","id":"12313326","description":"","name":"1.3.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12313483","id":"12313483","description":"Early Access 2","name":"2.0.0-M2","archived":false,"released":true,"releaseDate":"2009-06-03"}],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"160873","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312846","id":"12312846","description":"","name":"1.0.2","archived":false,"released":true,"releaseDate":"2008-02-18"}],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[{"id":"12322735","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12322735","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12394834","key":"OPENJPA-582","self":"https://issues.apache.org/jira/rest/api/2/issue/12394834","fields":{"summary":"when updating postgresql sequences last generated key query does not account for schema","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12313825":null,"assignee":null,"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12311300","id":"12311300","name":"jdbc","description":"jdbc interface"}],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"202621","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rogerkeays","name":"rogerkeays","key":"rogerkeays","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Roger Keays","active":true,"timeZone":"America/Bogota"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rogerkeays","name":"rogerkeays","key":"rogerkeays","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Roger Keays","active":true,"timeZone":"America/Bogota"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-557/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@61337667[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2033d1f9[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1cb7c263[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@22b57415[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@61715751[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@6f369af4[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4db0f9ab[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@442c29d4[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@2f0c35df[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@74b6fbf0[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3e81396c[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@1bc6c5e1[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2008-12-24T00:23:45.774+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-557/watchers","watchCount":2,"isWatching":false},"created":"2008-04-04T07:13:41.156+0000","updated":"2010-03-09T18:31:01.215+0000","timeoriginalestimate":null,"description":"as per http://www.nabble.com/forum/ViewPost.jtp?post=15460899&framed=y\n\nOpenJPA issues a SELECT currval('user_id_seq'); query to get the current PK value on postgres. This should *not* execute correctly when using a schema. The correct query is SELECT currval('schemaname.user_id_seq');","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12396561","id":"12396561","filename":"OPENJPA-557.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milosz","name":"milosz","key":"milosz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milosz Tylenda","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-21T11:58:37.151+0000","size":14440,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12396561/OPENJPA-557.patch"}],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"Primary key sequences broken with postgres schemas","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12393093/comment/12585428","id":"12585428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rogerkeays","name":"rogerkeays","key":"rogerkeays","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Roger Keays","active":true,"timeZone":"America/Bogota"},"body":"Here is my patch for OpenJPA 1.0.2. You might prefer to move the code to the superclass though.\n\nIndex: openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java\n===================================================================\n--- openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java      (revision 641780)\n+++ openjpa-jdbc/src/main/java/org/apache/openjpa/jdbc/sql/PostgresDictionary.java      (working copy)\n@@ -149,6 +149,21 @@\n             \"STORE\", \"VACUUM\", \"VERBOSE\", \"VERSION\",\n         }));\n     }\n+    \n+    /**\n+     * Prepend schema names to sequence names if there is one. This\n+     * method does not escape reserved words in the schema name or\n+     * sequence name.\n+     */\n+    protected String getGeneratedKeySequenceName(Column col) {\n+        String sequence = super.getGeneratedKeySequenceName(col);\n+        String schema = col.getSchemaName();\n+        if (schema != null && schema.length() > 0) {\n+            return schema + \".\" + sequence;\n+        } else {\n+            return sequence;\n+        }\n+    }\n \n     public Date getDate(ResultSet rs, int column)\n         throws SQLException { \n\nThis patch has been fine in production for me over the last week.\n\nAdam Hardy also adds:\n\nYou might want to make that schema.toLowerCase()\n\nPostgres diverges from the JDBC spec by making everything lower case and it\nwon't find an upper case schema. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rogerkeays","name":"rogerkeays","key":"rogerkeays","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Roger Keays","active":true,"timeZone":"America/Bogota"},"created":"2008-04-04T07:14:48.409+0000","updated":"2008-04-04T07:14:48.409+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12393093/comment/12649089","id":"12649089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mihbor%40wp.pl","name":"mihbor@wp.pl","key":"mihbor@wp.pl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Borowiecki","active":true,"timeZone":"Etc/UTC"},"body":"I experienced this bug in geronimo 2.1.3\n\nI checked out openjpa tag 1.0.3 sources, applied the patch, compiled and substituted the class file in openjpa-1.0.3.jar in geronimo 2.1.3 repository.\nI confirm the patch works.\n\nThis issue is very important and I hope someone applies it to trunk soon :)\n\nThanks for the patch Roger!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mihbor%40wp.pl","name":"mihbor@wp.pl","key":"mihbor@wp.pl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Borowiecki","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-19T16:48:40.448+0000","updated":"2008-11-19T16:48:40.448+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12393093/comment/12658380","id":"12658380","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milosz","name":"milosz","key":"milosz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milosz Tylenda","active":true,"timeZone":"Etc/UTC"},"body":"The patch attached fixes the problem as suggested by Mehmet in OPENJPA-582:\n\nlastGeneratedKeyQuery = \"SELECT CURRVAL(''{1}_{0}_seq'')\";\n\nThis reflects well how PostgreSQL is creating implicit sequences for SERIAL (auto-increment) columns [1]. Lower casing is already handled in DBDictionary.convertSchemaCase(String) method.\n\nI have updated the TestMultipleSchemaNames test case to make the issue visible. Previously the test case was failing in the beginning on PostgreSQL because of schema handling. Derby and DB2 create schema automatically in CREATE TABLE if schema does not exist. PostgreSQL requires explicit schema creation. I have added this to the test case. If we run the test case on Oracle or MySQL, the things are even worse because Oracle treats what we call schema a user name and MySQL treats it as database name.\n\nI added two DogX classes and removed comments from some others as I found them misleading.\n\n[1] http://www.postgresql.org/docs/8.3/interactive/datatype-numeric.html#DATATYPE-SERIAL","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milosz","name":"milosz","key":"milosz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milosz Tylenda","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-21T11:58:37.226+0000","updated":"2008-12-21T11:58:37.226+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12393093/comment/12658381","id":"12658381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milosz","name":"milosz","key":"milosz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milosz Tylenda","active":true,"timeZone":"Etc/UTC"},"body":"Applying the patch and running the test suite reveals another problem with schema handling in PostgreSQL. I will open a separate JIRA issue.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=milosz","name":"milosz","key":"milosz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Milosz Tylenda","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-21T12:02:36.818+0000","updated":"2008-12-21T12:02:36.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12393093/comment/12659008","id":"12659008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"body":"Patch provided by Milosz Tylenda has been checked in under svn trunk r729180 and branch 1.3.x r729181.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fancy","name":"fancy","key":"fancy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Catalina Wei","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-24T00:23:45.739+0000","updated":"2008-12-24T00:23:45.739+0000"}],"maxResults":5,"total":5,"startAt":0},"customfield_12311820":"0|i0z1yv:","customfield_12314139":null}}

