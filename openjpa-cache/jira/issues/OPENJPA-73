{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12354404","self":"https://issues.apache.org/jira/rest/api/2/issue/12354404","key":"OPENJPA-73","fields":{"fixVersions":[],"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12312323":null,"customfield_12312320":null,"customfield_12310420":"160410","customfield_12312321":null,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312326":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12312331":null,"customfield_12312332":null,"aggregatetimeoriginalestimate":null,"timeestimate":null,"customfield_12312330":null,"versions":[],"customfield_12311120":null,"customfield_12313826":null,"customfield_12312339":null,"issuelinks":[],"customfield_12313825":null,"assignee":null,"customfield_12312337":null,"customfield_12313823":null,"customfield_12312338":null,"customfield_12311920":null,"customfield_12313822":null,"customfield_12312335":null,"customfield_12313821":null,"customfield_12312336":null,"customfield_12313820":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"aggregatetimeestimate":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"203534","customfield_12312823":null,"creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"aggregateprogress":{"progress":0,"total":0},"customfield_12313520":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"customfield_12313924":null,"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-73/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12313920":null,"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"customfield_12314020":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@10d0cff4[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@625f5f9c[overall=PullRequestOverallBean{stateCount=0, state='OPEN', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@59963493[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@412d2382[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@3038751e[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@48b6e1[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@689238d7[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@408b3774[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@33e82afe[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@76d27ddc[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@f7fa751[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@1656115d[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\"cachedValue\":{\"errors\":[],\"configErrors\":[],\"summary\":{\"pullrequest\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":\"OPEN\",\"details\":{\"openCount\":0,\"mergedCount\":0,\"declinedCount\":0,\"total\":0},\"open\":true},\"byInstanceType\":{}},\"build\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"failedBuildCount\":0,\"successfulBuildCount\":0,\"unknownBuildCount\":0},\"byInstanceType\":{}},\"review\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"stateCount\":0,\"state\":null,\"dueDate\":null,\"overDue\":false,\"completed\":false},\"byInstanceType\":{}},\"deployment-environment\":{\"overall\":{\"count\":0,\"lastUpdated\":null,\"topEnvironments\":[],\"showProjects\":false,\"successfulCount\":0},\"byInstanceType\":{}},\"repository\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}},\"branch\":{\"overall\":{\"count\":0,\"lastUpdated\":null},\"byInstanceType\":{}}}},\"isStale\":false}}","customfield_12314141":null,"customfield_12314140":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310351","id":"12310351","key":"OPENJPA","name":"OpenJPA","projectTypeKey":"software","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310351&avatarId=10043","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310351&avatarId=10043","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310351&avatarId=10043","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310351&avatarId=10043"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10252","id":"10252","description":"","name":"OpenJPA"}},"aggregatetimespent":null,"customfield_12312520":null,"customfield_12314422":null,"customfield_12314421":null,"customfield_12314146":null,"customfield_12314420":null,"customfield_12314145":null,"customfield_12314144":null,"customfield_12314143":null,"resolutiondate":"2006-11-06T18:26:15.000+0000","workratio":-1,"customfield_12312923":null,"customfield_12312920":null,"customfield_12312921":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/OPENJPA-73/watchers","watchCount":0,"isWatching":false},"created":"2006-10-31T22:19:17.000+0000","updated":"2010-03-09T18:35:37.161+0000","timeoriginalestimate":null,"description":"PersistenceProviderImpl.createContainerEntityManagerFactory() doesn't work if you supply jdbc specific properties such as \n\n                        <property name=\"openjpa.Sequence\" value=\"table(Table=OPENJPASEQ, Increment=100)\"/>\n\n(or rather its string equivalent in the map argument)\n\nThe problem is that the ClassTransformerImpl creates a OpenJPAConfigurationImpl which doesn't know anything about jdbc configuration properties such as the sequence, but it gets fed all the properties you supply.\n\nChanging the code in PersistenceProviderImpl to create a JDBCConfigurationImpl makes everything work:  heres a patch to do this:\n\nIndex: openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java\n===================================================================\n--- openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java       (revision 469568)\n+++ openjpa-persistence/src/main/java/org/apache/openjpa/persistence/PersistenceProviderImpl.java       (working copy)\n@@ -89,17 +89,17 @@\n             // add enhancer\n             String ctOpts = (String) Configurations.getProperty\n                 (CLASS_TRANSFORMER_OPTIONS, pui.getProperties());\n-            pui.addTransformer(new ClassTransformerImpl(cp, ctOpts, \n+            pui.addTransformer(new ClassTransformerImpl(cp, ctOpts,\n                 pui.getNewTempClassLoader()));\n \n-            BrokerFactory factory = Bootstrap.newBrokerFactory(cp, \n+            BrokerFactory factory = Bootstrap.newBrokerFactory(cp,\n                 pui.getClassLoader());\n             return OpenJPAPersistence.toEntityManagerFactory(factory);\n         } catch (Exception e) {\n             throw PersistenceExceptions.toPersistenceException(e);\n         }\n     }\n-    \n+\n     /**\n      * Java EE 5 class transformer.\n      */\n@@ -108,10 +108,24 @@\n \n         private final ClassFileTransformer _trans;\n \n-        private ClassTransformerImpl(ConfigurationProvider cp, String props, \n+        private ClassTransformerImpl(ConfigurationProvider cp, String props,\n             final ClassLoader tmpLoader) {\n             // create an independent conf for enhancement\n-            OpenJPAConfiguration conf = new OpenJPAConfigurationImpl();\n+            OpenJPAConfiguration conf = null;\n+            try {\n+                ClassLoader tccl = Thread.currentThread().getContextClassLoader();\n+                Class clazz = Class.forName(\"org.apache.openjpa.jdbc.conf.JDBCConfigurationImpl\", true, tccl);\n+                conf = (OpenJPAConfiguration)clazz.newInstance();\n+            } catch (ClassNotFoundException e) {\n+                e.printStackTrace();\n+            } catch (IllegalAccessException e) {\n+                e.printStackTrace();\n+            } catch (InstantiationException e) {\n+                e.printStackTrace();\n+            }\n+            if (conf == null) {\n+                conf = new OpenJPAConfigurationImpl();\n+            }\n             cp.setInto(conf);\n             // don't allow connections\n             conf.setConnectionUserName(null);\n\n\nIt seems to me that using a JDBCConfiguration here is not needed: what is needed is to ignore properties that the OpenJPAConfigurationImpl doesn't understand, rather than throwing an exception.  We're only setting up the class transformer here, not the runtime configuration.\n\nI don't understand enough to suggest where to fix this, but given some hints I could make a try.\n\n\nThe relevant parts of the stacktrace showing the original error is:\n\nCaused by: java.lang.IllegalArgumentException: java.lang.ClassNotFoundException: table in classloader org.apache.geronimo.configs/openjpa/1.2-SNAPSHOT/car\n        at serp.util.Strings.toClass(Strings.java:211)\n        at serp.util.Strings.toClass(Strings.java:140)\n        at org.apache.openjpa.lib.conf.Configurations.newInstance(Configurations.java:135)\n        ... 62 more\n\n        at org.apache.openjpa.lib.conf.ConfigurationImpl.instantiateAll(ConfigurationImpl.java:278)\n        at org.apache.openjpa.conf.OpenJPAConfigurationImpl.instantiateAll(OpenJPAConfigurationImpl.java:1400)\n        at org.apache.openjpa.persistence.PersistenceProviderImpl$ClassTransformerImpl.<init>(PersistenceProviderImpl.java:130)\n        at org.apache.openjpa.persistence.PersistenceProviderImpl$ClassTransformerImpl.<init>(PersistenceProviderImpl.java:106)\n        at org.apache.openjpa.persistence.PersistenceProviderImpl.createContainerEntityManagerFactory(PersistenceProviderImpl.java:92)\n        at org.apache.geronimo.persistence.PersistenceUnitGBean.<init>(PersistenceUnitGBean.java:91)","customfield_10010":null,"timetracking":{},"customfield_12314523":null,"customfield_12314127":null,"customfield_12314522":null,"customfield_12314126":null,"customfield_12314521":null,"customfield_12314125":null,"customfield_12314520":null,"customfield_12314124":null,"attachment":[],"customfield_12312340":null,"customfield_12314123":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12314122":null,"customfield_12314121":null,"customfield_12310041":null,"customfield_12314120":null,"customfield_12314129":null,"customfield_12314524":null,"customfield_12314128":null,"summary":"PersistenceProviderImpl.createContainerEntityManagerFactory() doesn't work if you supply jdbc specific properties","customfield_12314130":null,"customfield_12310291":null,"customfield_12310290":null,"customfield_12314138":null,"customfield_12314137":null,"environment":null,"customfield_12314136":null,"customfield_12314135":null,"customfield_12311020":null,"customfield_12314134":null,"duedate":null,"customfield_12314132":null,"customfield_12314131":null,"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12354404/comment/12446144","id":"12446144","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"Abe White suggested on the dev list that the transformer configuration will never need to load optional plugins so eliminating line 130\n\n            conf.instantiateAll();\n\nshould not break anything and should fix the problems.  I've verified that removing line 130 fixes the problems I was seeing, and my sample app now works fine.  I pre-enhanced my classes so my experience may not indicate much about lack of other side effects :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2006-11-01T01:34:02.000+0000","updated":"2006-11-01T01:34:02.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12354404/comment/12446288","id":"12446288","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=awhite","name":"awhite","key":"awhite","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A. Abram White","active":true,"timeZone":"Etc/UTC"},"body":"David -- if you can verify that things also work if you don't pre-enhance, we'll commit the change.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=awhite","name":"awhite","key":"awhite","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A. Abram White","active":true,"timeZone":"Etc/UTC"},"created":"2006-11-01T16:07:04.000+0000","updated":"2006-11-01T16:07:04.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12354404/comment/12447240","id":"12447240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"After a lot of work to get runtime enhancement sometimes working in geronimo, I've found a simple enough example to not run into other problems and verify that removing line 130 solves the problem both with and without runtime enhancement.  So, I'd appreciate this change being made in trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2006-11-05T08:32:35.000+0000","updated":"2006-11-05T08:32:35.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12354404/comment/12447496","id":"12447496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=awhite","name":"awhite","key":"awhite","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A. Abram White","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by not instantiating all plugins up front in class transformer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=awhite","name":"awhite","key":"awhite","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"A. Abram White","active":true,"timeZone":"Etc/UTC"},"created":"2006-11-06T18:26:15.000+0000","updated":"2006-11-06T18:26:15.000+0000"}],"maxResults":4,"total":4,"startAt":0},"customfield_12311820":"0|i0z7lr:","customfield_12314139":null}}

