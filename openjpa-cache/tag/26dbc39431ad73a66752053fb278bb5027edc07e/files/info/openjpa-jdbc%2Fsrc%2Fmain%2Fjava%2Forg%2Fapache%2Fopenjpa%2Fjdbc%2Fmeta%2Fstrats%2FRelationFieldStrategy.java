{"sha":"5980871a5c8a73888eeb05c339d3bc7068c181c9","node_id":"MDQ6QmxvYjIwNjM2NDo1OTgwODcxYTVjOGE3Mzg4OGVlYjA1YzMzOWQzYmM3MDY4YzE4MWM5","size":40099,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/5980871a5c8a73888eeb05c339d3bc7068c181c9","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9y\ndCBqYXZhLnV0aWwuTGlzdDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CgppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmVuaGFuY2UuUGVyc2lzdGVuY2VDYXBh\nYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuY29uZi5KREJD\nQ29uZmlndXJhdGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJj\nLmtlcm5lbC5KREJDRmV0Y2hDb25maWd1cmF0aW9uOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLmpkYmMua2VybmVsLkpEQkNGZXRjaENvbmZpZ3VyYXRp\nb25JbXBsOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMua2VybmVs\nLkpEQkNTdG9yZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtl\ncm5lbC5KREJDU3RvcmVNYW5hZ2VyOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMubWV0YS5DbGFzc01hcHBpbmc7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5tZXRhLkVtYmVkZGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLkZpZWxkTWFwcGluZzsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuSm9pbmFibGU7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLk1hcHBpbmdJbmZvOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5WYWx1ZU1hcHBpbmc7\nCmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZhbHVlTWFw\ncGluZ0luZm87CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hl\nbWEuQ29sdW1uOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc2No\nZW1hLkNvbHVtbklPOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMu\nc2NoZW1hLkZvcmVpZ25LZXk7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\namRiYy5zY2hlbWEuUHJpbWFyeUtleTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNjaGVtYS5UYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5EQkRpY3Rpb25hcnk7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5zcWwuSm9pbnM7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuTG9naWNhbFVuaW9uOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlJlc3VsdDsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5qZGJjLnNxbC5Sb3c7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5q\ncGEuamRiYy5zcWwuUm93TWFuYWdlcjsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5TUUxCdWZmZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuU2VsZWN0OwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMuc3FsLlNlbGVjdEV4ZWN1dG9yOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlNlbGVjdEltcGw7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5zcWwuVW5pb247CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEua2VybmVsLk9wZW5KUEFTdGF0ZU1hbmFnZXI7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLmxvZy5Mb2c7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEubGliLnV0aWwuTG9jYWxpemVyOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLm1ldGEuQ2xhc3NNZXRhRGF0YTsKaW1wb3J0IG9yZy5h\ncGFjaGUub3BlbmpwYS5tZXRhLkphdmFUeXBlczsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkFwcGxpY2F0aW9uSWRzOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLnV0aWwuSW1wbEhlbHBlcjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkludGVybmFsRXhjZXB0aW9uOwppbXBvcnQgb3Jn\nLmFwYWNoZS5vcGVuanBhLnV0aWwuTWV0YURhdGFFeGNlcHRpb247CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5PcGVuSlBBSWQ7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEudXRpbC5VbnN1cHBvcnRlZEV4Y2VwdGlvbjsK\nCmltcG9ydCBzZXJwLnV0aWwuTnVtYmVyczsKCi8qKgogKiBNYXBwaW5nIGZv\nciBhIHNpbmdsZS12YWx1ZWQgcmVsYXRpb24gdG8gYW5vdGhlciBlbnRpdHku\nCiAqCiAqIEBhdXRob3IgQWJlIFdoaXRlCiAqIEBzaW5jZSAwLjQuMAogKi8K\ncHVibGljIGNsYXNzIFJlbGF0aW9uRmllbGRTdHJhdGVneQogICAgZXh0ZW5k\ncyBBYnN0cmFjdEZpZWxkU3RyYXRlZ3kKICAgIGltcGxlbWVudHMgSm9pbmFi\nbGUsIEVtYmVkZGFibGUgewoKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIExv\nY2FsaXplciBfbG9jID0gTG9jYWxpemVyLmZvclBhY2thZ2UKICAgICAgICAo\nUmVsYXRpb25GaWVsZFN0cmF0ZWd5LmNsYXNzKTsKCiAgICBwcml2YXRlIEJv\nb2xlYW4gX2ZrT2lkID0gbnVsbDsKCiAgICBwdWJsaWMgdm9pZCBtYXAoYm9v\nbGVhbiBhZGFwdCkgewogICAgICAgIGlmIChmaWVsZC5nZXRUeXBlQ29kZSgp\nICE9IEphdmFUeXBlcy5QQyB8fCBmaWVsZC5pc0VtYmVkZGVkUEMoKSkKICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nKCJub3QtcmVsYXRpb24iLCBmaWVsZCkpOwoKICAgICAgICBmaWVsZC5nZXRL\nZXlNYXBwaW5nKCkuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21w\nb25lbnRzCiAgICAgICAgICAgIChmaWVsZC5nZXRLZXkoKSwgIWFkYXB0KTsK\nICAgICAgICBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdldFZhbHVlSW5m\nbygpLmFzc2VydE5vU2NoZW1hQ29tcG9uZW50cwogICAgICAgICAgICAoZmll\nbGQuZ2V0RWxlbWVudCgpLCAhYWRhcHQpOwogICAgICAgIGJvb2xlYW4gY3Jp\ndGVyaWEgPSBmaWVsZC5nZXRWYWx1ZUluZm8oKS5nZXRVc2VDbGFzc0NyaXRl\ncmlhKCk7CgogICAgICAgIC8vIGNoZWNrIGZvciBuYW1lZCBpbnZlcnNlCiAg\nICAgICAgRmllbGRNYXBwaW5nIG1hcHBlZCA9IGZpZWxkLmdldE1hcHBlZEJ5\nTWFwcGluZygpOwogICAgICAgIGlmIChtYXBwZWQgIT0gbnVsbCkgewogICAg\nICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmFzc2VydE5vU2NoZW1h\nQ29tcG9uZW50cyhmaWVsZCwgIWFkYXB0KTsKICAgICAgICAgICAgZmllbGQu\nZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25lbnRzKGZpZWxk\nLCAhYWRhcHQpOwogICAgICAgICAgICBtYXBwZWQucmVzb2x2ZShtYXBwZWQu\nTU9ERV9NRVRBIHwgbWFwcGVkLk1PREVfTUFQUElORyk7CgogICAgICAgICAg\nICBpZiAoIW1hcHBlZC5pc01hcHBlZCgpIHx8IG1hcHBlZC5pc1NlcmlhbGl6\nZWQoKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2Vw\ndGlvbihfbG9jLmdldCgibWFwcGVkLWJ5LXVubWFwcGVkIiwKICAgICAgICAg\nICAgICAgICAgICBmaWVsZCwgbWFwcGVkKSk7CgogICAgICAgICAgICBpZiAo\nbWFwcGVkLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAg\nICAgICAgICAgICBpZiAobWFwcGVkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBt\nYXBwZWQuSk9JTl9GT1JXQVJEKSB7CiAgICAgICAgICAgICAgICAgICAgZmll\nbGQuc2V0Sm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAg\nICAgICAgICAgICAgICAgIGZpZWxkLnNldENvbHVtbnMobWFwcGVkLmdldERl\nZmluaW5nTWFwcGluZygpLgogICAgICAgICAgICAgICAgICAgICAgICBnZXRQ\ncmltYXJ5S2V5Q29sdW1ucygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBp\nZiAoaXNUeXBlVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQpKQogICAgICAgICAg\nICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdl\ndAogICAgICAgICAgICAgICAgICAgICAgICAoIm1hcHBlZC1pbnZlcnNlLXVu\nam9pbmVkIiwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAgICAg\nICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCksIG1hcHBlZCkp\nOwoKICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkobWFwcGVk\nLmdldEZvcmVpZ25LZXkKICAgICAgICAgICAgICAgICAgICAoZmllbGQuZ2V0\nRGVmaW5pbmdNYXBwaW5nKCkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICht\nYXBwZWQuZ2V0RWxlbWVudCgpLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVz\nLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUeXBlVW5qb2luZWRTdWJj\nbGFzcyhtYXBwZWQuZ2V0RWxlbWVudE1hcHBpbmcoKSkpCiAgICAgICAgICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nCiAgICAgICAgICAgICAgICAgICAgICAgICgibWFwcGVkLWludmVyc2UtdW5q\nb2luZWQiLCBmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICAgICAg\nICAgICAgICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgbWFwcGVkKSk7\nCgogICAgICAgICAgICAgICAgLy8gd2FybiB0aGUgdXNlciBhYm91dCBtYWtp\nbmcgdGhlIGNvbGxlY3Rpb24gc2lkZSB0aGUgb3duZXIKICAgICAgICAgICAg\nICAgIExvZyBsb2cgPSBmaWVsZC5nZXRSZXBvc2l0b3J5KCkuZ2V0TG9nKCk7\nCiAgICAgICAgICAgICAgICBpZiAobG9nLmlzSW5mb0VuYWJsZWQoKSkKICAg\nICAgICAgICAgICAgICAgICBsb2cuaW5mbyhfbG9jLmdldCgiY29sbC1vd25l\nciIsIGZpZWxkLCBtYXBwZWQpKTsKICAgICAgICAgICAgICAgIGZpZWxkLnNl\ndEZvcmVpZ25LZXkobWFwcGVkLmdldEVsZW1lbnRNYXBwaW5nKCkuCiAgICAg\nICAgICAgICAgICAgICAgZ2V0Rm9yZWlnbktleSgpKTsKICAgICAgICAgICAg\nfSBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTWV0YURhdGFFeGNl\ncHRpb24oX2xvYy5nZXQoIm5vdC1pbnYtcmVsYXRpb24iLAogICAgICAgICAg\nICAgICAgICAgIGZpZWxkLCBtYXBwZWQpKTsKCiAgICAgICAgICAgIGZpZWxk\nLnNldFVzZUNsYXNzQ3JpdGVyaWEoY3JpdGVyaWEpOwogICAgICAgICAgICBy\nZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2Fy\neSB0byBzdXBwb3J0IG9wZW5qcGEgMyBtYXBwaW5ncywgd2hpY2ggZGlkbid0\nCiAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIHNlY29uZGFyeSB0\nYWJsZSBqb2lucyBhbmQgcmVsYXRpb25zIGJ1aWx0CiAgICAgICAgLy8gYXJv\ndW5kIGFuIGludmVyc2Uga2V5OiBjaGVjayB0byBzZWUgaWYgd2UncmUgbWFw\ncGVkIGFzIGEgc2Vjb25kYXJ5CiAgICAgICAgLy8gdGFibGUgam9pbiBidXQg\nd2UncmUgaW4gdGhlIHRhYmxlIG9mIHRoZSByZWxhdGVkIHR5cGUsIGFuZCBp\nZiBzbwogICAgICAgIC8vIHN3aXRjaCBvdXIgam9pbiBtYXBwaW5nIGluZm8g\ndG8gb3VyIHZhbHVlIG1hcHBpbmcgaW5mbwogICAgICAgIFN0cmluZyB0YWJs\nZU5hbWUgPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldFRhYmxlTmFtZSgp\nOwogICAgICAgIFRhYmxlIHRhYmxlID0gZmllbGQuZ2V0VHlwZU1hcHBpbmco\nKS5nZXRUYWJsZSgpOwogICAgICAgIFZhbHVlTWFwcGluZ0luZm8gdmluZm8g\nPSBmaWVsZC5nZXRWYWx1ZUluZm8oKTsKICAgICAgICBpZiAodGFibGVOYW1l\nICE9IG51bGwgJiYgdGFibGUgIT0gbnVsbAogICAgICAgICAgICAmJiAodGFi\nbGVOYW1lLmVxdWFsc0lnbm9yZUNhc2UodGFibGUuZ2V0TmFtZSgpKQogICAg\nICAgICAgICB8fCB0YWJsZU5hbWUuZXF1YWxzSWdub3JlQ2FzZSh0YWJsZS5n\nZXRGdWxsTmFtZSgpKSkpIHsKICAgICAgICAgICAgdmluZm8uc2V0Sm9pbkRp\ncmVjdGlvbihNYXBwaW5nSW5mby5KT0lOX0lOVkVSU0UpOwogICAgICAgICAg\nICB2aW5mby5zZXRDb2x1bW5zKGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuZ2V0\nQ29sdW1ucygpKTsKICAgICAgICAgICAgZmllbGQuZ2V0TWFwcGluZ0luZm8o\nKS5zZXRUYWJsZU5hbWUobnVsbCk7CiAgICAgICAgICAgIGZpZWxkLmdldE1h\ncHBpbmdJbmZvKCkuc2V0Q29sdW1ucyhudWxsKTsKICAgICAgICB9CgogICAg\nICAgIGZpZWxkLm1hcEpvaW4oYWRhcHQsIGZhbHNlKTsKICAgICAgICBpZiAo\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5pc01hcHBlZCgpKSB7CiAgICAgICAg\nICAgIEZvcmVpZ25LZXkgZmsgPSB2aW5mby5nZXRUeXBlSm9pbihmaWVsZCwg\nZmllbGQuZ2V0TmFtZSgpLCB0cnVlLAogICAgICAgICAgICAgICAgYWRhcHQp\nOwogICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWduS2V5KGZrKTsKICAgICAg\nICAgICAgZmllbGQuc2V0Q29sdW1uSU8odmluZm8uZ2V0Q29sdW1uSU8oKSk7\nCiAgICAgICAgICAgIGlmICh2aW5mby5nZXRKb2luRGlyZWN0aW9uKCkgPT0g\ndmluZm8uSk9JTl9JTlZFUlNFKQogICAgICAgICAgICAgICAgZmllbGQuc2V0\nSm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAgICAgIH0g\nZWxzZQogICAgICAgICAgICBSZWxhdGlvblN0cmF0ZWdpZXMubWFwUmVsYXRp\nb25Ub1VubWFwcGVkUEMoZmllbGQsIGZpZWxkLmdldE5hbWUoKSwKICAgICAg\nICAgICAgICAgIGFkYXB0KTsKCiAgICAgICAgZmllbGQuc2V0VXNlQ2xhc3ND\ncml0ZXJpYShjcml0ZXJpYSk7CiAgICAgICAgZmllbGQubWFwUHJpbWFyeUtl\neShhZGFwdCk7CiAgICAgICAgUHJpbWFyeUtleSBwayA9IGZpZWxkLmdldFRh\nYmxlKCkuZ2V0UHJpbWFyeUtleSgpOwogICAgICAgIGlmIChmaWVsZC5pc1By\naW1hcnlLZXkoKSkgewogICAgICAgICAgICBDb2x1bW5bXSBjb2xzID0gZmll\nbGQuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocGsgIT0gbnVsbCAm\nJiAoYWRhcHQgfHwgcGsuaXNMb2dpY2FsKCkpKQogICAgICAgICAgICAgICAg\nZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAgICAg\nICAgICAgICAgICAgIHBrLmFkZENvbHVtbihjb2xzW2ldKTsKICAgICAgICAg\nICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAg\nICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkuc2V0Sm9p\nbmFibGUoY29sc1tpXSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBt\nYXAgY29uc3RyYWludHMgYWZ0ZXIgcGsgc28gd2UgZG9uJ3QgcmUtaW5kZXgg\nLyByZS11bmlxdWUgcGsgY29sCiAgICAgICAgZmllbGQubWFwQ29uc3RyYWlu\ndHMoZmllbGQuZ2V0TmFtZSgpLCBhZGFwdCk7CiAgICB9CgogICAgLyoqCiAg\nICAgKiBSZXR1cm4gd2hldGhlciBvdXIgZGVmaW5pbmcgbWFwcGluZyBpcyBh\nbiB1bmpvaW5lZCBzdWJjbGFzcyBvZgogICAgICogdGhlIHR5cGUgb2YgdGhl\nIGdpdmVuIHZhbHVlLgogICAgICovCiAgICBwcml2YXRlIGJvb2xlYW4gaXNU\neXBlVW5qb2luZWRTdWJjbGFzcyhWYWx1ZU1hcHBpbmcgbWFwcGVkKSB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGRlZiA9IGZpZWxkLmdldERlZmluaW5nTWFw\ncGluZygpOwogICAgICAgIGZvciAoOyBkZWYgIT0gbnVsbDsgZGVmID0gZGVm\nLmdldEpvaW5hYmxlUENTdXBlcmNsYXNzTWFwcGluZygpKQogICAgICAgICAg\nICBpZiAoZGVmID09IG1hcHBlZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAg\nICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIGluaXRpYWxpemUoKSB7CiAgICAgICAg\nZmllbGQuc2V0VXNlc0ludGVybWVkaWF0ZSh0cnVlKTsKCiAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBp\nZiAoZmsgPT0gbnVsbCkKICAgICAgICAgICAgX2ZrT2lkID0gQm9vbGVhbi5U\nUlVFOwogICAgICAgIGVsc2UgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24o\nKSAhPSBGaWVsZE1hcHBpbmcuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICBf\nZmtPaWQgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpLmlzRm9yZWlnbktleU9i\namVjdElkKGZrKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbnNlcnQoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5h\nZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAg\nIGlmIChmaWVsZC5nZXRNYXBwZWRCeSgpICE9IG51bGwpCiAgICAgICAgICAg\nIHJldHVybjsKCiAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBS\nZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyCiAgICAgICAgICAg\nIChzbS5mZXRjaE9iamVjdEZpZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9y\nZS5nZXRDb250ZXh0KCkpOwogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICB1\ncGRhdGVJbnZlcnNlKHNtLCByZWwsIHN0b3JlLCBybSk7CiAgICAgICAgZWxz\nZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3coc20sIHN0\nb3JlLCBybSwgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAgICAgICBpZiAo\ncm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWdu\nS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIHZv\naWQgdXBkYXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBz\ndG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0\naW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxs\nKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncgogICAgICAgICAgICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJ\nbmRleCgpKSwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKCiAgICAgICAgaWYgKGZp\nZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0Up\nIHsKICAgICAgICAgICAgbnVsbEludmVyc2Uoc20sIHJtKTsKICAgICAgICAg\nICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAgICAg\nIH0gZWxzZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3co\nc20sIHN0b3JlLCBybSwgUm93LkFDVElPTl9VUERBVEUpOwogICAgICAgICAg\nICBpZiAocm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRG\nb3JlaWduS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgZGVsZXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNT\ndG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAh\nPSBudWxsKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7\nCiAgICAgICAgICAgIGlmIChzbS5nZXRMb2FkZWQoKS5nZXQoZmllbGQuZ2V0\nSW5kZXgoKSkpIHsKICAgICAgICAgICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFn\nZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihz\nbS4KICAgICAgICAgICAgICAgICAgICBmZXRjaE9iamVjdEZpZWxkKGZpZWxk\nLmdldEluZGV4KCkpLCBzdG9yZS5nZXRDb250ZXh0KCkpOwogICAgICAgICAg\nICAgICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAg\nICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG51bGxJbnZlcnNlKHNt\nLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmllbGQuZGVs\nZXRlUm93KHNtLCBzdG9yZSwgcm0pOwoKICAgICAgICAgICAgLy8gaWYgb3Vy\nIGZvcmVpZ24ga2V5IGhhcyBhIGRlbGV0ZSBhY3Rpb24sIHdlIG5lZWQgdG8g\nc2V0IHRoZQogICAgICAgICAgICAvLyByZWxhdGVkIG9iamVjdCBzbyBjb25z\ndHJhaW50cyBjYW4gYmUgZXZhbHVhdGVkCiAgICAgICAgICAgIE9wZW5KUEFT\ndGF0ZU1hbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRl\nTWFuYWdlcgogICAgICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0RmllbGQo\nZmllbGQuZ2V0SW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAg\nICAgICAgIGlmIChyZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKENsYXNzTWFwcGlu\nZykKICAgICAgICAgICAgICAgICAgICByZWwuZ2V0TWV0YURhdGEoKSk7CiAg\nICAgICAgICAgICAgICBpZiAoZmsuZ2V0RGVsZXRlQWN0aW9uKCkgPT0gRm9y\nZWlnbktleS5BQ1RJT05fUkVTVFJJQ1QgfHwKICAgICAgICAgICAgICAgICAg\nICBmay5nZXREZWxldGVBY3Rpb24oKSA9PSBGb3JlaWduS2V5LkFDVElPTl9D\nQVNDQURFKSB7CiAgICAgICAgICAgICAgICAgICAgUm93IHJvdyA9IGZpZWxk\nLmdldFJvdyhzbSwgc3RvcmUsIHJtLCBSb3cuQUNUSU9OX0RFTEVURSk7CiAg\nICAgICAgICAgICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIG51bGws\nIHJlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAg\nICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBOdWxsIGludmVyc2UgcmVsYXRp\nb25zIHRoYXQgcmVmZXJlbmNlIHRoZSBnaXZlbiBvYmplY3QuCiAgICAgKi8K\nICAgIHByaXZhdGUgdm9pZCBudWxsSW52ZXJzZShPcGVuSlBBU3RhdGVNYW5h\nZ2VyIHNtLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNl\ncHRpb24gewogICAgICAgIGlmIChmaWVsZC5nZXRVc2VDbGFzc0NyaXRlcmlh\nKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgRm9yZWlnbktleSBm\nayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBDb2x1bW5JTyBp\nbyA9IGZpZWxkLmdldENvbHVtbklPKCk7CiAgICAgICAgaWYgKCFpby5pc0Fu\neVVwZGF0YWJsZShmaywgdHJ1ZSkpCiAgICAgICAgICAgIHJldHVybjsKCiAg\nICAgICAgLy8gbnVsbCBpbnZlcnNlIGlmIG5vdCBhbHJlYWR5IGVuZm9yY2Vk\nIGJ5IGZrCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1h\ncHBpbmdzKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0\naW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwogICAgICAgIFJv\ndyByb3cgPSBybS5nZXRBbGxSb3dzKGZrLmdldFRhYmxlKCksIFJvdy5BQ1RJ\nT05fVVBEQVRFKTsKICAgICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgaW8s\nIG51bGwpOwogICAgICAgIHJvdy53aGVyZUZvcmVpZ25LZXkoZmssIHNtKTsK\nICAgICAgICBybS5mbHVzaEFsbFJvd3Mocm93KTsKICAgIH0KCiAgICAvKioK\nICAgICAqIFRoaXMgbWV0aG9kIHVwZGF0ZXMgdGhlIGludmVyc2UgY29sdW1u\ncyBvZiBvdXIgcmVsYXRpb24KICAgICAqIHdpdGggdGhlIGdpdmVuIG9iamVj\ndC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIHVwZGF0ZUludmVyc2UoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgT3BlbkpQQVN0YXRlTWFuYWdlciByZWws\nCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChyZWwgPT0g\nbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBGb3JlaWduS2V5\nIGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbHVtbklP\nIGlvID0gZmllbGQuZ2V0Q29sdW1uSU8oKTsKCiAgICAgICAgaW50IGFjdGlv\nbjsKICAgICAgICBpZiAocmVsLmlzTmV3KCkgJiYgIXJlbC5pc0ZsdXNoZWQo\nKSkgewogICAgICAgICAgICBpZiAoc20uaXNEZWxldGVkKCkgfHwgIWlvLmlz\nQW55SW5zZXJ0YWJsZShmaywgZmFsc2UpKQogICAgICAgICAgICAgICAgcmV0\ndXJuOwogICAgICAgICAgICBhY3Rpb24gPSBSb3cuQUNUSU9OX0lOU0VSVDsK\nICAgICAgICB9IGVsc2UgaWYgKHJlbC5pc0RlbGV0ZWQoKSkgewogICAgICAg\nICAgICBpZiAocmVsLmlzRmx1c2hlZCgpIHx8ICFzbS5pc0RlbGV0ZWQoKSkK\nICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0g\nUm93LkFDVElPTl9ERUxFVEU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAg\nICAgaWYgKHNtLmlzRGVsZXRlZCgpKQogICAgICAgICAgICAgICAgc20gPSBu\ndWxsOwogICAgICAgICAgICBpZiAoIWlvLmlzQW55VXBkYXRhYmxlKGZrLCBz\nbSA9PSBudWxsKSkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAg\nICAgYWN0aW9uID0gUm93LkFDVElPTl9VUERBVEU7CiAgICAgICAgfQoKICAg\nICAgICBpZiAoZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5s\nZW5ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVn\naWVzLnVuaW52ZXJzYWJsZShmaWVsZCk7CgogICAgICAgIC8vIGdldCB0aGUg\ncm93IGZvciB0aGUgaW52ZXJzZSBvYmplY3Q7IHRoZSByb3cgbWlnaHQgYmUg\naW4gYSBzZWNvbmRhcnkKICAgICAgICAvLyB0YWJsZSBpZiB0aGVyZSBpcyBh\nIGZpZWxkIGNvbnRyb2xsaW5nIHRoZSBmb3JlaWduIGtleQogICAgICAgIFJv\ndyByb3cgPSBudWxsOwogICAgICAgIEZpZWxkTWFwcGluZ1tdIGludnMgPSBm\naWVsZC5nZXRJbnZlcnNlTWFwcGluZ3MoKTsKICAgICAgICBmb3IgKGludCBp\nID0gMDsgaSA8IGludnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYg\nKGludnNbaV0uZ2V0TWFwcGVkQnlNZXRhRGF0YSgpID09IGZpZWxkCiAgICAg\nICAgICAgICAgICAmJiBpbnZzW2ldLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5\ncGVzLlBDKSB7CiAgICAgICAgICAgICAgICByb3cgPSBpbnZzW2ldLmdldFJv\ndyhyZWwsIHN0b3JlLCBybSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIGJy\nZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIENsYXNzTWFw\ncGluZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAg\nICAgICBpZiAocm93ID09IG51bGwpCiAgICAgICAgICAgIHJvdyA9IHJtLmdl\ndFJvdyhyZWxNYXBwaW5nLmdldFRhYmxlKCksIGFjdGlvbiwgcmVsLCB0cnVl\nKTsKCiAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiB1cGRhdGUsIHRoaXMgbWln\naHQgYmUgdGhlIG9ubHkgbW9kIHRvIHRoZSByb3csIHNvCiAgICAgICAgLy8g\nbWFrZSBzdXJlIHRoZSB3aGVyZSBjb25kaXRpb24gaXMgc2V0CiAgICAgICAg\naWYgKGFjdGlvbiA9PSBSb3cuQUNUSU9OX1VQREFURQogICAgICAgICAgICAm\nJiByb3cuZ2V0VGFibGUoKSA9PSByZWxNYXBwaW5nLmdldFRhYmxlKCkpCiAg\nICAgICAgICAgIHJvdy53aGVyZVByaW1hcnlLZXkocmVsKTsKCiAgICAgICAg\nLy8gdXBkYXRlIHRoZSBpbnZlcnNlIHBvaW50ZXIgd2l0aCBvdXIgb2lkIHZh\nbHVlCiAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIGlvLCBzbSk7CiAg\nICB9CgogICAgcHVibGljIGludCBzdXBwb3J0c1NlbGVjdChTZWxlY3Qgc2Vs\nLCBpbnQgdHlwZSwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwKICAgICAgICBK\nREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gp\nIHsKICAgICAgICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9KT0lOTEVTUykK\nICAgICAgICAgICAgcmV0dXJuIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkg\nIT0gZmllbGQuSk9JTl9JTlZFUlNFCiAgICAgICAgICAgICAgICAmJiBzZWwu\naXNTZWxlY3RlZChmaWVsZC5nZXRUYWJsZSgpKSkgPyAxIDogMDsKICAgICAg\nICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9UV09fUEFSVCkKICAgICAgICAg\nICAgcmV0dXJuIDE7CgogICAgICAgIC8vIGFscmVhZHkgY2FjaGVkPwogICAg\nICAgIGlmIChzbSAhPSBudWxsKSB7CiAgICAgICAgICAgIE9iamVjdCBvaWQg\nPSBzbS5nZXRJbnRlcm1lZGlhdGUoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAg\nICAgICAgIGlmIChzdG9yZS5nZXRDb250ZXh0KCkuZmluZENhY2hlZChvaWQs\nIG51bGwpICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAg\nICAgICB9CgogICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIHN3aXRjaCAo\ndHlwZSkgewogICAgICAgICAgICBjYXNlIFNlbGVjdC5FQUdFUl9QQVJBTExF\nTDoKICAgICAgICAgICAgICAgIHJldHVybiBjbHNzLmxlbmd0aDsKICAgICAg\nICAgICAgY2FzZSBTZWxlY3QuRUFHRVJfT1VURVI6CiAgICAgICAgICAgICAg\nICByZXR1cm4gKGNsc3MubGVuZ3RoID09IDEgJiYgc3RvcmUuZ2V0REJEaWN0\naW9uYXJ5KCkuY2FuT3V0ZXJKb2luCiAgICAgICAgICAgICAgICAgICAgKHNl\nbC5nZXRKb2luU3ludGF4KCksIGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzc1sw\nXSkpKSA/IDEgOgogICAgICAgICAgICAgICAgICAgIDA7CiAgICAgICAgICAg\nIGNhc2UgU2VsZWN0LkVBR0VSX0lOTkVSOgogICAgICAgICAgICAgICAgcmV0\ndXJuIChjbHNzLmxlbmd0aCA9PSAxKSA/IDEgOiAwOwogICAgICAgICAgICBk\nZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIHNlbGVjdEVhZ2VyUGFyYWxsZWwoU2Vs\nZWN0RXhlY3V0b3Igc2VsLAogICAgICAgIGZpbmFsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sIGZpbmFsIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBmaW5h\nbCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBmaW5hbCBpbnQgZWFn\nZXJNb2RlKSB7CiAgICAgICAgZmluYWwgQ2xhc3NNYXBwaW5nW10gY2xzcyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAg\naWYgKCEoc2VsIGluc3RhbmNlb2YgVW5pb24pKQogICAgICAgICAgICBzZWxl\nY3RFYWdlclBhcmFsbGVsKChTZWxlY3QpIHNlbCwgY2xzc1swXSwgc3RvcmUs\nIGZldGNoLCBlYWdlck1vZGUpOwogICAgICAgIGVsc2UgewogICAgICAgICAg\nICBVbmlvbiB1bmlvbiA9IChVbmlvbikgc2VsOwogICAgICAgICAgICBpZiAo\nZmV0Y2guZ2V0U3ViY2xhc3NGZXRjaE1vZGUgKGZpZWxkLmdldFR5cGVNYXBw\naW5nKCkpIAogICAgICAgICAgICAgICAgIT0gSkRCQ0ZldGNoQ29uZmlndXJh\ndGlvbi5FQUdFUl9KT0lOKQogICAgICAgICAgICAgICAgdW5pb24uYWJvcnRV\nbmlvbigpOwogICAgICAgICAgICB1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNl\nbGVjdG9yKCkgewogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0\nKFNlbGVjdCBzZWwsIGludCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICBz\nZWxlY3RFYWdlclBhcmFsbGVsKHNlbCwgY2xzc1tpZHhdLCBzdG9yZSwgZmV0\nY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGVhZ2VyTW9kZSk7CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0K\nCiAgICAvKioKICAgICAqIFBlcmZvcm0gYW4gZWFnZXIgcGFyYWxsZWwgc2Vs\nZWN0LgogICAgICovCiAgICBwcml2YXRlIHZvaWQgc2VsZWN0RWFnZXJQYXJh\nbGxlbChTZWxlY3Qgc2VsLCBDbGFzc01hcHBpbmcgY2xzLAogICAgICAgIEpE\nQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwg\naW50IGVhZ2VyTW9kZSkgewogICAgICAgIHNlbC5zZWxlY3RQcmltYXJ5S2V5\nKGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpKTsKICAgICAgICAvLyBzZXQg\nYSB2YXJpYWJsZSBuYW1lIHRoYXQgZG9lcyBub3QgY29uZmxpY3Qgd2l0aCBh\nbnkgaW4gdGhlIHF1ZXJ5OwogICAgICAgIC8vIHVzaW5nIGEgdmFyaWFibGUg\nZ3VhcmFudGVlcyB0aGF0IHRoZSBzZWxlY3RlZCBkYXRhIHdpbGwgdXNlIGRp\nZmZlcmVudAogICAgICAgIC8vIGFsaWFzZXMgYW5kIGpvaW5zIHRoYW4gYW55\nIGV4aXN0aW5nIFdIRVJFIGNvbmRpdGlvbnMgb24gdGhpcyBmaWVsZAogICAg\nICAgIC8vIHRoYXQgbWlnaHQgb3RoZXJ3aXNlIGxpbWl0IHRoZSByZWxhdGlv\nbnMgdGhhdCBtYXRjaAogICAgICAgIEpvaW5zIGpvaW5zID0gc2VsLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNscywgdHJ1ZSk7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdlck1v\nZGUsIAogICAgICAgICAgICBqb2lucyk7CiAgICB9CgogICAgcHVibGljIHZv\naWQgc2VsZWN0RWFnZXJKb2luKFNlbGVjdCBzZWwsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hD\nb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJNb2RlKSB7CiAgICAgICAg\nLy8gbGltaXQgdGhlIGVhZ2VyIG1vZGUgdG8gc2luZ2xlIG9uIHJlY3Vyc2l2\nZSBlYWdlciBmZXRjaGluZyBiL2MKICAgICAgICAvLyBhdCB0aGlzIHBvaW50\nIHRoZSBzZWxlY3QgaGFzIGJlZW4gbW9kaWZpZWQgYW5kIGFuIGF0dGVtcHQg\ndG8KICAgICAgICAvLyBjbG9uZSBpdCBmb3IgYSB0by1tYW55IGVhZ2VyIHNl\nbGVjdCBjYW4gcmVzdWx0IGluIGEgY2xvbmUgdGhhdAogICAgICAgIC8vIHBy\nb2R1Y2VzIGludmFsaWQgU1FMCiAgICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07CiAgICAg\nICAgYm9vbGVhbiBmb3JjZUlubmVyID0gZmV0Y2guaGFzRmV0Y2hJbm5lckpv\naW4oZmllbGQuZ2V0RnVsbE5hbWUoZmFsc2UpKSA/CiAgICAgICAgICAgICAg\nICB0cnVlIDogZmFsc2U7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLAogICAgICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4sCiAgICAg\nICAgICAgIGVhZ2VySm9pbihzZWwubmV3Sm9pbnMoKSwgY2xzLCBmb3JjZUlu\nbmVyKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgdGhlIGpvaW5zIG5l\nZWRlZCB0byBzZWxlY3QvbG9hZCBlYWdlciBkYXRhLgogICAgICovCiAgICBw\ncml2YXRlIEpvaW5zIGVhZ2VySm9pbihKb2lucyBqb2lucywgQ2xhc3NNYXBw\naW5nIGNscywgYm9vbGVhbiBmb3JjZUlubmVyKSB7CiAgICAgICAgYm9vbGVh\nbiBpbnZlcnNlID0gZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRTsKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAg\nICAgICAgam9pbnMgPSBqb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAg\nIGpvaW5zID0gc2V0RW1iZWRkZWRWYXJpYWJsZShqb2lucyk7CiAgICAgICAg\nfQoKICAgICAgICAvLyBhbmQgam9pbiBpbnRvIHJlbGF0aW9uCiAgICAgICAg\nRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzKTsKICAg\nICAgICBpZiAoIWZvcmNlSW5uZXIgJiYgZmllbGQuZ2V0TnVsbFZhbHVlKCkg\nIT0gRmllbGRNYXBwaW5nLk5VTExfRVhDRVBUSU9OKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgp\nLCBmaywgZmllbGQuCiAgICAgICAgICAgICAgICBnZXRUeXBlTWFwcGluZygp\nLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZhbHNl\nKTsKICAgICAgICByZXR1cm4gam9pbnMuam9pblJlbGF0aW9uKGZpZWxkLmdl\ndE5hbWUoKSwgZmssIGZpZWxkLmdldFR5cGVNYXBwaW5nKCksIAogICAgICAg\nICAgICBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZh\nbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIElmIGpvaW5pbmcgZnJvbSBh\nbiBlbWJlZGRlZCBvd25lciwgdXNlIHZhcmlhYmxlIHRvIGNyZWF0ZSBhIHVu\naXF1ZQogICAgICogYWxpYXMgaW4gY2FzZSBvd25lciBjb250YWlucyBvdGhl\nciBzYW1lLXR5cGVkIGVtYmVkZGVkIHJlbGF0aW9ucy4KICAgICAqLwogICAg\ncHJpdmF0ZSBKb2lucyBzZXRFbWJlZGRlZFZhcmlhYmxlKEpvaW5zIGpvaW5z\nKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldERlZmluaW5nTWV0YURhdGEoKS5n\nZXRFbWJlZGRpbmdNZXRhRGF0YSgpID09IG51bGwpCiAgICAgICAgICAgIHJl\ndHVybiBqb2luczsKICAgICAgICByZXR1cm4gam9pbnMuc2V0VmFyaWFibGUo\nZmllbGQuZ2V0RGVmaW5pbmdNZXRhRGF0YSgpLgogICAgICAgICAgICBnZXRF\nbWJlZGRpbmdNZXRhRGF0YSgpLmdldEZpZWxkTWV0YURhdGEoKS5nZXROYW1l\nKCkpOwogICAgfQoKICAgIHB1YmxpYyBpbnQgc2VsZWN0KFNlbGVjdCBzZWws\nIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJN\nb2RlKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9\nPSBmaWVsZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybiAtMTsK\nICAgICAgICAvLyBhbHJlYWR5IGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNt\nICE9IG51bGwgJiYgc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4\nKCkpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBp\nZiAoIUJvb2xlYW4uVFJVRS5lcXVhbHMoX2ZrT2lkKSkKICAgICAgICAgICAg\ncmV0dXJuIC0xOwogICAgICAgIHNlbC5zZWxlY3QoZmllbGQuZ2V0Q29sdW1u\ncygpLCBmaWVsZC5qb2luKHNlbCkpOwogICAgICAgIHJldHVybiAwOwogICAg\nfQoKICAgIHB1YmxpYyBPYmplY3QgbG9hZEVhZ2VyUGFyYWxsZWwoT3BlbkpQ\nQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpE\nQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIE9iamVjdCByZXMpCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gcHJvY2VzcyBi\nYXRjaGVkIHJlc3VsdHMgaWYgd2UgaGF2ZW4ndCBhbHJlYWR5CiAgICAgICAg\nTWFwIHJlbHM7CiAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFJlc3VsdCkK\nICAgICAgICAgICAgcmVscyA9IHByb2Nlc3NFYWdlclBhcmFsbGVsUmVzdWx0\nKHNtLCBzdG9yZSwgZmV0Y2gsIChSZXN1bHQpIHJlcyk7CiAgICAgICAgZWxz\nZQogICAgICAgICAgICByZWxzID0gKE1hcCkgcmVzOwoKICAgICAgICAvLyBz\ndG9yZSBvYmplY3QgZm9yIHRoaXMgb2lkIGluIGluc3RhbmNlCiAgICAgICAg\nc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgcmVscy5yZW1vdmUo\nc20uZ2V0T2JqZWN0SWQoKSkpOwogICAgICAgIHJldHVybiByZWxzOwogICAg\nfQoKICAgIC8qKgogICAgICogUHJvY2VzcyB0aGUgZ2l2ZW4gYmF0Y2hlZCBy\nZXN1bHQuCiAgICAgKi8KICAgIHByaXZhdGUgTWFwIHByb2Nlc3NFYWdlclBh\ncmFsbGVsUmVzdWx0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAg\nSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNo\nLCBSZXN1bHQgcmVzKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewog\nICAgICAgIC8vIGRvIHNhbWUgam9pbnMgYXMgZm9yIGxvYWQKICAgICAgICAv\nLyMjIyBjaGVhdDogd2Uga25vdyB0eXBpY2FsIHJlc3VsdCBqb2lucyBvbmx5\nIGNhcmUgYWJvdXQgdGhlIHJlbGF0aW9uCiAgICAgICAgLy8jIyMgcGF0aDsg\ndGh1cyB3ZSBjYW4gaWdub3JlIGRpZmZlcmVudCBtYXBwaW5ncwogICAgICAg\nIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5\ncGVNYXBwaW5ncygpOwogICAgICAgIEpvaW5zIGpvaW5zID0gcmVzLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNsc3NbMF0sIHRydWUpOwoKICAgICAgICBNYXAgcmVscyA9IG5ldyBI\nYXNoTWFwKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIG93bmVyID0gZmllbGQu\nZ2V0RGVmaW5pbmdNYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIGNs\nczsKICAgICAgICBPYmplY3Qgb2lkOwogICAgICAgIHdoaWxlIChyZXMubmV4\ndCgpKSB7CiAgICAgICAgICAgIGNscyA9IHJlcy5nZXRCYXNlTWFwcGluZygp\nOwogICAgICAgICAgICBpZiAoY2xzID09IG51bGwpCiAgICAgICAgICAgICAg\nICBjbHMgPSBjbHNzWzBdOwogICAgICAgICAgICBvaWQgPSBvd25lci5nZXRP\nYmplY3RJZChzdG9yZSwgcmVzLCBudWxsLCB0cnVlLCBudWxsKTsKICAgICAg\nICAgICAgcmVscy5wdXQob2lkLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRj\naCwgam9pbnMpKTsKICAgICAgICB9CiAgICAgICAgcmVzLmNsb3NlKCk7Cgog\nICAgICAgIHJldHVybiByZWxzOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxv\nYWRFYWdlckpvaW4oT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3Jl\nIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gs\nIFJlc3VsdCByZXMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9IGZpZWxkLmdldEluZGVwZW5kZW50\nVHlwZU1hcHBpbmdzKClbMF07CgogICAgICAgIC8vIGZvciBpbnZlcnNlRWFn\nZXIgZmllbGQKICAgICAgICBGaWVsZE1hcHBpbmcgbWFwcGVkQnlGaWVsZE1h\ncHBpbmcgPSBmaWVsZC5nZXRNYXBwZWRCeU1hcHBpbmcoKTsKICAgICAgICBQ\nZXJzaXN0ZW5jZUNhcGFibGUgbWFwcGVkQnlWYWx1ZSA9IG51bGw7CgogICAg\nICAgIGlmIChtYXBwZWRCeUZpZWxkTWFwcGluZyAhPSBudWxsKSB7CiAgICAg\nICAgICAgIFZhbHVlTWFwcGluZyB2YWwgPSBtYXBwZWRCeUZpZWxkTWFwcGlu\nZy5nZXRWYWx1ZU1hcHBpbmcoKTsKICAgICAgICAgICAgQ2xhc3NNZXRhRGF0\nYSBkZWNNZXRhID0gdmFsLmdldFR5cGVNZXRhRGF0YSgpOwogICAgICAgICAg\nICAvLyBlYWdlciBsb2FkaW5nIGEgY2hpbGQgZnJvbSBpdHMgdG9PbmUgcGFy\nZW50IGFuZAogICAgICAgICAgICAvLyB0aGUgcGFyZW50IGhhcyBAT25lVG9P\nbmUobWFwcGVkQnk9InBhcmVudCIpIGNoaWxkIHJlbGF0aW9uLgogICAgICAg\nICAgICAvLyBCeSBzYXZpbmcgdGhlIG1hcHBlZC1ieSBpbmZvIGluICdyZXMn\nIGlzIHRvCiAgICAgICAgICAgIC8vIGF2b2lkIHVubmVlZGVkIFNRTCBwdXNo\nZG93biB0aGF0IHdvdWxkIG90aGVyd2lzZSBnZXRzCiAgICAgICAgICAgIC8v\nIGdlbmVyYXRlZC4KICAgICAgICAgICAgaWYgKGRlY01ldGEgIT0gbnVsbCkg\newogICAgICAgICAgICAgICAgbWFwcGVkQnlWYWx1ZSA9IHNtLmdldFBlcnNp\nc3RlbmNlQ2FwYWJsZSgpOwogICAgICAgICAgICAgICAgcmVzLnNldE1hcHBl\nZEJ5RmllbGRNYXBwaW5nKG1hcHBlZEJ5RmllbGRNYXBwaW5nKTsKICAgICAg\nICAgICAgICAgIHJlcy5zZXRNYXBwZWRCeVZhbHVlKG1hcHBlZEJ5VmFsdWUp\nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzbS5zdG9yZU9i\namVjdChmaWVsZC5nZXRJbmRleCgpLCByZXMubG9hZChjbHMsIHN0b3JlLCBm\nZXRjaCwKICAgICAgICBlYWdlckpvaW4ocmVzLm5ld0pvaW5zKCksIGNscywg\nZmFsc2UpKSk7CgogICAgICAgIC8vIHJlc2V0IG1hcHBlZCBieSBpcyBuZWVk\nZWQgZm9yIE9uZVRvT25lIGJpZGlyZWN0aW9uYWwgcmVsYXRpb25zCiAgICAg\nICAgLy8gaGF2aW5nIGEgbWFwcGVkLWJ5IHBhcmVudCB0byBjb3JyZWN0bHkg\nc2V0IHRoZSBwYXJlbnQtY2hpbGQKICAgICAgICAvLyByZWxhdGlvbi4KICAg\nICAgICByZXMuc2V0TWFwcGVkQnlGaWVsZE1hcHBpbmcobnVsbCk7CiAgICAg\nICAgcmVzLnNldE1hcHBlZEJ5VmFsdWUobnVsbCk7CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgbG9hZChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3Rv\ncmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRj\naCwgUmVzdWx0IHJlcykKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIC8v\nIGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNtICE9IG51bGwgJiYgc20uZ2V0\nSW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpICE9IG51bGwpCiAgICAg\nICAgICAgIHJldHVybjsKICAgICAgICBpZiAoIUJvb2xlYW4uVFJVRS5lcXVh\nbHMoX2ZrT2lkKSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmICgh\ncmVzLmNvbnRhaW5zQWxsKGZpZWxkLmdldENvbHVtbnMoKSkpCiAgICAgICAg\nICAgIHJldHVybjsKCiAgICAgICAgLy8gZ2V0IHRoZSByZWxhdGVkIG9iamVj\ndCdzIG9pZAogICAgICAgIENsYXNzTWFwcGluZyByZWxNYXBwaW5nID0gZmll\nbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAgICBPYmplY3Qgb2lkID0gbnVs\nbDsKICAgICAgICBpZiAocmVsTWFwcGluZy5pc01hcHBlZCgpKSB7CiAgICAg\nICAgICAgIG9pZCA9IHJlbE1hcHBpbmcuZ2V0T2JqZWN0SWQoc3RvcmUsIHJl\ncywgZmllbGQuZ2V0Rm9yZWlnbktleSgpLAogICAgICAgICAgICAgICAgZmll\nbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1hcHBpbmcuUE9MWV9GQUxT\nRSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgQ29sdW1u\nW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAgICAgaWYg\nKHJlbE1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5n\nLklEX0RBVEFTVE9SRSkgewogICAgICAgICAgICAgICAgbG9uZyBpZCA9IHJl\ncy5nZXRMb25nKGNvbHNbMF0pOwogICAgICAgICAgICAgICAgaWYgKCFyZXMu\nd2FzTnVsbCgpKQogICAgICAgICAgICAgICAgICAgIG9pZCA9IHN0b3JlLm5l\nd0RhdGFTdG9yZUlkKGlkLCByZWxNYXBwaW5nLCB0cnVlKTsKICAgICAgICAg\nICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAgICAvLyBhcHBsaWNhdGlvbiBp\nZAogICAgICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3RoID09IDEpIHsKICAg\nICAgICAgICAgICAgICAgICBPYmplY3QgdmFsID0gcmVzLmdldE9iamVjdChj\nb2xzWzBdLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICBpZiAo\ndmFsICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgIG9pZCA9IEFw\ncGxpY2F0aW9uSWRzLmZyb21QS1ZhbHVlcyhuZXcgT2JqZWN0W117IHZhbCB9\nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsTWFwcGluZyk7CiAg\nICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIE9i\namVjdFtdIHZhbHMgPSBuZXcgT2JqZWN0W2NvbHMubGVuZ3RoXTsKICAgICAg\nICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGNvbHMubGVuZ3Ro\nOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsc1tpXSA9IHJl\ncy5nZXRPYmplY3QoY29sc1tpXSwgbnVsbCwgbnVsbCk7CiAgICAgICAgICAg\nICAgICAgICAgICAgIGlmICh2YWxzW2ldID09IG51bGwpCiAgICAgICAgICAg\nICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAg\nICAgaWYgKGkgPT0gY29scy5sZW5ndGggLSAxKQogICAgICAgICAgICAgICAg\nICAgICAgICAgICAgb2lkID0gQXBwbGljYXRpb25JZHMuZnJvbVBLVmFsdWVz\nKHZhbHMsIHJlbE1hcHBpbmcpOwogICAgICAgICAgICAgICAgICAgIH0KICAg\nICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAg\nICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAgICAgICBzbS5zdG9yZU9iamVj\ndChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsKICAgICAgICBlbHNlCiAgICAg\nICAgICAgIHNtLnNldEludGVybWVkaWF0ZShmaWVsZC5nZXRJbmRleCgpLCBv\naWQpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxvYWQoZmluYWwgT3BlbkpQ\nQVN0YXRlTWFuYWdlciBzbSwgZmluYWwgSkRCQ1N0b3JlIHN0b3JlLAogICAg\nICAgIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gpCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gY2hlY2sgZm9y\nIGNhY2hlZCBvaWQgdmFsdWUsIG9yIGxvYWQgb2lkIGlmIG5vIHdheSB0byBq\nb2luCiAgICAgICAgaWYgKEJvb2xlYW4uVFJVRS5lcXVhbHMoX2ZrT2lkKSkg\newogICAgICAgICAgICBPYmplY3Qgb2lkID0gc20uZ2V0SW50ZXJtZWRpYXRl\nKGZpZWxkLmdldEluZGV4KCkpOwogICAgICAgICAgICBpZiAob2lkICE9IG51\nbGwpIHsKICAgICAgICAgICAgICAgIE9iamVjdCB2YWwgPSBzdG9yZS5maW5k\nKG9pZCwgZmllbGQsIGZldGNoKTsKICAgICAgICAgICAgICAgIHNtLnN0b3Jl\nT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHZhbCk7CiAgICAgICAgICAgICAg\nICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZp\nbmFsIENsYXNzTWFwcGluZ1tdIHJlbHMgPSBmaWVsZC5nZXRJbmRlcGVuZGVu\ndFR5cGVNYXBwaW5ncygpOwogICAgICAgIGZpbmFsIGludCBzdWJzID0gZmll\nbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpOwogICAgICAgIGZpbmFsIEpvaW5z\nW10gcmVzSm9pbnMgPSBuZXcgSm9pbnNbcmVscy5sZW5ndGhdOwoKICAgICAg\nICAvL2NhY2hlIHVuaW9uIGZvciBmaWVsZCBoZXJlCiAgICAgICAgLy9zZWxl\nY3QgZGF0YSBmb3IgdGhpcyBzbQogICAgICAgIFVuaW9uIHVuaW9uID0gbnVs\nbDsKICAgICAgICBTZWxlY3RJbXBsIHNlbCA9IG51bGw7CiAgICAgICAgTGlz\ndCBwYXJtTGlzdCA9IG51bGw7CgogICAgICAgIGlmICghKChKREJDU3RvcmVN\nYW5hZ2VyKXN0b3JlKS5pc1F1ZXJ5U1FMQ2FjaGVPbigpKQogICAgICAgICAg\nICB1bmlvbiA9IG5ld1VuaW9uKHNtLCBzdG9yZSwgZmV0Y2gsIHJlbHMsIHN1\nYnMsIHJlc0pvaW5zKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgTWFw\nPEpEQkNTdG9yZU1hbmFnZXIuU2VsZWN0S2V5LCBPYmplY3RbXT4gcmVsYXRp\nb25GaWVsZFVuaW9uQ2FjaGUgPSAKICAgICAgICAgICAgICAgICgoSkRCQ1N0\nb3JlTWFuYWdlcilzdG9yZSkuZ2V0Q2FjaGVNYXBGcm9tUXVlcnlTUUxDYWNo\nZSgKICAgICAgICAgICAgICAgIFJlbGF0aW9uRmllbGRTdHJhdGVneS5jbGFz\ncyk7CiAgICAgICAgICAgIGJvb2xlYW4gZm91bmQgPSB0cnVlOwogICAgICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoQ2xvbmUgPSBuZXcg\nSkRCQ0ZldGNoQ29uZmlndXJhdGlvbkltcGwoKTsKICAgICAgICAgICAgZmV0\nY2hDbG9uZS5jb3B5KGZldGNoKTsKICAgICAgICAgICAgSkRCQ1N0b3JlTWFu\nYWdlci5TZWxlY3RLZXkgc2VsS2V5ID0gCiAgICAgICAgICAgICAgICBuZXcg\nSkRCQ1N0b3JlTWFuYWdlci5TZWxlY3RLZXkobnVsbCwgZmllbGQsIGZldGNo\nKTsKICAgICAgICAgICAgT2JqZWN0W10gb2JqID0gcmVsYXRpb25GaWVsZFVu\naW9uQ2FjaGUuZ2V0KHNlbEtleSk7CiAgICAgICAgICAgIGlmIChvYmogIT0g\nbnVsbCkgewogICAgICAgICAgICAgICAgdW5pb24gPSAoVW5pb24pIG9ialsw\nXTsKICAgICAgICAgICAgICAgIHJlc0pvaW5zWzBdID0gKEpvaW5zKW9ialsx\nXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bmNo\ncm9uaXplZChyZWxhdGlvbkZpZWxkVW5pb25DYWNoZSkgewogICAgICAgICAg\nICAgICAgICAgIG9iaiA9IHJlbGF0aW9uRmllbGRVbmlvbkNhY2hlLmdldChz\nZWxLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChvYmogIT0gbnVsbCkg\newogICAgICAgICAgICAgICAgICAgICAgICB1bmlvbiA9IChVbmlvbikgb2Jq\nWzBdOwogICAgICAgICAgICAgICAgICAgICAgICByZXNKb2luc1swXSA9IChK\nb2lucykgb2JqWzFdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAg\nICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbGVjdCByZWxhdGVkIG1hcHBp\nbmcgY29sdW1uczsgam9pbmluZyBmcm9tIHRoZSAKICAgICAgICAgICAgICAg\nICAgICAgICAgLy8gcmVsYXRlZCB0eXBlIGJhY2sgdG8gb3VyIGZrIHRhYmxl\nIGlmIG5vdCBhbiBpbnZlcnNlIAogICAgICAgICAgICAgICAgICAgICAgICAv\nLyBtYXBwaW5nIChpbiB3aGljaCBjYXNlIHdlIGNhbiBqdXN0IG1ha2Ugc3Vy\nZSB0aGUgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGludmVyc2UgY29s\ncyA9PSBvdXIgcGsgdmFsdWVzKQogICAgICAgICAgICAgICAgICAgICAgICB1\nbmlvbiA9IG5ld1VuaW9uKHNtLCBzdG9yZSwgZmV0Y2gsIHJlbHMsIHN1YnMs\nIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc0pvaW5zKTsK\nICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBmYWxzZTsgICAgICAg\nICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAg\nICAgICAgIHNlbCA9ICgoTG9naWNhbFVuaW9uLlVuaW9uU2VsZWN0KXVuaW9u\nLmdldFNlbGVjdHMoKVswXSkuCiAgICAgICAgICAgICAgICAgICAgICAgIGdl\ndERlbGVnYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgU1FMQnVmZmVyIGJ1\nZiA9IHNlbC5nZXRTUUwoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoYnVm\nID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAJKChTZWxlY3RJbXBs\nKXNlbCkuc2V0U1FMKHN0b3JlLCBmZXRjaCk7CiAgICAgICAgICAgICAgICAg\nICAgICAgIGZvdW5kID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoK\nICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGNhY2hlIHRoZSB1bmlvbiB3\naGVuIGVsZW1zIGxlbmd0aCBpcyAxIGZvciBub3cKICAgICAgICAgICAgICAg\nICAgICBpZiAoIWZvdW5kICYmIHJlbHMubGVuZ3RoID09IDEpIHsKICAgICAg\nICAgICAgICAgICAgICAgICAgT2JqZWN0W10gb2JqMSA9IG5ldyBPYmplY3Rb\nMl07CiAgICAgICAgICAgICAgICAgICAgICAgIG9iajFbMF0gPSB1bmlvbjsK\nICAgICAgICAgICAgICAgICAgICAgICAgb2JqMVsxXSA9IHJlc0pvaW5zWzBd\nOwogICAgICAgICAgICAgICAgICAgICAgICAoKEpEQkNTdG9yZU1hbmFnZXIp\nc3RvcmUpLmFkZFRvU3FsQ2FjaGUoCiAgICAgICAgICAgICAgICAgICAgICAg\nICAgICByZWxhdGlvbkZpZWxkVW5pb25DYWNoZSwgc2VsS2V5LCBvYmoxKTsK\nICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAg\nICAgICAgIH0KICAgICAgICAgICAgTG9nIGxvZyA9IHN0b3JlLmdldENvbmZp\nZ3VyYXRpb24oKS4KICAgICAgICAgICAgICAgIGdldExvZyhKREJDQ29uZmln\ndXJhdGlvbi5MT0dfSkRCQyk7CiAgICAgICAgICAgIGlmIChsb2cuaXNUcmFj\nZUVuYWJsZWQoKSl7CiAgICAgICAgICAgICAgICBpZiAoZm91bmQpIAogICAg\nICAgICAgICAgICAgICAgIGxvZy50cmFjZShfbG9jLmdldCgiY2FjaGUtaGl0\nIiwgZmllbGQsIHRoaXMuZ2V0Q2xhc3MoKSkpOyAgICAgICAgICAgICAgICAg\nICAgICAgIAogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAg\nICAgIGxvZy50cmFjZShfbG9jLmdldCgiY2FjaGUtbWlzc2VkIiwgZmllbGQs\nIHRoaXMuZ2V0Q2xhc3MoKSkpOwogICAgICAgICAgICB9CgogICAgICAgICAg\nICBwYXJtTGlzdCA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICAgICAgQ2xh\nc3NNYXBwaW5nIG1hcHBpbmcgPSBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmco\nKTsKICAgICAgICAgICAgT2JqZWN0IG9pZCA9IHNtLmdldE9iamVjdElkKCk7\nCiAgICAgICAgICAgIENvbHVtbltdIGNvbHMgPSBtYXBwaW5nLmdldFByaW1h\ncnlLZXlDb2x1bW5zKCk7CiAgICAgICAgICAgIGlmIChzZWwgPT0gbnVsbCkK\nICAgICAgICAgICAgICAgIHNlbCA9ICgoTG9naWNhbFVuaW9uLlVuaW9uU2Vs\nZWN0KXVuaW9uLmdldFNlbGVjdHMoKVswXSkuCiAgICAgICAgICAgICAgICBn\nZXREZWxlZ2F0ZSgpOwoKICAgICAgICAgICAgc2VsLndoZXJlUHJpbWFyeUtl\neShtYXBwaW5nLCBjb2xzLCBjb2xzLCBvaWQsIHN0b3JlLCAKICAgICAgICAg\nICAgCW51bGwsIG51bGwsIHBhcm1MaXN0KTsKICAgICAgICB9CiAgICAgICAg\nCiAgICAgICAgUmVzdWx0IHJlcyA9IHVuaW9uLmV4ZWN1dGUoc3RvcmUsIGZl\ndGNoLCBwYXJtTGlzdCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgT2Jq\nZWN0IHZhbCA9IG51bGw7CiAgICAgICAgICAgIGlmIChyZXMubmV4dCgpKQog\nICAgICAgICAgICAgICAgdmFsID0gcmVzLmxvYWQocmVsc1tyZXMuaW5kZXhP\nZigpXSwgc3RvcmUsIGZldGNoLAogICAgICAgICAgICAgICAgICAgIHJlc0pv\naW5zW3Jlcy5pbmRleE9mKCldKTsKICAgICAgICAgICAgc20uc3RvcmVPYmpl\nY3QoZmllbGQuZ2V0SW5kZXgoKSwgdmFsKTsKICAgICAgICB9IGZpbmFsbHkg\newogICAgICAgICAgICByZXMuY2xvc2UoKTsKICAgICAgICB9CiAgICB9CiAg\nICAKICAgIHByb3RlY3RlZCBVbmlvbiBuZXdVbmlvbihmaW5hbCBPcGVuSlBB\nU3RhdGVNYW5hZ2VyIHNtLCAKICAgICAgICBmaW5hbCBKREJDU3RvcmUgc3Rv\ncmUsIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIAogICAg\nICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIHJlbHMsIGZpbmFsIGludCBzdWJz\nLCAKICAgICAgICBmaW5hbCBKb2luc1tdIHJlc0pvaW5zKSB7CiAgICAgICAg\nVW5pb24gdW5pb24gPSBzdG9yZS5nZXRTUUxGYWN0b3J5KCkubmV3VW5pb24o\ncmVscy5sZW5ndGgpOwogICAgICAgIHVuaW9uLnNldEV4cGVjdGVkUmVzdWx0\nQ291bnQoMSwgZmFsc2UpOwogICAgICAgIGlmIChmZXRjaC5nZXRTdWJjbGFz\nc0ZldGNoTW9kZShmaWVsZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAgICAg\nICAhPSBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4pCiAgICAg\nICAgICAgIHVuaW9uLmFib3J0VW5pb24oKTsKICAgICAgICB1bmlvbi5zZWxl\nY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkgewogICAgICAgICAgICBwdWJsaWMg\ndm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwgaW50IGlkeCkgewogICAgICAgICAg\nICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5K\nT0lOX0lOVkVSU0UpCiAgICAgICAgICAgICAgICAgICAgc2VsLndoZXJlRm9y\nZWlnbktleShmaWVsZC5nZXRGb3JlaWduS2V5KHJlbHNbaWR4XSksCiAgICAg\nICAgICAgICAgICAgICAgICAgIHNtLmdldE9iamVjdElkKCksIGZpZWxkLmdl\ndERlZmluaW5nTWFwcGluZygpLCBzdG9yZSk7CiAgICAgICAgICAgICAgICBl\nbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXNKb2luc1tpZHhdID0gc2Vs\nLm5ld0pvaW5zKCkuam9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwKICAg\nICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0Rm9yZWlnbktleShyZWxz\nW2lkeF0pLCByZWxzW2lkeF0sCiAgICAgICAgICAgICAgICAgICAgICAgIGZp\nZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgZmFsc2UsIGZhbHNlKTsKICAg\nICAgICAgICAgICAgICAgICBmaWVsZC53aGVyZVByaW1hcnlLZXkoc2VsLCBz\nbSwgc3RvcmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAg\nc2VsLnNlbGVjdChyZWxzW2lkeF0sIHN1YnMsIHN0b3JlLCBmZXRjaCwgZmV0\nY2guRUFHRVJfSk9JTiwgCiAgICAgICAgICAgICAgICAgICAgcmVzSm9pbnNb\naWR4XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1\ncm4gdW5pb247CiAgICB9CgogICAgcHVibGljIE9iamVjdCB0b0RhdGFTdG9y\nZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9yZSBzdG9yZSkgewogICAgICAg\nIHJldHVybiBSZWxhdGlvblN0cmF0ZWdpZXMudG9EYXRhU3RvcmVWYWx1ZShm\naWVsZCwgdmFsLCBzdG9yZSk7CiAgICB9CgogICAgcHVibGljIHZvaWQgYXBw\nZW5kSXNOdWxsKFNRTEJ1ZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpv\naW5zKSB7CiAgICAgICAgLy8gaWYgbm8gaW52ZXJzZSwganVzdCBqb2luIHRv\nIG1hcHBpbmcncyB0YWJsZSAodXN1YWxseSBhIG5vLW9wCiAgICAgICAgLy8g\nYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUgcHJpbWFyeSB0YWJsZSkgYW5kIHNl\nZSBpZiBmayBjb2xzIGFyZSBudWxsOwogICAgICAgIC8vIGlmIGludmVyc2Us\nIHRoZW4gd2UgaGF2ZSB0byBkbyBhIHN1Yi1zZWxlY3QgdG8gc2VlIGlmIGFu\neSBpbnZlcnNlCiAgICAgICAgLy8gb2JqZWN0cyBwb2ludCBiYWNrIHRvIHRo\naXMgZmllbGQncyBvd25lcgogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7CiAgICAgICAgICAg\nIC8vIyMjIHByb2JhYmx5IG5lZWQgc29tZSBzb3J0IG9mIHN1YnNlbGVjdCBo\nZXJlIG9uIGZrIGNvbnN0YW50cwogICAgICAgICAgICBqb2lucyA9IGpvaW4o\nam9pbnMsIGZhbHNlKTsKICAgICAgICAgICAgQ29sdW1uW10gY29scyA9IGZp\nZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3Ro\nID09IDApCiAgICAgICAgICAgICAgICBzcWwuYXBwZW5kKCIxIDw+IDEiKTsK\nICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgc3FsLmFwcGVuZChz\nZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwgam9pbnMpKS4KICAgICAgICAg\nICAgICAgICAgICBhcHBlbmQoIiBJUyAiKS5hcHBlbmRWYWx1ZShudWxsLCBj\nb2xzWzBdKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgdGVzdEludmVy\nc2VOdWxsKHNxbCwgc2VsLCBqb2lucywgdHJ1ZSk7CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgYXBwZW5kSXNOb3ROdWxsKFNRTEJ1ZmZlciBzcWwsIFNlbGVj\ndCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAgLy8gaWYgbm8gaW52ZXJz\nZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0YWJsZSAodXN1YWxseSBhIG5v\nLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUgcHJpbWFy\neSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xzIGFyZW4ndAogICAgICAgIC8v\nIG51bGw7IGlmIGludmVyc2UsIHRoZW4gd2UgaGF2ZSB0byBkbyBhIHN1Yi1z\nZWxlY3QgdG8gc2VlIGlmIGFueQogICAgICAgIC8vIGludmVyc2Ugb2JqZWN0\ncyBwb2ludCBiYWNrIHRvIHRoaXMgZmllbGQncyBvd25lcgogICAgICAgIGlm\nIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9JTlZF\nUlNFKSB7CiAgICAgICAgICAgIC8vIyMjIHByb2JhYmx5IG5lZWQgc29tZSBz\nb3J0IG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZrIGNvbnN0YW50cwogICAgICAg\nICAgICBqb2lucyA9IGpvaW4oam9pbnMsIGZhbHNlKTsKICAgICAgICAgICAg\nQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAg\nICAgaWYgKGNvbHMubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICBzcWwu\nYXBwZW5kKCIxID0gMSIpOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAg\nICAgICBzcWwuYXBwZW5kKHNlbC5nZXRDb2x1bW5BbGlhcyhjb2xzWzBdLCBq\nb2lucykpLgogICAgICAgICAgICAgICAgICAgIGFwcGVuZCgiIElTIE5PVCAi\nKS5hcHBlbmRWYWx1ZShudWxsLCBjb2xzWzBdKTsKICAgICAgICB9IGVsc2UK\nICAgICAgICAgICAgdGVzdEludmVyc2VOdWxsKHNxbCwgc2VsLCBqb2lucywg\nZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQXBwZW5kIFNRTCBmb3Ig\nYSBzdWItc2VsZWN0IHRlc3Rpbmcgd2hldGhlciBhbiBpbnZlcnNlIG9iamVj\ndCBleGlzdHMKICAgICAqIGZvciB0aGlzIHJlbGF0aW9uLgogICAgICovCiAg\nICBwcml2YXRlIHZvaWQgdGVzdEludmVyc2VOdWxsKFNRTEJ1ZmZlciBzcWws\nIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zLAogICAgICAgIGJvb2xlYW4gZW1w\ndHkpIHsKICAgICAgICBEQkRpY3Rpb25hcnkgZGljdCA9IGZpZWxkLmdldE1h\ncHBpbmdSZXBvc2l0b3J5KCkuZ2V0REJEaWN0aW9uYXJ5KCk7CiAgICAgICAg\nZGljdC5hc3NlcnRTdXBwb3J0KGRpY3Quc3VwcG9ydHNTdWJzZWxlY3QsICJT\ndXBwb3J0c1N1YnNlbGVjdCIpOwoKICAgICAgICBpZiAoZmllbGQuZ2V0SW5k\nZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5ndGggIT0gMSkKICAgICAgICAg\nICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJzYWJsZShmaWVs\nZCk7CgogICAgICAgIGlmIChlbXB0eSkKICAgICAgICAgICAgc3FsLmFwcGVu\nZCgiMCA9ICIpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgc3FsLmFwcGVu\nZCgiMCA8ICIpOwoKICAgICAgICBGb3JlaWduS2V5IGZrID0gZmllbGQuZ2V0\nRm9yZWlnbktleSgpOwogICAgICAgIENvbnRhaW5lckZpZWxkU3RyYXRlZ3ku\nYXBwZW5kSm9pbkNvdW50KHNxbCwgc2VsLCBqb2lucywgZGljdCwgZmllbGQs\nCiAgICAgICAgICAgIGZrKTsKICAgIH0KCiAgICBwdWJsaWMgSm9pbnMgam9p\nbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3JjZU91dGVyKSB7CiAgICAgICAg\nLy8gaWYgd2UncmUgbm90IGluIGFuIGludmVyc2Ugb2JqZWN0IHRhYmxlIGpv\naW4gbm9ybWFsbHksIG90aGVyd2lzZQogICAgICAgIC8vIGFscmVhZHkgdHJh\ndmVyc2VkIHRoZSByZWxhdGlvbjsganVzdCBqb2luIGJhY2sgdG8gb3duZXIg\ndGFibGUKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpICE9\nIGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJuIGZpZWxk\nLmpvaW4oam9pbnMsIGZvcmNlT3V0ZXIsIGZhbHNlKTsKICAgICAgICBDbGFz\nc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFw\ncGluZ3MoKTsKICAgICAgICBpZiAoY2xzcy5sZW5ndGggIT0gMSkKICAgICAg\nICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJzYWJsZShm\naWVsZCk7CiAgICAgICAgaWYgKGZvcmNlT3V0ZXIpCiAgICAgICAgICAgIHJl\ndHVybiBqb2lucy5vdXRlckpvaW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCks\nCiAgICAgICAgICAgICAgICBmaWVsZC5nZXRGb3JlaWduS2V5KCksIGNsc3Nb\nMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgCiAgICAgICAgICAg\nICAgICB0cnVlLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIGpvaW5zLmpvaW5S\nZWxhdGlvbihmaWVsZC5nZXROYW1lKCksIGZpZWxkLmdldEZvcmVpZ25LZXko\nKSwKICAgICAgICAgICAgY2xzc1swXSwgZmllbGQuZ2V0U2VsZWN0U3ViY2xh\nc3NlcygpLCB0cnVlLCBmYWxzZSk7CiAgICB9CgogICAgcHVibGljIEpvaW5z\nIGpvaW5SZWxhdGlvbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3JjZU91dGVy\nLAogICAgICAgIGJvb2xlYW4gdHJhdmVyc2UpIHsKICAgICAgICAvLyBpZiB0\naGlzIGlzIGFuIGludmVyc2UgbWFwcGluZyBpdCdzIGFscmVhZHkgam9pbmVk\nIHRvIHRoZSByZWxhdGlvbgogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnM7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xzcyA9IGZp\nZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAgaWYg\nKGNsc3MubGVuZ3RoICE9IDEpIHsKICAgICAgICAgICAgaWYgKHRyYXZlcnNl\nKQogICAgICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVu\nam9pbmFibGUoZmllbGQpOwogICAgICAgICAgICByZXR1cm4gam9pbnM7CiAg\nICAgICAgfQoKICAgICAgICBqb2lucyA9IHNldEVtYmVkZGVkVmFyaWFibGUo\nam9pbnMpOwogICAgICAgIGlmIChmb3JjZU91dGVyKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgp\nLCAKICAgICAgICAgICAgICAgIGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzc1sw\nXSksIGNsc3NbMF0sIAogICAgICAgICAgICAgICAgZmllbGQuZ2V0U2VsZWN0\nU3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwogICAgICAgIHJldHVybiBq\nb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLCBmaWVsZC5nZXRG\nb3JlaWduS2V5KGNsc3NbMF0pLAogICAgICAgICAgICBjbHNzWzBdLCBmaWVs\nZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7CiAgICB9\nCgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBKb2lu\nYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vCgogICAgcHVibGljIGludCBnZXRGaWVsZEluZGV4KCkgewogICAg\nICAgIHJldHVybiBmaWVsZC5nZXRJbmRleCgpOwogICAgfQoKICAgIHB1Ymxp\nYyBPYmplY3QgZ2V0UHJpbWFyeUtleVZhbHVlKFJlc3VsdCByZXMsIENvbHVt\nbltdIGNvbHMsIEZvcmVpZ25LZXkgZmssCiAgICAgICAgSkRCQ1N0b3JlIHN0\nb3JlLCBKb2lucyBqb2lucykKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9u\nIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVsbWFwcGluZyA9IGZpZWxkLmdl\ndFR5cGVNYXBwaW5nKCk7CiAgICAgICAgaWYgKHJlbG1hcHBpbmcuZ2V0SWRl\nbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5nLklEX0RBVEFTVE9SRSkgewog\nICAgICAgICAgICBDb2x1bW4gY29sID0gY29sc1swXTsKICAgICAgICAgICAg\naWYgKGZrICE9IG51bGwpCiAgICAgICAgICAgICAgICBjb2wgPSBmay5nZXRD\nb2x1bW4oY29sKTsgICAKICAgICAgICAgICAgbG9uZyBpZCA9IHJlcy5nZXRM\nb25nKGNvbCwgam9pbnMpOwogICAgICAgICAgICBpZiAoZmllbGQuZ2V0T2Jq\nZWN0SWRGaWVsZFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLkxPTkcpCiAgICAg\nICAgICAgICAgICByZXR1cm4gTnVtYmVycy52YWx1ZU9mKGlkKTsKICAgICAg\nICAgICAgcmV0dXJuIHN0b3JlLm5ld0RhdGFTdG9yZUlkKGlkLCByZWxtYXBw\naW5nLCBmaWVsZC5nZXRQb2x5bW9ycGhpYygpIAogICAgICAgICAgICAgICAg\nIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0UpOwogICAgICAgIH0KCiAgICAg\nICAgaWYgKHJlbG1hcHBpbmcuaXNPcGVuSlBBSWRlbnRpdHkoKSkKICAgICAg\nICAgICAgcmV0dXJuICgoSm9pbmFibGUpIHJlbG1hcHBpbmcuZ2V0UHJpbWFy\neUtleUZpZWxkTWFwcGluZ3MoKVswXS4KICAgICAgICAgICAgICAgIGdldFN0\ncmF0ZWd5KCkpLmdldFByaW1hcnlLZXlWYWx1ZShyZXMsIGNvbHMsIGZrLCBz\ndG9yZSwgam9pbnMpOwoKICAgICAgICBpZiAoY29scyA9PSBnZXRDb2x1bW5z\nKCkgJiYgZmsgPT0gbnVsbCkKICAgICAgICAgICAgZmsgPSBmaWVsZC5nZXRG\nb3JlaWduS2V5KCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICBmayA9IGNy\nZWF0ZVRyYW5zbGF0aW5nRm9yZWlnbktleShyZWxtYXBwaW5nLCBjb2xzLCBm\nayk7IAogICAgICAgIHJldHVybiByZWxtYXBwaW5nLmdldE9iamVjdElkKHN0\nb3JlLCByZXMsIGZrLAogICAgICAgICAgICBmaWVsZC5nZXRQb2x5bW9ycGhp\nYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFLCBqb2lucyk7CiAgICB9\nCgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBmYXV4IGZvcmVpZ24ga2V5IHRo\nYXQgdHJhbnNsYXRlcyBiZXR3ZWVuIHRoZSBjb2x1bW5zIHRvIHB1bGwKICAg\nICAqIHRoZSBkYXRhIGZyb20gYW5kIG91ciByZWxhdGVkIHR5cGUncyBwcmlt\nYXJ5IGtleSBjb2x1bW5zLgogICAgICovCiAgICBwcml2YXRlIEZvcmVpZ25L\nZXkgY3JlYXRlVHJhbnNsYXRpbmdGb3JlaWduS2V5KENsYXNzTWFwcGluZyBy\nZWxtYXBwaW5nLAogICAgICAgIENvbHVtbltdIGdjb2xzLCBGb3JlaWduS2V5\nIGdmaykgewogICAgICAgIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5nZXRGb3Jl\naWduS2V5KCk7IAogICAgICAgIENvbHVtbltdIGNvbHMgPSBmay5nZXRDb2x1\nbW5zKCk7CgogICAgICAgIEZvcmVpZ25LZXkgdGZrID0gbnVsbDsKICAgICAg\nICBDb2x1bW4gdGNvbDsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGdj\nb2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRjb2wgPSBnY29sc1tp\nXTsKICAgICAgICAgICAgaWYgKGdmayAhPSBudWxsKQogICAgICAgICAgICAg\nICAgdGNvbCA9IGdmay5nZXRDb2x1bW4odGNvbCk7CiAgICAgICAgICAgIGlm\nICh0ZmsgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRmayA9IG5ldyBGb3Jl\naWduS2V5KG51bGwsIHRjb2wuZ2V0VGFibGUoKSk7CiAgICAgICAgICAgIHRm\nay5qb2luKHRjb2wsIGZrLmdldFByaW1hcnlLZXlDb2x1bW4oY29sc1tpXSkp\nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGZrOwogICAgfQoKICAgIHB1\nYmxpYyBPYmplY3QgZ2V0Sm9pblZhbHVlKE9iamVjdCBmaWVsZFZhbCwgQ29s\ndW1uIGNvbCwgSkRCQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgT2JqZWN0IG8g\nPSBmaWVsZC5nZXRGb3JlaWduS2V5KCkuZ2V0Q29uc3RhbnQoY29sKTsKICAg\nICAgICBpZiAobyAhPSBudWxsKQogICAgICAgICAgICByZXR1cm4gbzsKICAg\nICAgICBjb2wgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCkuZ2V0UHJpbWFyeUtl\neUNvbHVtbihjb2wpOwogICAgICAgIGlmIChjb2wgPT0gbnVsbCkKICAgICAg\nICAgICAgdGhyb3cgbmV3IEludGVybmFsRXhjZXB0aW9uKCk7CgogICAgICAg\nIENsYXNzTWFwcGluZyByZWxtYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBp\nbmcoKTsKICAgICAgICBKb2luYWJsZSBqID0gZmllbGQuZ2V0VHlwZU1hcHBp\nbmcoKS5hc3NlcnRKb2luYWJsZShjb2wpOwogICAgICAgIGlmIChJbXBsSGVs\ncGVyLmlzTWFuYWdlYWJsZShmaWVsZFZhbCkpCiAgICAgICAgICAgIGZpZWxk\nVmFsID0gc3RvcmUuZ2V0Q29udGV4dCgpLmdldE9iamVjdElkKGZpZWxkVmFs\nKTsKICAgICAgICBpZiAoZmllbGRWYWwgaW5zdGFuY2VvZiBPcGVuSlBBSWQp\nCiAgICAgICAgICAgIGZpZWxkVmFsID0gKChPcGVuSlBBSWQpIGZpZWxkVmFs\nKS5nZXRJZE9iamVjdCgpOwogICAgICAgIGlmIChyZWxtYXBwaW5nLmdldE9i\namVjdElkVHlwZSgpICE9IG51bGwKICAgICAgICAgICAgJiYgcmVsbWFwcGlu\nZy5nZXRPYmplY3RJZFR5cGUoKS5pc0luc3RhbmNlKGZpZWxkVmFsKSkgewog\nICAgICAgICAgICBPYmplY3RbXSBwa3MgPSBBcHBsaWNhdGlvbklkcy50b1BL\nVmFsdWVzKGZpZWxkVmFsLCByZWxtYXBwaW5nKTsKICAgICAgICAgICAgZmll\nbGRWYWwgPSBwa3NbcmVsbWFwcGluZy5nZXRGaWVsZChqLmdldEZpZWxkSW5k\nZXgoKSkuCiAgICAgICAgICAgICAgICBnZXRQcmltYXJ5S2V5SW5kZXgoKV07\nCiAgICAgICAgfQogICAgICAgIHJldHVybiBqLmdldEpvaW5WYWx1ZShmaWVs\nZFZhbCwgY29sLCBzdG9yZSk7CiAgICB9CgogICAgcHVibGljIE9iamVjdCBn\nZXRKb2luVmFsdWUoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgQ29sdW1uIGNv\nbCwKICAgICAgICBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICByZXR1cm4g\nZ2V0Sm9pblZhbHVlKHNtLmZldGNoKGZpZWxkLmdldEluZGV4KCkpLCBjb2ws\nIHN0b3JlKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBzZXRBdXRvQXNzaWdu\nZWRWYWx1ZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3Rv\ncmUsCiAgICAgICAgQ29sdW1uIGNvbCwgT2JqZWN0IGF1dG9JbmMpIHsKICAg\nICAgICB0aHJvdyBuZXcgVW5zdXBwb3J0ZWRFeGNlcHRpb24oKTsKICAgIH0K\nCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gRW1i\nZWRkYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vLy8vLy8KCiAgICBwdWJsaWMgQ29sdW1uW10gZ2V0Q29sdW1ucygp\nIHsKICAgICAgICByZXR1cm4gZmllbGQuZ2V0Q29sdW1ucygpOwogICAgfQoK\nICAgIHB1YmxpYyBDb2x1bW5JTyBnZXRDb2x1bW5JTygpIHsKICAgICAgICBy\nZXR1cm4gZmllbGQuZ2V0Q29sdW1uSU8oKTsKICAgIH0KCiAgICBwdWJsaWMg\nT2JqZWN0W10gZ2V0UmVzdWx0QXJndW1lbnRzKCkgewogICAgICAgIHJldHVy\nbiBudWxsOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9FbWJlZGRlZERh\ndGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9yZSBzdG9yZSkgewog\nICAgICAgIHJldHVybiB0b0RhdGFTdG9yZVZhbHVlKHZhbCwgc3RvcmUpOwog\nICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9FbWJlZGRlZE9iamVjdFZhbHVl\nKE9iamVjdCB2YWwpIHsKICAgICAgICByZXR1cm4gVU5TVVBQT1JURUQ7CiAg\nICB9CgogICAgcHVibGljIHZvaWQgbG9hZEVtYmVkZGVkKE9wZW5KUEFTdGF0\nZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBKREJDRmV0\nY2hDb25maWd1cmF0aW9uIGZldGNoLCBPYmplY3QgdmFsKQogICAgICAgIHRo\ncm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIENsYXNzTWFwcGluZyByZWxN\nYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAgICBPYmpl\nY3Qgb2lkOwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkKICAgICAgICAgICAg\nb2lkID0gbnVsbDsKICAgICAgICBlbHNlIGlmIChyZWxNYXBwaW5nLmdldElk\nZW50aXR5VHlwZSgpID09IENsYXNzTWFwcGluZy5JRF9EQVRBU1RPUkUpCiAg\nICAgICAgICAgIG9pZCA9IHN0b3JlLm5ld0RhdGFTdG9yZUlkKCgoTnVtYmVy\nKSB2YWwpLmxvbmdWYWx1ZSgpLCByZWxNYXBwaW5nLAogICAgICAgICAgICAg\nICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1hcHBpbmcuUE9M\nWV9GQUxTRSk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIE9iamVjdFtd\nIHBrcyA9IChnZXRDb2x1bW5zKCkubGVuZ3RoID09IDEpID8gbmV3IE9iamVj\ndFtdeyB2YWwgfQogICAgICAgICAgICAgICAgOiAoT2JqZWN0W10pIHZhbDsK\nICAgICAgICAgICAgYm9vbGVhbiBudWxscyA9IHRydWU7CiAgICAgICAgICAg\nIGZvciAoaW50IGkgPSAwOyBudWxscyAmJiBpIDwgcGtzLmxlbmd0aDsgaSsr\nKQogICAgICAgICAgICAgICAgbnVsbHMgPSBwa3NbaV0gPT0gbnVsbDsKICAg\nICAgICAgICAgaWYgKG51bGxzKQogICAgICAgICAgICAgICAgb2lkID0gbnVs\nbDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBvaWQgPSBB\ncHBsaWNhdGlvbklkcy5mcm9tUEtWYWx1ZXMocGtzLCByZWxNYXBwaW5nKTsK\nICAgICAgICAgICAgICAgIGlmIChmaWVsZC5nZXRQb2x5bW9ycGhpYygpID09\nIFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFCiAgICAgICAgICAgICAgICAgICAg\nJiYgb2lkIGluc3RhbmNlb2YgT3BlbkpQQUlkKSB7CiAgICAgICAgICAgICAg\nICAgICAgKChPcGVuSlBBSWQpIG9pZCkuc2V0TWFuYWdlZEluc3RhbmNlVHlw\nZShyZWxNYXBwaW5nLgogICAgICAgICAgICAgICAgICAgICAgICBnZXREZXNj\ncmliZWRUeXBlKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9\nCiAgICAgICAgfQoKICAgICAgICBpZiAob2lkID09IG51bGwpCiAgICAgICAg\nICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIG51bGwpOwog\nICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoSmF2YVR5cGVzLm1heWJl\nUEMoZmllbGQuZ2V0VmFsdWUoKSkgJiYKICAgICAgICAgICAgICAgICFmaWVs\nZC5nZXRWYWx1ZSgpLmdldERlY2xhcmVkVHlwZU1ldGFEYXRhKCkuaXNFbWJl\nZGRlZE9ubHkoKSkgewogICAgICAgICAgICAgICAgT2JqZWN0IG9iaiA9IHN0\nb3JlLmZpbmQob2lkLCBmaWVsZCwgZmV0Y2gpOwogICAgICAgICAgICAgICAg\nc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgb2JqKTsKICAgICAg\nICAgICAgfSBlbHNlICAgIAogICAgICAgICAgICAgICAgc20uc2V0SW50ZXJt\nZWRpYXRlKGZpZWxkLmdldEluZGV4KCksIG9pZCk7CiAgICAgICAgfQogICAg\nfQp9Cg==\n","encoding":"base64"}

