{"sha":"46d94180bee5cff6c38bad9bdf790033d017096d","node_id":"MDQ6QmxvYjIwNjM2NDo0NmQ5NDE4MGJlZTVjZmY2YzM4YmFkOWJkZjc5MDAzM2QwMTcwOTZk","size":45083,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/46d94180bee5cff6c38bad9bdf790033d017096d","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkNvbGxlY3Rpb25zOwpp\nbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9ydCBqYXZhLnV0aWwuTGlz\ndDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CmltcG9ydCBqYXZhLnV0aWwuU2V0\nOwoKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNlLlBlcnNpc3Rl\nbmNlQ2FwYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNl\nLlJlZmxlY3RpbmdQZXJzaXN0ZW5jZUNhcGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5pZGVudGlmaWVyLkRCSWRlbnRpZmllcjsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtlcm5lbC5KREJDRmV0Y2hD\nb25maWd1cmF0aW9uOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMu\na2VybmVsLkpEQkNTdG9yZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5q\nZGJjLm1ldGEuQ2xhc3NNYXBwaW5nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMubWV0YS5FbWJlZGRhYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLmpkYmMubWV0YS5GaWVsZE1hcHBpbmc7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLkZpZWxkU3RyYXRlZ3k7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLkpvaW5hYmxlOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5NYXBwaW5nSW5mbzsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuVmFsdWVIYW5kbGVy\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5WYWx1ZU1h\ncHBpbmc7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZh\nbHVlTWFwcGluZ0ltcGw7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRi\nYy5tZXRhLlZhbHVlTWFwcGluZ0luZm87CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zY2hlbWEuQ29sdW1uOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLmpkYmMuc2NoZW1hLkNvbHVtbklPOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc2NoZW1hLkZvcmVpZ25LZXk7CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hlbWEuUHJpbWFyeUtleTsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNjaGVtYS5UYWJsZTsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNxbC5EQkRpY3Rpb25hcnk7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuSm9pbnM7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuUmVzdWx0OwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc3FsLlJvdzsKaW1wb3J0IG9yZy5h\ncGFjaGUub3BlbmpwYS5qZGJjLnNxbC5Sb3dNYW5hZ2VyOwppbXBvcnQgb3Jn\nLmFwYWNoZS5vcGVuanBhLmpkYmMuc3FsLlNRTEJ1ZmZlcjsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNxbC5TZWxlY3Q7CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuU2VsZWN0RXhlY3V0b3I7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuVW5pb247CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEua2VybmVsLkxvY2tNYW5hZ2VyOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmtlcm5lbC5PcGVuSlBBU3RhdGVNYW5hZ2Vy\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmxpYi5sb2cuTG9nOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmxpYi51dGlsLkxvY2FsaXplcjsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5tZXRhLkNsYXNzTWV0YURhdGE7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEubWV0YS5GaWVsZE1ldGFEYXRhOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLm1ldGEuSmF2YVR5cGVzOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuQXBwbGljYXRpb25JZHM7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5JbXBsSGVscGVyOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuSW50ZXJuYWxFeGNlcHRpb247\nCmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5NZXRhRGF0YUV4Y2Vw\ndGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS51dGlsLk9iamVjdElk\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuT3BlbkpQQUlkOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuVW5zdXBwb3J0ZWRFeGNl\ncHRpb247CgoKLyoqCiAqIE1hcHBpbmcgZm9yIGEgc2luZ2xlLXZhbHVlZCBy\nZWxhdGlvbiB0byBhbm90aGVyIGVudGl0eS4KICoKICogQGF1dGhvciBBYmUg\nV2hpdGUKICogQHNpbmNlIDAuNC4wCiAqLwpwdWJsaWMgY2xhc3MgUmVsYXRp\nb25GaWVsZFN0cmF0ZWd5CiAgICBleHRlbmRzIEFic3RyYWN0RmllbGRTdHJh\ndGVneQogICAgaW1wbGVtZW50cyBKb2luYWJsZSwgRW1iZWRkYWJsZSB7Cgog\nICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTG9jYWxpemVyIF9sb2MgPSBMb2Nh\nbGl6ZXIuZm9yUGFja2FnZQogICAgICAgIChSZWxhdGlvbkZpZWxkU3RyYXRl\nZ3kuY2xhc3MpOwoKICAgIHByaXZhdGUgQm9vbGVhbiBfZmtPaWQgPSBudWxs\nOwogICAgCiAgICBwdWJsaWMgdm9pZCBtYXAoYm9vbGVhbiBhZGFwdCkgewog\nICAgICAgIGlmIChmaWVsZC5nZXRUeXBlQ29kZSgpICE9IEphdmFUeXBlcy5Q\nQyB8fCBmaWVsZC5pc0VtYmVkZGVkUEMoKSkKICAgICAgICAgICAgdGhyb3cg\nbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0KCJub3QtcmVsYXRpb24i\nLCBmaWVsZCkpOwoKICAgICAgICBmaWVsZC5nZXRLZXlNYXBwaW5nKCkuZ2V0\nVmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25lbnRzCiAgICAgICAg\nICAgIChmaWVsZC5nZXRLZXkoKSwgIWFkYXB0KTsKICAgICAgICBpZiAoIWZp\nZWxkLmlzTm9uRGVmYXVsdE1hcHBpbmdVc2luZ0pvaW5UYWJsZVN0cmF0ZWd5\nKCkpCiAgICAgICAgICAgIGZpZWxkLmdldEVsZW1lbnRNYXBwaW5nKCkuZ2V0\nVmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25lbnRzCiAgICAgICAg\nICAgICAgICAoZmllbGQuZ2V0RWxlbWVudCgpLCAhYWRhcHQpOwogICAgICAg\nIGJvb2xlYW4gY3JpdGVyaWEgPSBmaWVsZC5nZXRWYWx1ZUluZm8oKS5nZXRV\nc2VDbGFzc0NyaXRlcmlhKCk7CgogICAgICAgIC8vIGNoZWNrIGZvciBuYW1l\nZCBpbnZlcnNlCiAgICAgICAgRmllbGRNYXBwaW5nIG1hcHBlZCA9IGZpZWxk\nLmdldE1hcHBlZEJ5TWFwcGluZygpOwogICAgICAgIGlmIChtYXBwZWQgIT0g\nbnVsbCkgewogICAgICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmFz\nc2VydE5vU2NoZW1hQ29tcG9uZW50cyhmaWVsZCwgIWFkYXB0KTsKICAgICAg\nICAgICAgZmllbGQuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21w\nb25lbnRzKGZpZWxkLCAhYWRhcHQpOwogICAgICAgICAgICBtYXBwZWQucmVz\nb2x2ZShtYXBwZWQuTU9ERV9NRVRBIHwgbWFwcGVkLk1PREVfTUFQUElORyk7\nCgogICAgICAgICAgICBpZiAoIW1hcHBlZC5pc01hcHBlZCgpIHx8IG1hcHBl\nZC5pc1NlcmlhbGl6ZWQoKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBN\nZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdldCgibWFwcGVkLWJ5LXVubWFwcGVk\nIiwKICAgICAgICAgICAgICAgICAgICBmaWVsZCwgbWFwcGVkKSk7CgogICAg\nICAgICAgICBpZiAobWFwcGVkLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVz\nLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAobWFwcGVkLmdldEpvaW5EaXJl\nY3Rpb24oKSA9PSBtYXBwZWQuSk9JTl9GT1JXQVJEKSB7CiAgICAgICAgICAg\nICAgICAgICAgZmllbGQuc2V0Sm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lO\nVkVSU0UpOwogICAgICAgICAgICAgICAgICAgIGZpZWxkLnNldENvbHVtbnMo\nbWFwcGVkLmdldERlZmluaW5nTWFwcGluZygpLgogICAgICAgICAgICAgICAg\nICAgICAgICBnZXRQcmltYXJ5S2V5Q29sdW1ucygpKTsKICAgICAgICAgICAg\nICAgIH0gZWxzZSBpZiAoaXNUeXBlVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQp\nKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2Vw\ndGlvbihfbG9jLmdldAogICAgICAgICAgICAgICAgICAgICAgICAoIm1hcHBl\nZC1pbnZlcnNlLXVuam9pbmVkIiwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAg\nICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5n\nKCksIG1hcHBlZCkpOwoKICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVp\nZ25LZXkobWFwcGVkLmdldEZvcmVpZ25LZXkKICAgICAgICAgICAgICAgICAg\nICAoZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkpKTsKICAgICAgICAgICAg\nfSBlbHNlIGlmIChtYXBwZWQuZ2V0RWxlbWVudCgpLmdldFR5cGVDb2RlKCkg\nPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUeXBl\nVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQuZ2V0RWxlbWVudE1hcHBpbmcoKSkp\nCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0\naW9uKF9sb2MuZ2V0CiAgICAgICAgICAgICAgICAgICAgICAgICgibWFwcGVk\nLWludmVyc2UtdW5qb2luZWQiLCBmaWVsZC5nZXROYW1lKCksCiAgICAgICAg\nICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmco\nKSwgbWFwcGVkKSk7CgogICAgICAgICAgICAgICAgLy8gd2FybiB0aGUgdXNl\nciBhYm91dCBtYWtpbmcgdGhlIGNvbGxlY3Rpb24gc2lkZSB0aGUgb3duZXIK\nICAgICAgICAgICAgICAgIExvZyBsb2cgPSBmaWVsZC5nZXRSZXBvc2l0b3J5\nKCkuZ2V0TG9nKCk7CiAgICAgICAgICAgICAgICBpZiAobG9nLmlzSW5mb0Vu\nYWJsZWQoKSkKICAgICAgICAgICAgICAgICAgICBsb2cuaW5mbyhfbG9jLmdl\ndCgiY29sbC1vd25lciIsIGZpZWxkLCBtYXBwZWQpKTsKICAgICAgICAgICAg\nICAgIGZpZWxkLnNldEZvcmVpZ25LZXkobWFwcGVkLmdldEVsZW1lbnRNYXBw\naW5nKCkuCiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9yZWlnbktleSgpKTsK\nICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcg\nTWV0YURhdGFFeGNlcHRpb24oX2xvYy5nZXQoIm5vdC1pbnYtcmVsYXRpb24i\nLAogICAgICAgICAgICAgICAgICAgIGZpZWxkLCBtYXBwZWQpKTsKCiAgICAg\nICAgICAgIGZpZWxkLnNldFVzZUNsYXNzQ3JpdGVyaWEoY3JpdGVyaWEpOwog\nICAgICAgICAgICByZXR1cm47CiAgICAgICAgfSAKCiAgICAgICAgLy8gdGhp\ncyBpcyBuZWNlc3NhcnkgdG8gc3VwcG9ydCBvcGVuanBhIDMgbWFwcGluZ3Ms\nIHdoaWNoIGRpZG4ndAogICAgICAgIC8vIGRpZmZlcmVudGlhdGUgYmV0d2Vl\nbiBzZWNvbmRhcnkgdGFibGUgam9pbnMgYW5kIHJlbGF0aW9ucyBidWlsdAog\nICAgICAgIC8vIGFyb3VuZCBhbiBpbnZlcnNlIGtleTogY2hlY2sgdG8gc2Vl\nIGlmIHdlJ3JlIG1hcHBlZCBhcyBhIHNlY29uZGFyeQogICAgICAgIC8vIHRh\nYmxlIGpvaW4gYnV0IHdlJ3JlIGluIHRoZSB0YWJsZSBvZiB0aGUgcmVsYXRl\nZCB0eXBlLCBhbmQgaWYgc28KICAgICAgICAvLyBzd2l0Y2ggb3VyIGpvaW4g\nbWFwcGluZyBpbmZvIHRvIG91ciB2YWx1ZSBtYXBwaW5nIGluZm8KICAgICAg\nICBEQklkZW50aWZpZXIgdGFibGVOYW1lID0gZmllbGQuZ2V0TWFwcGluZ0lu\nZm8oKS5nZXRUYWJsZUlkZW50aWZpZXIoKTsKICAgICAgICBUYWJsZSB0YWJs\nZSA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCkuZ2V0VGFibGUoKTsKICAgICAg\nICBWYWx1ZU1hcHBpbmdJbmZvIHZpbmZvID0gZmllbGQuZ2V0VmFsdWVJbmZv\nKCk7CiAgICAgICAgaWYgKCFEQklkZW50aWZpZXIuaXNOdWxsKHRhYmxlTmFt\nZSkgJiYgdGFibGUgIT0gbnVsbAogICAgICAgICAgICAmJiAodGFibGVOYW1l\nLmVxdWFscyh0YWJsZS5nZXRJZGVudGlmaWVyKCkpCiAgICAgICAgICAgIHx8\nIHRhYmxlTmFtZS5lcXVhbHModGFibGUuZ2V0RnVsbElkZW50aWZpZXIoKSkp\nKSB7CiAgICAgICAgICAgIHZpbmZvLnNldEpvaW5EaXJlY3Rpb24oTWFwcGlu\nZ0luZm8uSk9JTl9JTlZFUlNFKTsKICAgICAgICAgICAgdmluZm8uc2V0Q29s\ndW1ucyhmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldENvbHVtbnMoKSk7CiAg\nICAgICAgICAgIGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuc2V0VGFibGVJZGVu\ndGlmaWVyKERCSWRlbnRpZmllci5OVUxMKTsKICAgICAgICAgICAgZmllbGQu\nZ2V0TWFwcGluZ0luZm8oKS5zZXRDb2x1bW5zKG51bGwpOwogICAgICAgIH0K\nICAgICAgICAKICAgICAgICBpZiAoIWZpZWxkLmlzQmlNVG8xSlQoKSkKICAg\nICAgICAgICAgZmllbGQubWFwSm9pbihhZGFwdCwgZmFsc2UpOwogICAgICAg\nIGlmIChmaWVsZC5nZXRUeXBlTWFwcGluZygpLmlzTWFwcGVkKCkpIHsKICAg\nICAgICAgICAgaWYgKGZpZWxkLmdldE1hcHBlZEJ5SWRWYWx1ZSgpICE9IG51\nbGwpIAogICAgICAgICAgICAgICAgc2V0TWFwcGVkQnlJZENvbHVtbnMoKTsg\nICAgICAgICAgICAKICAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWZp\nZWxkLmlzQmlNVG8xSlQoKSkgewogICAgICAgICAgICAgICAgRm9yZWlnbktl\neSBmayA9IHZpbmZvLmdldFR5cGVKb2luKGZpZWxkLCBmaWVsZC5nZXROYW1l\nKCksIHRydWUsCiAgICAgICAgICAgICAgICAgICAgYWRhcHQpOwogICAgICAg\nICAgICAgICAgZmllbGQuc2V0Rm9yZWlnbktleShmayk7CiAgICAgICAgICAg\nIH0KICAgICAgICAgICAgZmllbGQuc2V0Q29sdW1uSU8odmluZm8uZ2V0Q29s\ndW1uSU8oKSk7CiAgICAgICAgICAgIGlmICh2aW5mby5nZXRKb2luRGlyZWN0\naW9uKCkgPT0gdmluZm8uSk9JTl9JTlZFUlNFKQogICAgICAgICAgICAgICAg\nZmllbGQuc2V0Sm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwog\nICAgICAgIH0gZWxzZQogICAgICAgICAgICBSZWxhdGlvblN0cmF0ZWdpZXMu\nbWFwUmVsYXRpb25Ub1VubWFwcGVkUEMoZmllbGQsIGZpZWxkLmdldE5hbWUo\nKSwKICAgICAgICAgICAgICAgIGFkYXB0KTsKCiAgICAgICAgZmllbGQuc2V0\nVXNlQ2xhc3NDcml0ZXJpYShjcml0ZXJpYSk7CiAgICAgICAgZmllbGQubWFw\nUHJpbWFyeUtleShhZGFwdCk7CiAgICAgICAgUHJpbWFyeUtleSBwayA9IGZp\nZWxkLmdldFRhYmxlKCkuZ2V0UHJpbWFyeUtleSgpOwogICAgICAgIGlmIChm\naWVsZC5pc1ByaW1hcnlLZXkoKSkgewogICAgICAgICAgICBDb2x1bW5bXSBj\nb2xzID0gZmllbGQuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocGsg\nIT0gbnVsbCAmJiAoYWRhcHQgfHwgcGsuaXNMb2dpY2FsKCkpKQogICAgICAg\nICAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsr\nKQogICAgICAgICAgICAgICAgICAgIHBrLmFkZENvbHVtbihjb2xzW2ldKTsK\nICAgICAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsg\naSsrKQogICAgICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5n\nKCkuc2V0Sm9pbmFibGUoY29sc1tpXSwgdGhpcyk7CiAgICAgICAgfQoKICAg\nICAgICAvLyBtYXAgY29uc3RyYWludHMgYWZ0ZXIgcGsgc28gd2UgZG9uJ3Qg\ncmUtaW5kZXggLyByZS11bmlxdWUgcGsgY29sCiAgICAgICAgZmllbGQubWFw\nQ29uc3RyYWludHMoZmllbGQuZ2V0TmFtZSgpLCBhZGFwdCk7CiAgICB9Cgog\nICAgLyoqCiAgICAgKiBXaGVuIHRoZXJlIGlzIE1hcHBlZEJ5SWQgYW5ub3Rh\ndGlvbiwgdGhlIG93bmVyIG9mIHRoZSBvbmUtdG8tb25lLwogICAgICogbWFu\neS10by1vbmUgcmVsYXRpb25zaGlwIHdpbGwgdXNlIGl0cyBwcmltYXJ5IGtl\neSB0byByZXByZXNlbnQgCiAgICAgKiBmb3JlaWduIGtleSByZWxhdGlvbi4g\nTm8gbmVlZCB0byBjcmVhdGUgYSBzZXBhcmF0ZSBmb3JlaWduIGtleQogICAg\nICogY29sdW1uLiAKICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIHNldE1hcHBl\nZEJ5SWRDb2x1bW5zKCkgewogICAgICAgIENsYXNzTWV0YURhdGEgb3duZXIg\nPSBmaWVsZC5nZXREZWZpbmluZ01ldGFEYXRhKCk7CiAgICAgICAgRmllbGRN\nZXRhRGF0YVtdIHBrcyA9IG93bmVyLmdldFByaW1hcnlLZXlGaWVsZHMoKTsK\nICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IHBrcy5sZW5ndGg7IGkrKykg\newogICAgICAgICAgICBGaWVsZE1hcHBpbmcgZm0gPSAoRmllbGRNYXBwaW5n\nKSBwa3NbaV07CiAgICAgICAgICAgIFZhbHVlTWFwcGluZ0ltcGwgdmFsID0g\nKFZhbHVlTWFwcGluZ0ltcGwpIGZpZWxkLmdldFZhbHVlKCk7CiAgICAgICAg\nICAgIFZhbHVlTWFwcGluZ0luZm8gaW5mbyA9IHZhbC5nZXRWYWx1ZUluZm8o\nKTsKICAgICAgICAgICAgaWYgKGluZm8uZ2V0Q29sdW1ucygpLnNpemUoKSA9\nPSAwKSAKICAgICAgICAgICAgICAgIGluZm8uc2V0Q29sdW1ucyhnZXRNYXBw\nZWRCeUlkQ29sdW1ucyhmbSkpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2\nYXRlIExpc3QgZ2V0TWFwcGVkQnlJZENvbHVtbnMoRmllbGRNYXBwaW5nIHBr\nKSB7CiAgICAgICAgQ2xhc3NNZXRhRGF0YSBlbWJlZGRlZElkID0gKChWYWx1\nZU1hcHBpbmdJbXBsKXBrLmdldFZhbHVlKCkpLgogICAgICAgICAgICBnZXRF\nbWJlZGRlZE1ldGFEYXRhKCk7CiAgICAgICAgQ29sdW1uW10gcGtDb2xzID0g\nbnVsbDsKICAgICAgICBMaXN0IGNvbHMgPSBuZXcgQXJyYXlMaXN0KCk7CiAg\nICAgICAgU3RyaW5nIG1hcHBlZEJ5SWRWYWx1ZSA9IGZpZWxkLmdldE1hcHBl\nZEJ5SWRWYWx1ZSgpOwogICAgICAgIGlmIChlbWJlZGRlZElkICE9IG51bGwp\nIHsKICAgICAgICAgICAgRmllbGRNZXRhRGF0YVtdIGZtZHMgPSBlbWJlZGRl\nZElkLmdldEZpZWxkcygpOwogICAgICAgICAgICBmb3IgKGludCBpID0gMDsg\naSA8IGZtZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICgo\nZm1kc1tpXS5nZXROYW1lKCkuZXF1YWxzKG1hcHBlZEJ5SWRWYWx1ZSkpIHx8\nCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkQnlJZFZhbHVlLmxlbmd0aCgp\nID09IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm1kc1tpXS5nZXRW\nYWx1ZSgpLmdldEVtYmVkZGVkTWV0YURhdGEoKSAhPSBudWxsKSB7CiAgICAg\nICAgICAgICAgICAgICAgICAgIEVtYmVkVmFsdWVIYW5kbGVyLmdldEVtYmVk\nZGVkSWRDb2xzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChG\naWVsZE1hcHBpbmcpZm1kc1tpXSwgY29scyk7CiAgICAgICAgICAgICAgICAg\nICAgfSBlbHNlIAogICAgICAgICAgICAgICAgICAgICAgICBFbWJlZFZhbHVl\nSGFuZGxlci5nZXRJZENvbHVtbnMoCiAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgKEZpZWxkTWFwcGluZylmbWRzW2ldLCBjb2xzKTsKICAgICAg\nICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4g\nY29sczsKICAgICAgICB9IGVsc2UgeyAvLyBwcmltYXJ5IGtleSBpcyBzaW5n\nbGUtdmFsdWUKICAgICAgICAgICAgQ2xhc3MgcGtUeXBlID0gcGsuZ2V0RGVj\nbGFyZWRUeXBlKCk7CiAgICAgICAgICAgIEZpZWxkTWV0YURhdGFbXSBwa3Mg\nPSBmaWVsZC5nZXRWYWx1ZSgpLmdldERlY2xhcmVkVHlwZU1ldGFEYXRhKCku\nCiAgICAgICAgICAgICAgICAgICAgZ2V0UHJpbWFyeUtleUZpZWxkcygpOwog\nICAgICAgICAgICBpZiAocGtzLmxlbmd0aCAhPSAxIHx8IHBrc1swXS5nZXRE\nZWNsYXJlZFR5cGUoKSAhPSBwa1R5cGUpCiAgICAgICAgICAgICAgICByZXR1\ncm4gQ29sbGVjdGlvbnMuRU1QVFlfTElTVDsKICAgICAgICAgICAgcGtDb2xz\nID0gcGsuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBmb3IgKGludCBpID0g\nMDsgaSA8IHBrQ29scy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgIGNv\nbHMuYWRkKHBrQ29sc1tpXSk7CiAgICAgICAgICAgIHJldHVybiBjb2xzOwog\nICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybiB3aGV0aGVy\nIG91ciBkZWZpbmluZyBtYXBwaW5nIGlzIGFuIHVuam9pbmVkIHN1YmNsYXNz\nIG9mCiAgICAgKiB0aGUgdHlwZSBvZiB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAg\nKi8KICAgIHByaXZhdGUgYm9vbGVhbiBpc1R5cGVVbmpvaW5lZFN1YmNsYXNz\nKFZhbHVlTWFwcGluZyBtYXBwZWQpIHsKICAgICAgICBDbGFzc01hcHBpbmcg\nZGVmID0gZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCk7CiAgICAgICAgZm9y\nICg7IGRlZiAhPSBudWxsOyBkZWYgPSBkZWYuZ2V0Sm9pbmFibGVQQ1N1cGVy\nY2xhc3NNYXBwaW5nKCkpCiAgICAgICAgICAgIGlmIChkZWYgPT0gbWFwcGVk\nLmdldFR5cGVNYXBwaW5nKCkpCiAgICAgICAgICAgICAgICByZXR1cm4gZmFs\nc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcHVibGljIHZv\naWQgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBmaWVsZC5zZXRVc2VzSW50ZXJt\nZWRpYXRlKHRydWUpOwoKICAgICAgICBGb3JlaWduS2V5IGZrID0gZmllbGQu\nZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIGlmIChmayA9PSBudWxsKQogICAg\nICAgICAgICBfZmtPaWQgPSBCb29sZWFuLlRSVUU7CiAgICAgICAgZWxzZSBp\nZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpICE9IEZpZWxkTWFwcGluZy5K\nT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIF9ma09pZCA9IGZpZWxkLmdldFR5\ncGVNYXBwaW5nKCkuaXNGb3JlaWduS2V5T2JqZWN0SWQoZmspOwogICAgfQoK\nICAgIHB1YmxpYyB2b2lkIGluc2VydChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNt\nLCBKREJDU3RvcmUgc3RvcmUsIFJvd01hbmFnZXIgcm0pCiAgICAgICAgdGhy\nb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKGZpZWxkLmdldE1hcHBl\nZEJ5KCkgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBP\ncGVuSlBBU3RhdGVNYW5hZ2VyIHJlbCA9IFJlbGF0aW9uU3RyYXRlZ2llcy5n\nZXRTdGF0ZU1hbmFnZXIKICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0Rmll\nbGQoZmllbGQuZ2V0SW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CiAg\nICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5K\nT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHVwZGF0ZUludmVyc2Uoc20sIHJl\nbCwgc3RvcmUsIHJtKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgUm93\nIHJvdyA9IGZpZWxkLmdldFJvdyhzbSwgc3RvcmUsIHJtLCBSb3cuQUNUSU9O\nX0lOU0VSVCk7CiAgICAgICAgICAgIGlmIChyb3cgIT0gbnVsbCAmJiAhZmll\nbGQuaXNCaU1UbzFKVCgpKSB7CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRG\nb3JlaWduS2V5KHJvdywgcmVsKTsKICAgICAgICAgICAgICAgIC8vIHRoaXMg\naXMgZm9yIGJpLWRpcmVjdGlvbmFsIG1hcHMsIHRoZSBrZXkgYW5kIHZhbHVl\nIG9mIHRoZSAKICAgICAgICAgICAgICAgIC8vIG1hcCBhcmUgc3RvcmVkIGlu\nIHRoZSB0YWJsZSBvZiB0aGUgbWFwcGVkLWJ5IGVudGl0eSAgCiAgICAgICAg\nICAgICAgICBzZXRNYXBLZXkoc20sIHJlbCwgc3RvcmUsIHJvdyk7CiAgICAg\nICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHByaXZhdGUgdm9p\nZCBzZXRNYXBLZXkoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgT3BlbkpQQVN0\nYXRlTWFuYWdlciByZWwsIAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgUm93\nIHJvdykgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKHJlbCA9\nPSBudWxsKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgQ2xhc3NNZXRh\nRGF0YSBtZXRhID0gcmVsLmdldE1ldGFEYXRhKCk7CiAgICAgICAgRmllbGRN\nYXBwaW5nIG1hcEZpZWxkID0gZ2V0TWFwRmllbGQobWV0YSk7CiAgICAgICAg\nCiAgICAgICAgLy8gdGhlcmUgaXMgbm8gYmktZGlyZWN0aW9uYWwgbWFwIGZp\nZWxkCiAgICAgICAgaWYgKG1hcEZpZWxkID09IG51bGwpCiAgICAgICAgICAg\nIHJldHVybjsKICAgICAgICAKICAgICAgICBNYXAgbWFwT2JqID0gKE1hcCly\nZWwuZmV0Y2hPYmplY3RGaWVsZChtYXBGaWVsZC5nZXRJbmRleCgpKTsKICAg\nICAgICBPYmplY3Qga2V5T2JqID0gZ2V0TWFwS2V5T2JqKG1hcE9iaiwgc20u\nZ2V0UGVyc2lzdGVuY2VDYXBhYmxlKCkpOwogICAgICAgIFZhbHVlTWFwcGlu\nZyBrZXkgPSBtYXBGaWVsZC5nZXRLZXlNYXBwaW5nKCk7CiAgICAgICAgaWYg\nKCFrZXkuaXNFbWJlZGRlZCgpKSB7CiAgICAgICAgICAgIGlmIChrZXlPYmog\naW5zdGFuY2VvZiBQZXJzaXN0ZW5jZUNhcGFibGUpIHsKICAgICAgICAgICAg\nICAgIE9wZW5KUEFTdGF0ZU1hbmFnZXIga2V5U20gPSBSZWxhdGlvblN0cmF0\nZWdpZXMuCiAgICAgICAgICAgICAgICAgICAgZ2V0U3RhdGVNYW5hZ2VyKGtl\neU9iaiwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKICAgICAgICAgICAgICAgIC8v\nIGtleSBpcyBhbiBlbnRpdHkKICAgICAgICAgICAgICAgIEZvcmVpZ25LZXkg\nZmsgPSBtYXBGaWVsZC5nZXRLZXlNYXBwaW5nKCkuCiAgICAgICAgICAgICAg\nICAgICAgZ2V0Rm9yZWlnbktleSgpOwogICAgICAgICAgICAgICAgQ29sdW1u\nSU8gaW8gPSBuZXcgQ29sdW1uSU8oKTsKICAgICAgICAgICAgICAgIHJvdy5z\nZXRGb3JlaWduS2V5KGZrLCBpbywga2V5U20pOwogICAgICAgICAgICB9IAog\nICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGtleSBpcyBhbiBlbWJl\nZGRhYmxlIG9yIGJhc2ljIHR5cGUKICAgICAgICAgICAgRmllbGRTdHJhdGVn\neSBzdHJhdGVneSA9IG1hcEZpZWxkLmdldFN0cmF0ZWd5KCk7IAogICAgICAg\nICAgICBpZiAoc3RyYXRlZ3kgaW5zdGFuY2VvZiAgCiAgICAgICAgICAgICAg\nICAgICAgSGFuZGxlclJlbGF0aW9uTWFwVGFibGVGaWVsZFN0cmF0ZWd5KSB7\nCiAgICAgICAgICAgICAgICBIYW5kbGVyUmVsYXRpb25NYXBUYWJsZUZpZWxk\nU3RyYXRlZ3kgc3RyYXQgPSAKICAgICAgICAgICAgICAgICAgICAoSGFuZGxl\nclJlbGF0aW9uTWFwVGFibGVGaWVsZFN0cmF0ZWd5KSBzdHJhdGVneTsKICAg\nICAgICAgICAgICAgIENvbHVtbltdIGtjb2xzID0gc3RyYXQuZ2V0S2V5Q29s\ndW1ucygoQ2xhc3NNYXBwaW5nKW1ldGEpOwogICAgICAgICAgICAgICAgQ29s\ndW1uSU8ga2lvID0gc3RyYXQuZ2V0S2V5Q29sdW1uSU8oKTsKICAgICAgICAg\nICAgICAgIEhhbmRsZXJTdHJhdGVnaWVzLnNldChrZXksIGtleU9iaiwgc3Rv\ncmUsIHJvdywga2NvbHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGtpbywg\ndHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IAogICAgfQogICAgCiAg\nICBwcml2YXRlIEZpZWxkTWFwcGluZyBnZXRNYXBGaWVsZChDbGFzc01ldGFE\nYXRhIG1ldGEpIHsKICAgICAgICBGaWVsZE1hcHBpbmdbXSBmaWVsZHMgPSAo\nKENsYXNzTWFwcGluZyltZXRhKS5nZXRGaWVsZE1hcHBpbmdzKCk7CiAgICAg\nICAgZm9yIChpbnQgaSA9IDA7IGkgPCBmaWVsZHMubGVuZ3RoOyBpKyspIHsK\nICAgICAgICAgICAgRmllbGRNZXRhRGF0YSBtYXBwZWRCeSA9IGZpZWxkc1tp\nXS5nZXRNYXBwZWRCeU1ldGFEYXRhKCk7CiAgICAgICAgICAgIGlmIChmaWVs\nZHNbaV0uZ2V0RGVjbGFyZWRUeXBlQ29kZSgpID09IEphdmFUeXBlcy5NQVAg\nJiYKICAgICAgICAgICAgICAgIG1hcHBlZEJ5ID09IGZpZWxkKSAgCiAgICAg\nICAgICAgICAgICByZXR1cm4gZmllbGRzW2ldOwogICAgICAgIH0gCiAgICAg\nICAgcmV0dXJuIG51bGw7ICAgIAogICAgfQogICAgCiAgICBwcml2YXRlIE9i\namVjdCBnZXRNYXBLZXlPYmooTWFwIG1hcE9iaiwgT2JqZWN0IHZhbHVlKSB7\nCiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmVmbGVjdGluZ1BlcnNp\nc3RlbmNlQ2FwYWJsZSkKICAgICAgICAgICAgdmFsdWUgPSAoKFJlZmxlY3Rp\nbmdQZXJzaXN0ZW5jZUNhcGFibGUpdmFsdWUpLmdldE1hbmFnZWRJbnN0YW5j\nZSgpOyAKICAgICAgICBTZXQga2V5U2V0ID0gbWFwT2JqLmtleVNldCgpOwog\nICAgICAgIGZvciAoT2JqZWN0IGtleSA6IGtleVNldCkgewogICAgICAgICAg\nICBpZiAobWFwT2JqLmdldChrZXkpID09IHZhbHVlKQogICAgICAgICAgICAg\nICAgcmV0dXJuIGtleTsKICAgICAgICB9CiAgICAgICAgU2V0PE1hcC5FbnRy\neT4gZW50cmllcyA9IG1hcE9iai5lbnRyeVNldCgpOwogICAgICAgIGZvciAo\nTWFwLkVudHJ5IGVudHJ5IDogZW50cmllcykgewogICAgICAgICAgICBpZiAo\nZW50cnkuZ2V0VmFsdWUoKSA9PSB2YWx1ZSkKICAgICAgICAgICAgICAgIHJl\ndHVybiBlbnRyeS5nZXRLZXkoKTsKICAgICAgICB9CiAgICAgCiAgICAgICAg\ncmV0dXJuIG51bGw7CiAgICB9CgogICAgcHVibGljIHZvaWQgdXBkYXRlKE9w\nZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwgUm93TWFu\nYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAg\nICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxsKQogICAgICAgICAg\nICByZXR1cm47CgogICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFnZXIgcmVsID0g\nUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcgogICAgICAgICAg\nICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJbmRleCgpKSwgc3Rv\ncmUuZ2V0Q29udGV4dCgpKTsKCiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5E\naXJlY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0UpIHsKICAgICAgICAg\nICAgbnVsbEludmVyc2Uoc20sIHJtKTsKICAgICAgICAgICAgdXBkYXRlSW52\nZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAgICAgIH0gZWxzZSB7CiAg\nICAgICAgICAgIGludCBhY3Rpb24gPSAocmVsID09IG51bGwgJiYgCiAgICAg\nICAgICAgICAgICAgICAgZmllbGQuaXNCaWRpcmVjdGlvbmFsSm9pblRhYmxl\nTWFwcGluZ05vbk93bmVyKCkpID8KICAgICAgICAgICAgICAgICAgICBSb3cu\nQUNUSU9OX0RFTEVURSA6IFJvdy5BQ1RJT05fVVBEQVRFOwogICAgICAgICAg\nICBSb3cgcm93ID0gZmllbGQuZ2V0Um93KHNtLCBzdG9yZSwgcm0sIGFjdGlv\nbik7CiAgICAgICAgICAgIGlmIChyb3cgIT0gbnVsbCAmJiAhZmllbGQuaXNC\naU1UbzFKVCgpKSB7CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWdu\nS2V5KHJvdywgcmVsKTsKICAgICAgICAgICAgICAgIC8vIHRoaXMgaXMgZm9y\nIGJpLWRpcmVjdGlvbmFsIG1hcHMsIHRoZSBrZXkgYW5kIHZhbHVlIG9mIHRo\nZSAKICAgICAgICAgICAgICAgIC8vIG1hcCBhcmUgc3RvcmVkIGluIHRoZSB0\nYWJsZSBvZiB0aGUgbWFwcGVkLWJ5IGVudGl0eSAgCiAgICAgICAgICAgICAg\nICBzZXRNYXBLZXkoc20sIHJlbCwgc3RvcmUsIHJvdyk7CiAgICAgICAgICAg\nIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChmaWVsZC5pc0JpTVRv\nMUpUKCkpIHsgLy8gYWxzbyBuZWVkIHRvIHVwZGF0ZSB0aGUgam9pbiB0YWJs\nZQogICAgICAgICAgICAgICAgUGVyc2lzdGVuY2VDYXBhYmxlIGludlBDID0g\nKFBlcnNpc3RlbmNlQ2FwYWJsZSlzbS5mZXRjaE9iamVjdCgKICAgICAgICAg\nICAgICAgICAgICBmaWVsZC5nZXRCaV8xVG9NX0pURmllbGQoKS5nZXRJbmRl\neCgpKTsKICAgICAgICAgICAgICAgIFJvdyBzZWNvbmRhcnlSb3cgPSBudWxs\nOwogICAgICAgICAgICAgICAgaWYgKGludlBDICE9IG51bGwpIHsKICAgICAg\nICAgICAgICAgICAgICBzZWNvbmRhcnlSb3cgPSBybS5nZXRTZWNvbmRhcnlS\nb3coZmllbGQuZ2V0QmkxVG9NSm9pbkZLKCkuZ2V0VGFibGUoKSwKICAgICAg\nICAgICAgICAgICAgICAgICAgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAg\nICAgICAgICAgICAgIHNlY29uZGFyeVJvdy5zZXRGb3JlaWduS2V5KGZpZWxk\nLmdldEJpMVRvTUVsZW1GSygpLCBudWxsLCBzbSk7CiAgICAgICAgICAgICAg\nICAgICAgc2Vjb25kYXJ5Um93LnNldEZvcmVpZ25LZXkoZmllbGQuZ2V0Qmkx\nVG9NSm9pbkZLKCksIG51bGwsIAogICAgICAgICAgICAgICAgICAgICAgICBS\nZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKGludlBDLAogICAg\nICAgICAgICAgICAgICAgICAgICBzdG9yZS5nZXRDb250ZXh0KCkpKTsKICAg\nICAgICAgICAgICAgICAgICBybS5mbHVzaFNlY29uZGFyeVJvdyhzZWNvbmRh\ncnlSb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAg\nICAgfQogICAgfQoKICAgIHB1YmxpYyB2b2lkIGRlbGV0ZShPcGVuSlBBU3Rh\ndGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsIFJvd01hbmFnZXIgcm0p\nCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKGZp\nZWxkLmdldE1hcHBlZEJ5KCkgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJu\nOwoKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZp\nZWxkLkpPSU5fSU5WRVJTRSkgewogICAgICAgICAgICBpZiAoc20uZ2V0TG9h\nZGVkKCkuZ2V0KGZpZWxkLmdldEluZGV4KCkpKSB7CiAgICAgICAgICAgICAg\nICBPcGVuSlBBU3RhdGVNYW5hZ2VyIHJlbCA9IFJlbGF0aW9uU3RyYXRlZ2ll\ncy5nZXRTdGF0ZU1hbmFnZXIoc20uCiAgICAgICAgICAgICAgICAgICAgZmV0\nY2hPYmplY3RGaWVsZChmaWVsZC5nZXRJbmRleCgpKSwgc3RvcmUuZ2V0Q29u\ndGV4dCgpKTsKICAgICAgICAgICAgICAgIHVwZGF0ZUludmVyc2Uoc20sIHJl\nbCwgc3RvcmUsIHJtKTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAg\nICAgICBudWxsSW52ZXJzZShzbSwgcm0pOwogICAgICAgIH0gZWxzZSB7CiAg\nICAgICAgICAgIGZpZWxkLmRlbGV0ZVJvdyhzbSwgc3RvcmUsIHJtKTsKCiAg\nICAgICAgICAgIC8vIGlmIG91ciBmb3JlaWduIGtleSBoYXMgYSBkZWxldGUg\nYWN0aW9uLCB3ZSBuZWVkIHRvIHNldCB0aGUKICAgICAgICAgICAgLy8gcmVs\nYXRlZCBvYmplY3Qgc28gY29uc3RyYWludHMgY2FuIGJlIGV2YWx1YXRlZAog\nICAgICAgICAgICBPcGVuSlBBU3RhdGVNYW5hZ2VyIHJlbCA9IFJlbGF0aW9u\nU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIKICAgICAgICAgICAgICAgIChz\nbS5mZXRjaE9iamVjdEZpZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9yZS5n\nZXRDb250ZXh0KCkpOwogICAgICAgICAgICBpZiAocmVsICE9IG51bGwpIHsK\nICAgICAgICAgICAgICAgIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5nZXRGb3Jl\naWduS2V5KChDbGFzc01hcHBpbmcpCiAgICAgICAgICAgICAgICAgICAgcmVs\nLmdldE1ldGFEYXRhKCkpOwogICAgICAgICAgICAgICAgaWYgKGZrLmdldERl\nbGV0ZUFjdGlvbigpID09IEZvcmVpZ25LZXkuQUNUSU9OX1JFU1RSSUNUIHx8\nCiAgICAgICAgICAgICAgICAgICAgZmsuZ2V0RGVsZXRlQWN0aW9uKCkgPT0g\nRm9yZWlnbktleS5BQ1RJT05fQ0FTQ0FERSkgewogICAgICAgICAgICAgICAg\nICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3coc20sIHN0b3JlLCBybSwgUm93\nLkFDVElPTl9ERUxFVEUpOwogICAgICAgICAgICAgICAgICAgIHJvdy5zZXRG\nb3JlaWduS2V5KGZrLCBudWxsLCByZWwpOwogICAgICAgICAgICAgICAgICAg\nIC8vIHRoaXMgaXMgZm9yIGJpLWRpcmVjdGlvbmFsIG1hcHMsIHRoZSBrZXkg\nYW5kIHZhbHVlIG9mIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIG1hcCBh\ncmUgc3RvcmVkIGluIHRoZSB0YWJsZSBvZiB0aGUgbWFwcGVkLWJ5IGVudGl0\neSAgCiAgICAgICAgICAgICAgICAgICAgc2V0TWFwS2V5KHNtLCByZWwsIHN0\nb3JlLCByb3cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAg\nICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogTnVsbCBpbnZlcnNlIHJl\nbGF0aW9ucyB0aGF0IHJlZmVyZW5jZSB0aGUgZ2l2ZW4gb2JqZWN0LgogICAg\nICovCiAgICBwcml2YXRlIHZvaWQgbnVsbEludmVyc2UoT3BlbkpQQVN0YXRl\nTWFuYWdlciBzbSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0VXNlQ2xhc3NDcml0\nZXJpYSgpKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIEZvcmVpZ25L\nZXkgZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7CiAgICAgICAgQ29sdW1u\nSU8gaW8gPSBmaWVsZC5nZXRDb2x1bW5JTygpOwogICAgICAgIGlmICghaW8u\naXNBbnlVcGRhdGFibGUoZmssIHRydWUpKQogICAgICAgICAgICByZXR1cm47\nCgogICAgICAgIC8vIG51bGwgaW52ZXJzZSBpZiBub3QgYWxyZWFkeSBlbmZv\ncmNlZCBieSBmawogICAgICAgIGlmIChmaWVsZC5nZXRJbmRlcGVuZGVudFR5\ncGVNYXBwaW5ncygpLmxlbmd0aCAhPSAxKQogICAgICAgICAgICB0aHJvdyBS\nZWxhdGlvblN0cmF0ZWdpZXMudW5pbnZlcnNhYmxlKGZpZWxkKTsKICAgICAg\nICBSb3cgcm93ID0gcm0uZ2V0QWxsUm93cyhmay5nZXRUYWJsZSgpLCBSb3cu\nQUNUSU9OX1VQREFURSk7CiAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmss\nIGlvLCBudWxsKTsKICAgICAgICByb3cud2hlcmVGb3JlaWduS2V5KGZrLCBz\nbSk7CiAgICAgICAgcm0uZmx1c2hBbGxSb3dzKHJvdyk7CiAgICB9CgogICAg\nLyoqCiAgICAgKiBUaGlzIG1ldGhvZCB1cGRhdGVzIHRoZSBpbnZlcnNlIGNv\nbHVtbnMgb2Ygb3VyIHJlbGF0aW9uCiAgICAgKiB3aXRoIHRoZSBnaXZlbiBv\nYmplY3QuCiAgICAgKi8KICAgIHByaXZhdGUgdm9pZCB1cGRhdGVJbnZlcnNl\nKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIE9wZW5KUEFTdGF0ZU1hbmFnZXIg\ncmVsLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkK\nICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBpZiAocmVs\nID09IG51bGwpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgRm9yZWln\nbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBDb2x1\nbW5JTyBpbyA9IGZpZWxkLmdldENvbHVtbklPKCk7CgogICAgICAgIGludCBh\nY3Rpb247CiAgICAgICAgaWYgKHJlbC5pc05ldygpICYmICFyZWwuaXNGbHVz\naGVkKCkpIHsKICAgICAgICAgICAgaWYgKHNtLmlzRGVsZXRlZCgpIHx8ICFp\nby5pc0FueUluc2VydGFibGUoZmssIGZhbHNlKSkKICAgICAgICAgICAgICAg\nIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0gUm93LkFDVElPTl9JTlNF\nUlQ7CiAgICAgICAgfSBlbHNlIGlmIChyZWwuaXNEZWxldGVkKCkpIHsKICAg\nICAgICAgICAgaWYgKHJlbC5pc0ZsdXNoZWQoKSB8fCAhc20uaXNEZWxldGVk\nKCkpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGFjdGlv\nbiA9IFJvdy5BQ1RJT05fREVMRVRFOwogICAgICAgIH0gZWxzZSB7CiAgICAg\nICAgICAgIGlmIChzbS5pc0RlbGV0ZWQoKSkKICAgICAgICAgICAgICAgIHNt\nID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFpby5pc0FueVVwZGF0YWJsZShm\naywgc20gPT0gbnVsbCkpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAg\nICAgICAgIGFjdGlvbiA9IFJvdy5BQ1RJT05fVVBEQVRFOwogICAgICAgIH0K\nCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdz\nKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0aW9uU3Ry\nYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwoKICAgICAgICAvLyBnZXQg\ndGhlIHJvdyBmb3IgdGhlIGludmVyc2Ugb2JqZWN0OyB0aGUgcm93IG1pZ2h0\nIGJlIGluIGEgc2Vjb25kYXJ5CiAgICAgICAgLy8gdGFibGUgaWYgdGhlcmUg\naXMgYSBmaWVsZCBjb250cm9sbGluZyB0aGUgZm9yZWlnbiBrZXkKICAgICAg\nICBSb3cgcm93ID0gbnVsbDsKICAgICAgICBGaWVsZE1hcHBpbmdbXSBpbnZz\nID0gZmllbGQuZ2V0SW52ZXJzZU1hcHBpbmdzKCk7CiAgICAgICAgZm9yIChp\nbnQgaSA9IDA7IGkgPCBpbnZzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAg\nIGlmIChpbnZzW2ldLmdldE1hcHBlZEJ5TWV0YURhdGEoKSA9PSBmaWVsZAog\nICAgICAgICAgICAgICAgJiYgaW52c1tpXS5nZXRUeXBlQ29kZSgpID09IEph\ndmFUeXBlcy5QQykgewogICAgICAgICAgICAgICAgcm93ID0gaW52c1tpXS5n\nZXRSb3cocmVsLCBzdG9yZSwgcm0sIGFjdGlvbik7CiAgICAgICAgICAgICAg\nICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBDbGFz\nc01hcHBpbmcgcmVsTWFwcGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7\nCiAgICAgICAgaWYgKHJvdyA9PSBudWxsKQogICAgICAgICAgICByb3cgPSBy\nbS5nZXRSb3cocmVsTWFwcGluZy5nZXRUYWJsZSgpLCBhY3Rpb24sIHJlbCwg\ndHJ1ZSk7CgogICAgICAgIC8vIGlmIHRoaXMgaXMgYW4gdXBkYXRlLCB0aGlz\nIG1pZ2h0IGJlIHRoZSBvbmx5IG1vZCB0byB0aGUgcm93LCBzbwogICAgICAg\nIC8vIG1ha2Ugc3VyZSB0aGUgd2hlcmUgY29uZGl0aW9uIGlzIHNldAogICAg\nICAgIGlmIChhY3Rpb24gPT0gUm93LkFDVElPTl9VUERBVEUKICAgICAgICAg\nICAgJiYgcm93LmdldFRhYmxlKCkgPT0gcmVsTWFwcGluZy5nZXRUYWJsZSgp\nKQogICAgICAgICAgICByb3cud2hlcmVQcmltYXJ5S2V5KHJlbCk7CgogICAg\nICAgIC8vIHVwZGF0ZSB0aGUgaW52ZXJzZSBwb2ludGVyIHdpdGggb3VyIG9p\nZCB2YWx1ZQogICAgICAgIHJvdy5zZXRGb3JlaWduS2V5KGZrLCBpbywgc20p\nOwogICAgfQoKICAgIHB1YmxpYyBpbnQgc3VwcG9ydHNTZWxlY3QoU2VsZWN0\nIHNlbCwgaW50IHR5cGUsIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAg\nICAgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZl\ndGNoKSB7CiAgICAgICAgaWYgKHR5cGUgPT0gU2VsZWN0LlRZUEVfSk9JTkxF\nU1MpCiAgICAgICAgICAgIHJldHVybiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlv\nbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRQogICAgICAgICAgICAgICAgJiYg\nc2VsLmlzU2VsZWN0ZWQoZmllbGQuZ2V0VGFibGUoKSkpID8gMSA6IDA7CiAg\nICAgICAgaWYgKHR5cGUgPT0gU2VsZWN0LlRZUEVfVFdPX1BBUlQpCiAgICAg\nICAgICAgIHJldHVybiAxOwoKICAgICAgICAvLyBhbHJlYWR5IGNhY2hlZD8K\nICAgICAgICBpZiAoc20gIT0gbnVsbCkgewogICAgICAgICAgICBPYmplY3Qg\nb2lkID0gc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpOwog\nICAgICAgICAgICBpZiAoc3RvcmUuZ2V0Q29udGV4dCgpLmZpbmRDYWNoZWQo\nb2lkLCBudWxsKSAhPSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7\nCiAgICAgICAgfQoKICAgICAgICBDbGFzc01hcHBpbmdbXSBjbHNzID0gZmll\nbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKTsKICAgICAgICBzd2l0\nY2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBTZWxlY3QuRUFHRVJfUEFS\nQUxMRUw6CiAgICAgICAgICAgICAgICByZXR1cm4gY2xzcy5sZW5ndGg7CiAg\nICAgICAgICAgIGNhc2UgU2VsZWN0LkVBR0VSX09VVEVSOgogICAgICAgICAg\nICAgICAgcmV0dXJuIChjbHNzLmxlbmd0aCA9PSAxICYmIHN0b3JlLmdldERC\nRGljdGlvbmFyeSgpLmNhbk91dGVySm9pbgogICAgICAgICAgICAgICAgICAg\nIChzZWwuZ2V0Sm9pblN5bnRheCgpLCBmaWVsZC5nZXRGb3JlaWduS2V5KGNs\nc3NbMF0pKSkgPyAxIDoKICAgICAgICAgICAgICAgICAgICAwOwogICAgICAg\nICAgICBjYXNlIFNlbGVjdC5FQUdFUl9JTk5FUjoKICAgICAgICAgICAgICAg\nIHJldHVybiAoY2xzcy5sZW5ndGggPT0gMSkgPyAxIDogMDsKICAgICAgICAg\nICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAg\nIH0KICAgIH0KCiAgICBwdWJsaWMgdm9pZCBzZWxlY3RFYWdlclBhcmFsbGVs\nKFNlbGVjdEV4ZWN1dG9yIHNlbCwKICAgICAgICBmaW5hbCBPcGVuSlBBU3Rh\ndGVNYW5hZ2VyIHNtLCBmaW5hbCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAg\nZmluYWwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwgZmluYWwgaW50\nIGVhZ2VyTW9kZSkgewogICAgICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIGNs\nc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAg\nICAgIGlmICghKHNlbCBpbnN0YW5jZW9mIFVuaW9uKSkKICAgICAgICAgICAg\nc2VsZWN0RWFnZXJQYXJhbGxlbCgoU2VsZWN0KSBzZWwsIGNsc3NbMF0sIHN0\nb3JlLCBmZXRjaCwgZWFnZXJNb2RlKTsKICAgICAgICBlbHNlIHsKICAgICAg\nICAgICAgVW5pb24gdW5pb24gPSAoVW5pb24pIHNlbDsKICAgICAgICAgICAg\naWYgKGZldGNoLmdldFN1YmNsYXNzRmV0Y2hNb2RlIChmaWVsZC5nZXRUeXBl\nTWFwcGluZygpKSAKICAgICAgICAgICAgICAgICE9IEpEQkNGZXRjaENvbmZp\nZ3VyYXRpb24uRUFHRVJfSk9JTikKICAgICAgICAgICAgICAgIHVuaW9uLmFi\nb3J0VW5pb24oKTsKICAgICAgICAgICAgdW5pb24uc2VsZWN0KG5ldyBVbmlv\nbi5TZWxlY3RvcigpIHsKICAgICAgICAgICAgICAgIHB1YmxpYyB2b2lkIHNl\nbGVjdChTZWxlY3Qgc2VsLCBpbnQgaWR4KSB7CiAgICAgICAgICAgICAgICAg\nICAgc2VsZWN0RWFnZXJQYXJhbGxlbChzZWwsIGNsc3NbaWR4XSwgc3RvcmUs\nIGZldGNoLAogICAgICAgICAgICAgICAgICAgICAgICBlYWdlck1vZGUpOwog\nICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAg\nICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtIGFuIGVhZ2VyIHBhcmFsbGVs\nIHNlbGVjdC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIHNlbGVjdEVhZ2Vy\nUGFyYWxsZWwoU2VsZWN0IHNlbCwgQ2xhc3NNYXBwaW5nIGNscywKICAgICAg\nICBKREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0\nY2gsIGludCBlYWdlck1vZGUpIHsKICAgICAgICBpZiAoZmllbGQuaXNCaU1U\nbzFKVCgpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgc2VsLnNlbGVj\ndFByaW1hcnlLZXkoZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkpOwogICAg\nICAgIC8vIHNldCBhIHZhcmlhYmxlIG5hbWUgdGhhdCBkb2VzIG5vdCBjb25m\nbGljdCB3aXRoIGFueSBpbiB0aGUgcXVlcnk7CiAgICAgICAgLy8gdXNpbmcg\nYSB2YXJpYWJsZSBndWFyYW50ZWVzIHRoYXQgdGhlIHNlbGVjdGVkIGRhdGEg\nd2lsbCB1c2UgZGlmZmVyZW50CiAgICAgICAgLy8gYWxpYXNlcyBhbmQgam9p\nbnMgdGhhbiBhbnkgZXhpc3RpbmcgV0hFUkUgY29uZGl0aW9ucyBvbiB0aGlz\nIGZpZWxkCiAgICAgICAgLy8gdGhhdCBtaWdodCBvdGhlcndpc2UgbGltaXQg\ndGhlIHJlbGF0aW9ucyB0aGF0IG1hdGNoCiAgICAgICAgSm9pbnMgam9pbnMg\nPSBzZWwubmV3Sm9pbnMoKS5zZXRWYXJpYWJsZSgiKiIpOwogICAgICAgIGVh\nZ2VySm9pbihqb2lucywgY2xzLCB0cnVlKTsKICAgICAgICBzZWwuc2VsZWN0\nKGNscywgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBzdG9yZSwgZmV0\nY2gsIGVhZ2VyTW9kZSwgCiAgICAgICAgICAgIGpvaW5zKTsKICAgIH0KCiAg\nICBwdWJsaWMgdm9pZCBzZWxlY3RFYWdlckpvaW4oU2VsZWN0IHNlbCwgT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwKICAgICAgICBKREJDU3RvcmUgc3RvcmUs\nIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIGludCBlYWdlck1vZGUp\nIHsKICAgICAgICBpZiAoZmllbGQuaXNCaU1UbzFKVCgpKSAKICAgICAgICAg\nICAgcmV0dXJuOwoKICAgICAgICAvLyBsaW1pdCB0aGUgZWFnZXIgbW9kZSB0\nbyBzaW5nbGUgb24gcmVjdXJzaXZlIGVhZ2VyIGZldGNoaW5nIGIvYwogICAg\nICAgIC8vIGF0IHRoaXMgcG9pbnQgdGhlIHNlbGVjdCBoYXMgYmVlbiBtb2Rp\nZmllZCBhbmQgYW4gYXR0ZW1wdCB0bwogICAgICAgIC8vIGNsb25lIGl0IGZv\nciBhIHRvLW1hbnkgZWFnZXIgc2VsZWN0IGNhbiByZXN1bHQgaW4gYSBjbG9u\nZSB0aGF0CiAgICAgICAgLy8gcHJvZHVjZXMgaW52YWxpZCBTUUwKICAgICAg\nICBDbGFzc01hcHBpbmcgY2xzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBl\nTWFwcGluZ3MoKVswXTsKICAgICAgICBib29sZWFuIGZvcmNlSW5uZXIgPSBm\nZXRjaC5oYXNGZXRjaElubmVySm9pbihmaWVsZC5nZXRGdWxsTmFtZShmYWxz\nZSkpID8KICAgICAgICAgICAgICAgIHRydWUgOiBmYWxzZTsKICAgICAgICBz\nZWwuc2VsZWN0KGNscywgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBz\ndG9yZSwgZmV0Y2gsCiAgICAgICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRp\nb24uRUFHRVJfSk9JTiwKICAgICAgICAgICAgZWFnZXJKb2luKHNlbC5uZXdK\nb2lucygpLCBjbHMsIGZvcmNlSW5uZXIpKTsKICAgIH0KCiAgICAvKioKICAg\nICAqIEFkZCB0aGUgam9pbnMgbmVlZGVkIHRvIHNlbGVjdC9sb2FkIGVhZ2Vy\nIGRhdGEuCiAgICAgKi8KICAgIHByaXZhdGUgSm9pbnMgZWFnZXJKb2luKEpv\naW5zIGpvaW5zLCBDbGFzc01hcHBpbmcgY2xzLCBib29sZWFuIGZvcmNlSW5u\nZXIpIHsKICAgICAgICBib29sZWFuIGludmVyc2UgPSBmaWVsZC5nZXRKb2lu\nRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFOwogICAgICAgIGlm\nICghaW52ZXJzZSkgewogICAgICAgICAgICBqb2lucyA9IGpvaW4oam9pbnMs\nIGZhbHNlKTsKICAgICAgICAgICAgam9pbnMgPSBzZXRFbWJlZGRlZFZhcmlh\nYmxlKGpvaW5zKTsKICAgICAgICB9CgogICAgICAgIC8vIGFuZCBqb2luIGlu\ndG8gcmVsYXRpb24KICAgICAgICBGb3JlaWduS2V5IGZrID0gZmllbGQuZ2V0\nRm9yZWlnbktleShjbHMpOwogICAgICAgIGlmICghZm9yY2VJbm5lciAmJiBm\naWVsZC5nZXROdWxsVmFsdWUoKSAhPSBGaWVsZE1hcHBpbmcuTlVMTF9FWENF\nUFRJT04pCiAgICAgICAgICAgIHJldHVybiBqb2lucy5vdXRlckpvaW5SZWxh\ndGlvbihmaWVsZC5nZXROYW1lKCksIGZrLCBmaWVsZC4KICAgICAgICAgICAg\nICAgIGdldFR5cGVNYXBwaW5nKCksIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNz\nZXMoKSwgaW52ZXJzZSwgZmFsc2UpOwogICAgICAgIHJldHVybiBqb2lucy5q\nb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLCBmaywgZmllbGQuZ2V0VHlw\nZU1hcHBpbmcoKSwgCiAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1YmNs\nYXNzZXMoKSwgaW52ZXJzZSwgZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAg\nICogSWYgam9pbmluZyBmcm9tIGFuIGVtYmVkZGVkIG93bmVyLCB1c2UgdmFy\naWFibGUgdG8gY3JlYXRlIGEgdW5pcXVlCiAgICAgKiBhbGlhcyBpbiBjYXNl\nIG93bmVyIGNvbnRhaW5zIG90aGVyIHNhbWUtdHlwZWQgZW1iZWRkZWQgcmVs\nYXRpb25zLgogICAgICovCiAgICBwcml2YXRlIEpvaW5zIHNldEVtYmVkZGVk\nVmFyaWFibGUoSm9pbnMgam9pbnMpIHsKICAgICAgICBpZiAoZmllbGQuZ2V0\nRGVmaW5pbmdNZXRhRGF0YSgpLmdldEVtYmVkZGluZ01ldGFEYXRhKCkgPT0g\nbnVsbCkKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwogICAgICAgIHJldHVy\nbiBqb2lucy5zZXRWYXJpYWJsZShmaWVsZC5nZXREZWZpbmluZ01ldGFEYXRh\nKCkuCiAgICAgICAgICAgIGdldEVtYmVkZGluZ01ldGFEYXRhKCkuZ2V0Rmll\nbGRNZXRhRGF0YSgpLmdldE5hbWUoKSk7CiAgICB9CgogICAgcHVibGljIGlu\ndCBzZWxlY3QoU2VsZWN0IHNlbCwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwg\nSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRp\nb24gZmV0Y2gsIGludCBlYWdlck1vZGUpIHsKICAgICAgICBpZiAoZmllbGQu\nZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAg\nICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIC8vIGFscmVhZHkgY2FjaGVk\nIG9pZD8KICAgICAgICBpZiAoc20gIT0gbnVsbCAmJiBzbS5nZXRJbnRlcm1l\nZGlhdGUoZmllbGQuZ2V0SW5kZXgoKSkgIT0gbnVsbCkKICAgICAgICAgICAg\ncmV0dXJuIC0xOwogICAgICAgIGlmICghQm9vbGVhbi5UUlVFLmVxdWFscyhf\nZmtPaWQpKQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgc2VsLnNl\nbGVjdChmaWVsZC5nZXRDb2x1bW5zKCksIGZpZWxkLmpvaW4oc2VsKSk7CiAg\nICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgcHVibGljIE9iamVjdCBsb2Fk\nRWFnZXJQYXJhbGxlbChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3Rv\ncmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRj\naCwgT2JqZWN0IHJlcykKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICAvLyBwcm9jZXNzIGJhdGNoZWQgcmVzdWx0cyBpZiB3ZSBoYXZl\nbid0IGFscmVhZHkKICAgICAgICBNYXAgcmVsczsKICAgICAgICBpZiAocmVz\nIGluc3RhbmNlb2YgUmVzdWx0KQogICAgICAgICAgICByZWxzID0gcHJvY2Vz\nc0VhZ2VyUGFyYWxsZWxSZXN1bHQoc20sIHN0b3JlLCBmZXRjaCwgKFJlc3Vs\ndCkgcmVzKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJlbHMgPSAoTWFw\nKSByZXM7CgogICAgICAgIC8vIHN0b3JlIG9iamVjdCBmb3IgdGhpcyBvaWQg\naW4gaW5zdGFuY2UKICAgICAgICBzbS5zdG9yZU9iamVjdChmaWVsZC5nZXRJ\nbmRleCgpLCByZWxzLnJlbW92ZShzbS5nZXRPYmplY3RJZCgpKSk7CiAgICAg\nICAgcmV0dXJuIHJlbHM7CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9jZXNz\nIHRoZSBnaXZlbiBiYXRjaGVkIHJlc3VsdC4KICAgICAqLwogICAgcHJpdmF0\nZSBNYXAgcHJvY2Vzc0VhZ2VyUGFyYWxsZWxSZXN1bHQoT3BlbkpQQVN0YXRl\nTWFuYWdlciBzbSwKICAgICAgICBKREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRj\naENvbmZpZ3VyYXRpb24gZmV0Y2gsIFJlc3VsdCByZXMpCiAgICAgICAgdGhy\nb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gZG8gc2FtZSBqb2lucyBh\ncyBmb3IgbG9hZAogICAgICAgIC8vIyMjIGNoZWF0OiB3ZSBrbm93IHR5cGlj\nYWwgcmVzdWx0IGpvaW5zIG9ubHkgY2FyZSBhYm91dCB0aGUgcmVsYXRpb24K\nICAgICAgICAvLyMjIyBwYXRoOyB0aHVzIHdlIGNhbiBpZ25vcmUgZGlmZmVy\nZW50IG1hcHBpbmdzCiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xzcyA9IGZp\nZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAgSm9p\nbnMgam9pbnMgPSByZXMubmV3Sm9pbnMoKS5zZXRWYXJpYWJsZSgiKiIpOwog\nICAgICAgIGVhZ2VySm9pbihqb2lucywgY2xzc1swXSwgdHJ1ZSk7CgogICAg\nICAgIE1hcCByZWxzID0gbmV3IEhhc2hNYXAoKTsKICAgICAgICBDbGFzc01h\ncHBpbmcgb3duZXIgPSBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKTsKICAg\nICAgICBDbGFzc01hcHBpbmcgY2xzOwogICAgICAgIE9iamVjdCBvaWQ7CiAg\nICAgICAgd2hpbGUgKHJlcy5uZXh0KCkpIHsKICAgICAgICAgICAgY2xzID0g\ncmVzLmdldEJhc2VNYXBwaW5nKCk7CiAgICAgICAgICAgIGlmIChjbHMgPT0g\nbnVsbCkKICAgICAgICAgICAgICAgIGNscyA9IGNsc3NbMF07CiAgICAgICAg\nICAgIG9pZCA9IG93bmVyLmdldE9iamVjdElkKHN0b3JlLCByZXMsIG51bGws\nIHRydWUsIG51bGwpOwogICAgICAgICAgICByZWxzLnB1dChvaWQsIHJlcy5s\nb2FkKGNscywgc3RvcmUsIGZldGNoLCBqb2lucykpOwogICAgICAgIH0KICAg\nICAgICByZXMuY2xvc2UoKTsKCiAgICAgICAgcmV0dXJuIHJlbHM7CiAgICB9\nCgogICAgcHVibGljIHZvaWQgbG9hZEVhZ2VySm9pbihPcGVuSlBBU3RhdGVN\nYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNo\nQ29uZmlndXJhdGlvbiBmZXRjaCwgUmVzdWx0IHJlcykKICAgICAgICB0aHJv\nd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuaXNCaU1UbzFK\nVCgpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgQ2xhc3NNYXBwaW5n\nIGNscyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07\nCgogICAgICAgIC8vIGZvciBpbnZlcnNlRWFnZXIgZmllbGQKICAgICAgICBG\naWVsZE1hcHBpbmcgbWFwcGVkQnlGaWVsZE1hcHBpbmcgPSBmaWVsZC5nZXRN\nYXBwZWRCeU1hcHBpbmcoKTsKICAgICAgICBQZXJzaXN0ZW5jZUNhcGFibGUg\nbWFwcGVkQnlWYWx1ZSA9IG51bGw7CgogICAgICAgIGlmIChtYXBwZWRCeUZp\nZWxkTWFwcGluZyAhPSBudWxsKSB7CiAgICAgICAgCVZhbHVlTWFwcGluZyB2\nYWwgPSBtYXBwZWRCeUZpZWxkTWFwcGluZy5nZXRWYWx1ZU1hcHBpbmcoKTsK\nICAgICAgICAJQ2xhc3NNZXRhRGF0YSBkZWNNZXRhID0gdmFsLmdldFR5cGVN\nZXRhRGF0YSgpOwogICAgICAgICAgICAvLyBlYWdlciBsb2FkaW5nIGEgY2hp\nbGQgZnJvbSBpdHMgdG9PbmUgcGFyZW50IGFuZAogICAgICAgICAgICAvLyB0\naGUgcGFyZW50IGhhcyBAT25lVG9PbmUobWFwcGVkQnk9InBhcmVudCIpIGNo\naWxkIHJlbGF0aW9uLgogICAgICAgICAgICAvLyBCeSBzYXZpbmcgdGhlIG1h\ncHBlZC1ieSBpbmZvIGluICdyZXMnIGlzIHRvCiAgICAgICAgICAgIC8vIGF2\nb2lkIHVubmVlZGVkIFNRTCBwdXNoZG93biB0aGF0IHdvdWxkIG90aGVyd2lz\nZSBnZXRzCiAgICAgICAgICAgIC8vIGdlbmVyYXRlZC4KICAgICAgICAgICAg\naWYgKGRlY01ldGEgIT0gbnVsbCAmJiAhc20uaXNFbWJlZGRlZCgpKSB7CiAg\nICAgICAgCSAgICBtYXBwZWRCeVZhbHVlID0gc20uZ2V0UGVyc2lzdGVuY2VD\nYXBhYmxlKCk7CiAgICAgICAgCSAgICByZXMuc2V0TWFwcGVkQnlGaWVsZE1h\ncHBpbmcobWFwcGVkQnlGaWVsZE1hcHBpbmcpOwogICAgICAgIAkgICAgcmVz\nLnNldE1hcHBlZEJ5VmFsdWUobWFwcGVkQnlWYWx1ZSk7CiAgICAgICAgCX0K\nICAgICAgICB9CgogICAgICAgIGJvb2xlYW4gaXNMb2NrZWQgPSByZXMuaXNM\nb2NraW5nKCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHN0b3Jl\nLmdldExvY2tNYW5hZ2VyKCkgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHJl\ncy5zZXRMb2NraW5nKHN0b3JlLmdldExvY2tNYW5hZ2VyKCkuc2tpcFJlbGF0\naW9uRmllbGRMb2NrKCkpOwogICAgICAgICAgICBzbS5zdG9yZU9iamVjdChm\naWVsZC5nZXRJbmRleCgpLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRjaCwK\nICAgICAgICAgICAgICAgICAgICBlYWdlckpvaW4ocmVzLm5ld0pvaW5zKCks\nIGNscywgZmFsc2UpKSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAg\nICAgcmVzLnNldExvY2tpbmcoaXNMb2NrZWQpOwogICAgICAgIH0KCiAgICAg\nICAgLy8gcmVzZXQgbWFwcGVkIGJ5IGlzIG5lZWRlZCBmb3IgT25lVG9PbmUg\nYmlkaXJlY3Rpb25hbCByZWxhdGlvbnMKICAgICAgICAvLyBoYXZpbmcgYSBt\nYXBwZWQtYnkgcGFyZW50IHRvIGNvcnJlY3RseSBzZXQgdGhlIHBhcmVudC1j\naGlsZAogICAgICAgIC8vIHJlbGF0aW9uLgogICAgICAgIHJlcy5zZXRNYXBw\nZWRCeUZpZWxkTWFwcGluZyhudWxsKTsKICAgICAgICByZXMuc2V0TWFwcGVk\nQnlWYWx1ZShudWxsKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBsb2FkKE9w\nZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAg\nICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBSZXN1bHQgcmVzKQog\nICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQog\nICAgICAgICAgICByZXR1cm47CiAgICAgICAgLy8gY2FjaGVkIG9pZD8KICAg\nICAgICBpZiAoc20gIT0gbnVsbCAmJiBzbS5nZXRJbnRlcm1lZGlhdGUoZmll\nbGQuZ2V0SW5kZXgoKSkgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwog\nICAgICAgIGlmICghQm9vbGVhbi5UUlVFLmVxdWFscyhfZmtPaWQpKQogICAg\nICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKCFyZXMuY29udGFpbnNBbGwo\nZmllbGQuZ2V0Q29sdW1ucygpKSkKICAgICAgICAgICAgcmV0dXJuOwoKICAg\nICAgICAvLyBnZXQgdGhlIHJlbGF0ZWQgb2JqZWN0J3Mgb2lkCiAgICAgICAg\nQ2xhc3NNYXBwaW5nIHJlbE1hcHBpbmcgPSBmaWVsZC5nZXRUeXBlTWFwcGlu\nZygpOwogICAgICAgIE9iamVjdCBvaWQgPSBudWxsOwogICAgICAgIGlmIChy\nZWxNYXBwaW5nLmlzTWFwcGVkKCkgJiYgIWZpZWxkLmlzQmlNVG8xSlQoKSkg\neyAKICAgICAgICAgICAgb2lkID0gcmVsTWFwcGluZy5nZXRPYmplY3RJZChz\ndG9yZSwgcmVzLCBmaWVsZC5nZXRGb3JlaWduS2V5KCksCiAgICAgICAgICAg\nICAgICAgICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1hcHBp\nbmcuUE9MWV9GQUxTRSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAg\nICAgICAgQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAg\nICAgICAgICAgaWYgKHJlbE1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBlKCkgPT0g\nQ2xhc3NNYXBwaW5nLklEX0RBVEFTVE9SRSkgewogICAgICAgICAgICAgICAg\nbG9uZyBpZCA9IHJlcy5nZXRMb25nKGNvbHNbMF0pOwogICAgICAgICAgICAg\nICAgaWYgKCFyZXMud2FzTnVsbCgpKQogICAgICAgICAgICAgICAgICAgIG9p\nZCA9IHN0b3JlLm5ld0RhdGFTdG9yZUlkKGlkLCByZWxNYXBwaW5nLCB0cnVl\nKTsKICAgICAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAgICAvLyBh\ncHBsaWNhdGlvbiBpZAogICAgICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3Ro\nID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBPYmplY3QgdmFsID0gcmVz\nLmdldE9iamVjdChjb2xzWzBdLCBudWxsLCBudWxsKTsKICAgICAgICAgICAg\nICAgICAgICBpZiAodmFsICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAg\nICAgIG9pZCA9IEFwcGxpY2F0aW9uSWRzLmZyb21QS1ZhbHVlcyhuZXcgT2Jq\nZWN0W117IHZhbCB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVs\nTWFwcGluZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAg\nICAgICAgICAgIE9iamVjdFtdIHZhbHMgPSBuZXcgT2JqZWN0W2NvbHMubGVu\nZ3RoXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8\nIGNvbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAg\ndmFsc1tpXSA9IHJlcy5nZXRPYmplY3QoY29sc1tpXSwgbnVsbCwgbnVsbCk7\nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxzW2ldID09IG51bGwp\nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAg\nICAgICAgICAgICAgICAgaWYgKGkgPT0gY29scy5sZW5ndGggLSAxKQogICAg\nICAgICAgICAgICAgICAgICAgICAgICAgb2lkID0gQXBwbGljYXRpb25JZHMu\nZnJvbVBLVmFsdWVzKHZhbHMsIHJlbE1hcHBpbmcpOwogICAgICAgICAgICAg\nICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAg\nICAgIH0KCiAgICAgICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAgICAgICBz\nbS5zdG9yZU9iamVjdChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsKICAgICAg\nICBlbHNlCiAgICAgICAgICAgIHNtLnNldEludGVybWVkaWF0ZShmaWVsZC5n\nZXRJbmRleCgpLCBvaWQpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxvYWQo\nZmluYWwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgZmluYWwgSkRCQ1N0b3Jl\nIHN0b3JlLAogICAgICAgIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24g\nZmV0Y2gpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAg\nLy8gY2hlY2sgZm9yIGNhY2hlZCBvaWQgdmFsdWUsIG9yIGxvYWQgb2lkIGlm\nIG5vIHdheSB0byBqb2luCiAgICAgICAgaWYgKEJvb2xlYW4uVFJVRS5lcXVh\nbHMoX2ZrT2lkKSkgewogICAgICAgICAgICBPYmplY3Qgb2lkID0gc20uZ2V0\nSW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpOwogICAgICAgICAgICBp\nZiAob2lkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIE9iamVjdCB2YWwg\nPSBzdG9yZS5maW5kKG9pZCwgZmllbGQsIGZldGNoKTsKICAgICAgICAgICAg\nICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHZhbCk7CiAg\nICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9\nCgogICAgICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIHJlbHMgPSBmaWVsZC5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGZpbmFsIGlu\ndCBzdWJzID0gZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpOwogICAgICAg\nIGZpbmFsIEpvaW5zW10gcmVzSm9pbnMgPSBuZXcgSm9pbnNbcmVscy5sZW5n\ndGhdOwoKICAgICAgICAvLyBzZWxlY3QgcmVsYXRlZCBtYXBwaW5nIGNvbHVt\nbnM7IGpvaW5pbmcgZnJvbSB0aGUgcmVsYXRlZCB0eXBlCiAgICAgICAgLy8g\nYmFjayB0byBvdXIgZmsgdGFibGUgaWYgbm90IGFuIGludmVyc2UgbWFwcGlu\nZyAoaW4gd2hpY2ggY2FzZSB3ZQogICAgICAgIC8vIGNhbiBqdXN0IG1ha2Ug\nc3VyZSB0aGUgaW52ZXJzZSBjb2xzID09IG91ciBwayB2YWx1ZXMpCiAgICAg\nICAgVW5pb24gdW5pb24gPSBzdG9yZS5nZXRTUUxGYWN0b3J5KCkubmV3VW5p\nb24ocmVscy5sZW5ndGgpOwogICAgICAgIHVuaW9uLnNldEV4cGVjdGVkUmVz\ndWx0Q291bnQoMSwgZmFsc2UpOwogICAgICAgIGlmIChmZXRjaC5nZXRTdWJj\nbGFzc0ZldGNoTW9kZShmaWVsZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAg\nICAgICAhPSBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4pCiAg\nICAgICAgICAgIHVuaW9uLmFib3J0VW5pb24oKTsKICAgICAgICB1bmlvbi5z\nZWxlY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkgewogICAgICAgICAgICBwdWJs\naWMgdm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwgaW50IGlkeCkgewogICAgICAg\nICAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVs\nZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgICAgICAgICAgc2VsLndoZXJl\nRm9yZWlnbktleShmaWVsZC5nZXRGb3JlaWduS2V5KHJlbHNbaWR4XSksCiAg\nICAgICAgICAgICAgICAgICAgICAgIHNtLmdldE9iamVjdElkKCksIGZpZWxk\nLmdldERlZmluaW5nTWFwcGluZygpLCBzdG9yZSk7CiAgICAgICAgICAgICAg\nICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWZpZWxkLmlzQmlN\nVG8xSlQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXNKb2luc1tp\nZHhdID0gc2VsLm5ld0pvaW5zKCkuam9pblJlbGF0aW9uKGZpZWxkLmdldE5h\nbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldEZv\ncmVpZ25LZXkocmVsc1tpZHhdKSwgcmVsc1tpZHhdLAogICAgICAgICAgICAg\nICAgICAgICAgICAgICAgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBm\nYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC53\naGVyZVByaW1hcnlLZXkoc2VsLCBzbSwgc3RvcmUpOwogICAgICAgICAgICAg\nICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc0pv\naW5zW2lkeF0gPSBzZWwubmV3Sm9pbnMoKS5qb2luUmVsYXRpb24obnVsbCwK\nICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldEJpMVRvTUpv\naW5GSygpLCByZWxzW2lkeF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAg\nICBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7\nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbC53aGVyZUZvcmVpZ25LZXko\nZmllbGQuZ2V0QmkxVG9NRWxlbUZLKCksIHNtLmdldE9iamVjdElkKCksIAog\nICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdN\nYXBwaW5nKCksIHN0b3JlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWwuc2VsZWN0KHJlbHNb\naWR4XSwgc3Vicywgc3RvcmUsIGZldGNoLCBmZXRjaC5FQUdFUl9KT0lOLCAK\nICAgICAgICAgICAgICAgICAgICByZXNKb2luc1tpZHhdKTsKICAgICAgICAg\nICAgfQogICAgICAgIH0pOwoKICAgICAgICBSZXN1bHQgcmVzID0gdW5pb24u\nZXhlY3V0ZShzdG9yZSwgZmV0Y2gpOwogICAgICAgIHRyeSB7CiAgICAgICAg\nICAgIE9iamVjdCB2YWwgPSBudWxsOwogICAgICAgICAgICBpZiAocmVzLm5l\neHQoKSkKICAgICAgICAgICAgICAgIHZhbCA9IHJlcy5sb2FkKHJlbHNbcmVz\nLmluZGV4T2YoKV0sIHN0b3JlLCBmZXRjaCwKICAgICAgICAgICAgICAgICAg\nICByZXNKb2luc1tyZXMuaW5kZXhPZigpXSk7CiAgICAgICAgICAgIHNtLnN0\nb3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHZhbCk7CiAgICAgICAgfSBm\naW5hbGx5IHsKICAgICAgICAgICAgcmVzLmNsb3NlKCk7CiAgICAgICAgfQog\nICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9EYXRhU3RvcmVWYWx1ZShPYmpl\nY3QgdmFsLCBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICByZXR1cm4gUmVs\nYXRpb25TdHJhdGVnaWVzLnRvRGF0YVN0b3JlVmFsdWUoZmllbGQsIHZhbCwg\nc3RvcmUpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGFwcGVuZElzTnVsbChT\nUUxCdWZmZXIgc3FsLCBTZWxlY3Qgc2VsLCBKb2lucyBqb2lucykgewogICAg\nICAgIC8vIGlmIG5vIGludmVyc2UsIGp1c3Qgam9pbiB0byBtYXBwaW5nJ3Mg\ndGFibGUgKHVzdWFsbHkgYSBuby1vcAogICAgICAgIC8vIGJlY2F1c2UgaXQn\nbGwgYmUgaW4gdGhlIHByaW1hcnkgdGFibGUpIGFuZCBzZWUgaWYgZmsgY29s\ncyBhcmUgbnVsbDsKICAgICAgICAvLyBpZiBpbnZlcnNlLCB0aGVuIHdlIGhh\ndmUgdG8gZG8gYSBzdWItc2VsZWN0IHRvIHNlZSBpZiBhbnkgaW52ZXJzZQog\nICAgICAgIC8vIG9iamVjdHMgcG9pbnQgYmFjayB0byB0aGlzIGZpZWxkJ3Mg\nb3duZXIKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpICE9\nIGZpZWxkLkpPSU5fSU5WRVJTRSkgewogICAgICAgICAgICAvLyMjIyBwcm9i\nYWJseSBuZWVkIHNvbWUgc29ydCBvZiBzdWJzZWxlY3QgaGVyZSBvbiBmayBj\nb25zdGFudHMKICAgICAgICAgICAgam9pbnMgPSBqb2luKGpvaW5zLCBmYWxz\nZSk7CiAgICAgICAgICAgIENvbHVtbltdIGNvbHMgPSBmaWVsZC5nZXRDb2x1\nbW5zKCk7CiAgICAgICAgICAgIGlmIChjb2xzLmxlbmd0aCA9PSAwKQogICAg\nICAgICAgICAgICAgc3FsLmFwcGVuZCgiMSA8PiAxIik7CiAgICAgICAgICAg\nIGVsc2UKICAgICAgICAgICAgICAgIHNxbC5hcHBlbmQoc2VsLmdldENvbHVt\nbkFsaWFzKGNvbHNbMF0sIGpvaW5zKSkuCiAgICAgICAgICAgICAgICAgICAg\nYXBwZW5kKCIgSVMgIikuYXBwZW5kVmFsdWUobnVsbCwgY29sc1swXSk7CiAg\nICAgICAgfSBlbHNlCiAgICAgICAgICAgIHRlc3RJbnZlcnNlTnVsbChzcWws\nIHNlbCwgam9pbnMsIHRydWUpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGFw\ncGVuZElzTm90TnVsbChTUUxCdWZmZXIgc3FsLCBTZWxlY3Qgc2VsLCBKb2lu\ncyBqb2lucykgewogICAgICAgIC8vIGlmIG5vIGludmVyc2UsIGp1c3Qgam9p\nbiB0byBtYXBwaW5nJ3MgdGFibGUgKHVzdWFsbHkgYSBuby1vcAogICAgICAg\nIC8vIGJlY2F1c2UgaXQnbGwgYmUgaW4gdGhlIHByaW1hcnkgdGFibGUpIGFu\nZCBzZWUgaWYgZmsgY29scyBhcmVuJ3QKICAgICAgICAvLyBudWxsOyBpZiBp\nbnZlcnNlLCB0aGVuIHdlIGhhdmUgdG8gZG8gYSBzdWItc2VsZWN0IHRvIHNl\nZSBpZiBhbnkKICAgICAgICAvLyBpbnZlcnNlIG9iamVjdHMgcG9pbnQgYmFj\nayB0byB0aGlzIGZpZWxkJ3Mgb3duZXIKICAgICAgICBpZiAoZmllbGQuZ2V0\nSm9pbkRpcmVjdGlvbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRSkgewogICAg\nICAgICAgICAvLyMjIyBwcm9iYWJseSBuZWVkIHNvbWUgc29ydCBvZiBzdWJz\nZWxlY3QgaGVyZSBvbiBmayBjb25zdGFudHMKICAgICAgICAgICAgam9pbnMg\nPSBqb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAgIENvbHVtbltdIGNv\nbHMgPSBmaWVsZC5nZXRDb2x1bW5zKCk7CiAgICAgICAgICAgIGlmIChjb2xz\nLmxlbmd0aCA9PSAwKQogICAgICAgICAgICAgICAgc3FsLmFwcGVuZCgiMSA9\nIDEiKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgc3FsLmFw\ncGVuZChzZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwgam9pbnMpKS4KICAg\nICAgICAgICAgICAgICAgICBhcHBlbmQoIiBJUyBOT1QgIikuYXBwZW5kVmFs\ndWUobnVsbCwgY29sc1swXSk7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICAg\nIHRlc3RJbnZlcnNlTnVsbChzcWwsIHNlbCwgam9pbnMsIGZhbHNlKTsKICAg\nIH0KCiAgICAvKioKICAgICAqIEFwcGVuZCBTUUwgZm9yIGEgc3ViLXNlbGVj\ndCB0ZXN0aW5nIHdoZXRoZXIgYW4gaW52ZXJzZSBvYmplY3QgZXhpc3RzCiAg\nICAgKiBmb3IgdGhpcyByZWxhdGlvbi4KICAgICAqLwogICAgcHJpdmF0ZSB2\nb2lkIHRlc3RJbnZlcnNlTnVsbChTUUxCdWZmZXIgc3FsLCBTZWxlY3Qgc2Vs\nLCBKb2lucyBqb2lucywKICAgICAgICBib29sZWFuIGVtcHR5KSB7CiAgICAg\nICAgREJEaWN0aW9uYXJ5IGRpY3QgPSBmaWVsZC5nZXRNYXBwaW5nUmVwb3Np\ndG9yeSgpLmdldERCRGljdGlvbmFyeSgpOwogICAgICAgIGRpY3QuYXNzZXJ0\nU3VwcG9ydChkaWN0LnN1cHBvcnRzU3Vic2VsZWN0LCAiU3VwcG9ydHNTdWJz\nZWxlY3QiKTsKCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlw\nZU1hcHBpbmdzKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJl\nbGF0aW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwoKICAgICAg\nICBpZiAoZW1wdHkpCiAgICAgICAgICAgIHNxbC5hcHBlbmQoIjAgPSAiKTsK\nICAgICAgICBlbHNlCiAgICAgICAgICAgIHNxbC5hcHBlbmQoIjAgPCAiKTsK\nCiAgICAgICAgRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXko\nKTsKICAgICAgICBDb250YWluZXJGaWVsZFN0cmF0ZWd5LmFwcGVuZEpvaW5D\nb3VudChzcWwsIHNlbCwgam9pbnMsIGRpY3QsIGZpZWxkLAogICAgICAgICAg\nICBmayk7CiAgICB9CgogICAgcHVibGljIEpvaW5zIGpvaW4oSm9pbnMgam9p\nbnMsIGJvb2xlYW4gZm9yY2VPdXRlcikgewogICAgICAgIC8vIGlmIHdlJ3Jl\nIG5vdCBpbiBhbiBpbnZlcnNlIG9iamVjdCB0YWJsZSBqb2luIG5vcm1hbGx5\nLCBvdGhlcndpc2UKICAgICAgICAvLyBhbHJlYWR5IHRyYXZlcnNlZCB0aGUg\ncmVsYXRpb247IGp1c3Qgam9pbiBiYWNrIHRvIG93bmVyIHRhYmxlCiAgICAg\nICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSAhPSBmaWVsZC5KT0lO\nX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybiBmaWVsZC5qb2luKGpvaW5z\nLCBmb3JjZU91dGVyLCBmYWxzZSk7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10g\nY2xzcyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAg\nICAgICAgaWYgKGNsc3MubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93\nIFJlbGF0aW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwogICAg\nICAgIGlmIChmb3JjZU91dGVyKQogICAgICAgICAgICByZXR1cm4gam9pbnMu\nb3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAg\nICAgICAgZmllbGQuZ2V0Rm9yZWlnbktleSgpLCBjbHNzWzBdLCBmaWVsZC5n\nZXRTZWxlY3RTdWJjbGFzc2VzKCksIAogICAgICAgICAgICAgICAgdHJ1ZSwg\nZmFsc2UpOwogICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmll\nbGQuZ2V0TmFtZSgpLCBmaWVsZC5nZXRGb3JlaWduS2V5KCksCiAgICAgICAg\nICAgIGNsc3NbMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgdHJ1\nZSwgZmFsc2UpOwogICAgfQoKICAgIHB1YmxpYyBKb2lucyBqb2luUmVsYXRp\nb24oSm9pbnMgam9pbnMsIGJvb2xlYW4gZm9yY2VPdXRlciwKICAgICAgICBi\nb29sZWFuIHRyYXZlcnNlKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBp\nbnZlcnNlIG1hcHBpbmcgaXQncyBhbHJlYWR5IGpvaW5lZCB0byB0aGUgcmVs\nYXRpb24KICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09\nIGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJuIGpvaW5z\nOwogICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRl\ncGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGlmIChjbHNzLmxlbmd0\naCAhPSAxKSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZSkKICAgICAgICAg\nICAgICAgIHRocm93IFJlbGF0aW9uU3RyYXRlZ2llcy51bmpvaW5hYmxlKGZp\nZWxkKTsKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwogICAgICAgIH0KCiAg\nICAgICAgam9pbnMgPSBzZXRFbWJlZGRlZFZhcmlhYmxlKGpvaW5zKTsKICAg\nICAgICBpZiAoZm9yY2VPdXRlcikKICAgICAgICAgICAgcmV0dXJuIGpvaW5z\nLm91dGVySm9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwgCiAgICAgICAg\nICAgICAgICBmaWVsZC5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLCBjbHNzWzBd\nLCAKICAgICAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMo\nKSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICByZXR1cm4gam9pbnMuam9pblJl\nbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwgZmllbGQuZ2V0Rm9yZWlnbktleShj\nbHNzWzBdKSwKICAgICAgICAgICAgY2xzc1swXSwgZmllbGQuZ2V0U2VsZWN0\nU3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwogICAgfQoKICAgIC8vLy8v\nLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gSm9pbmFibGUgaW1wbGVt\nZW50YXRpb24KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAg\nIHB1YmxpYyBpbnQgZ2V0RmllbGRJbmRleCgpIHsKICAgICAgICByZXR1cm4g\nZmllbGQuZ2V0SW5kZXgoKTsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGdl\ndFByaW1hcnlLZXlWYWx1ZShSZXN1bHQgcmVzLCBDb2x1bW5bXSBjb2xzLCBG\nb3JlaWduS2V5IGZrLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgSm9pbnMg\nam9pbnMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAg\nQ2xhc3NNYXBwaW5nIHJlbG1hcHBpbmcgPSBmaWVsZC5nZXRUeXBlTWFwcGlu\nZygpOwogICAgICAgIGlmIChyZWxtYXBwaW5nLmdldElkZW50aXR5VHlwZSgp\nID09IENsYXNzTWFwcGluZy5JRF9EQVRBU1RPUkUpIHsKICAgICAgICAgICAg\nQ29sdW1uIGNvbCA9IGNvbHNbMF07CiAgICAgICAgICAgIGlmIChmayAhPSBu\ndWxsKQogICAgICAgICAgICAgICAgY29sID0gZmsuZ2V0Q29sdW1uKGNvbCk7\nICAgCiAgICAgICAgICAgIGxvbmcgaWQgPSByZXMuZ2V0TG9uZyhjb2wsIGpv\naW5zKTsKICAgICAgICAgICAgaWYgKGZpZWxkLmdldE9iamVjdElkRmllbGRU\neXBlQ29kZSgpID09IEphdmFUeXBlcy5MT05HKQogICAgICAgICAgICAgICAg\ncmV0dXJuIGlkOwogICAgICAgICAgICByZXR1cm4gc3RvcmUubmV3RGF0YVN0\nb3JlSWQoaWQsIHJlbG1hcHBpbmcsIGZpZWxkLmdldFBvbHltb3JwaGljKCkg\nCiAgICAgICAgICAgICAgICAhPSBWYWx1ZU1hcHBpbmcuUE9MWV9GQUxTRSk7\nCiAgICAgICAgfQoKICAgICAgICBpZiAocmVsbWFwcGluZy5pc09wZW5KUEFJ\nZGVudGl0eSgpKQogICAgICAgICAgICByZXR1cm4gKChKb2luYWJsZSkgcmVs\nbWFwcGluZy5nZXRQcmltYXJ5S2V5RmllbGRNYXBwaW5ncygpWzBdLgogICAg\nICAgICAgICAgICAgZ2V0U3RyYXRlZ3koKSkuZ2V0UHJpbWFyeUtleVZhbHVl\nKHJlcywgY29scywgZmssIHN0b3JlLCBqb2lucyk7CgogICAgICAgIGlmIChj\nb2xzID09IGdldENvbHVtbnMoKSAmJiBmayA9PSBudWxsKQogICAgICAgICAg\nICBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBlbHNlCiAg\nICAgICAgICAgIGZrID0gY3JlYXRlVHJhbnNsYXRpbmdGb3JlaWduS2V5KHJl\nbG1hcHBpbmcsIGNvbHMsIGZrKTsgCiAgICAgICAgcmV0dXJuIHJlbG1hcHBp\nbmcuZ2V0T2JqZWN0SWQoc3RvcmUsIHJlcywgZmssCiAgICAgICAgICAgIGZp\nZWxkLmdldFBvbHltb3JwaGljKCkgIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFM\nU0UsIGpvaW5zKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZSBhIGZh\ndXggZm9yZWlnbiBrZXkgdGhhdCB0cmFuc2xhdGVzIGJldHdlZW4gdGhlIGNv\nbHVtbnMgdG8gcHVsbAogICAgICogdGhlIGRhdGEgZnJvbSBhbmQgb3VyIHJl\nbGF0ZWQgdHlwZSdzIHByaW1hcnkga2V5IGNvbHVtbnMuCiAgICAgKi8KICAg\nIHByaXZhdGUgRm9yZWlnbktleSBjcmVhdGVUcmFuc2xhdGluZ0ZvcmVpZ25L\nZXkoQ2xhc3NNYXBwaW5nIHJlbG1hcHBpbmcsCiAgICAgICAgQ29sdW1uW10g\nZ2NvbHMsIEZvcmVpZ25LZXkgZ2ZrKSB7CiAgICAgICAgRm9yZWlnbktleSBm\nayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsgCiAgICAgICAgQ29sdW1uW10g\nY29scyA9IGZrLmdldENvbHVtbnMoKTsKCiAgICAgICAgRm9yZWlnbktleSB0\nZmsgPSBudWxsOwogICAgICAgIENvbHVtbiB0Y29sOwogICAgICAgIGZvciAo\naW50IGkgPSAwOyBpIDwgZ2NvbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAg\nICAgdGNvbCA9IGdjb2xzW2ldOwogICAgICAgICAgICBpZiAoZ2ZrICE9IG51\nbGwpCiAgICAgICAgICAgICAgICB0Y29sID0gZ2ZrLmdldENvbHVtbih0Y29s\nKTsKICAgICAgICAgICAgaWYgKHRmayA9PSBudWxsKQogICAgICAgICAgICAg\nICAgdGZrID0gbmV3IEZvcmVpZ25LZXkoREJJZGVudGlmaWVyLk5VTEwsIHRj\nb2wuZ2V0VGFibGUoKSk7CiAgICAgICAgICAgIHRmay5qb2luKHRjb2wsIGZr\nLmdldFByaW1hcnlLZXlDb2x1bW4oY29sc1tpXSkpOwogICAgICAgIH0KICAg\nICAgICByZXR1cm4gdGZrOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgZ2V0\nSm9pblZhbHVlKE9iamVjdCBmaWVsZFZhbCwgQ29sdW1uIGNvbCwgSkRCQ1N0\nb3JlIHN0b3JlKSB7CiAgICAgICAgT2JqZWN0IG8gPSBmaWVsZC5nZXRGb3Jl\naWduS2V5KCkuZ2V0Q29uc3RhbnQoY29sKTsKICAgICAgICBpZiAobyAhPSBu\ndWxsKQogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICBjb2wgPSBmaWVs\nZC5nZXRGb3JlaWduS2V5KCkuZ2V0UHJpbWFyeUtleUNvbHVtbihjb2wpOwog\nICAgICAgIGlmIChjb2wgPT0gbnVsbCkKICAgICAgICAgICAgdGhyb3cgbmV3\nIEludGVybmFsRXhjZXB0aW9uKCk7CiAgICAgICAgCiAgICAgICAgT2JqZWN0\nIHNhdmVkRmllbGRWYWwgPSBmaWVsZFZhbDsKCiAgICAgICAgQ2xhc3NNYXBw\naW5nIHJlbG1hcHBpbmcgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpOwogICAg\nICAgIEpvaW5hYmxlIGogPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpLmFzc2Vy\ndEpvaW5hYmxlKGNvbCk7CiAgICAgICAgaWYgKEltcGxIZWxwZXIuaXNNYW5h\nZ2VhYmxlKGZpZWxkVmFsKSAmJiAhZmllbGQuZ2V0RGVmaW5pbmdNZXRhRGF0\nYSgpLnVzZUlkQ2xhc3NGcm9tUGFyZW50KCkpCiAgICAgICAgICAgIGZpZWxk\nVmFsID0gc3RvcmUuZ2V0Q29udGV4dCgpLmdldE9iamVjdElkKGZpZWxkVmFs\nKTsKICAgICAgICBpZiAoZmllbGRWYWwgaW5zdGFuY2VvZiBPcGVuSlBBSWQp\nCiAgICAgICAgICAgIGZpZWxkVmFsID0gKChPcGVuSlBBSWQpIGZpZWxkVmFs\nKS5nZXRJZE9iamVjdCgpOwogICAgICAgIGlmIChyZWxtYXBwaW5nLmdldE9i\namVjdElkVHlwZSgpICE9IG51bGwKICAgICAgICAgICAgJiYgcmVsbWFwcGlu\nZy5nZXRPYmplY3RJZFR5cGUoKS5pc0luc3RhbmNlKGZpZWxkVmFsKSkgewog\nICAgICAgICAgICBPYmplY3RbXSBwa3MgPSBBcHBsaWNhdGlvbklkcy50b1BL\nVmFsdWVzKGZpZWxkVmFsLCByZWxtYXBwaW5nKTsKICAgICAgICAgICAgZmll\nbGRWYWwgPSBwa3NbcmVsbWFwcGluZy5nZXRGaWVsZChqLmdldEZpZWxkSW5k\nZXgoKSkuCiAgICAgICAgICAgICAgICBnZXRQcmltYXJ5S2V5SW5kZXgoKV07\nCiAgICAgICAgfSBlbHNlIGlmIChyZWxtYXBwaW5nLmdldE9iamVjdElkVHlw\nZSgpID09IE9iamVjdElkLmNsYXNzICYmIAogICAgICAgICAgICByZWxtYXBw\naW5nLmdldFByaW1hcnlLZXlGaWVsZE1hcHBpbmdzKClbMF0uZ2V0VmFsdWVN\nYXBwaW5nKCkuaXNFbWJlZGRlZCgpKSB7CiAgICAgICAgICAgIGlmIChmaWVs\nZFZhbCA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIGouZ2V0Sm9p\nblZhbHVlKHNhdmVkRmllbGRWYWwsIGNvbCwgc3RvcmUpOwogICAgICAgICAg\nICByZXR1cm4gai5nZXRKb2luVmFsdWUoZmllbGRWYWwsIGNvbCwgc3RvcmUp\nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gai5nZXRKb2luVmFsdWUoZmll\nbGRWYWwsIGNvbCwgc3RvcmUpOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3Qg\nZ2V0Sm9pblZhbHVlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIENvbHVtbiBj\nb2wsCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgcmV0dXJu\nIGdldEpvaW5WYWx1ZShzbS5mZXRjaChmaWVsZC5nZXRJbmRleCgpKSwgY29s\nLCBzdG9yZSk7CiAgICB9CgogICAgcHVibGljIHZvaWQgc2V0QXV0b0Fzc2ln\nbmVkVmFsdWUoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0\nb3JlLAogICAgICAgIENvbHVtbiBjb2wsIE9iamVjdCBhdXRvSW5jKSB7CiAg\nICAgICAgdGhyb3cgbmV3IFVuc3VwcG9ydGVkRXhjZXB0aW9uKCk7CiAgICB9\nCgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIEVt\nYmVkZGFibGUgaW1wbGVtZW50YXRpb24KICAgIC8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vLy8vLy8vCgogICAgcHVibGljIENvbHVtbltdIGdldENvbHVtbnMo\nKSB7CiAgICAgICAgcmV0dXJuIGZpZWxkLmdldENvbHVtbnMoKTsKICAgIH0K\nCiAgICBwdWJsaWMgQ29sdW1uSU8gZ2V0Q29sdW1uSU8oKSB7CiAgICAgICAg\ncmV0dXJuIGZpZWxkLmdldENvbHVtbklPKCk7CiAgICB9CgogICAgcHVibGlj\nIE9iamVjdFtdIGdldFJlc3VsdEFyZ3VtZW50cygpIHsKICAgICAgICByZXR1\ncm4gbnVsbDsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IHRvRW1iZWRkZWRE\nYXRhU3RvcmVWYWx1ZShPYmplY3QgdmFsLCBKREJDU3RvcmUgc3RvcmUpIHsK\nICAgICAgICByZXR1cm4gdG9EYXRhU3RvcmVWYWx1ZSh2YWwsIHN0b3JlKTsK\nICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IHRvRW1iZWRkZWRPYmplY3RWYWx1\nZShPYmplY3QgdmFsKSB7CiAgICAgICAgcmV0dXJuIFVOU1VQUE9SVEVEOwog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIGxvYWRFbWJlZGRlZChPcGVuSlBBU3Rh\ndGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRCQ0Zl\ndGNoQ29uZmlndXJhdGlvbiBmZXRjaCwgT2JqZWN0IHZhbCkKICAgICAgICB0\naHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVs\nTWFwcGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgT2Jq\nZWN0IG9pZDsKICAgICAgICBpZiAodmFsID09IG51bGwpCiAgICAgICAgICAg\nIG9pZCA9IG51bGw7CiAgICAgICAgZWxzZSBpZiAocmVsTWFwcGluZy5nZXRJ\nZGVudGl0eVR5cGUoKSA9PSBDbGFzc01hcHBpbmcuSURfREFUQVNUT1JFKQog\nICAgICAgICAgICBvaWQgPSBzdG9yZS5uZXdEYXRhU3RvcmVJZCgoKE51bWJl\ncikgdmFsKS5sb25nVmFsdWUoKSwgcmVsTWFwcGluZywKICAgICAgICAgICAg\nICAgIGZpZWxkLmdldFBvbHltb3JwaGljKCkgIT0gVmFsdWVNYXBwaW5nLlBP\nTFlfRkFMU0UpOwogICAgICAgIGVsc2UgewogICAgICAgICAgICBPYmplY3Rb\nXSBwa3MgPSAoZ2V0Q29sdW1ucygpLmxlbmd0aCA9PSAxKSA/IG5ldyBPYmpl\nY3RbXXsgdmFsIH0KICAgICAgICAgICAgICAgIDogKE9iamVjdFtdKSB2YWw7\nCiAgICAgICAgICAgIGJvb2xlYW4gbnVsbHMgPSB0cnVlOwogICAgICAgICAg\nICBmb3IgKGludCBpID0gMDsgbnVsbHMgJiYgaSA8IHBrcy5sZW5ndGg7IGkr\nKykKICAgICAgICAgICAgICAgIG51bGxzID0gcGtzW2ldID09IG51bGw7CiAg\nICAgICAgICAgIGlmIChudWxscykKICAgICAgICAgICAgICAgIG9pZCA9IG51\nbGw7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb2lkID0g\nQXBwbGljYXRpb25JZHMuZnJvbVBLVmFsdWVzKHBrcywgcmVsTWFwcGluZyk7\nCiAgICAgICAgICAgICAgICBpZiAoZmllbGQuZ2V0UG9seW1vcnBoaWMoKSA9\nPSBWYWx1ZU1hcHBpbmcuUE9MWV9GQUxTRQogICAgICAgICAgICAgICAgICAg\nICYmIG9pZCBpbnN0YW5jZW9mIE9wZW5KUEFJZCkgewogICAgICAgICAgICAg\nICAgICAgICgoT3BlbkpQQUlkKSBvaWQpLnNldE1hbmFnZWRJbnN0YW5jZVR5\ncGUocmVsTWFwcGluZy4KICAgICAgICAgICAgICAgICAgICAgICAgZ2V0RGVz\nY3JpYmVkVHlwZSgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAg\nfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAg\nICAgICBzbS5zdG9yZU9iamVjdChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsK\nICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaWYgKEphdmFUeXBlcy5tYXli\nZVBDKGZpZWxkLmdldFZhbHVlKCkpICYmCiAgICAgICAgICAgICAgICBmaWVs\nZC5nZXRFbGVtZW50KCkuZ2V0RW1iZWRkZWRNZXRhRGF0YSgpID09IG51bGwp\nIHsKICAgICAgICAgICAgICAgIE9iamVjdCBvYmogPSBzdG9yZS5maW5kKG9p\nZCwgZmllbGQsIGZldGNoKTsKICAgICAgICAgICAgICAgIHNtLnN0b3JlT2Jq\nZWN0KGZpZWxkLmdldEluZGV4KCksIG9iaik7CiAgICAgICAgICAgIH0gZWxz\nZSAgICAKICAgICAgICAgICAgICAgIHNtLnNldEludGVybWVkaWF0ZShmaWVs\nZC5nZXRJbmRleCgpLCBvaWQpOwogICAgICAgIH0KICAgIH0KfQo=\n","encoding":"base64"}

