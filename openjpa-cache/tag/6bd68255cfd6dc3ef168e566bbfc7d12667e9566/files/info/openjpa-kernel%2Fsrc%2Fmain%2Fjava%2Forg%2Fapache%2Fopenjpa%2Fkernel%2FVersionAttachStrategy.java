{"sha":"5813f78d0a17c16883f54c161890ca5b435d31c9","node_id":"MDQ6QmxvYjIwNjM2NDo1ODEzZjc4ZDBhMTdjMTY4ODNmNTRjMTYxODkwY2E1YjQzNWQzMWM5","size":13510,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/5813f78d0a17c16883f54c161890ca5b435d31c9","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEua2VybmVsOwoKaW1wb3J0IGph\ndmEudXRpbC5Db2xsZWN0aW9uOwppbXBvcnQgamF2YS51dGlsLkl0ZXJhdG9y\nOwppbXBvcnQgamF2YS51dGlsLk1hcDsKCmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuZW5oYW5jZS5QZXJzaXN0ZW5jZUNhcGFibGU7CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEuZW5oYW5jZS5TdGF0ZU1hbmFnZXI7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLnV0aWwuTG9jYWxpemVyOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLm1ldGEuQ2xhc3NNZXRhRGF0YTsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5tZXRhLkZpZWxkTWV0YURhdGE7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEubWV0YS5KYXZhVHlwZXM7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubWV0YS5WYWx1ZU1ldGFEYXRhOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuQXBwbGljYXRpb25JZHM7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5PYmplY3ROb3RGb3VuZEV4Y2Vw\ndGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS51dGlsLk9wdGltaXN0\naWNFeGNlcHRpb247CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5J\nbXBsSGVscGVyOwoKLyoqCiAqIEhhbmRsZXMgYXR0YWNoaW5nIGluc3RhbmNl\ncyB1c2luZyB2ZXJzaW9uIGFuZCBwcmltYXJ5IGtleSBmaWVsZHMuCiAqCiAq\nIEBub2phdmFkb2MKICogQGF1dGhvciBTdGV2ZSBLaW0KICovCmNsYXNzIFZl\ncnNpb25BdHRhY2hTdHJhdGVneQogICAgZXh0ZW5kcyBBdHRhY2hTdHJhdGVn\neQogICAgaW1wbGVtZW50cyBEZXRhY2hTdGF0ZSB7CgogICAgcHJpdmF0ZSBz\ndGF0aWMgZmluYWwgTG9jYWxpemVyIF9sb2MgPSBMb2NhbGl6ZXIuZm9yUGFj\na2FnZQogICAgICAgIChWZXJzaW9uQXR0YWNoU3RyYXRlZ3kuY2xhc3MpOwoK\nICAgIHByb3RlY3RlZCBPYmplY3QgZ2V0RGV0YWNoZWRPYmplY3RJZChBdHRh\nY2hNYW5hZ2VyIG1hbmFnZXIsCiAgICAgICAgT2JqZWN0IHRvQXR0YWNoKSB7\nCiAgICAgICAgQnJva2VyIGJyb2tlciA9IG1hbmFnZXIuZ2V0QnJva2VyKCk7\nCiAgICAgICAgQ2xhc3NNZXRhRGF0YSBtZXRhID0gYnJva2VyLmdldENvbmZp\nZ3VyYXRpb24oKS4KICAgICAgICAgICAgZ2V0TWV0YURhdGFSZXBvc2l0b3J5\nSW5zdGFuY2UoKS5nZXRNZXRhRGF0YSgKICAgICAgICAgICAgICAgIEltcGxI\nZWxwZXIuZ2V0TWFuYWdlZEluc3RhbmNlKHRvQXR0YWNoKS5nZXRDbGFzcygp\nLAogICAgICAgICAgICAgICAgYnJva2VyLmdldENsYXNzTG9hZGVyKCksIHRy\ndWUpOwogICAgICAgIHJldHVybiBBcHBsaWNhdGlvbklkcy5jcmVhdGUoSW1w\nbEhlbHBlci50b1BlcnNpc3RlbmNlQ2FwYWJsZSh0b0F0dGFjaCwKICAgICAg\nICAgICAgYnJva2VyLmdldENvbmZpZ3VyYXRpb24oKSksCiAgICAgICAgICAg\nIG1ldGEpOwogICAgfQoKICAgIHByb3RlY3RlZCB2b2lkIHByb3ZpZGVGaWVs\nZChPYmplY3QgdG9BdHRhY2gsIFN0YXRlTWFuYWdlckltcGwgc20sCiAgICAg\nICAgaW50IGZpZWxkKSB7CiAgICAgICAgc20ucHJvdmlkZUZpZWxkKEltcGxI\nZWxwZXIudG9QZXJzaXN0ZW5jZUNhcGFibGUodG9BdHRhY2gsCiAgICAgICAg\nICAgIHNtLmdldENvbnRleHQoKS5nZXRDb25maWd1cmF0aW9uKCkpLCB0aGlz\nLCBmaWVsZCk7CiAgICB9CgogICAgcHVibGljIE9iamVjdCBhdHRhY2goQXR0\nYWNoTWFuYWdlciBtYW5hZ2VyLCBPYmplY3QgdG9BdHRhY2gsCiAgICAgICAg\nQ2xhc3NNZXRhRGF0YSBtZXRhLCBQZXJzaXN0ZW5jZUNhcGFibGUgaW50bywg\nT3BlbkpQQVN0YXRlTWFuYWdlciBvd25lciwKICAgICAgICBWYWx1ZU1ldGFE\nYXRhIG93bmVyTWV0YSwgYm9vbGVhbiBleHBsaWNpdCkgewogICAgICAgIEJy\nb2tlckltcGwgYnJva2VyID0gbWFuYWdlci5nZXRCcm9rZXIoKTsKICAgICAg\nICBQZXJzaXN0ZW5jZUNhcGFibGUgcGMgPSBJbXBsSGVscGVyLnRvUGVyc2lz\ndGVuY2VDYXBhYmxlKHRvQXR0YWNoLAogICAgICAgICAgICBtZXRhLmdldFJl\ncG9zaXRvcnkoKS5nZXRDb25maWd1cmF0aW9uKCkpOwoKICAgICAgICBib29s\nZWFuIGVtYmVkZGVkID0gb3duZXJNZXRhICE9IG51bGwgJiYgb3duZXJNZXRh\nLmlzRW1iZWRkZWRQQygpOwogICAgICAgIGJvb2xlYW4gaXNOZXcgPSAhYnJv\na2VyLmlzRGV0YWNoZWQocGMpOwogICAgICAgIE9iamVjdCB2ZXJzaW9uID0g\nbnVsbDsKICAgICAgICBTdGF0ZU1hbmFnZXJJbXBsIHNtOwoKICAgICAgICAv\nLyBpZiB0aGUgc3RhdGUgbWFuYWdlciBmb3IgdGhlIGVtYmVkZGVkIGluc3Rh\nbmNlIGlzIG51bGwsIHRoZW4KICAgICAgICAvLyBpdCBzaG91bGQgYmUgdHJl\nYXRlZCBhcyBhIG5ldyBpbnN0YW5jZSAoc2luY2UgdGhlCiAgICAgICAgLy8g\nbmV3bHkgcGVyc2lzdGVkIG93bmVyIG1heSBjcmVhdGUgYSBuZXcgZW1iZWRk\nZWQgaW5zdGFuY2UKICAgICAgICAvLyBpbiB0aGUgY29uc3RydWN0b3IpOyBm\naXhlZCBidWcgIzEwNzUuCiAgICAgICAgLy8gYWxzbywgaWYgdGhlIHVzZXIg\naGFzIGF0dGFjaGVkIGEgZGV0YWNoZWQgb2JqIGZyb20gc29tZXdoZXJlCiAg\nICAgICAgLy8gZWxzZSBpbiB0aGUgZ3JhcGggdG8gYW4gZW1iZWRkZWQgZmll\nbGQgdGhhdCB3YXMgcHJldmlvdXNseSBudWxsLAogICAgICAgIC8vIGNvcHkg\naW50byBhIG5ldyBlbWJlZGRlZCBpbnN0YW5jZQogICAgICAgIGlmIChlbWJl\nZGRlZCAmJiAoaXNOZXcgfHwgaW50byA9PSBudWxsCiAgICAgICAgICAgIHx8\nIGJyb2tlci5nZXRTdGF0ZU1hbmFnZXIoaW50bykgPT0gbnVsbCkpIHsKICAg\nICAgICAgICAgaWYgKGludG8gPT0gbnVsbCkKICAgICAgICAgICAgICAgIGlu\ndG8gPSBwYy5wY05ld0luc3RhbmNlKG51bGwsIGZhbHNlKTsKICAgICAgICAg\nICAgc20gPSAoU3RhdGVNYW5hZ2VySW1wbCkgYnJva2VyLmVtYmVkKGludG8s\nIG51bGwsIG93bmVyLCBvd25lck1ldGEpOwogICAgICAgICAgICBpbnRvID0g\nc20uZ2V0UGVyc2lzdGVuY2VDYXBhYmxlKCk7CiAgICAgICAgfSBlbHNlIGlm\nIChpc05ldykgewogICAgICAgICAgICBzbSA9IHBlcnNpc3QobWFuYWdlciwg\ncGMsIG1ldGEsIEFwcGxpY2F0aW9uSWRzLmNyZWF0ZShwYywgbWV0YSksCiAg\nICAgICAgICAgICAgICBleHBsaWNpdCk7CiAgICAgICAgICAgIGludG8gPSBz\nbS5nZXRQZXJzaXN0ZW5jZUNhcGFibGUoKTsKICAgICAgICB9IGVsc2UgaWYg\nKCFlbWJlZGRlZCAmJiBpbnRvID09IG51bGwpIHsKICAgICAgICAgICAgT2Jq\nZWN0IGlkID0gZ2V0RGV0YWNoZWRPYmplY3RJZChtYW5hZ2VyLCB0b0F0dGFj\naCk7CiAgICAgICAgICAgIGlmIChpZCAhPSBudWxsKQogICAgICAgICAgICAg\nICAgaW50byA9CiAgICAgICAgICAgICAgICAgICAgSW1wbEhlbHBlci50b1Bl\ncnNpc3RlbmNlQ2FwYWJsZShicm9rZXIuZmluZChpZCwgdHJ1ZSwgbnVsbCks\nCiAgICAgICAgICAgICAgICAgICAgICAgIGJyb2tlci5nZXRDb25maWd1cmF0\naW9uKCkpOwogICAgICAgICAgICBpZiAoaW50byA9PSBudWxsKQogICAgICAg\nICAgICAgICAgdGhyb3cgbmV3IE9wdGltaXN0aWNFeGNlcHRpb24oX2xvYy5n\nZXQoImF0dGFjaC12ZXJzaW9uLWRlbCIsCiAgICAgICAgICAgICAgICAgICAg\nSW1wbEhlbHBlci5nZXRNYW5hZ2VkSW5zdGFuY2UocGMpLmdldENsYXNzKCks\nIGlkLCB2ZXJzaW9uKSkKICAgICAgICAgICAgICAgICAgICAuc2V0RmFpbGVk\nT2JqZWN0KHRvQXR0YWNoKTsKCiAgICAgICAgICAgIHNtID0gbWFuYWdlci5h\nc3NlcnRNYW5hZ2VkKGludG8pOwogICAgICAgICAgICBpZiAobWV0YS5nZXRE\nZXNjcmliZWRUeXBlKCkKICAgICAgICAgICAgICAgICE9IHNtLmdldE1ldGFE\nYXRhKCkuZ2V0RGVzY3JpYmVkVHlwZSgpKSB7CiAgICAgICAgICAgICAgICB0\naHJvdyBuZXcgT2JqZWN0Tm90Rm91bmRFeGNlcHRpb24oX2xvYy5nZXQKICAg\nICAgICAgICAgICAgICAgICAoImF0dGFjaC13cm9uZ2NsYXNzIiwgaWQsIHRv\nQXR0YWNoLmdldENsYXNzKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHNt\nLmdldE1ldGFEYXRhKCkuZ2V0RGVzY3JpYmVkVHlwZSgpKSkuCiAgICAgICAg\nICAgICAgICAgICAgc2V0RmFpbGVkT2JqZWN0KHRvQXR0YWNoKTsKICAgICAg\nICAgICAgfQogICAgICAgIH0gZWxzZQogICAgICAgICAgICBzbSA9IG1hbmFn\nZXIuYXNzZXJ0TWFuYWdlZChpbnRvKTsKCiAgICAgICAgLy8gbWFyayB0aGF0\nIHdlIGF0dGFjaGVkIHRoZSBpbnN0YW5jZSAqYmVmb3JlKiB3ZQogICAgICAg\nIC8vIGZpbGwgaW4gdmFsdWVzIHRvIGF2b2lkIGVuZGxlc3MgcmVjdXJzaW9u\nCiAgICAgICAgbWFuYWdlci5zZXRBdHRhY2hlZENvcHkodG9BdHRhY2gsIGlu\ndG8pOwoKICAgICAgICAvLyBpZiBwZXJzaXN0aW5nIGluIHBsYWNlLCBqdXN0\nIGF0dGFjaCBmaWVsZCB2YWx1ZXMKICAgICAgICBpZiAocGMgPT0gaW50bykg\newogICAgICAgICAgICBhdHRhY2hGaWVsZHNJblBsYWNlKG1hbmFnZXIsIHNt\nKTsKICAgICAgICAgICAgcmV0dXJuIGludG87CiAgICAgICAgfQoKICAgICAg\nICAvLyBpbnZva2UgYW55IHByZUF0dGFjaCBvbiB0aGUgZGV0YWNoZWQgaW5z\ndGFuY2UKICAgICAgICBtYW5hZ2VyLmZpcmVCZWZvcmVBdHRhY2godG9BdHRh\nY2gsIG1ldGEpOwoKICAgICAgICAvLyBhc3NpZ24gdGhlIGRldGFjaGVkIHBj\nIHRoZSBzYW1lIHN0YXRlIG1hbmFnZXIgYXMgdGhlIG9iamVjdCB3ZSdyZQog\nICAgICAgIC8vIGNvcHlpbmcgaW50byBkdXJpbmcgdGhlIGF0dGFjaCBwcm9j\nZXNzCiAgICAgICAgU3RhdGVNYW5hZ2VyIHNtQmVmb3JlID0gcGMucGNHZXRT\ndGF0ZU1hbmFnZXIoKTsKICAgICAgICBwYy5wY1JlcGxhY2VTdGF0ZU1hbmFn\nZXIoc20pOwogICAgICAgIGludCBkZXRhY2ggPSAoaXNOZXcpID8gREVUQUNI\nX0FMTCA6IGJyb2tlci5nZXREZXRhY2hTdGF0ZSgpOwogICAgICAgIEZldGNo\nQ29uZmlndXJhdGlvbiBmZXRjaCA9IGJyb2tlci5nZXRGZXRjaENvbmZpZ3Vy\nYXRpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBGaWVsZE1ldGFE\nYXRhW10gZm1kcyA9IG1ldGEuZ2V0RmllbGRzKCk7CiAgICAgICAgICAgIGZv\nciAoaW50IGkgPSAwOyBpIDwgZm1kcy5sZW5ndGg7IGkrKykgewogICAgICAg\nICAgICAgICAgc3dpdGNoIChkZXRhY2gpIHsKICAgICAgICAgICAgICAgICAg\nICBjYXNlIERFVEFDSF9BTEw6CiAgICAgICAgICAgICAgICAgICAgICAgIGF0\ndGFjaEZpZWxkKG1hbmFnZXIsIHRvQXR0YWNoLCBzbSwgZm1kc1tpXSwgdHJ1\nZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAg\nICAgICAgICAgIGNhc2UgREVUQUNIX0ZFVENIX0dST1VQUzoKICAgICAgICAg\nICAgICAgICAgICAgICAgaWYgKGZldGNoLnJlcXVpcmVzRmV0Y2goZm1kc1tp\nXSkgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAhPSBGZXRjaENvbmZp\nZ3VyYXRpb24uRkVUQ0hfTk9ORSkKICAgICAgICAgICAgICAgICAgICAgICAg\nICAgIGF0dGFjaEZpZWxkKG1hbmFnZXIsIHRvQXR0YWNoLCBzbSwgZm1kc1tp\nXSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAg\nICAgICAgICAgICAgICAgIGNhc2UgREVUQUNIX0xPQURFRDoKICAgICAgICAg\nICAgICAgICAgICAgICAgYXR0YWNoRmllbGQobWFuYWdlciwgdG9BdHRhY2gs\nIHNtLCBmbWRzW2ldLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAg\nIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAg\nICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcGMucGNSZXBsYWNlU3RhdGVN\nYW5hZ2VyKHNtQmVmb3JlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFlbWJl\nZGRlZCAmJiAhaXNOZXcpCiAgICAgICAgICAgIGNvbXBhcmVWZXJzaW9uKHNt\nLCBwYyk7CiAgICAgICAgcmV0dXJuIEltcGxIZWxwZXIuZ2V0TWFuYWdlZElu\nc3RhbmNlKGludG8pOwogICAgfQoKICAgIC8qKgogICAgICogTWFrZSBzdXJl\nIHRoZSB2ZXJzaW9uIGluZm9ybWF0aW9uIGlzIGNvcnJlY3QgaW4gdGhlIGRl\ndGFjaGVkIG9iamVjdC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIGNvbXBh\ncmVWZXJzaW9uKFN0YXRlTWFuYWdlckltcGwgc20sIFBlcnNpc3RlbmNlQ2Fw\nYWJsZSBwYykgewogICAgICAgIE9iamVjdCB2ZXJzaW9uID0gcGMucGNHZXRW\nZXJzaW9uKCk7CiAgICAgICAgaWYgKHZlcnNpb24gPT0gbnVsbCkKICAgICAg\nICAgICAgcmV0dXJuOwoKICAgICAgICAvLyBkb24ndCBuZWVkIHRvIGxvYWQg\ndW5sb2FkZWQgZmllbGRzIHNpbmNlIGl0cyBpbXBsaWNpdGx5CiAgICAgICAg\nLy8gYSBzaW5nbGUgZmllbGQgdmFsdWUKICAgICAgICBTdG9yZU1hbmFnZXIg\nc3RvcmUgPSBzbS5nZXRCcm9rZXIoKS5nZXRTdG9yZU1hbmFnZXIoKTsKICAg\nICAgICBzd2l0Y2ggKHN0b3JlLmNvbXBhcmVWZXJzaW9uKHNtLCB2ZXJzaW9u\nLCBzbS5nZXRWZXJzaW9uKCkpKSB7CiAgICAgICAgICAgIGNhc2UgU3RvcmVN\nYW5hZ2VyLlZFUlNJT05fTEFURVI6CiAgICAgICAgICAgICAgICAvLyB3ZSBo\nYXZlIGEgbGF0ZXIgdmVyc2lvbjogc2V0IGl0IGludG8gdGhlIG9iamVjdC4K\nICAgICAgICAgICAgICAgIC8vIGxvY2sgdmFsaWRhdGlvbiB3aWxsIG9jY3Vy\nIGF0IGNvbW1pdCB0aW1lCiAgICAgICAgICAgICAgICBzbS5zZXRWZXJzaW9u\nKHZlcnNpb24pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAg\nIGNhc2UgU3RvcmVNYW5hZ2VyLlZFUlNJT05fRUFSTElFUjoKICAgICAgICAg\nICAgY2FzZSBTdG9yZU1hbmFnZXIuVkVSU0lPTl9ESUZGRVJFTlQ6CiAgICAg\nICAgICAgICAgICBzbS5zZXRWZXJzaW9uKHZlcnNpb24pOwogICAgICAgICAg\nICAgICAgdGhyb3cgbmV3IE9wdGltaXN0aWNFeGNlcHRpb24oc20uZ2V0TWFu\nYWdlZEluc3RhbmNlKCkpOwogICAgICAgICAgICBjYXNlIFN0b3JlTWFuYWdl\nci5WRVJTSU9OX1NBTUU6CiAgICAgICAgICAgICAgICAvLyBubyBhY3Rpb24g\ncmVxdWlyZWQKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAg\nIH0KCiAgICAvKioKICAgICAqIEF0dGFjaCB0aGUgZmllbGRzIG9mIGFuIGlu\nLXBsYWNlIHBlcnNpc3RlZCBpbnN0YW5jZS4KICAgICAqLwogICAgcHJpdmF0\nZSB2b2lkIGF0dGFjaEZpZWxkc0luUGxhY2UoQXR0YWNoTWFuYWdlciBtYW5h\nZ2VyLAogICAgICAgIFN0YXRlTWFuYWdlckltcGwgc20pIHsKICAgICAgICBG\naWVsZE1ldGFEYXRhW10gZm1kcyA9IHNtLmdldE1ldGFEYXRhKCkuZ2V0Rmll\nbGRzKCk7CiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBmbWRzLmxlbmd0\naDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChmbWRzW2ldLmdldE1hbmFnZW1l\nbnQoKSAhPSBGaWVsZE1ldGFEYXRhLk1BTkFHRV9QRVJTSVNURU5UKQogICAg\nICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICBPYmplY3QgY3Vy\nLCBhdHRhY2hlZDsKICAgICAgICAgICAgc3dpdGNoIChmbWRzW2ldLmdldERl\nY2xhcmVkVHlwZUNvZGUoKSkgewogICAgICAgICAgICAgICAgY2FzZSBKYXZh\nVHlwZXMuUEM6CiAgICAgICAgICAgICAgICBjYXNlIEphdmFUeXBlcy5QQ19V\nTlRZUEVEOgogICAgICAgICAgICAgICAgICAgIGN1ciA9IHNtLmZldGNoT2Jq\nZWN0RmllbGQoaSk7CiAgICAgICAgICAgICAgICAgICAgYXR0YWNoZWQgPSBh\ndHRhY2hJblBsYWNlKG1hbmFnZXIsIHNtLCBmbWRzW2ldLCBjdXIpOwogICAg\nICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBK\nYXZhVHlwZXMuQVJSQVk6CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmbWRz\nW2ldLmdldEVsZW1lbnQoKS5pc0RlY2xhcmVkVHlwZVBDKCkpCiAgICAgICAg\nICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAg\nIGN1ciA9IHNtLmZldGNoT2JqZWN0RmllbGQoaSk7CiAgICAgICAgICAgICAg\nICAgICAgYXR0YWNoZWQgPQogICAgICAgICAgICAgICAgICAgICAgICBhdHRh\nY2hJblBsYWNlKG1hbmFnZXIsIHNtLCBmbWRzW2ldLCAoT2JqZWN0W10pIGN1\ncik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAg\nICBjYXNlIEphdmFUeXBlcy5DT0xMRUNUSU9OOgogICAgICAgICAgICAgICAg\nICAgIGlmICghZm1kc1tpXS5nZXRFbGVtZW50KCkuaXNEZWNsYXJlZFR5cGVQ\nQygpKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAg\nICAgICAgICAgICAgICBjdXIgPSBzbS5mZXRjaE9iamVjdEZpZWxkKGkpOwog\nICAgICAgICAgICAgICAgICAgIGF0dGFjaGVkID0gYXR0YWNoSW5QbGFjZSht\nYW5hZ2VyLCBzbSwgZm1kc1tpXSwKICAgICAgICAgICAgICAgICAgICAgICAg\nKENvbGxlY3Rpb24pIGN1cik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7\nCiAgICAgICAgICAgICAgICBjYXNlIEphdmFUeXBlcy5NQVA6CiAgICAgICAg\nICAgICAgICAgICAgaWYgKCFmbWRzW2ldLmdldEVsZW1lbnQoKS5pc0RlY2xh\ncmVkVHlwZVBDKCkKICAgICAgICAgICAgICAgICAgICAgICAgJiYgIWZtZHNb\naV0uZ2V0S2V5KCkuaXNEZWNsYXJlZFR5cGVQQygpKQogICAgICAgICAgICAg\nICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICBjdXIg\nPSBzbS5mZXRjaE9iamVjdEZpZWxkKGkpOwogICAgICAgICAgICAgICAgICAg\nIGF0dGFjaGVkID0gYXR0YWNoSW5QbGFjZShtYW5hZ2VyLCBzbSwgZm1kc1tp\nXSwgKE1hcCkgY3VyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAg\nICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29u\ndGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXIgIT0g\nYXR0YWNoZWQpCiAgICAgICAgICAgICAgICBzbS5zZXR0aW5nT2JqZWN0Rmll\nbGQoc20uZ2V0UGVyc2lzdGVuY2VDYXBhYmxlKCksIGksCiAgICAgICAgICAg\nICAgICAgICAgY3VyLCBhdHRhY2hlZCwgU3RhdGVNYW5hZ2VyLlNFVF9SRU1P\nVEUpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEF0dGFjaCB0\naGUgZ2l2ZW4gcGMuCiAgICAgKi8KICAgIHByaXZhdGUgT2JqZWN0IGF0dGFj\naEluUGxhY2UoQXR0YWNoTWFuYWdlciBtYW5hZ2VyLCBTdGF0ZU1hbmFnZXJJ\nbXBsIHNtLAogICAgICAgIFZhbHVlTWV0YURhdGEgdm1kLCBPYmplY3QgcGMp\nIHsKICAgICAgICBpZiAocGMgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJu\nIG51bGw7CiAgICAgICAgT2JqZWN0IGF0dGFjaGVkID0gbWFuYWdlci5nZXRB\ndHRhY2hlZENvcHkocGMpOwogICAgICAgIGlmIChhdHRhY2hlZCAhPSBudWxs\nKQogICAgICAgICAgICByZXR1cm4gYXR0YWNoZWQ7CgogICAgICAgIE9wZW5K\nUEFTdGF0ZU1hbmFnZXIgaW50byA9IG1hbmFnZXIuZ2V0QnJva2VyKCkuZ2V0\nU3RhdGVNYW5hZ2VyKHBjKTsKICAgICAgICBQZXJzaXN0ZW5jZUNhcGFibGUg\naW50b1BDID0gKGludG8gPT0gbnVsbCkgPyBudWxsCiAgICAgICAgICAgIDog\naW50by5nZXRQZXJzaXN0ZW5jZUNhcGFibGUoKTsKICAgICAgICBpZiAodm1k\nLmlzRW1iZWRkZWQoKSkKICAgICAgICAgICAgcmV0dXJuIG1hbmFnZXIuYXR0\nYWNoKHBjLCBpbnRvUEMsIHNtLCB2bWQsIGZhbHNlKTsKICAgICAgICByZXR1\ncm4gbWFuYWdlci5hdHRhY2gocGMsIGludG9QQywgbnVsbCwgbnVsbCwgZmFs\nc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQXR0YWNoIHRoZSBnaXZlbiBh\ncnJheS4KICAgICAqLwogICAgcHJpdmF0ZSBPYmplY3RbXSBhdHRhY2hJblBs\nYWNlKEF0dGFjaE1hbmFnZXIgbWFuYWdlciwgU3RhdGVNYW5hZ2VySW1wbCBz\nbSwKICAgICAgICBGaWVsZE1ldGFEYXRhIGZtZCwgT2JqZWN0W10gYXJyKSB7\nCiAgICAgICAgaWYgKGFyciA9PSBudWxsKQogICAgICAgICAgICByZXR1cm4g\nbnVsbDsKCiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBhcnIubGVuZ3Ro\nOyBpKyspCiAgICAgICAgICAgIGFycltpXSA9IGF0dGFjaEluUGxhY2UobWFu\nYWdlciwgc20sIGZtZC5nZXRFbGVtZW50KCksIGFycltpXSk7CiAgICAgICAg\ncmV0dXJuIGFycjsKICAgIH0KCiAgICAvKioKICAgICAqIEF0dGFjaCB0aGUg\nZ2l2ZW4gY29sbGVjdGlvbi4KICAgICAqLwogICAgcHJpdmF0ZSBDb2xsZWN0\naW9uIGF0dGFjaEluUGxhY2UoQXR0YWNoTWFuYWdlciBtYW5hZ2VyLAogICAg\nICAgIFN0YXRlTWFuYWdlckltcGwgc20sIEZpZWxkTWV0YURhdGEgZm1kLCBD\nb2xsZWN0aW9uIGNvbGwpIHsKICAgICAgICBpZiAoY29sbCA9PSBudWxsIHx8\nIGNvbGwuaXNFbXB0eSgpKQogICAgICAgICAgICByZXR1cm4gY29sbDsKCiAg\nICAgICAgLy8gY29weSBpZiBlbGVtZW50cyBlbWJlZGRlZCBvciBjb250YWlu\ncyBkZXRhY2hlZCwgd2hpY2ggd2lsbCBtZWFuCiAgICAgICAgLy8gd2UnbGwg\naGF2ZSB0byBjb3B5IHRoZSBleGlzdGluZyBlbGVtZW50cwogICAgICAgIENv\nbGxlY3Rpb24gY29weSA9IG51bGw7CiAgICAgICAgaWYgKGZtZC5nZXRFbGVt\nZW50KCkuaXNFbWJlZGRlZCgpKQogICAgICAgICAgICBjb3B5ID0gKENvbGxl\nY3Rpb24pIHNtLm5ld0ZpZWxkUHJveHkoZm1kLmdldEluZGV4KCkpOwogICAg\nICAgIGVsc2UgewogICAgICAgICAgICBmb3IgKEl0ZXJhdG9yIGl0ciA9IGNv\nbGwuaXRlcmF0b3IoKTsgaXRyLmhhc05leHQoKTspIHsKICAgICAgICAgICAg\nICAgIGlmIChtYW5hZ2VyLmdldEJyb2tlcigpLmlzRGV0YWNoZWQoaXRyLm5l\neHQoKSkpIHsKICAgICAgICAgICAgICAgICAgICBjb3B5ID0gKENvbGxlY3Rp\nb24pIHNtLm5ld0ZpZWxkUHJveHkoZm1kLmdldEluZGV4KCkpOwogICAgICAg\nICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAg\nICAgICB9CiAgICAgICAgfQoKICAgICAgICBPYmplY3QgYXR0YWNoZWQ7CiAg\nICAgICAgZm9yIChJdGVyYXRvciBpdHIgPSBjb2xsLml0ZXJhdG9yKCk7IGl0\nci5oYXNOZXh0KCk7KSB7CiAgICAgICAgICAgIGF0dGFjaGVkID0gYXR0YWNo\nSW5QbGFjZShtYW5hZ2VyLCBzbSwgZm1kLmdldEVsZW1lbnQoKSwKICAgICAg\nICAgICAgICAgIGl0ci5uZXh0KCkpOwogICAgICAgICAgICBpZiAoY29weSAh\nPSBudWxsKQogICAgICAgICAgICAgICAgY29weS5hZGQoYXR0YWNoZWQpOwog\nICAgICAgIH0KICAgICAgICByZXR1cm4gKGNvcHkgPT0gbnVsbCkgPyBjb2xs\nIDogY29weTsKICAgIH0KCiAgICAvKioKICAgICAqIEF0dGFjaCB0aGUgZ2l2\nZW4gbWFwLgogICAgICovCiAgICBwcml2YXRlIE1hcCBhdHRhY2hJblBsYWNl\nKEF0dGFjaE1hbmFnZXIgbWFuYWdlciwgU3RhdGVNYW5hZ2VySW1wbCBzbSwK\nICAgICAgICBGaWVsZE1ldGFEYXRhIGZtZCwgTWFwIG1hcCkgewogICAgICAg\nIGlmIChtYXAgPT0gbnVsbCB8fCBtYXAuaXNFbXB0eSgpKQogICAgICAgICAg\nICByZXR1cm4gbWFwOwoKICAgICAgICBNYXAgY29weSA9IG51bGw7CiAgICAg\nICAgTWFwLkVudHJ5IGVudHJ5OwogICAgICAgIGJvb2xlYW4ga2V5UEMgPSBm\nbWQuZ2V0S2V5KCkuaXNEZWNsYXJlZFR5cGVQQygpOwogICAgICAgIGJvb2xl\nYW4gdmFsUEMgPSBmbWQuZ2V0RWxlbWVudCgpLmlzRGVjbGFyZWRUeXBlUEMo\nKTsKCiAgICAgICAgLy8gY29weSBpZiBlbWJlZGRlZCBwY3Mgb3IgZGV0YWNo\nZWQgcGNzLCB3aGljaCB3aWxsIHJlcXVpcmUgdXMgdG8KICAgICAgICAvLyBj\nb3B5IGVsZW1lbnRzCiAgICAgICAgaWYgKGZtZC5nZXRLZXkoKS5pc0VtYmVk\nZGVkUEMoKSB8fCBmbWQuZ2V0RWxlbWVudCgpLmlzRW1iZWRkZWRQQygpKQog\nICAgICAgICAgICBjb3B5ID0gKE1hcCkgc20ubmV3RmllbGRQcm94eShmbWQu\nZ2V0SW5kZXgoKSk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGZvciAo\nSXRlcmF0b3IgaXRyID0gbWFwLmVudHJ5U2V0KCkuaXRlcmF0b3IoKTsgaXRy\nLmhhc05leHQoKTspIHsKICAgICAgICAgICAgICAgIGVudHJ5ID0gKE1hcC5F\nbnRyeSkgaXRyLm5leHQoKTsKICAgICAgICAgICAgICAgIGlmICgoa2V5UEMg\nJiYgbWFuYWdlci5nZXRCcm9rZXIoKS5pc0RldGFjaGVkKGVudHJ5LmdldEtl\neSgpKSkKICAgICAgICAgICAgICAgICAgICB8fCAodmFsUEMgJiYgbWFuYWdl\nci5nZXRCcm9rZXIoKS5pc0RldGFjaGVkCiAgICAgICAgICAgICAgICAgICAg\nKGVudHJ5LmdldFZhbHVlKCkpKSkgewogICAgICAgICAgICAgICAgICAgIGNv\ncHkgPSAoTWFwKSBzbS5uZXdGaWVsZFByb3h5KGZtZC5nZXRJbmRleCgpKTsK\nICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0K\nICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgT2JqZWN0IGtleSwg\ndmFsOwogICAgICAgIGZvciAoSXRlcmF0b3IgaXRyID0gbWFwLmVudHJ5U2V0\nKCkuaXRlcmF0b3IoKTsgaXRyLmhhc05leHQoKTspIHsKICAgICAgICAgICAg\nZW50cnkgPSAoTWFwLkVudHJ5KSBpdHIubmV4dCgpOwogICAgICAgICAgICBr\nZXkgPSBlbnRyeS5nZXRLZXkoKTsKICAgICAgICAgICAgaWYgKGtleVBDKQog\nICAgICAgICAgICAgICAga2V5ID0gYXR0YWNoSW5QbGFjZShtYW5hZ2VyLCBz\nbSwgZm1kLmdldEtleSgpLCBrZXkpOwogICAgICAgICAgICB2YWwgPSBlbnRy\neS5nZXRWYWx1ZSgpOwogICAgICAgICAgICBpZiAodmFsUEMpCiAgICAgICAg\nICAgICAgICB2YWwgPSBhdHRhY2hJblBsYWNlKG1hbmFnZXIsIHNtLCBmbWQu\nZ2V0RWxlbWVudCgpLCB2YWwpOwogICAgICAgICAgICBpZiAoY29weSAhPSBu\ndWxsKQogICAgICAgICAgICAgICAgY29weS5wdXQoa2V5LCB2YWwpOwogICAg\nICAgIH0KICAgICAgICByZXR1cm4gKGNvcHkgPT0gbnVsbCkgPyBtYXAgOiBj\nb3B5OwoJfQp9Cg==\n","encoding":"base64"}

