{"sha":"90d352ec610597c18dbc8a0e2593cac6c88e484a","node_id":"MDQ6QmxvYjIwNjM2NDo5MGQzNTJlYzYxMDU5N2MxOGRiYzhhMGUyNTkzY2FjNmM4OGU0ODRh","size":22673,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/90d352ec610597c18dbc8a0e2593cac6c88e484a","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwpwYWNr\nYWdlIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuc3RyYXRzOwoKaW1w\nb3J0IGphdmEuc3FsLio7CmltcG9ydCBqYXZhLnV0aWwuKjsKCmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLnV0aWwuKjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS5tZXRhLio7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\na2VybmVsLio7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC4qOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmVuaGFuY2UuUGVyc2lzdGVuY2VD\nYXBhYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS4q\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuaWRlbnRpZmllci5E\nQklkZW50aWZpZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5r\nZXJuZWwuKjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNjaGVt\nYS4qOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc3FsLio7Cgov\nKioKICogPHA+TWFwcGluZyBmb3IgYSBtYXAgd2hvc2Uga2V5cyBhbmQgdmFs\ndWVzIGFyZSBib3RoIHJlbGF0aW9ucyB0byBvdGhlcgogKiBwZXJzaXN0ZW50\nIG9iamVjdHMuPC9wPgogKgogKiBAYXV0aG9yIEFiZSBXaGl0ZQogKiBAc2lu\nY2UgMC40LjAsIDEuMS4wCiAqLwpwdWJsaWMgY2xhc3MgUmVsYXRpb25SZWxh\ndGlvbk1hcFRhYmxlRmllbGRTdHJhdGVneQogICAgZXh0ZW5kcyBNYXBUYWJs\nZUZpZWxkU3RyYXRlZ3kgewoKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIExv\nY2FsaXplciBfbG9jID0gTG9jYWxpemVyLmZvclBhY2thZ2UKICAgICAgICAo\nUmVsYXRpb25SZWxhdGlvbk1hcFRhYmxlRmllbGRTdHJhdGVneS5jbGFzcyk7\nCgogICAgcHJpdmF0ZSBTdHJpbmcgX2tleVJlbGF0aW9uTmFtZSA9IG51bGw7\nCgogICAgcHVibGljIENvbHVtbltdIGdldEtleUNvbHVtbnMoQ2xhc3NNYXBw\naW5nIGNscykgewogICAgICAgIHJldHVybiBmaWVsZC5nZXRLZXlNYXBwaW5n\nKCkuZ2V0Q29sdW1ucygpOwogICAgfQoKICAgIHB1YmxpYyBDb2x1bW5bXSBn\nZXRWYWx1ZUNvbHVtbnMoQ2xhc3NNYXBwaW5nIGNscykgewogICAgICAgIHJl\ndHVybiBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdldENvbHVtbnMoKTsK\nICAgIH0KCiAgICBwdWJsaWMgdm9pZCBzZWxlY3RLZXkoU2VsZWN0IHNlbCwg\nQ2xhc3NNYXBwaW5nIGtleSwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwKICAg\nICAgICBKREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24g\nZmV0Y2gsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAgc2VsLnNlbGVjdChrZXks\nIGZpZWxkLmdldEtleU1hcHBpbmcoKS5nZXRTZWxlY3RTdWJjbGFzc2VzKCks\nCiAgICAgICAgICAgIHN0b3JlLCBmZXRjaCwgSkRCQ0ZldGNoQ29uZmlndXJh\ndGlvbi5FQUdFUl9OT05FLCBqb2lucyk7CiAgICB9CgogICAgcHVibGljIHZv\naWQgc2VsZWN0VmFsdWUoU2VsZWN0IHNlbCwgQ2xhc3NNYXBwaW5nIHZhbCwK\nICAgICAgICBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3Rv\ncmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIAogICAgICAgIEpv\naW5zIGpvaW5zKSB7CiAgICAgICAgc2VsLnNlbGVjdCh2YWwsIGZpZWxkLmdl\ndEVsZW1lbnRNYXBwaW5nKCkuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLAogICAg\nICAgICAgICBzdG9yZSwgZmV0Y2gsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24u\nRUFHRVJfTk9ORSwgam9pbnMpOwogICAgfQoKICAgIHB1YmxpYyBSZXN1bHRb\nXSBnZXRSZXN1bHRzKGZpbmFsIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAg\nICAgICAgZmluYWwgSkRCQ1N0b3JlIHN0b3JlLCBmaW5hbCBKREJDRmV0Y2hD\nb25maWd1cmF0aW9uIGZldGNoLAogICAgICAgIGZpbmFsIGludCBlYWdlck1v\nZGUsIGZpbmFsIEpvaW5zW10gcmVzSm9pbnMsIGJvb2xlYW4gbHJzKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIFZhbHVlTWFwcGlu\nZyBrZXkgPSBmaWVsZC5nZXRLZXlNYXBwaW5nKCk7CiAgICAgICAgZmluYWwg\nQ2xhc3NNYXBwaW5nW10ga2V5cyA9IGtleS5nZXRJbmRlcGVuZGVudFR5cGVN\nYXBwaW5ncygpOwogICAgICAgIFVuaW9uIGt1bmlvbiA9IHN0b3JlLmdldFNR\nTEZhY3RvcnkoKS5uZXdVbmlvbihrZXlzLmxlbmd0aCk7CiAgICAgICAgaWYg\nKGZldGNoLmdldFN1YmNsYXNzRmV0Y2hNb2RlKGtleS5nZXRUeXBlTWFwcGlu\nZygpKQogICAgICAgICAgICAhPSBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVB\nR0VSX0pPSU4pCiAgICAgICAgICAgIGt1bmlvbi5hYm9ydFVuaW9uKCk7CiAg\nICAgICAga3VuaW9uLnNldExSUyhscnMpOwogICAgICAgIGt1bmlvbi5zZWxl\nY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkgewogICAgICAgICAgICBwdWJsaWMg\ndm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwgaW50IGlkeCkgewogICAgICAgICAg\nICAgICAgRm9yZWlnbktleSBqb2luRksgPSBudWxsOwogICAgICAgICAgICAg\nICAgaWYgKGZpZWxkLmlzVW5pMVRvTUZLKCkpIHsKICAgICAgICAgICAgICAg\nICAgICBWYWx1ZU1hcHBpbmcgdmFsID0gZmllbGQuZ2V0RWxlbWVudE1hcHBp\nbmcoKTsKICAgICAgICAgICAgICAgICAgICBWYWx1ZU1hcHBpbmdJbmZvIHZp\nbmZvID0gdmFsLmdldFZhbHVlSW5mbygpOwogICAgICAgICAgICAgICAgICAg\nIFRhYmxlIHRhYmxlID0gdmluZm8uZ2V0VGFibGUodmFsKTsKICAgICAgICAg\nICAgICAgICAgICBqb2luRksgPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdl\ndEpvaW5Gb3JlaWduS2V5KGZpZWxkLCB0YWJsZSwgdHJ1ZSk7CiAgICAgICAg\nICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGpvaW5GSyA9\nIGZpZWxkLmdldEpvaW5Gb3JlaWduS2V5KCk7CiAgICAgICAgICAgICAgICB9\nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbC53aGVyZUZv\ncmVpZ25LZXkoam9pbkZLLAogICAgICAgICAgICAgICAgICAgIHNtLmdldE9i\namVjdElkKCksIGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpLCBzdG9yZSk7\nCgogICAgICAgICAgICAgICAgLy8gb3JkZXIgYmVmb3JlIHNlbGVjdCBpbiBj\nYXNlIHdlJ3JlIGZha2luZyB1bmlvbiB3aXRoCiAgICAgICAgICAgICAgICAv\nLyBtdWx0aXBsZSBzZWxlY3RzOyBvcmRlciB2YWxzIHVzZWQgdG8gbWVyZ2Ug\ncmVzdWx0cwogICAgICAgICAgICAgICAgSm9pbnMgam9pbnMgPSBqb2luS2V5\nUmVsYXRpb24oc2VsLm5ld0pvaW5zKCksIGtleXNbaWR4XSk7CiAgICAgICAg\nICAgICAgICBzZWwub3JkZXJCeShmaWVsZC5nZXRLZXlNYXBwaW5nKCkuZ2V0\nQ29sdW1ucygpLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgIHNlbC5z\nZWxlY3Qoa2V5c1tpZHhdLCBmaWVsZC5nZXRLZXlNYXBwaW5nKCkuCiAgICAg\nICAgICAgICAgICAgICAgZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBzdG9yZSwg\nZmV0Y2gsIGVhZ2VyTW9kZSwgam9pbnMpOwoKICAgICAgICAgICAgICAgIC8v\nIyMjIGNoZWF0OiByZXN1bHQgam9pbnMgb25seSBjYXJlIGFib3V0IHRoZSBy\nZWxhdGlvbiBwYXRoOwogICAgICAgICAgICAgICAgLy8jIyMgdGh1cyB3ZSBj\nYW4gdXNlIGZpcnN0IG1hcHBpbmcgb2YgdW5pb24gb25seQogICAgICAgICAg\nICAgICAgaWYgKGlkeCA9PSAwKQogICAgICAgICAgICAgICAgICAgIHJlc0pv\naW5zWzBdID0gam9pbnM7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAg\nICAgICAgVmFsdWVNYXBwaW5nIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRNYXBw\naW5nKCk7CiAgICAgICAgZmluYWwgQ2xhc3NNYXBwaW5nW10gdmFscyA9IHZh\nbC5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIFVuaW9u\nIHZ1bmlvbiA9IHN0b3JlLmdldFNRTEZhY3RvcnkoKS5uZXdVbmlvbih2YWxz\nLmxlbmd0aCk7CiAgICAgICAgaWYgKGZldGNoLmdldFN1YmNsYXNzRmV0Y2hN\nb2RlKHZhbC5nZXRUeXBlTWFwcGluZygpKQogICAgICAgICAgICAhPSBKREJD\nRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4pCiAgICAgICAgICAgIHZ1\nbmlvbi5hYm9ydFVuaW9uKCk7CiAgICAgICAgdnVuaW9uLnNldExSUyhscnMp\nOwogICAgICAgIHZ1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkg\newogICAgICAgICAgICBwdWJsaWMgdm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwg\naW50IGlkeCkgewogICAgICAgICAgICAgICAgaWYgKGZpZWxkLmlzVW5pMVRv\nTUZLKCkpIHsKICAgICAgICAgICAgICAgICAgICBzZWwub3JkZXJCeShmaWVs\nZC5nZXRLZXlNYXBwaW5nKCkuZ2V0Q29sdW1ucygpLCB0cnVlLCB0cnVlKTsK\nICAgICAgICAgICAgICAgICAgICBzZWwuc2VsZWN0KHZhbHNbaWR4XSwgZmll\nbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS4KICAgICAgICAgICAgICAgICAgICAg\nICAgZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBzdG9yZSwgZmV0Y2gsIGVhZ2Vy\nTW9kZSwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgc2VsLndoZXJlRm9y\nZWlnbktleShmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdldEZvcmVpZ25L\nZXkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgc20uZ2V0T2JqZWN0SWQo\nKSwgZmllbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXREZWNsYXJlZFR5cGVN\nYXBwaW5nKCksIHN0b3JlKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAg\nICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsLndo\nZXJlRm9yZWlnbktleShmaWVsZC5nZXRKb2luRm9yZWlnbktleSgpLAogICAg\nICAgICAgICAgICAgICAgICAgICBzbS5nZXRPYmplY3RJZCgpLCBmaWVsZC5n\nZXREZWZpbmluZ01hcHBpbmcoKSwgc3RvcmUpOwoKICAgICAgICAgICAgICAg\nICAgICAvLyBvcmRlciBiZWZvcmUgc2VsZWN0IGluIGNhc2Ugd2UncmUgZmFr\naW5nIHVuaW9uIHdpdGgKICAgICAgICAgICAgICAgICAgICAvLyBtdWx0aXBs\nZSBzZWxlY3RzOyBvcmRlciB2YWxzIHVzZWQgdG8gbWVyZ2UgcmVzdWx0cwog\nICAgICAgICAgICAgICAgICAgIEpvaW5zIGpvaW5zID0gam9pblZhbHVlUmVs\nYXRpb24oc2VsLm5ld0pvaW5zKCksIHZhbHNbaWR4XSk7CiAgICAgICAgICAg\nICAgICAgICAgc2VsLm9yZGVyQnkoZmllbGQuZ2V0S2V5TWFwcGluZygpLmdl\ndENvbHVtbnMoKSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAg\nc2VsLnNlbGVjdCh2YWxzW2lkeF0sIGZpZWxkLmdldEVsZW1lbnRNYXBwaW5n\nKCkuCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFNlbGVjdFN1YmNsYXNz\nZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdlck1vZGUsIGpvaW5zKTsKCiAgICAg\nICAgICAgICAgICAgICAgLy8jIyMgY2hlYXQ6IHJlc3VsdCBqb2lucyBvbmx5\nIGNhcmUgYWJvdXQgdGhlIHJlbGF0aW9uIHBhdGg7CiAgICAgICAgICAgICAg\nICAgICAgLy8jIyMgdGh1cyB3ZSBjYW4gdXNlIGZpcnN0IG1hcHBpbmcgb2Yg\ndW5pb24gb25seQogICAgICAgICAgICAgICAgICAgIGlmIChpZHggPT0gMCkK\nICAgICAgICAgICAgICAgICAgICAgICAgcmVzSm9pbnNbMV0gPSBqb2luczsK\nICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoK\nICAgICAgICBSZXN1bHQga3JlcyA9IG51bGw7CiAgICAgICAgUmVzdWx0IHZy\nZXMgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGtyZXMgPSBr\ndW5pb24uZXhlY3V0ZShzdG9yZSwgZmV0Y2gpOwogICAgICAgICAgICB2cmVz\nID0gdnVuaW9uLmV4ZWN1dGUoc3RvcmUsIGZldGNoKTsKICAgICAgICAgICAg\ncmV0dXJuIG5ldyBSZXN1bHRbXXsga3JlcywgdnJlcyB9OwogICAgICAgIH0g\nY2F0Y2ggKFNRTEV4Y2VwdGlvbiBzZSkgewogICAgICAgICAgICBpZiAoa3Jl\ncyAhPSBudWxsKQogICAgICAgICAgICAgICAga3Jlcy5jbG9zZSgpOwogICAg\nICAgICAgICBpZiAodnJlcyAhPSBudWxsKQogICAgICAgICAgICAgICAgdnJl\ncy5jbG9zZSgpOwogICAgICAgICAgICB0aHJvdyBzZTsKICAgICAgICB9CiAg\nICB9CgogICAgcHVibGljIE9iamVjdCBsb2FkS2V5KE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBKREJDRmV0Y2hD\nb25maWd1cmF0aW9uIGZldGNoLCBSZXN1bHQgcmVzLCBKb2lucyBqb2lucykK\nICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBDbGFzc01h\ncHBpbmcga2V5ID0gcmVzLmdldEJhc2VNYXBwaW5nKCk7CiAgICAgICAgaWYg\nKGtleSA9PSBudWxsKQogICAgICAgICAgICBrZXkgPSBmaWVsZC5nZXRLZXlN\nYXBwaW5nKCkuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKVswXTsKICAg\nICAgICByZXR1cm4gcmVzLmxvYWQoa2V5LCBzdG9yZSwgZmV0Y2gsIGpvaW5z\nKTsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGxvYWRWYWx1ZShPcGVuSlBB\nU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRC\nQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwgUmVzdWx0IHJlcywgSm9pbnMg\nam9pbnMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAg\nQ2xhc3NNYXBwaW5nIHZhbCA9IHJlcy5nZXRCYXNlTWFwcGluZygpOwogICAg\nICAgIGlmICh2YWwgPT0gbnVsbCkKICAgICAgICAgICAgdmFsID0gZmllbGQu\nZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5n\ncygpWzBdOwogICAgICAgIHJldHVybiByZXMubG9hZCh2YWwsIHN0b3JlLCBm\nZXRjaCwgam9pbnMpOwogICAgfQoKICAgIHB1YmxpYyBKb2lucyBqb2luS2V5\nUmVsYXRpb24oSm9pbnMgam9pbnMsIENsYXNzTWFwcGluZyBrZXkpIHsKICAg\nICAgICBWYWx1ZU1hcHBpbmcgdm0gPSBmaWVsZC5nZXRLZXlNYXBwaW5nKCk7\nCiAgICAgICAgcmV0dXJuIGpvaW5zLmpvaW5SZWxhdGlvbihfa2V5UmVsYXRp\nb25OYW1lLCB2bS5nZXRGb3JlaWduS2V5KGtleSksIGtleSwKICAgICAgICAg\nICAgdm0uZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwog\nICAgfQoKICAgIHB1YmxpYyBKb2lucyBqb2luVmFsdWVSZWxhdGlvbihKb2lu\ncyBqb2lucywgQ2xhc3NNYXBwaW5nIHZhbCkgewogICAgICAgIFZhbHVlTWFw\ncGluZyB2bSA9IGZpZWxkLmdldEVsZW1lbnRNYXBwaW5nKCk7CiAgICAgICAg\nRm9yZWlnbktleSBmayA9IHZtLmdldEZvcmVpZ25LZXkodmFsKTsKICAgICAg\nICBpZiAoZmsgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwog\nICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFt\nZSgpLCBmaywgdmFsLAogICAgICAgICAgICB2bS5nZXRTZWxlY3RTdWJjbGFz\nc2VzKCksIGZhbHNlLCBmYWxzZSk7CiAgICB9CgogICAgcHVibGljIHZvaWQg\nbWFwKGJvb2xlYW4gYWRhcHQpIHsKICAgICAgICBzdXBlci5tYXAoYWRhcHQp\nOwoKICAgICAgICBWYWx1ZU1hcHBpbmcga2V5ID0gZmllbGQuZ2V0S2V5TWFw\ncGluZygpOwogICAgICAgIGlmIChrZXkuZ2V0VHlwZUNvZGUoKSAhPSBKYXZh\nVHlwZXMuUEMgfHwga2V5LmlzRW1iZWRkZWRQQygpKQogICAgICAgICAgICB0\naHJvdyBuZXcgTWV0YURhdGFFeGNlcHRpb24oX2xvYy5nZXQoIm5vdC1yZWxh\ndGlvbiIsIGtleSkpOwogICAgICAgIFZhbHVlTWFwcGluZyB2YWwgPSBmaWVs\nZC5nZXRFbGVtZW50TWFwcGluZygpOwogICAgICAgIGlmICh2YWwuZ2V0VHlw\nZUNvZGUoKSAhPSBKYXZhVHlwZXMuUEMgfHwgdmFsLmlzRW1iZWRkZWRQQygp\nKQogICAgICAgICAgICB0aHJvdyBuZXcgTWV0YURhdGFFeGNlcHRpb24oX2xv\nYy5nZXQoIm5vdC1yZWxhdGlvbiIsIHZhbCkpOwogICAgICAgIEZpZWxkTWFw\ncGluZyBtYXBwZWQgPSBmaWVsZC5nZXRNYXBwZWRCeU1hcHBpbmcoKTsKICAg\nICAgICBEQkRpY3Rpb25hcnkgZGljdCA9IGZpZWxkLmdldE1hcHBpbmdSZXBv\nc2l0b3J5KCkuZ2V0REJEaWN0aW9uYXJ5KCk7CiAgICAgICAgREJJZGVudGlm\naWVyIGtleU5hbWUgPSBudWxsOwogICAgICAgIGlmIChmaWVsZC5pc1VuaTFU\nb01GSygpIHx8ICghZmllbGQuaXNCaU1UbzFKVCgpICYmIG1hcHBlZCAhPSBu\ndWxsKSkgeyAKICAgICAgICAgICAgaGFuZGxlTWFwcGVkQnlGb3JlaWduS2V5\nKGFkYXB0KTsKICAgICAgICAgICAga2V5TmFtZSA9IGRpY3QuZ2V0VmFsaWRD\nb2x1bW5OYW1lKERCSWRlbnRpZmllci5uZXdDb2x1bW4oInZrZXkiKSwgZmll\nbGQuZ2V0VGFibGUoKSk7CiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5pc0Jp\nTVRvMUpUKCkgfHwgbWFwcGVkID09IG51bGwpIHsgCiAgICAgICAgICAgIGZp\nZWxkLm1hcEpvaW4oYWRhcHQsIHRydWUpOwogICAgICAgICAgICBtYXBUeXBl\nSm9pbih2YWwsIERCSWRlbnRpZmllci5uZXdDb2x1bW4oInZhbHVlIiksIGFk\nYXB0KTsKICAgICAgICAgICAga2V5TmFtZSA9IGRpY3QuZ2V0VmFsaWRDb2x1\nbW5OYW1lKERCSWRlbnRpZmllci5uZXdDb2x1bW4oImtleSIpLCBmaWVsZC5n\nZXRUYWJsZSgpKTsKICAgICAgICB9CiAgICAgICAgbWFwVHlwZUpvaW4oa2V5\nLCBrZXlOYW1lLCBhZGFwdCk7CgogICAgICAgIGZpZWxkLm1hcFByaW1hcnlL\nZXkoYWRhcHQpOwogICAgfQoKICAgIC8qKgogICAgICogTWFwIHRoZSBnaXZl\nbiB2YWx1ZSdzIGpvaW4gdG8gaXRzIHBlcnNpc3RlbnQgdHlwZS4KICAgICAq\nLwogICAgcHJpdmF0ZSB2b2lkIG1hcFR5cGVKb2luKFZhbHVlTWFwcGluZyB2\nbSwgREJJZGVudGlmaWVyIG5hbWUsIGJvb2xlYW4gYWRhcHQpIHsKICAgICAg\nICBpZiAodm0uZ2V0VHlwZU1hcHBpbmcoKS5pc01hcHBlZCgpKSB7CiAgICAg\nICAgICAgIFZhbHVlTWFwcGluZ0luZm8gdmluZm8gPSB2bS5nZXRWYWx1ZUlu\nZm8oKTsKICAgICAgICAgICAgRm9yZWlnbktleSBmayA9IHZpbmZvLmdldFR5\ncGVKb2luKHZtLCBuYW1lLCBmYWxzZSwgYWRhcHQpOwogICAgICAgICAgICB2\nbS5zZXRGb3JlaWduS2V5KGZrKTsKICAgICAgICAgICAgdm0uc2V0Q29sdW1u\nSU8odmluZm8uZ2V0Q29sdW1uSU8oKSk7CiAgICAgICAgfSBlbHNlCiAgICAg\nICAgICAgIFJlbGF0aW9uU3RyYXRlZ2llcy5tYXBSZWxhdGlvblRvVW5tYXBw\nZWRQQyh2bSwgbmFtZSwgYWRhcHQpOwogICAgICAgIHZtLm1hcENvbnN0cmFp\nbnRzKG5hbWUsIGFkYXB0KTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbml0\naWFsaXplKCkgewogICAgICAgIF9rZXlSZWxhdGlvbk5hbWUgPSBmaWVsZC5n\nZXROYW1lKCkgKyAiOmtleSI7CiAgICB9CgogICAgcHVibGljIHZvaWQgaW5z\nZXJ0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwg\nUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICBpbnNlcnQoc20sIHJtLCAoTWFwKSBzbS5mZXRjaE9iamVjdChm\naWVsZC5nZXRJbmRleCgpKSwgc3RvcmUpOwogICAgfQoKICAgIHByaXZhdGUg\ndm9pZCBpbnNlcnQoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgUm93TWFuYWdl\nciBybSwgTWFwIG1hcCwgCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChtYXAgPT0g\nbnVsbCB8fCBtYXAuaXNFbXB0eSgpKQogICAgICAgICAgICByZXR1cm47CiAg\nICAgICAgCiAgICAgICAgaWYgKCFmaWVsZC5pc0JpTVRvMUpUKCkgJiYgZmll\nbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxsKQogICAgICAgICAgICByZXR1cm47\nCgogICAgICAgIFJvdyByb3cgPSBudWxsOwogICAgICAgIGlmICghZmllbGQu\naXNVbmkxVG9NRksoKSkgewogICAgICAgICAgICByb3cgPSBybS5nZXRTZWNv\nbmRhcnlSb3coZmllbGQuZ2V0VGFibGUoKSwgUm93LkFDVElPTl9JTlNFUlQp\nOwogICAgICAgICAgICByb3cuc2V0Rm9yZWlnbktleShmaWVsZC5nZXRKb2lu\nRm9yZWlnbktleSgpLCBmaWVsZC5nZXRKb2luQ29sdW1uSU8oKSwKICAgICAg\nICAgICAgICAgIHNtKTsKICAgICAgICB9CiAgICAgICAgVmFsdWVNYXBwaW5n\nIGtleSA9IGZpZWxkLmdldEtleU1hcHBpbmcoKTsKICAgICAgICBWYWx1ZU1h\ncHBpbmcgdmFsID0gZmllbGQuZ2V0RWxlbWVudE1hcHBpbmcoKTsKICAgICAg\nICBTdG9yZUNvbnRleHQgY3R4ID0gc20uZ2V0Q29udGV4dCgpOwogICAgICAg\nIE9wZW5KUEFTdGF0ZU1hbmFnZXIga2V5c20sIHZhbHNtOwogICAgICAgIE1h\ncC5FbnRyeSBlbnRyeTsKICAgICAgICBmb3IgKEl0ZXJhdG9yIGl0ciA9IG1h\ncC5lbnRyeVNldCgpLml0ZXJhdG9yKCk7IGl0ci5oYXNOZXh0KCk7KSB7CiAg\nICAgICAgICAgIGVudHJ5ID0gKE1hcC5FbnRyeSkgaXRyLm5leHQoKTsKICAg\nICAgICAgICAga2V5c20gPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVN\nYW5hZ2VyKGVudHJ5LmdldEtleSgpLCBjdHgpOwogICAgICAgICAgICB2YWxz\nbSA9IFJlbGF0aW9uU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIoZW50cnku\nZ2V0VmFsdWUoKSwgY3R4KTsKICAgICAgICAgICAgaWYgKGZpZWxkLmlzVW5p\nMVRvTUZLKCkpewogICAgICAgICAgICAgICAgcm93ID0gcm0uZ2V0Um93KGZp\nZWxkLmdldEVsZW1lbnRNYXBwaW5nKCkuZ2V0RGVjbGFyZWRUeXBlTWFwcGlu\nZygpLmdldFRhYmxlKCksCiAgICAgICAgICAgICAgICAgICAgUm93LkFDVElP\nTl9VUERBVEUsIHZhbHNtLCB0cnVlKTsKICAgICAgICAgICAgICAgIHJvdy53\naGVyZVByaW1hcnlLZXkodmFsc20pOwogICAgICAgICAgICAgICAgdmFsLnNl\ndEZvcmVpZ25LZXkocm93LCBzbSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAg\nICAgICAgICAgICAgICB2YWwuc2V0Rm9yZWlnbktleShyb3csIHZhbHNtKTsK\nICAgICAgICAgICAgfQogICAgICAgICAgICBrZXkuc2V0Rm9yZWlnbktleShy\nb3csIGtleXNtKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHNvIGZh\nciwgd2UgcG9wdWxhdGVkIHRoZSBrZXkvdmFsdWUgb2YgZWFjaAogICAgICAg\nICAgICAvLyBtYXAgZWxlbWVudCBvd25lZCBieSB0aGUgZW50aXR5LgogICAg\nICAgICAgICAvLyBJbiB0aGUgY2FzZSBvZiBUb01hbnksIGFuZCBib3RoIHNp\nZGVzCiAgICAgICAgICAgIC8vIHVzZSBNYXAgdG8gcmVwcmVzZW50IHRoZSBy\nZWxhdGlvbiwKICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBwb3B1bGF0ZSB0\naGUga2V5IHZhbHVlIG9mIHRoZSBvd25lcgogICAgICAgICAgICAvLyBmcm9t\nIHRoZSB2aWV3IHBvaW50IG9mIHRoZSBvd25lZCBzaWRlCiAgICAgICAgICAg\nIFBlcnNpc3RlbmNlQ2FwYWJsZSBvYmogPSBzbS5nZXRQZXJzaXN0ZW5jZUNh\ncGFibGUoKTsKICAgICAgICAgICAgaWYgKCFwb3B1bGF0ZUtleShyb3csIHZh\nbHNtLCBvYmosIGN0eCwgcm0sIHN0b3JlKSkKICAgICAgICAgICAgICAgIGlm\nICghZmllbGQuaXNVbmkxVG9NRksoKSkKICAgICAgICAgICAgICAgICAgICBy\nbS5mbHVzaFNlY29uZGFyeVJvdyhyb3cpOwogICAgICAgIH0KICAgIH0KCiAg\nICBwdWJsaWMgdm9pZCB1cGRhdGUoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwg\nSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93\ncyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChmaWVsZC5nZXRNYXBwZWRC\neSgpICE9IG51bGwgJiYgIWZpZWxkLmlzQmlNVG8xSlQoKSkKICAgICAgICAg\nICAgcmV0dXJuOwogICAgICAgIAogICAgICAgIE1hcCBtYXAgPSAoTWFwKSBz\nbS5mZXRjaE9iamVjdChmaWVsZC5nZXRJbmRleCgpKTsKICAgICAgICBDaGFu\nZ2VUcmFja2VyIGN0ID0gbnVsbDsKICAgICAgICBpZiAobWFwIGluc3RhbmNl\nb2YgUHJveHkpIHsKICAgICAgICAgICAgUHJveHkgcHJveHkgPSAoUHJveHkp\nIG1hcDsKICAgICAgICAgICAgaWYgKFByb3hpZXMuaXNPd25lcihwcm94eSwg\nc20sIGZpZWxkLmdldEluZGV4KCkpKQogICAgICAgICAgICAgICAgY3QgPSBw\ncm94eS5nZXRDaGFuZ2VUcmFja2VyKCk7CiAgICAgICAgfQoKICAgICAgICAv\nLyBpZiBubyBmaW5lLWdyYWluZWQgY2hhbmdlIHRyYWNraW5nIHRoZW4ganVz\ndCBkZWxldGUgYW5kIHJlaW5zZXJ0CiAgICAgICAgaWYgKGN0ID09IG51bGwg\nfHwgIWN0LmlzVHJhY2tpbmcoKSkgewogICAgICAgICAgICBkZWxldGUoc20s\nIHN0b3JlLCBybSk7CiAgICAgICAgICAgIGluc2VydChzbSwgcm0sIG1hcCwg\nc3RvcmUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAg\nICBWYWx1ZU1hcHBpbmcga2V5ID0gZmllbGQuZ2V0S2V5TWFwcGluZygpOwog\nICAgICAgIFZhbHVlTWFwcGluZyB2YWwgPSBmaWVsZC5nZXRFbGVtZW50TWFw\ncGluZygpOwogICAgICAgIFN0b3JlQ29udGV4dCBjdHggPSBzdG9yZS5nZXRD\nb250ZXh0KCk7CiAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciBrZXlzbSwg\ndmFsc207CgogICAgICAgIC8vIHVwZGF0ZSB0aGUgY2hhbmdlczsgbm90ZSB0\naGF0IHdlIGhhdmUgdG8gbW9kZWwgY2hhbmdlcyBhcwogICAgICAgIC8vIGRl\nbGV0ZS10aGVuLWluc2VydCBpZiB3ZSBoYXZlIGEgZm9yZWlnbiBrZXkgYWN0\naW9uLCBiZWNhdXNlCiAgICAgICAgLy8gc2Vjb25kYXJ5IHJvdyB1cGRhdGVz\nIGFyZW4ndCBwYXJ0IG9mIHRoZSBjb25zdHJhaW50IGdyYXBoCiAgICAgICAg\nQ29sbGVjdGlvbiBjaGFuZ2UgPSBjdC5nZXRDaGFuZ2VkKCk7CiAgICAgICAg\nYm9vbGVhbiBjYW5DaGFuZ2UgPSB2YWwuZ2V0Rm9yZWlnbktleSgpLmlzTG9n\naWNhbCgpOwogICAgICAgIE9iamVjdCBta2V5OwogICAgICAgIGlmIChjYW5D\naGFuZ2UgJiYgIWNoYW5nZS5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgUm93\nIGNoYW5nZVJvdyA9IG51bGw7CiAgICAgICAgICAgIGlmICghZmllbGQuaXNV\nbmkxVG9NRksoKSkgewogICAgICAgICAgICAgICAgcm0uZ2V0U2Vjb25kYXJ5\nUm93KGZpZWxkLmdldFRhYmxlKCksCiAgICAgICAgICAgICAgICAgICAgUm93\nLkFDVElPTl9VUERBVEUpOwogICAgICAgICAgICAgICAgY2hhbmdlUm93Lndo\nZXJlRm9yZWlnbktleShmaWVsZC5nZXRKb2luRm9yZWlnbktleSgpLCBzbSk7\nCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChJdGVyYXRvciBpdHIg\nPSBjaGFuZ2UuaXRlcmF0b3IoKTsgaXRyLmhhc05leHQoKTspIHsKICAgICAg\nICAgICAgICAgIG1rZXkgPSBpdHIubmV4dCgpOwogICAgICAgICAgICAgICAg\nT2JqZWN0IG12YWwgPSBtYXAuZ2V0KG1rZXkpOwogICAgICAgICAgICAgICAg\naWYgKG12YWwgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIFNldDxN\nYXAuRW50cnk+IGVudHJpZXMgPSBtYXAuZW50cnlTZXQoKTsKICAgICAgICAg\nICAgICAgICAgICBmb3IgKE1hcC5FbnRyeSBlbnRyeSA6IGVudHJpZXMpIHsK\nICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudHJ5LmdldEtleSgpLmVx\ndWFscyhta2V5KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG12YWwg\nPSBlbnRyeS5nZXRWYWx1ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAg\nICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChtdmFsID09IG51\nbGwpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAg\nICAgICBrZXlzbSA9IFJlbGF0aW9uU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFn\nZXIobWtleSwgY3R4KTsKICAgICAgICAgICAgICAgIHZhbHNtID0gUmVsYXRp\nb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihtdmFsLCBjdHgpOwogICAg\nICAgICAgICAgICAga2V5LndoZXJlRm9yZWlnbktleShjaGFuZ2VSb3csIGtl\neXNtKTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5pc1VuaTFUb01GSygp\nKXsKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VSb3cgPSBybS5nZXRSb3co\nZmllbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXREZWNsYXJlZFR5cGVNYXBw\naW5nKCkuZ2V0VGFibGUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgUm93\nLkFDVElPTl9VUERBVEUsIHZhbHNtLCB0cnVlKTsKICAgICAgICAgICAgICAg\nICAgICBjaGFuZ2VSb3cud2hlcmVQcmltYXJ5S2V5KHZhbHNtKTsKICAgICAg\nICAgICAgICAgICAgICB2YWwuc2V0Rm9yZWlnbktleShjaGFuZ2VSb3csIHNt\nKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAg\nICAgdmFsLnNldEZvcmVpZ25LZXkoY2hhbmdlUm93LCB2YWxzbSk7CiAgICAg\nICAgICAgICAgICAgICAgcm0uZmx1c2hTZWNvbmRhcnlSb3coY2hhbmdlUm93\nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0K\nCiAgICAgICAgLy8gZGVsZXRlIHRoZSByZW1vdmVzCiAgICAgICAgQ29sbGVj\ndGlvbiByZW0gPSBjdC5nZXRSZW1vdmVkKCk7CiAgICAgICAgaWYgKCFyZW0u\naXNFbXB0eSgpIHx8ICghY2FuQ2hhbmdlICYmICFjaGFuZ2UuaXNFbXB0eSgp\nKSkgewogICAgICAgICAgICBSb3cgZGVsUm93ID0gbnVsbDsKICAgICAgICAg\nICAgaWYgKCFmaWVsZC5pc1VuaTFUb01GSygpKSB7CiAgICAgICAgICAgICAg\nICBkZWxSb3cgPSBybS5nZXRTZWNvbmRhcnlSb3coZmllbGQuZ2V0VGFibGUo\nKSwKICAgICAgICAgICAgICAgICAgICBSb3cuQUNUSU9OX0RFTEVURSk7CiAg\nICAgICAgICAgICAgICBkZWxSb3cud2hlcmVGb3JlaWduS2V5KGZpZWxkLmdl\ndEpvaW5Gb3JlaWduS2V5KCksIHNtKTsKICAgICAgICAgICAgfQoKICAgICAg\nICAgICAgZm9yIChJdGVyYXRvciBpdHIgPSByZW0uaXRlcmF0b3IoKTsgaXRy\nLmhhc05leHQoKTspIHsKICAgICAgICAgICAgICAgIE9iamVjdCBwYyA9IGl0\nci5uZXh0KCk7CiAgICAgICAgICAgICAgICBpZiAoZmllbGQuaXNVbmkxVG9N\nRksoKSl7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlU2V0TnVsbChzbSwg\ncm0sIHBjKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAg\nICAgICAgICAga2V5c20gPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVN\nYW5hZ2VyKHBjLCBjdHgpOwogICAgICAgICAgICAgICAgICAgIGtleS53aGVy\nZUZvcmVpZ25LZXkoZGVsUm93LCBrZXlzbSk7CiAgICAgICAgICAgICAgICAg\nICAgcm0uZmx1c2hTZWNvbmRhcnlSb3coZGVsUm93KTsKICAgICAgICAgICAg\nICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNhbkNoYW5n\nZSAmJiAhY2hhbmdlLmlzRW1wdHkoKSkgewogICAgICAgICAgICAgICAgZm9y\nIChJdGVyYXRvciBpdHIgPSBjaGFuZ2UuaXRlcmF0b3IoKTsgaXRyLmhhc05l\neHQoKTspIHsKICAgICAgICAgICAgICAgICAgICBPYmplY3QgcGMgPSBpdHIu\nbmV4dCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZC5pc1VuaTFU\nb01GSygpKXsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlU2V0TnVs\nbChzbSwgcm0sIHBjKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAK\nICAgICAgICAgICAgICAgICAgICAgICAga2V5c20gPSBSZWxhdGlvblN0cmF0\nZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKHBjLCBjdHgpOwogICAgICAgICAgICAg\nICAgICAgICAgICBrZXkud2hlcmVGb3JlaWduS2V5KGRlbFJvdywga2V5c20p\nOwogICAgICAgICAgICAgICAgICAgICAgICBybS5mbHVzaFNlY29uZGFyeVJv\ndyhkZWxSb3cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAg\nICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gaW5z\nZXJ0IHRoZSBhZGRzCiAgICAgICAgQ29sbGVjdGlvbiBhZGQgPSBjdC5nZXRB\nZGRlZCgpOwogICAgICAgIGlmICghYWRkLmlzRW1wdHkoKSB8fCAoIWNhbkNo\nYW5nZSAmJiAhY2hhbmdlLmlzRW1wdHkoKSkpIHsKICAgICAgICAgICAgUm93\nIGFkZFJvdyA9IG51bGw7CiAgICAgICAgICAgIGlmICghZmllbGQuaXNVbmkx\nVG9NRksoKSkgewogICAgICAgICAgICAgICAgYWRkUm93ID0gcm0uZ2V0U2Vj\nb25kYXJ5Um93KGZpZWxkLmdldFRhYmxlKCksCiAgICAgICAgICAgICAgICAg\nICAgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAgICAgICAgICAgYWRkUm93\nLnNldEZvcmVpZ25LZXkoZmllbGQuZ2V0Sm9pbkZvcmVpZ25LZXkoKSwKICAg\nICAgICAgICAgICAgICAgICBmaWVsZC5nZXRKb2luQ29sdW1uSU8oKSwgc20p\nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoSXRlcmF0b3IgaXRy\nID0gYWRkLml0ZXJhdG9yKCk7IGl0ci5oYXNOZXh0KCk7KSB7CiAgICAgICAg\nICAgICAgICBta2V5ID0gaXRyLm5leHQoKTsKICAgICAgICAgICAgICAgIE9i\namVjdCBtdmFsID0gbWFwLmdldChta2V5KTsKICAgICAgICAgICAgICAgIGlm\nIChtdmFsID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBTZXQ8TWFw\nLkVudHJ5PiBlbnRyaWVzID0gbWFwLmVudHJ5U2V0KCk7CiAgICAgICAgICAg\nICAgICAgICAgZm9yIChNYXAuRW50cnkgZW50cnkgOiBlbnRyaWVzKSB7CiAg\nICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeS5nZXRLZXkoKS5lcXVh\nbHMobWtleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdmFsID0g\nZW50cnkuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobXZhbCA9PSBudWxs\nKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAg\nICAga2V5c20gPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2Vy\nKG1rZXksIGN0eCk7CiAgICAgICAgICAgICAgICB2YWxzbSA9IFJlbGF0aW9u\nU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIobXZhbCwgY3R4KTsKICAgICAg\nICAgICAgICAgIGlmIChmaWVsZC5pc1VuaTFUb01GSygpKXsKICAgICAgICAg\nICAgICAgICAgICBhZGRSb3cgPSBybS5nZXRSb3coZmllbGQuZ2V0RWxlbWVu\ndE1hcHBpbmcoKS5nZXREZWNsYXJlZFR5cGVNYXBwaW5nKCkuZ2V0VGFibGUo\nKSwKICAgICAgICAgICAgICAgICAgICAgICAgUm93LkFDVElPTl9VUERBVEUs\nIHZhbHNtLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBhZGRSb3cud2hl\ncmVQcmltYXJ5S2V5KHZhbHNtKTsKICAgICAgICAgICAgICAgICAgICBrZXku\nc2V0Rm9yZWlnbktleShhZGRSb3csIGtleXNtKTsKICAgICAgICAgICAgICAg\nICAgICB2YWwuc2V0Rm9yZWlnbktleShhZGRSb3csIHNtKTsKICAgICAgICAg\nICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAga2V5LnNldEZv\ncmVpZ25LZXkoYWRkUm93LCBrZXlzbSk7CiAgICAgICAgICAgICAgICAgICAg\ndmFsLnNldEZvcmVpZ25LZXkoYWRkUm93LCB2YWxzbSk7CiAgICAgICAgICAg\nICAgICAgICAgcm0uZmx1c2hTZWNvbmRhcnlSb3coYWRkUm93KTsKICAgICAg\nICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNh\nbkNoYW5nZSAmJiAhY2hhbmdlLmlzRW1wdHkoKSkgewogICAgICAgICAgICAg\nICAgZm9yIChJdGVyYXRvciBpdHIgPSBjaGFuZ2UuaXRlcmF0b3IoKTsgaXRy\nLmhhc05leHQoKTspIHsKICAgICAgICAgICAgICAgICAgICBta2V5ID0gaXRy\nLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICBPYmplY3QgbXZhbCA9IG1h\ncC5nZXQobWtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG12YWwgPT0g\nbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBTZXQ8TWFwLkVudHJ5\nPiBlbnRyaWVzID0gbWFwLmVudHJ5U2V0KCk7CiAgICAgICAgICAgICAgICAg\nICAgICAgIGZvciAoTWFwLkVudHJ5IGVudHJ5IDogZW50cmllcykgewogICAg\nICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVudHJ5LmdldEtleSgpLmVx\ndWFscyhta2V5KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBt\ndmFsID0gZW50cnkuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICAg\nICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAg\nICBpZiAobXZhbCA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICBj\nb250aW51ZTsKICAgICAgICAgICAgICAgICAgICBrZXlzbSA9IFJlbGF0aW9u\nU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIobWtleSwgY3R4KTsKICAgICAg\nICAgICAgICAgICAgICB2YWxzbSA9IFJlbGF0aW9uU3RyYXRlZ2llcy5nZXRT\ndGF0ZU1hbmFnZXIobXZhbCwgY3R4KTsKICAgICAgICAgICAgICAgICAgICBp\nZiAoZmllbGQuaXNVbmkxVG9NRksoKSl7CiAgICAgICAgICAgICAgICAgICAg\nICAgIGFkZFJvdyA9IHJtLmdldFJvdyhmaWVsZC5nZXRFbGVtZW50TWFwcGlu\nZygpLmdldERlY2xhcmVkVHlwZU1hcHBpbmcoKS5nZXRUYWJsZSgpLAogICAg\nICAgICAgICAgICAgICAgICAgICAgICAgUm93LkFDVElPTl9VUERBVEUsIHZh\nbHNtLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkUm93Lndo\nZXJlUHJpbWFyeUtleSh2YWxzbSk7CiAgICAgICAgICAgICAgICAgICAgICAg\nIGtleS5zZXRGb3JlaWduS2V5KGFkZFJvdywga2V5c20pOwogICAgICAgICAg\nICAgICAgICAgICAgICB2YWwuc2V0Rm9yZWlnbktleShhZGRSb3csIHNtKTsK\nICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAg\nICAgICAgICBrZXkuc2V0Rm9yZWlnbktleShhZGRSb3csIGtleXNtKTsKICAg\nICAgICAgICAgICAgICAgICAgICAgdmFsLnNldEZvcmVpZ25LZXkoYWRkUm93\nLCB2YWxzbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJtLmZsdXNoU2Vj\nb25kYXJ5Um93KGFkZFJvdyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAg\nICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoK\nICAgIHB1YmxpYyBKb2lucyBqb2luUmVsYXRpb24oSm9pbnMgam9pbnMsIGJv\nb2xlYW4gZm9yY2VPdXRlciwKICAgICAgICBib29sZWFuIHRyYXZlcnNlKSB7\nCiAgICAgICAgVmFsdWVNYXBwaW5nIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRN\nYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xzcyA9IHZhbC5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGlmIChjbHNz\nLmxlbmd0aCAhPSAxKSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZSkKICAg\nICAgICAgICAgICAgIHRocm93IFJlbGF0aW9uU3RyYXRlZ2llcy51bmpvaW5h\nYmxlKHZhbCk7CiAgICAgICAgICAgIHJldHVybiBqb2luczsKICAgICAgICB9\nCiAgICAgICAgRm9yZWlnbktleSBmayA9IHZhbC5nZXRGb3JlaWduS2V5KGNs\nc3NbMF0pOwogICAgICAgIGlmIChmayA9PSBudWxsKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnM7CiAgICAgICAgaWYgKGZvcmNlT3V0ZXIpCiAgICAgICAg\nICAgIHJldHVybiBqb2lucy5vdXRlckpvaW5SZWxhdGlvbihmaWVsZC5nZXRO\nYW1lKCksCiAgICAgICAgICAgICAgICBmaywgY2xzc1swXSwgdmFsLmdldFNl\nbGVjdFN1YmNsYXNzZXMoKSwKICAgICAgICAgICAgICAgIGZhbHNlLCBmYWxz\nZSk7CiAgICAgICAgcmV0dXJuIGpvaW5zLmpvaW5SZWxhdGlvbihmaWVsZC5n\nZXROYW1lKCksCiAgICAgICAgICAgIGZrLCBjbHNzWzBdLCB2YWwuZ2V0U2Vs\nZWN0U3ViY2xhc3NlcygpLAogICAgICAgICAgICBmYWxzZSwgZmFsc2UpOwog\nICAgfQoKICAgIHB1YmxpYyBKb2lucyBqb2luS2V5UmVsYXRpb24oSm9pbnMg\nam9pbnMsIGJvb2xlYW4gZm9yY2VPdXRlciwKICAgICAgICBib29sZWFuIHRy\nYXZlcnNlKSB7CiAgICAgICAgVmFsdWVNYXBwaW5nIGtleSA9IGZpZWxkLmdl\ndEtleU1hcHBpbmcoKTsKICAgICAgICBDbGFzc01hcHBpbmdbXSBjbHNzID0g\na2V5LmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAgaWYg\nKGNsc3MubGVuZ3RoICE9IDEpIHsKICAgICAgICAgICAgaWYgKHRyYXZlcnNl\nKQogICAgICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVu\nam9pbmFibGUoa2V5KTsKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwogICAg\nICAgIH0KICAgICAgICBpZiAoZm9yY2VPdXRlcikKICAgICAgICAgICAgcmV0\ndXJuIGpvaW5zLm91dGVySm9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwK\nICAgICAgICAgICAgICAgIGtleS5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLCBj\nbHNzWzBdLCBrZXkuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLAogICAgICAgICAg\nICAgICAgZmFsc2UsIGZhbHNlKTsKICAgICAgICByZXR1cm4gam9pbnMuam9p\nblJlbGF0aW9uKF9rZXlSZWxhdGlvbk5hbWUsCiAgICAgICAgICAgIGtleS5n\nZXRGb3JlaWduS2V5KGNsc3NbMF0pLCBjbHNzWzBdLCBrZXkuZ2V0U2VsZWN0\nU3ViY2xhc3NlcygpLCAKICAgICAgICAgICAgZmFsc2UsIGZhbHNlKTsKICAg\nIH0KCiAgICBwdWJsaWMgT2JqZWN0IHRvRGF0YVN0b3JlVmFsdWUoT2JqZWN0\nIHZhbCwgSkRCQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgcmV0dXJuIFJlbGF0\naW9uU3RyYXRlZ2llcy50b0RhdGFTdG9yZVZhbHVlKGZpZWxkLmdldEVsZW1l\nbnRNYXBwaW5nKCksCiAgICAgICAgICAgIHZhbCwgc3RvcmUpOwogICAgfQoK\nICAgIHB1YmxpYyBPYmplY3QgdG9LZXlEYXRhU3RvcmVWYWx1ZShPYmplY3Qg\ndmFsLCBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICByZXR1cm4gUmVsYXRp\nb25TdHJhdGVnaWVzLnRvRGF0YVN0b3JlVmFsdWUoZmllbGQuZ2V0S2V5TWFw\ncGluZygpLAogICAgICAgICAgICB2YWwsIHN0b3JlKTsKICAgIH0KICAgIAog\nICAgcHVibGljIHZvaWQgZGVsZXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20s\nIEpEQkNTdG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJv\nd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuaXNVbmkxVG9N\nRksoKSkgewogICAgICAgICAgICBNYXAgbWFwT2JqID0gKE1hcClzbS5mZXRj\naE9iamVjdChmaWVsZC5nZXRJbmRleCgpKTsKICAgICAgICAgICAgdXBkYXRl\nU2V0TnVsbChzbSwgc3RvcmUsIHJtLCBtYXBPYmoua2V5U2V0KCkpOwogICAg\nICAgICAgICByZXR1cm47CiAgICAgICAgfSAgICAKICAgICAgICBzdXBlci5k\nZWxldGUoc20sIHN0b3JlLCBybSk7CiAgICB9CiAgICAKICAgIHByaXZhdGUg\ndm9pZCB1cGRhdGVTZXROdWxsKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpE\nQkNTdG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSwKICAgICAgICBTZXQgcmVt\nKSB0aHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBmb3IgKEl0ZXJhdG9y\nIGl0ciA9IHJlbS5pdGVyYXRvcigpOyBpdHIuaGFzTmV4dCgpOykgewogICAg\nICAgICAgICBPYmplY3QgbWtleSA9IGl0ci5uZXh0KCk7CiAgICAgICAgICAg\nIHVwZGF0ZVNldE51bGwoc20sIHJtLCBta2V5KTsKICAgICAgICB9CiAgICB9\nCiAgICAKICAgIHByaXZhdGUgdm9pZCB1cGRhdGVTZXROdWxsKE9wZW5KUEFT\ndGF0ZU1hbmFnZXIgc20sIFJvd01hbmFnZXIgcm0sIE9iamVjdCBta2V5KSAK\nICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBTdG9yZUNv\nbnRleHQgY3R4ID0gc20uZ2V0Q29udGV4dCgpOwogICAgICAgIFZhbHVlTWFw\ncGluZyBrZXkgPSBmaWVsZC5nZXRLZXlNYXBwaW5nKCk7CiAgICAgICAgVmFs\ndWVNYXBwaW5nIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRNYXBwaW5nKCk7CiAg\nICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciBrZXlzbSA9IFJlbGF0aW9uU3Ry\nYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIobWtleSwgY3R4KTsKICAgICAgICBS\nb3cgZGVsUm93ID0gcm0uZ2V0Um93KGZpZWxkLmdldEVsZW1lbnRNYXBwaW5n\nKCkuZ2V0RGVjbGFyZWRUeXBlTWFwcGluZygpLmdldFRhYmxlKCksCiAgICAg\nICAgICAgICAgICBSb3cuQUNUSU9OX1VQREFURSwgc20sIHRydWUpOwogICAg\nICAgIFZhbHVlTWFwcGluZ0luZm8gdmluZm8gPSBmaWVsZC5nZXRFbGVtZW50\nTWFwcGluZygpLmdldFZhbHVlSW5mbygpOwogICAgICAgIFRhYmxlIHRhYmxl\nID0gdmluZm8uZ2V0VGFibGUodmFsKTsKICAgICAgICBGb3JlaWduS2V5IGpv\naW5GSyA9IGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuZ2V0Sm9pbkZvcmVpZ25L\nZXkoZmllbGQsIHRhYmxlLCB0cnVlKTsKICAgICAgICBkZWxSb3cud2hlcmVG\nb3JlaWduS2V5KGpvaW5GSywgc20pOwogICAgICAgIGRlbFJvdy53aGVyZUZv\ncmVpZ25LZXkoa2V5LmdldEZvcmVpZ25LZXkoKSwga2V5c20pOwogICAgICAg\nIHZhbC5zZXRGb3JlaWduS2V5KGRlbFJvdywgbnVsbCk7CiAgICAgICAga2V5\nLnNldEZvcmVpZ25LZXkoZGVsUm93LCBudWxsKTsKICAgIH0KfQo=\n","encoding":"base64"}

