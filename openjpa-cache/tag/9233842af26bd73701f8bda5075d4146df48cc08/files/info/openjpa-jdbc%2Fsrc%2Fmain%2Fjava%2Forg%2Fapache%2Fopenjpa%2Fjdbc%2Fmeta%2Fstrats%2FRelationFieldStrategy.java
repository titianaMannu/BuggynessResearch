{"sha":"04de366d9c7c4f5007ad67812b48d9ff12d4d878","node_id":"MDQ6QmxvYjIwNjM2NDowNGRlMzY2ZDljN2M0ZjUwMDdhZDY3ODEyYjQ4ZDlmZjEyZDRkODc4","size":44143,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/04de366d9c7c4f5007ad67812b48d9ff12d4d878","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkNvbGxlY3Rpb25zOwpp\nbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9ydCBqYXZhLnV0aWwuTGlz\ndDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CmltcG9ydCBqYXZhLnV0aWwuU2V0\nOwoKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNlLlBlcnNpc3Rl\nbmNlQ2FwYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNl\nLlJlZmxlY3RpbmdQZXJzaXN0ZW5jZUNhcGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5rZXJuZWwuSkRCQ0ZldGNoQ29uZmlndXJhdGlv\nbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtlcm5lbC5KREJD\nU3RvcmU7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLkNs\nYXNzTWFwcGluZzsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1l\ndGEuRW1iZWRkYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJj\nLm1ldGEuRmllbGRNYXBwaW5nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBh\nLmpkYmMubWV0YS5GaWVsZFN0cmF0ZWd5OwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLmpkYmMubWV0YS5Kb2luYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5qZGJjLm1ldGEuTWFwcGluZ0luZm87CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZhbHVlTWFwcGluZzsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuVmFsdWVNYXBwaW5nSW1wbDsK\naW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuVmFsdWVNYXBw\naW5nSW5mbzsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNjaGVt\nYS5Db2x1bW47CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hl\nbWEuQ29sdW1uSU87CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5z\nY2hlbWEuRm9yZWlnbktleTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5q\nZGJjLnNjaGVtYS5QcmltYXJ5S2V5OwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMuc2NoZW1hLlRhYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMuc3FsLkRCRGljdGlvbmFyeTsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5qZGJjLnNxbC5Kb2luczsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5SZXN1bHQ7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5q\ncGEuamRiYy5zcWwuUm93OwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpk\nYmMuc3FsLlJvd01hbmFnZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\namRiYy5zcWwuU1FMQnVmZmVyOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBh\nLmpkYmMuc3FsLlNlbGVjdDsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5q\nZGJjLnNxbC5TZWxlY3RFeGVjdXRvcjsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5VbmlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3Blbmpw\nYS5rZXJuZWwuT3BlbkpQQVN0YXRlTWFuYWdlcjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS5saWIubG9nLkxvZzsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5saWIudXRpbC5Mb2NhbGl6ZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEubWV0YS5DbGFzc01ldGFEYXRhOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLm1ldGEuRmllbGRNZXRhRGF0YTsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5tZXRhLkphdmFUeXBlczsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS51dGlsLkFwcGxpY2F0aW9uSWRzOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLnV0aWwuSW1wbEhlbHBlcjsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS51dGlsLkludGVybmFsRXhjZXB0aW9uOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLnV0aWwuTWV0YURhdGFFeGNlcHRpb247CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEudXRpbC5PcGVuSlBBSWQ7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEudXRpbC5VbnN1cHBvcnRlZEV4Y2VwdGlvbjsKaW1wb3J0\nIHNlcnAudXRpbC5OdW1iZXJzOwoKLyoqCiAqIE1hcHBpbmcgZm9yIGEgc2lu\nZ2xlLXZhbHVlZCByZWxhdGlvbiB0byBhbm90aGVyIGVudGl0eS4KICoKICog\nQGF1dGhvciBBYmUgV2hpdGUKICogQHNpbmNlIDAuNC4wCiAqLwpwdWJsaWMg\nY2xhc3MgUmVsYXRpb25GaWVsZFN0cmF0ZWd5CiAgICBleHRlbmRzIEFic3Ry\nYWN0RmllbGRTdHJhdGVneQogICAgaW1wbGVtZW50cyBKb2luYWJsZSwgRW1i\nZWRkYWJsZSB7CgogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgTG9jYWxpemVy\nIF9sb2MgPSBMb2NhbGl6ZXIuZm9yUGFja2FnZQogICAgICAgIChSZWxhdGlv\nbkZpZWxkU3RyYXRlZ3kuY2xhc3MpOwoKICAgIHByaXZhdGUgQm9vbGVhbiBf\nZmtPaWQgPSBudWxsOwogICAgCiAgICBwdWJsaWMgdm9pZCBtYXAoYm9vbGVh\nbiBhZGFwdCkgewogICAgICAgIGlmIChmaWVsZC5nZXRUeXBlQ29kZSgpICE9\nIEphdmFUeXBlcy5QQyB8fCBmaWVsZC5pc0VtYmVkZGVkUEMoKSkKICAgICAg\nICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0KCJu\nb3QtcmVsYXRpb24iLCBmaWVsZCkpOwoKICAgICAgICBmaWVsZC5nZXRLZXlN\nYXBwaW5nKCkuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25l\nbnRzCiAgICAgICAgICAgIChmaWVsZC5nZXRLZXkoKSwgIWFkYXB0KTsKICAg\nICAgICBpZiAoIWZpZWxkLmlzTm9uRGVmYXVsdE1hcHBpbmdVc2luZ0pvaW5U\nYWJsZVN0cmF0ZWd5KCkpCiAgICAgICAgICAgIGZpZWxkLmdldEVsZW1lbnRN\nYXBwaW5nKCkuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25l\nbnRzCiAgICAgICAgICAgICAgICAoZmllbGQuZ2V0RWxlbWVudCgpLCAhYWRh\ncHQpOwogICAgICAgIGJvb2xlYW4gY3JpdGVyaWEgPSBmaWVsZC5nZXRWYWx1\nZUluZm8oKS5nZXRVc2VDbGFzc0NyaXRlcmlhKCk7CgogICAgICAgIC8vIGNo\nZWNrIGZvciBuYW1lZCBpbnZlcnNlCiAgICAgICAgRmllbGRNYXBwaW5nIG1h\ncHBlZCA9IGZpZWxkLmdldE1hcHBlZEJ5TWFwcGluZygpOwogICAgICAgIGlm\nIChtYXBwZWQgIT0gbnVsbCkgewogICAgICAgICAgICBmaWVsZC5nZXRNYXBw\naW5nSW5mbygpLmFzc2VydE5vU2NoZW1hQ29tcG9uZW50cyhmaWVsZCwgIWFk\nYXB0KTsKICAgICAgICAgICAgZmllbGQuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0\nTm9TY2hlbWFDb21wb25lbnRzKGZpZWxkLCAhYWRhcHQpOwogICAgICAgICAg\nICBtYXBwZWQucmVzb2x2ZShtYXBwZWQuTU9ERV9NRVRBIHwgbWFwcGVkLk1P\nREVfTUFQUElORyk7CgogICAgICAgICAgICBpZiAoIW1hcHBlZC5pc01hcHBl\nZCgpIHx8IG1hcHBlZC5pc1NlcmlhbGl6ZWQoKSkKICAgICAgICAgICAgICAg\nIHRocm93IG5ldyBNZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdldCgibWFwcGVk\nLWJ5LXVubWFwcGVkIiwKICAgICAgICAgICAgICAgICAgICBmaWVsZCwgbWFw\ncGVkKSk7CgogICAgICAgICAgICBpZiAobWFwcGVkLmdldFR5cGVDb2RlKCkg\nPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAobWFwcGVk\nLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBtYXBwZWQuSk9JTl9GT1JXQVJEKSB7\nCiAgICAgICAgICAgICAgICAgICAgZmllbGQuc2V0Sm9pbkRpcmVjdGlvbihm\naWVsZC5KT0lOX0lOVkVSU0UpOwogICAgICAgICAgICAgICAgICAgIGZpZWxk\nLnNldENvbHVtbnMobWFwcGVkLmdldERlZmluaW5nTWFwcGluZygpLgogICAg\nICAgICAgICAgICAgICAgICAgICBnZXRQcmltYXJ5S2V5Q29sdW1ucygpKTsK\nICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNUeXBlVW5qb2luZWRTdWJj\nbGFzcyhtYXBwZWQpKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBN\nZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdldAogICAgICAgICAgICAgICAgICAg\nICAgICAoIm1hcHBlZC1pbnZlcnNlLXVuam9pbmVkIiwgZmllbGQuZ2V0TmFt\nZSgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0RGVm\naW5pbmdNYXBwaW5nKCksIG1hcHBlZCkpOwoKICAgICAgICAgICAgICAgIGZp\nZWxkLnNldEZvcmVpZ25LZXkobWFwcGVkLmdldEZvcmVpZ25LZXkKICAgICAg\nICAgICAgICAgICAgICAoZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkpKTsK\nICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWQuZ2V0RWxlbWVudCgpLmdl\ndFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAgICAgICAgICAg\nICBpZiAoaXNUeXBlVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQuZ2V0RWxlbWVu\ndE1hcHBpbmcoKSkpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1l\ndGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0CiAgICAgICAgICAgICAgICAgICAg\nICAgICgibWFwcGVkLWludmVyc2UtdW5qb2luZWQiLCBmaWVsZC5nZXROYW1l\nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXREZWZp\nbmluZ01hcHBpbmcoKSwgbWFwcGVkKSk7CgogICAgICAgICAgICAgICAgLy8g\nd2FybiB0aGUgdXNlciBhYm91dCBtYWtpbmcgdGhlIGNvbGxlY3Rpb24gc2lk\nZSB0aGUgb3duZXIKICAgICAgICAgICAgICAgIExvZyBsb2cgPSBmaWVsZC5n\nZXRSZXBvc2l0b3J5KCkuZ2V0TG9nKCk7CiAgICAgICAgICAgICAgICBpZiAo\nbG9nLmlzSW5mb0VuYWJsZWQoKSkKICAgICAgICAgICAgICAgICAgICBsb2cu\naW5mbyhfbG9jLmdldCgiY29sbC1vd25lciIsIGZpZWxkLCBtYXBwZWQpKTsK\nICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkobWFwcGVkLmdl\ndEVsZW1lbnRNYXBwaW5nKCkuCiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9y\nZWlnbktleSgpKTsKICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAg\nICB0aHJvdyBuZXcgTWV0YURhdGFFeGNlcHRpb24oX2xvYy5nZXQoIm5vdC1p\nbnYtcmVsYXRpb24iLAogICAgICAgICAgICAgICAgICAgIGZpZWxkLCBtYXBw\nZWQpKTsKCiAgICAgICAgICAgIGZpZWxkLnNldFVzZUNsYXNzQ3JpdGVyaWEo\nY3JpdGVyaWEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfSAKCiAg\nICAgICAgLy8gdGhpcyBpcyBuZWNlc3NhcnkgdG8gc3VwcG9ydCBvcGVuanBh\nIDMgbWFwcGluZ3MsIHdoaWNoIGRpZG4ndAogICAgICAgIC8vIGRpZmZlcmVu\ndGlhdGUgYmV0d2VlbiBzZWNvbmRhcnkgdGFibGUgam9pbnMgYW5kIHJlbGF0\naW9ucyBidWlsdAogICAgICAgIC8vIGFyb3VuZCBhbiBpbnZlcnNlIGtleTog\nY2hlY2sgdG8gc2VlIGlmIHdlJ3JlIG1hcHBlZCBhcyBhIHNlY29uZGFyeQog\nICAgICAgIC8vIHRhYmxlIGpvaW4gYnV0IHdlJ3JlIGluIHRoZSB0YWJsZSBv\nZiB0aGUgcmVsYXRlZCB0eXBlLCBhbmQgaWYgc28KICAgICAgICAvLyBzd2l0\nY2ggb3VyIGpvaW4gbWFwcGluZyBpbmZvIHRvIG91ciB2YWx1ZSBtYXBwaW5n\nIGluZm8KICAgICAgICBTdHJpbmcgdGFibGVOYW1lID0gZmllbGQuZ2V0TWFw\ncGluZ0luZm8oKS5nZXRUYWJsZU5hbWUoKTsKICAgICAgICBUYWJsZSB0YWJs\nZSA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCkuZ2V0VGFibGUoKTsKICAgICAg\nICBWYWx1ZU1hcHBpbmdJbmZvIHZpbmZvID0gZmllbGQuZ2V0VmFsdWVJbmZv\nKCk7CiAgICAgICAgaWYgKHRhYmxlTmFtZSAhPSBudWxsICYmIHRhYmxlICE9\nIG51bGwKICAgICAgICAgICAgJiYgKHRhYmxlTmFtZS5lcXVhbHNJZ25vcmVD\nYXNlKHRhYmxlLmdldE5hbWUoKSkKICAgICAgICAgICAgfHwgdGFibGVOYW1l\nLmVxdWFsc0lnbm9yZUNhc2UodGFibGUuZ2V0RnVsbE5hbWUoKSkpKSB7CiAg\nICAgICAgICAgIHZpbmZvLnNldEpvaW5EaXJlY3Rpb24oTWFwcGluZ0luZm8u\nSk9JTl9JTlZFUlNFKTsKICAgICAgICAgICAgdmluZm8uc2V0Q29sdW1ucyhm\naWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldENvbHVtbnMoKSk7CiAgICAgICAg\nICAgIGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuc2V0VGFibGVOYW1lKG51bGwp\nOwogICAgICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLnNldENvbHVt\nbnMobnVsbCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghZmll\nbGQuaXNCaU1UbzFKVCgpKQogICAgICAgICAgICBmaWVsZC5tYXBKb2luKGFk\nYXB0LCBmYWxzZSk7CiAgICAgICAgaWYgKGZpZWxkLmdldFR5cGVNYXBwaW5n\nKCkuaXNNYXBwZWQoKSkgewogICAgICAgICAgICBpZiAoZmllbGQuZ2V0TWFw\ncGVkQnlJZFZhbHVlKCkgIT0gbnVsbCkgCiAgICAgICAgICAgICAgICBzZXRN\nYXBwZWRCeUlkQ29sdW1ucygpOyAgICAgICAgICAgIAogICAgICAgICAgICAg\nCiAgICAgICAgICAgIGlmICghZmllbGQuaXNCaU1UbzFKVCgpKSB7CiAgICAg\nICAgICAgICAgICBGb3JlaWduS2V5IGZrID0gdmluZm8uZ2V0VHlwZUpvaW4o\nZmllbGQsIGZpZWxkLmdldE5hbWUoKSwgdHJ1ZSwKICAgICAgICAgICAgICAg\nICAgICBhZGFwdCk7CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWdu\nS2V5KGZrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaWVsZC5zZXRD\nb2x1bW5JTyh2aW5mby5nZXRDb2x1bW5JTygpKTsKICAgICAgICAgICAgaWYg\nKHZpbmZvLmdldEpvaW5EaXJlY3Rpb24oKSA9PSB2aW5mby5KT0lOX0lOVkVS\nU0UpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRKb2luRGlyZWN0aW9uKGZp\nZWxkLkpPSU5fSU5WRVJTRSk7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICAg\nIFJlbGF0aW9uU3RyYXRlZ2llcy5tYXBSZWxhdGlvblRvVW5tYXBwZWRQQyhm\naWVsZCwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAgYWRhcHQp\nOwoKICAgICAgICBmaWVsZC5zZXRVc2VDbGFzc0NyaXRlcmlhKGNyaXRlcmlh\nKTsKICAgICAgICBmaWVsZC5tYXBQcmltYXJ5S2V5KGFkYXB0KTsKICAgICAg\nICBQcmltYXJ5S2V5IHBrID0gZmllbGQuZ2V0VGFibGUoKS5nZXRQcmltYXJ5\nS2V5KCk7CiAgICAgICAgaWYgKGZpZWxkLmlzUHJpbWFyeUtleSgpKSB7CiAg\nICAgICAgICAgIENvbHVtbltdIGNvbHMgPSBmaWVsZC5nZXRDb2x1bW5zKCk7\nCiAgICAgICAgICAgIGlmIChwayAhPSBudWxsICYmIChhZGFwdCB8fCBway5p\nc0xvZ2ljYWwoKSkpCiAgICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsg\naSA8IGNvbHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgcGsu\nYWRkQ29sdW1uKGNvbHNbaV0pOwogICAgICAgICAgICBmb3IgKGludCBpID0g\nMDsgaSA8IGNvbHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICBmaWVs\nZC5nZXREZWZpbmluZ01hcHBpbmcoKS5zZXRKb2luYWJsZShjb2xzW2ldLCB0\naGlzKTsKICAgICAgICB9CgogICAgICAgIC8vIG1hcCBjb25zdHJhaW50cyBh\nZnRlciBwayBzbyB3ZSBkb24ndCByZS1pbmRleCAvIHJlLXVuaXF1ZSBwayBj\nb2wKICAgICAgICBmaWVsZC5tYXBDb25zdHJhaW50cyhmaWVsZC5nZXROYW1l\nKCksIGFkYXB0KTsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZW4gdGhlcmUg\naXMgTWFwcGVkQnlJZCBhbm5vdGF0aW9uLCB0aGUgb3duZXIgb2YgdGhlIG9u\nZS10by1vbmUvCiAgICAgKiBtYW55LXRvLW9uZSByZWxhdGlvbnNoaXAgd2ls\nbCB1c2UgaXRzIHByaW1hcnkga2V5IHRvIHJlcHJlc2VudCAKICAgICAqIGZv\ncmVpZ24ga2V5IHJlbGF0aW9uLiBObyBuZWVkIHRvIGNyZWF0ZSBhIHNlcGFy\nYXRlIGZvcmVpZ24ga2V5CiAgICAgKiBjb2x1bW4uIAogICAgICovCiAgICBw\ncml2YXRlIHZvaWQgc2V0TWFwcGVkQnlJZENvbHVtbnMoKSB7CiAgICAgICAg\nQ2xhc3NNZXRhRGF0YSBvd25lciA9IGZpZWxkLmdldERlZmluaW5nTWV0YURh\ndGEoKTsKICAgICAgICBGaWVsZE1ldGFEYXRhW10gcGtzID0gb3duZXIuZ2V0\nUHJpbWFyeUtleUZpZWxkcygpOwogICAgICAgIGZvciAoaW50IGkgPSAwOyBp\nIDwgcGtzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEZpZWxkTWFwcGlu\nZyBmbSA9IChGaWVsZE1hcHBpbmcpIHBrc1tpXTsKICAgICAgICAgICAgVmFs\ndWVNYXBwaW5nSW1wbCB2YWwgPSAoVmFsdWVNYXBwaW5nSW1wbCkgZmllbGQu\nZ2V0VmFsdWUoKTsKICAgICAgICAgICAgVmFsdWVNYXBwaW5nSW5mbyBpbmZv\nID0gdmFsLmdldFZhbHVlSW5mbygpOwogICAgICAgICAgICBpbmZvLnNldENv\nbHVtbnMoZ2V0TWFwcGVkQnlJZENvbHVtbnMoZm0pKTsKICAgICAgICB9CiAg\nICB9CgogICAgcHJpdmF0ZSBMaXN0IGdldE1hcHBlZEJ5SWRDb2x1bW5zKEZp\nZWxkTWFwcGluZyBwaykgewogICAgICAgIENsYXNzTWV0YURhdGEgZW1iZWRk\nZWRJZCA9ICgoVmFsdWVNYXBwaW5nSW1wbClway5nZXRWYWx1ZSgpKS4KICAg\nICAgICAgICAgZ2V0RW1iZWRkZWRNZXRhRGF0YSgpOwogICAgICAgIENvbHVt\nbltdIHBrQ29scyA9IG51bGw7CiAgICAgICAgTGlzdCBjb2xzID0gbmV3IEFy\ncmF5TGlzdCgpOwogICAgICAgIFN0cmluZyBtYXBwZWRCeUlkVmFsdWUgPSBm\naWVsZC5nZXRNYXBwZWRCeUlkVmFsdWUoKTsKICAgICAgICBpZiAoZW1iZWRk\nZWRJZCAhPSBudWxsKSB7CiAgICAgICAgICAgIEZpZWxkTWV0YURhdGFbXSBm\nbWRzID0gZW1iZWRkZWRJZC5nZXRGaWVsZHMoKTsKICAgICAgICAgICAgZm9y\nIChpbnQgaSA9IDA7IGkgPCBmbWRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAg\nICAgICAgICBpZiAoKGZtZHNbaV0uZ2V0TmFtZSgpLmVxdWFscyhtYXBwZWRC\neUlkVmFsdWUpKSB8fAogICAgICAgICAgICAgICAgICAgIG1hcHBlZEJ5SWRW\nYWx1ZS5sZW5ndGgoKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYg\nKGZtZHNbaV0uZ2V0VmFsdWUoKS5nZXRFbWJlZGRlZE1ldGFEYXRhKCkgIT0g\nbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBFbWJlZFZhbHVlSGFu\nZGxlci5nZXRFbWJlZGRlZElkQ29scygKICAgICAgICAgICAgICAgICAgICAg\nICAgICAgICAgICAoRmllbGRNYXBwaW5nKWZtZHNbaV0sIGNvbHMpOwogICAg\nICAgICAgICAgICAgICAgIH0gZWxzZSAKICAgICAgICAgICAgICAgICAgICAg\nICAgRW1iZWRWYWx1ZUhhbmRsZXIuZ2V0SWRDb2x1bW5zKAogICAgICAgICAg\nICAgICAgICAgICAgICAgICAgICAgIChGaWVsZE1hcHBpbmcpZm1kc1tpXSwg\nY29scyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAg\nICAgICAgcmV0dXJuIGNvbHM7CiAgICAgICAgfSBlbHNlIHsgLy8gcHJpbWFy\neSBrZXkgaXMgc2luZ2xlLXZhbHVlCiAgICAgICAgICAgIENsYXNzIHBrVHlw\nZSA9IHBrLmdldERlY2xhcmVkVHlwZSgpOwogICAgICAgICAgICBGaWVsZE1l\ndGFEYXRhW10gcGtzID0gZmllbGQuZ2V0VmFsdWUoKS5nZXREZWNsYXJlZFR5\ncGVNZXRhRGF0YSgpLgogICAgICAgICAgICAgICAgICAgIGdldFByaW1hcnlL\nZXlGaWVsZHMoKTsKICAgICAgICAgICAgaWYgKHBrcy5sZW5ndGggIT0gMSB8\nfCBwa3NbMF0uZ2V0RGVjbGFyZWRUeXBlKCkgIT0gcGtUeXBlKQogICAgICAg\nICAgICAgICAgcmV0dXJuIENvbGxlY3Rpb25zLkVNUFRZX0xJU1Q7CiAgICAg\nICAgICAgIHBrQ29scyA9IHBrLmdldENvbHVtbnMoKTsKICAgICAgICAgICAg\nZm9yIChpbnQgaSA9IDA7IGkgPCBwa0NvbHMubGVuZ3RoOyBpKyspCiAgICAg\nICAgICAgICAgICBjb2xzLmFkZChwa0NvbHNbaV0pOwogICAgICAgICAgICBy\nZXR1cm4gY29sczsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBS\nZXR1cm4gd2hldGhlciBvdXIgZGVmaW5pbmcgbWFwcGluZyBpcyBhbiB1bmpv\naW5lZCBzdWJjbGFzcyBvZgogICAgICogdGhlIHR5cGUgb2YgdGhlIGdpdmVu\nIHZhbHVlLgogICAgICovCiAgICBwcml2YXRlIGJvb2xlYW4gaXNUeXBlVW5q\nb2luZWRTdWJjbGFzcyhWYWx1ZU1hcHBpbmcgbWFwcGVkKSB7CiAgICAgICAg\nQ2xhc3NNYXBwaW5nIGRlZiA9IGZpZWxkLmdldERlZmluaW5nTWFwcGluZygp\nOwogICAgICAgIGZvciAoOyBkZWYgIT0gbnVsbDsgZGVmID0gZGVmLmdldEpv\naW5hYmxlUENTdXBlcmNsYXNzTWFwcGluZygpKQogICAgICAgICAgICBpZiAo\nZGVmID09IG1hcHBlZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAgICAgICAg\nICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoK\nICAgIHB1YmxpYyB2b2lkIGluaXRpYWxpemUoKSB7CiAgICAgICAgZmllbGQu\nc2V0VXNlc0ludGVybWVkaWF0ZSh0cnVlKTsKCiAgICAgICAgRm9yZWlnbktl\neSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBpZiAoZmsg\nPT0gbnVsbCkKICAgICAgICAgICAgX2ZrT2lkID0gQm9vbGVhbi5UUlVFOwog\nICAgICAgIGVsc2UgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSAhPSBG\naWVsZE1hcHBpbmcuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICBfZmtPaWQg\nPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpLmlzRm9yZWlnbktleU9iamVjdElk\nKGZrKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbnNlcnQoT3BlbkpQQVN0\nYXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJt\nKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChm\naWVsZC5nZXRNYXBwZWRCeSgpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVy\nbjsKCiAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBSZWxhdGlv\nblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyCiAgICAgICAgICAgIChzbS5m\nZXRjaE9iamVjdEZpZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9yZS5nZXRD\nb250ZXh0KCkpOwogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGlyZWN0aW9u\nKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICB1cGRhdGVJ\nbnZlcnNlKHNtLCByZWwsIHN0b3JlLCBybSk7CiAgICAgICAgZWxzZSB7CiAg\nICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3coc20sIHN0b3JlLCBy\nbSwgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAgICAgICBpZiAocm93ICE9\nIG51bGwgJiYgIWZpZWxkLmlzQmlNVG8xSlQoKSkgewogICAgICAgICAgICAg\nICAgZmllbGQuc2V0Rm9yZWlnbktleShyb3csIHJlbCk7CiAgICAgICAgICAg\nICAgICAvLyB0aGlzIGlzIGZvciBiaS1kaXJlY3Rpb25hbCBtYXBzLCB0aGUg\na2V5IGFuZCB2YWx1ZSBvZiB0aGUgCiAgICAgICAgICAgICAgICAvLyBtYXAg\nYXJlIHN0b3JlZCBpbiB0aGUgdGFibGUgb2YgdGhlIG1hcHBlZC1ieSBlbnRp\ndHkgIAogICAgICAgICAgICAgICAgc2V0TWFwS2V5KHNtLCByZWwsIHN0b3Jl\nLCByb3cpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAg\nICBwcml2YXRlIHZvaWQgc2V0TWFwS2V5KE9wZW5KUEFTdGF0ZU1hbmFnZXIg\nc20sIE9wZW5KUEFTdGF0ZU1hbmFnZXIgcmVsLCAKICAgICAgICBKREJDU3Rv\ncmUgc3RvcmUsIFJvdyByb3cpIHRocm93cyBTUUxFeGNlcHRpb24gewogICAg\nICAgIGlmIChyZWwgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwogICAg\nICAgIENsYXNzTWV0YURhdGEgbWV0YSA9IHJlbC5nZXRNZXRhRGF0YSgpOwog\nICAgICAgIEZpZWxkTWFwcGluZyBtYXBGaWVsZCA9IGdldE1hcEZpZWxkKG1l\ndGEpOwogICAgICAgIAogICAgICAgIC8vIHRoZXJlIGlzIG5vIGJpLWRpcmVj\ndGlvbmFsIG1hcCBmaWVsZAogICAgICAgIGlmIChtYXBGaWVsZCA9PSBudWxs\nKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgCiAgICAgICAgTWFwIG1h\ncE9iaiA9IChNYXApcmVsLmZldGNoT2JqZWN0RmllbGQobWFwRmllbGQuZ2V0\nSW5kZXgoKSk7CiAgICAgICAgT2JqZWN0IGtleU9iaiA9IGdldE1hcEtleU9i\naihtYXBPYmosIHNtLmdldFBlcnNpc3RlbmNlQ2FwYWJsZSgpKTsKICAgICAg\nICBWYWx1ZU1hcHBpbmcga2V5ID0gbWFwRmllbGQuZ2V0S2V5TWFwcGluZygp\nOwogICAgICAgIGlmICgha2V5LmlzRW1iZWRkZWQoKSkgewogICAgICAgICAg\nICBpZiAoa2V5T2JqIGluc3RhbmNlb2YgUGVyc2lzdGVuY2VDYXBhYmxlKSB7\nCiAgICAgICAgICAgICAgICBPcGVuSlBBU3RhdGVNYW5hZ2VyIGtleVNtID0g\nUmVsYXRpb25TdHJhdGVnaWVzLgogICAgICAgICAgICAgICAgICAgIGdldFN0\nYXRlTWFuYWdlcihrZXlPYmosIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAg\nICAgICAgICAgICAvLyBrZXkgaXMgYW4gZW50aXR5CiAgICAgICAgICAgICAg\nICBGb3JlaWduS2V5IGZrID0gbWFwRmllbGQuZ2V0S2V5TWFwcGluZygpLgog\nICAgICAgICAgICAgICAgICAgIGdldEZvcmVpZ25LZXkoKTsKICAgICAgICAg\nICAgICAgIENvbHVtbklPIGlvID0gbmV3IENvbHVtbklPKCk7CiAgICAgICAg\nICAgICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgaW8sIGtleVNtKTsKICAg\nICAgICAgICAgfSAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBr\nZXkgaXMgYW4gZW1iZWRkYWJsZSBvciBiYXNpYyB0eXBlCiAgICAgICAgICAg\nIEZpZWxkU3RyYXRlZ3kgc3RyYXRlZ3kgPSBtYXBGaWVsZC5nZXRTdHJhdGVn\neSgpOyAKICAgICAgICAgICAgaWYgKHN0cmF0ZWd5IGluc3RhbmNlb2YgIAog\nICAgICAgICAgICAgICAgICAgIEhhbmRsZXJSZWxhdGlvbk1hcFRhYmxlRmll\nbGRTdHJhdGVneSkgewogICAgICAgICAgICAgICAgSGFuZGxlclJlbGF0aW9u\nTWFwVGFibGVGaWVsZFN0cmF0ZWd5IHN0cmF0ID0gCiAgICAgICAgICAgICAg\nICAgICAgKEhhbmRsZXJSZWxhdGlvbk1hcFRhYmxlRmllbGRTdHJhdGVneSkg\nc3RyYXRlZ3k7CiAgICAgICAgICAgICAgICBDb2x1bW5bXSBrY29scyA9IHN0\ncmF0LmdldEtleUNvbHVtbnMoKENsYXNzTWFwcGluZyltZXRhKTsKICAgICAg\nICAgICAgICAgIENvbHVtbklPIGtpbyA9IHN0cmF0LmdldEtleUNvbHVtbklP\nKCk7CiAgICAgICAgICAgICAgICBIYW5kbGVyU3RyYXRlZ2llcy5zZXQoa2V5\nLCBrZXlPYmosIHN0b3JlLCByb3csIGtjb2xzLAogICAgICAgICAgICAgICAg\nICAgICAgICBraW8sIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSAK\nICAgIH0KICAgIAogICAgcHJpdmF0ZSBGaWVsZE1hcHBpbmcgZ2V0TWFwRmll\nbGQoQ2xhc3NNZXRhRGF0YSBtZXRhKSB7CiAgICAgICAgRmllbGRNYXBwaW5n\nW10gZmllbGRzID0gKChDbGFzc01hcHBpbmcpbWV0YSkuZ2V0RmllbGRNYXBw\naW5ncygpOwogICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgZmllbGRzLmxl\nbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEZpZWxkTWV0YURhdGEgbWFwcGVk\nQnkgPSBmaWVsZHNbaV0uZ2V0TWFwcGVkQnlNZXRhRGF0YSgpOwogICAgICAg\nICAgICBpZiAoZmllbGRzW2ldLmdldERlY2xhcmVkVHlwZUNvZGUoKSA9PSBK\nYXZhVHlwZXMuTUFQICYmCiAgICAgICAgICAgICAgICBtYXBwZWRCeSA9PSBm\naWVsZCkgIAogICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkc1tpXTsKICAg\nICAgICB9IAogICAgICAgIHJldHVybiBudWxsOyAgICAKICAgIH0KICAgIAog\nICAgcHJpdmF0ZSBPYmplY3QgZ2V0TWFwS2V5T2JqKE1hcCBtYXBPYmosIE9i\namVjdCB2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJl\nZmxlY3RpbmdQZXJzaXN0ZW5jZUNhcGFibGUpCiAgICAgICAgICAgIHZhbHVl\nID0gKChSZWZsZWN0aW5nUGVyc2lzdGVuY2VDYXBhYmxlKXZhbHVlKS5nZXRN\nYW5hZ2VkSW5zdGFuY2UoKTsgCiAgICAgICAgU2V0IGtleVNldCA9IG1hcE9i\nai5rZXlTZXQoKTsKICAgICAgICBmb3IgKE9iamVjdCBrZXkgOiBrZXlTZXQp\nIHsKICAgICAgICAgICAgaWYgKG1hcE9iai5nZXQoa2V5KSA9PSB2YWx1ZSkK\nICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgfQogICAgICAg\nIFNldDxNYXAuRW50cnk+IGVudHJpZXMgPSBtYXBPYmouZW50cnlTZXQoKTsK\nICAgICAgICBmb3IgKE1hcC5FbnRyeSBlbnRyeSA6IGVudHJpZXMpIHsKICAg\nICAgICAgICAgaWYgKGVudHJ5LmdldFZhbHVlKCkgPT0gdmFsdWUpCiAgICAg\nICAgICAgICAgICByZXR1cm4gZW50cnkuZ2V0S2V5KCk7CiAgICAgICAgfQog\nICAgIAogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHB1YmxpYyB2\nb2lkIHVwZGF0ZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUg\nc3RvcmUsIFJvd01hbmFnZXIgcm0pCiAgICAgICAgdGhyb3dzIFNRTEV4Y2Vw\ndGlvbiB7CiAgICAgICAgaWYgKGZpZWxkLmdldE1hcHBlZEJ5KCkgIT0gbnVs\nbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBPcGVuSlBBU3RhdGVN\nYW5hZ2VyIHJlbCA9IFJlbGF0aW9uU3RyYXRlZ2llcy5nZXRTdGF0ZU1hbmFn\nZXIKICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0RmllbGQoZmllbGQuZ2V0\nSW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CgogICAgICAgIGlmIChm\naWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNF\nKSB7CiAgICAgICAgICAgIG51bGxJbnZlcnNlKHNtLCBybSk7CiAgICAgICAg\nICAgIHVwZGF0ZUludmVyc2Uoc20sIHJlbCwgc3RvcmUsIHJtKTsKICAgICAg\nICB9IGVsc2UgewogICAgICAgICAgICBpbnQgYWN0aW9uID0gKHJlbCA9PSBu\ndWxsICYmIAogICAgICAgICAgICAgICAgICAgIGZpZWxkLmlzQmlkaXJlY3Rp\nb25hbEpvaW5UYWJsZU1hcHBpbmdOb25Pd25lcigpKSA/CiAgICAgICAgICAg\nICAgICAgICAgUm93LkFDVElPTl9ERUxFVEUgOiBSb3cuQUNUSU9OX1VQREFU\nRTsKICAgICAgICAgICAgUm93IHJvdyA9IGZpZWxkLmdldFJvdyhzbSwgc3Rv\ncmUsIHJtLCBhY3Rpb24pOwogICAgICAgICAgICBpZiAocm93ICE9IG51bGwg\nJiYgIWZpZWxkLmlzQmlNVG8xSlQoKSkgewogICAgICAgICAgICAgICAgZmll\nbGQuc2V0Rm9yZWlnbktleShyb3csIHJlbCk7CiAgICAgICAgICAgICAgICAv\nLyB0aGlzIGlzIGZvciBiaS1kaXJlY3Rpb25hbCBtYXBzLCB0aGUga2V5IGFu\nZCB2YWx1ZSBvZiB0aGUgCiAgICAgICAgICAgICAgICAvLyBtYXAgYXJlIHN0\nb3JlZCBpbiB0aGUgdGFibGUgb2YgdGhlIG1hcHBlZC1ieSBlbnRpdHkgIAog\nICAgICAgICAgICAgICAgc2V0TWFwS2V5KHNtLCByZWwsIHN0b3JlLCByb3cp\nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAo\nZmllbGQuaXNCaU1UbzFKVCgpKSB7IC8vIGFsc28gbmVlZCB0byB1cGRhdGUg\ndGhlIGpvaW4gdGFibGUKICAgICAgICAgICAgICAgIFBlcnNpc3RlbmNlQ2Fw\nYWJsZSBpbnZQQyA9IChQZXJzaXN0ZW5jZUNhcGFibGUpc20uZmV0Y2hPYmpl\nY3QoCiAgICAgICAgICAgICAgICAgICAgZmllbGQuZ2V0QmlfMVRvTV9KVEZp\nZWxkKCkuZ2V0SW5kZXgoKSk7CiAgICAgICAgICAgICAgICBSb3cgc2Vjb25k\nYXJ5Um93ID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChpbnZQQyAhPSBu\ndWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5Um93ID0gcm0u\nZ2V0U2Vjb25kYXJ5Um93KGZpZWxkLmdldEJpMVRvTUpvaW5GSygpLmdldFRh\nYmxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJT05fSU5T\nRVJUKTsKICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlSb3cuc2V0Rm9y\nZWlnbktleShmaWVsZC5nZXRCaTFUb01FbGVtRksoKSwgbnVsbCwgc20pOwog\nICAgICAgICAgICAgICAgICAgIHNlY29uZGFyeVJvdy5zZXRGb3JlaWduS2V5\nKGZpZWxkLmdldEJpMVRvTUpvaW5GSygpLCBudWxsLCAKICAgICAgICAgICAg\nICAgICAgICAgICAgUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncihpbnZQQywKICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmUuZ2V0Q29u\ndGV4dCgpKSk7CiAgICAgICAgICAgICAgICAgICAgcm0uZmx1c2hTZWNvbmRh\ncnlSb3coc2Vjb25kYXJ5Um93KTsKICAgICAgICAgICAgICAgIH0KICAgICAg\nICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgdm9pZCBkZWxl\ndGUoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBS\nb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewog\nICAgICAgIGlmIChmaWVsZC5nZXRNYXBwZWRCeSgpICE9IG51bGwpCiAgICAg\nICAgICAgIHJldHVybjsKCiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJl\nY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0UpIHsKICAgICAgICAgICAg\naWYgKHNtLmdldExvYWRlZCgpLmdldChmaWVsZC5nZXRJbmRleCgpKSkgewog\nICAgICAgICAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBSZWxh\ndGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKHNtLgogICAgICAgICAg\nICAgICAgICAgIGZldGNoT2JqZWN0RmllbGQoZmllbGQuZ2V0SW5kZXgoKSks\nIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAgICAgICAgICAgICB1cGRhdGVJ\nbnZlcnNlKHNtLCByZWwsIHN0b3JlLCBybSk7CiAgICAgICAgICAgIH0gZWxz\nZQogICAgICAgICAgICAgICAgbnVsbEludmVyc2Uoc20sIHJtKTsKICAgICAg\nICB9IGVsc2UgewogICAgICAgICAgICBmaWVsZC5kZWxldGVSb3coc20sIHN0\nb3JlLCBybSk7CgogICAgICAgICAgICAvLyBpZiBvdXIgZm9yZWlnbiBrZXkg\naGFzIGEgZGVsZXRlIGFjdGlvbiwgd2UgbmVlZCB0byBzZXQgdGhlCiAgICAg\nICAgICAgIC8vIHJlbGF0ZWQgb2JqZWN0IHNvIGNvbnN0cmFpbnRzIGNhbiBi\nZSBldmFsdWF0ZWQKICAgICAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciBy\nZWwgPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyCiAgICAg\nICAgICAgICAgICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJbmRl\neCgpKSwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKICAgICAgICAgICAgaWYgKHJl\nbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBGb3JlaWduS2V5IGZrID0g\nZmllbGQuZ2V0Rm9yZWlnbktleSgoQ2xhc3NNYXBwaW5nKQogICAgICAgICAg\nICAgICAgICAgIHJlbC5nZXRNZXRhRGF0YSgpKTsKICAgICAgICAgICAgICAg\nIGlmIChmay5nZXREZWxldGVBY3Rpb24oKSA9PSBGb3JlaWduS2V5LkFDVElP\nTl9SRVNUUklDVCB8fAogICAgICAgICAgICAgICAgICAgIGZrLmdldERlbGV0\nZUFjdGlvbigpID09IEZvcmVpZ25LZXkuQUNUSU9OX0NBU0NBREUpIHsKICAg\nICAgICAgICAgICAgICAgICBSb3cgcm93ID0gZmllbGQuZ2V0Um93KHNtLCBz\ndG9yZSwgcm0sIFJvdy5BQ1RJT05fREVMRVRFKTsKICAgICAgICAgICAgICAg\nICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgbnVsbCwgcmVsKTsKICAgICAg\nICAgICAgICAgICAgICAvLyB0aGlzIGlzIGZvciBiaS1kaXJlY3Rpb25hbCBt\nYXBzLCB0aGUga2V5IGFuZCB2YWx1ZSBvZiB0aGUKICAgICAgICAgICAgICAg\nICAgICAvLyBtYXAgYXJlIHN0b3JlZCBpbiB0aGUgdGFibGUgb2YgdGhlIG1h\ncHBlZC1ieSBlbnRpdHkgIAogICAgICAgICAgICAgICAgICAgIHNldE1hcEtl\neShzbSwgcmVsLCBzdG9yZSwgcm93KTsKICAgICAgICAgICAgICAgIH0KICAg\nICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIE51\nbGwgaW52ZXJzZSByZWxhdGlvbnMgdGhhdCByZWZlcmVuY2UgdGhlIGdpdmVu\nIG9iamVjdC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIG51bGxJbnZlcnNl\nKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIFJvd01hbmFnZXIgcm0pCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKGZpZWxkLmdl\ndFVzZUNsYXNzQ3JpdGVyaWEoKSkKICAgICAgICAgICAgcmV0dXJuOwoKICAg\nICAgICBGb3JlaWduS2V5IGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwog\nICAgICAgIENvbHVtbklPIGlvID0gZmllbGQuZ2V0Q29sdW1uSU8oKTsKICAg\nICAgICBpZiAoIWlvLmlzQW55VXBkYXRhYmxlKGZrLCB0cnVlKSkKICAgICAg\nICAgICAgcmV0dXJuOwoKICAgICAgICAvLyBudWxsIGludmVyc2UgaWYgbm90\nIGFscmVhZHkgZW5mb3JjZWQgYnkgZmsKICAgICAgICBpZiAoZmllbGQuZ2V0\nSW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5ndGggIT0gMSkKICAgICAg\nICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJzYWJsZShm\naWVsZCk7CiAgICAgICAgUm93IHJvdyA9IHJtLmdldEFsbFJvd3MoZmsuZ2V0\nVGFibGUoKSwgUm93LkFDVElPTl9VUERBVEUpOwogICAgICAgIHJvdy5zZXRG\nb3JlaWduS2V5KGZrLCBpbywgbnVsbCk7CiAgICAgICAgcm93LndoZXJlRm9y\nZWlnbktleShmaywgc20pOwogICAgICAgIHJtLmZsdXNoQWxsUm93cyhyb3cp\nOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgdXBkYXRlcyB0\naGUgaW52ZXJzZSBjb2x1bW5zIG9mIG91ciByZWxhdGlvbgogICAgICogd2l0\naCB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICovCiAgICBwcml2YXRlIHZvaWQg\ndXBkYXRlSW52ZXJzZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBPcGVuSlBB\nU3RhdGVNYW5hZ2VyIHJlbCwKICAgICAgICBKREJDU3RvcmUgc3RvcmUsIFJv\nd01hbmFnZXIgcm0pCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAg\nICAgICAgaWYgKHJlbCA9PSBudWxsKQogICAgICAgICAgICByZXR1cm47Cgog\nICAgICAgIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7\nCiAgICAgICAgQ29sdW1uSU8gaW8gPSBmaWVsZC5nZXRDb2x1bW5JTygpOwoK\nICAgICAgICBpbnQgYWN0aW9uOwogICAgICAgIGlmIChyZWwuaXNOZXcoKSAm\nJiAhcmVsLmlzRmx1c2hlZCgpKSB7CiAgICAgICAgICAgIGlmIChzbS5pc0Rl\nbGV0ZWQoKSB8fCAhaW8uaXNBbnlJbnNlcnRhYmxlKGZrLCBmYWxzZSkpCiAg\nICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGFjdGlvbiA9IFJv\ndy5BQ1RJT05fSU5TRVJUOwogICAgICAgIH0gZWxzZSBpZiAocmVsLmlzRGVs\nZXRlZCgpKSB7CiAgICAgICAgICAgIGlmIChyZWwuaXNGbHVzaGVkKCkgfHwg\nIXNtLmlzRGVsZXRlZCgpKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAg\nICAgICAgICBhY3Rpb24gPSBSb3cuQUNUSU9OX0RFTEVURTsKICAgICAgICB9\nIGVsc2UgewogICAgICAgICAgICBpZiAoc20uaXNEZWxldGVkKCkpCiAgICAg\nICAgICAgICAgICBzbSA9IG51bGw7CiAgICAgICAgICAgIGlmICghaW8uaXNB\nbnlVcGRhdGFibGUoZmssIHNtID09IG51bGwpKQogICAgICAgICAgICAgICAg\ncmV0dXJuOwogICAgICAgICAgICBhY3Rpb24gPSBSb3cuQUNUSU9OX1VQREFU\nRTsKICAgICAgICB9CgogICAgICAgIGlmIChmaWVsZC5nZXRJbmRlcGVuZGVu\ndFR5cGVNYXBwaW5ncygpLmxlbmd0aCAhPSAxKQogICAgICAgICAgICB0aHJv\ndyBSZWxhdGlvblN0cmF0ZWdpZXMudW5pbnZlcnNhYmxlKGZpZWxkKTsKCiAg\nICAgICAgLy8gZ2V0IHRoZSByb3cgZm9yIHRoZSBpbnZlcnNlIG9iamVjdDsg\ndGhlIHJvdyBtaWdodCBiZSBpbiBhIHNlY29uZGFyeQogICAgICAgIC8vIHRh\nYmxlIGlmIHRoZXJlIGlzIGEgZmllbGQgY29udHJvbGxpbmcgdGhlIGZvcmVp\nZ24ga2V5CiAgICAgICAgUm93IHJvdyA9IG51bGw7CiAgICAgICAgRmllbGRN\nYXBwaW5nW10gaW52cyA9IGZpZWxkLmdldEludmVyc2VNYXBwaW5ncygpOwog\nICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgaW52cy5sZW5ndGg7IGkrKykg\newogICAgICAgICAgICBpZiAoaW52c1tpXS5nZXRNYXBwZWRCeU1ldGFEYXRh\nKCkgPT0gZmllbGQKICAgICAgICAgICAgICAgICYmIGludnNbaV0uZ2V0VHlw\nZUNvZGUoKSA9PSBKYXZhVHlwZXMuUEMpIHsKICAgICAgICAgICAgICAgIHJv\ndyA9IGludnNbaV0uZ2V0Um93KHJlbCwgc3RvcmUsIHJtLCBhY3Rpb24pOwog\nICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9\nCiAgICAgICAgQ2xhc3NNYXBwaW5nIHJlbE1hcHBpbmcgPSBmaWVsZC5nZXRU\neXBlTWFwcGluZygpOwogICAgICAgIGlmIChyb3cgPT0gbnVsbCkKICAgICAg\nICAgICAgcm93ID0gcm0uZ2V0Um93KHJlbE1hcHBpbmcuZ2V0VGFibGUoKSwg\nYWN0aW9uLCByZWwsIHRydWUpOwoKICAgICAgICAvLyBpZiB0aGlzIGlzIGFu\nIHVwZGF0ZSwgdGhpcyBtaWdodCBiZSB0aGUgb25seSBtb2QgdG8gdGhlIHJv\ndywgc28KICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHdoZXJlIGNvbmRpdGlv\nbiBpcyBzZXQKICAgICAgICBpZiAoYWN0aW9uID09IFJvdy5BQ1RJT05fVVBE\nQVRFCiAgICAgICAgICAgICYmIHJvdy5nZXRUYWJsZSgpID09IHJlbE1hcHBp\nbmcuZ2V0VGFibGUoKSkKICAgICAgICAgICAgcm93LndoZXJlUHJpbWFyeUtl\neShyZWwpOwoKICAgICAgICAvLyB1cGRhdGUgdGhlIGludmVyc2UgcG9pbnRl\nciB3aXRoIG91ciBvaWQgdmFsdWUKICAgICAgICByb3cuc2V0Rm9yZWlnbktl\neShmaywgaW8sIHNtKTsKICAgIH0KCiAgICBwdWJsaWMgaW50IHN1cHBvcnRz\nU2VsZWN0KFNlbGVjdCBzZWwsIGludCB0eXBlLCBPcGVuSlBBU3RhdGVNYW5h\nZ2VyIHNtLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29u\nZmlndXJhdGlvbiBmZXRjaCkgewogICAgICAgIGlmICh0eXBlID09IFNlbGVj\ndC5UWVBFX0pPSU5MRVNTKQogICAgICAgICAgICByZXR1cm4gKGZpZWxkLmdl\ndEpvaW5EaXJlY3Rpb24oKSAhPSBmaWVsZC5KT0lOX0lOVkVSU0UKICAgICAg\nICAgICAgICAgICYmIHNlbC5pc1NlbGVjdGVkKGZpZWxkLmdldFRhYmxlKCkp\nKSA/IDEgOiAwOwogICAgICAgIGlmICh0eXBlID09IFNlbGVjdC5UWVBFX1RX\nT19QQVJUKQogICAgICAgICAgICByZXR1cm4gMTsKCiAgICAgICAgLy8gYWxy\nZWFkeSBjYWNoZWQ/CiAgICAgICAgaWYgKHNtICE9IG51bGwpIHsKICAgICAg\nICAgICAgT2JqZWN0IG9pZCA9IHNtLmdldEludGVybWVkaWF0ZShmaWVsZC5n\nZXRJbmRleCgpKTsKICAgICAgICAgICAgaWYgKHN0b3JlLmdldENvbnRleHQo\nKS5maW5kQ2FjaGVkKG9pZCwgbnVsbCkgIT0gbnVsbCkKICAgICAgICAgICAg\nICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgQ2xhc3NNYXBwaW5n\nW10gY2xzcyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7\nCiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgU2Vs\nZWN0LkVBR0VSX1BBUkFMTEVMOgogICAgICAgICAgICAgICAgcmV0dXJuIGNs\nc3MubGVuZ3RoOwogICAgICAgICAgICBjYXNlIFNlbGVjdC5FQUdFUl9PVVRF\nUjoKICAgICAgICAgICAgICAgIHJldHVybiAoY2xzcy5sZW5ndGggPT0gMSAm\nJiBzdG9yZS5nZXREQkRpY3Rpb25hcnkoKS5jYW5PdXRlckpvaW4KICAgICAg\nICAgICAgICAgICAgICAoc2VsLmdldEpvaW5TeW50YXgoKSwgZmllbGQuZ2V0\nRm9yZWlnbktleShjbHNzWzBdKSkpID8gMSA6CiAgICAgICAgICAgICAgICAg\nICAgMDsKICAgICAgICAgICAgY2FzZSBTZWxlY3QuRUFHRVJfSU5ORVI6CiAg\nICAgICAgICAgICAgICByZXR1cm4gKGNsc3MubGVuZ3RoID09IDEpID8gMSA6\nIDA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1\ncm4gMDsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIHZvaWQgc2VsZWN0\nRWFnZXJQYXJhbGxlbChTZWxlY3RFeGVjdXRvciBzZWwsCiAgICAgICAgZmlu\nYWwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgZmluYWwgSkRCQ1N0b3JlIHN0\nb3JlLAogICAgICAgIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0\nY2gsIGZpbmFsIGludCBlYWdlck1vZGUpIHsKICAgICAgICBmaW5hbCBDbGFz\nc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFw\ncGluZ3MoKTsKICAgICAgICBpZiAoIShzZWwgaW5zdGFuY2VvZiBVbmlvbikp\nCiAgICAgICAgICAgIHNlbGVjdEVhZ2VyUGFyYWxsZWwoKFNlbGVjdCkgc2Vs\nLCBjbHNzWzBdLCBzdG9yZSwgZmV0Y2gsIGVhZ2VyTW9kZSk7CiAgICAgICAg\nZWxzZSB7CiAgICAgICAgICAgIFVuaW9uIHVuaW9uID0gKFVuaW9uKSBzZWw7\nCiAgICAgICAgICAgIGlmIChmZXRjaC5nZXRTdWJjbGFzc0ZldGNoTW9kZSAo\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKSkgCiAgICAgICAgICAgICAgICAhPSBK\nREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4pCiAgICAgICAgICAg\nICAgICB1bmlvbi5hYm9ydFVuaW9uKCk7CiAgICAgICAgICAgIHVuaW9uLnNl\nbGVjdChuZXcgVW5pb24uU2VsZWN0b3IoKSB7CiAgICAgICAgICAgICAgICBw\ndWJsaWMgdm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwgaW50IGlkeCkgewogICAg\nICAgICAgICAgICAgICAgIHNlbGVjdEVhZ2VyUGFyYWxsZWwoc2VsLCBjbHNz\nW2lkeF0sIHN0b3JlLCBmZXRjaCwKICAgICAgICAgICAgICAgICAgICAgICAg\nZWFnZXJNb2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7\nCiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUGVyZm9ybSBhbiBl\nYWdlciBwYXJhbGxlbCBzZWxlY3QuCiAgICAgKi8KICAgIHByaXZhdGUgdm9p\nZCBzZWxlY3RFYWdlclBhcmFsbGVsKFNlbGVjdCBzZWwsIENsYXNzTWFwcGlu\nZyBjbHMsCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25m\naWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJNb2RlKSB7CiAgICAgICAgaWYg\nKGZpZWxkLmlzQmlNVG8xSlQoKSkKICAgICAgICAgICAgcmV0dXJuOwogICAg\nICAgIHNlbC5zZWxlY3RQcmltYXJ5S2V5KGZpZWxkLmdldERlZmluaW5nTWFw\ncGluZygpKTsKICAgICAgICAvLyBzZXQgYSB2YXJpYWJsZSBuYW1lIHRoYXQg\nZG9lcyBub3QgY29uZmxpY3Qgd2l0aCBhbnkgaW4gdGhlIHF1ZXJ5OwogICAg\nICAgIC8vIHVzaW5nIGEgdmFyaWFibGUgZ3VhcmFudGVlcyB0aGF0IHRoZSBz\nZWxlY3RlZCBkYXRhIHdpbGwgdXNlIGRpZmZlcmVudAogICAgICAgIC8vIGFs\naWFzZXMgYW5kIGpvaW5zIHRoYW4gYW55IGV4aXN0aW5nIFdIRVJFIGNvbmRp\ndGlvbnMgb24gdGhpcyBmaWVsZAogICAgICAgIC8vIHRoYXQgbWlnaHQgb3Ro\nZXJ3aXNlIGxpbWl0IHRoZSByZWxhdGlvbnMgdGhhdCBtYXRjaAogICAgICAg\nIEpvaW5zIGpvaW5zID0gc2VsLm5ld0pvaW5zKCkuc2V0VmFyaWFibGUoIioi\nKTsKICAgICAgICBlYWdlckpvaW4oam9pbnMsIGNscywgdHJ1ZSk7CiAgICAg\nICAgc2VsLnNlbGVjdChjbHMsIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMo\nKSwgc3RvcmUsIGZldGNoLCBlYWdlck1vZGUsIAogICAgICAgICAgICBqb2lu\ncyk7CiAgICB9CgogICAgcHVibGljIHZvaWQgc2VsZWN0RWFnZXJKb2luKFNl\nbGVjdCBzZWwsIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAgSkRC\nQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBp\nbnQgZWFnZXJNb2RlKSB7CiAgICAgICAgaWYgKGZpZWxkLmlzQmlNVG8xSlQo\nKSkgCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgLy8gbGltaXQgdGhl\nIGVhZ2VyIG1vZGUgdG8gc2luZ2xlIG9uIHJlY3Vyc2l2ZSBlYWdlciBmZXRj\naGluZyBiL2MKICAgICAgICAvLyBhdCB0aGlzIHBvaW50IHRoZSBzZWxlY3Qg\naGFzIGJlZW4gbW9kaWZpZWQgYW5kIGFuIGF0dGVtcHQgdG8KICAgICAgICAv\nLyBjbG9uZSBpdCBmb3IgYSB0by1tYW55IGVhZ2VyIHNlbGVjdCBjYW4gcmVz\ndWx0IGluIGEgY2xvbmUgdGhhdAogICAgICAgIC8vIHByb2R1Y2VzIGludmFs\naWQgU1FMCiAgICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9IGZpZWxkLmdldElu\nZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07CiAgICAgICAgYm9vbGVhbiBm\nb3JjZUlubmVyID0gZmV0Y2guaGFzRmV0Y2hJbm5lckpvaW4oZmllbGQuZ2V0\nRnVsbE5hbWUoZmFsc2UpKSA/CiAgICAgICAgICAgICAgICB0cnVlIDogZmFs\nc2U7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxkLmdldFNlbGVjdFN1\nYmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLAogICAgICAgICAgICBKREJDRmV0\nY2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4sCiAgICAgICAgICAgIGVhZ2Vy\nSm9pbihzZWwubmV3Sm9pbnMoKSwgY2xzLCBmb3JjZUlubmVyKSk7CiAgICB9\nCgogICAgLyoqCiAgICAgKiBBZGQgdGhlIGpvaW5zIG5lZWRlZCB0byBzZWxl\nY3QvbG9hZCBlYWdlciBkYXRhLgogICAgICovCiAgICBwcml2YXRlIEpvaW5z\nIGVhZ2VySm9pbihKb2lucyBqb2lucywgQ2xhc3NNYXBwaW5nIGNscywgYm9v\nbGVhbiBmb3JjZUlubmVyKSB7CiAgICAgICAgYm9vbGVhbiBpbnZlcnNlID0g\nZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJT\nRTsKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgICAgam9pbnMg\nPSBqb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAgIGpvaW5zID0gc2V0\nRW1iZWRkZWRWYXJpYWJsZShqb2lucyk7CiAgICAgICAgfQoKICAgICAgICAv\nLyBhbmQgam9pbiBpbnRvIHJlbGF0aW9uCiAgICAgICAgRm9yZWlnbktleSBm\nayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzKTsKICAgICAgICBpZiAoIWZv\ncmNlSW5uZXIgJiYgZmllbGQuZ2V0TnVsbFZhbHVlKCkgIT0gRmllbGRNYXBw\naW5nLk5VTExfRVhDRVBUSU9OKQogICAgICAgICAgICByZXR1cm4gam9pbnMu\nb3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLCBmaywgZmllbGQu\nCiAgICAgICAgICAgICAgICBnZXRUeXBlTWFwcGluZygpLCBmaWVsZC5nZXRT\nZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZhbHNlKTsKICAgICAgICBy\nZXR1cm4gam9pbnMuam9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwgZmss\nIGZpZWxkLmdldFR5cGVNYXBwaW5nKCksIAogICAgICAgICAgICBmaWVsZC5n\nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZhbHNlKTsKICAgIH0K\nCiAgICAvKioKICAgICAqIElmIGpvaW5pbmcgZnJvbSBhbiBlbWJlZGRlZCBv\nd25lciwgdXNlIHZhcmlhYmxlIHRvIGNyZWF0ZSBhIHVuaXF1ZQogICAgICog\nYWxpYXMgaW4gY2FzZSBvd25lciBjb250YWlucyBvdGhlciBzYW1lLXR5cGVk\nIGVtYmVkZGVkIHJlbGF0aW9ucy4KICAgICAqLwogICAgcHJpdmF0ZSBKb2lu\ncyBzZXRFbWJlZGRlZFZhcmlhYmxlKEpvaW5zIGpvaW5zKSB7CiAgICAgICAg\naWYgKGZpZWxkLmdldERlZmluaW5nTWV0YURhdGEoKS5nZXRFbWJlZGRpbmdN\nZXRhRGF0YSgpID09IG51bGwpCiAgICAgICAgICAgIHJldHVybiBqb2luczsK\nICAgICAgICByZXR1cm4gam9pbnMuc2V0VmFyaWFibGUoZmllbGQuZ2V0RGVm\naW5pbmdNZXRhRGF0YSgpLgogICAgICAgICAgICBnZXRFbWJlZGRpbmdNZXRh\nRGF0YSgpLmdldEZpZWxkTWV0YURhdGEoKS5nZXROYW1lKCkpOwogICAgfQoK\nICAgIHB1YmxpYyBpbnQgc2VsZWN0KFNlbGVjdCBzZWwsIE9wZW5KUEFTdGF0\nZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBKREJDRmV0\nY2hDb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJNb2RlKSB7CiAgICAg\nICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5KT0lO\nX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAvLyBh\nbHJlYWR5IGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNtICE9IG51bGwgJiYg\nc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpICE9IG51bGwp\nCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBpZiAoIUJvb2xlYW4u\nVFJVRS5lcXVhbHMoX2ZrT2lkKSkKICAgICAgICAgICAgcmV0dXJuIC0xOwog\nICAgICAgIHNlbC5zZWxlY3QoZmllbGQuZ2V0Q29sdW1ucygpLCBmaWVsZC5q\nb2luKHNlbCkpOwogICAgICAgIHJldHVybiAwOwogICAgfQoKICAgIHB1Ymxp\nYyBPYmplY3QgbG9hZEVhZ2VyUGFyYWxsZWwoT3BlbkpQQVN0YXRlTWFuYWdl\nciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZp\nZ3VyYXRpb24gZmV0Y2gsIE9iamVjdCByZXMpCiAgICAgICAgdGhyb3dzIFNR\nTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gcHJvY2VzcyBiYXRjaGVkIHJlc3Vs\ndHMgaWYgd2UgaGF2ZW4ndCBhbHJlYWR5CiAgICAgICAgTWFwIHJlbHM7CiAg\nICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFJlc3VsdCkKICAgICAgICAgICAg\ncmVscyA9IHByb2Nlc3NFYWdlclBhcmFsbGVsUmVzdWx0KHNtLCBzdG9yZSwg\nZmV0Y2gsIChSZXN1bHQpIHJlcyk7CiAgICAgICAgZWxzZQogICAgICAgICAg\nICByZWxzID0gKE1hcCkgcmVzOwoKICAgICAgICAvLyBzdG9yZSBvYmplY3Qg\nZm9yIHRoaXMgb2lkIGluIGluc3RhbmNlCiAgICAgICAgc20uc3RvcmVPYmpl\nY3QoZmllbGQuZ2V0SW5kZXgoKSwgcmVscy5yZW1vdmUoc20uZ2V0T2JqZWN0\nSWQoKSkpOwogICAgICAgIHJldHVybiByZWxzOwogICAgfQoKICAgIC8qKgog\nICAgICogUHJvY2VzcyB0aGUgZ2l2ZW4gYmF0Y2hlZCByZXN1bHQuCiAgICAg\nKi8KICAgIHByaXZhdGUgTWFwIHByb2Nlc3NFYWdlclBhcmFsbGVsUmVzdWx0\nKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAgSkRCQ1N0b3JlIHN0\nb3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBSZXN1bHQgcmVz\nKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIC8vIGRv\nIHNhbWUgam9pbnMgYXMgZm9yIGxvYWQKICAgICAgICAvLyMjIyBjaGVhdDog\nd2Uga25vdyB0eXBpY2FsIHJlc3VsdCBqb2lucyBvbmx5IGNhcmUgYWJvdXQg\ndGhlIHJlbGF0aW9uCiAgICAgICAgLy8jIyMgcGF0aDsgdGh1cyB3ZSBjYW4g\naWdub3JlIGRpZmZlcmVudCBtYXBwaW5ncwogICAgICAgIENsYXNzTWFwcGlu\nZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygp\nOwogICAgICAgIEpvaW5zIGpvaW5zID0gcmVzLm5ld0pvaW5zKCkuc2V0VmFy\naWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9pbnMsIGNsc3NbMF0s\nIHRydWUpOwoKICAgICAgICBNYXAgcmVscyA9IG5ldyBIYXNoTWFwKCk7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIG93bmVyID0gZmllbGQuZ2V0RGVmaW5pbmdN\nYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIGNsczsKICAgICAgICBP\nYmplY3Qgb2lkOwogICAgICAgIHdoaWxlIChyZXMubmV4dCgpKSB7CiAgICAg\nICAgICAgIGNscyA9IHJlcy5nZXRCYXNlTWFwcGluZygpOwogICAgICAgICAg\nICBpZiAoY2xzID09IG51bGwpCiAgICAgICAgICAgICAgICBjbHMgPSBjbHNz\nWzBdOwogICAgICAgICAgICBvaWQgPSBvd25lci5nZXRPYmplY3RJZChzdG9y\nZSwgcmVzLCBudWxsLCB0cnVlLCBudWxsKTsKICAgICAgICAgICAgcmVscy5w\ndXQob2lkLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRjaCwgam9pbnMpKTsK\nICAgICAgICB9CiAgICAgICAgcmVzLmNsb3NlKCk7CgogICAgICAgIHJldHVy\nbiByZWxzOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxvYWRFYWdlckpvaW4o\nT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAg\nICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIFJlc3VsdCByZXMp\nCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKGZp\nZWxkLmlzQmlNVG8xSlQoKSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAg\nIENsYXNzTWFwcGluZyBjbHMgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5cGVN\nYXBwaW5ncygpWzBdOwoKICAgICAgICAvLyBmb3IgaW52ZXJzZUVhZ2VyIGZp\nZWxkCiAgICAgICAgRmllbGRNYXBwaW5nIG1hcHBlZEJ5RmllbGRNYXBwaW5n\nID0gZmllbGQuZ2V0TWFwcGVkQnlNYXBwaW5nKCk7CiAgICAgICAgUGVyc2lz\ndGVuY2VDYXBhYmxlIG1hcHBlZEJ5VmFsdWUgPSBudWxsOwoKICAgICAgICBp\nZiAobWFwcGVkQnlGaWVsZE1hcHBpbmcgIT0gbnVsbCkgewogICAgICAgIAlW\nYWx1ZU1hcHBpbmcgdmFsID0gbWFwcGVkQnlGaWVsZE1hcHBpbmcuZ2V0VmFs\ndWVNYXBwaW5nKCk7CiAgICAgICAgCUNsYXNzTWV0YURhdGEgZGVjTWV0YSA9\nIHZhbC5nZXRUeXBlTWV0YURhdGEoKTsKICAgICAgICAgICAgLy8gZWFnZXIg\nbG9hZGluZyBhIGNoaWxkIGZyb20gaXRzIHRvT25lIHBhcmVudCBhbmQKICAg\nICAgICAgICAgLy8gdGhlIHBhcmVudCBoYXMgQE9uZVRvT25lKG1hcHBlZEJ5\nPSJwYXJlbnQiKSBjaGlsZCByZWxhdGlvbi4KICAgICAgICAgICAgLy8gQnkg\nc2F2aW5nIHRoZSBtYXBwZWQtYnkgaW5mbyBpbiAncmVzJyBpcyB0bwogICAg\nICAgICAgICAvLyBhdm9pZCB1bm5lZWRlZCBTUUwgcHVzaGRvd24gdGhhdCB3\nb3VsZCBvdGhlcndpc2UgZ2V0cwogICAgICAgICAgICAvLyBnZW5lcmF0ZWQu\nCiAgICAgICAgICAgIGlmIChkZWNNZXRhICE9IG51bGwgJiYgIXNtLmlzRW1i\nZWRkZWQoKSkgewogICAgICAgIAkgICAgbWFwcGVkQnlWYWx1ZSA9IHNtLmdl\ndFBlcnNpc3RlbmNlQ2FwYWJsZSgpOwogICAgICAgIAkgICAgcmVzLnNldE1h\ncHBlZEJ5RmllbGRNYXBwaW5nKG1hcHBlZEJ5RmllbGRNYXBwaW5nKTsKICAg\nICAgICAJICAgIHJlcy5zZXRNYXBwZWRCeVZhbHVlKG1hcHBlZEJ5VmFsdWUp\nOwogICAgICAgIAl9CiAgICAgICAgfQoKICAgICAgICBzbS5zdG9yZU9iamVj\ndChmaWVsZC5nZXRJbmRleCgpLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRj\naCwKICAgICAgICAgICAgZWFnZXJKb2luKHJlcy5uZXdKb2lucygpLCBjbHMs\nIGZhbHNlKSkpOwoKICAgICAgICAvLyByZXNldCBtYXBwZWQgYnkgaXMgbmVl\nZGVkIGZvciBPbmVUb09uZSBiaWRpcmVjdGlvbmFsIHJlbGF0aW9ucwogICAg\nICAgIC8vIGhhdmluZyBhIG1hcHBlZC1ieSBwYXJlbnQgdG8gY29ycmVjdGx5\nIHNldCB0aGUgcGFyZW50LWNoaWxkCiAgICAgICAgLy8gcmVsYXRpb24uCiAg\nICAgICAgcmVzLnNldE1hcHBlZEJ5RmllbGRNYXBwaW5nKG51bGwpOwogICAg\nICAgIHJlcy5zZXRNYXBwZWRCeVZhbHVlKG51bGwpOwogICAgfQoKICAgIHB1\nYmxpYyB2b2lkIGxvYWQoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0\nb3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0\nY2gsIFJlc3VsdCByZXMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7\nCiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVs\nZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAv\nLyBjYWNoZWQgb2lkPwogICAgICAgIGlmIChzbSAhPSBudWxsICYmIHNtLmdl\ndEludGVybWVkaWF0ZShmaWVsZC5nZXRJbmRleCgpKSAhPSBudWxsKQogICAg\nICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKCFCb29sZWFuLlRSVUUuZXF1\nYWxzKF9ma09pZCkpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAo\nIXJlcy5jb250YWluc0FsbChmaWVsZC5nZXRDb2x1bW5zKCkpKQogICAgICAg\nICAgICByZXR1cm47CgogICAgICAgIC8vIGdldCB0aGUgcmVsYXRlZCBvYmpl\nY3QncyBvaWQKICAgICAgICBDbGFzc01hcHBpbmcgcmVsTWFwcGluZyA9IGZp\nZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgT2JqZWN0IG9pZCA9IG51\nbGw7CiAgICAgICAgaWYgKHJlbE1hcHBpbmcuaXNNYXBwZWQoKSAmJiAhZmll\nbGQuaXNCaU1UbzFKVCgpKSB7IAogICAgICAgICAgICBvaWQgPSByZWxNYXBw\naW5nLmdldE9iamVjdElkKHN0b3JlLCByZXMsIGZpZWxkLmdldEZvcmVpZ25L\nZXkoKSwKICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRQb2x5bW9ycGhp\nYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFLCBudWxsKTsKICAgICAg\nICB9IGVsc2UgewogICAgICAgICAgICBDb2x1bW5bXSBjb2xzID0gZmllbGQu\nZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocmVsTWFwcGluZy5nZXRJ\nZGVudGl0eVR5cGUoKSA9PSBDbGFzc01hcHBpbmcuSURfREFUQVNUT1JFKSB7\nCiAgICAgICAgICAgICAgICBsb25nIGlkID0gcmVzLmdldExvbmcoY29sc1sw\nXSk7CiAgICAgICAgICAgICAgICBpZiAoIXJlcy53YXNOdWxsKCkpCiAgICAg\nICAgICAgICAgICAgICAgb2lkID0gc3RvcmUubmV3RGF0YVN0b3JlSWQoaWQs\nIHJlbE1hcHBpbmcsIHRydWUpOwogICAgICAgICAgICB9IGVsc2UgeyAKICAg\nICAgICAgICAgICAgIC8vIGFwcGxpY2F0aW9uIGlkCiAgICAgICAgICAgICAg\nICBpZiAoY29scy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgICAg\nIE9iamVjdCB2YWwgPSByZXMuZ2V0T2JqZWN0KGNvbHNbMF0sIG51bGwsIG51\nbGwpOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT0gbnVsbCkKICAg\nICAgICAgICAgICAgICAgICAgICAgb2lkID0gQXBwbGljYXRpb25JZHMuZnJv\nbVBLVmFsdWVzKG5ldyBPYmplY3RbXXsgdmFsIH0sCiAgICAgICAgICAgICAg\nICAgICAgICAgICAgICByZWxNYXBwaW5nKTsKICAgICAgICAgICAgICAgIH0g\nZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgT2JqZWN0W10gdmFscyA9IG5l\ndyBPYmplY3RbY29scy5sZW5ndGhdOwogICAgICAgICAgICAgICAgICAgIGZv\nciAoaW50IGkgPSAwOyBpIDwgY29scy5sZW5ndGg7IGkrKykgewogICAgICAg\nICAgICAgICAgICAgICAgICB2YWxzW2ldID0gcmVzLmdldE9iamVjdChjb2xz\nW2ldLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYg\nKHZhbHNbaV0gPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAg\nIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PSBjb2xz\nLmxlbmd0aCAtIDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvaWQg\nPSBBcHBsaWNhdGlvbklkcy5mcm9tUEtWYWx1ZXModmFscywgcmVsTWFwcGlu\nZyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQog\nICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob2lkID09IG51\nbGwpCiAgICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4\nKCksIG51bGwpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgc20uc2V0SW50\nZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCksIG9pZCk7CiAgICB9CgogICAg\ncHVibGljIHZvaWQgbG9hZChmaW5hbCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNt\nLCBmaW5hbCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgZmluYWwgSkRCQ0Zl\ndGNoQ29uZmlndXJhdGlvbiBmZXRjaCkKICAgICAgICB0aHJvd3MgU1FMRXhj\nZXB0aW9uIHsKICAgICAgICAvLyBjaGVjayBmb3IgY2FjaGVkIG9pZCB2YWx1\nZSwgb3IgbG9hZCBvaWQgaWYgbm8gd2F5IHRvIGpvaW4KICAgICAgICBpZiAo\nQm9vbGVhbi5UUlVFLmVxdWFscyhfZmtPaWQpKSB7CiAgICAgICAgICAgIE9i\namVjdCBvaWQgPSBzbS5nZXRJbnRlcm1lZGlhdGUoZmllbGQuZ2V0SW5kZXgo\nKSk7CiAgICAgICAgICAgIGlmIChvaWQgIT0gbnVsbCkgewogICAgICAgICAg\nICAgICAgT2JqZWN0IHZhbCA9IHN0b3JlLmZpbmQob2lkLCBmaWVsZCwgZmV0\nY2gpOwogICAgICAgICAgICAgICAgc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0\nSW5kZXgoKSwgdmFsKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAg\nICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZmluYWwgQ2xhc3NNYXBwaW5n\nW10gcmVscyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7\nCiAgICAgICAgZmluYWwgaW50IHN1YnMgPSBmaWVsZC5nZXRTZWxlY3RTdWJj\nbGFzc2VzKCk7CiAgICAgICAgZmluYWwgSm9pbnNbXSByZXNKb2lucyA9IG5l\ndyBKb2luc1tyZWxzLmxlbmd0aF07CgogICAgICAgIC8vIHNlbGVjdCByZWxh\ndGVkIG1hcHBpbmcgY29sdW1uczsgam9pbmluZyBmcm9tIHRoZSByZWxhdGVk\nIHR5cGUKICAgICAgICAvLyBiYWNrIHRvIG91ciBmayB0YWJsZSBpZiBub3Qg\nYW4gaW52ZXJzZSBtYXBwaW5nIChpbiB3aGljaCBjYXNlIHdlCiAgICAgICAg\nLy8gY2FuIGp1c3QgbWFrZSBzdXJlIHRoZSBpbnZlcnNlIGNvbHMgPT0gb3Vy\nIHBrIHZhbHVlcykKICAgICAgICBVbmlvbiB1bmlvbiA9IHN0b3JlLmdldFNR\nTEZhY3RvcnkoKS5uZXdVbmlvbihyZWxzLmxlbmd0aCk7CiAgICAgICAgdW5p\nb24uc2V0RXhwZWN0ZWRSZXN1bHRDb3VudCgxLCBmYWxzZSk7CiAgICAgICAg\naWYgKGZldGNoLmdldFN1YmNsYXNzRmV0Y2hNb2RlKGZpZWxkLmdldFR5cGVN\nYXBwaW5nKCkpCiAgICAgICAgICAgICE9IEpEQkNGZXRjaENvbmZpZ3VyYXRp\nb24uRUFHRVJfSk9JTikKICAgICAgICAgICAgdW5pb24uYWJvcnRVbmlvbigp\nOwogICAgICAgIHVuaW9uLnNlbGVjdChuZXcgVW5pb24uU2VsZWN0b3IoKSB7\nCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIHNlbGVjdChTZWxlY3Qgc2VsLCBp\nbnQgaWR4KSB7CiAgICAgICAgICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRp\ncmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAg\nICAgICAgICBzZWwud2hlcmVGb3JlaWduS2V5KGZpZWxkLmdldEZvcmVpZ25L\nZXkocmVsc1tpZHhdKSwKICAgICAgICAgICAgICAgICAgICAgICAgc20uZ2V0\nT2JqZWN0SWQoKSwgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCksIHN0b3Jl\nKTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAg\nIGlmICghZmllbGQuaXNCaU1UbzFKVCgpKSB7CiAgICAgICAgICAgICAgICAg\nICAgICAgIHJlc0pvaW5zW2lkeF0gPSBzZWwubmV3Sm9pbnMoKS5qb2luUmVs\nYXRpb24oZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAgICAgICAg\nICAgICAgZmllbGQuZ2V0Rm9yZWlnbktleShyZWxzW2lkeF0pLCByZWxzW2lk\neF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRTZWxl\nY3RTdWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAg\nICAgICAgICAgIGZpZWxkLndoZXJlUHJpbWFyeUtleShzZWwsIHNtLCBzdG9y\nZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAg\nICAgICAgICAgICAgcmVzSm9pbnNbaWR4XSA9IHNlbC5uZXdKb2lucygpLmpv\naW5SZWxhdGlvbihudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAg\nZmllbGQuZ2V0QmkxVG9NSm9pbkZLKCksIHJlbHNbaWR4XSwKICAgICAgICAg\nICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMo\nKSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2Vs\nLndoZXJlRm9yZWlnbktleShmaWVsZC5nZXRCaTFUb01FbGVtRksoKSwgc20u\nZ2V0T2JqZWN0SWQoKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBm\naWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgc3RvcmUpOwogICAgICAgICAg\nICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAg\nIHNlbC5zZWxlY3QocmVsc1tpZHhdLCBzdWJzLCBzdG9yZSwgZmV0Y2gsIGZl\ndGNoLkVBR0VSX0pPSU4sIAogICAgICAgICAgICAgICAgICAgIHJlc0pvaW5z\nW2lkeF0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIFJl\nc3VsdCByZXMgPSB1bmlvbi5leGVjdXRlKHN0b3JlLCBmZXRjaCk7CiAgICAg\nICAgdHJ5IHsKICAgICAgICAgICAgT2JqZWN0IHZhbCA9IG51bGw7CiAgICAg\nICAgICAgIGlmIChyZXMubmV4dCgpKQogICAgICAgICAgICAgICAgdmFsID0g\ncmVzLmxvYWQocmVsc1tyZXMuaW5kZXhPZigpXSwgc3RvcmUsIGZldGNoLAog\nICAgICAgICAgICAgICAgICAgIHJlc0pvaW5zW3Jlcy5pbmRleE9mKCldKTsK\nICAgICAgICAgICAgc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwg\ndmFsKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZXMuY2xv\nc2UoKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIE9iamVjdCB0b0Rh\ndGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9yZSBzdG9yZSkgewog\nICAgICAgIHJldHVybiBSZWxhdGlvblN0cmF0ZWdpZXMudG9EYXRhU3RvcmVW\nYWx1ZShmaWVsZCwgdmFsLCBzdG9yZSk7CiAgICB9CgogICAgcHVibGljIHZv\naWQgYXBwZW5kSXNOdWxsKFNRTEJ1ZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpv\naW5zIGpvaW5zKSB7CiAgICAgICAgLy8gaWYgbm8gaW52ZXJzZSwganVzdCBq\nb2luIHRvIG1hcHBpbmcncyB0YWJsZSAodXN1YWxseSBhIG5vLW9wCiAgICAg\nICAgLy8gYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUgcHJpbWFyeSB0YWJsZSkg\nYW5kIHNlZSBpZiBmayBjb2xzIGFyZSBudWxsOwogICAgICAgIC8vIGlmIGlu\ndmVyc2UsIHRoZW4gd2UgaGF2ZSB0byBkbyBhIHN1Yi1zZWxlY3QgdG8gc2Vl\nIGlmIGFueSBpbnZlcnNlCiAgICAgICAgLy8gb2JqZWN0cyBwb2ludCBiYWNr\nIHRvIHRoaXMgZmllbGQncyBvd25lcgogICAgICAgIGlmIChmaWVsZC5nZXRK\nb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7CiAgICAg\nICAgICAgIC8vIyMjIHByb2JhYmx5IG5lZWQgc29tZSBzb3J0IG9mIHN1YnNl\nbGVjdCBoZXJlIG9uIGZrIGNvbnN0YW50cwogICAgICAgICAgICBqb2lucyA9\nIGpvaW4oam9pbnMsIGZhbHNlKTsKICAgICAgICAgICAgQ29sdW1uW10gY29s\ncyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAgICAgaWYgKGNvbHMu\nbGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICBzcWwuYXBwZW5kKCIxIDw+\nIDEiKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgc3FsLmFw\ncGVuZChzZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwgam9pbnMpKS4KICAg\nICAgICAgICAgICAgICAgICBhcHBlbmQoIiBJUyAiKS5hcHBlbmRWYWx1ZShu\ndWxsLCBjb2xzWzBdKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgdGVz\ndEludmVyc2VOdWxsKHNxbCwgc2VsLCBqb2lucywgdHJ1ZSk7CiAgICB9Cgog\nICAgcHVibGljIHZvaWQgYXBwZW5kSXNOb3ROdWxsKFNRTEJ1ZmZlciBzcWws\nIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAgLy8gaWYgbm8g\naW52ZXJzZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0YWJsZSAodXN1YWxs\neSBhIG5vLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUg\ncHJpbWFyeSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xzIGFyZW4ndAogICAg\nICAgIC8vIG51bGw7IGlmIGludmVyc2UsIHRoZW4gd2UgaGF2ZSB0byBkbyBh\nIHN1Yi1zZWxlY3QgdG8gc2VlIGlmIGFueQogICAgICAgIC8vIGludmVyc2Ug\nb2JqZWN0cyBwb2ludCBiYWNrIHRvIHRoaXMgZmllbGQncyBvd25lcgogICAg\nICAgIGlmIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9J\nTl9JTlZFUlNFKSB7CiAgICAgICAgICAgIC8vIyMjIHByb2JhYmx5IG5lZWQg\nc29tZSBzb3J0IG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZrIGNvbnN0YW50cwog\nICAgICAgICAgICBqb2lucyA9IGpvaW4oam9pbnMsIGZhbHNlKTsKICAgICAg\nICAgICAgQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAg\nICAgICAgICAgaWYgKGNvbHMubGVuZ3RoID09IDApCiAgICAgICAgICAgICAg\nICBzcWwuYXBwZW5kKCIxID0gMSIpOwogICAgICAgICAgICBlbHNlCiAgICAg\nICAgICAgICAgICBzcWwuYXBwZW5kKHNlbC5nZXRDb2x1bW5BbGlhcyhjb2xz\nWzBdLCBqb2lucykpLgogICAgICAgICAgICAgICAgICAgIGFwcGVuZCgiIElT\nIE5PVCAiKS5hcHBlbmRWYWx1ZShudWxsLCBjb2xzWzBdKTsKICAgICAgICB9\nIGVsc2UKICAgICAgICAgICAgdGVzdEludmVyc2VOdWxsKHNxbCwgc2VsLCBq\nb2lucywgZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICogQXBwZW5kIFNR\nTCBmb3IgYSBzdWItc2VsZWN0IHRlc3Rpbmcgd2hldGhlciBhbiBpbnZlcnNl\nIG9iamVjdCBleGlzdHMKICAgICAqIGZvciB0aGlzIHJlbGF0aW9uLgogICAg\nICovCiAgICBwcml2YXRlIHZvaWQgdGVzdEludmVyc2VOdWxsKFNRTEJ1ZmZl\nciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zLAogICAgICAgIGJvb2xl\nYW4gZW1wdHkpIHsKICAgICAgICBEQkRpY3Rpb25hcnkgZGljdCA9IGZpZWxk\nLmdldE1hcHBpbmdSZXBvc2l0b3J5KCkuZ2V0REJEaWN0aW9uYXJ5KCk7CiAg\nICAgICAgZGljdC5hc3NlcnRTdXBwb3J0KGRpY3Quc3VwcG9ydHNTdWJzZWxl\nY3QsICJTdXBwb3J0c1N1YnNlbGVjdCIpOwoKICAgICAgICBpZiAoZmllbGQu\nZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5ndGggIT0gMSkKICAg\nICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJzYWJs\nZShmaWVsZCk7CgogICAgICAgIGlmIChlbXB0eSkKICAgICAgICAgICAgc3Fs\nLmFwcGVuZCgiMCA9ICIpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgc3Fs\nLmFwcGVuZCgiMCA8ICIpOwoKICAgICAgICBGb3JlaWduS2V5IGZrID0gZmll\nbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbnRhaW5lckZpZWxkU3Ry\nYXRlZ3kuYXBwZW5kSm9pbkNvdW50KHNxbCwgc2VsLCBqb2lucywgZGljdCwg\nZmllbGQsCiAgICAgICAgICAgIGZrKTsKICAgIH0KCiAgICBwdWJsaWMgSm9p\nbnMgam9pbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3JjZU91dGVyKSB7CiAg\nICAgICAgLy8gaWYgd2UncmUgbm90IGluIGFuIGludmVyc2Ugb2JqZWN0IHRh\nYmxlIGpvaW4gbm9ybWFsbHksIG90aGVyd2lzZQogICAgICAgIC8vIGFscmVh\nZHkgdHJhdmVyc2VkIHRoZSByZWxhdGlvbjsganVzdCBqb2luIGJhY2sgdG8g\nb3duZXIgdGFibGUKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlv\nbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJu\nIGZpZWxkLmpvaW4oam9pbnMsIGZvcmNlT3V0ZXIsIGZhbHNlKTsKICAgICAg\nICBDbGFzc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRU\neXBlTWFwcGluZ3MoKTsKICAgICAgICBpZiAoY2xzcy5sZW5ndGggIT0gMSkK\nICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJz\nYWJsZShmaWVsZCk7CiAgICAgICAgaWYgKGZvcmNlT3V0ZXIpCiAgICAgICAg\nICAgIHJldHVybiBqb2lucy5vdXRlckpvaW5SZWxhdGlvbihmaWVsZC5nZXRO\nYW1lKCksCiAgICAgICAgICAgICAgICBmaWVsZC5nZXRGb3JlaWduS2V5KCks\nIGNsc3NbMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgCiAgICAg\nICAgICAgICAgICB0cnVlLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIGpvaW5z\nLmpvaW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCksIGZpZWxkLmdldEZvcmVp\nZ25LZXkoKSwKICAgICAgICAgICAgY2xzc1swXSwgZmllbGQuZ2V0U2VsZWN0\nU3ViY2xhc3NlcygpLCB0cnVlLCBmYWxzZSk7CiAgICB9CgogICAgcHVibGlj\nIEpvaW5zIGpvaW5SZWxhdGlvbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3Jj\nZU91dGVyLAogICAgICAgIGJvb2xlYW4gdHJhdmVyc2UpIHsKICAgICAgICAv\nLyBpZiB0aGlzIGlzIGFuIGludmVyc2UgbWFwcGluZyBpdCdzIGFscmVhZHkg\nam9pbmVkIHRvIHRoZSByZWxhdGlvbgogICAgICAgIGlmIChmaWVsZC5nZXRK\nb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAg\nICAgICByZXR1cm4gam9pbnM7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xz\ncyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAg\nICAgaWYgKGNsc3MubGVuZ3RoICE9IDEpIHsKICAgICAgICAgICAgaWYgKHRy\nYXZlcnNlKQogICAgICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVn\naWVzLnVuam9pbmFibGUoZmllbGQpOwogICAgICAgICAgICByZXR1cm4gam9p\nbnM7CiAgICAgICAgfQoKICAgICAgICBqb2lucyA9IHNldEVtYmVkZGVkVmFy\naWFibGUoam9pbnMpOwogICAgICAgIGlmIChmb3JjZU91dGVyKQogICAgICAg\nICAgICByZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0\nTmFtZSgpLCAKICAgICAgICAgICAgICAgIGZpZWxkLmdldEZvcmVpZ25LZXko\nY2xzc1swXSksIGNsc3NbMF0sIAogICAgICAgICAgICAgICAgZmllbGQuZ2V0\nU2VsZWN0U3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwogICAgICAgIHJl\ndHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLCBmaWVs\nZC5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLAogICAgICAgICAgICBjbHNzWzBd\nLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7\nCiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAv\nLyBKb2luYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vLy8vLy8vCgogICAgcHVibGljIGludCBnZXRGaWVsZEluZGV4KCkg\newogICAgICAgIHJldHVybiBmaWVsZC5nZXRJbmRleCgpOwogICAgfQoKICAg\nIHB1YmxpYyBPYmplY3QgZ2V0UHJpbWFyeUtleVZhbHVlKFJlc3VsdCByZXMs\nIENvbHVtbltdIGNvbHMsIEZvcmVpZ25LZXkgZmssCiAgICAgICAgSkRCQ1N0\nb3JlIHN0b3JlLCBKb2lucyBqb2lucykKICAgICAgICB0aHJvd3MgU1FMRXhj\nZXB0aW9uIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVsbWFwcGluZyA9IGZp\nZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgaWYgKHJlbG1hcHBpbmcu\nZ2V0SWRlbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5nLklEX0RBVEFTVE9S\nRSkgewogICAgICAgICAgICBDb2x1bW4gY29sID0gY29sc1swXTsKICAgICAg\nICAgICAgaWYgKGZrICE9IG51bGwpCiAgICAgICAgICAgICAgICBjb2wgPSBm\nay5nZXRDb2x1bW4oY29sKTsgICAKICAgICAgICAgICAgbG9uZyBpZCA9IHJl\ncy5nZXRMb25nKGNvbCwgam9pbnMpOwogICAgICAgICAgICBpZiAoZmllbGQu\nZ2V0T2JqZWN0SWRGaWVsZFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLkxPTkcp\nCiAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVycy52YWx1ZU9mKGlkKTsK\nICAgICAgICAgICAgcmV0dXJuIHN0b3JlLm5ld0RhdGFTdG9yZUlkKGlkLCBy\nZWxtYXBwaW5nLCBmaWVsZC5nZXRQb2x5bW9ycGhpYygpIAogICAgICAgICAg\nICAgICAgIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0UpOwogICAgICAgIH0K\nCiAgICAgICAgaWYgKHJlbG1hcHBpbmcuaXNPcGVuSlBBSWRlbnRpdHkoKSkK\nICAgICAgICAgICAgcmV0dXJuICgoSm9pbmFibGUpIHJlbG1hcHBpbmcuZ2V0\nUHJpbWFyeUtleUZpZWxkTWFwcGluZ3MoKVswXS4KICAgICAgICAgICAgICAg\nIGdldFN0cmF0ZWd5KCkpLmdldFByaW1hcnlLZXlWYWx1ZShyZXMsIGNvbHMs\nIGZrLCBzdG9yZSwgam9pbnMpOwoKICAgICAgICBpZiAoY29scyA9PSBnZXRD\nb2x1bW5zKCkgJiYgZmsgPT0gbnVsbCkKICAgICAgICAgICAgZmsgPSBmaWVs\nZC5nZXRGb3JlaWduS2V5KCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICBm\nayA9IGNyZWF0ZVRyYW5zbGF0aW5nRm9yZWlnbktleShyZWxtYXBwaW5nLCBj\nb2xzLCBmayk7IAogICAgICAgIHJldHVybiByZWxtYXBwaW5nLmdldE9iamVj\ndElkKHN0b3JlLCByZXMsIGZrLAogICAgICAgICAgICBmaWVsZC5nZXRQb2x5\nbW9ycGhpYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFLCBqb2lucyk7\nCiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBmYXV4IGZvcmVpZ24g\na2V5IHRoYXQgdHJhbnNsYXRlcyBiZXR3ZWVuIHRoZSBjb2x1bW5zIHRvIHB1\nbGwKICAgICAqIHRoZSBkYXRhIGZyb20gYW5kIG91ciByZWxhdGVkIHR5cGUn\ncyBwcmltYXJ5IGtleSBjb2x1bW5zLgogICAgICovCiAgICBwcml2YXRlIEZv\ncmVpZ25LZXkgY3JlYXRlVHJhbnNsYXRpbmdGb3JlaWduS2V5KENsYXNzTWFw\ncGluZyByZWxtYXBwaW5nLAogICAgICAgIENvbHVtbltdIGdjb2xzLCBGb3Jl\naWduS2V5IGdmaykgewogICAgICAgIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5n\nZXRGb3JlaWduS2V5KCk7IAogICAgICAgIENvbHVtbltdIGNvbHMgPSBmay5n\nZXRDb2x1bW5zKCk7CgogICAgICAgIEZvcmVpZ25LZXkgdGZrID0gbnVsbDsK\nICAgICAgICBDb2x1bW4gdGNvbDsKICAgICAgICBmb3IgKGludCBpID0gMDsg\naSA8IGdjb2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRjb2wgPSBn\nY29sc1tpXTsKICAgICAgICAgICAgaWYgKGdmayAhPSBudWxsKQogICAgICAg\nICAgICAgICAgdGNvbCA9IGdmay5nZXRDb2x1bW4odGNvbCk7CiAgICAgICAg\nICAgIGlmICh0ZmsgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRmayA9IG5l\ndyBGb3JlaWduS2V5KG51bGwsIHRjb2wuZ2V0VGFibGUoKSk7CiAgICAgICAg\nICAgIHRmay5qb2luKHRjb2wsIGZrLmdldFByaW1hcnlLZXlDb2x1bW4oY29s\nc1tpXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGZrOwogICAgfQoK\nICAgIHB1YmxpYyBPYmplY3QgZ2V0Sm9pblZhbHVlKE9iamVjdCBmaWVsZFZh\nbCwgQ29sdW1uIGNvbCwgSkRCQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgT2Jq\nZWN0IG8gPSBmaWVsZC5nZXRGb3JlaWduS2V5KCkuZ2V0Q29uc3RhbnQoY29s\nKTsKICAgICAgICBpZiAobyAhPSBudWxsKQogICAgICAgICAgICByZXR1cm4g\nbzsKICAgICAgICBjb2wgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCkuZ2V0UHJp\nbWFyeUtleUNvbHVtbihjb2wpOwogICAgICAgIGlmIChjb2wgPT0gbnVsbCkK\nICAgICAgICAgICAgdGhyb3cgbmV3IEludGVybmFsRXhjZXB0aW9uKCk7Cgog\nICAgICAgIENsYXNzTWFwcGluZyByZWxtYXBwaW5nID0gZmllbGQuZ2V0VHlw\nZU1hcHBpbmcoKTsKICAgICAgICBKb2luYWJsZSBqID0gZmllbGQuZ2V0VHlw\nZU1hcHBpbmcoKS5hc3NlcnRKb2luYWJsZShjb2wpOwogICAgICAgIGlmIChJ\nbXBsSGVscGVyLmlzTWFuYWdlYWJsZShmaWVsZFZhbCkpCiAgICAgICAgICAg\nIGZpZWxkVmFsID0gc3RvcmUuZ2V0Q29udGV4dCgpLmdldE9iamVjdElkKGZp\nZWxkVmFsKTsKICAgICAgICBpZiAoZmllbGRWYWwgaW5zdGFuY2VvZiBPcGVu\nSlBBSWQpCiAgICAgICAgICAgIGZpZWxkVmFsID0gKChPcGVuSlBBSWQpIGZp\nZWxkVmFsKS5nZXRJZE9iamVjdCgpOwogICAgICAgIGlmIChyZWxtYXBwaW5n\nLmdldE9iamVjdElkVHlwZSgpICE9IG51bGwKICAgICAgICAgICAgJiYgcmVs\nbWFwcGluZy5nZXRPYmplY3RJZFR5cGUoKS5pc0luc3RhbmNlKGZpZWxkVmFs\nKSkgewogICAgICAgICAgICBPYmplY3RbXSBwa3MgPSBBcHBsaWNhdGlvbklk\ncy50b1BLVmFsdWVzKGZpZWxkVmFsLCByZWxtYXBwaW5nKTsKICAgICAgICAg\nICAgZmllbGRWYWwgPSBwa3NbcmVsbWFwcGluZy5nZXRGaWVsZChqLmdldEZp\nZWxkSW5kZXgoKSkuCiAgICAgICAgICAgICAgICBnZXRQcmltYXJ5S2V5SW5k\nZXgoKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBqLmdldEpvaW5WYWx1\nZShmaWVsZFZhbCwgY29sLCBzdG9yZSk7CiAgICB9CgogICAgcHVibGljIE9i\namVjdCBnZXRKb2luVmFsdWUoT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgQ29s\ndW1uIGNvbCwKICAgICAgICBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICBy\nZXR1cm4gZ2V0Sm9pblZhbHVlKHNtLmZldGNoKGZpZWxkLmdldEluZGV4KCkp\nLCBjb2wsIHN0b3JlKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBzZXRBdXRv\nQXNzaWduZWRWYWx1ZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3Rv\ncmUgc3RvcmUsCiAgICAgICAgQ29sdW1uIGNvbCwgT2JqZWN0IGF1dG9JbmMp\nIHsKICAgICAgICB0aHJvdyBuZXcgVW5zdXBwb3J0ZWRFeGNlcHRpb24oKTsK\nICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAg\nLy8gRW1iZWRkYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8vLy8vLy8vLy8v\nLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBwdWJsaWMgQ29sdW1uW10gZ2V0Q29s\ndW1ucygpIHsKICAgICAgICByZXR1cm4gZmllbGQuZ2V0Q29sdW1ucygpOwog\nICAgfQoKICAgIHB1YmxpYyBDb2x1bW5JTyBnZXRDb2x1bW5JTygpIHsKICAg\nICAgICByZXR1cm4gZmllbGQuZ2V0Q29sdW1uSU8oKTsKICAgIH0KCiAgICBw\ndWJsaWMgT2JqZWN0W10gZ2V0UmVzdWx0QXJndW1lbnRzKCkgewogICAgICAg\nIHJldHVybiBudWxsOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9FbWJl\nZGRlZERhdGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9yZSBzdG9y\nZSkgewogICAgICAgIHJldHVybiB0b0RhdGFTdG9yZVZhbHVlKHZhbCwgc3Rv\ncmUpOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9FbWJlZGRlZE9iamVj\ndFZhbHVlKE9iamVjdCB2YWwpIHsKICAgICAgICByZXR1cm4gVU5TVVBQT1JU\nRUQ7CiAgICB9CgogICAgcHVibGljIHZvaWQgbG9hZEVtYmVkZGVkKE9wZW5K\nUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBK\nREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBPYmplY3QgdmFsKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIENsYXNzTWFwcGlu\nZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAg\nICBPYmplY3Qgb2lkOwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkKICAgICAg\nICAgICAgb2lkID0gbnVsbDsKICAgICAgICBlbHNlIGlmIChyZWxNYXBwaW5n\nLmdldElkZW50aXR5VHlwZSgpID09IENsYXNzTWFwcGluZy5JRF9EQVRBU1RP\nUkUpCiAgICAgICAgICAgIG9pZCA9IHN0b3JlLm5ld0RhdGFTdG9yZUlkKCgo\nTnVtYmVyKSB2YWwpLmxvbmdWYWx1ZSgpLCByZWxNYXBwaW5nLAogICAgICAg\nICAgICAgICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1hcHBp\nbmcuUE9MWV9GQUxTRSk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIE9i\namVjdFtdIHBrcyA9IChnZXRDb2x1bW5zKCkubGVuZ3RoID09IDEpID8gbmV3\nIE9iamVjdFtdeyB2YWwgfQogICAgICAgICAgICAgICAgOiAoT2JqZWN0W10p\nIHZhbDsKICAgICAgICAgICAgYm9vbGVhbiBudWxscyA9IHRydWU7CiAgICAg\nICAgICAgIGZvciAoaW50IGkgPSAwOyBudWxscyAmJiBpIDwgcGtzLmxlbmd0\naDsgaSsrKQogICAgICAgICAgICAgICAgbnVsbHMgPSBwa3NbaV0gPT0gbnVs\nbDsKICAgICAgICAgICAgaWYgKG51bGxzKQogICAgICAgICAgICAgICAgb2lk\nID0gbnVsbDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBv\naWQgPSBBcHBsaWNhdGlvbklkcy5mcm9tUEtWYWx1ZXMocGtzLCByZWxNYXBw\naW5nKTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5nZXRQb2x5bW9ycGhp\nYygpID09IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFCiAgICAgICAgICAgICAg\nICAgICAgJiYgb2lkIGluc3RhbmNlb2YgT3BlbkpQQUlkKSB7CiAgICAgICAg\nICAgICAgICAgICAgKChPcGVuSlBBSWQpIG9pZCkuc2V0TWFuYWdlZEluc3Rh\nbmNlVHlwZShyZWxNYXBwaW5nLgogICAgICAgICAgICAgICAgICAgICAgICBn\nZXREZXNjcmliZWRUeXBlKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAg\nICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob2lkID09IG51bGwpCiAg\nICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIG51\nbGwpOwogICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoSmF2YVR5cGVz\nLm1heWJlUEMoZmllbGQuZ2V0VmFsdWUoKSkgJiYKICAgICAgICAgICAgICAg\nIGZpZWxkLmdldEVsZW1lbnQoKS5nZXRFbWJlZGRlZE1ldGFEYXRhKCkgPT0g\nbnVsbCkgewogICAgICAgICAgICAgICAgT2JqZWN0IG9iaiA9IHN0b3JlLmZp\nbmQob2lkLCBmaWVsZCwgZmV0Y2gpOwogICAgICAgICAgICAgICAgc20uc3Rv\ncmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgb2JqKTsKICAgICAgICAgICAg\nfSBlbHNlICAgIAogICAgICAgICAgICAgICAgc20uc2V0SW50ZXJtZWRpYXRl\nKGZpZWxkLmdldEluZGV4KCksIG9pZCk7CiAgICAgICAgfQogICAgfQp9Cg==\n","encoding":"base64"}

