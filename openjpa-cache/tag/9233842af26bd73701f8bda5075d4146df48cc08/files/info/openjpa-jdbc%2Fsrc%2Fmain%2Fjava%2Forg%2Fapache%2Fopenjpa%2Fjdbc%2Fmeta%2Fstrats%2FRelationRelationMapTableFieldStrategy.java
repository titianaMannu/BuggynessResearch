{"sha":"4573eda6852f1ae890eed03c6447542ab705e653","node_id":"MDQ6QmxvYjIwNjM2NDo0NTczZWRhNjg1MmYxYWU4OTBlZWQwM2M2NDQ3NTQyYWI3MDVlNjUz","size":22533,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/4573eda6852f1ae890eed03c6447542ab705e653","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwpwYWNr\nYWdlIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuc3RyYXRzOwoKaW1w\nb3J0IGphdmEuc3FsLio7CmltcG9ydCBqYXZhLnV0aWwuKjsKCmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLnV0aWwuKjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS5tZXRhLio7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\na2VybmVsLio7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC4qOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmVuaGFuY2UuUGVyc2lzdGVuY2VD\nYXBhYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS4q\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMua2VybmVsLio7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hlbWEuKjsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNxbC4qOwoKLyoqCiAqIDxwPk1h\ncHBpbmcgZm9yIGEgbWFwIHdob3NlIGtleXMgYW5kIHZhbHVlcyBhcmUgYm90\naCByZWxhdGlvbnMgdG8gb3RoZXIKICogcGVyc2lzdGVudCBvYmplY3RzLjwv\ncD4KICoKICogQGF1dGhvciBBYmUgV2hpdGUKICogQHNpbmNlIDAuNC4wLCAx\nLjEuMAogKi8KcHVibGljIGNsYXNzIFJlbGF0aW9uUmVsYXRpb25NYXBUYWJs\nZUZpZWxkU3RyYXRlZ3kKICAgIGV4dGVuZHMgTWFwVGFibGVGaWVsZFN0cmF0\nZWd5IHsKCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBMb2NhbGl6ZXIgX2xv\nYyA9IExvY2FsaXplci5mb3JQYWNrYWdlCiAgICAgICAgKFJlbGF0aW9uUmVs\nYXRpb25NYXBUYWJsZUZpZWxkU3RyYXRlZ3kuY2xhc3MpOwoKICAgIHByaXZh\ndGUgU3RyaW5nIF9rZXlSZWxhdGlvbk5hbWUgPSBudWxsOwoKICAgIHB1Ymxp\nYyBDb2x1bW5bXSBnZXRLZXlDb2x1bW5zKENsYXNzTWFwcGluZyBjbHMpIHsK\nICAgICAgICByZXR1cm4gZmllbGQuZ2V0S2V5TWFwcGluZygpLmdldENvbHVt\nbnMoKTsKICAgIH0KCiAgICBwdWJsaWMgQ29sdW1uW10gZ2V0VmFsdWVDb2x1\nbW5zKENsYXNzTWFwcGluZyBjbHMpIHsKICAgICAgICByZXR1cm4gZmllbGQu\nZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXRDb2x1bW5zKCk7CiAgICB9CgogICAg\ncHVibGljIHZvaWQgc2VsZWN0S2V5KFNlbGVjdCBzZWwsIENsYXNzTWFwcGlu\nZyBrZXksIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAgSkRCQ1N0\nb3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBKb2lu\ncyBqb2lucykgewogICAgICAgIHNlbC5zZWxlY3Qoa2V5LCBmaWVsZC5nZXRL\nZXlNYXBwaW5nKCkuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLAogICAgICAgICAg\nICBzdG9yZSwgZmV0Y2gsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24uRUFHRVJf\nTk9ORSwgam9pbnMpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIHNlbGVjdFZh\nbHVlKFNlbGVjdCBzZWwsIENsYXNzTWFwcGluZyB2YWwsCiAgICAgICAgT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0\nY2hDb25maWd1cmF0aW9uIGZldGNoLCAKICAgICAgICBKb2lucyBqb2lucykg\newogICAgICAgIHNlbC5zZWxlY3QodmFsLCBmaWVsZC5nZXRFbGVtZW50TWFw\ncGluZygpLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwKICAgICAgICAgICAgc3Rv\ncmUsIGZldGNoLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX05PTkUs\nIGpvaW5zKTsKICAgIH0KCiAgICBwdWJsaWMgUmVzdWx0W10gZ2V0UmVzdWx0\ncyhmaW5hbCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLAogICAgICAgIGZpbmFs\nIEpEQkNTdG9yZSBzdG9yZSwgZmluYWwgSkRCQ0ZldGNoQ29uZmlndXJhdGlv\nbiBmZXRjaCwKICAgICAgICBmaW5hbCBpbnQgZWFnZXJNb2RlLCBmaW5hbCBK\nb2luc1tdIHJlc0pvaW5zLCBib29sZWFuIGxycykKICAgICAgICB0aHJvd3Mg\nU1FMRXhjZXB0aW9uIHsKICAgICAgICBWYWx1ZU1hcHBpbmcga2V5ID0gZmll\nbGQuZ2V0S2V5TWFwcGluZygpOwogICAgICAgIGZpbmFsIENsYXNzTWFwcGlu\nZ1tdIGtleXMgPSBrZXkuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKTsK\nICAgICAgICBVbmlvbiBrdW5pb24gPSBzdG9yZS5nZXRTUUxGYWN0b3J5KCku\nbmV3VW5pb24oa2V5cy5sZW5ndGgpOwogICAgICAgIGlmIChmZXRjaC5nZXRT\ndWJjbGFzc0ZldGNoTW9kZShrZXkuZ2V0VHlwZU1hcHBpbmcoKSkKICAgICAg\nICAgICAgIT0gSkRCQ0ZldGNoQ29uZmlndXJhdGlvbi5FQUdFUl9KT0lOKQog\nICAgICAgICAgICBrdW5pb24uYWJvcnRVbmlvbigpOwogICAgICAgIGt1bmlv\nbi5zZXRMUlMobHJzKTsKICAgICAgICBrdW5pb24uc2VsZWN0KG5ldyBVbmlv\nbi5TZWxlY3RvcigpIHsKICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0\nKFNlbGVjdCBzZWwsIGludCBpZHgpIHsKICAgICAgICAgICAgICAgIEZvcmVp\nZ25LZXkgam9pbkZLID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChmaWVs\nZC5pc1VuaTFUb01GSygpKSB7CiAgICAgICAgICAgICAgICAgICAgVmFsdWVN\nYXBwaW5nIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRNYXBwaW5nKCk7CiAgICAg\nICAgICAgICAgICAgICAgVmFsdWVNYXBwaW5nSW5mbyB2aW5mbyA9IHZhbC5n\nZXRWYWx1ZUluZm8oKTsKICAgICAgICAgICAgICAgICAgICBUYWJsZSB0YWJs\nZSA9IHZpbmZvLmdldFRhYmxlKHZhbCk7CiAgICAgICAgICAgICAgICAgICAg\nam9pbkZLID0gZmllbGQuZ2V0TWFwcGluZ0luZm8oKS5nZXRKb2luRm9yZWln\nbktleShmaWVsZCwgdGFibGUsIHRydWUpOwogICAgICAgICAgICAgICAgfSBl\nbHNlIHsKICAgICAgICAgICAgICAgICAgICBqb2luRksgPSBmaWVsZC5nZXRK\nb2luRm9yZWlnbktleSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAg\nICAgICAgCiAgICAgICAgICAgICAgICBzZWwud2hlcmVGb3JlaWduS2V5KGpv\naW5GSywKICAgICAgICAgICAgICAgICAgICBzbS5nZXRPYmplY3RJZCgpLCBm\naWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgc3RvcmUpOwoKICAgICAgICAg\nICAgICAgIC8vIG9yZGVyIGJlZm9yZSBzZWxlY3QgaW4gY2FzZSB3ZSdyZSBm\nYWtpbmcgdW5pb24gd2l0aAogICAgICAgICAgICAgICAgLy8gbXVsdGlwbGUg\nc2VsZWN0czsgb3JkZXIgdmFscyB1c2VkIHRvIG1lcmdlIHJlc3VsdHMKICAg\nICAgICAgICAgICAgIEpvaW5zIGpvaW5zID0gam9pbktleVJlbGF0aW9uKHNl\nbC5uZXdKb2lucygpLCBrZXlzW2lkeF0pOwogICAgICAgICAgICAgICAgc2Vs\nLm9yZGVyQnkoZmllbGQuZ2V0S2V5TWFwcGluZygpLmdldENvbHVtbnMoKSwg\ndHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBzZWwuc2VsZWN0KGtleXNb\naWR4XSwgZmllbGQuZ2V0S2V5TWFwcGluZygpLgogICAgICAgICAgICAgICAg\nICAgIGdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdl\nck1vZGUsIGpvaW5zKTsKCiAgICAgICAgICAgICAgICAvLyMjIyBjaGVhdDog\ncmVzdWx0IGpvaW5zIG9ubHkgY2FyZSBhYm91dCB0aGUgcmVsYXRpb24gcGF0\naDsKICAgICAgICAgICAgICAgIC8vIyMjIHRodXMgd2UgY2FuIHVzZSBmaXJz\ndCBtYXBwaW5nIG9mIHVuaW9uIG9ubHkKICAgICAgICAgICAgICAgIGlmIChp\nZHggPT0gMCkKICAgICAgICAgICAgICAgICAgICByZXNKb2luc1swXSA9IGpv\naW5zOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIFZhbHVl\nTWFwcGluZyB2YWwgPSBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpOwogICAg\nICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIHZhbHMgPSB2YWwuZ2V0SW5kZXBl\nbmRlbnRUeXBlTWFwcGluZ3MoKTsKICAgICAgICBVbmlvbiB2dW5pb24gPSBz\ndG9yZS5nZXRTUUxGYWN0b3J5KCkubmV3VW5pb24odmFscy5sZW5ndGgpOwog\nICAgICAgIGlmIChmZXRjaC5nZXRTdWJjbGFzc0ZldGNoTW9kZSh2YWwuZ2V0\nVHlwZU1hcHBpbmcoKSkKICAgICAgICAgICAgIT0gSkRCQ0ZldGNoQ29uZmln\ndXJhdGlvbi5FQUdFUl9KT0lOKQogICAgICAgICAgICB2dW5pb24uYWJvcnRV\nbmlvbigpOwogICAgICAgIHZ1bmlvbi5zZXRMUlMobHJzKTsKICAgICAgICB2\ndW5pb24uc2VsZWN0KG5ldyBVbmlvbi5TZWxlY3RvcigpIHsKICAgICAgICAg\nICAgcHVibGljIHZvaWQgc2VsZWN0KFNlbGVjdCBzZWwsIGludCBpZHgpIHsK\nICAgICAgICAgICAgICAgIGlmIChmaWVsZC5pc1VuaTFUb01GSygpKSB7CiAg\nICAgICAgICAgICAgICAgICAgc2VsLm9yZGVyQnkoZmllbGQuZ2V0S2V5TWFw\ncGluZygpLmdldENvbHVtbnMoKSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAg\nICAgICAgICAgc2VsLnNlbGVjdCh2YWxzW2lkeF0sIGZpZWxkLmdldEVsZW1l\nbnRNYXBwaW5nKCkuCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFNlbGVj\ndFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdlck1vZGUsIG51bGwp\nOwogICAgICAgICAgICAgICAgICAgIHNlbC53aGVyZUZvcmVpZ25LZXkoZmll\nbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXRGb3JlaWduS2V5KCksCiAgICAg\nICAgICAgICAgICAgICAgICAgIHNtLmdldE9iamVjdElkKCksIGZpZWxkLmdl\ndEVsZW1lbnRNYXBwaW5nKCkuZ2V0RGVjbGFyZWRUeXBlTWFwcGluZygpLCBz\ndG9yZSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9\nIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNlbC53aGVyZUZvcmVpZ25L\nZXkoZmllbGQuZ2V0Sm9pbkZvcmVpZ25LZXkoKSwKICAgICAgICAgICAgICAg\nICAgICAgICAgc20uZ2V0T2JqZWN0SWQoKSwgZmllbGQuZ2V0RGVmaW5pbmdN\nYXBwaW5nKCksIHN0b3JlKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gb3Jk\nZXIgYmVmb3JlIHNlbGVjdCBpbiBjYXNlIHdlJ3JlIGZha2luZyB1bmlvbiB3\naXRoCiAgICAgICAgICAgICAgICAgICAgLy8gbXVsdGlwbGUgc2VsZWN0czsg\nb3JkZXIgdmFscyB1c2VkIHRvIG1lcmdlIHJlc3VsdHMKICAgICAgICAgICAg\nICAgICAgICBKb2lucyBqb2lucyA9IGpvaW5WYWx1ZVJlbGF0aW9uKHNlbC5u\nZXdKb2lucygpLCB2YWxzW2lkeF0pOwogICAgICAgICAgICAgICAgICAgIHNl\nbC5vcmRlckJ5KGZpZWxkLmdldEtleU1hcHBpbmcoKS5nZXRDb2x1bW5zKCks\nIHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHNlbC5zZWxlY3Qo\ndmFsc1tpZHhdLCBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLgogICAgICAg\nICAgICAgICAgICAgICAgICBnZXRTZWxlY3RTdWJjbGFzc2VzKCksIHN0b3Jl\nLCBmZXRjaCwgZWFnZXJNb2RlLCBqb2lucyk7CgogICAgICAgICAgICAgICAg\nICAgIC8vIyMjIGNoZWF0OiByZXN1bHQgam9pbnMgb25seSBjYXJlIGFib3V0\nIHRoZSByZWxhdGlvbiBwYXRoOwogICAgICAgICAgICAgICAgICAgIC8vIyMj\nIHRodXMgd2UgY2FuIHVzZSBmaXJzdCBtYXBwaW5nIG9mIHVuaW9uIG9ubHkK\nICAgICAgICAgICAgICAgICAgICBpZiAoaWR4ID09IDApCiAgICAgICAgICAg\nICAgICAgICAgICAgIHJlc0pvaW5zWzFdID0gam9pbnM7CiAgICAgICAgICAg\nICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgUmVz\ndWx0IGtyZXMgPSBudWxsOwogICAgICAgIFJlc3VsdCB2cmVzID0gbnVsbDsK\nICAgICAgICB0cnkgewogICAgICAgICAgICBrcmVzID0ga3VuaW9uLmV4ZWN1\ndGUoc3RvcmUsIGZldGNoKTsKICAgICAgICAgICAgdnJlcyA9IHZ1bmlvbi5l\neGVjdXRlKHN0b3JlLCBmZXRjaCk7CiAgICAgICAgICAgIHJldHVybiBuZXcg\nUmVzdWx0W117IGtyZXMsIHZyZXMgfTsKICAgICAgICB9IGNhdGNoIChTUUxF\neGNlcHRpb24gc2UpIHsKICAgICAgICAgICAgaWYgKGtyZXMgIT0gbnVsbCkK\nICAgICAgICAgICAgICAgIGtyZXMuY2xvc2UoKTsKICAgICAgICAgICAgaWYg\nKHZyZXMgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHZyZXMuY2xvc2UoKTsK\nICAgICAgICAgICAgdGhyb3cgc2U7CiAgICAgICAgfQogICAgfQoKICAgIHB1\nYmxpYyBPYmplY3QgbG9hZEtleShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBK\nREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlv\nbiBmZXRjaCwgUmVzdWx0IHJlcywgSm9pbnMgam9pbnMpCiAgICAgICAgdGhy\nb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgQ2xhc3NNYXBwaW5nIGtleSA9\nIHJlcy5nZXRCYXNlTWFwcGluZygpOwogICAgICAgIGlmIChrZXkgPT0gbnVs\nbCkKICAgICAgICAgICAga2V5ID0gZmllbGQuZ2V0S2V5TWFwcGluZygpLmdl\ndEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07CiAgICAgICAgcmV0dXJu\nIHJlcy5sb2FkKGtleSwgc3RvcmUsIGZldGNoLCBqb2lucyk7CiAgICB9Cgog\nICAgcHVibGljIE9iamVjdCBsb2FkVmFsdWUoT3BlbkpQQVN0YXRlTWFuYWdl\nciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZp\nZ3VyYXRpb24gZmV0Y2gsIFJlc3VsdCByZXMsIEpvaW5zIGpvaW5zKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIENsYXNzTWFwcGlu\nZyB2YWwgPSByZXMuZ2V0QmFzZU1hcHBpbmcoKTsKICAgICAgICBpZiAodmFs\nID09IG51bGwpCiAgICAgICAgICAgIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRN\nYXBwaW5nKCkuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKVswXTsKICAg\nICAgICByZXR1cm4gcmVzLmxvYWQodmFsLCBzdG9yZSwgZmV0Y2gsIGpvaW5z\nKTsKICAgIH0KCiAgICBwdWJsaWMgSm9pbnMgam9pbktleVJlbGF0aW9uKEpv\naW5zIGpvaW5zLCBDbGFzc01hcHBpbmcga2V5KSB7CiAgICAgICAgVmFsdWVN\nYXBwaW5nIHZtID0gZmllbGQuZ2V0S2V5TWFwcGluZygpOwogICAgICAgIHJl\ndHVybiBqb2lucy5qb2luUmVsYXRpb24oX2tleVJlbGF0aW9uTmFtZSwgdm0u\nZ2V0Rm9yZWlnbktleShrZXkpLCBrZXksCiAgICAgICAgICAgIHZtLmdldFNl\nbGVjdFN1YmNsYXNzZXMoKSwgZmFsc2UsIGZhbHNlKTsKICAgIH0KCiAgICBw\ndWJsaWMgSm9pbnMgam9pblZhbHVlUmVsYXRpb24oSm9pbnMgam9pbnMsIENs\nYXNzTWFwcGluZyB2YWwpIHsKICAgICAgICBWYWx1ZU1hcHBpbmcgdm0gPSBm\naWVsZC5nZXRFbGVtZW50TWFwcGluZygpOwogICAgICAgIEZvcmVpZ25LZXkg\nZmsgPSB2bS5nZXRGb3JlaWduS2V5KHZhbCk7CiAgICAgICAgaWYgKGZrID09\nIG51bGwpCiAgICAgICAgICAgIHJldHVybiBqb2luczsKICAgICAgICByZXR1\ncm4gam9pbnMuam9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwgZmssIHZh\nbCwKICAgICAgICAgICAgdm0uZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBmYWxz\nZSwgZmFsc2UpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIG1hcChib29sZWFu\nIGFkYXB0KSB7CiAgICAgICAgc3VwZXIubWFwKGFkYXB0KTsKCiAgICAgICAg\nVmFsdWVNYXBwaW5nIGtleSA9IGZpZWxkLmdldEtleU1hcHBpbmcoKTsKICAg\nICAgICBpZiAoa2V5LmdldFR5cGVDb2RlKCkgIT0gSmF2YVR5cGVzLlBDIHx8\nIGtleS5pc0VtYmVkZGVkUEMoKSkKICAgICAgICAgICAgdGhyb3cgbmV3IE1l\ndGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0KCJub3QtcmVsYXRpb24iLCBrZXkp\nKTsKICAgICAgICBWYWx1ZU1hcHBpbmcgdmFsID0gZmllbGQuZ2V0RWxlbWVu\ndE1hcHBpbmcoKTsKICAgICAgICBpZiAodmFsLmdldFR5cGVDb2RlKCkgIT0g\nSmF2YVR5cGVzLlBDIHx8IHZhbC5pc0VtYmVkZGVkUEMoKSkKICAgICAgICAg\nICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0KCJub3Qt\ncmVsYXRpb24iLCB2YWwpKTsKICAgICAgICBGaWVsZE1hcHBpbmcgbWFwcGVk\nID0gZmllbGQuZ2V0TWFwcGVkQnlNYXBwaW5nKCk7CiAgICAgICAgREJEaWN0\naW9uYXJ5IGRpY3QgPSBmaWVsZC5nZXRNYXBwaW5nUmVwb3NpdG9yeSgpLmdl\ndERCRGljdGlvbmFyeSgpOwogICAgICAgIFN0cmluZyBrZXlOYW1lID0gbnVs\nbDsKICAgICAgICBpZiAoZmllbGQuaXNVbmkxVG9NRksoKSB8fCAoIWZpZWxk\nLmlzQmlNVG8xSlQoKSAmJiBtYXBwZWQgIT0gbnVsbCkpIHsgCiAgICAgICAg\nICAgIGhhbmRsZU1hcHBlZEJ5Rm9yZWlnbktleShhZGFwdCk7CiAgICAgICAg\nICAgIGtleU5hbWUgPSBkaWN0LmdldFZhbGlkQ29sdW1uTmFtZSgidmtleSIs\nIGZpZWxkLmdldFRhYmxlKCkpOwogICAgICAgIH0gZWxzZSBpZiAoZmllbGQu\naXNCaU1UbzFKVCgpIHx8IG1hcHBlZCA9PSBudWxsKSB7IAogICAgICAgICAg\nICBmaWVsZC5tYXBKb2luKGFkYXB0LCB0cnVlKTsKICAgICAgICAgICAgbWFw\nVHlwZUpvaW4odmFsLCAidmFsdWUiLCBhZGFwdCk7CiAgICAgICAgICAgIGtl\neU5hbWUgPSBkaWN0LmdldFZhbGlkQ29sdW1uTmFtZSgia2V5IiwgZmllbGQu\nZ2V0VGFibGUoKSk7CiAgICAgICAgfQogICAgICAgIG1hcFR5cGVKb2luKGtl\neSwga2V5TmFtZSwgYWRhcHQpOwoKICAgICAgICBmaWVsZC5tYXBQcmltYXJ5\nS2V5KGFkYXB0KTsKICAgIH0KCiAgICAvKioKICAgICAqIE1hcCB0aGUgZ2l2\nZW4gdmFsdWUncyBqb2luIHRvIGl0cyBwZXJzaXN0ZW50IHR5cGUuCiAgICAg\nKi8KICAgIHByaXZhdGUgdm9pZCBtYXBUeXBlSm9pbihWYWx1ZU1hcHBpbmcg\ndm0sIFN0cmluZyBuYW1lLCBib29sZWFuIGFkYXB0KSB7CiAgICAgICAgaWYg\nKHZtLmdldFR5cGVNYXBwaW5nKCkuaXNNYXBwZWQoKSkgewogICAgICAgICAg\nICBWYWx1ZU1hcHBpbmdJbmZvIHZpbmZvID0gdm0uZ2V0VmFsdWVJbmZvKCk7\nCiAgICAgICAgICAgIEZvcmVpZ25LZXkgZmsgPSB2aW5mby5nZXRUeXBlSm9p\nbih2bSwgbmFtZSwgZmFsc2UsIGFkYXB0KTsKICAgICAgICAgICAgdm0uc2V0\nRm9yZWlnbktleShmayk7CiAgICAgICAgICAgIHZtLnNldENvbHVtbklPKHZp\nbmZvLmdldENvbHVtbklPKCkpOwogICAgICAgIH0gZWxzZQogICAgICAgICAg\nICBSZWxhdGlvblN0cmF0ZWdpZXMubWFwUmVsYXRpb25Ub1VubWFwcGVkUEMo\ndm0sIG5hbWUsIGFkYXB0KTsKICAgICAgICB2bS5tYXBDb25zdHJhaW50cyhu\nYW1lLCBhZGFwdCk7CiAgICB9CgogICAgcHVibGljIHZvaWQgaW5pdGlhbGl6\nZSgpIHsKICAgICAgICBfa2V5UmVsYXRpb25OYW1lID0gZmllbGQuZ2V0TmFt\nZSgpICsgIjprZXkiOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGluc2VydChP\ncGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsIFJvd01h\nbmFnZXIgcm0pCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAg\nICAgaW5zZXJ0KHNtLCBybSwgKE1hcCkgc20uZmV0Y2hPYmplY3QoZmllbGQu\nZ2V0SW5kZXgoKSksIHN0b3JlKTsKICAgIH0KCiAgICBwcml2YXRlIHZvaWQg\naW5zZXJ0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIFJvd01hbmFnZXIgcm0s\nIE1hcCBtYXAsIAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSkKICAgICAgICB0\naHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBpZiAobWFwID09IG51bGwg\nfHwgbWFwLmlzRW1wdHkoKSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAg\nIAogICAgICAgIGlmICghZmllbGQuaXNCaU1UbzFKVCgpICYmIGZpZWxkLmdl\ndE1hcHBlZEJ5KCkgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAg\nICAgICBSb3cgcm93ID0gbnVsbDsKICAgICAgICBpZiAoIWZpZWxkLmlzVW5p\nMVRvTUZLKCkpIHsKICAgICAgICAgICAgcm93ID0gcm0uZ2V0U2Vjb25kYXJ5\nUm93KGZpZWxkLmdldFRhYmxlKCksIFJvdy5BQ1RJT05fSU5TRVJUKTsKICAg\nICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmllbGQuZ2V0Sm9pbkZvcmVp\nZ25LZXkoKSwgZmllbGQuZ2V0Sm9pbkNvbHVtbklPKCksCiAgICAgICAgICAg\nICAgICBzbSk7CiAgICAgICAgfQogICAgICAgIFZhbHVlTWFwcGluZyBrZXkg\nPSBmaWVsZC5nZXRLZXlNYXBwaW5nKCk7CiAgICAgICAgVmFsdWVNYXBwaW5n\nIHZhbCA9IGZpZWxkLmdldEVsZW1lbnRNYXBwaW5nKCk7CiAgICAgICAgU3Rv\ncmVDb250ZXh0IGN0eCA9IHNtLmdldENvbnRleHQoKTsKICAgICAgICBPcGVu\nSlBBU3RhdGVNYW5hZ2VyIGtleXNtLCB2YWxzbTsKICAgICAgICBNYXAuRW50\ncnkgZW50cnk7CiAgICAgICAgZm9yIChJdGVyYXRvciBpdHIgPSBtYXAuZW50\ncnlTZXQoKS5pdGVyYXRvcigpOyBpdHIuaGFzTmV4dCgpOykgewogICAgICAg\nICAgICBlbnRyeSA9IChNYXAuRW50cnkpIGl0ci5uZXh0KCk7CiAgICAgICAg\nICAgIGtleXNtID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncihlbnRyeS5nZXRLZXkoKSwgY3R4KTsKICAgICAgICAgICAgdmFsc20gPSBS\nZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKGVudHJ5LmdldFZh\nbHVlKCksIGN0eCk7CiAgICAgICAgICAgIGlmIChmaWVsZC5pc1VuaTFUb01G\nSygpKXsKICAgICAgICAgICAgICAgIHJvdyA9IHJtLmdldFJvdyhmaWVsZC5n\nZXRFbGVtZW50TWFwcGluZygpLmdldERlY2xhcmVkVHlwZU1hcHBpbmcoKS5n\nZXRUYWJsZSgpLAogICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJT05fVVBE\nQVRFLCB2YWxzbSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICByb3cud2hlcmVQ\ncmltYXJ5S2V5KHZhbHNtKTsKICAgICAgICAgICAgICAgIHZhbC5zZXRGb3Jl\naWduS2V5KHJvdywgc20pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAg\nICAgICAgICAgdmFsLnNldEZvcmVpZ25LZXkocm93LCB2YWxzbSk7CiAgICAg\nICAgICAgIH0KICAgICAgICAgICAga2V5LnNldEZvcmVpZ25LZXkocm93LCBr\nZXlzbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBzbyBmYXIsIHdl\nIHBvcHVsYXRlZCB0aGUga2V5L3ZhbHVlIG9mIGVhY2gKICAgICAgICAgICAg\nLy8gbWFwIGVsZW1lbnQgb3duZWQgYnkgdGhlIGVudGl0eS4KICAgICAgICAg\nICAgLy8gSW4gdGhlIGNhc2Ugb2YgVG9NYW55LCBhbmQgYm90aCBzaWRlcwog\nICAgICAgICAgICAvLyB1c2UgTWFwIHRvIHJlcHJlc2VudCB0aGUgcmVsYXRp\nb24sCiAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcG9wdWxhdGUgdGhlIGtl\neSB2YWx1ZSBvZiB0aGUgb3duZXIKICAgICAgICAgICAgLy8gZnJvbSB0aGUg\ndmlldyBwb2ludCBvZiB0aGUgb3duZWQgc2lkZQogICAgICAgICAgICBQZXJz\naXN0ZW5jZUNhcGFibGUgb2JqID0gc20uZ2V0UGVyc2lzdGVuY2VDYXBhYmxl\nKCk7CiAgICAgICAgICAgIGlmICghcG9wdWxhdGVLZXkocm93LCB2YWxzbSwg\nb2JqLCBjdHgsIHJtLCBzdG9yZSkpCiAgICAgICAgICAgICAgICBpZiAoIWZp\nZWxkLmlzVW5pMVRvTUZLKCkpCiAgICAgICAgICAgICAgICAgICAgcm0uZmx1\nc2hTZWNvbmRhcnlSb3cocm93KTsKICAgICAgICB9CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgdXBkYXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNT\ndG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAh\nPSBudWxsICYmICFmaWVsZC5pc0JpTVRvMUpUKCkpCiAgICAgICAgICAgIHJl\ndHVybjsKICAgICAgICAKICAgICAgICBNYXAgbWFwID0gKE1hcCkgc20uZmV0\nY2hPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAgICAgQ2hhbmdlVHJh\nY2tlciBjdCA9IG51bGw7CiAgICAgICAgaWYgKG1hcCBpbnN0YW5jZW9mIFBy\nb3h5KSB7CiAgICAgICAgICAgIFByb3h5IHByb3h5ID0gKFByb3h5KSBtYXA7\nCiAgICAgICAgICAgIGlmIChQcm94aWVzLmlzT3duZXIocHJveHksIHNtLCBm\naWVsZC5nZXRJbmRleCgpKSkKICAgICAgICAgICAgICAgIGN0ID0gcHJveHku\nZ2V0Q2hhbmdlVHJhY2tlcigpOwogICAgICAgIH0KCiAgICAgICAgLy8gaWYg\nbm8gZmluZS1ncmFpbmVkIGNoYW5nZSB0cmFja2luZyB0aGVuIGp1c3QgZGVs\nZXRlIGFuZCByZWluc2VydAogICAgICAgIGlmIChjdCA9PSBudWxsIHx8ICFj\ndC5pc1RyYWNraW5nKCkpIHsKICAgICAgICAgICAgZGVsZXRlKHNtLCBzdG9y\nZSwgcm0pOwogICAgICAgICAgICBpbnNlcnQoc20sIHJtLCBtYXAsIHN0b3Jl\nKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgVmFs\ndWVNYXBwaW5nIGtleSA9IGZpZWxkLmdldEtleU1hcHBpbmcoKTsKICAgICAg\nICBWYWx1ZU1hcHBpbmcgdmFsID0gZmllbGQuZ2V0RWxlbWVudE1hcHBpbmco\nKTsKICAgICAgICBTdG9yZUNvbnRleHQgY3R4ID0gc3RvcmUuZ2V0Q29udGV4\ndCgpOwogICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFnZXIga2V5c20sIHZhbHNt\nOwoKICAgICAgICAvLyB1cGRhdGUgdGhlIGNoYW5nZXM7IG5vdGUgdGhhdCB3\nZSBoYXZlIHRvIG1vZGVsIGNoYW5nZXMgYXMKICAgICAgICAvLyBkZWxldGUt\ndGhlbi1pbnNlcnQgaWYgd2UgaGF2ZSBhIGZvcmVpZ24ga2V5IGFjdGlvbiwg\nYmVjYXVzZQogICAgICAgIC8vIHNlY29uZGFyeSByb3cgdXBkYXRlcyBhcmVu\nJ3QgcGFydCBvZiB0aGUgY29uc3RyYWludCBncmFwaAogICAgICAgIENvbGxl\nY3Rpb24gY2hhbmdlID0gY3QuZ2V0Q2hhbmdlZCgpOwogICAgICAgIGJvb2xl\nYW4gY2FuQ2hhbmdlID0gdmFsLmdldEZvcmVpZ25LZXkoKS5pc0xvZ2ljYWwo\nKTsKICAgICAgICBPYmplY3QgbWtleTsKICAgICAgICBpZiAoY2FuQ2hhbmdl\nICYmICFjaGFuZ2UuaXNFbXB0eSgpKSB7CiAgICAgICAgICAgIFJvdyBjaGFu\nZ2VSb3cgPSBudWxsOwogICAgICAgICAgICBpZiAoIWZpZWxkLmlzVW5pMVRv\nTUZLKCkpIHsKICAgICAgICAgICAgICAgIHJtLmdldFNlY29uZGFyeVJvdyhm\naWVsZC5nZXRUYWJsZSgpLAogICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJ\nT05fVVBEQVRFKTsKICAgICAgICAgICAgICAgIGNoYW5nZVJvdy53aGVyZUZv\ncmVpZ25LZXkoZmllbGQuZ2V0Sm9pbkZvcmVpZ25LZXkoKSwgc20pOwogICAg\nICAgICAgICB9CiAgICAgICAgICAgIGZvciAoSXRlcmF0b3IgaXRyID0gY2hh\nbmdlLml0ZXJhdG9yKCk7IGl0ci5oYXNOZXh0KCk7KSB7CiAgICAgICAgICAg\nICAgICBta2V5ID0gaXRyLm5leHQoKTsKICAgICAgICAgICAgICAgIE9iamVj\ndCBtdmFsID0gbWFwLmdldChta2V5KTsKICAgICAgICAgICAgICAgIGlmICht\ndmFsID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBTZXQ8TWFwLkVu\ndHJ5PiBlbnRyaWVzID0gbWFwLmVudHJ5U2V0KCk7CiAgICAgICAgICAgICAg\nICAgICAgZm9yIChNYXAuRW50cnkgZW50cnkgOiBlbnRyaWVzKSB7CiAgICAg\nICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeS5nZXRLZXkoKS5lcXVhbHMo\nbWtleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdmFsID0gZW50\ncnkuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAg\nICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobXZhbCA9PSBudWxsKQog\nICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAg\na2V5c20gPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKG1r\nZXksIGN0eCk7CiAgICAgICAgICAgICAgICB2YWxzbSA9IFJlbGF0aW9uU3Ry\nYXRlZ2llcy5nZXRTdGF0ZU1hbmFnZXIobXZhbCwgY3R4KTsKICAgICAgICAg\nICAgICAgIGtleS53aGVyZUZvcmVpZ25LZXkoY2hhbmdlUm93LCBrZXlzbSk7\nCiAgICAgICAgICAgICAgICBpZiAoZmllbGQuaXNVbmkxVG9NRksoKSl7CiAg\nICAgICAgICAgICAgICAgICAgY2hhbmdlUm93ID0gcm0uZ2V0Um93KGZpZWxk\nLmdldEVsZW1lbnRNYXBwaW5nKCkuZ2V0RGVjbGFyZWRUeXBlTWFwcGluZygp\nLmdldFRhYmxlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJ\nT05fVVBEQVRFLCB2YWxzbSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAg\nY2hhbmdlUm93LndoZXJlUHJpbWFyeUtleSh2YWxzbSk7CiAgICAgICAgICAg\nICAgICAgICAgdmFsLnNldEZvcmVpZ25LZXkoY2hhbmdlUm93LCBzbSk7CiAg\nICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZh\nbC5zZXRGb3JlaWduS2V5KGNoYW5nZVJvdywgdmFsc20pOwogICAgICAgICAg\nICAgICAgICAgIHJtLmZsdXNoU2Vjb25kYXJ5Um93KGNoYW5nZVJvdyk7CiAg\nICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAg\nICAgIC8vIGRlbGV0ZSB0aGUgcmVtb3ZlcwogICAgICAgIENvbGxlY3Rpb24g\ncmVtID0gY3QuZ2V0UmVtb3ZlZCgpOwogICAgICAgIGlmICghcmVtLmlzRW1w\ndHkoKSB8fCAoIWNhbkNoYW5nZSAmJiAhY2hhbmdlLmlzRW1wdHkoKSkpIHsK\nICAgICAgICAgICAgUm93IGRlbFJvdyA9IG51bGw7CiAgICAgICAgICAgIGlm\nICghZmllbGQuaXNVbmkxVG9NRksoKSkgewogICAgICAgICAgICAgICAgZGVs\nUm93ID0gcm0uZ2V0U2Vjb25kYXJ5Um93KGZpZWxkLmdldFRhYmxlKCksCiAg\nICAgICAgICAgICAgICAgICAgUm93LkFDVElPTl9ERUxFVEUpOwogICAgICAg\nICAgICAgICAgZGVsUm93LndoZXJlRm9yZWlnbktleShmaWVsZC5nZXRKb2lu\nRm9yZWlnbktleSgpLCBzbSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAg\nIGZvciAoSXRlcmF0b3IgaXRyID0gcmVtLml0ZXJhdG9yKCk7IGl0ci5oYXNO\nZXh0KCk7KSB7CiAgICAgICAgICAgICAgICBPYmplY3QgcGMgPSBpdHIubmV4\ndCgpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkLmlzVW5pMVRvTUZLKCkp\newogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVNldE51bGwoc20sIHJtLCBw\nYyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAg\nICAgIGtleXNtID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncihwYywgY3R4KTsKICAgICAgICAgICAgICAgICAgICBrZXkud2hlcmVGb3Jl\naWduS2V5KGRlbFJvdywga2V5c20pOwogICAgICAgICAgICAgICAgICAgIHJt\nLmZsdXNoU2Vjb25kYXJ5Um93KGRlbFJvdyk7CiAgICAgICAgICAgICAgICB9\nCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYW5DaGFuZ2UgJiYg\nIWNoYW5nZS5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgICAgIGZvciAoSXRl\ncmF0b3IgaXRyID0gY2hhbmdlLml0ZXJhdG9yKCk7IGl0ci5oYXNOZXh0KCk7\nKSB7CiAgICAgICAgICAgICAgICAgICAgT2JqZWN0IHBjID0gaXRyLm5leHQo\nKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQuaXNVbmkxVG9NRkso\nKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVNldE51bGwoc20s\nIHJtLCBwYyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgCiAgICAg\nICAgICAgICAgICAgICAgICAgIGtleXNtID0gUmVsYXRpb25TdHJhdGVnaWVz\nLmdldFN0YXRlTWFuYWdlcihwYywgY3R4KTsKICAgICAgICAgICAgICAgICAg\nICAgICAga2V5LndoZXJlRm9yZWlnbktleShkZWxSb3csIGtleXNtKTsKICAg\nICAgICAgICAgICAgICAgICAgICAgcm0uZmx1c2hTZWNvbmRhcnlSb3coZGVs\nUm93KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9\nCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGluc2VydCB0\naGUgYWRkcwogICAgICAgIENvbGxlY3Rpb24gYWRkID0gY3QuZ2V0QWRkZWQo\nKTsKICAgICAgICBpZiAoIWFkZC5pc0VtcHR5KCkgfHwgKCFjYW5DaGFuZ2Ug\nJiYgIWNoYW5nZS5pc0VtcHR5KCkpKSB7CiAgICAgICAgICAgIFJvdyBhZGRS\nb3cgPSBudWxsOwogICAgICAgICAgICBpZiAoIWZpZWxkLmlzVW5pMVRvTUZL\nKCkpIHsKICAgICAgICAgICAgICAgIGFkZFJvdyA9IHJtLmdldFNlY29uZGFy\neVJvdyhmaWVsZC5nZXRUYWJsZSgpLAogICAgICAgICAgICAgICAgICAgIFJv\ndy5BQ1RJT05fSU5TRVJUKTsKICAgICAgICAgICAgICAgIGFkZFJvdy5zZXRG\nb3JlaWduS2V5KGZpZWxkLmdldEpvaW5Gb3JlaWduS2V5KCksCiAgICAgICAg\nICAgICAgICAgICAgZmllbGQuZ2V0Sm9pbkNvbHVtbklPKCksIHNtKTsKICAg\nICAgICAgICAgfQogICAgICAgICAgICBmb3IgKEl0ZXJhdG9yIGl0ciA9IGFk\nZC5pdGVyYXRvcigpOyBpdHIuaGFzTmV4dCgpOykgewogICAgICAgICAgICAg\nICAgbWtleSA9IGl0ci5uZXh0KCk7CiAgICAgICAgICAgICAgICBPYmplY3Qg\nbXZhbCA9IG1hcC5nZXQobWtleSk7CiAgICAgICAgICAgICAgICBpZiAobXZh\nbCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgU2V0PE1hcC5FbnRy\neT4gZW50cmllcyA9IG1hcC5lbnRyeVNldCgpOwogICAgICAgICAgICAgICAg\nICAgIGZvciAoTWFwLkVudHJ5IGVudHJ5IDogZW50cmllcykgewogICAgICAg\nICAgICAgICAgICAgICAgICBpZiAoZW50cnkuZ2V0S2V5KCkuZXF1YWxzKG1r\nZXkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXZhbCA9IGVudHJ5\nLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAg\nICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG12YWwgPT0gbnVsbCkKICAg\nICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIGtl\neXNtID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihta2V5\nLCBjdHgpOwogICAgICAgICAgICAgICAgdmFsc20gPSBSZWxhdGlvblN0cmF0\nZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKG12YWwsIGN0eCk7CiAgICAgICAgICAg\nICAgICBpZiAoZmllbGQuaXNVbmkxVG9NRksoKSl7CiAgICAgICAgICAgICAg\nICAgICAgYWRkUm93ID0gcm0uZ2V0Um93KGZpZWxkLmdldEVsZW1lbnRNYXBw\naW5nKCkuZ2V0RGVjbGFyZWRUeXBlTWFwcGluZygpLmdldFRhYmxlKCksCiAg\nICAgICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJT05fVVBEQVRFLCB2YWxz\nbSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgYWRkUm93LndoZXJlUHJp\nbWFyeUtleSh2YWxzbSk7CiAgICAgICAgICAgICAgICAgICAga2V5LnNldEZv\ncmVpZ25LZXkoYWRkUm93LCBrZXlzbSk7CiAgICAgICAgICAgICAgICAgICAg\ndmFsLnNldEZvcmVpZ25LZXkoYWRkUm93LCBzbSk7CiAgICAgICAgICAgICAg\nICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGtleS5zZXRGb3JlaWdu\nS2V5KGFkZFJvdywga2V5c20pOwogICAgICAgICAgICAgICAgICAgIHZhbC5z\nZXRGb3JlaWduS2V5KGFkZFJvdywgdmFsc20pOwogICAgICAgICAgICAgICAg\nICAgIHJtLmZsdXNoU2Vjb25kYXJ5Um93KGFkZFJvdyk7CiAgICAgICAgICAg\nICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYW5DaGFu\nZ2UgJiYgIWNoYW5nZS5pc0VtcHR5KCkpIHsKICAgICAgICAgICAgICAgIGZv\nciAoSXRlcmF0b3IgaXRyID0gY2hhbmdlLml0ZXJhdG9yKCk7IGl0ci5oYXNO\nZXh0KCk7KSB7CiAgICAgICAgICAgICAgICAgICAgbWtleSA9IGl0ci5uZXh0\nKCk7CiAgICAgICAgICAgICAgICAgICAgT2JqZWN0IG12YWwgPSBtYXAuZ2V0\nKG1rZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChtdmFsID09IG51bGwp\nIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2V0PE1hcC5FbnRyeT4gZW50\ncmllcyA9IG1hcC5lbnRyeVNldCgpOwogICAgICAgICAgICAgICAgICAgICAg\nICBmb3IgKE1hcC5FbnRyeSBlbnRyeSA6IGVudHJpZXMpIHsKICAgICAgICAg\nICAgICAgICAgICAgICAgICAgIGlmIChlbnRyeS5nZXRLZXkoKS5lcXVhbHMo\nbWtleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXZhbCA9\nIGVudHJ5LmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0K\nICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYg\nKG12YWwgPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGlu\ndWU7CiAgICAgICAgICAgICAgICAgICAga2V5c20gPSBSZWxhdGlvblN0cmF0\nZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyKG1rZXksIGN0eCk7CiAgICAgICAgICAg\nICAgICAgICAgdmFsc20gPSBSZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVN\nYW5hZ2VyKG12YWwsIGN0eCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZp\nZWxkLmlzVW5pMVRvTUZLKCkpewogICAgICAgICAgICAgICAgICAgICAgICBh\nZGRSb3cgPSBybS5nZXRSb3coZmllbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS5n\nZXREZWNsYXJlZFR5cGVNYXBwaW5nKCkuZ2V0VGFibGUoKSwKICAgICAgICAg\nICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJT05fVVBEQVRFLCB2YWxzbSwg\ndHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZFJvdy53aGVyZVBy\naW1hcnlLZXkodmFsc20pOwogICAgICAgICAgICAgICAgICAgICAgICBrZXku\nc2V0Rm9yZWlnbktleShhZGRSb3csIGtleXNtKTsKICAgICAgICAgICAgICAg\nICAgICAgICAgdmFsLnNldEZvcmVpZ25LZXkoYWRkUm93LCBzbSk7CiAgICAg\nICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAg\nICAga2V5LnNldEZvcmVpZ25LZXkoYWRkUm93LCBrZXlzbSk7CiAgICAgICAg\nICAgICAgICAgICAgICAgIHZhbC5zZXRGb3JlaWduS2V5KGFkZFJvdywgdmFs\nc20pOwogICAgICAgICAgICAgICAgICAgICAgICBybS5mbHVzaFNlY29uZGFy\neVJvdyhhZGRSb3cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAg\nICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBw\ndWJsaWMgSm9pbnMgam9pblJlbGF0aW9uKEpvaW5zIGpvaW5zLCBib29sZWFu\nIGZvcmNlT3V0ZXIsCiAgICAgICAgYm9vbGVhbiB0cmF2ZXJzZSkgewogICAg\nICAgIFZhbHVlTWFwcGluZyB2YWwgPSBmaWVsZC5nZXRFbGVtZW50TWFwcGlu\nZygpOwogICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSB2YWwuZ2V0SW5k\nZXBlbmRlbnRUeXBlTWFwcGluZ3MoKTsKICAgICAgICBpZiAoY2xzcy5sZW5n\ndGggIT0gMSkgewogICAgICAgICAgICBpZiAodHJhdmVyc2UpCiAgICAgICAg\nICAgICAgICB0aHJvdyBSZWxhdGlvblN0cmF0ZWdpZXMudW5qb2luYWJsZSh2\nYWwpOwogICAgICAgICAgICByZXR1cm4gam9pbnM7CiAgICAgICAgfQogICAg\nICAgIEZvcmVpZ25LZXkgZmsgPSB2YWwuZ2V0Rm9yZWlnbktleShjbHNzWzBd\nKTsKICAgICAgICBpZiAoZmsgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJu\nIGpvaW5zOwogICAgICAgIGlmIChmb3JjZU91dGVyKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgp\nLAogICAgICAgICAgICAgICAgZmssIGNsc3NbMF0sIHZhbC5nZXRTZWxlY3RT\ndWJjbGFzc2VzKCksCiAgICAgICAgICAgICAgICBmYWxzZSwgZmFsc2UpOwog\nICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFt\nZSgpLAogICAgICAgICAgICBmaywgY2xzc1swXSwgdmFsLmdldFNlbGVjdFN1\nYmNsYXNzZXMoKSwKICAgICAgICAgICAgZmFsc2UsIGZhbHNlKTsKICAgIH0K\nCiAgICBwdWJsaWMgSm9pbnMgam9pbktleVJlbGF0aW9uKEpvaW5zIGpvaW5z\nLCBib29sZWFuIGZvcmNlT3V0ZXIsCiAgICAgICAgYm9vbGVhbiB0cmF2ZXJz\nZSkgewogICAgICAgIFZhbHVlTWFwcGluZyBrZXkgPSBmaWVsZC5nZXRLZXlN\nYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xzcyA9IGtleS5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGlmIChjbHNz\nLmxlbmd0aCAhPSAxKSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZSkKICAg\nICAgICAgICAgICAgIHRocm93IFJlbGF0aW9uU3RyYXRlZ2llcy51bmpvaW5h\nYmxlKGtleSk7CiAgICAgICAgICAgIHJldHVybiBqb2luczsKICAgICAgICB9\nCiAgICAgICAgaWYgKGZvcmNlT3V0ZXIpCiAgICAgICAgICAgIHJldHVybiBq\nb2lucy5vdXRlckpvaW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCksCiAgICAg\nICAgICAgICAgICBrZXkuZ2V0Rm9yZWlnbktleShjbHNzWzBdKSwgY2xzc1sw\nXSwga2V5LmdldFNlbGVjdFN1YmNsYXNzZXMoKSwKICAgICAgICAgICAgICAg\nIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIGpvaW5zLmpvaW5SZWxh\ndGlvbihfa2V5UmVsYXRpb25OYW1lLAogICAgICAgICAgICBrZXkuZ2V0Rm9y\nZWlnbktleShjbHNzWzBdKSwgY2xzc1swXSwga2V5LmdldFNlbGVjdFN1YmNs\nYXNzZXMoKSwgCiAgICAgICAgICAgIGZhbHNlLCBmYWxzZSk7CiAgICB9Cgog\nICAgcHVibGljIE9iamVjdCB0b0RhdGFTdG9yZVZhbHVlKE9iamVjdCB2YWws\nIEpEQkNTdG9yZSBzdG9yZSkgewogICAgICAgIHJldHVybiBSZWxhdGlvblN0\ncmF0ZWdpZXMudG9EYXRhU3RvcmVWYWx1ZShmaWVsZC5nZXRFbGVtZW50TWFw\ncGluZygpLAogICAgICAgICAgICB2YWwsIHN0b3JlKTsKICAgIH0KCiAgICBw\ndWJsaWMgT2JqZWN0IHRvS2V5RGF0YVN0b3JlVmFsdWUoT2JqZWN0IHZhbCwg\nSkRCQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgcmV0dXJuIFJlbGF0aW9uU3Ry\nYXRlZ2llcy50b0RhdGFTdG9yZVZhbHVlKGZpZWxkLmdldEtleU1hcHBpbmco\nKSwKICAgICAgICAgICAgdmFsLCBzdG9yZSk7CiAgICB9CiAgICAKICAgIHB1\nYmxpYyB2b2lkIGRlbGV0ZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJD\nU3RvcmUgc3RvcmUsIFJvd01hbmFnZXIgcm0pCiAgICAgICAgdGhyb3dzIFNR\nTEV4Y2VwdGlvbiB7CiAgICAgICAgaWYgKGZpZWxkLmlzVW5pMVRvTUZLKCkp\nIHsKICAgICAgICAgICAgTWFwIG1hcE9iaiA9IChNYXApc20uZmV0Y2hPYmpl\nY3QoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAgICAgICAgIHVwZGF0ZVNldE51\nbGwoc20sIHN0b3JlLCBybSwgbWFwT2JqLmtleVNldCgpKTsKICAgICAgICAg\nICAgcmV0dXJuOwogICAgICAgIH0gICAgCiAgICAgICAgc3VwZXIuZGVsZXRl\nKHNtLCBzdG9yZSwgcm0pOwogICAgfQogICAgCiAgICBwcml2YXRlIHZvaWQg\ndXBkYXRlU2V0TnVsbChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3Rv\ncmUgc3RvcmUsIFJvd01hbmFnZXIgcm0sCiAgICAgICAgU2V0IHJlbSkgdGhy\nb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgZm9yIChJdGVyYXRvciBpdHIg\nPSByZW0uaXRlcmF0b3IoKTsgaXRyLmhhc05leHQoKTspIHsKICAgICAgICAg\nICAgT2JqZWN0IG1rZXkgPSBpdHIubmV4dCgpOwogICAgICAgICAgICB1cGRh\ndGVTZXROdWxsKHNtLCBybSwgbWtleSk7CiAgICAgICAgfQogICAgfQogICAg\nCiAgICBwcml2YXRlIHZvaWQgdXBkYXRlU2V0TnVsbChPcGVuSlBBU3RhdGVN\nYW5hZ2VyIHNtLCBSb3dNYW5hZ2VyIHJtLCBPYmplY3QgbWtleSkgCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgU3RvcmVDb250ZXh0\nIGN0eCA9IHNtLmdldENvbnRleHQoKTsKICAgICAgICBWYWx1ZU1hcHBpbmcg\na2V5ID0gZmllbGQuZ2V0S2V5TWFwcGluZygpOwogICAgICAgIFZhbHVlTWFw\ncGluZyB2YWwgPSBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpOwogICAgICAg\nIE9wZW5KUEFTdGF0ZU1hbmFnZXIga2V5c20gPSBSZWxhdGlvblN0cmF0ZWdp\nZXMuZ2V0U3RhdGVNYW5hZ2VyKG1rZXksIGN0eCk7CiAgICAgICAgUm93IGRl\nbFJvdyA9IHJtLmdldFJvdyhmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdl\ndERlY2xhcmVkVHlwZU1hcHBpbmcoKS5nZXRUYWJsZSgpLAogICAgICAgICAg\nICAgICAgUm93LkFDVElPTl9VUERBVEUsIHNtLCB0cnVlKTsKICAgICAgICBW\nYWx1ZU1hcHBpbmdJbmZvIHZpbmZvID0gZmllbGQuZ2V0RWxlbWVudE1hcHBp\nbmcoKS5nZXRWYWx1ZUluZm8oKTsKICAgICAgICBUYWJsZSB0YWJsZSA9IHZp\nbmZvLmdldFRhYmxlKHZhbCk7CiAgICAgICAgRm9yZWlnbktleSBqb2luRksg\nPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldEpvaW5Gb3JlaWduS2V5KGZp\nZWxkLCB0YWJsZSwgdHJ1ZSk7CiAgICAgICAgZGVsUm93LndoZXJlRm9yZWln\nbktleShqb2luRkssIHNtKTsKICAgICAgICBkZWxSb3cud2hlcmVGb3JlaWdu\nS2V5KGtleS5nZXRGb3JlaWduS2V5KCksIGtleXNtKTsKICAgICAgICB2YWwu\nc2V0Rm9yZWlnbktleShkZWxSb3csIG51bGwpOwogICAgICAgIGtleS5zZXRG\nb3JlaWduS2V5KGRlbFJvdywgbnVsbCk7CiAgICB9Cn0K\n","encoding":"base64"}

