{"sha":"7a536ca58f47b61763e4eec8d1e172cc32e099c8","node_id":"MDQ6QmxvYjIwNjM2NDo3YTUzNmNhNThmNDdiNjE3NjNlNGVlYzhkMWUxNzJjYzMyZTA5OWM4","size":45126,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/7a536ca58f47b61763e4eec8d1e172cc32e099c8","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkNvbGxlY3Rpb25zOwpp\nbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9ydCBqYXZhLnV0aWwuTGlz\ndDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CmltcG9ydCBqYXZhLnV0aWwuU2V0\nOwoKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNlLlBlcnNpc3Rl\nbmNlQ2FwYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5lbmhhbmNl\nLlJlZmxlY3RpbmdQZXJzaXN0ZW5jZUNhcGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5pZGVudGlmaWVyLkRCSWRlbnRpZmllcjsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtlcm5lbC5KREJDRmV0Y2hD\nb25maWd1cmF0aW9uOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMu\na2VybmVsLkpEQkNTdG9yZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5q\nZGJjLm1ldGEuQ2xhc3NNYXBwaW5nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMubWV0YS5FbWJlZGRhYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLmpkYmMubWV0YS5GaWVsZE1hcHBpbmc7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLkZpZWxkU3RyYXRlZ3k7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLkpvaW5hYmxlOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5NYXBwaW5nSW5mbzsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuVmFsdWVIYW5kbGVy\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5WYWx1ZU1h\ncHBpbmc7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZh\nbHVlTWFwcGluZ0ltcGw7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRi\nYy5tZXRhLlZhbHVlTWFwcGluZ0luZm87CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zY2hlbWEuQ29sdW1uOwppbXBvcnQgb3JnLmFwYWNoZS5v\ncGVuanBhLmpkYmMuc2NoZW1hLkNvbHVtbklPOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc2NoZW1hLkZvcmVpZ25LZXk7CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hlbWEuUHJpbWFyeUtleTsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNjaGVtYS5UYWJsZTsKaW1wb3J0\nIG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNxbC5EQkRpY3Rpb25hcnk7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuSm9pbnM7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuUmVzdWx0OwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc3FsLlJvdzsKaW1wb3J0IG9yZy5h\ncGFjaGUub3BlbmpwYS5qZGJjLnNxbC5Sb3dNYW5hZ2VyOwppbXBvcnQgb3Jn\nLmFwYWNoZS5vcGVuanBhLmpkYmMuc3FsLlNRTEJ1ZmZlcjsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLnNxbC5TZWxlY3Q7CmltcG9ydCBvcmcu\nYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuU2VsZWN0RXhlY3V0b3I7CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zcWwuVW5pb247CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEua2VybmVsLkxvY2tNYW5hZ2VyOwppbXBvcnQg\nb3JnLmFwYWNoZS5vcGVuanBhLmtlcm5lbC5PcGVuSlBBU3RhdGVNYW5hZ2Vy\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmxpYi5sb2cuTG9nOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmxpYi51dGlsLkxvY2FsaXplcjsKaW1w\nb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5tZXRhLkNsYXNzTWV0YURhdGE7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEubWV0YS5GaWVsZE1ldGFEYXRhOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLm1ldGEuSmF2YVR5cGVzOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuQXBwbGljYXRpb25JZHM7Cmlt\ncG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5JbXBsSGVscGVyOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuSW50ZXJuYWxFeGNlcHRpb247\nCmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5NZXRhRGF0YUV4Y2Vw\ndGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS51dGlsLk9iamVjdElk\nOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuT3BlbkpQQUlkOwpp\nbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLnV0aWwuVW5zdXBwb3J0ZWRFeGNl\ncHRpb247CgppbXBvcnQgc2VycC51dGlsLk51bWJlcnM7CgovKioKICogTWFw\ncGluZyBmb3IgYSBzaW5nbGUtdmFsdWVkIHJlbGF0aW9uIHRvIGFub3RoZXIg\nZW50aXR5LgogKgogKiBAYXV0aG9yIEFiZSBXaGl0ZQogKiBAc2luY2UgMC40\nLjAKICovCnB1YmxpYyBjbGFzcyBSZWxhdGlvbkZpZWxkU3RyYXRlZ3kKICAg\nIGV4dGVuZHMgQWJzdHJhY3RGaWVsZFN0cmF0ZWd5CiAgICBpbXBsZW1lbnRz\nIEpvaW5hYmxlLCBFbWJlZGRhYmxlIHsKCiAgICBwcml2YXRlIHN0YXRpYyBm\naW5hbCBMb2NhbGl6ZXIgX2xvYyA9IExvY2FsaXplci5mb3JQYWNrYWdlCiAg\nICAgICAgKFJlbGF0aW9uRmllbGRTdHJhdGVneS5jbGFzcyk7CgogICAgcHJp\ndmF0ZSBCb29sZWFuIF9ma09pZCA9IG51bGw7CiAgICAKICAgIHB1YmxpYyB2\nb2lkIG1hcChib29sZWFuIGFkYXB0KSB7CiAgICAgICAgaWYgKGZpZWxkLmdl\ndFR5cGVDb2RlKCkgIT0gSmF2YVR5cGVzLlBDIHx8IGZpZWxkLmlzRW1iZWRk\nZWRQQygpKQogICAgICAgICAgICB0aHJvdyBuZXcgTWV0YURhdGFFeGNlcHRp\nb24oX2xvYy5nZXQoIm5vdC1yZWxhdGlvbiIsIGZpZWxkKSk7CgogICAgICAg\nIGZpZWxkLmdldEtleU1hcHBpbmcoKS5nZXRWYWx1ZUluZm8oKS5hc3NlcnRO\nb1NjaGVtYUNvbXBvbmVudHMKICAgICAgICAgICAgKGZpZWxkLmdldEtleSgp\nLCAhYWRhcHQpOwogICAgICAgIGlmICghZmllbGQuaXNOb25EZWZhdWx0TWFw\ncGluZ1VzaW5nSm9pblRhYmxlU3RyYXRlZ3koKSkKICAgICAgICAgICAgZmll\nbGQuZ2V0RWxlbWVudE1hcHBpbmcoKS5nZXRWYWx1ZUluZm8oKS5hc3NlcnRO\nb1NjaGVtYUNvbXBvbmVudHMKICAgICAgICAgICAgICAgIChmaWVsZC5nZXRF\nbGVtZW50KCksICFhZGFwdCk7CiAgICAgICAgYm9vbGVhbiBjcml0ZXJpYSA9\nIGZpZWxkLmdldFZhbHVlSW5mbygpLmdldFVzZUNsYXNzQ3JpdGVyaWEoKTsK\nCiAgICAgICAgLy8gY2hlY2sgZm9yIG5hbWVkIGludmVyc2UKICAgICAgICBG\naWVsZE1hcHBpbmcgbWFwcGVkID0gZmllbGQuZ2V0TWFwcGVkQnlNYXBwaW5n\nKCk7CiAgICAgICAgaWYgKG1hcHBlZCAhPSBudWxsKSB7CiAgICAgICAgICAg\nIGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25l\nbnRzKGZpZWxkLCAhYWRhcHQpOwogICAgICAgICAgICBmaWVsZC5nZXRWYWx1\nZUluZm8oKS5hc3NlcnROb1NjaGVtYUNvbXBvbmVudHMoZmllbGQsICFhZGFw\ndCk7CiAgICAgICAgICAgIG1hcHBlZC5yZXNvbHZlKG1hcHBlZC5NT0RFX01F\nVEEgfCBtYXBwZWQuTU9ERV9NQVBQSU5HKTsKCiAgICAgICAgICAgIGlmICgh\nbWFwcGVkLmlzTWFwcGVkKCkgfHwgbWFwcGVkLmlzU2VyaWFsaXplZCgpKQog\nICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9s\nb2MuZ2V0KCJtYXBwZWQtYnktdW5tYXBwZWQiLAogICAgICAgICAgICAgICAg\nICAgIGZpZWxkLCBtYXBwZWQpKTsKCiAgICAgICAgICAgIGlmIChtYXBwZWQu\nZ2V0VHlwZUNvZGUoKSA9PSBKYXZhVHlwZXMuUEMpIHsKICAgICAgICAgICAg\nICAgIGlmIChtYXBwZWQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IG1hcHBlZC5K\nT0lOX0ZPUldBUkQpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZXRK\nb2luRGlyZWN0aW9uKGZpZWxkLkpPSU5fSU5WRVJTRSk7CiAgICAgICAgICAg\nICAgICAgICAgZmllbGQuc2V0Q29sdW1ucyhtYXBwZWQuZ2V0RGVmaW5pbmdN\nYXBwaW5nKCkuCiAgICAgICAgICAgICAgICAgICAgICAgIGdldFByaW1hcnlL\nZXlDb2x1bW5zKCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc1R5\ncGVVbmpvaW5lZFN1YmNsYXNzKG1hcHBlZCkpCiAgICAgICAgICAgICAgICAg\nICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0CiAgICAg\nICAgICAgICAgICAgICAgICAgICgibWFwcGVkLWludmVyc2UtdW5qb2luZWQi\nLCBmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAg\nICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgbWFwcGVkKSk7CgogICAg\nICAgICAgICAgICAgZmllbGQuc2V0Rm9yZWlnbktleShtYXBwZWQuZ2V0Rm9y\nZWlnbktleQogICAgICAgICAgICAgICAgICAgIChmaWVsZC5nZXREZWZpbmlu\nZ01hcHBpbmcoKSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1hcHBlZC5n\nZXRFbGVtZW50KCkuZ2V0VHlwZUNvZGUoKSA9PSBKYXZhVHlwZXMuUEMpIHsK\nICAgICAgICAgICAgICAgIGlmIChpc1R5cGVVbmpvaW5lZFN1YmNsYXNzKG1h\ncHBlZC5nZXRFbGVtZW50TWFwcGluZygpKSkKICAgICAgICAgICAgICAgICAg\nICB0aHJvdyBuZXcgTWV0YURhdGFFeGNlcHRpb24oX2xvYy5nZXQKICAgICAg\nICAgICAgICAgICAgICAgICAgKCJtYXBwZWQtaW52ZXJzZS11bmpvaW5lZCIs\nIGZpZWxkLmdldE5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAg\nIGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpLCBtYXBwZWQpKTsKCiAgICAg\nICAgICAgICAgICAvLyB3YXJuIHRoZSB1c2VyIGFib3V0IG1ha2luZyB0aGUg\nY29sbGVjdGlvbiBzaWRlIHRoZSBvd25lcgogICAgICAgICAgICAgICAgTG9n\nIGxvZyA9IGZpZWxkLmdldFJlcG9zaXRvcnkoKS5nZXRMb2coKTsKICAgICAg\nICAgICAgICAgIGlmIChsb2cuaXNJbmZvRW5hYmxlZCgpKQogICAgICAgICAg\nICAgICAgICAgIGxvZy5pbmZvKF9sb2MuZ2V0KCJjb2xsLW93bmVyIiwgZmll\nbGQsIG1hcHBlZCkpOwogICAgICAgICAgICAgICAgZmllbGQuc2V0Rm9yZWln\nbktleShtYXBwZWQuZ2V0RWxlbWVudE1hcHBpbmcoKS4KICAgICAgICAgICAg\nICAgICAgICBnZXRGb3JlaWduS2V5KCkpOwogICAgICAgICAgICB9IGVsc2UK\nICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2VwdGlvbihf\nbG9jLmdldCgibm90LWludi1yZWxhdGlvbiIsCiAgICAgICAgICAgICAgICAg\nICAgZmllbGQsIG1hcHBlZCkpOwoKICAgICAgICAgICAgZmllbGQuc2V0VXNl\nQ2xhc3NDcml0ZXJpYShjcml0ZXJpYSk7CiAgICAgICAgICAgIHJldHVybjsK\nICAgICAgICB9IAoKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2FyeSB0byBz\ndXBwb3J0IG9wZW5qcGEgMyBtYXBwaW5ncywgd2hpY2ggZGlkbid0CiAgICAg\nICAgLy8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIHNlY29uZGFyeSB0YWJsZSBq\nb2lucyBhbmQgcmVsYXRpb25zIGJ1aWx0CiAgICAgICAgLy8gYXJvdW5kIGFu\nIGludmVyc2Uga2V5OiBjaGVjayB0byBzZWUgaWYgd2UncmUgbWFwcGVkIGFz\nIGEgc2Vjb25kYXJ5CiAgICAgICAgLy8gdGFibGUgam9pbiBidXQgd2UncmUg\naW4gdGhlIHRhYmxlIG9mIHRoZSByZWxhdGVkIHR5cGUsIGFuZCBpZiBzbwog\nICAgICAgIC8vIHN3aXRjaCBvdXIgam9pbiBtYXBwaW5nIGluZm8gdG8gb3Vy\nIHZhbHVlIG1hcHBpbmcgaW5mbwogICAgICAgIERCSWRlbnRpZmllciB0YWJs\nZU5hbWUgPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldFRhYmxlSWRlbnRp\nZmllcigpOwogICAgICAgIFRhYmxlIHRhYmxlID0gZmllbGQuZ2V0VHlwZU1h\ncHBpbmcoKS5nZXRUYWJsZSgpOwogICAgICAgIFZhbHVlTWFwcGluZ0luZm8g\ndmluZm8gPSBmaWVsZC5nZXRWYWx1ZUluZm8oKTsKICAgICAgICBpZiAoIURC\nSWRlbnRpZmllci5pc051bGwodGFibGVOYW1lKSAmJiB0YWJsZSAhPSBudWxs\nCiAgICAgICAgICAgICYmICh0YWJsZU5hbWUuZXF1YWxzKHRhYmxlLmdldElk\nZW50aWZpZXIoKSkKICAgICAgICAgICAgfHwgdGFibGVOYW1lLmVxdWFscyh0\nYWJsZS5nZXRGdWxsSWRlbnRpZmllcigpKSkpIHsKICAgICAgICAgICAgdmlu\nZm8uc2V0Sm9pbkRpcmVjdGlvbihNYXBwaW5nSW5mby5KT0lOX0lOVkVSU0Up\nOwogICAgICAgICAgICB2aW5mby5zZXRDb2x1bW5zKGZpZWxkLmdldE1hcHBp\nbmdJbmZvKCkuZ2V0Q29sdW1ucygpKTsKICAgICAgICAgICAgZmllbGQuZ2V0\nTWFwcGluZ0luZm8oKS5zZXRUYWJsZUlkZW50aWZpZXIoREJJZGVudGlmaWVy\nLk5VTEwpOwogICAgICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLnNl\ndENvbHVtbnMobnVsbCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlm\nICghZmllbGQuaXNCaU1UbzFKVCgpKQogICAgICAgICAgICBmaWVsZC5tYXBK\nb2luKGFkYXB0LCBmYWxzZSk7CiAgICAgICAgaWYgKGZpZWxkLmdldFR5cGVN\nYXBwaW5nKCkuaXNNYXBwZWQoKSkgewogICAgICAgICAgICBpZiAoZmllbGQu\nZ2V0TWFwcGVkQnlJZFZhbHVlKCkgIT0gbnVsbCkgCiAgICAgICAgICAgICAg\nICBzZXRNYXBwZWRCeUlkQ29sdW1ucygpOyAgICAgICAgICAgIAogICAgICAg\nICAgICAgCiAgICAgICAgICAgIGlmICghZmllbGQuaXNCaU1UbzFKVCgpKSB7\nCiAgICAgICAgICAgICAgICBGb3JlaWduS2V5IGZrID0gdmluZm8uZ2V0VHlw\nZUpvaW4oZmllbGQsIGZpZWxkLmdldE5hbWUoKSwgdHJ1ZSwKICAgICAgICAg\nICAgICAgICAgICBhZGFwdCk7CiAgICAgICAgICAgICAgICBmaWVsZC5zZXRG\nb3JlaWduS2V5KGZrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaWVs\nZC5zZXRDb2x1bW5JTyh2aW5mby5nZXRDb2x1bW5JTygpKTsKICAgICAgICAg\nICAgaWYgKHZpbmZvLmdldEpvaW5EaXJlY3Rpb24oKSA9PSB2aW5mby5KT0lO\nX0lOVkVSU0UpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRKb2luRGlyZWN0\naW9uKGZpZWxkLkpPSU5fSU5WRVJTRSk7CiAgICAgICAgfSBlbHNlCiAgICAg\nICAgICAgIFJlbGF0aW9uU3RyYXRlZ2llcy5tYXBSZWxhdGlvblRvVW5tYXBw\nZWRQQyhmaWVsZCwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAg\nYWRhcHQpOwoKICAgICAgICBmaWVsZC5zZXRVc2VDbGFzc0NyaXRlcmlhKGNy\naXRlcmlhKTsKICAgICAgICBmaWVsZC5tYXBQcmltYXJ5S2V5KGFkYXB0KTsK\nICAgICAgICBQcmltYXJ5S2V5IHBrID0gZmllbGQuZ2V0VGFibGUoKS5nZXRQ\ncmltYXJ5S2V5KCk7CiAgICAgICAgaWYgKGZpZWxkLmlzUHJpbWFyeUtleSgp\nKSB7CiAgICAgICAgICAgIENvbHVtbltdIGNvbHMgPSBmaWVsZC5nZXRDb2x1\nbW5zKCk7CiAgICAgICAgICAgIGlmIChwayAhPSBudWxsICYmIChhZGFwdCB8\nfCBway5pc0xvZ2ljYWwoKSkpCiAgICAgICAgICAgICAgICBmb3IgKGludCBp\nID0gMDsgaSA8IGNvbHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAg\nICAgcGsuYWRkQ29sdW1uKGNvbHNbaV0pOwogICAgICAgICAgICBmb3IgKGlu\ndCBpID0gMDsgaSA8IGNvbHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAg\nICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKS5zZXRKb2luYWJsZShjb2xz\nW2ldLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIC8vIG1hcCBjb25zdHJh\naW50cyBhZnRlciBwayBzbyB3ZSBkb24ndCByZS1pbmRleCAvIHJlLXVuaXF1\nZSBwayBjb2wKICAgICAgICBmaWVsZC5tYXBDb25zdHJhaW50cyhmaWVsZC5n\nZXROYW1lKCksIGFkYXB0KTsKICAgIH0KCiAgICAvKioKICAgICAqIFdoZW4g\ndGhlcmUgaXMgTWFwcGVkQnlJZCBhbm5vdGF0aW9uLCB0aGUgb3duZXIgb2Yg\ndGhlIG9uZS10by1vbmUvCiAgICAgKiBtYW55LXRvLW9uZSByZWxhdGlvbnNo\naXAgd2lsbCB1c2UgaXRzIHByaW1hcnkga2V5IHRvIHJlcHJlc2VudCAKICAg\nICAqIGZvcmVpZ24ga2V5IHJlbGF0aW9uLiBObyBuZWVkIHRvIGNyZWF0ZSBh\nIHNlcGFyYXRlIGZvcmVpZ24ga2V5CiAgICAgKiBjb2x1bW4uIAogICAgICov\nCiAgICBwcml2YXRlIHZvaWQgc2V0TWFwcGVkQnlJZENvbHVtbnMoKSB7CiAg\nICAgICAgQ2xhc3NNZXRhRGF0YSBvd25lciA9IGZpZWxkLmdldERlZmluaW5n\nTWV0YURhdGEoKTsKICAgICAgICBGaWVsZE1ldGFEYXRhW10gcGtzID0gb3du\nZXIuZ2V0UHJpbWFyeUtleUZpZWxkcygpOwogICAgICAgIGZvciAoaW50IGkg\nPSAwOyBpIDwgcGtzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEZpZWxk\nTWFwcGluZyBmbSA9IChGaWVsZE1hcHBpbmcpIHBrc1tpXTsKICAgICAgICAg\nICAgVmFsdWVNYXBwaW5nSW1wbCB2YWwgPSAoVmFsdWVNYXBwaW5nSW1wbCkg\nZmllbGQuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgVmFsdWVNYXBwaW5nSW5m\nbyBpbmZvID0gdmFsLmdldFZhbHVlSW5mbygpOwogICAgICAgICAgICBpZiAo\naW5mby5nZXRDb2x1bW5zKCkuc2l6ZSgpID09IDApIAogICAgICAgICAgICAg\nICAgaW5mby5zZXRDb2x1bW5zKGdldE1hcHBlZEJ5SWRDb2x1bW5zKGZtKSk7\nCiAgICAgICAgfQogICAgfQoKICAgIHByaXZhdGUgTGlzdCBnZXRNYXBwZWRC\neUlkQ29sdW1ucyhGaWVsZE1hcHBpbmcgcGspIHsKICAgICAgICBDbGFzc01l\ndGFEYXRhIGVtYmVkZGVkSWQgPSAoKFZhbHVlTWFwcGluZ0ltcGwpcGsuZ2V0\nVmFsdWUoKSkuCiAgICAgICAgICAgIGdldEVtYmVkZGVkTWV0YURhdGEoKTsK\nICAgICAgICBDb2x1bW5bXSBwa0NvbHMgPSBudWxsOwogICAgICAgIExpc3Qg\nY29scyA9IG5ldyBBcnJheUxpc3QoKTsKICAgICAgICBTdHJpbmcgbWFwcGVk\nQnlJZFZhbHVlID0gZmllbGQuZ2V0TWFwcGVkQnlJZFZhbHVlKCk7CiAgICAg\nICAgaWYgKGVtYmVkZGVkSWQgIT0gbnVsbCkgewogICAgICAgICAgICBGaWVs\nZE1ldGFEYXRhW10gZm1kcyA9IGVtYmVkZGVkSWQuZ2V0RmllbGRzKCk7CiAg\nICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgZm1kcy5sZW5ndGg7IGkr\nKykgewogICAgICAgICAgICAgICAgaWYgKChmbWRzW2ldLmdldE5hbWUoKS5l\ncXVhbHMobWFwcGVkQnlJZFZhbHVlKSkgfHwKICAgICAgICAgICAgICAgICAg\nICBtYXBwZWRCeUlkVmFsdWUubGVuZ3RoKCkgPT0gMCkgewogICAgICAgICAg\nICAgICAgICAgIGlmIChmbWRzW2ldLmdldFZhbHVlKCkuZ2V0RW1iZWRkZWRN\nZXRhRGF0YSgpICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAg\nRW1iZWRWYWx1ZUhhbmRsZXIuZ2V0RW1iZWRkZWRJZENvbHMoCiAgICAgICAg\nICAgICAgICAgICAgICAgICAgICAgICAgKEZpZWxkTWFwcGluZylmbWRzW2ld\nLCBjb2xzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgCiAgICAgICAg\nICAgICAgICAgICAgICAgIEVtYmVkVmFsdWVIYW5kbGVyLmdldElkQ29sdW1u\ncygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoRmllbGRNYXBw\naW5nKWZtZHNbaV0sIGNvbHMpOwogICAgICAgICAgICAgICAgfQogICAgICAg\nICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb2xzOwogICAgICAgIH0gZWxz\nZSB7IC8vIHByaW1hcnkga2V5IGlzIHNpbmdsZS12YWx1ZQogICAgICAgICAg\nICBDbGFzcyBwa1R5cGUgPSBway5nZXREZWNsYXJlZFR5cGUoKTsKICAgICAg\nICAgICAgRmllbGRNZXRhRGF0YVtdIHBrcyA9IGZpZWxkLmdldFZhbHVlKCku\nZ2V0RGVjbGFyZWRUeXBlTWV0YURhdGEoKS4KICAgICAgICAgICAgICAgICAg\nICBnZXRQcmltYXJ5S2V5RmllbGRzKCk7CiAgICAgICAgICAgIGlmIChwa3Mu\nbGVuZ3RoICE9IDEgfHwgcGtzWzBdLmdldERlY2xhcmVkVHlwZSgpICE9IHBr\nVHlwZSkKICAgICAgICAgICAgICAgIHJldHVybiBDb2xsZWN0aW9ucy5FTVBU\nWV9MSVNUOwogICAgICAgICAgICBwa0NvbHMgPSBway5nZXRDb2x1bW5zKCk7\nCiAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgcGtDb2xzLmxlbmd0\naDsgaSsrKQogICAgICAgICAgICAgICAgY29scy5hZGQocGtDb2xzW2ldKTsK\nICAgICAgICAgICAgcmV0dXJuIGNvbHM7CiAgICAgICAgfQogICAgfQoKICAg\nIC8qKgogICAgICogUmV0dXJuIHdoZXRoZXIgb3VyIGRlZmluaW5nIG1hcHBp\nbmcgaXMgYW4gdW5qb2luZWQgc3ViY2xhc3Mgb2YKICAgICAqIHRoZSB0eXBl\nIG9mIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAqLwogICAgcHJpdmF0ZSBib29s\nZWFuIGlzVHlwZVVuam9pbmVkU3ViY2xhc3MoVmFsdWVNYXBwaW5nIG1hcHBl\nZCkgewogICAgICAgIENsYXNzTWFwcGluZyBkZWYgPSBmaWVsZC5nZXREZWZp\nbmluZ01hcHBpbmcoKTsKICAgICAgICBmb3IgKDsgZGVmICE9IG51bGw7IGRl\nZiA9IGRlZi5nZXRKb2luYWJsZVBDU3VwZXJjbGFzc01hcHBpbmcoKSkKICAg\nICAgICAgICAgaWYgKGRlZiA9PSBtYXBwZWQuZ2V0VHlwZU1hcHBpbmcoKSkK\nICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4g\ndHJ1ZTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbml0aWFsaXplKCkgewog\nICAgICAgIGZpZWxkLnNldFVzZXNJbnRlcm1lZGlhdGUodHJ1ZSk7CgogICAg\nICAgIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7CiAg\nICAgICAgaWYgKGZrID09IG51bGwpCiAgICAgICAgICAgIF9ma09pZCA9IEJv\nb2xlYW4uVFJVRTsKICAgICAgICBlbHNlIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgIT0gRmllbGRNYXBwaW5nLkpPSU5fSU5WRVJTRSkKICAgICAg\nICAgICAgX2ZrT2lkID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5pc0ZvcmVp\nZ25LZXlPYmplY3RJZChmayk7CiAgICB9CgogICAgcHVibGljIHZvaWQgaW5z\nZXJ0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwg\nUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxsKQogICAg\nICAgICAgICByZXR1cm47CgogICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFnZXIg\ncmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcgogICAg\nICAgICAgICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJbmRleCgp\nKSwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKICAgICAgICBpZiAoZmllbGQuZ2V0\nSm9pbkRpcmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAg\nICAgICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAg\nICAgIGVsc2UgewogICAgICAgICAgICBSb3cgcm93ID0gZmllbGQuZ2V0Um93\nKHNtLCBzdG9yZSwgcm0sIFJvdy5BQ1RJT05fSU5TRVJUKTsKICAgICAgICAg\nICAgaWYgKHJvdyAhPSBudWxsICYmICFmaWVsZC5pc0JpTVRvMUpUKCkpIHsK\nICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkocm93LCByZWwp\nOwogICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgYmktZGlyZWN0aW9u\nYWwgbWFwcywgdGhlIGtleSBhbmQgdmFsdWUgb2YgdGhlIAogICAgICAgICAg\nICAgICAgLy8gbWFwIGFyZSBzdG9yZWQgaW4gdGhlIHRhYmxlIG9mIHRoZSBt\nYXBwZWQtYnkgZW50aXR5ICAKICAgICAgICAgICAgICAgIHNldE1hcEtleShz\nbSwgcmVsLCBzdG9yZSwgcm93KTsKICAgICAgICAgICAgfQogICAgICAgIH0K\nICAgIH0KICAgIAogICAgcHJpdmF0ZSB2b2lkIHNldE1hcEtleShPcGVuSlBB\nU3RhdGVNYW5hZ2VyIHNtLCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHJlbCwgCiAg\nICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBSb3cgcm93KSB0aHJvd3MgU1FMRXhj\nZXB0aW9uIHsKICAgICAgICBpZiAocmVsID09IG51bGwpCiAgICAgICAgICAg\nIHJldHVybjsKICAgICAgICBDbGFzc01ldGFEYXRhIG1ldGEgPSByZWwuZ2V0\nTWV0YURhdGEoKTsKICAgICAgICBGaWVsZE1hcHBpbmcgbWFwRmllbGQgPSBn\nZXRNYXBGaWVsZChtZXRhKTsKICAgICAgICAKICAgICAgICAvLyB0aGVyZSBp\ncyBubyBiaS1kaXJlY3Rpb25hbCBtYXAgZmllbGQKICAgICAgICBpZiAobWFw\nRmllbGQgPT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIAog\nICAgICAgIE1hcCBtYXBPYmogPSAoTWFwKXJlbC5mZXRjaE9iamVjdEZpZWxk\nKG1hcEZpZWxkLmdldEluZGV4KCkpOwogICAgICAgIE9iamVjdCBrZXlPYmog\nPSBnZXRNYXBLZXlPYmoobWFwT2JqLCBzbS5nZXRQZXJzaXN0ZW5jZUNhcGFi\nbGUoKSk7CiAgICAgICAgVmFsdWVNYXBwaW5nIGtleSA9IG1hcEZpZWxkLmdl\ndEtleU1hcHBpbmcoKTsKICAgICAgICBpZiAoIWtleS5pc0VtYmVkZGVkKCkp\nIHsKICAgICAgICAgICAgaWYgKGtleU9iaiBpbnN0YW5jZW9mIFBlcnNpc3Rl\nbmNlQ2FwYWJsZSkgewogICAgICAgICAgICAgICAgT3BlbkpQQVN0YXRlTWFu\nYWdlciBrZXlTbSA9IFJlbGF0aW9uU3RyYXRlZ2llcy4KICAgICAgICAgICAg\nICAgICAgICBnZXRTdGF0ZU1hbmFnZXIoa2V5T2JqLCBzdG9yZS5nZXRDb250\nZXh0KCkpOwogICAgICAgICAgICAgICAgLy8ga2V5IGlzIGFuIGVudGl0eQog\nICAgICAgICAgICAgICAgRm9yZWlnbktleSBmayA9IG1hcEZpZWxkLmdldEtl\neU1hcHBpbmcoKS4KICAgICAgICAgICAgICAgICAgICBnZXRGb3JlaWduS2V5\nKCk7CiAgICAgICAgICAgICAgICBDb2x1bW5JTyBpbyA9IG5ldyBDb2x1bW5J\nTygpOwogICAgICAgICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIGlv\nLCBrZXlTbSk7CiAgICAgICAgICAgIH0gCiAgICAgICAgfSBlbHNlIHsKICAg\nICAgICAgICAgLy8ga2V5IGlzIGFuIGVtYmVkZGFibGUgb3IgYmFzaWMgdHlw\nZQogICAgICAgICAgICBGaWVsZFN0cmF0ZWd5IHN0cmF0ZWd5ID0gbWFwRmll\nbGQuZ2V0U3RyYXRlZ3koKTsgCiAgICAgICAgICAgIGlmIChzdHJhdGVneSBp\nbnN0YW5jZW9mICAKICAgICAgICAgICAgICAgICAgICBIYW5kbGVyUmVsYXRp\nb25NYXBUYWJsZUZpZWxkU3RyYXRlZ3kpIHsKICAgICAgICAgICAgICAgIEhh\nbmRsZXJSZWxhdGlvbk1hcFRhYmxlRmllbGRTdHJhdGVneSBzdHJhdCA9IAog\nICAgICAgICAgICAgICAgICAgIChIYW5kbGVyUmVsYXRpb25NYXBUYWJsZUZp\nZWxkU3RyYXRlZ3kpIHN0cmF0ZWd5OwogICAgICAgICAgICAgICAgQ29sdW1u\nW10ga2NvbHMgPSBzdHJhdC5nZXRLZXlDb2x1bW5zKChDbGFzc01hcHBpbmcp\nbWV0YSk7CiAgICAgICAgICAgICAgICBDb2x1bW5JTyBraW8gPSBzdHJhdC5n\nZXRLZXlDb2x1bW5JTygpOwogICAgICAgICAgICAgICAgSGFuZGxlclN0cmF0\nZWdpZXMuc2V0KGtleSwga2V5T2JqLCBzdG9yZSwgcm93LCBrY29scywKICAg\nICAgICAgICAgICAgICAgICAgICAga2lvLCB0cnVlKTsKICAgICAgICAgICAg\nfQogICAgICAgIH0gCiAgICB9CiAgICAKICAgIHByaXZhdGUgRmllbGRNYXBw\naW5nIGdldE1hcEZpZWxkKENsYXNzTWV0YURhdGEgbWV0YSkgewogICAgICAg\nIEZpZWxkTWFwcGluZ1tdIGZpZWxkcyA9ICgoQ2xhc3NNYXBwaW5nKW1ldGEp\nLmdldEZpZWxkTWFwcGluZ3MoKTsKICAgICAgICBmb3IgKGludCBpID0gMDsg\naSA8IGZpZWxkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBGaWVsZE1l\ndGFEYXRhIG1hcHBlZEJ5ID0gZmllbGRzW2ldLmdldE1hcHBlZEJ5TWV0YURh\ndGEoKTsKICAgICAgICAgICAgaWYgKGZpZWxkc1tpXS5nZXREZWNsYXJlZFR5\ncGVDb2RlKCkgPT0gSmF2YVR5cGVzLk1BUCAmJgogICAgICAgICAgICAgICAg\nbWFwcGVkQnkgPT0gZmllbGQpICAKICAgICAgICAgICAgICAgIHJldHVybiBm\naWVsZHNbaV07CiAgICAgICAgfSAKICAgICAgICByZXR1cm4gbnVsbDsgICAg\nCiAgICB9CiAgICAKICAgIHByaXZhdGUgT2JqZWN0IGdldE1hcEtleU9iaihN\nYXAgbWFwT2JqLCBPYmplY3QgdmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUg\naW5zdGFuY2VvZiBSZWZsZWN0aW5nUGVyc2lzdGVuY2VDYXBhYmxlKQogICAg\nICAgICAgICB2YWx1ZSA9ICgoUmVmbGVjdGluZ1BlcnNpc3RlbmNlQ2FwYWJs\nZSl2YWx1ZSkuZ2V0TWFuYWdlZEluc3RhbmNlKCk7IAogICAgICAgIFNldCBr\nZXlTZXQgPSBtYXBPYmoua2V5U2V0KCk7CiAgICAgICAgZm9yIChPYmplY3Qg\na2V5IDoga2V5U2V0KSB7CiAgICAgICAgICAgIGlmIChtYXBPYmouZ2V0KGtl\neSkgPT0gdmFsdWUpCiAgICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAg\nICAgIH0KICAgICAgICBTZXQ8TWFwLkVudHJ5PiBlbnRyaWVzID0gbWFwT2Jq\nLmVudHJ5U2V0KCk7CiAgICAgICAgZm9yIChNYXAuRW50cnkgZW50cnkgOiBl\nbnRyaWVzKSB7CiAgICAgICAgICAgIGlmIChlbnRyeS5nZXRWYWx1ZSgpID09\nIHZhbHVlKQogICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5LmdldEtleSgp\nOwogICAgICAgIH0KICAgICAKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0K\nCiAgICBwdWJsaWMgdm9pZCB1cGRhdGUoT3BlbkpQQVN0YXRlTWFuYWdlciBz\nbSwgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRo\ncm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChmaWVsZC5nZXRNYXBw\nZWRCeSgpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAg\nT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBSZWxhdGlvblN0cmF0ZWdpZXMu\nZ2V0U3RhdGVNYW5hZ2VyCiAgICAgICAgICAgIChzbS5mZXRjaE9iamVjdEZp\nZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9yZS5nZXRDb250ZXh0KCkpOwoK\nICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRSkgewogICAgICAgICAgICBudWxsSW52ZXJzZShzbSwg\ncm0pOwogICAgICAgICAgICB1cGRhdGVJbnZlcnNlKHNtLCByZWwsIHN0b3Jl\nLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW50IGFjdGlv\nbiA9IChyZWwgPT0gbnVsbCAmJiAKICAgICAgICAgICAgICAgICAgICBmaWVs\nZC5pc0JpZGlyZWN0aW9uYWxKb2luVGFibGVNYXBwaW5nTm9uT3duZXIoKSkg\nPwogICAgICAgICAgICAgICAgICAgIFJvdy5BQ1RJT05fREVMRVRFIDogUm93\nLkFDVElPTl9VUERBVEU7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5n\nZXRSb3coc20sIHN0b3JlLCBybSwgYWN0aW9uKTsKICAgICAgICAgICAgaWYg\nKHJvdyAhPSBudWxsICYmICFmaWVsZC5pc0JpTVRvMUpUKCkpIHsKICAgICAg\nICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkocm93LCByZWwpOwogICAg\nICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgYmktZGlyZWN0aW9uYWwgbWFw\ncywgdGhlIGtleSBhbmQgdmFsdWUgb2YgdGhlIAogICAgICAgICAgICAgICAg\nLy8gbWFwIGFyZSBzdG9yZWQgaW4gdGhlIHRhYmxlIG9mIHRoZSBtYXBwZWQt\nYnkgZW50aXR5ICAKICAgICAgICAgICAgICAgIHNldE1hcEtleShzbSwgcmVs\nLCBzdG9yZSwgcm93KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAg\nICAgICAgICAgaWYgKGZpZWxkLmlzQmlNVG8xSlQoKSkgeyAvLyBhbHNvIG5l\nZWQgdG8gdXBkYXRlIHRoZSBqb2luIHRhYmxlCiAgICAgICAgICAgICAgICBQ\nZXJzaXN0ZW5jZUNhcGFibGUgaW52UEMgPSAoUGVyc2lzdGVuY2VDYXBhYmxl\nKXNtLmZldGNoT2JqZWN0KAogICAgICAgICAgICAgICAgICAgIGZpZWxkLmdl\ndEJpXzFUb01fSlRGaWVsZCgpLmdldEluZGV4KCkpOwogICAgICAgICAgICAg\nICAgUm93IHNlY29uZGFyeVJvdyA9IG51bGw7CiAgICAgICAgICAgICAgICBp\nZiAoaW52UEMgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHNlY29u\nZGFyeVJvdyA9IHJtLmdldFNlY29uZGFyeVJvdyhmaWVsZC5nZXRCaTFUb01K\nb2luRksoKS5nZXRUYWJsZSgpLAogICAgICAgICAgICAgICAgICAgICAgICBS\nb3cuQUNUSU9OX0lOU0VSVCk7CiAgICAgICAgICAgICAgICAgICAgc2Vjb25k\nYXJ5Um93LnNldEZvcmVpZ25LZXkoZmllbGQuZ2V0QmkxVG9NRWxlbUZLKCks\nIG51bGwsIHNtKTsKICAgICAgICAgICAgICAgICAgICBzZWNvbmRhcnlSb3cu\nc2V0Rm9yZWlnbktleShmaWVsZC5nZXRCaTFUb01Kb2luRksoKSwgbnVsbCwg\nCiAgICAgICAgICAgICAgICAgICAgICAgIFJlbGF0aW9uU3RyYXRlZ2llcy5n\nZXRTdGF0ZU1hbmFnZXIoaW52UEMsCiAgICAgICAgICAgICAgICAgICAgICAg\nIHN0b3JlLmdldENvbnRleHQoKSkpOwogICAgICAgICAgICAgICAgICAgIHJt\nLmZsdXNoU2Vjb25kYXJ5Um93KHNlY29uZGFyeVJvdyk7CiAgICAgICAgICAg\nICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgZGVsZXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNT\ndG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAh\nPSBudWxsKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7\nCiAgICAgICAgICAgIGlmIChzbS5nZXRMb2FkZWQoKS5nZXQoZmllbGQuZ2V0\nSW5kZXgoKSkpIHsKICAgICAgICAgICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFn\nZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihz\nbS4KICAgICAgICAgICAgICAgICAgICBmZXRjaE9iamVjdEZpZWxkKGZpZWxk\nLmdldEluZGV4KCkpLCBzdG9yZS5nZXRDb250ZXh0KCkpOwogICAgICAgICAg\nICAgICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAg\nICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG51bGxJbnZlcnNlKHNt\nLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmllbGQuZGVs\nZXRlUm93KHNtLCBzdG9yZSwgcm0pOwoKICAgICAgICAgICAgLy8gaWYgb3Vy\nIGZvcmVpZ24ga2V5IGhhcyBhIGRlbGV0ZSBhY3Rpb24sIHdlIG5lZWQgdG8g\nc2V0IHRoZQogICAgICAgICAgICAvLyByZWxhdGVkIG9iamVjdCBzbyBjb25z\ndHJhaW50cyBjYW4gYmUgZXZhbHVhdGVkCiAgICAgICAgICAgIE9wZW5KUEFT\ndGF0ZU1hbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRl\nTWFuYWdlcgogICAgICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0RmllbGQo\nZmllbGQuZ2V0SW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAg\nICAgICAgIGlmIChyZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKENsYXNzTWFwcGlu\nZykKICAgICAgICAgICAgICAgICAgICByZWwuZ2V0TWV0YURhdGEoKSk7CiAg\nICAgICAgICAgICAgICBpZiAoZmsuZ2V0RGVsZXRlQWN0aW9uKCkgPT0gRm9y\nZWlnbktleS5BQ1RJT05fUkVTVFJJQ1QgfHwKICAgICAgICAgICAgICAgICAg\nICBmay5nZXREZWxldGVBY3Rpb24oKSA9PSBGb3JlaWduS2V5LkFDVElPTl9D\nQVNDQURFKSB7CiAgICAgICAgICAgICAgICAgICAgUm93IHJvdyA9IGZpZWxk\nLmdldFJvdyhzbSwgc3RvcmUsIHJtLCBSb3cuQUNUSU9OX0RFTEVURSk7CiAg\nICAgICAgICAgICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIG51bGws\nIHJlbCk7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyBpcyBmb3IgYmkt\nZGlyZWN0aW9uYWwgbWFwcywgdGhlIGtleSBhbmQgdmFsdWUgb2YgdGhlCiAg\nICAgICAgICAgICAgICAgICAgLy8gbWFwIGFyZSBzdG9yZWQgaW4gdGhlIHRh\nYmxlIG9mIHRoZSBtYXBwZWQtYnkgZW50aXR5ICAKICAgICAgICAgICAgICAg\nICAgICBzZXRNYXBLZXkoc20sIHJlbCwgc3RvcmUsIHJvdyk7CiAgICAgICAg\nICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAg\nLyoqCiAgICAgKiBOdWxsIGludmVyc2UgcmVsYXRpb25zIHRoYXQgcmVmZXJl\nbmNlIHRoZSBnaXZlbiBvYmplY3QuCiAgICAgKi8KICAgIHByaXZhdGUgdm9p\nZCBudWxsSW52ZXJzZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBSb3dNYW5h\nZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAg\nIGlmIChmaWVsZC5nZXRVc2VDbGFzc0NyaXRlcmlhKCkpCiAgICAgICAgICAg\nIHJldHVybjsKCiAgICAgICAgRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZv\ncmVpZ25LZXkoKTsKICAgICAgICBDb2x1bW5JTyBpbyA9IGZpZWxkLmdldENv\nbHVtbklPKCk7CiAgICAgICAgaWYgKCFpby5pc0FueVVwZGF0YWJsZShmaywg\ndHJ1ZSkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgLy8gbnVsbCBp\nbnZlcnNlIGlmIG5vdCBhbHJlYWR5IGVuZm9yY2VkIGJ5IGZrCiAgICAgICAg\naWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCkubGVuZ3Ro\nICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0aW9uU3RyYXRlZ2llcy51\nbmludmVyc2FibGUoZmllbGQpOwogICAgICAgIFJvdyByb3cgPSBybS5nZXRB\nbGxSb3dzKGZrLmdldFRhYmxlKCksIFJvdy5BQ1RJT05fVVBEQVRFKTsKICAg\nICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgaW8sIG51bGwpOwogICAgICAg\nIHJvdy53aGVyZUZvcmVpZ25LZXkoZmssIHNtKTsKICAgICAgICBybS5mbHVz\naEFsbFJvd3Mocm93KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0\naG9kIHVwZGF0ZXMgdGhlIGludmVyc2UgY29sdW1ucyBvZiBvdXIgcmVsYXRp\nb24KICAgICAqIHdpdGggdGhlIGdpdmVuIG9iamVjdC4KICAgICAqLwogICAg\ncHJpdmF0ZSB2b2lkIHVwZGF0ZUludmVyc2UoT3BlbkpQQVN0YXRlTWFuYWdl\nciBzbSwgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwsCiAgICAgICAgSkRCQ1N0\nb3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxF\neGNlcHRpb24gewogICAgICAgIGlmIChyZWwgPT0gbnVsbCkKICAgICAgICAg\nICAgcmV0dXJuOwoKICAgICAgICBGb3JlaWduS2V5IGZrID0gZmllbGQuZ2V0\nRm9yZWlnbktleSgpOwogICAgICAgIENvbHVtbklPIGlvID0gZmllbGQuZ2V0\nQ29sdW1uSU8oKTsKCiAgICAgICAgaW50IGFjdGlvbjsKICAgICAgICBpZiAo\ncmVsLmlzTmV3KCkgJiYgIXJlbC5pc0ZsdXNoZWQoKSkgewogICAgICAgICAg\nICBpZiAoc20uaXNEZWxldGVkKCkgfHwgIWlvLmlzQW55SW5zZXJ0YWJsZShm\naywgZmFsc2UpKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAg\nICBhY3Rpb24gPSBSb3cuQUNUSU9OX0lOU0VSVDsKICAgICAgICB9IGVsc2Ug\naWYgKHJlbC5pc0RlbGV0ZWQoKSkgewogICAgICAgICAgICBpZiAocmVsLmlz\nRmx1c2hlZCgpIHx8ICFzbS5pc0RlbGV0ZWQoKSkKICAgICAgICAgICAgICAg\nIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0gUm93LkFDVElPTl9ERUxF\nVEU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNtLmlzRGVs\nZXRlZCgpKQogICAgICAgICAgICAgICAgc20gPSBudWxsOwogICAgICAgICAg\nICBpZiAoIWlvLmlzQW55VXBkYXRhYmxlKGZrLCBzbSA9PSBudWxsKSkKICAg\nICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0gUm93\nLkFDVElPTl9VUERBVEU7CiAgICAgICAgfQoKICAgICAgICBpZiAoZmllbGQu\nZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5ndGggIT0gMSkKICAg\nICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVuaW52ZXJzYWJs\nZShmaWVsZCk7CgogICAgICAgIC8vIGdldCB0aGUgcm93IGZvciB0aGUgaW52\nZXJzZSBvYmplY3Q7IHRoZSByb3cgbWlnaHQgYmUgaW4gYSBzZWNvbmRhcnkK\nICAgICAgICAvLyB0YWJsZSBpZiB0aGVyZSBpcyBhIGZpZWxkIGNvbnRyb2xs\naW5nIHRoZSBmb3JlaWduIGtleQogICAgICAgIFJvdyByb3cgPSBudWxsOwog\nICAgICAgIEZpZWxkTWFwcGluZ1tdIGludnMgPSBmaWVsZC5nZXRJbnZlcnNl\nTWFwcGluZ3MoKTsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGludnMu\nbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGludnNbaV0uZ2V0TWFw\ncGVkQnlNZXRhRGF0YSgpID09IGZpZWxkCiAgICAgICAgICAgICAgICAmJiBp\nbnZzW2ldLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAg\nICAgICAgICAgICByb3cgPSBpbnZzW2ldLmdldFJvdyhyZWwsIHN0b3JlLCBy\nbSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAg\nICB9CiAgICAgICAgfQogICAgICAgIENsYXNzTWFwcGluZyByZWxNYXBwaW5n\nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAgICBpZiAocm93ID09\nIG51bGwpCiAgICAgICAgICAgIHJvdyA9IHJtLmdldFJvdyhyZWxNYXBwaW5n\nLmdldFRhYmxlKCksIGFjdGlvbiwgcmVsLCB0cnVlKTsKCiAgICAgICAgLy8g\naWYgdGhpcyBpcyBhbiB1cGRhdGUsIHRoaXMgbWlnaHQgYmUgdGhlIG9ubHkg\nbW9kIHRvIHRoZSByb3csIHNvCiAgICAgICAgLy8gbWFrZSBzdXJlIHRoZSB3\naGVyZSBjb25kaXRpb24gaXMgc2V0CiAgICAgICAgaWYgKGFjdGlvbiA9PSBS\nb3cuQUNUSU9OX1VQREFURQogICAgICAgICAgICAmJiByb3cuZ2V0VGFibGUo\nKSA9PSByZWxNYXBwaW5nLmdldFRhYmxlKCkpCiAgICAgICAgICAgIHJvdy53\naGVyZVByaW1hcnlLZXkocmVsKTsKCiAgICAgICAgLy8gdXBkYXRlIHRoZSBp\nbnZlcnNlIHBvaW50ZXIgd2l0aCBvdXIgb2lkIHZhbHVlCiAgICAgICAgcm93\nLnNldEZvcmVpZ25LZXkoZmssIGlvLCBzbSk7CiAgICB9CgogICAgcHVibGlj\nIGludCBzdXBwb3J0c1NlbGVjdChTZWxlY3Qgc2VsLCBpbnQgdHlwZSwgT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwKICAgICAgICBKREJDU3RvcmUgc3RvcmUs\nIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gpIHsKICAgICAgICBpZiAo\ndHlwZSA9PSBTZWxlY3QuVFlQRV9KT0lOTEVTUykKICAgICAgICAgICAgcmV0\ndXJuIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9J\nTlZFUlNFCiAgICAgICAgICAgICAgICAmJiBzZWwuaXNTZWxlY3RlZChmaWVs\nZC5nZXRUYWJsZSgpKSkgPyAxIDogMDsKICAgICAgICBpZiAodHlwZSA9PSBT\nZWxlY3QuVFlQRV9UV09fUEFSVCkKICAgICAgICAgICAgcmV0dXJuIDE7Cgog\nICAgICAgIC8vIGFscmVhZHkgY2FjaGVkPwogICAgICAgIGlmIChzbSAhPSBu\ndWxsKSB7CiAgICAgICAgICAgIE9iamVjdCBvaWQgPSBzbS5nZXRJbnRlcm1l\nZGlhdGUoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAgICAgICAgIGlmIChzdG9y\nZS5nZXRDb250ZXh0KCkuZmluZENhY2hlZChvaWQsIG51bGwpICE9IG51bGwp\nCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAg\nIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5\ncGVNYXBwaW5ncygpOwogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAg\nICAgICBjYXNlIFNlbGVjdC5FQUdFUl9QQVJBTExFTDoKICAgICAgICAgICAg\nICAgIHJldHVybiBjbHNzLmxlbmd0aDsKICAgICAgICAgICAgY2FzZSBTZWxl\nY3QuRUFHRVJfT1VURVI6CiAgICAgICAgICAgICAgICByZXR1cm4gKGNsc3Mu\nbGVuZ3RoID09IDEgJiYgc3RvcmUuZ2V0REJEaWN0aW9uYXJ5KCkuY2FuT3V0\nZXJKb2luCiAgICAgICAgICAgICAgICAgICAgKHNlbC5nZXRKb2luU3ludGF4\nKCksIGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzc1swXSkpKSA/IDEgOgogICAg\nICAgICAgICAgICAgICAgIDA7CiAgICAgICAgICAgIGNhc2UgU2VsZWN0LkVB\nR0VSX0lOTkVSOgogICAgICAgICAgICAgICAgcmV0dXJuIChjbHNzLmxlbmd0\naCA9PSAxKSA/IDEgOiAwOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAg\nICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgfQoKICAgIHB1Ymxp\nYyB2b2lkIHNlbGVjdEVhZ2VyUGFyYWxsZWwoU2VsZWN0RXhlY3V0b3Igc2Vs\nLAogICAgICAgIGZpbmFsIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIGZpbmFs\nIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBmaW5hbCBKREJDRmV0Y2hDb25m\naWd1cmF0aW9uIGZldGNoLCBmaW5hbCBpbnQgZWFnZXJNb2RlKSB7CiAgICAg\nICAgZmluYWwgQ2xhc3NNYXBwaW5nW10gY2xzcyA9IGZpZWxkLmdldEluZGVw\nZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAgaWYgKCEoc2VsIGluc3Rh\nbmNlb2YgVW5pb24pKQogICAgICAgICAgICBzZWxlY3RFYWdlclBhcmFsbGVs\nKChTZWxlY3QpIHNlbCwgY2xzc1swXSwgc3RvcmUsIGZldGNoLCBlYWdlck1v\nZGUpOwogICAgICAgIGVsc2UgewogICAgICAgICAgICBVbmlvbiB1bmlvbiA9\nIChVbmlvbikgc2VsOwogICAgICAgICAgICBpZiAoZmV0Y2guZ2V0U3ViY2xh\nc3NGZXRjaE1vZGUgKGZpZWxkLmdldFR5cGVNYXBwaW5nKCkpIAogICAgICAg\nICAgICAgICAgIT0gSkRCQ0ZldGNoQ29uZmlndXJhdGlvbi5FQUdFUl9KT0lO\nKQogICAgICAgICAgICAgICAgdW5pb24uYWJvcnRVbmlvbigpOwogICAgICAg\nICAgICB1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkgewogICAg\nICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0KFNlbGVjdCBzZWwsIGlu\ndCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RFYWdlclBhcmFs\nbGVsKHNlbCwgY2xzc1tpZHhdLCBzdG9yZSwgZmV0Y2gsCiAgICAgICAgICAg\nICAgICAgICAgICAgIGVhZ2VyTW9kZSk7CiAgICAgICAgICAgICAgICB9CiAg\nICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAq\nIFBlcmZvcm0gYW4gZWFnZXIgcGFyYWxsZWwgc2VsZWN0LgogICAgICovCiAg\nICBwcml2YXRlIHZvaWQgc2VsZWN0RWFnZXJQYXJhbGxlbChTZWxlY3Qgc2Vs\nLCBDbGFzc01hcHBpbmcgY2xzLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwg\nSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwgaW50IGVhZ2VyTW9kZSkg\newogICAgICAgIGlmIChmaWVsZC5pc0JpTVRvMUpUKCkpCiAgICAgICAgICAg\nIHJldHVybjsKICAgICAgICBzZWwuc2VsZWN0UHJpbWFyeUtleShmaWVsZC5n\nZXREZWZpbmluZ01hcHBpbmcoKSk7CiAgICAgICAgLy8gc2V0IGEgdmFyaWFi\nbGUgbmFtZSB0aGF0IGRvZXMgbm90IGNvbmZsaWN0IHdpdGggYW55IGluIHRo\nZSBxdWVyeTsKICAgICAgICAvLyB1c2luZyBhIHZhcmlhYmxlIGd1YXJhbnRl\nZXMgdGhhdCB0aGUgc2VsZWN0ZWQgZGF0YSB3aWxsIHVzZSBkaWZmZXJlbnQK\nICAgICAgICAvLyBhbGlhc2VzIGFuZCBqb2lucyB0aGFuIGFueSBleGlzdGlu\nZyBXSEVSRSBjb25kaXRpb25zIG9uIHRoaXMgZmllbGQKICAgICAgICAvLyB0\naGF0IG1pZ2h0IG90aGVyd2lzZSBsaW1pdCB0aGUgcmVsYXRpb25zIHRoYXQg\nbWF0Y2gKICAgICAgICBKb2lucyBqb2lucyA9IHNlbC5uZXdKb2lucygpLnNl\ndFZhcmlhYmxlKCIqIik7CiAgICAgICAgZWFnZXJKb2luKGpvaW5zLCBjbHMs\nIHRydWUpOwogICAgICAgIHNlbC5zZWxlY3QoY2xzLCBmaWVsZC5nZXRTZWxl\nY3RTdWJjbGFzc2VzKCksIHN0b3JlLCBmZXRjaCwgZWFnZXJNb2RlLCAKICAg\nICAgICAgICAgam9pbnMpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIHNlbGVj\ndEVhZ2VySm9pbihTZWxlY3Qgc2VsLCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNt\nLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29uZmlndXJh\ndGlvbiBmZXRjaCwgaW50IGVhZ2VyTW9kZSkgewogICAgICAgIGlmIChmaWVs\nZC5pc0JpTVRvMUpUKCkpIAogICAgICAgICAgICByZXR1cm47CgogICAgICAg\nIC8vIGxpbWl0IHRoZSBlYWdlciBtb2RlIHRvIHNpbmdsZSBvbiByZWN1cnNp\ndmUgZWFnZXIgZmV0Y2hpbmcgYi9jCiAgICAgICAgLy8gYXQgdGhpcyBwb2lu\ndCB0aGUgc2VsZWN0IGhhcyBiZWVuIG1vZGlmaWVkIGFuZCBhbiBhdHRlbXB0\nIHRvCiAgICAgICAgLy8gY2xvbmUgaXQgZm9yIGEgdG8tbWFueSBlYWdlciBz\nZWxlY3QgY2FuIHJlc3VsdCBpbiBhIGNsb25lIHRoYXQKICAgICAgICAvLyBw\ncm9kdWNlcyBpbnZhbGlkIFNRTAogICAgICAgIENsYXNzTWFwcGluZyBjbHMg\nPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpWzBdOwogICAg\nICAgIGJvb2xlYW4gZm9yY2VJbm5lciA9IGZldGNoLmhhc0ZldGNoSW5uZXJK\nb2luKGZpZWxkLmdldEZ1bGxOYW1lKGZhbHNlKSkgPwogICAgICAgICAgICAg\nICAgdHJ1ZSA6IGZhbHNlOwogICAgICAgIHNlbC5zZWxlY3QoY2xzLCBmaWVs\nZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIHN0b3JlLCBmZXRjaCwKICAgICAg\nICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbi5FQUdFUl9KT0lOLAogICAg\nICAgICAgICBlYWdlckpvaW4oc2VsLm5ld0pvaW5zKCksIGNscywgZm9yY2VJ\nbm5lcikpOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIHRoZSBqb2lucyBu\nZWVkZWQgdG8gc2VsZWN0L2xvYWQgZWFnZXIgZGF0YS4KICAgICAqLwogICAg\ncHJpdmF0ZSBKb2lucyBlYWdlckpvaW4oSm9pbnMgam9pbnMsIENsYXNzTWFw\ncGluZyBjbHMsIGJvb2xlYW4gZm9yY2VJbm5lcikgewogICAgICAgIGJvb2xl\nYW4gaW52ZXJzZSA9IGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVs\nZC5KT0lOX0lOVkVSU0U7CiAgICAgICAgaWYgKCFpbnZlcnNlKSB7CiAgICAg\nICAgICAgIGpvaW5zID0gam9pbihqb2lucywgZmFsc2UpOwogICAgICAgICAg\nICBqb2lucyA9IHNldEVtYmVkZGVkVmFyaWFibGUoam9pbnMpOwogICAgICAg\nIH0KCiAgICAgICAgLy8gYW5kIGpvaW4gaW50byByZWxhdGlvbgogICAgICAg\nIEZvcmVpZ25LZXkgZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KGNscyk7CiAg\nICAgICAgaWYgKCFmb3JjZUlubmVyICYmIGZpZWxkLmdldE51bGxWYWx1ZSgp\nICE9IEZpZWxkTWFwcGluZy5OVUxMX0VYQ0VQVElPTikKICAgICAgICAgICAg\ncmV0dXJuIGpvaW5zLm91dGVySm9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUo\nKSwgZmssIGZpZWxkLgogICAgICAgICAgICAgICAgZ2V0VHlwZU1hcHBpbmco\nKSwgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBpbnZlcnNlLCBmYWxz\nZSk7CiAgICAgICAgcmV0dXJuIGpvaW5zLmpvaW5SZWxhdGlvbihmaWVsZC5n\nZXROYW1lKCksIGZrLCBmaWVsZC5nZXRUeXBlTWFwcGluZygpLCAKICAgICAg\nICAgICAgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBpbnZlcnNlLCBm\nYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBJZiBqb2luaW5nIGZyb20g\nYW4gZW1iZWRkZWQgb3duZXIsIHVzZSB2YXJpYWJsZSB0byBjcmVhdGUgYSB1\nbmlxdWUKICAgICAqIGFsaWFzIGluIGNhc2Ugb3duZXIgY29udGFpbnMgb3Ro\nZXIgc2FtZS10eXBlZCBlbWJlZGRlZCByZWxhdGlvbnMuCiAgICAgKi8KICAg\nIHByaXZhdGUgSm9pbnMgc2V0RW1iZWRkZWRWYXJpYWJsZShKb2lucyBqb2lu\ncykgewogICAgICAgIGlmIChmaWVsZC5nZXREZWZpbmluZ01ldGFEYXRhKCku\nZ2V0RW1iZWRkaW5nTWV0YURhdGEoKSA9PSBudWxsKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnM7CiAgICAgICAgcmV0dXJuIGpvaW5zLnNldFZhcmlhYmxl\nKGZpZWxkLmdldERlZmluaW5nTWV0YURhdGEoKS4KICAgICAgICAgICAgZ2V0\nRW1iZWRkaW5nTWV0YURhdGEoKS5nZXRGaWVsZE1ldGFEYXRhKCkuZ2V0TmFt\nZSgpKTsKICAgIH0KCiAgICBwdWJsaWMgaW50IHNlbGVjdChTZWxlY3Qgc2Vs\nLCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAg\nICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwgaW50IGVhZ2Vy\nTW9kZSkgewogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkg\nPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICByZXR1cm4gLTE7\nCiAgICAgICAgLy8gYWxyZWFkeSBjYWNoZWQgb2lkPwogICAgICAgIGlmIChz\nbSAhPSBudWxsICYmIHNtLmdldEludGVybWVkaWF0ZShmaWVsZC5nZXRJbmRl\neCgpKSAhPSBudWxsKQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAg\naWYgKCFCb29sZWFuLlRSVUUuZXF1YWxzKF9ma09pZCkpCiAgICAgICAgICAg\nIHJldHVybiAtMTsKICAgICAgICBzZWwuc2VsZWN0KGZpZWxkLmdldENvbHVt\nbnMoKSwgZmllbGQuam9pbihzZWwpKTsKICAgICAgICByZXR1cm4gMDsKICAg\nIH0KCiAgICBwdWJsaWMgT2JqZWN0IGxvYWRFYWdlclBhcmFsbGVsKE9wZW5K\nUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBK\nREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBPYmplY3QgcmVzKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIC8vIHByb2Nlc3Mg\nYmF0Y2hlZCByZXN1bHRzIGlmIHdlIGhhdmVuJ3QgYWxyZWFkeQogICAgICAg\nIE1hcCByZWxzOwogICAgICAgIGlmIChyZXMgaW5zdGFuY2VvZiBSZXN1bHQp\nCiAgICAgICAgICAgIHJlbHMgPSBwcm9jZXNzRWFnZXJQYXJhbGxlbFJlc3Vs\ndChzbSwgc3RvcmUsIGZldGNoLCAoUmVzdWx0KSByZXMpOwogICAgICAgIGVs\nc2UKICAgICAgICAgICAgcmVscyA9IChNYXApIHJlczsKCiAgICAgICAgLy8g\nc3RvcmUgb2JqZWN0IGZvciB0aGlzIG9pZCBpbiBpbnN0YW5jZQogICAgICAg\nIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHJlbHMucmVtb3Zl\nKHNtLmdldE9iamVjdElkKCkpKTsKICAgICAgICByZXR1cm4gcmVsczsKICAg\nIH0KCiAgICAvKioKICAgICAqIFByb2Nlc3MgdGhlIGdpdmVuIGJhdGNoZWQg\ncmVzdWx0LgogICAgICovCiAgICBwcml2YXRlIE1hcCBwcm9jZXNzRWFnZXJQ\nYXJhbGxlbFJlc3VsdChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLAogICAgICAg\nIEpEQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRj\naCwgUmVzdWx0IHJlcykKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICAvLyBkbyBzYW1lIGpvaW5zIGFzIGZvciBsb2FkCiAgICAgICAg\nLy8jIyMgY2hlYXQ6IHdlIGtub3cgdHlwaWNhbCByZXN1bHQgam9pbnMgb25s\neSBjYXJlIGFib3V0IHRoZSByZWxhdGlvbgogICAgICAgIC8vIyMjIHBhdGg7\nIHRodXMgd2UgY2FuIGlnbm9yZSBkaWZmZXJlbnQgbWFwcGluZ3MKICAgICAg\nICBDbGFzc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRU\neXBlTWFwcGluZ3MoKTsKICAgICAgICBKb2lucyBqb2lucyA9IHJlcy5uZXdK\nb2lucygpLnNldFZhcmlhYmxlKCIqIik7CiAgICAgICAgZWFnZXJKb2luKGpv\naW5zLCBjbHNzWzBdLCB0cnVlKTsKCiAgICAgICAgTWFwIHJlbHMgPSBuZXcg\nSGFzaE1hcCgpOwogICAgICAgIENsYXNzTWFwcGluZyBvd25lciA9IGZpZWxk\nLmdldERlZmluaW5nTWFwcGluZygpOwogICAgICAgIENsYXNzTWFwcGluZyBj\nbHM7CiAgICAgICAgT2JqZWN0IG9pZDsKICAgICAgICB3aGlsZSAocmVzLm5l\neHQoKSkgewogICAgICAgICAgICBjbHMgPSByZXMuZ2V0QmFzZU1hcHBpbmco\nKTsKICAgICAgICAgICAgaWYgKGNscyA9PSBudWxsKQogICAgICAgICAgICAg\nICAgY2xzID0gY2xzc1swXTsKICAgICAgICAgICAgb2lkID0gb3duZXIuZ2V0\nT2JqZWN0SWQoc3RvcmUsIHJlcywgbnVsbCwgdHJ1ZSwgbnVsbCk7CiAgICAg\nICAgICAgIHJlbHMucHV0KG9pZCwgcmVzLmxvYWQoY2xzLCBzdG9yZSwgZmV0\nY2gsIGpvaW5zKSk7CiAgICAgICAgfQogICAgICAgIHJlcy5jbG9zZSgpOwoK\nICAgICAgICByZXR1cm4gcmVsczsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBs\nb2FkRWFnZXJKb2luKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9y\nZSBzdG9yZSwKICAgICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNo\nLCBSZXN1bHQgcmVzKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewog\nICAgICAgIGlmIChmaWVsZC5pc0JpTVRvMUpUKCkpCiAgICAgICAgICAgIHJl\ndHVybjsKICAgICAgICBDbGFzc01hcHBpbmcgY2xzID0gZmllbGQuZ2V0SW5k\nZXBlbmRlbnRUeXBlTWFwcGluZ3MoKVswXTsKCiAgICAgICAgLy8gZm9yIGlu\ndmVyc2VFYWdlciBmaWVsZAogICAgICAgIEZpZWxkTWFwcGluZyBtYXBwZWRC\neUZpZWxkTWFwcGluZyA9IGZpZWxkLmdldE1hcHBlZEJ5TWFwcGluZygpOwog\nICAgICAgIFBlcnNpc3RlbmNlQ2FwYWJsZSBtYXBwZWRCeVZhbHVlID0gbnVs\nbDsKCiAgICAgICAgaWYgKG1hcHBlZEJ5RmllbGRNYXBwaW5nICE9IG51bGwp\nIHsKICAgICAgICAJVmFsdWVNYXBwaW5nIHZhbCA9IG1hcHBlZEJ5RmllbGRN\nYXBwaW5nLmdldFZhbHVlTWFwcGluZygpOwogICAgICAgIAlDbGFzc01ldGFE\nYXRhIGRlY01ldGEgPSB2YWwuZ2V0VHlwZU1ldGFEYXRhKCk7CiAgICAgICAg\nICAgIC8vIGVhZ2VyIGxvYWRpbmcgYSBjaGlsZCBmcm9tIGl0cyB0b09uZSBw\nYXJlbnQgYW5kCiAgICAgICAgICAgIC8vIHRoZSBwYXJlbnQgaGFzIEBPbmVU\nb09uZShtYXBwZWRCeT0icGFyZW50IikgY2hpbGQgcmVsYXRpb24uCiAgICAg\nICAgICAgIC8vIEJ5IHNhdmluZyB0aGUgbWFwcGVkLWJ5IGluZm8gaW4gJ3Jl\ncycgaXMgdG8KICAgICAgICAgICAgLy8gYXZvaWQgdW5uZWVkZWQgU1FMIHB1\nc2hkb3duIHRoYXQgd291bGQgb3RoZXJ3aXNlIGdldHMKICAgICAgICAgICAg\nLy8gZ2VuZXJhdGVkLgogICAgICAgICAgICBpZiAoZGVjTWV0YSAhPSBudWxs\nICYmICFzbS5pc0VtYmVkZGVkKCkpIHsKICAgICAgICAJICAgIG1hcHBlZEJ5\nVmFsdWUgPSBzbS5nZXRQZXJzaXN0ZW5jZUNhcGFibGUoKTsKICAgICAgICAJ\nICAgIHJlcy5zZXRNYXBwZWRCeUZpZWxkTWFwcGluZyhtYXBwZWRCeUZpZWxk\nTWFwcGluZyk7CiAgICAgICAgCSAgICByZXMuc2V0TWFwcGVkQnlWYWx1ZSht\nYXBwZWRCeVZhbHVlKTsKICAgICAgICAJfQogICAgICAgIH0KCiAgICAgICAg\nYm9vbGVhbiBpc0xvY2tlZCA9IHJlcy5pc0xvY2tpbmcoKTsKICAgICAgICB0\ncnkgewogICAgICAgICAgICBpZiAoc3RvcmUuZ2V0TG9ja01hbmFnZXIoKSAh\nPSBudWxsKQogICAgICAgICAgICAgICAgcmVzLnNldExvY2tpbmcoc3RvcmUu\nZ2V0TG9ja01hbmFnZXIoKS5za2lwUmVsYXRpb25GaWVsZExvY2soKSk7CiAg\nICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHJl\ncy5sb2FkKGNscywgc3RvcmUsIGZldGNoLAogICAgICAgICAgICAgICAgICAg\nIGVhZ2VySm9pbihyZXMubmV3Sm9pbnMoKSwgY2xzLCBmYWxzZSkpKTsKICAg\nICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZXMuc2V0TG9ja2luZyhp\nc0xvY2tlZCk7CiAgICAgICAgfQoKICAgICAgICAvLyByZXNldCBtYXBwZWQg\nYnkgaXMgbmVlZGVkIGZvciBPbmVUb09uZSBiaWRpcmVjdGlvbmFsIHJlbGF0\naW9ucwogICAgICAgIC8vIGhhdmluZyBhIG1hcHBlZC1ieSBwYXJlbnQgdG8g\nY29ycmVjdGx5IHNldCB0aGUgcGFyZW50LWNoaWxkCiAgICAgICAgLy8gcmVs\nYXRpb24uCiAgICAgICAgcmVzLnNldE1hcHBlZEJ5RmllbGRNYXBwaW5nKG51\nbGwpOwogICAgICAgIHJlcy5zZXRNYXBwZWRCeVZhbHVlKG51bGwpOwogICAg\nfQoKICAgIHB1YmxpYyB2b2lkIGxvYWQoT3BlbkpQQVN0YXRlTWFuYWdlciBz\nbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3Vy\nYXRpb24gZmV0Y2gsIFJlc3VsdCByZXMpCiAgICAgICAgdGhyb3dzIFNRTEV4\nY2VwdGlvbiB7CiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24o\nKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybjsK\nICAgICAgICAvLyBjYWNoZWQgb2lkPwogICAgICAgIGlmIChzbSAhPSBudWxs\nICYmIHNtLmdldEludGVybWVkaWF0ZShmaWVsZC5nZXRJbmRleCgpKSAhPSBu\ndWxsKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKCFCb29sZWFu\nLlRSVUUuZXF1YWxzKF9ma09pZCkpCiAgICAgICAgICAgIHJldHVybjsKICAg\nICAgICBpZiAoIXJlcy5jb250YWluc0FsbChmaWVsZC5nZXRDb2x1bW5zKCkp\nKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIC8vIGdldCB0aGUgcmVs\nYXRlZCBvYmplY3QncyBvaWQKICAgICAgICBDbGFzc01hcHBpbmcgcmVsTWFw\ncGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgT2JqZWN0\nIG9pZCA9IG51bGw7CiAgICAgICAgaWYgKHJlbE1hcHBpbmcuaXNNYXBwZWQo\nKSAmJiAhZmllbGQuaXNCaU1UbzFKVCgpKSB7IAogICAgICAgICAgICBvaWQg\nPSByZWxNYXBwaW5nLmdldE9iamVjdElkKHN0b3JlLCByZXMsIGZpZWxkLmdl\ndEZvcmVpZ25LZXkoKSwKICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRQ\nb2x5bW9ycGhpYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFLCBudWxs\nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBDb2x1bW5bXSBjb2xz\nID0gZmllbGQuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocmVsTWFw\ncGluZy5nZXRJZGVudGl0eVR5cGUoKSA9PSBDbGFzc01hcHBpbmcuSURfREFU\nQVNUT1JFKSB7CiAgICAgICAgICAgICAgICBsb25nIGlkID0gcmVzLmdldExv\nbmcoY29sc1swXSk7CiAgICAgICAgICAgICAgICBpZiAoIXJlcy53YXNOdWxs\nKCkpCiAgICAgICAgICAgICAgICAgICAgb2lkID0gc3RvcmUubmV3RGF0YVN0\nb3JlSWQoaWQsIHJlbE1hcHBpbmcsIHRydWUpOwogICAgICAgICAgICB9IGVs\nc2UgeyAKICAgICAgICAgICAgICAgIC8vIGFwcGxpY2F0aW9uIGlkCiAgICAg\nICAgICAgICAgICBpZiAoY29scy5sZW5ndGggPT0gMSkgewogICAgICAgICAg\nICAgICAgICAgIE9iamVjdCB2YWwgPSByZXMuZ2V0T2JqZWN0KGNvbHNbMF0s\nIG51bGwsIG51bGwpOwogICAgICAgICAgICAgICAgICAgIGlmICh2YWwgIT0g\nbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgb2lkID0gQXBwbGljYXRp\nb25JZHMuZnJvbVBLVmFsdWVzKG5ldyBPYmplY3RbXXsgdmFsIH0sCiAgICAg\nICAgICAgICAgICAgICAgICAgICAgICByZWxNYXBwaW5nKTsKICAgICAgICAg\nICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgT2JqZWN0W10g\ndmFscyA9IG5ldyBPYmplY3RbY29scy5sZW5ndGhdOwogICAgICAgICAgICAg\nICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgY29scy5sZW5ndGg7IGkrKykg\newogICAgICAgICAgICAgICAgICAgICAgICB2YWxzW2ldID0gcmVzLmdldE9i\namVjdChjb2xzW2ldLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAg\nICAgICAgaWYgKHZhbHNbaV0gPT0gbnVsbCkKICAgICAgICAgICAgICAgICAg\nICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAo\naSA9PSBjb2xzLmxlbmd0aCAtIDEpCiAgICAgICAgICAgICAgICAgICAgICAg\nICAgICBvaWQgPSBBcHBsaWNhdGlvbklkcy5mcm9tUEtWYWx1ZXModmFscywg\ncmVsTWFwcGluZyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAg\nICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAo\nb2lkID09IG51bGwpCiAgICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxk\nLmdldEluZGV4KCksIG51bGwpOwogICAgICAgIGVsc2UKICAgICAgICAgICAg\nc20uc2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCksIG9pZCk7CiAg\nICB9CgogICAgcHVibGljIHZvaWQgbG9hZChmaW5hbCBPcGVuSlBBU3RhdGVN\nYW5hZ2VyIHNtLCBmaW5hbCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgZmlu\nYWwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCkKICAgICAgICB0aHJv\nd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICAvLyBjaGVjayBmb3IgY2FjaGVk\nIG9pZCB2YWx1ZSwgb3IgbG9hZCBvaWQgaWYgbm8gd2F5IHRvIGpvaW4KICAg\nICAgICBpZiAoQm9vbGVhbi5UUlVFLmVxdWFscyhfZmtPaWQpKSB7CiAgICAg\nICAgICAgIE9iamVjdCBvaWQgPSBzbS5nZXRJbnRlcm1lZGlhdGUoZmllbGQu\nZ2V0SW5kZXgoKSk7CiAgICAgICAgICAgIGlmIChvaWQgIT0gbnVsbCkgewog\nICAgICAgICAgICAgICAgT2JqZWN0IHZhbCA9IHN0b3JlLmZpbmQob2lkLCBm\naWVsZCwgZmV0Y2gpOwogICAgICAgICAgICAgICAgc20uc3RvcmVPYmplY3Qo\nZmllbGQuZ2V0SW5kZXgoKSwgdmFsKTsKICAgICAgICAgICAgICAgIHJldHVy\nbjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZmluYWwgQ2xh\nc3NNYXBwaW5nW10gcmVscyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1h\ncHBpbmdzKCk7CiAgICAgICAgZmluYWwgaW50IHN1YnMgPSBmaWVsZC5nZXRT\nZWxlY3RTdWJjbGFzc2VzKCk7CiAgICAgICAgZmluYWwgSm9pbnNbXSByZXNK\nb2lucyA9IG5ldyBKb2luc1tyZWxzLmxlbmd0aF07CgogICAgICAgIC8vIHNl\nbGVjdCByZWxhdGVkIG1hcHBpbmcgY29sdW1uczsgam9pbmluZyBmcm9tIHRo\nZSByZWxhdGVkIHR5cGUKICAgICAgICAvLyBiYWNrIHRvIG91ciBmayB0YWJs\nZSBpZiBub3QgYW4gaW52ZXJzZSBtYXBwaW5nIChpbiB3aGljaCBjYXNlIHdl\nCiAgICAgICAgLy8gY2FuIGp1c3QgbWFrZSBzdXJlIHRoZSBpbnZlcnNlIGNv\nbHMgPT0gb3VyIHBrIHZhbHVlcykKICAgICAgICBVbmlvbiB1bmlvbiA9IHN0\nb3JlLmdldFNRTEZhY3RvcnkoKS5uZXdVbmlvbihyZWxzLmxlbmd0aCk7CiAg\nICAgICAgdW5pb24uc2V0RXhwZWN0ZWRSZXN1bHRDb3VudCgxLCBmYWxzZSk7\nCiAgICAgICAgaWYgKGZldGNoLmdldFN1YmNsYXNzRmV0Y2hNb2RlKGZpZWxk\nLmdldFR5cGVNYXBwaW5nKCkpCiAgICAgICAgICAgICE9IEpEQkNGZXRjaENv\nbmZpZ3VyYXRpb24uRUFHRVJfSk9JTikKICAgICAgICAgICAgdW5pb24uYWJv\ncnRVbmlvbigpOwogICAgICAgIHVuaW9uLnNlbGVjdChuZXcgVW5pb24uU2Vs\nZWN0b3IoKSB7CiAgICAgICAgICAgIHB1YmxpYyB2b2lkIHNlbGVjdChTZWxl\nY3Qgc2VsLCBpbnQgaWR4KSB7CiAgICAgICAgICAgICAgICBpZiAoZmllbGQu\nZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAg\nICAgICAgICAgICAgICAgICBzZWwud2hlcmVGb3JlaWduS2V5KGZpZWxkLmdl\ndEZvcmVpZ25LZXkocmVsc1tpZHhdKSwKICAgICAgICAgICAgICAgICAgICAg\nICAgc20uZ2V0T2JqZWN0SWQoKSwgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5n\nKCksIHN0b3JlKTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAg\nICAgICAgICAgIGlmICghZmllbGQuaXNCaU1UbzFKVCgpKSB7CiAgICAgICAg\nICAgICAgICAgICAgICAgIHJlc0pvaW5zW2lkeF0gPSBzZWwubmV3Sm9pbnMo\nKS5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAg\nICAgICAgICAgICAgICAgZmllbGQuZ2V0Rm9yZWlnbktleShyZWxzW2lkeF0p\nLCByZWxzW2lkeF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVs\nZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7CiAgICAg\nICAgICAgICAgICAgICAgICAgIGZpZWxkLndoZXJlUHJpbWFyeUtleShzZWws\nIHNtLCBzdG9yZSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAg\nICAgICAgICAgICAgICAgICAgICAgcmVzSm9pbnNbaWR4XSA9IHNlbC5uZXdK\nb2lucygpLmpvaW5SZWxhdGlvbihudWxsLAogICAgICAgICAgICAgICAgICAg\nICAgICAgICAgZmllbGQuZ2V0QmkxVG9NSm9pbkZLKCksIHJlbHNbaWR4XSwK\nICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1\nYmNsYXNzZXMoKSwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAg\nICAgICAgc2VsLndoZXJlRm9yZWlnbktleShmaWVsZC5nZXRCaTFUb01FbGVt\nRksoKSwgc20uZ2V0T2JqZWN0SWQoKSwgCiAgICAgICAgICAgICAgICAgICAg\nICAgICAgICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgc3RvcmUpOwog\nICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAg\nICAgICAgICAgIHNlbC5zZWxlY3QocmVsc1tpZHhdLCBzdWJzLCBzdG9yZSwg\nZmV0Y2gsIGZldGNoLkVBR0VSX0pPSU4sIAogICAgICAgICAgICAgICAgICAg\nIHJlc0pvaW5zW2lkeF0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7Cgog\nICAgICAgIFJlc3VsdCByZXMgPSB1bmlvbi5leGVjdXRlKHN0b3JlLCBmZXRj\naCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgT2JqZWN0IHZhbCA9IG51\nbGw7CiAgICAgICAgICAgIGlmIChyZXMubmV4dCgpKQogICAgICAgICAgICAg\nICAgdmFsID0gcmVzLmxvYWQocmVsc1tyZXMuaW5kZXhPZigpXSwgc3RvcmUs\nIGZldGNoLAogICAgICAgICAgICAgICAgICAgIHJlc0pvaW5zW3Jlcy5pbmRl\neE9mKCldKTsKICAgICAgICAgICAgc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0\nSW5kZXgoKSwgdmFsKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAg\nICByZXMuY2xvc2UoKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIE9i\namVjdCB0b0RhdGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9yZSBz\ndG9yZSkgewogICAgICAgIHJldHVybiBSZWxhdGlvblN0cmF0ZWdpZXMudG9E\nYXRhU3RvcmVWYWx1ZShmaWVsZCwgdmFsLCBzdG9yZSk7CiAgICB9CgogICAg\ncHVibGljIHZvaWQgYXBwZW5kSXNOdWxsKFNRTEJ1ZmZlciBzcWwsIFNlbGVj\ndCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAgLy8gaWYgbm8gaW52ZXJz\nZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0YWJsZSAodXN1YWxseSBhIG5v\nLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUgcHJpbWFy\neSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xzIGFyZSBudWxsOwogICAgICAg\nIC8vIGlmIGludmVyc2UsIHRoZW4gd2UgaGF2ZSB0byBkbyBhIHN1Yi1zZWxl\nY3QgdG8gc2VlIGlmIGFueSBpbnZlcnNlCiAgICAgICAgLy8gb2JqZWN0cyBw\nb2ludCBiYWNrIHRvIHRoaXMgZmllbGQncyBvd25lcgogICAgICAgIGlmIChm\naWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9JTlZFUlNF\nKSB7CiAgICAgICAgICAgIC8vIyMjIHByb2JhYmx5IG5lZWQgc29tZSBzb3J0\nIG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZrIGNvbnN0YW50cwogICAgICAgICAg\nICBqb2lucyA9IGpvaW4oam9pbnMsIGZhbHNlKTsKICAgICAgICAgICAgQ29s\ndW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAgICAg\naWYgKGNvbHMubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICBzcWwuYXBw\nZW5kKCIxIDw+IDEiKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAg\nICAgc3FsLmFwcGVuZChzZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwgam9p\nbnMpKS4KICAgICAgICAgICAgICAgICAgICBhcHBlbmQoIiBJUyAiKS5hcHBl\nbmRWYWx1ZShudWxsLCBjb2xzWzBdKTsKICAgICAgICB9IGVsc2UKICAgICAg\nICAgICAgdGVzdEludmVyc2VOdWxsKHNxbCwgc2VsLCBqb2lucywgdHJ1ZSk7\nCiAgICB9CgogICAgcHVibGljIHZvaWQgYXBwZW5kSXNOb3ROdWxsKFNRTEJ1\nZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAg\nLy8gaWYgbm8gaW52ZXJzZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0YWJs\nZSAodXN1YWxseSBhIG5vLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCdsbCBi\nZSBpbiB0aGUgcHJpbWFyeSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xzIGFy\nZW4ndAogICAgICAgIC8vIG51bGw7IGlmIGludmVyc2UsIHRoZW4gd2UgaGF2\nZSB0byBkbyBhIHN1Yi1zZWxlY3QgdG8gc2VlIGlmIGFueQogICAgICAgIC8v\nIGludmVyc2Ugb2JqZWN0cyBwb2ludCBiYWNrIHRvIHRoaXMgZmllbGQncyBv\nd25lcgogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0g\nZmllbGQuSk9JTl9JTlZFUlNFKSB7CiAgICAgICAgICAgIC8vIyMjIHByb2Jh\nYmx5IG5lZWQgc29tZSBzb3J0IG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZrIGNv\nbnN0YW50cwogICAgICAgICAgICBqb2lucyA9IGpvaW4oam9pbnMsIGZhbHNl\nKTsKICAgICAgICAgICAgQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVt\nbnMoKTsKICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3RoID09IDApCiAgICAg\nICAgICAgICAgICBzcWwuYXBwZW5kKCIxID0gMSIpOwogICAgICAgICAgICBl\nbHNlCiAgICAgICAgICAgICAgICBzcWwuYXBwZW5kKHNlbC5nZXRDb2x1bW5B\nbGlhcyhjb2xzWzBdLCBqb2lucykpLgogICAgICAgICAgICAgICAgICAgIGFw\ncGVuZCgiIElTIE5PVCAiKS5hcHBlbmRWYWx1ZShudWxsLCBjb2xzWzBdKTsK\nICAgICAgICB9IGVsc2UKICAgICAgICAgICAgdGVzdEludmVyc2VOdWxsKHNx\nbCwgc2VsLCBqb2lucywgZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAgICog\nQXBwZW5kIFNRTCBmb3IgYSBzdWItc2VsZWN0IHRlc3Rpbmcgd2hldGhlciBh\nbiBpbnZlcnNlIG9iamVjdCBleGlzdHMKICAgICAqIGZvciB0aGlzIHJlbGF0\naW9uLgogICAgICovCiAgICBwcml2YXRlIHZvaWQgdGVzdEludmVyc2VOdWxs\nKFNRTEJ1ZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zLAogICAg\nICAgIGJvb2xlYW4gZW1wdHkpIHsKICAgICAgICBEQkRpY3Rpb25hcnkgZGlj\ndCA9IGZpZWxkLmdldE1hcHBpbmdSZXBvc2l0b3J5KCkuZ2V0REJEaWN0aW9u\nYXJ5KCk7CiAgICAgICAgZGljdC5hc3NlcnRTdXBwb3J0KGRpY3Quc3VwcG9y\ndHNTdWJzZWxlY3QsICJTdXBwb3J0c1N1YnNlbGVjdCIpOwoKICAgICAgICBp\nZiAoZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5ndGgg\nIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVzLnVu\naW52ZXJzYWJsZShmaWVsZCk7CgogICAgICAgIGlmIChlbXB0eSkKICAgICAg\nICAgICAgc3FsLmFwcGVuZCgiMCA9ICIpOwogICAgICAgIGVsc2UKICAgICAg\nICAgICAgc3FsLmFwcGVuZCgiMCA8ICIpOwoKICAgICAgICBGb3JlaWduS2V5\nIGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbnRhaW5l\nckZpZWxkU3RyYXRlZ3kuYXBwZW5kSm9pbkNvdW50KHNxbCwgc2VsLCBqb2lu\ncywgZGljdCwgZmllbGQsCiAgICAgICAgICAgIGZrKTsKICAgIH0KCiAgICBw\ndWJsaWMgSm9pbnMgam9pbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3JjZU91\ndGVyKSB7CiAgICAgICAgLy8gaWYgd2UncmUgbm90IGluIGFuIGludmVyc2Ug\nb2JqZWN0IHRhYmxlIGpvaW4gbm9ybWFsbHksIG90aGVyd2lzZQogICAgICAg\nIC8vIGFscmVhZHkgdHJhdmVyc2VkIHRoZSByZWxhdGlvbjsganVzdCBqb2lu\nIGJhY2sgdG8gb3duZXIgdGFibGUKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9p\nbkRpcmVjdGlvbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAg\nICAgcmV0dXJuIGZpZWxkLmpvaW4oam9pbnMsIGZvcmNlT3V0ZXIsIGZhbHNl\nKTsKICAgICAgICBDbGFzc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0SW5k\nZXBlbmRlbnRUeXBlTWFwcGluZ3MoKTsKICAgICAgICBpZiAoY2xzcy5sZW5n\ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVz\nLnVuaW52ZXJzYWJsZShmaWVsZCk7CiAgICAgICAgaWYgKGZvcmNlT3V0ZXIp\nCiAgICAgICAgICAgIHJldHVybiBqb2lucy5vdXRlckpvaW5SZWxhdGlvbihm\naWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICBmaWVsZC5nZXRGb3Jl\naWduS2V5KCksIGNsc3NbMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMo\nKSwgCiAgICAgICAgICAgICAgICB0cnVlLCBmYWxzZSk7CiAgICAgICAgcmV0\ndXJuIGpvaW5zLmpvaW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCksIGZpZWxk\nLmdldEZvcmVpZ25LZXkoKSwKICAgICAgICAgICAgY2xzc1swXSwgZmllbGQu\nZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCB0cnVlLCBmYWxzZSk7CiAgICB9Cgog\nICAgcHVibGljIEpvaW5zIGpvaW5SZWxhdGlvbihKb2lucyBqb2lucywgYm9v\nbGVhbiBmb3JjZU91dGVyLAogICAgICAgIGJvb2xlYW4gdHJhdmVyc2UpIHsK\nICAgICAgICAvLyBpZiB0aGlzIGlzIGFuIGludmVyc2UgbWFwcGluZyBpdCdz\nIGFscmVhZHkgam9pbmVkIHRvIHRoZSByZWxhdGlvbgogICAgICAgIGlmIChm\naWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNF\nKQogICAgICAgICAgICByZXR1cm4gam9pbnM7CiAgICAgICAgQ2xhc3NNYXBw\naW5nW10gY2xzcyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdz\nKCk7CiAgICAgICAgaWYgKGNsc3MubGVuZ3RoICE9IDEpIHsKICAgICAgICAg\nICAgaWYgKHRyYXZlcnNlKQogICAgICAgICAgICAgICAgdGhyb3cgUmVsYXRp\nb25TdHJhdGVnaWVzLnVuam9pbmFibGUoZmllbGQpOwogICAgICAgICAgICBy\nZXR1cm4gam9pbnM7CiAgICAgICAgfQoKICAgICAgICBqb2lucyA9IHNldEVt\nYmVkZGVkVmFyaWFibGUoam9pbnMpOwogICAgICAgIGlmIChmb3JjZU91dGVy\nKQogICAgICAgICAgICByZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24o\nZmllbGQuZ2V0TmFtZSgpLCAKICAgICAgICAgICAgICAgIGZpZWxkLmdldEZv\ncmVpZ25LZXkoY2xzc1swXSksIGNsc3NbMF0sIAogICAgICAgICAgICAgICAg\nZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwog\nICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0TmFt\nZSgpLCBmaWVsZC5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLAogICAgICAgICAg\nICBjbHNzWzBdLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZhbHNl\nLCBmYWxzZSk7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vCiAgICAvLyBKb2luYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8vLy8v\nLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgcHVibGljIGludCBnZXRGaWVs\nZEluZGV4KCkgewogICAgICAgIHJldHVybiBmaWVsZC5nZXRJbmRleCgpOwog\nICAgfQoKICAgIHB1YmxpYyBPYmplY3QgZ2V0UHJpbWFyeUtleVZhbHVlKFJl\nc3VsdCByZXMsIENvbHVtbltdIGNvbHMsIEZvcmVpZ25LZXkgZmssCiAgICAg\nICAgSkRCQ1N0b3JlIHN0b3JlLCBKb2lucyBqb2lucykKICAgICAgICB0aHJv\nd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVsbWFw\ncGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgaWYgKHJl\nbG1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5nLklE\nX0RBVEFTVE9SRSkgewogICAgICAgICAgICBDb2x1bW4gY29sID0gY29sc1sw\nXTsKICAgICAgICAgICAgaWYgKGZrICE9IG51bGwpCiAgICAgICAgICAgICAg\nICBjb2wgPSBmay5nZXRDb2x1bW4oY29sKTsgICAKICAgICAgICAgICAgbG9u\nZyBpZCA9IHJlcy5nZXRMb25nKGNvbCwgam9pbnMpOwogICAgICAgICAgICBp\nZiAoZmllbGQuZ2V0T2JqZWN0SWRGaWVsZFR5cGVDb2RlKCkgPT0gSmF2YVR5\ncGVzLkxPTkcpCiAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVycy52YWx1\nZU9mKGlkKTsKICAgICAgICAgICAgcmV0dXJuIHN0b3JlLm5ld0RhdGFTdG9y\nZUlkKGlkLCByZWxtYXBwaW5nLCBmaWVsZC5nZXRQb2x5bW9ycGhpYygpIAog\nICAgICAgICAgICAgICAgIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0UpOwog\nICAgICAgIH0KCiAgICAgICAgaWYgKHJlbG1hcHBpbmcuaXNPcGVuSlBBSWRl\nbnRpdHkoKSkKICAgICAgICAgICAgcmV0dXJuICgoSm9pbmFibGUpIHJlbG1h\ncHBpbmcuZ2V0UHJpbWFyeUtleUZpZWxkTWFwcGluZ3MoKVswXS4KICAgICAg\nICAgICAgICAgIGdldFN0cmF0ZWd5KCkpLmdldFByaW1hcnlLZXlWYWx1ZShy\nZXMsIGNvbHMsIGZrLCBzdG9yZSwgam9pbnMpOwoKICAgICAgICBpZiAoY29s\ncyA9PSBnZXRDb2x1bW5zKCkgJiYgZmsgPT0gbnVsbCkKICAgICAgICAgICAg\nZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7CiAgICAgICAgZWxzZQogICAg\nICAgICAgICBmayA9IGNyZWF0ZVRyYW5zbGF0aW5nRm9yZWlnbktleShyZWxt\nYXBwaW5nLCBjb2xzLCBmayk7IAogICAgICAgIHJldHVybiByZWxtYXBwaW5n\nLmdldE9iamVjdElkKHN0b3JlLCByZXMsIGZrLAogICAgICAgICAgICBmaWVs\nZC5nZXRQb2x5bW9ycGhpYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNF\nLCBqb2lucyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBmYXV4\nIGZvcmVpZ24ga2V5IHRoYXQgdHJhbnNsYXRlcyBiZXR3ZWVuIHRoZSBjb2x1\nbW5zIHRvIHB1bGwKICAgICAqIHRoZSBkYXRhIGZyb20gYW5kIG91ciByZWxh\ndGVkIHR5cGUncyBwcmltYXJ5IGtleSBjb2x1bW5zLgogICAgICovCiAgICBw\ncml2YXRlIEZvcmVpZ25LZXkgY3JlYXRlVHJhbnNsYXRpbmdGb3JlaWduS2V5\nKENsYXNzTWFwcGluZyByZWxtYXBwaW5nLAogICAgICAgIENvbHVtbltdIGdj\nb2xzLCBGb3JlaWduS2V5IGdmaykgewogICAgICAgIEZvcmVpZ25LZXkgZmsg\nPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7IAogICAgICAgIENvbHVtbltdIGNv\nbHMgPSBmay5nZXRDb2x1bW5zKCk7CgogICAgICAgIEZvcmVpZ25LZXkgdGZr\nID0gbnVsbDsKICAgICAgICBDb2x1bW4gdGNvbDsKICAgICAgICBmb3IgKGlu\ndCBpID0gMDsgaSA8IGdjb2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAg\nIHRjb2wgPSBnY29sc1tpXTsKICAgICAgICAgICAgaWYgKGdmayAhPSBudWxs\nKQogICAgICAgICAgICAgICAgdGNvbCA9IGdmay5nZXRDb2x1bW4odGNvbCk7\nCiAgICAgICAgICAgIGlmICh0ZmsgPT0gbnVsbCkKICAgICAgICAgICAgICAg\nIHRmayA9IG5ldyBGb3JlaWduS2V5KERCSWRlbnRpZmllci5OVUxMLCB0Y29s\nLmdldFRhYmxlKCkpOwogICAgICAgICAgICB0Zmsuam9pbih0Y29sLCBmay5n\nZXRQcmltYXJ5S2V5Q29sdW1uKGNvbHNbaV0pKTsKICAgICAgICB9CiAgICAg\nICAgcmV0dXJuIHRmazsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGdldEpv\naW5WYWx1ZShPYmplY3QgZmllbGRWYWwsIENvbHVtbiBjb2wsIEpEQkNTdG9y\nZSBzdG9yZSkgewogICAgICAgIE9iamVjdCBvID0gZmllbGQuZ2V0Rm9yZWln\nbktleSgpLmdldENvbnN0YW50KGNvbCk7CiAgICAgICAgaWYgKG8gIT0gbnVs\nbCkKICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgY29sID0gZmllbGQu\nZ2V0Rm9yZWlnbktleSgpLmdldFByaW1hcnlLZXlDb2x1bW4oY29sKTsKICAg\nICAgICBpZiAoY29sID09IG51bGwpCiAgICAgICAgICAgIHRocm93IG5ldyBJ\nbnRlcm5hbEV4Y2VwdGlvbigpOwogICAgICAgIAogICAgICAgIE9iamVjdCBz\nYXZlZEZpZWxkVmFsID0gZmllbGRWYWw7CgogICAgICAgIENsYXNzTWFwcGlu\nZyByZWxtYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAg\nICBKb2luYWJsZSBqID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5hc3NlcnRK\nb2luYWJsZShjb2wpOwogICAgICAgIGlmIChJbXBsSGVscGVyLmlzTWFuYWdl\nYWJsZShmaWVsZFZhbCkgJiYgIWZpZWxkLmdldERlZmluaW5nTWV0YURhdGEo\nKS51c2VJZENsYXNzRnJvbVBhcmVudCgpKQogICAgICAgICAgICBmaWVsZFZh\nbCA9IHN0b3JlLmdldENvbnRleHQoKS5nZXRPYmplY3RJZChmaWVsZFZhbCk7\nCiAgICAgICAgaWYgKGZpZWxkVmFsIGluc3RhbmNlb2YgT3BlbkpQQUlkKQog\nICAgICAgICAgICBmaWVsZFZhbCA9ICgoT3BlbkpQQUlkKSBmaWVsZFZhbCku\nZ2V0SWRPYmplY3QoKTsKICAgICAgICBpZiAocmVsbWFwcGluZy5nZXRPYmpl\nY3RJZFR5cGUoKSAhPSBudWxsCiAgICAgICAgICAgICYmIHJlbG1hcHBpbmcu\nZ2V0T2JqZWN0SWRUeXBlKCkuaXNJbnN0YW5jZShmaWVsZFZhbCkpIHsKICAg\nICAgICAgICAgT2JqZWN0W10gcGtzID0gQXBwbGljYXRpb25JZHMudG9QS1Zh\nbHVlcyhmaWVsZFZhbCwgcmVsbWFwcGluZyk7CiAgICAgICAgICAgIGZpZWxk\nVmFsID0gcGtzW3JlbG1hcHBpbmcuZ2V0RmllbGQoai5nZXRGaWVsZEluZGV4\nKCkpLgogICAgICAgICAgICAgICAgZ2V0UHJpbWFyeUtleUluZGV4KCldOwog\nICAgICAgIH0gZWxzZSBpZiAocmVsbWFwcGluZy5nZXRPYmplY3RJZFR5cGUo\nKSA9PSBPYmplY3RJZC5jbGFzcyAmJiAKICAgICAgICAgICAgcmVsbWFwcGlu\nZy5nZXRQcmltYXJ5S2V5RmllbGRNYXBwaW5ncygpWzBdLmdldFZhbHVlTWFw\ncGluZygpLmlzRW1iZWRkZWQoKSkgewogICAgICAgICAgICBpZiAoZmllbGRW\nYWwgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiBqLmdldEpvaW5W\nYWx1ZShzYXZlZEZpZWxkVmFsLCBjb2wsIHN0b3JlKTsKICAgICAgICAgICAg\ncmV0dXJuIGouZ2V0Sm9pblZhbHVlKGZpZWxkVmFsLCBjb2wsIHN0b3JlKTsK\nICAgICAgICB9CiAgICAgICAgcmV0dXJuIGouZ2V0Sm9pblZhbHVlKGZpZWxk\nVmFsLCBjb2wsIHN0b3JlKTsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGdl\ndEpvaW5WYWx1ZShPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBDb2x1bW4gY29s\nLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSkgewogICAgICAgIHJldHVybiBn\nZXRKb2luVmFsdWUoc20uZmV0Y2goZmllbGQuZ2V0SW5kZXgoKSksIGNvbCwg\nc3RvcmUpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIHNldEF1dG9Bc3NpZ25l\nZFZhbHVlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9y\nZSwKICAgICAgICBDb2x1bW4gY29sLCBPYmplY3QgYXV0b0luYykgewogICAg\nICAgIHRocm93IG5ldyBVbnN1cHBvcnRlZEV4Y2VwdGlvbigpOwogICAgfQoK\nICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBFbWJl\nZGRhYmxlIGltcGxlbWVudGF0aW9uCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vLy8vLwoKICAgIHB1YmxpYyBDb2x1bW5bXSBnZXRDb2x1bW5zKCkg\newogICAgICAgIHJldHVybiBmaWVsZC5nZXRDb2x1bW5zKCk7CiAgICB9Cgog\nICAgcHVibGljIENvbHVtbklPIGdldENvbHVtbklPKCkgewogICAgICAgIHJl\ndHVybiBmaWVsZC5nZXRDb2x1bW5JTygpOwogICAgfQoKICAgIHB1YmxpYyBP\nYmplY3RbXSBnZXRSZXN1bHRBcmd1bWVudHMoKSB7CiAgICAgICAgcmV0dXJu\nIG51bGw7CiAgICB9CgogICAgcHVibGljIE9iamVjdCB0b0VtYmVkZGVkRGF0\nYVN0b3JlVmFsdWUoT2JqZWN0IHZhbCwgSkRCQ1N0b3JlIHN0b3JlKSB7CiAg\nICAgICAgcmV0dXJuIHRvRGF0YVN0b3JlVmFsdWUodmFsLCBzdG9yZSk7CiAg\nICB9CgogICAgcHVibGljIE9iamVjdCB0b0VtYmVkZGVkT2JqZWN0VmFsdWUo\nT2JqZWN0IHZhbCkgewogICAgICAgIHJldHVybiBVTlNVUFBPUlRFRDsKICAg\nIH0KCiAgICBwdWJsaWMgdm9pZCBsb2FkRW1iZWRkZWQoT3BlbkpQQVN0YXRl\nTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpEQkNGZXRj\naENvbmZpZ3VyYXRpb24gZmV0Y2gsIE9iamVjdCB2YWwpCiAgICAgICAgdGhy\nb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgQ2xhc3NNYXBwaW5nIHJlbE1h\ncHBpbmcgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpOwogICAgICAgIE9iamVj\ndCBvaWQ7CiAgICAgICAgaWYgKHZhbCA9PSBudWxsKQogICAgICAgICAgICBv\naWQgPSBudWxsOwogICAgICAgIGVsc2UgaWYgKHJlbE1hcHBpbmcuZ2V0SWRl\nbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5nLklEX0RBVEFTVE9SRSkKICAg\nICAgICAgICAgb2lkID0gc3RvcmUubmV3RGF0YVN0b3JlSWQoKChOdW1iZXIp\nIHZhbCkubG9uZ1ZhbHVlKCksIHJlbE1hcHBpbmcsCiAgICAgICAgICAgICAg\nICBmaWVsZC5nZXRQb2x5bW9ycGhpYygpICE9IFZhbHVlTWFwcGluZy5QT0xZ\nX0ZBTFNFKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgICAgT2JqZWN0W10g\ncGtzID0gKGdldENvbHVtbnMoKS5sZW5ndGggPT0gMSkgPyBuZXcgT2JqZWN0\nW117IHZhbCB9CiAgICAgICAgICAgICAgICA6IChPYmplY3RbXSkgdmFsOwog\nICAgICAgICAgICBib29sZWFuIG51bGxzID0gdHJ1ZTsKICAgICAgICAgICAg\nZm9yIChpbnQgaSA9IDA7IG51bGxzICYmIGkgPCBwa3MubGVuZ3RoOyBpKysp\nCiAgICAgICAgICAgICAgICBudWxscyA9IHBrc1tpXSA9PSBudWxsOwogICAg\nICAgICAgICBpZiAobnVsbHMpCiAgICAgICAgICAgICAgICBvaWQgPSBudWxs\nOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG9pZCA9IEFw\ncGxpY2F0aW9uSWRzLmZyb21QS1ZhbHVlcyhwa3MsIHJlbE1hcHBpbmcpOwog\nICAgICAgICAgICAgICAgaWYgKGZpZWxkLmdldFBvbHltb3JwaGljKCkgPT0g\nVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0UKICAgICAgICAgICAgICAgICAgICAm\nJiBvaWQgaW5zdGFuY2VvZiBPcGVuSlBBSWQpIHsKICAgICAgICAgICAgICAg\nICAgICAoKE9wZW5KUEFJZCkgb2lkKS5zZXRNYW5hZ2VkSW5zdGFuY2VUeXBl\nKHJlbE1hcHBpbmcuCiAgICAgICAgICAgICAgICAgICAgICAgIGdldERlc2Ny\naWJlZFR5cGUoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0K\nICAgICAgICB9CgogICAgICAgIGlmIChvaWQgPT0gbnVsbCkKICAgICAgICAg\nICAgc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgbnVsbCk7CiAg\nICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlmIChKYXZhVHlwZXMubWF5YmVQ\nQyhmaWVsZC5nZXRWYWx1ZSgpKSAmJgogICAgICAgICAgICAgICAgZmllbGQu\nZ2V0RWxlbWVudCgpLmdldEVtYmVkZGVkTWV0YURhdGEoKSA9PSBudWxsKSB7\nCiAgICAgICAgICAgICAgICBPYmplY3Qgb2JqID0gc3RvcmUuZmluZChvaWQs\nIGZpZWxkLCBmZXRjaCk7CiAgICAgICAgICAgICAgICBzbS5zdG9yZU9iamVj\ndChmaWVsZC5nZXRJbmRleCgpLCBvYmopOwogICAgICAgICAgICB9IGVsc2Ug\nICAgCiAgICAgICAgICAgICAgICBzbS5zZXRJbnRlcm1lZGlhdGUoZmllbGQu\nZ2V0SW5kZXgoKSwgb2lkKTsKICAgICAgICB9CiAgICB9Cn0K\n","encoding":"base64"}

