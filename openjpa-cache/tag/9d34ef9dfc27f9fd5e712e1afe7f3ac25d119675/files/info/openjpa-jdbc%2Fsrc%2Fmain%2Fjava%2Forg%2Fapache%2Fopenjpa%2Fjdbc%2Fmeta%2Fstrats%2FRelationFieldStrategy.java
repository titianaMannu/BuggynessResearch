{"sha":"2ef9aa273cf75cfd5d0599e2a12a8a4f14c46682","node_id":"MDQ6QmxvYjIwNjM2NDoyZWY5YWEyNzNjZjc1Y2ZkNWQwNTk5ZTJhMTJhOGE0ZjE0YzQ2Njgy","size":40220,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/2ef9aa273cf75cfd5d0599e2a12a8a4f14c46682","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9y\ndCBqYXZhLnV0aWwuTGlzdDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CgppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmVuaGFuY2UuUGVyc2lzdGVuY2VDYXBh\nYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuY29uZi5KREJD\nQ29uZmlndXJhdGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJj\nLmtlcm5lbC5KREJDRmV0Y2hDb25maWd1cmF0aW9uOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLmpkYmMua2VybmVsLkpEQkNGZXRjaENvbmZpZ3VyYXRp\nb25JbXBsOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMua2VybmVs\nLkpEQkNTdG9yZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtl\ncm5lbC5KREJDU3RvcmVNYW5hZ2VyOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMubWV0YS5DbGFzc01hcHBpbmc7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5tZXRhLkVtYmVkZGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLkZpZWxkTWFwcGluZzsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuSm9pbmFibGU7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLk1hcHBpbmdJbmZvOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5WYWx1ZU1hcHBpbmc7\nCmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZhbHVlTWFw\ncGluZ0luZm87CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hl\nbWEuQ29sdW1uOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc2No\nZW1hLkNvbHVtbklPOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMu\nc2NoZW1hLkZvcmVpZ25LZXk7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\namRiYy5zY2hlbWEuUHJpbWFyeUtleTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNjaGVtYS5UYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5EQkRpY3Rpb25hcnk7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5zcWwuSm9pbnM7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuTG9naWNhbFVuaW9uOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlJlc3VsdDsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5qZGJjLnNxbC5Sb3c7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5q\ncGEuamRiYy5zcWwuUm93TWFuYWdlcjsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5TUUxCdWZmZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuU2VsZWN0OwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMuc3FsLlNlbGVjdEV4ZWN1dG9yOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlNlbGVjdEltcGw7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5zcWwuVW5pb247CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEua2VybmVsLk9wZW5KUEFTdGF0ZU1hbmFnZXI7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLmxvZy5Mb2c7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEubGliLnV0aWwuTG9jYWxpemVyOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLm1ldGEuQ2xhc3NNZXRhRGF0YTsKaW1wb3J0IG9yZy5h\ncGFjaGUub3BlbmpwYS5tZXRhLkphdmFUeXBlczsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkFwcGxpY2F0aW9uSWRzOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLnV0aWwuSW1wbEhlbHBlcjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkludGVybmFsRXhjZXB0aW9uOwppbXBvcnQgb3Jn\nLmFwYWNoZS5vcGVuanBhLnV0aWwuTWV0YURhdGFFeGNlcHRpb247CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5PcGVuSlBBSWQ7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEudXRpbC5VbnN1cHBvcnRlZEV4Y2VwdGlvbjsK\nCmltcG9ydCBzZXJwLnV0aWwuTnVtYmVyczsKCi8qKgogKiBNYXBwaW5nIGZv\nciBhIHNpbmdsZS12YWx1ZWQgcmVsYXRpb24gdG8gYW5vdGhlciBlbnRpdHku\nCiAqCiAqIEBhdXRob3IgQWJlIFdoaXRlCiAqIEBzaW5jZSAwLjQuMAogKi8K\ncHVibGljIGNsYXNzIFJlbGF0aW9uRmllbGRTdHJhdGVneQogICAgZXh0ZW5k\ncyBBYnN0cmFjdEZpZWxkU3RyYXRlZ3kKICAgIGltcGxlbWVudHMgSm9pbmFi\nbGUsIEVtYmVkZGFibGUgewoKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIExv\nY2FsaXplciBfbG9jID0gTG9jYWxpemVyLmZvclBhY2thZ2UKICAgICAgICAo\nUmVsYXRpb25GaWVsZFN0cmF0ZWd5LmNsYXNzKTsKCiAgICBwcml2YXRlIEJv\nb2xlYW4gX2ZrT2lkID0gbnVsbDsKCiAgICBwdWJsaWMgdm9pZCBtYXAoYm9v\nbGVhbiBhZGFwdCkgewogICAgICAgIGlmIChmaWVsZC5nZXRUeXBlQ29kZSgp\nICE9IEphdmFUeXBlcy5QQyB8fCBmaWVsZC5pc0VtYmVkZGVkUEMoKSkKICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nKCJub3QtcmVsYXRpb24iLCBmaWVsZCkpOwoKICAgICAgICBmaWVsZC5nZXRL\nZXlNYXBwaW5nKCkuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21w\nb25lbnRzCiAgICAgICAgICAgIChmaWVsZC5nZXRLZXkoKSwgIWFkYXB0KTsK\nICAgICAgICBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdldFZhbHVlSW5m\nbygpLmFzc2VydE5vU2NoZW1hQ29tcG9uZW50cwogICAgICAgICAgICAoZmll\nbGQuZ2V0RWxlbWVudCgpLCAhYWRhcHQpOwogICAgICAgIGJvb2xlYW4gY3Jp\ndGVyaWEgPSBmaWVsZC5nZXRWYWx1ZUluZm8oKS5nZXRVc2VDbGFzc0NyaXRl\ncmlhKCk7CgogICAgICAgIC8vIGNoZWNrIGZvciBuYW1lZCBpbnZlcnNlCiAg\nICAgICAgRmllbGRNYXBwaW5nIG1hcHBlZCA9IGZpZWxkLmdldE1hcHBlZEJ5\nTWFwcGluZygpOwogICAgICAgIGlmIChtYXBwZWQgIT0gbnVsbCkgewogICAg\nICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmFzc2VydE5vU2NoZW1h\nQ29tcG9uZW50cyhmaWVsZCwgIWFkYXB0KTsKICAgICAgICAgICAgZmllbGQu\nZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25lbnRzKGZpZWxk\nLCAhYWRhcHQpOwogICAgICAgICAgICBtYXBwZWQucmVzb2x2ZShtYXBwZWQu\nTU9ERV9NRVRBIHwgbWFwcGVkLk1PREVfTUFQUElORyk7CgogICAgICAgICAg\nICBpZiAoIW1hcHBlZC5pc01hcHBlZCgpIHx8IG1hcHBlZC5pc1NlcmlhbGl6\nZWQoKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2Vw\ndGlvbihfbG9jLmdldCgibWFwcGVkLWJ5LXVubWFwcGVkIiwKICAgICAgICAg\nICAgICAgICAgICBmaWVsZCwgbWFwcGVkKSk7CgogICAgICAgICAgICBpZiAo\nbWFwcGVkLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAg\nICAgICAgICAgICBpZiAobWFwcGVkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBt\nYXBwZWQuSk9JTl9GT1JXQVJEKSB7CiAgICAgICAgICAgICAgICAgICAgZmll\nbGQuc2V0Sm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAg\nICAgICAgICAgICAgICAgIGZpZWxkLnNldENvbHVtbnMobWFwcGVkLmdldERl\nZmluaW5nTWFwcGluZygpLgogICAgICAgICAgICAgICAgICAgICAgICBnZXRQ\ncmltYXJ5S2V5Q29sdW1ucygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBp\nZiAoaXNUeXBlVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQpKQogICAgICAgICAg\nICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdl\ndAogICAgICAgICAgICAgICAgICAgICAgICAoIm1hcHBlZC1pbnZlcnNlLXVu\nam9pbmVkIiwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAgICAg\nICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCksIG1hcHBlZCkp\nOwoKICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkobWFwcGVk\nLmdldEZvcmVpZ25LZXkKICAgICAgICAgICAgICAgICAgICAoZmllbGQuZ2V0\nRGVmaW5pbmdNYXBwaW5nKCkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICht\nYXBwZWQuZ2V0RWxlbWVudCgpLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVz\nLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUeXBlVW5qb2luZWRTdWJj\nbGFzcyhtYXBwZWQuZ2V0RWxlbWVudE1hcHBpbmcoKSkpCiAgICAgICAgICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nCiAgICAgICAgICAgICAgICAgICAgICAgICgibWFwcGVkLWludmVyc2UtdW5q\nb2luZWQiLCBmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICAgICAg\nICAgICAgICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgbWFwcGVkKSk7\nCgogICAgICAgICAgICAgICAgLy8gd2FybiB0aGUgdXNlciBhYm91dCBtYWtp\nbmcgdGhlIGNvbGxlY3Rpb24gc2lkZSB0aGUgb3duZXIKICAgICAgICAgICAg\nICAgIExvZyBsb2cgPSBmaWVsZC5nZXRSZXBvc2l0b3J5KCkuZ2V0TG9nKCk7\nCiAgICAgICAgICAgICAgICBpZiAobG9nLmlzSW5mb0VuYWJsZWQoKSkKICAg\nICAgICAgICAgICAgICAgICBsb2cuaW5mbyhfbG9jLmdldCgiY29sbC1vd25l\nciIsIGZpZWxkLCBtYXBwZWQpKTsKICAgICAgICAgICAgICAgIGZpZWxkLnNl\ndEZvcmVpZ25LZXkobWFwcGVkLmdldEVsZW1lbnRNYXBwaW5nKCkuCiAgICAg\nICAgICAgICAgICAgICAgZ2V0Rm9yZWlnbktleSgpKTsKICAgICAgICAgICAg\nfSBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTWV0YURhdGFFeGNl\ncHRpb24oX2xvYy5nZXQoIm5vdC1pbnYtcmVsYXRpb24iLAogICAgICAgICAg\nICAgICAgICAgIGZpZWxkLCBtYXBwZWQpKTsKCiAgICAgICAgICAgIGZpZWxk\nLnNldFVzZUNsYXNzQ3JpdGVyaWEoY3JpdGVyaWEpOwogICAgICAgICAgICBy\nZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2Fy\neSB0byBzdXBwb3J0IG9wZW5qcGEgMyBtYXBwaW5ncywgd2hpY2ggZGlkbid0\nCiAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIHNlY29uZGFyeSB0\nYWJsZSBqb2lucyBhbmQgcmVsYXRpb25zIGJ1aWx0CiAgICAgICAgLy8gYXJv\ndW5kIGFuIGludmVyc2Uga2V5OiBjaGVjayB0byBzZWUgaWYgd2UncmUgbWFw\ncGVkIGFzIGEgc2Vjb25kYXJ5CiAgICAgICAgLy8gdGFibGUgam9pbiBidXQg\nd2UncmUgaW4gdGhlIHRhYmxlIG9mIHRoZSByZWxhdGVkIHR5cGUsIGFuZCBp\nZiBzbwogICAgICAgIC8vIHN3aXRjaCBvdXIgam9pbiBtYXBwaW5nIGluZm8g\ndG8gb3VyIHZhbHVlIG1hcHBpbmcgaW5mbwogICAgICAgIFN0cmluZyB0YWJs\nZU5hbWUgPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldFRhYmxlTmFtZSgp\nOwogICAgICAgIFRhYmxlIHRhYmxlID0gZmllbGQuZ2V0VHlwZU1hcHBpbmco\nKS5nZXRUYWJsZSgpOwogICAgICAgIFZhbHVlTWFwcGluZ0luZm8gdmluZm8g\nPSBmaWVsZC5nZXRWYWx1ZUluZm8oKTsKICAgICAgICBpZiAodGFibGVOYW1l\nICE9IG51bGwgJiYgdGFibGUgIT0gbnVsbAogICAgICAgICAgICAmJiAodGFi\nbGVOYW1lLmVxdWFsc0lnbm9yZUNhc2UodGFibGUuZ2V0TmFtZSgpKQogICAg\nICAgICAgICB8fCB0YWJsZU5hbWUuZXF1YWxzSWdub3JlQ2FzZSh0YWJsZS5n\nZXRGdWxsTmFtZSgpKSkpIHsKICAgICAgICAgICAgdmluZm8uc2V0Sm9pbkRp\ncmVjdGlvbihNYXBwaW5nSW5mby5KT0lOX0lOVkVSU0UpOwogICAgICAgICAg\nICB2aW5mby5zZXRDb2x1bW5zKGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuZ2V0\nQ29sdW1ucygpKTsKICAgICAgICAgICAgZmllbGQuZ2V0TWFwcGluZ0luZm8o\nKS5zZXRUYWJsZU5hbWUobnVsbCk7CiAgICAgICAgICAgIGZpZWxkLmdldE1h\ncHBpbmdJbmZvKCkuc2V0Q29sdW1ucyhudWxsKTsKICAgICAgICB9CgogICAg\nICAgIGZpZWxkLm1hcEpvaW4oYWRhcHQsIGZhbHNlKTsKICAgICAgICBpZiAo\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5pc01hcHBlZCgpKSB7CiAgICAgICAg\nICAgIEZvcmVpZ25LZXkgZmsgPSB2aW5mby5nZXRUeXBlSm9pbihmaWVsZCwg\nZmllbGQuZ2V0TmFtZSgpLCB0cnVlLAogICAgICAgICAgICAgICAgYWRhcHQp\nOwogICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWduS2V5KGZrKTsKICAgICAg\nICAgICAgZmllbGQuc2V0Q29sdW1uSU8odmluZm8uZ2V0Q29sdW1uSU8oKSk7\nCiAgICAgICAgICAgIGlmICh2aW5mby5nZXRKb2luRGlyZWN0aW9uKCkgPT0g\ndmluZm8uSk9JTl9JTlZFUlNFKQogICAgICAgICAgICAgICAgZmllbGQuc2V0\nSm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAgICAgIH0g\nZWxzZQogICAgICAgICAgICBSZWxhdGlvblN0cmF0ZWdpZXMubWFwUmVsYXRp\nb25Ub1VubWFwcGVkUEMoZmllbGQsIGZpZWxkLmdldE5hbWUoKSwKICAgICAg\nICAgICAgICAgIGFkYXB0KTsKCiAgICAgICAgZmllbGQuc2V0VXNlQ2xhc3ND\ncml0ZXJpYShjcml0ZXJpYSk7CiAgICAgICAgZmllbGQubWFwUHJpbWFyeUtl\neShhZGFwdCk7CiAgICAgICAgUHJpbWFyeUtleSBwayA9IGZpZWxkLmdldFRh\nYmxlKCkuZ2V0UHJpbWFyeUtleSgpOwogICAgICAgIGlmIChmaWVsZC5pc1By\naW1hcnlLZXkoKSkgewogICAgICAgICAgICBDb2x1bW5bXSBjb2xzID0gZmll\nbGQuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocGsgIT0gbnVsbCAm\nJiAoYWRhcHQgfHwgcGsuaXNMb2dpY2FsKCkpKQogICAgICAgICAgICAgICAg\nZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAgICAg\nICAgICAgICAgICAgIHBrLmFkZENvbHVtbihjb2xzW2ldKTsKICAgICAgICAg\nICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAg\nICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkuc2V0Sm9p\nbmFibGUoY29sc1tpXSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBt\nYXAgY29uc3RyYWludHMgYWZ0ZXIgcGsgc28gd2UgZG9uJ3QgcmUtaW5kZXgg\nLyByZS11bmlxdWUgcGsgY29sCiAgICAgICAgZmllbGQubWFwQ29uc3RyYWlu\ndHMoZmllbGQuZ2V0TmFtZSgpLCBhZGFwdCk7CiAgICB9CgogICAgLyoqCiAg\nICAgKiBSZXR1cm4gd2hldGhlciBvdXIgZGVmaW5pbmcgbWFwcGluZyBpcyBh\nbiB1bmpvaW5lZCBzdWJjbGFzcyBvZgogICAgICogdGhlIHR5cGUgb2YgdGhl\nIGdpdmVuIHZhbHVlLgogICAgICovCiAgICBwcml2YXRlIGJvb2xlYW4gaXNU\neXBlVW5qb2luZWRTdWJjbGFzcyhWYWx1ZU1hcHBpbmcgbWFwcGVkKSB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGRlZiA9IGZpZWxkLmdldERlZmluaW5nTWFw\ncGluZygpOwogICAgICAgIGZvciAoOyBkZWYgIT0gbnVsbDsgZGVmID0gZGVm\nLmdldEpvaW5hYmxlUENTdXBlcmNsYXNzTWFwcGluZygpKQogICAgICAgICAg\nICBpZiAoZGVmID09IG1hcHBlZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAg\nICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIGluaXRpYWxpemUoKSB7CiAgICAgICAg\nZmllbGQuc2V0VXNlc0ludGVybWVkaWF0ZSh0cnVlKTsKCiAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBp\nZiAoZmsgPT0gbnVsbCkKICAgICAgICAgICAgX2ZrT2lkID0gQm9vbGVhbi5U\nUlVFOwogICAgICAgIGVsc2UgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24o\nKSAhPSBGaWVsZE1hcHBpbmcuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICBf\nZmtPaWQgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpLmlzRm9yZWlnbktleU9i\namVjdElkKGZrKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbnNlcnQoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5h\nZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAg\nIGlmIChmaWVsZC5nZXRNYXBwZWRCeSgpICE9IG51bGwpCiAgICAgICAgICAg\nIHJldHVybjsKCiAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBS\nZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyCiAgICAgICAgICAg\nIChzbS5mZXRjaE9iamVjdEZpZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9y\nZS5nZXRDb250ZXh0KCkpOwogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICB1\ncGRhdGVJbnZlcnNlKHNtLCByZWwsIHN0b3JlLCBybSk7CiAgICAgICAgZWxz\nZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3coc20sIHN0\nb3JlLCBybSwgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAgICAgICBpZiAo\ncm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWdu\nS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIHZv\naWQgdXBkYXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBz\ndG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0\naW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxs\nKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncgogICAgICAgICAgICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJ\nbmRleCgpKSwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKCiAgICAgICAgaWYgKGZp\nZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0Up\nIHsKICAgICAgICAgICAgbnVsbEludmVyc2Uoc20sIHJtKTsKICAgICAgICAg\nICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAgICAg\nIH0gZWxzZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3co\nc20sIHN0b3JlLCBybSwgUm93LkFDVElPTl9VUERBVEUpOwogICAgICAgICAg\nICBpZiAocm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRG\nb3JlaWduS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgZGVsZXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNT\ndG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAh\nPSBudWxsKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7\nCiAgICAgICAgICAgIGlmIChzbS5nZXRMb2FkZWQoKS5nZXQoZmllbGQuZ2V0\nSW5kZXgoKSkpIHsKICAgICAgICAgICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFn\nZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihz\nbS4KICAgICAgICAgICAgICAgICAgICBmZXRjaE9iamVjdEZpZWxkKGZpZWxk\nLmdldEluZGV4KCkpLCBzdG9yZS5nZXRDb250ZXh0KCkpOwogICAgICAgICAg\nICAgICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAg\nICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG51bGxJbnZlcnNlKHNt\nLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmllbGQuZGVs\nZXRlUm93KHNtLCBzdG9yZSwgcm0pOwoKICAgICAgICAgICAgLy8gaWYgb3Vy\nIGZvcmVpZ24ga2V5IGhhcyBhIGRlbGV0ZSBhY3Rpb24sIHdlIG5lZWQgdG8g\nc2V0IHRoZQogICAgICAgICAgICAvLyByZWxhdGVkIG9iamVjdCBzbyBjb25z\ndHJhaW50cyBjYW4gYmUgZXZhbHVhdGVkCiAgICAgICAgICAgIE9wZW5KUEFT\ndGF0ZU1hbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRl\nTWFuYWdlcgogICAgICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0RmllbGQo\nZmllbGQuZ2V0SW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAg\nICAgICAgIGlmIChyZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKENsYXNzTWFwcGlu\nZykKICAgICAgICAgICAgICAgICAgICByZWwuZ2V0TWV0YURhdGEoKSk7CiAg\nICAgICAgICAgICAgICBpZiAoZmsuZ2V0RGVsZXRlQWN0aW9uKCkgPT0gRm9y\nZWlnbktleS5BQ1RJT05fUkVTVFJJQ1QgfHwKICAgICAgICAgICAgICAgICAg\nICBmay5nZXREZWxldGVBY3Rpb24oKSA9PSBGb3JlaWduS2V5LkFDVElPTl9D\nQVNDQURFKSB7CiAgICAgICAgICAgICAgICAgICAgUm93IHJvdyA9IGZpZWxk\nLmdldFJvdyhzbSwgc3RvcmUsIHJtLCBSb3cuQUNUSU9OX0RFTEVURSk7CiAg\nICAgICAgICAgICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIG51bGws\nIHJlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAg\nICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBOdWxsIGludmVyc2UgcmVsYXRp\nb25zIHRoYXQgcmVmZXJlbmNlIHRoZSBnaXZlbiBvYmplY3QuCiAgICAgKi8K\nICAgIHByaXZhdGUgdm9pZCBudWxsSW52ZXJzZShPcGVuSlBBU3RhdGVNYW5h\nZ2VyIHNtLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNl\ncHRpb24gewogICAgICAgIGlmIChmaWVsZC5nZXRVc2VDbGFzc0NyaXRlcmlh\nKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgRm9yZWlnbktleSBm\nayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBDb2x1bW5JTyBp\nbyA9IGZpZWxkLmdldENvbHVtbklPKCk7CiAgICAgICAgaWYgKCFpby5pc0Fu\neVVwZGF0YWJsZShmaywgdHJ1ZSkpCiAgICAgICAgICAgIHJldHVybjsKCiAg\nICAgICAgLy8gbnVsbCBpbnZlcnNlIGlmIG5vdCBhbHJlYWR5IGVuZm9yY2Vk\nIGJ5IGZrCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1h\ncHBpbmdzKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0\naW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwogICAgICAgIFJv\ndyByb3cgPSBybS5nZXRBbGxSb3dzKGZrLmdldFRhYmxlKCksIFJvdy5BQ1RJ\nT05fVVBEQVRFKTsKICAgICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgaW8s\nIG51bGwpOwogICAgICAgIHJvdy53aGVyZUZvcmVpZ25LZXkoZmssIHNtKTsK\nICAgICAgICBybS5mbHVzaEFsbFJvd3Mocm93KTsKICAgIH0KCiAgICAvKioK\nICAgICAqIFRoaXMgbWV0aG9kIHVwZGF0ZXMgdGhlIGludmVyc2UgY29sdW1u\ncyBvZiBvdXIgcmVsYXRpb24KICAgICAqIHdpdGggdGhlIGdpdmVuIG9iamVj\ndC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIHVwZGF0ZUludmVyc2UoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgT3BlbkpQQVN0YXRlTWFuYWdlciByZWws\nCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChyZWwgPT0g\nbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBGb3JlaWduS2V5\nIGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbHVtbklP\nIGlvID0gZmllbGQuZ2V0Q29sdW1uSU8oKTsKCiAgICAgICAgaW50IGFjdGlv\nbjsKICAgICAgICBpZiAocmVsLmlzTmV3KCkgJiYgIXJlbC5pc0ZsdXNoZWQo\nKSkgewogICAgICAgICAgICBpZiAoc20uaXNEZWxldGVkKCkgfHwgIWlvLmlz\nQW55SW5zZXJ0YWJsZShmaywgZmFsc2UpKQogICAgICAgICAgICAgICAgcmV0\ndXJuOwogICAgICAgICAgICBhY3Rpb24gPSBSb3cuQUNUSU9OX0lOU0VSVDsK\nICAgICAgICB9IGVsc2UgaWYgKHJlbC5pc0RlbGV0ZWQoKSkgewogICAgICAg\nICAgICBpZiAocmVsLmlzRmx1c2hlZCgpIHx8ICFzbS5pc0RlbGV0ZWQoKSkK\nICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0g\nUm93LkFDVElPTl9ERUxFVEU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAg\nICAgaWYgKHNtLmlzRGVsZXRlZCgpKQogICAgICAgICAgICAgICAgc20gPSBu\ndWxsOwogICAgICAgICAgICBpZiAoIWlvLmlzQW55VXBkYXRhYmxlKGZrLCBz\nbSA9PSBudWxsKSkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAg\nICAgYWN0aW9uID0gUm93LkFDVElPTl9VUERBVEU7CiAgICAgICAgfQoKICAg\nICAgICBpZiAoZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5s\nZW5ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVn\naWVzLnVuaW52ZXJzYWJsZShmaWVsZCk7CgogICAgICAgIC8vIGdldCB0aGUg\ncm93IGZvciB0aGUgaW52ZXJzZSBvYmplY3Q7IHRoZSByb3cgbWlnaHQgYmUg\naW4gYSBzZWNvbmRhcnkKICAgICAgICAvLyB0YWJsZSBpZiB0aGVyZSBpcyBh\nIGZpZWxkIGNvbnRyb2xsaW5nIHRoZSBmb3JlaWduIGtleQogICAgICAgIFJv\ndyByb3cgPSBudWxsOwogICAgICAgIEZpZWxkTWFwcGluZ1tdIGludnMgPSBm\naWVsZC5nZXRJbnZlcnNlTWFwcGluZ3MoKTsKICAgICAgICBmb3IgKGludCBp\nID0gMDsgaSA8IGludnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYg\nKGludnNbaV0uZ2V0TWFwcGVkQnlNZXRhRGF0YSgpID09IGZpZWxkCiAgICAg\nICAgICAgICAgICAmJiBpbnZzW2ldLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5\ncGVzLlBDKSB7CiAgICAgICAgICAgICAgICByb3cgPSBpbnZzW2ldLmdldFJv\ndyhyZWwsIHN0b3JlLCBybSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIGJy\nZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIENsYXNzTWFw\ncGluZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAg\nICAgICBpZiAocm93ID09IG51bGwpCiAgICAgICAgICAgIHJvdyA9IHJtLmdl\ndFJvdyhyZWxNYXBwaW5nLmdldFRhYmxlKCksIGFjdGlvbiwgcmVsLCB0cnVl\nKTsKCiAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiB1cGRhdGUsIHRoaXMgbWln\naHQgYmUgdGhlIG9ubHkgbW9kIHRvIHRoZSByb3csIHNvCiAgICAgICAgLy8g\nbWFrZSBzdXJlIHRoZSB3aGVyZSBjb25kaXRpb24gaXMgc2V0CiAgICAgICAg\naWYgKGFjdGlvbiA9PSBSb3cuQUNUSU9OX1VQREFURQogICAgICAgICAgICAm\nJiByb3cuZ2V0VGFibGUoKSA9PSByZWxNYXBwaW5nLmdldFRhYmxlKCkpCiAg\nICAgICAgICAgIHJvdy53aGVyZVByaW1hcnlLZXkocmVsKTsKCiAgICAgICAg\nLy8gdXBkYXRlIHRoZSBpbnZlcnNlIHBvaW50ZXIgd2l0aCBvdXIgb2lkIHZh\nbHVlCiAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIGlvLCBzbSk7CiAg\nICB9CgogICAgcHVibGljIGludCBzdXBwb3J0c1NlbGVjdChTZWxlY3Qgc2Vs\nLCBpbnQgdHlwZSwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwKICAgICAgICBK\nREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gp\nIHsKICAgICAgICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9KT0lOTEVTUykK\nICAgICAgICAgICAgcmV0dXJuIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkg\nIT0gZmllbGQuSk9JTl9JTlZFUlNFCiAgICAgICAgICAgICAgICAmJiBzZWwu\naXNTZWxlY3RlZChmaWVsZC5nZXRUYWJsZSgpKSkgPyAxIDogMDsKICAgICAg\nICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9UV09fUEFSVCkKICAgICAgICAg\nICAgcmV0dXJuIDE7CgogICAgICAgIC8vIGFscmVhZHkgY2FjaGVkPwogICAg\nICAgIGlmIChzbSAhPSBudWxsKSB7CiAgICAgICAgICAgIE9iamVjdCBvaWQg\nPSBzbS5nZXRJbnRlcm1lZGlhdGUoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAg\nICAgICAgIGlmIChzdG9yZS5nZXRDb250ZXh0KCkuZmluZENhY2hlZChvaWQs\nIG51bGwpICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAg\nICAgICB9CgogICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIHN3aXRjaCAo\ndHlwZSkgewogICAgICAgICAgICBjYXNlIFNlbGVjdC5FQUdFUl9QQVJBTExF\nTDoKICAgICAgICAgICAgICAgIHJldHVybiBjbHNzLmxlbmd0aDsKICAgICAg\nICAgICAgY2FzZSBTZWxlY3QuRUFHRVJfT1VURVI6CiAgICAgICAgICAgICAg\nICByZXR1cm4gKGNsc3MubGVuZ3RoID09IDEgJiYgc3RvcmUuZ2V0REJEaWN0\naW9uYXJ5KCkuY2FuT3V0ZXJKb2luCiAgICAgICAgICAgICAgICAgICAgKHNl\nbC5nZXRKb2luU3ludGF4KCksIGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzc1sw\nXSkpKSA/IDEgOgogICAgICAgICAgICAgICAgICAgIDA7CiAgICAgICAgICAg\nIGNhc2UgU2VsZWN0LkVBR0VSX0lOTkVSOgogICAgICAgICAgICAgICAgcmV0\ndXJuIChjbHNzLmxlbmd0aCA9PSAxKSA/IDEgOiAwOwogICAgICAgICAgICBk\nZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIHNlbGVjdEVhZ2VyUGFyYWxsZWwoU2Vs\nZWN0RXhlY3V0b3Igc2VsLAogICAgICAgIGZpbmFsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sIGZpbmFsIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBmaW5h\nbCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBmaW5hbCBpbnQgZWFn\nZXJNb2RlKSB7CiAgICAgICAgZmluYWwgQ2xhc3NNYXBwaW5nW10gY2xzcyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAg\naWYgKCEoc2VsIGluc3RhbmNlb2YgVW5pb24pKQogICAgICAgICAgICBzZWxl\nY3RFYWdlclBhcmFsbGVsKChTZWxlY3QpIHNlbCwgY2xzc1swXSwgc3RvcmUs\nIGZldGNoLCBlYWdlck1vZGUpOwogICAgICAgIGVsc2UgewogICAgICAgICAg\nICBVbmlvbiB1bmlvbiA9IChVbmlvbikgc2VsOwogICAgICAgICAgICBpZiAo\nZmV0Y2guZ2V0U3ViY2xhc3NGZXRjaE1vZGUgKGZpZWxkLmdldFR5cGVNYXBw\naW5nKCkpIAogICAgICAgICAgICAgICAgIT0gSkRCQ0ZldGNoQ29uZmlndXJh\ndGlvbi5FQUdFUl9KT0lOKQogICAgICAgICAgICAgICAgdW5pb24uYWJvcnRV\nbmlvbigpOwogICAgICAgICAgICB1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNl\nbGVjdG9yKCkgewogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0\nKFNlbGVjdCBzZWwsIGludCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICBz\nZWxlY3RFYWdlclBhcmFsbGVsKHNlbCwgY2xzc1tpZHhdLCBzdG9yZSwgZmV0\nY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGVhZ2VyTW9kZSk7CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0K\nCiAgICAvKioKICAgICAqIFBlcmZvcm0gYW4gZWFnZXIgcGFyYWxsZWwgc2Vs\nZWN0LgogICAgICovCiAgICBwcml2YXRlIHZvaWQgc2VsZWN0RWFnZXJQYXJh\nbGxlbChTZWxlY3Qgc2VsLCBDbGFzc01hcHBpbmcgY2xzLAogICAgICAgIEpE\nQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwg\naW50IGVhZ2VyTW9kZSkgewogICAgICAgIHNlbC5zZWxlY3RQcmltYXJ5S2V5\nKGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpKTsKICAgICAgICAvLyBzZXQg\nYSB2YXJpYWJsZSBuYW1lIHRoYXQgZG9lcyBub3QgY29uZmxpY3Qgd2l0aCBh\nbnkgaW4gdGhlIHF1ZXJ5OwogICAgICAgIC8vIHVzaW5nIGEgdmFyaWFibGUg\nZ3VhcmFudGVlcyB0aGF0IHRoZSBzZWxlY3RlZCBkYXRhIHdpbGwgdXNlIGRp\nZmZlcmVudAogICAgICAgIC8vIGFsaWFzZXMgYW5kIGpvaW5zIHRoYW4gYW55\nIGV4aXN0aW5nIFdIRVJFIGNvbmRpdGlvbnMgb24gdGhpcyBmaWVsZAogICAg\nICAgIC8vIHRoYXQgbWlnaHQgb3RoZXJ3aXNlIGxpbWl0IHRoZSByZWxhdGlv\nbnMgdGhhdCBtYXRjaAogICAgICAgIEpvaW5zIGpvaW5zID0gc2VsLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNscywgdHJ1ZSk7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdlck1v\nZGUsIAogICAgICAgICAgICBqb2lucyk7CiAgICB9CgogICAgcHVibGljIHZv\naWQgc2VsZWN0RWFnZXJKb2luKFNlbGVjdCBzZWwsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hD\nb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJNb2RlKSB7CiAgICAgICAg\nLy8gbGltaXQgdGhlIGVhZ2VyIG1vZGUgdG8gc2luZ2xlIG9uIHJlY3Vyc2l2\nZSBlYWdlciBmZXRjaGluZyBiL2MKICAgICAgICAvLyBhdCB0aGlzIHBvaW50\nIHRoZSBzZWxlY3QgaGFzIGJlZW4gbW9kaWZpZWQgYW5kIGFuIGF0dGVtcHQg\ndG8KICAgICAgICAvLyBjbG9uZSBpdCBmb3IgYSB0by1tYW55IGVhZ2VyIHNl\nbGVjdCBjYW4gcmVzdWx0IGluIGEgY2xvbmUgdGhhdAogICAgICAgIC8vIHBy\nb2R1Y2VzIGludmFsaWQgU1FMCiAgICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07CiAgICAg\nICAgYm9vbGVhbiBmb3JjZUlubmVyID0gZmV0Y2guaGFzRmV0Y2hJbm5lckpv\naW4oZmllbGQuZ2V0RnVsbE5hbWUoZmFsc2UpKSA/CiAgICAgICAgICAgICAg\nICB0cnVlIDogZmFsc2U7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLAogICAgICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4sCiAgICAg\nICAgICAgIGVhZ2VySm9pbihzZWwubmV3Sm9pbnMoKSwgY2xzLCBmb3JjZUlu\nbmVyKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgdGhlIGpvaW5zIG5l\nZWRlZCB0byBzZWxlY3QvbG9hZCBlYWdlciBkYXRhLgogICAgICovCiAgICBw\ncml2YXRlIEpvaW5zIGVhZ2VySm9pbihKb2lucyBqb2lucywgQ2xhc3NNYXBw\naW5nIGNscywgYm9vbGVhbiBmb3JjZUlubmVyKSB7CiAgICAgICAgYm9vbGVh\nbiBpbnZlcnNlID0gZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRTsKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAg\nICAgICAgam9pbnMgPSBqb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAg\nIGpvaW5zID0gc2V0RW1iZWRkZWRWYXJpYWJsZShqb2lucyk7CiAgICAgICAg\nfQoKICAgICAgICAvLyBhbmQgam9pbiBpbnRvIHJlbGF0aW9uCiAgICAgICAg\nRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzKTsKICAg\nICAgICBpZiAoIWZvcmNlSW5uZXIgJiYgZmllbGQuZ2V0TnVsbFZhbHVlKCkg\nIT0gRmllbGRNYXBwaW5nLk5VTExfRVhDRVBUSU9OKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgp\nLCBmaywgZmllbGQuCiAgICAgICAgICAgICAgICBnZXRUeXBlTWFwcGluZygp\nLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZhbHNl\nKTsKICAgICAgICByZXR1cm4gam9pbnMuam9pblJlbGF0aW9uKGZpZWxkLmdl\ndE5hbWUoKSwgZmssIGZpZWxkLmdldFR5cGVNYXBwaW5nKCksIAogICAgICAg\nICAgICBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZh\nbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIElmIGpvaW5pbmcgZnJvbSBh\nbiBlbWJlZGRlZCBvd25lciwgdXNlIHZhcmlhYmxlIHRvIGNyZWF0ZSBhIHVu\naXF1ZQogICAgICogYWxpYXMgaW4gY2FzZSBvd25lciBjb250YWlucyBvdGhl\nciBzYW1lLXR5cGVkIGVtYmVkZGVkIHJlbGF0aW9ucy4KICAgICAqLwogICAg\ncHJpdmF0ZSBKb2lucyBzZXRFbWJlZGRlZFZhcmlhYmxlKEpvaW5zIGpvaW5z\nKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldERlZmluaW5nTWV0YURhdGEoKS5n\nZXRFbWJlZGRpbmdNZXRhRGF0YSgpID09IG51bGwpCiAgICAgICAgICAgIHJl\ndHVybiBqb2luczsKICAgICAgICByZXR1cm4gam9pbnMuc2V0VmFyaWFibGUo\nZmllbGQuZ2V0RGVmaW5pbmdNZXRhRGF0YSgpLgogICAgICAgICAgICBnZXRF\nbWJlZGRpbmdNZXRhRGF0YSgpLmdldEZpZWxkTWV0YURhdGEoKS5nZXROYW1l\nKCkpOwogICAgfQoKICAgIHB1YmxpYyBpbnQgc2VsZWN0KFNlbGVjdCBzZWws\nIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJN\nb2RlKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9\nPSBmaWVsZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybiAtMTsK\nICAgICAgICAvLyBhbHJlYWR5IGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNt\nICE9IG51bGwgJiYgc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4\nKCkpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBp\nZiAoIUJvb2xlYW4uVFJVRS5lcXVhbHMoX2ZrT2lkKSkKICAgICAgICAgICAg\ncmV0dXJuIC0xOwogICAgICAgIHNlbC5zZWxlY3QoZmllbGQuZ2V0Q29sdW1u\ncygpLCBmaWVsZC5qb2luKHNlbCkpOwogICAgICAgIHJldHVybiAwOwogICAg\nfQoKICAgIHB1YmxpYyBPYmplY3QgbG9hZEVhZ2VyUGFyYWxsZWwoT3BlbkpQ\nQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpE\nQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIE9iamVjdCByZXMpCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gcHJvY2VzcyBi\nYXRjaGVkIHJlc3VsdHMgaWYgd2UgaGF2ZW4ndCBhbHJlYWR5CiAgICAgICAg\nTWFwIHJlbHM7CiAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFJlc3VsdCkK\nICAgICAgICAgICAgcmVscyA9IHByb2Nlc3NFYWdlclBhcmFsbGVsUmVzdWx0\nKHNtLCBzdG9yZSwgZmV0Y2gsIChSZXN1bHQpIHJlcyk7CiAgICAgICAgZWxz\nZQogICAgICAgICAgICByZWxzID0gKE1hcCkgcmVzOwoKICAgICAgICAvLyBz\ndG9yZSBvYmplY3QgZm9yIHRoaXMgb2lkIGluIGluc3RhbmNlCiAgICAgICAg\nc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgcmVscy5yZW1vdmUo\nc20uZ2V0T2JqZWN0SWQoKSkpOwogICAgICAgIHJldHVybiByZWxzOwogICAg\nfQoKICAgIC8qKgogICAgICogUHJvY2VzcyB0aGUgZ2l2ZW4gYmF0Y2hlZCBy\nZXN1bHQuCiAgICAgKi8KICAgIHByaXZhdGUgTWFwIHByb2Nlc3NFYWdlclBh\ncmFsbGVsUmVzdWx0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAg\nSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNo\nLCBSZXN1bHQgcmVzKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewog\nICAgICAgIC8vIGRvIHNhbWUgam9pbnMgYXMgZm9yIGxvYWQKICAgICAgICAv\nLyMjIyBjaGVhdDogd2Uga25vdyB0eXBpY2FsIHJlc3VsdCBqb2lucyBvbmx5\nIGNhcmUgYWJvdXQgdGhlIHJlbGF0aW9uCiAgICAgICAgLy8jIyMgcGF0aDsg\ndGh1cyB3ZSBjYW4gaWdub3JlIGRpZmZlcmVudCBtYXBwaW5ncwogICAgICAg\nIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5\ncGVNYXBwaW5ncygpOwogICAgICAgIEpvaW5zIGpvaW5zID0gcmVzLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNsc3NbMF0sIHRydWUpOwoKICAgICAgICBNYXAgcmVscyA9IG5ldyBI\nYXNoTWFwKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIG93bmVyID0gZmllbGQu\nZ2V0RGVmaW5pbmdNYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIGNs\nczsKICAgICAgICBPYmplY3Qgb2lkOwogICAgICAgIHdoaWxlIChyZXMubmV4\ndCgpKSB7CiAgICAgICAgICAgIGNscyA9IHJlcy5nZXRCYXNlTWFwcGluZygp\nOwogICAgICAgICAgICBpZiAoY2xzID09IG51bGwpCiAgICAgICAgICAgICAg\nICBjbHMgPSBjbHNzWzBdOwogICAgICAgICAgICBvaWQgPSBvd25lci5nZXRP\nYmplY3RJZChzdG9yZSwgcmVzLCBudWxsLCB0cnVlLCBudWxsKTsKICAgICAg\nICAgICAgcmVscy5wdXQob2lkLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRj\naCwgam9pbnMpKTsKICAgICAgICB9CiAgICAgICAgcmVzLmNsb3NlKCk7Cgog\nICAgICAgIHJldHVybiByZWxzOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxv\nYWRFYWdlckpvaW4oT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3Jl\nIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gs\nIFJlc3VsdCByZXMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9IGZpZWxkLmdldEluZGVwZW5kZW50\nVHlwZU1hcHBpbmdzKClbMF07CgogICAgICAgIC8vIGZvciBpbnZlcnNlRWFn\nZXIgZmllbGQKICAgICAgICBGaWVsZE1hcHBpbmcgbWFwcGVkQnlGaWVsZE1h\ncHBpbmcgPSBmaWVsZC5nZXRNYXBwZWRCeU1hcHBpbmcoKTsKICAgICAgICBQ\nZXJzaXN0ZW5jZUNhcGFibGUgbWFwcGVkQnlWYWx1ZSA9IG51bGw7CgogICAg\nICAgIGlmIChtYXBwZWRCeUZpZWxkTWFwcGluZyAhPSBudWxsKSB7CiAgICAg\nICAgICAgIFZhbHVlTWFwcGluZyB2YWwgPSBtYXBwZWRCeUZpZWxkTWFwcGlu\nZy5nZXRWYWx1ZU1hcHBpbmcoKTsKICAgICAgICAgICAgQ2xhc3NNZXRhRGF0\nYSBkZWNNZXRhID0gdmFsLmdldFR5cGVNZXRhRGF0YSgpOwogICAgICAgICAg\nICAvLyBlYWdlciBsb2FkaW5nIGEgY2hpbGQgZnJvbSBpdHMgdG9PbmUgcGFy\nZW50IGFuZAogICAgICAgICAgICAvLyB0aGUgcGFyZW50IGhhcyBAT25lVG9P\nbmUobWFwcGVkQnk9InBhcmVudCIpIGNoaWxkIHJlbGF0aW9uLgogICAgICAg\nICAgICAvLyBCeSBzYXZpbmcgdGhlIG1hcHBlZC1ieSBpbmZvIGluICdyZXMn\nIGlzIHRvCiAgICAgICAgICAgIC8vIGF2b2lkIHVubmVlZGVkIFNRTCBwdXNo\nZG93biB0aGF0IHdvdWxkIG90aGVyd2lzZSBnZXRzCiAgICAgICAgICAgIC8v\nIGdlbmVyYXRlZC4KICAgICAgICAgICAgaWYgKGRlY01ldGEgIT0gbnVsbCkg\newogICAgICAgICAgICAgICAgbWFwcGVkQnlWYWx1ZSA9IHNtLmdldFBlcnNp\nc3RlbmNlQ2FwYWJsZSgpOwogICAgICAgICAgICAgICAgcmVzLnNldE1hcHBl\nZEJ5RmllbGRNYXBwaW5nKG1hcHBlZEJ5RmllbGRNYXBwaW5nKTsKICAgICAg\nICAgICAgICAgIHJlcy5zZXRNYXBwZWRCeVZhbHVlKG1hcHBlZEJ5VmFsdWUp\nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzbS5zdG9yZU9i\namVjdChmaWVsZC5nZXRJbmRleCgpLCByZXMubG9hZChjbHMsIHN0b3JlLCBm\nZXRjaCwKICAgICAgICBlYWdlckpvaW4ocmVzLm5ld0pvaW5zKCksIGNscywg\nZmFsc2UpKSk7CgogICAgICAgIC8vIHJlc2V0IG1hcHBlZCBieSBpcyBuZWVk\nZWQgZm9yIE9uZVRvT25lIGJpZGlyZWN0aW9uYWwgcmVsYXRpb25zCiAgICAg\nICAgLy8gaGF2aW5nIGEgbWFwcGVkLWJ5IHBhcmVudCB0byBjb3JyZWN0bHkg\nc2V0IHRoZSBwYXJlbnQtY2hpbGQKICAgICAgICAvLyByZWxhdGlvbi4KICAg\nICAgICByZXMuc2V0TWFwcGVkQnlGaWVsZE1hcHBpbmcobnVsbCk7CiAgICAg\nICAgcmVzLnNldE1hcHBlZEJ5VmFsdWUobnVsbCk7CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgbG9hZChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBKREJDU3Rv\ncmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRj\naCwgUmVzdWx0IHJlcykKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0aW9uIHsK\nICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIC8v\nIGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNtICE9IG51bGwgJiYgc20uZ2V0\nSW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpICE9IG51bGwpCiAgICAg\nICAgICAgIHJldHVybjsKICAgICAgICBpZiAoIUJvb2xlYW4uVFJVRS5lcXVh\nbHMoX2ZrT2lkKSkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmICgh\ncmVzLmNvbnRhaW5zQWxsKGZpZWxkLmdldENvbHVtbnMoKSkpCiAgICAgICAg\nICAgIHJldHVybjsKCiAgICAgICAgLy8gZ2V0IHRoZSByZWxhdGVkIG9iamVj\ndCdzIG9pZAogICAgICAgIENsYXNzTWFwcGluZyByZWxNYXBwaW5nID0gZmll\nbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAgICBPYmplY3Qgb2lkID0gbnVs\nbDsKICAgICAgICBpZiAocmVsTWFwcGluZy5pc01hcHBlZCgpKSB7CiAgICAg\nICAgICAgIG9pZCA9IHJlbE1hcHBpbmcuZ2V0T2JqZWN0SWQoc3RvcmUsIHJl\ncywgZmllbGQuZ2V0Rm9yZWlnbktleSgpLAogICAgICAgICAgICAgICAgZmll\nbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1hcHBpbmcuUE9MWV9GQUxT\nRSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgQ29sdW1u\nW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAgICAgaWYg\nKHJlbE1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5n\nLklEX0RBVEFTVE9SRSkgewogICAgICAgICAgICAgICAgbG9uZyBpZCA9IHJl\ncy5nZXRMb25nKGNvbHNbMF0pOwogICAgICAgICAgICAgICAgaWYgKCFyZXMu\nd2FzTnVsbCgpKQogICAgICAgICAgICAgICAgICAgIG9pZCA9IHN0b3JlLm5l\nd0RhdGFTdG9yZUlkKGlkLCByZWxNYXBwaW5nLCB0cnVlKTsKICAgICAgICAg\nICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAgICAvLyBhcHBsaWNhdGlvbiBp\nZAogICAgICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3RoID09IDEpIHsKICAg\nICAgICAgICAgICAgICAgICBPYmplY3QgdmFsID0gcmVzLmdldE9iamVjdChj\nb2xzWzBdLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgICAgICAgICBpZiAo\ndmFsICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgIG9pZCA9IEFw\ncGxpY2F0aW9uSWRzLmZyb21QS1ZhbHVlcyhuZXcgT2JqZWN0W117IHZhbCB9\nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsTWFwcGluZyk7CiAg\nICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIE9i\namVjdFtdIHZhbHMgPSBuZXcgT2JqZWN0W2NvbHMubGVuZ3RoXTsKICAgICAg\nICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGNvbHMubGVuZ3Ro\nOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsc1tpXSA9IHJl\ncy5nZXRPYmplY3QoY29sc1tpXSwgbnVsbCwgbnVsbCk7CiAgICAgICAgICAg\nICAgICAgICAgICAgIGlmICh2YWxzW2ldID09IG51bGwpCiAgICAgICAgICAg\nICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAg\nICAgaWYgKGkgPT0gY29scy5sZW5ndGggLSAxKQogICAgICAgICAgICAgICAg\nICAgICAgICAgICAgb2lkID0gQXBwbGljYXRpb25JZHMuZnJvbVBLVmFsdWVz\nKHZhbHMsIHJlbE1hcHBpbmcpOwogICAgICAgICAgICAgICAgICAgIH0KICAg\nICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAg\nICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAgICAgICBzbS5zdG9yZU9iamVj\ndChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsKICAgICAgICBlbHNlCiAgICAg\nICAgICAgIHNtLnNldEludGVybWVkaWF0ZShmaWVsZC5nZXRJbmRleCgpLCBv\naWQpOwogICAgfQogICAgCiAgICBNYXA8SkRCQ1N0b3JlTWFuYWdlci5TZWxl\nY3RLZXksIE9iamVjdFtdPiByZWxhdGlvbkZpZWxkVW5pb25DYWNoZSA9IG51\nbGw7CiAgICBwdWJsaWMgdm9pZCBsb2FkKGZpbmFsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sIGZpbmFsIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBmaW5h\nbCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoKQogICAgICAgIHRocm93\ncyBTUUxFeGNlcHRpb24gewogICAgICAgIC8vIGNoZWNrIGZvciBjYWNoZWQg\nb2lkIHZhbHVlLCBvciBsb2FkIG9pZCBpZiBubyB3YXkgdG8gam9pbgogICAg\nICAgIGlmIChCb29sZWFuLlRSVUUuZXF1YWxzKF9ma09pZCkpIHsKICAgICAg\nICAgICAgT2JqZWN0IG9pZCA9IHNtLmdldEludGVybWVkaWF0ZShmaWVsZC5n\nZXRJbmRleCgpKTsKICAgICAgICAgICAgaWYgKG9pZCAhPSBudWxsKSB7CiAg\nICAgICAgICAgICAgICBPYmplY3QgdmFsID0gc3RvcmUuZmluZChvaWQsIGZp\nZWxkLCBmZXRjaCk7CiAgICAgICAgICAgICAgICBzbS5zdG9yZU9iamVjdChm\naWVsZC5nZXRJbmRleCgpLCB2YWwpOwogICAgICAgICAgICAgICAgcmV0dXJu\nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmaW5hbCBDbGFz\nc01hcHBpbmdbXSByZWxzID0gZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFw\ncGluZ3MoKTsKICAgICAgICBmaW5hbCBpbnQgc3VicyA9IGZpZWxkLmdldFNl\nbGVjdFN1YmNsYXNzZXMoKTsKICAgICAgICBmaW5hbCBKb2luc1tdIHJlc0pv\naW5zID0gbmV3IEpvaW5zW3JlbHMubGVuZ3RoXTsKCiAgICAgICAgLy9jYWNo\nZSB1bmlvbiBmb3IgZmllbGQgaGVyZQogICAgICAgIC8vc2VsZWN0IGRhdGEg\nZm9yIHRoaXMgc20KICAgICAgICBVbmlvbiB1bmlvbiA9IG51bGw7CiAgICAg\nICAgU2VsZWN0SW1wbCBzZWwgPSBudWxsOwogICAgICAgIExpc3QgcGFybUxp\nc3QgPSBudWxsOwoKICAgICAgICBpZiAoISgoSkRCQ1N0b3JlTWFuYWdlcilz\ndG9yZSkuaXNRdWVyeVNRTENhY2hlT24oKSkKICAgICAgICAgICAgdW5pb24g\nPSBuZXdVbmlvbihzbSwgc3RvcmUsIGZldGNoLCByZWxzLCBzdWJzLCByZXNK\nb2lucyk7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlmIChyZWxhdGlv\nbkZpZWxkVW5pb25DYWNoZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBy\nZWxhdGlvbkZpZWxkVW5pb25DYWNoZSA9CiAgICAgICAgICAgICAgICAgICAg\nKChKREJDU3RvcmVNYW5hZ2VyKSBzdG9yZSkKICAgICAgICAgICAgICAgICAg\nICAgICAgLmdldENhY2hlTWFwRnJvbVF1ZXJ5U1FMQ2FjaGUoUmVsYXRpb25G\naWVsZFN0cmF0ZWd5LmNsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAg\nICBib29sZWFuIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgSkRCQ0ZldGNo\nQ29uZmlndXJhdGlvbiBmZXRjaENsb25lID0gbmV3IEpEQkNGZXRjaENvbmZp\nZ3VyYXRpb25JbXBsKCk7CiAgICAgICAgICAgIGZldGNoQ2xvbmUuY29weShm\nZXRjaCk7CiAgICAgICAgICAgIEpEQkNTdG9yZU1hbmFnZXIuU2VsZWN0S2V5\nIHNlbEtleSA9IAogICAgICAgICAgICAgICAgbmV3IEpEQkNTdG9yZU1hbmFn\nZXIuU2VsZWN0S2V5KG51bGwsIGZpZWxkLCBmZXRjaCk7CiAgICAgICAgICAg\nIE9iamVjdFtdIG9iaiA9IHJlbGF0aW9uRmllbGRVbmlvbkNhY2hlLmdldChz\nZWxLZXkpOwogICAgICAgICAgICBpZiAob2JqICE9IG51bGwpIHsKICAgICAg\nICAgICAgICAgIHVuaW9uID0gKFVuaW9uKSBvYmpbMF07CiAgICAgICAgICAg\nICAgICByZXNKb2luc1swXSA9IChKb2lucylvYmpbMV07CiAgICAgICAgICAg\nIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzeW5jaHJvbml6ZWQocmVsYXRp\nb25GaWVsZFVuaW9uQ2FjaGUpIHsKICAgICAgICAgICAgICAgICAgICBvYmog\nPSByZWxhdGlvbkZpZWxkVW5pb25DYWNoZS5nZXQoc2VsS2V5KTsKICAgICAg\nICAgICAgICAgICAgICBpZiAob2JqICE9IG51bGwpIHsKICAgICAgICAgICAg\nICAgICAgICAgICAgdW5pb24gPSAoVW5pb24pIG9ialswXTsKICAgICAgICAg\nICAgICAgICAgICAgICAgcmVzSm9pbnNbMF0gPSAoSm9pbnMpIG9ialsxXTsK\nICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAg\nICAgICAgICAvLyBzZWxlY3QgcmVsYXRlZCBtYXBwaW5nIGNvbHVtbnM7IGpv\naW5pbmcgZnJvbSB0aGUgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJl\nbGF0ZWQgdHlwZSBiYWNrIHRvIG91ciBmayB0YWJsZSBpZiBub3QgYW4gaW52\nZXJzZSAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFwcGluZyAoaW4g\nd2hpY2ggY2FzZSB3ZSBjYW4ganVzdCBtYWtlIHN1cmUgdGhlIAogICAgICAg\nICAgICAgICAgICAgICAgICAvLyBpbnZlcnNlIGNvbHMgPT0gb3VyIHBrIHZh\nbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgdW5pb24gPSBuZXdVbmlv\nbihzbSwgc3RvcmUsIGZldGNoLCByZWxzLCBzdWJzLCAKICAgICAgICAgICAg\nICAgICAgICAgICAgICAgICAgICByZXNKb2lucyk7CiAgICAgICAgICAgICAg\nICAgICAgICAgIGZvdW5kID0gZmFsc2U7ICAgICAgICAgICAgICAgIAogICAg\nICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZWwgPSAo\nKExvZ2ljYWxVbmlvbi5VbmlvblNlbGVjdCl1bmlvbi5nZXRTZWxlY3RzKClb\nMF0pLgogICAgICAgICAgICAgICAgICAgICAgICBnZXREZWxlZ2F0ZSgpOwog\nICAgICAgICAgICAgICAgICAgIFNRTEJ1ZmZlciBidWYgPSBzZWwuZ2V0U1FM\nKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1ZiA9PSBudWxsKSB7CiAg\nICAgICAgICAgICAgICAgICAgCSgoU2VsZWN0SW1wbClzZWwpLnNldFNRTChz\ndG9yZSwgZmV0Y2gpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9\nIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAg\nICAgICAgLy8gb25seSBjYWNoZSB0aGUgdW5pb24gd2hlbiBlbGVtcyBsZW5n\ndGggaXMgMSBmb3Igbm93CiAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3Vu\nZCAmJiByZWxzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAg\nICAgIE9iamVjdFtdIG9iajEgPSBuZXcgT2JqZWN0WzJdOwogICAgICAgICAg\nICAgICAgICAgICAgICBvYmoxWzBdID0gdW5pb247CiAgICAgICAgICAgICAg\nICAgICAgICAgIG9iajFbMV0gPSByZXNKb2luc1swXTsKICAgICAgICAgICAg\nICAgICAgICAgICAgKChKREJDU3RvcmVNYW5hZ2VyKXN0b3JlKS5hZGRUb1Nx\nbENhY2hlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpb25G\naWVsZFVuaW9uQ2FjaGUsIHNlbEtleSwgb2JqMSk7CiAgICAgICAgICAgICAg\nICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAg\nICAgICAgIExvZyBsb2cgPSBzdG9yZS5nZXRDb25maWd1cmF0aW9uKCkuCiAg\nICAgICAgICAgICAgICBnZXRMb2coSkRCQ0NvbmZpZ3VyYXRpb24uTE9HX0pE\nQkMpOwogICAgICAgICAgICBpZiAobG9nLmlzVHJhY2VFbmFibGVkKCkpewog\nICAgICAgICAgICAgICAgaWYgKGZvdW5kKSAKICAgICAgICAgICAgICAgICAg\nICBsb2cudHJhY2UoX2xvYy5nZXQoImNhY2hlLWhpdCIsIGZpZWxkLCB0aGlz\nLmdldENsYXNzKCkpKTsgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAg\nICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2Uo\nX2xvYy5nZXQoImNhY2hlLW1pc3NlZCIsIGZpZWxkLCB0aGlzLmdldENsYXNz\nKCkpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGFybUxpc3QgPSBu\nZXcgQXJyYXlMaXN0KCk7CiAgICAgICAgICAgIENsYXNzTWFwcGluZyBtYXBw\naW5nID0gZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCk7CiAgICAgICAgICAg\nIE9iamVjdCBvaWQgPSBzbS5nZXRPYmplY3RJZCgpOwogICAgICAgICAgICBD\nb2x1bW5bXSBjb2xzID0gbWFwcGluZy5nZXRQcmltYXJ5S2V5Q29sdW1ucygp\nOwogICAgICAgICAgICBpZiAoc2VsID09IG51bGwpCiAgICAgICAgICAgICAg\nICBzZWwgPSAoKExvZ2ljYWxVbmlvbi5VbmlvblNlbGVjdCl1bmlvbi5nZXRT\nZWxlY3RzKClbMF0pLgogICAgICAgICAgICAgICAgZ2V0RGVsZWdhdGUoKTsK\nCiAgICAgICAgICAgIHNlbC53aGVyZVByaW1hcnlLZXkobWFwcGluZywgY29s\ncywgY29scywgb2lkLCBzdG9yZSwgCiAgICAgICAgICAgIAludWxsLCBudWxs\nLCBwYXJtTGlzdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIFJlc3Vs\ndCByZXMgPSB1bmlvbi5leGVjdXRlKHN0b3JlLCBmZXRjaCwgcGFybUxpc3Qp\nOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIE9iamVjdCB2YWwgPSBudWxs\nOwogICAgICAgICAgICBpZiAocmVzLm5leHQoKSkKICAgICAgICAgICAgICAg\nIHZhbCA9IHJlcy5sb2FkKHJlbHNbcmVzLmluZGV4T2YoKV0sIHN0b3JlLCBm\nZXRjaCwKICAgICAgICAgICAgICAgICAgICByZXNKb2luc1tyZXMuaW5kZXhP\nZigpXSk7CiAgICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldElu\nZGV4KCksIHZhbCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAg\ncmVzLmNsb3NlKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBwcm90ZWN0\nZWQgVW5pb24gbmV3VW5pb24oZmluYWwgT3BlbkpQQVN0YXRlTWFuYWdlciBz\nbSwgCiAgICAgICAgZmluYWwgSkRCQ1N0b3JlIHN0b3JlLCBmaW5hbCBKREJD\nRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCAKICAgICAgICBmaW5hbCBDbGFz\nc01hcHBpbmdbXSByZWxzLCBmaW5hbCBpbnQgc3VicywgCiAgICAgICAgZmlu\nYWwgSm9pbnNbXSByZXNKb2lucykgewogICAgICAgIFVuaW9uIHVuaW9uID0g\nc3RvcmUuZ2V0U1FMRmFjdG9yeSgpLm5ld1VuaW9uKHJlbHMubGVuZ3RoKTsK\nICAgICAgICB1bmlvbi5zZXRFeHBlY3RlZFJlc3VsdENvdW50KDEsIGZhbHNl\nKTsKICAgICAgICBpZiAoZmV0Y2guZ2V0U3ViY2xhc3NGZXRjaE1vZGUoZmll\nbGQuZ2V0VHlwZU1hcHBpbmcoKSkKICAgICAgICAgICAgIT0gSkRCQ0ZldGNo\nQ29uZmlndXJhdGlvbi5FQUdFUl9KT0lOKQogICAgICAgICAgICB1bmlvbi5h\nYm9ydFVuaW9uKCk7CiAgICAgICAgdW5pb24uc2VsZWN0KG5ldyBVbmlvbi5T\nZWxlY3RvcigpIHsKICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0KFNl\nbGVjdCBzZWwsIGludCBpZHgpIHsKICAgICAgICAgICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQog\nICAgICAgICAgICAgICAgICAgIHNlbC53aGVyZUZvcmVpZ25LZXkoZmllbGQu\nZ2V0Rm9yZWlnbktleShyZWxzW2lkeF0pLAogICAgICAgICAgICAgICAgICAg\nICAgICBzbS5nZXRPYmplY3RJZCgpLCBmaWVsZC5nZXREZWZpbmluZ01hcHBp\nbmcoKSwgc3RvcmUpOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAg\nICAgICAgICAgICAgcmVzSm9pbnNbaWR4XSA9IHNlbC5uZXdKb2lucygpLmpv\naW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICAg\nICAgICAgIGZpZWxkLmdldEZvcmVpZ25LZXkocmVsc1tpZHhdKSwgcmVsc1tp\nZHhdLAogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5nZXRTZWxlY3RT\ndWJjbGFzc2VzKCksIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAg\nICAgZmllbGQud2hlcmVQcmltYXJ5S2V5KHNlbCwgc20sIHN0b3JlKTsKICAg\nICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbC5zZWxlY3QocmVs\nc1tpZHhdLCBzdWJzLCBzdG9yZSwgZmV0Y2gsIGZldGNoLkVBR0VSX0pPSU4s\nIAogICAgICAgICAgICAgICAgICAgIHJlc0pvaW5zW2lkeF0pOwogICAgICAg\nICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHVuaW9uOwogICAg\nfQoKICAgIHB1YmxpYyBPYmplY3QgdG9EYXRhU3RvcmVWYWx1ZShPYmplY3Qg\ndmFsLCBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICByZXR1cm4gUmVsYXRp\nb25TdHJhdGVnaWVzLnRvRGF0YVN0b3JlVmFsdWUoZmllbGQsIHZhbCwgc3Rv\ncmUpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGFwcGVuZElzTnVsbChTUUxC\ndWZmZXIgc3FsLCBTZWxlY3Qgc2VsLCBKb2lucyBqb2lucykgewogICAgICAg\nIC8vIGlmIG5vIGludmVyc2UsIGp1c3Qgam9pbiB0byBtYXBwaW5nJ3MgdGFi\nbGUgKHVzdWFsbHkgYSBuby1vcAogICAgICAgIC8vIGJlY2F1c2UgaXQnbGwg\nYmUgaW4gdGhlIHByaW1hcnkgdGFibGUpIGFuZCBzZWUgaWYgZmsgY29scyBh\ncmUgbnVsbDsKICAgICAgICAvLyBpZiBpbnZlcnNlLCB0aGVuIHdlIGhhdmUg\ndG8gZG8gYSBzdWItc2VsZWN0IHRvIHNlZSBpZiBhbnkgaW52ZXJzZQogICAg\nICAgIC8vIG9iamVjdHMgcG9pbnQgYmFjayB0byB0aGlzIGZpZWxkJ3Mgb3du\nZXIKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpICE9IGZp\nZWxkLkpPSU5fSU5WRVJTRSkgewogICAgICAgICAgICAvLyMjIyBwcm9iYWJs\neSBuZWVkIHNvbWUgc29ydCBvZiBzdWJzZWxlY3QgaGVyZSBvbiBmayBjb25z\ndGFudHMKICAgICAgICAgICAgam9pbnMgPSBqb2luKGpvaW5zLCBmYWxzZSk7\nCiAgICAgICAgICAgIENvbHVtbltdIGNvbHMgPSBmaWVsZC5nZXRDb2x1bW5z\nKCk7CiAgICAgICAgICAgIGlmIChjb2xzLmxlbmd0aCA9PSAwKQogICAgICAg\nICAgICAgICAgc3FsLmFwcGVuZCgiMSA8PiAxIik7CiAgICAgICAgICAgIGVs\nc2UKICAgICAgICAgICAgICAgIHNxbC5hcHBlbmQoc2VsLmdldENvbHVtbkFs\naWFzKGNvbHNbMF0sIGpvaW5zKSkuCiAgICAgICAgICAgICAgICAgICAgYXBw\nZW5kKCIgSVMgIikuYXBwZW5kVmFsdWUobnVsbCwgY29sc1swXSk7CiAgICAg\nICAgfSBlbHNlCiAgICAgICAgICAgIHRlc3RJbnZlcnNlTnVsbChzcWwsIHNl\nbCwgam9pbnMsIHRydWUpOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGFwcGVu\nZElzTm90TnVsbChTUUxCdWZmZXIgc3FsLCBTZWxlY3Qgc2VsLCBKb2lucyBq\nb2lucykgewogICAgICAgIC8vIGlmIG5vIGludmVyc2UsIGp1c3Qgam9pbiB0\nbyBtYXBwaW5nJ3MgdGFibGUgKHVzdWFsbHkgYSBuby1vcAogICAgICAgIC8v\nIGJlY2F1c2UgaXQnbGwgYmUgaW4gdGhlIHByaW1hcnkgdGFibGUpIGFuZCBz\nZWUgaWYgZmsgY29scyBhcmVuJ3QKICAgICAgICAvLyBudWxsOyBpZiBpbnZl\ncnNlLCB0aGVuIHdlIGhhdmUgdG8gZG8gYSBzdWItc2VsZWN0IHRvIHNlZSBp\nZiBhbnkKICAgICAgICAvLyBpbnZlcnNlIG9iamVjdHMgcG9pbnQgYmFjayB0\nbyB0aGlzIGZpZWxkJ3Mgb3duZXIKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9p\nbkRpcmVjdGlvbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRSkgewogICAgICAg\nICAgICAvLyMjIyBwcm9iYWJseSBuZWVkIHNvbWUgc29ydCBvZiBzdWJzZWxl\nY3QgaGVyZSBvbiBmayBjb25zdGFudHMKICAgICAgICAgICAgam9pbnMgPSBq\nb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAgIENvbHVtbltdIGNvbHMg\nPSBmaWVsZC5nZXRDb2x1bW5zKCk7CiAgICAgICAgICAgIGlmIChjb2xzLmxl\nbmd0aCA9PSAwKQogICAgICAgICAgICAgICAgc3FsLmFwcGVuZCgiMSA9IDEi\nKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgc3FsLmFwcGVu\nZChzZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwgam9pbnMpKS4KICAgICAg\nICAgICAgICAgICAgICBhcHBlbmQoIiBJUyBOT1QgIikuYXBwZW5kVmFsdWUo\nbnVsbCwgY29sc1swXSk7CiAgICAgICAgfSBlbHNlCiAgICAgICAgICAgIHRl\nc3RJbnZlcnNlTnVsbChzcWwsIHNlbCwgam9pbnMsIGZhbHNlKTsKICAgIH0K\nCiAgICAvKioKICAgICAqIEFwcGVuZCBTUUwgZm9yIGEgc3ViLXNlbGVjdCB0\nZXN0aW5nIHdoZXRoZXIgYW4gaW52ZXJzZSBvYmplY3QgZXhpc3RzCiAgICAg\nKiBmb3IgdGhpcyByZWxhdGlvbi4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lk\nIHRlc3RJbnZlcnNlTnVsbChTUUxCdWZmZXIgc3FsLCBTZWxlY3Qgc2VsLCBK\nb2lucyBqb2lucywKICAgICAgICBib29sZWFuIGVtcHR5KSB7CiAgICAgICAg\nREJEaWN0aW9uYXJ5IGRpY3QgPSBmaWVsZC5nZXRNYXBwaW5nUmVwb3NpdG9y\neSgpLmdldERCRGljdGlvbmFyeSgpOwogICAgICAgIGRpY3QuYXNzZXJ0U3Vw\ncG9ydChkaWN0LnN1cHBvcnRzU3Vic2VsZWN0LCAiU3VwcG9ydHNTdWJzZWxl\nY3QiKTsKCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1h\ncHBpbmdzKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0\naW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwoKICAgICAgICBp\nZiAoZW1wdHkpCiAgICAgICAgICAgIHNxbC5hcHBlbmQoIjAgPSAiKTsKICAg\nICAgICBlbHNlCiAgICAgICAgICAgIHNxbC5hcHBlbmQoIjAgPCAiKTsKCiAg\nICAgICAgRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsK\nICAgICAgICBDb250YWluZXJGaWVsZFN0cmF0ZWd5LmFwcGVuZEpvaW5Db3Vu\ndChzcWwsIHNlbCwgam9pbnMsIGRpY3QsIGZpZWxkLAogICAgICAgICAgICBm\nayk7CiAgICB9CgogICAgcHVibGljIEpvaW5zIGpvaW4oSm9pbnMgam9pbnMs\nIGJvb2xlYW4gZm9yY2VPdXRlcikgewogICAgICAgIC8vIGlmIHdlJ3JlIG5v\ndCBpbiBhbiBpbnZlcnNlIG9iamVjdCB0YWJsZSBqb2luIG5vcm1hbGx5LCBv\ndGhlcndpc2UKICAgICAgICAvLyBhbHJlYWR5IHRyYXZlcnNlZCB0aGUgcmVs\nYXRpb247IGp1c3Qgam9pbiBiYWNrIHRvIG93bmVyIHRhYmxlCiAgICAgICAg\naWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSAhPSBmaWVsZC5KT0lOX0lO\nVkVSU0UpCiAgICAgICAgICAgIHJldHVybiBmaWVsZC5qb2luKGpvaW5zLCBm\nb3JjZU91dGVyLCBmYWxzZSk7CiAgICAgICAgQ2xhc3NNYXBwaW5nW10gY2xz\ncyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAg\nICAgaWYgKGNsc3MubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJl\nbGF0aW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwogICAgICAg\nIGlmIChmb3JjZU91dGVyKQogICAgICAgICAgICByZXR1cm4gam9pbnMub3V0\nZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAg\nICAgZmllbGQuZ2V0Rm9yZWlnbktleSgpLCBjbHNzWzBdLCBmaWVsZC5nZXRT\nZWxlY3RTdWJjbGFzc2VzKCksIAogICAgICAgICAgICAgICAgdHJ1ZSwgZmFs\nc2UpOwogICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQu\nZ2V0TmFtZSgpLCBmaWVsZC5nZXRGb3JlaWduS2V5KCksCiAgICAgICAgICAg\nIGNsc3NbMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgdHJ1ZSwg\nZmFsc2UpOwogICAgfQoKICAgIHB1YmxpYyBKb2lucyBqb2luUmVsYXRpb24o\nSm9pbnMgam9pbnMsIGJvb2xlYW4gZm9yY2VPdXRlciwKICAgICAgICBib29s\nZWFuIHRyYXZlcnNlKSB7CiAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBpbnZl\ncnNlIG1hcHBpbmcgaXQncyBhbHJlYWR5IGpvaW5lZCB0byB0aGUgcmVsYXRp\nb24KICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZp\nZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwog\nICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVu\nZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGlmIChjbHNzLmxlbmd0aCAh\nPSAxKSB7CiAgICAgICAgICAgIGlmICh0cmF2ZXJzZSkKICAgICAgICAgICAg\nICAgIHRocm93IFJlbGF0aW9uU3RyYXRlZ2llcy51bmpvaW5hYmxlKGZpZWxk\nKTsKICAgICAgICAgICAgcmV0dXJuIGpvaW5zOwogICAgICAgIH0KCiAgICAg\nICAgam9pbnMgPSBzZXRFbWJlZGRlZFZhcmlhYmxlKGpvaW5zKTsKICAgICAg\nICBpZiAoZm9yY2VPdXRlcikKICAgICAgICAgICAgcmV0dXJuIGpvaW5zLm91\ndGVySm9pblJlbGF0aW9uKGZpZWxkLmdldE5hbWUoKSwgCiAgICAgICAgICAg\nICAgICBmaWVsZC5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLCBjbHNzWzBdLCAK\nICAgICAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwg\nZmFsc2UsIGZhbHNlKTsKICAgICAgICByZXR1cm4gam9pbnMuam9pblJlbGF0\naW9uKGZpZWxkLmdldE5hbWUoKSwgZmllbGQuZ2V0Rm9yZWlnbktleShjbHNz\nWzBdKSwKICAgICAgICAgICAgY2xzc1swXSwgZmllbGQuZ2V0U2VsZWN0U3Vi\nY2xhc3NlcygpLCBmYWxzZSwgZmFsc2UpOwogICAgfQoKICAgIC8vLy8vLy8v\nLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gSm9pbmFibGUgaW1wbGVtZW50\nYXRpb24KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIHB1\nYmxpYyBpbnQgZ2V0RmllbGRJbmRleCgpIHsKICAgICAgICByZXR1cm4gZmll\nbGQuZ2V0SW5kZXgoKTsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGdldFBy\naW1hcnlLZXlWYWx1ZShSZXN1bHQgcmVzLCBDb2x1bW5bXSBjb2xzLCBGb3Jl\naWduS2V5IGZrLAogICAgICAgIEpEQkNTdG9yZSBzdG9yZSwgSm9pbnMgam9p\nbnMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgQ2xh\nc3NNYXBwaW5nIHJlbG1hcHBpbmcgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygp\nOwogICAgICAgIGlmIChyZWxtYXBwaW5nLmdldElkZW50aXR5VHlwZSgpID09\nIENsYXNzTWFwcGluZy5JRF9EQVRBU1RPUkUpIHsKICAgICAgICAgICAgQ29s\ndW1uIGNvbCA9IGNvbHNbMF07CiAgICAgICAgICAgIGlmIChmayAhPSBudWxs\nKQogICAgICAgICAgICAgICAgY29sID0gZmsuZ2V0Q29sdW1uKGNvbCk7ICAg\nCiAgICAgICAgICAgIGxvbmcgaWQgPSByZXMuZ2V0TG9uZyhjb2wsIGpvaW5z\nKTsKICAgICAgICAgICAgaWYgKGZpZWxkLmdldE9iamVjdElkRmllbGRUeXBl\nQ29kZSgpID09IEphdmFUeXBlcy5MT05HKQogICAgICAgICAgICAgICAgcmV0\ndXJuIE51bWJlcnMudmFsdWVPZihpZCk7CiAgICAgICAgICAgIHJldHVybiBz\ndG9yZS5uZXdEYXRhU3RvcmVJZChpZCwgcmVsbWFwcGluZywgZmllbGQuZ2V0\nUG9seW1vcnBoaWMoKSAKICAgICAgICAgICAgICAgICE9IFZhbHVlTWFwcGlu\nZy5QT0xZX0ZBTFNFKTsKICAgICAgICB9CgogICAgICAgIGlmIChyZWxtYXBw\naW5nLmlzT3BlbkpQQUlkZW50aXR5KCkpCiAgICAgICAgICAgIHJldHVybiAo\nKEpvaW5hYmxlKSByZWxtYXBwaW5nLmdldFByaW1hcnlLZXlGaWVsZE1hcHBp\nbmdzKClbMF0uCiAgICAgICAgICAgICAgICBnZXRTdHJhdGVneSgpKS5nZXRQ\ncmltYXJ5S2V5VmFsdWUocmVzLCBjb2xzLCBmaywgc3RvcmUsIGpvaW5zKTsK\nCiAgICAgICAgaWYgKGNvbHMgPT0gZ2V0Q29sdW1ucygpICYmIGZrID09IG51\nbGwpCiAgICAgICAgICAgIGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwog\nICAgICAgIGVsc2UKICAgICAgICAgICAgZmsgPSBjcmVhdGVUcmFuc2xhdGlu\nZ0ZvcmVpZ25LZXkocmVsbWFwcGluZywgY29scywgZmspOyAKICAgICAgICBy\nZXR1cm4gcmVsbWFwcGluZy5nZXRPYmplY3RJZChzdG9yZSwgcmVzLCBmaywK\nICAgICAgICAgICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1ZU1h\ncHBpbmcuUE9MWV9GQUxTRSwgam9pbnMpOwogICAgfQoKICAgIC8qKgogICAg\nICogQ3JlYXRlIGEgZmF1eCBmb3JlaWduIGtleSB0aGF0IHRyYW5zbGF0ZXMg\nYmV0d2VlbiB0aGUgY29sdW1ucyB0byBwdWxsCiAgICAgKiB0aGUgZGF0YSBm\ncm9tIGFuZCBvdXIgcmVsYXRlZCB0eXBlJ3MgcHJpbWFyeSBrZXkgY29sdW1u\ncy4KICAgICAqLwogICAgcHJpdmF0ZSBGb3JlaWduS2V5IGNyZWF0ZVRyYW5z\nbGF0aW5nRm9yZWlnbktleShDbGFzc01hcHBpbmcgcmVsbWFwcGluZywKICAg\nICAgICBDb2x1bW5bXSBnY29scywgRm9yZWlnbktleSBnZmspIHsKICAgICAg\nICBGb3JlaWduS2V5IGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOyAKICAg\nICAgICBDb2x1bW5bXSBjb2xzID0gZmsuZ2V0Q29sdW1ucygpOwoKICAgICAg\nICBGb3JlaWduS2V5IHRmayA9IG51bGw7CiAgICAgICAgQ29sdW1uIHRjb2w7\nCiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBnY29scy5sZW5ndGg7IGkr\nKykgewogICAgICAgICAgICB0Y29sID0gZ2NvbHNbaV07CiAgICAgICAgICAg\nIGlmIChnZmsgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRjb2wgPSBnZmsu\nZ2V0Q29sdW1uKHRjb2wpOwogICAgICAgICAgICBpZiAodGZrID09IG51bGwp\nCiAgICAgICAgICAgICAgICB0ZmsgPSBuZXcgRm9yZWlnbktleShudWxsLCB0\nY29sLmdldFRhYmxlKCkpOwogICAgICAgICAgICB0Zmsuam9pbih0Y29sLCBm\nay5nZXRQcmltYXJ5S2V5Q29sdW1uKGNvbHNbaV0pKTsKICAgICAgICB9CiAg\nICAgICAgcmV0dXJuIHRmazsKICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0IGdl\ndEpvaW5WYWx1ZShPYmplY3QgZmllbGRWYWwsIENvbHVtbiBjb2wsIEpEQkNT\ndG9yZSBzdG9yZSkgewogICAgICAgIE9iamVjdCBvID0gZmllbGQuZ2V0Rm9y\nZWlnbktleSgpLmdldENvbnN0YW50KGNvbCk7CiAgICAgICAgaWYgKG8gIT0g\nbnVsbCkKICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgY29sID0gZmll\nbGQuZ2V0Rm9yZWlnbktleSgpLmdldFByaW1hcnlLZXlDb2x1bW4oY29sKTsK\nICAgICAgICBpZiAoY29sID09IG51bGwpCiAgICAgICAgICAgIHRocm93IG5l\ndyBJbnRlcm5hbEV4Y2VwdGlvbigpOwoKICAgICAgICBDbGFzc01hcHBpbmcg\ncmVsbWFwcGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAg\nSm9pbmFibGUgaiA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCkuYXNzZXJ0Sm9p\nbmFibGUoY29sKTsKICAgICAgICBpZiAoSW1wbEhlbHBlci5pc01hbmFnZWFi\nbGUoZmllbGRWYWwpKQogICAgICAgICAgICBmaWVsZFZhbCA9IHN0b3JlLmdl\ndENvbnRleHQoKS5nZXRPYmplY3RJZChmaWVsZFZhbCk7CiAgICAgICAgaWYg\nKGZpZWxkVmFsIGluc3RhbmNlb2YgT3BlbkpQQUlkKQogICAgICAgICAgICBm\naWVsZFZhbCA9ICgoT3BlbkpQQUlkKSBmaWVsZFZhbCkuZ2V0SWRPYmplY3Qo\nKTsKICAgICAgICBpZiAocmVsbWFwcGluZy5nZXRPYmplY3RJZFR5cGUoKSAh\nPSBudWxsCiAgICAgICAgICAgICYmIHJlbG1hcHBpbmcuZ2V0T2JqZWN0SWRU\neXBlKCkuaXNJbnN0YW5jZShmaWVsZFZhbCkpIHsKICAgICAgICAgICAgT2Jq\nZWN0W10gcGtzID0gQXBwbGljYXRpb25JZHMudG9QS1ZhbHVlcyhmaWVsZFZh\nbCwgcmVsbWFwcGluZyk7CiAgICAgICAgICAgIGZpZWxkVmFsID0gcGtzW3Jl\nbG1hcHBpbmcuZ2V0RmllbGQoai5nZXRGaWVsZEluZGV4KCkpLgogICAgICAg\nICAgICAgICAgZ2V0UHJpbWFyeUtleUluZGV4KCldOwogICAgICAgIH0KICAg\nICAgICByZXR1cm4gai5nZXRKb2luVmFsdWUoZmllbGRWYWwsIGNvbCwgc3Rv\ncmUpOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgZ2V0Sm9pblZhbHVlKE9w\nZW5KUEFTdGF0ZU1hbmFnZXIgc20sIENvbHVtbiBjb2wsCiAgICAgICAgSkRC\nQ1N0b3JlIHN0b3JlKSB7CiAgICAgICAgcmV0dXJuIGdldEpvaW5WYWx1ZShz\nbS5mZXRjaChmaWVsZC5nZXRJbmRleCgpKSwgY29sLCBzdG9yZSk7CiAgICB9\nCgogICAgcHVibGljIHZvaWQgc2V0QXV0b0Fzc2lnbmVkVmFsdWUoT3BlbkpQ\nQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIENv\nbHVtbiBjb2wsIE9iamVjdCBhdXRvSW5jKSB7CiAgICAgICAgdGhyb3cgbmV3\nIFVuc3VwcG9ydGVkRXhjZXB0aW9uKCk7CiAgICB9CgogICAgLy8vLy8vLy8v\nLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIEVtYmVkZGFibGUgaW1wbGVt\nZW50YXRpb24KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgog\nICAgcHVibGljIENvbHVtbltdIGdldENvbHVtbnMoKSB7CiAgICAgICAgcmV0\ndXJuIGZpZWxkLmdldENvbHVtbnMoKTsKICAgIH0KCiAgICBwdWJsaWMgQ29s\ndW1uSU8gZ2V0Q29sdW1uSU8oKSB7CiAgICAgICAgcmV0dXJuIGZpZWxkLmdl\ndENvbHVtbklPKCk7CiAgICB9CgogICAgcHVibGljIE9iamVjdFtdIGdldFJl\nc3VsdEFyZ3VtZW50cygpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0K\nCiAgICBwdWJsaWMgT2JqZWN0IHRvRW1iZWRkZWREYXRhU3RvcmVWYWx1ZShP\nYmplY3QgdmFsLCBKREJDU3RvcmUgc3RvcmUpIHsKICAgICAgICByZXR1cm4g\ndG9EYXRhU3RvcmVWYWx1ZSh2YWwsIHN0b3JlKTsKICAgIH0KCiAgICBwdWJs\naWMgT2JqZWN0IHRvRW1iZWRkZWRPYmplY3RWYWx1ZShPYmplY3QgdmFsKSB7\nCiAgICAgICAgcmV0dXJuIFVOU1VQUE9SVEVEOwogICAgfQoKICAgIHB1Ymxp\nYyB2b2lkIGxvYWRFbWJlZGRlZChPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCBK\nREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNoQ29uZmlndXJhdGlv\nbiBmZXRjaCwgT2JqZWN0IHZhbCkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0\naW9uIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVsTWFwcGluZyA9IGZpZWxk\nLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgT2JqZWN0IG9pZDsKICAgICAg\nICBpZiAodmFsID09IG51bGwpCiAgICAgICAgICAgIG9pZCA9IG51bGw7CiAg\nICAgICAgZWxzZSBpZiAocmVsTWFwcGluZy5nZXRJZGVudGl0eVR5cGUoKSA9\nPSBDbGFzc01hcHBpbmcuSURfREFUQVNUT1JFKQogICAgICAgICAgICBvaWQg\nPSBzdG9yZS5uZXdEYXRhU3RvcmVJZCgoKE51bWJlcikgdmFsKS5sb25nVmFs\ndWUoKSwgcmVsTWFwcGluZywKICAgICAgICAgICAgICAgIGZpZWxkLmdldFBv\nbHltb3JwaGljKCkgIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0UpOwogICAg\nICAgIGVsc2UgewogICAgICAgICAgICBPYmplY3RbXSBwa3MgPSAoZ2V0Q29s\ndW1ucygpLmxlbmd0aCA9PSAxKSA/IG5ldyBPYmplY3RbXXsgdmFsIH0KICAg\nICAgICAgICAgICAgIDogKE9iamVjdFtdKSB2YWw7CiAgICAgICAgICAgIGJv\nb2xlYW4gbnVsbHMgPSB0cnVlOwogICAgICAgICAgICBmb3IgKGludCBpID0g\nMDsgbnVsbHMgJiYgaSA8IHBrcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAg\nICAgIG51bGxzID0gcGtzW2ldID09IG51bGw7CiAgICAgICAgICAgIGlmIChu\ndWxscykKICAgICAgICAgICAgICAgIG9pZCA9IG51bGw7CiAgICAgICAgICAg\nIGVsc2UgewogICAgICAgICAgICAgICAgb2lkID0gQXBwbGljYXRpb25JZHMu\nZnJvbVBLVmFsdWVzKHBrcywgcmVsTWFwcGluZyk7CiAgICAgICAgICAgICAg\nICBpZiAoZmllbGQuZ2V0UG9seW1vcnBoaWMoKSA9PSBWYWx1ZU1hcHBpbmcu\nUE9MWV9GQUxTRQogICAgICAgICAgICAgICAgICAgICYmIG9pZCBpbnN0YW5j\nZW9mIE9wZW5KUEFJZCkgewogICAgICAgICAgICAgICAgICAgICgoT3BlbkpQ\nQUlkKSBvaWQpLnNldE1hbmFnZWRJbnN0YW5jZVR5cGUocmVsTWFwcGluZy4K\nICAgICAgICAgICAgICAgICAgICAgICAgZ2V0RGVzY3JpYmVkVHlwZSgpKTsK\nICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAg\nICAgICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAgICAgICBzbS5zdG9yZU9i\namVjdChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsKICAgICAgICBlbHNlIHsK\nICAgICAgICAgICAgaWYgKEphdmFUeXBlcy5tYXliZVBDKGZpZWxkLmdldFZh\nbHVlKCkpICYmCiAgICAgICAgICAgICAgICAhZmllbGQuZ2V0VmFsdWUoKS5n\nZXREZWNsYXJlZFR5cGVNZXRhRGF0YSgpLmlzRW1iZWRkZWRPbmx5KCkpIHsK\nICAgICAgICAgICAgICAgIE9iamVjdCBvYmogPSBzdG9yZS5maW5kKG9pZCwg\nZmllbGQsIGZldGNoKTsKICAgICAgICAgICAgICAgIHNtLnN0b3JlT2JqZWN0\nKGZpZWxkLmdldEluZGV4KCksIG9iaik7CiAgICAgICAgICAgIH0gZWxzZSAg\nICAKICAgICAgICAgICAgICAgIHNtLnNldEludGVybWVkaWF0ZShmaWVsZC5n\nZXRJbmRleCgpLCBvaWQpOwogICAgICAgIH0KICAgIH0KfQo=\n","encoding":"base64"}

