{"sha":"f310f9449413bde0c790aca015a8a3f0cf291775","node_id":"MDQ6QmxvYjIwNjM2NDpmMzEwZjk0NDk0MTNiZGUwYzc5MGFjYTAxNWE4YTNmMGNmMjkxNzc1","size":39378,"url":"https://api.github.com/repos/apache/openjpa/git/blobs/f310f9449413bde0c790aca015a8a3f0cf291775","content":"LyoKICogTGljZW5zZWQgdG8gdGhlIEFwYWNoZSBTb2Z0d2FyZSBGb3VuZGF0\naW9uIChBU0YpIHVuZGVyIG9uZQogKiBvciBtb3JlIGNvbnRyaWJ1dG9yIGxp\nY2Vuc2UgYWdyZWVtZW50cy4gIFNlZSB0aGUgTk9USUNFIGZpbGUKICogZGlz\ndHJpYnV0ZWQgd2l0aCB0aGlzIHdvcmsgZm9yIGFkZGl0aW9uYWwgaW5mb3Jt\nYXRpb24KICogcmVnYXJkaW5nIGNvcHlyaWdodCBvd25lcnNoaXAuICBUaGUg\nQVNGIGxpY2Vuc2VzIHRoaXMgZmlsZQogKiB0byB5b3UgdW5kZXIgdGhlIEFw\nYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlCiAqICJMaWNlbnNlIik7\nIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFu\nY2UKICogd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBtYXkgb2J0YWluIGEgY29w\neSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5v\ncmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVk\nIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLAog\nKiBzb2Z0d2FyZSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBk\naXN0cmlidXRlZCBvbiBhbgogKiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdB\nUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkKICogS0lORCwgZWl0aGVy\nIGV4cHJlc3Mgb3IgaW1wbGllZC4gIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhl\nCiAqIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBh\nbmQgbGltaXRhdGlvbnMKICogdW5kZXIgdGhlIExpY2Vuc2UuICAgIAogKi8K\ncGFja2FnZSBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLnN0cmF0czsK\nCmltcG9ydCBqYXZhLnNxbC5TUUxFeGNlcHRpb247CmltcG9ydCBqYXZhLnV0\naWwuQXJyYXlMaXN0OwppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7CmltcG9y\ndCBqYXZhLnV0aWwuTGlzdDsKaW1wb3J0IGphdmEudXRpbC5NYXA7CgppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmVuaGFuY2UuUGVyc2lzdGVuY2VDYXBh\nYmxlOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuY29uZi5KREJD\nQ29uZmlndXJhdGlvbjsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJj\nLmtlcm5lbC5KREJDRmV0Y2hDb25maWd1cmF0aW9uOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLmpkYmMua2VybmVsLkpEQkNGZXRjaENvbmZpZ3VyYXRp\nb25JbXBsOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMua2VybmVs\nLkpEQkNTdG9yZTsKaW1wb3J0IG9yZy5hcGFjaGUub3BlbmpwYS5qZGJjLmtl\ncm5lbC5KREJDU3RvcmVNYW5hZ2VyOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMubWV0YS5DbGFzc01hcHBpbmc7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5tZXRhLkVtYmVkZGFibGU7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5tZXRhLkZpZWxkTWFwcGluZzsKaW1wb3J0IG9y\nZy5hcGFjaGUub3BlbmpwYS5qZGJjLm1ldGEuSm9pbmFibGU7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLk1hcHBpbmdJbmZvOwppbXBv\ncnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMubWV0YS5WYWx1ZU1hcHBpbmc7\nCmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5tZXRhLlZhbHVlTWFw\ncGluZ0luZm87CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEuamRiYy5zY2hl\nbWEuQ29sdW1uOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMuc2No\nZW1hLkNvbHVtbklPOwppbXBvcnQgb3JnLmFwYWNoZS5vcGVuanBhLmpkYmMu\nc2NoZW1hLkZvcmVpZ25LZXk7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5qcGEu\namRiYy5zY2hlbWEuUHJpbWFyeUtleTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNjaGVtYS5UYWJsZTsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5EQkRpY3Rpb25hcnk7CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEuamRiYy5zcWwuSm9pbnM7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuTG9naWNhbFVuaW9uOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlJlc3VsdDsKaW1wb3J0IG9yZy5hcGFjaGUu\nb3BlbmpwYS5qZGJjLnNxbC5Sb3c7CmltcG9ydCBvcmcuYXBhY2hlLm9wZW5q\ncGEuamRiYy5zcWwuUm93TWFuYWdlcjsKaW1wb3J0IG9yZy5hcGFjaGUub3Bl\nbmpwYS5qZGJjLnNxbC5TUUxCdWZmZXI7CmltcG9ydCBvcmcuYXBhY2hlLm9w\nZW5qcGEuamRiYy5zcWwuU2VsZWN0OwppbXBvcnQgb3JnLmFwYWNoZS5vcGVu\nanBhLmpkYmMuc3FsLlNlbGVjdEV4ZWN1dG9yOwppbXBvcnQgb3JnLmFwYWNo\nZS5vcGVuanBhLmpkYmMuc3FsLlNlbGVjdEltcGw7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEuamRiYy5zcWwuVW5pb247CmltcG9ydCBvcmcuYXBhY2hl\nLm9wZW5qcGEua2VybmVsLk9wZW5KUEFTdGF0ZU1hbmFnZXI7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEubGliLmxvZy5Mb2c7CmltcG9ydCBvcmcuYXBh\nY2hlLm9wZW5qcGEubGliLnV0aWwuTG9jYWxpemVyOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLm1ldGEuQ2xhc3NNZXRhRGF0YTsKaW1wb3J0IG9yZy5h\ncGFjaGUub3BlbmpwYS5tZXRhLkphdmFUeXBlczsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkFwcGxpY2F0aW9uSWRzOwppbXBvcnQgb3JnLmFw\nYWNoZS5vcGVuanBhLnV0aWwuSW1wbEhlbHBlcjsKaW1wb3J0IG9yZy5hcGFj\naGUub3BlbmpwYS51dGlsLkludGVybmFsRXhjZXB0aW9uOwppbXBvcnQgb3Jn\nLmFwYWNoZS5vcGVuanBhLnV0aWwuTWV0YURhdGFFeGNlcHRpb247CmltcG9y\ndCBvcmcuYXBhY2hlLm9wZW5qcGEudXRpbC5PcGVuSlBBSWQ7CmltcG9ydCBv\ncmcuYXBhY2hlLm9wZW5qcGEudXRpbC5VbnN1cHBvcnRlZEV4Y2VwdGlvbjsK\nCmltcG9ydCBzZXJwLnV0aWwuTnVtYmVyczsKCi8qKgogKiBNYXBwaW5nIGZv\nciBhIHNpbmdsZS12YWx1ZWQgcmVsYXRpb24gdG8gYW5vdGhlciBlbnRpdHku\nCiAqCiAqIEBhdXRob3IgQWJlIFdoaXRlCiAqIEBzaW5jZSAwLjQuMAogKi8K\ncHVibGljIGNsYXNzIFJlbGF0aW9uRmllbGRTdHJhdGVneQogICAgZXh0ZW5k\ncyBBYnN0cmFjdEZpZWxkU3RyYXRlZ3kKICAgIGltcGxlbWVudHMgSm9pbmFi\nbGUsIEVtYmVkZGFibGUgewoKICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIExv\nY2FsaXplciBfbG9jID0gTG9jYWxpemVyLmZvclBhY2thZ2UKICAgICAgICAo\nUmVsYXRpb25GaWVsZFN0cmF0ZWd5LmNsYXNzKTsKCiAgICBwcml2YXRlIEJv\nb2xlYW4gX2ZrT2lkID0gbnVsbDsKCiAgICBwdWJsaWMgdm9pZCBtYXAoYm9v\nbGVhbiBhZGFwdCkgewogICAgICAgIGlmIChmaWVsZC5nZXRUeXBlQ29kZSgp\nICE9IEphdmFUeXBlcy5QQyB8fCBmaWVsZC5pc0VtYmVkZGVkUEMoKSkKICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nKCJub3QtcmVsYXRpb24iLCBmaWVsZCkpOwoKICAgICAgICBmaWVsZC5nZXRL\nZXlNYXBwaW5nKCkuZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21w\nb25lbnRzCiAgICAgICAgICAgIChmaWVsZC5nZXRLZXkoKSwgIWFkYXB0KTsK\nICAgICAgICBmaWVsZC5nZXRFbGVtZW50TWFwcGluZygpLmdldFZhbHVlSW5m\nbygpLmFzc2VydE5vU2NoZW1hQ29tcG9uZW50cwogICAgICAgICAgICAoZmll\nbGQuZ2V0RWxlbWVudCgpLCAhYWRhcHQpOwogICAgICAgIGJvb2xlYW4gY3Jp\ndGVyaWEgPSBmaWVsZC5nZXRWYWx1ZUluZm8oKS5nZXRVc2VDbGFzc0NyaXRl\ncmlhKCk7CgogICAgICAgIC8vIGNoZWNrIGZvciBuYW1lZCBpbnZlcnNlCiAg\nICAgICAgRmllbGRNYXBwaW5nIG1hcHBlZCA9IGZpZWxkLmdldE1hcHBlZEJ5\nTWFwcGluZygpOwogICAgICAgIGlmIChtYXBwZWQgIT0gbnVsbCkgewogICAg\nICAgICAgICBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmFzc2VydE5vU2NoZW1h\nQ29tcG9uZW50cyhmaWVsZCwgIWFkYXB0KTsKICAgICAgICAgICAgZmllbGQu\nZ2V0VmFsdWVJbmZvKCkuYXNzZXJ0Tm9TY2hlbWFDb21wb25lbnRzKGZpZWxk\nLCAhYWRhcHQpOwogICAgICAgICAgICBtYXBwZWQucmVzb2x2ZShtYXBwZWQu\nTU9ERV9NRVRBIHwgbWFwcGVkLk1PREVfTUFQUElORyk7CgogICAgICAgICAg\nICBpZiAoIW1hcHBlZC5pc01hcHBlZCgpIHx8IG1hcHBlZC5pc1NlcmlhbGl6\nZWQoKSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2Vw\ndGlvbihfbG9jLmdldCgibWFwcGVkLWJ5LXVubWFwcGVkIiwKICAgICAgICAg\nICAgICAgICAgICBmaWVsZCwgbWFwcGVkKSk7CgogICAgICAgICAgICBpZiAo\nbWFwcGVkLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVzLlBDKSB7CiAgICAg\nICAgICAgICAgICBpZiAobWFwcGVkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBt\nYXBwZWQuSk9JTl9GT1JXQVJEKSB7CiAgICAgICAgICAgICAgICAgICAgZmll\nbGQuc2V0Sm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAg\nICAgICAgICAgICAgICAgIGZpZWxkLnNldENvbHVtbnMobWFwcGVkLmdldERl\nZmluaW5nTWFwcGluZygpLgogICAgICAgICAgICAgICAgICAgICAgICBnZXRQ\ncmltYXJ5S2V5Q29sdW1ucygpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBp\nZiAoaXNUeXBlVW5qb2luZWRTdWJjbGFzcyhtYXBwZWQpKQogICAgICAgICAg\nICAgICAgICAgIHRocm93IG5ldyBNZXRhRGF0YUV4Y2VwdGlvbihfbG9jLmdl\ndAogICAgICAgICAgICAgICAgICAgICAgICAoIm1hcHBlZC1pbnZlcnNlLXVu\nam9pbmVkIiwgZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICAgICAgICAg\nICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCksIG1hcHBlZCkp\nOwoKICAgICAgICAgICAgICAgIGZpZWxkLnNldEZvcmVpZ25LZXkobWFwcGVk\nLmdldEZvcmVpZ25LZXkKICAgICAgICAgICAgICAgICAgICAoZmllbGQuZ2V0\nRGVmaW5pbmdNYXBwaW5nKCkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICht\nYXBwZWQuZ2V0RWxlbWVudCgpLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5cGVz\nLlBDKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNUeXBlVW5qb2luZWRTdWJj\nbGFzcyhtYXBwZWQuZ2V0RWxlbWVudE1hcHBpbmcoKSkpCiAgICAgICAgICAg\nICAgICAgICAgdGhyb3cgbmV3IE1ldGFEYXRhRXhjZXB0aW9uKF9sb2MuZ2V0\nCiAgICAgICAgICAgICAgICAgICAgICAgICgibWFwcGVkLWludmVyc2UtdW5q\nb2luZWQiLCBmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICAgICAg\nICAgICAgICBmaWVsZC5nZXREZWZpbmluZ01hcHBpbmcoKSwgbWFwcGVkKSk7\nCgogICAgICAgICAgICAgICAgLy8gd2FybiB0aGUgdXNlciBhYm91dCBtYWtp\nbmcgdGhlIGNvbGxlY3Rpb24gc2lkZSB0aGUgb3duZXIKICAgICAgICAgICAg\nICAgIExvZyBsb2cgPSBmaWVsZC5nZXRSZXBvc2l0b3J5KCkuZ2V0TG9nKCk7\nCiAgICAgICAgICAgICAgICBpZiAobG9nLmlzSW5mb0VuYWJsZWQoKSkKICAg\nICAgICAgICAgICAgICAgICBsb2cuaW5mbyhfbG9jLmdldCgiY29sbC1vd25l\nciIsIGZpZWxkLCBtYXBwZWQpKTsKICAgICAgICAgICAgICAgIGZpZWxkLnNl\ndEZvcmVpZ25LZXkobWFwcGVkLmdldEVsZW1lbnRNYXBwaW5nKCkuCiAgICAg\nICAgICAgICAgICAgICAgZ2V0Rm9yZWlnbktleSgpKTsKICAgICAgICAgICAg\nfSBlbHNlCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgTWV0YURhdGFFeGNl\ncHRpb24oX2xvYy5nZXQoIm5vdC1pbnYtcmVsYXRpb24iLAogICAgICAgICAg\nICAgICAgICAgIGZpZWxkLCBtYXBwZWQpKTsKCiAgICAgICAgICAgIGZpZWxk\nLnNldFVzZUNsYXNzQ3JpdGVyaWEoY3JpdGVyaWEpOwogICAgICAgICAgICBy\nZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2Fy\neSB0byBzdXBwb3J0IG9wZW5qcGEgMyBtYXBwaW5ncywgd2hpY2ggZGlkbid0\nCiAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIHNlY29uZGFyeSB0\nYWJsZSBqb2lucyBhbmQgcmVsYXRpb25zIGJ1aWx0CiAgICAgICAgLy8gYXJv\ndW5kIGFuIGludmVyc2Uga2V5OiBjaGVjayB0byBzZWUgaWYgd2UncmUgbWFw\ncGVkIGFzIGEgc2Vjb25kYXJ5CiAgICAgICAgLy8gdGFibGUgam9pbiBidXQg\nd2UncmUgaW4gdGhlIHRhYmxlIG9mIHRoZSByZWxhdGVkIHR5cGUsIGFuZCBp\nZiBzbwogICAgICAgIC8vIHN3aXRjaCBvdXIgam9pbiBtYXBwaW5nIGluZm8g\ndG8gb3VyIHZhbHVlIG1hcHBpbmcgaW5mbwogICAgICAgIFN0cmluZyB0YWJs\nZU5hbWUgPSBmaWVsZC5nZXRNYXBwaW5nSW5mbygpLmdldFRhYmxlTmFtZSgp\nOwogICAgICAgIFRhYmxlIHRhYmxlID0gZmllbGQuZ2V0VHlwZU1hcHBpbmco\nKS5nZXRUYWJsZSgpOwogICAgICAgIFZhbHVlTWFwcGluZ0luZm8gdmluZm8g\nPSBmaWVsZC5nZXRWYWx1ZUluZm8oKTsKICAgICAgICBpZiAodGFibGVOYW1l\nICE9IG51bGwgJiYgdGFibGUgIT0gbnVsbAogICAgICAgICAgICAmJiAodGFi\nbGVOYW1lLmVxdWFsc0lnbm9yZUNhc2UodGFibGUuZ2V0TmFtZSgpKQogICAg\nICAgICAgICB8fCB0YWJsZU5hbWUuZXF1YWxzSWdub3JlQ2FzZSh0YWJsZS5n\nZXRGdWxsTmFtZSgpKSkpIHsKICAgICAgICAgICAgdmluZm8uc2V0Sm9pbkRp\ncmVjdGlvbihNYXBwaW5nSW5mby5KT0lOX0lOVkVSU0UpOwogICAgICAgICAg\nICB2aW5mby5zZXRDb2x1bW5zKGZpZWxkLmdldE1hcHBpbmdJbmZvKCkuZ2V0\nQ29sdW1ucygpKTsKICAgICAgICAgICAgZmllbGQuZ2V0TWFwcGluZ0luZm8o\nKS5zZXRUYWJsZU5hbWUobnVsbCk7CiAgICAgICAgICAgIGZpZWxkLmdldE1h\ncHBpbmdJbmZvKCkuc2V0Q29sdW1ucyhudWxsKTsKICAgICAgICB9CgogICAg\nICAgIGZpZWxkLm1hcEpvaW4oYWRhcHQsIGZhbHNlKTsKICAgICAgICBpZiAo\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5pc01hcHBlZCgpKSB7CiAgICAgICAg\nICAgIEZvcmVpZ25LZXkgZmsgPSB2aW5mby5nZXRUeXBlSm9pbihmaWVsZCwg\nZmllbGQuZ2V0TmFtZSgpLCB0cnVlLAogICAgICAgICAgICAgICAgYWRhcHQp\nOwogICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWduS2V5KGZrKTsKICAgICAg\nICAgICAgZmllbGQuc2V0Q29sdW1uSU8odmluZm8uZ2V0Q29sdW1uSU8oKSk7\nCiAgICAgICAgICAgIGlmICh2aW5mby5nZXRKb2luRGlyZWN0aW9uKCkgPT0g\ndmluZm8uSk9JTl9JTlZFUlNFKQogICAgICAgICAgICAgICAgZmllbGQuc2V0\nSm9pbkRpcmVjdGlvbihmaWVsZC5KT0lOX0lOVkVSU0UpOwogICAgICAgIH0g\nZWxzZQogICAgICAgICAgICBSZWxhdGlvblN0cmF0ZWdpZXMubWFwUmVsYXRp\nb25Ub1VubWFwcGVkUEMoZmllbGQsIGZpZWxkLmdldE5hbWUoKSwKICAgICAg\nICAgICAgICAgIGFkYXB0KTsKCiAgICAgICAgZmllbGQuc2V0VXNlQ2xhc3ND\ncml0ZXJpYShjcml0ZXJpYSk7CiAgICAgICAgZmllbGQubWFwUHJpbWFyeUtl\neShhZGFwdCk7CiAgICAgICAgUHJpbWFyeUtleSBwayA9IGZpZWxkLmdldFRh\nYmxlKCkuZ2V0UHJpbWFyeUtleSgpOwogICAgICAgIGlmIChmaWVsZC5pc1By\naW1hcnlLZXkoKSkgewogICAgICAgICAgICBDb2x1bW5bXSBjb2xzID0gZmll\nbGQuZ2V0Q29sdW1ucygpOwogICAgICAgICAgICBpZiAocGsgIT0gbnVsbCAm\nJiAoYWRhcHQgfHwgcGsuaXNMb2dpY2FsKCkpKQogICAgICAgICAgICAgICAg\nZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAgICAg\nICAgICAgICAgICAgIHBrLmFkZENvbHVtbihjb2xzW2ldKTsKICAgICAgICAg\nICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb2xzLmxlbmd0aDsgaSsrKQogICAg\nICAgICAgICAgICAgZmllbGQuZ2V0RGVmaW5pbmdNYXBwaW5nKCkuc2V0Sm9p\nbmFibGUoY29sc1tpXSwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICAvLyBt\nYXAgY29uc3RyYWludHMgYWZ0ZXIgcGsgc28gd2UgZG9uJ3QgcmUtaW5kZXgg\nLyByZS11bmlxdWUgcGsgY29sCiAgICAgICAgZmllbGQubWFwQ29uc3RyYWlu\ndHMoZmllbGQuZ2V0TmFtZSgpLCBhZGFwdCk7CiAgICB9CgogICAgLyoqCiAg\nICAgKiBSZXR1cm4gd2hldGhlciBvdXIgZGVmaW5pbmcgbWFwcGluZyBpcyBh\nbiB1bmpvaW5lZCBzdWJjbGFzcyBvZgogICAgICogdGhlIHR5cGUgb2YgdGhl\nIGdpdmVuIHZhbHVlLgogICAgICovCiAgICBwcml2YXRlIGJvb2xlYW4gaXNU\neXBlVW5qb2luZWRTdWJjbGFzcyhWYWx1ZU1hcHBpbmcgbWFwcGVkKSB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGRlZiA9IGZpZWxkLmdldERlZmluaW5nTWFw\ncGluZygpOwogICAgICAgIGZvciAoOyBkZWYgIT0gbnVsbDsgZGVmID0gZGVm\nLmdldEpvaW5hYmxlUENTdXBlcmNsYXNzTWFwcGluZygpKQogICAgICAgICAg\nICBpZiAoZGVmID09IG1hcHBlZC5nZXRUeXBlTWFwcGluZygpKQogICAgICAg\nICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIGluaXRpYWxpemUoKSB7CiAgICAgICAg\nZmllbGQuc2V0VXNlc0ludGVybWVkaWF0ZSh0cnVlKTsKCiAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBp\nZiAoZmsgPT0gbnVsbCkKICAgICAgICAgICAgX2ZrT2lkID0gQm9vbGVhbi5U\nUlVFOwogICAgICAgIGVsc2UgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24o\nKSAhPSBGaWVsZE1hcHBpbmcuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICBf\nZmtPaWQgPSBmaWVsZC5nZXRUeXBlTWFwcGluZygpLmlzRm9yZWlnbktleU9i\namVjdElkKGZrKTsKICAgIH0KCiAgICBwdWJsaWMgdm9pZCBpbnNlcnQoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5h\nZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAg\nIGlmIChmaWVsZC5nZXRNYXBwZWRCeSgpICE9IG51bGwpCiAgICAgICAgICAg\nIHJldHVybjsKCiAgICAgICAgT3BlbkpQQVN0YXRlTWFuYWdlciByZWwgPSBS\nZWxhdGlvblN0cmF0ZWdpZXMuZ2V0U3RhdGVNYW5hZ2VyCiAgICAgICAgICAg\nIChzbS5mZXRjaE9iamVjdEZpZWxkKGZpZWxkLmdldEluZGV4KCkpLCBzdG9y\nZS5nZXRDb250ZXh0KCkpOwogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGly\nZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKQogICAgICAgICAgICB1\ncGRhdGVJbnZlcnNlKHNtLCByZWwsIHN0b3JlLCBybSk7CiAgICAgICAgZWxz\nZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3coc20sIHN0\nb3JlLCBybSwgUm93LkFDVElPTl9JTlNFUlQpOwogICAgICAgICAgICBpZiAo\ncm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRGb3JlaWdu\nS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIHZv\naWQgdXBkYXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBz\ndG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FMRXhjZXB0\naW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAhPSBudWxs\nKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdl\ncgogICAgICAgICAgICAoc20uZmV0Y2hPYmplY3RGaWVsZChmaWVsZC5nZXRJ\nbmRleCgpKSwgc3RvcmUuZ2V0Q29udGV4dCgpKTsKCiAgICAgICAgaWYgKGZp\nZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0Up\nIHsKICAgICAgICAgICAgbnVsbEludmVyc2Uoc20sIHJtKTsKICAgICAgICAg\nICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAgICAg\nIH0gZWxzZSB7CiAgICAgICAgICAgIFJvdyByb3cgPSBmaWVsZC5nZXRSb3co\nc20sIHN0b3JlLCBybSwgUm93LkFDVElPTl9VUERBVEUpOwogICAgICAgICAg\nICBpZiAocm93ICE9IG51bGwpCiAgICAgICAgICAgICAgICBmaWVsZC5zZXRG\nb3JlaWduS2V5KHJvdywgcmVsKTsKICAgICAgICB9CiAgICB9CgogICAgcHVi\nbGljIHZvaWQgZGVsZXRlKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNT\ndG9yZSBzdG9yZSwgUm93TWFuYWdlciBybSkKICAgICAgICB0aHJvd3MgU1FM\nRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0TWFwcGVkQnkoKSAh\nPSBudWxsKQogICAgICAgICAgICByZXR1cm47CgogICAgICAgIGlmIChmaWVs\nZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7\nCiAgICAgICAgICAgIGlmIChzbS5nZXRMb2FkZWQoKS5nZXQoZmllbGQuZ2V0\nSW5kZXgoKSkpIHsKICAgICAgICAgICAgICAgIE9wZW5KUEFTdGF0ZU1hbmFn\nZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRlTWFuYWdlcihz\nbS4KICAgICAgICAgICAgICAgICAgICBmZXRjaE9iamVjdEZpZWxkKGZpZWxk\nLmdldEluZGV4KCkpLCBzdG9yZS5nZXRDb250ZXh0KCkpOwogICAgICAgICAg\nICAgICAgdXBkYXRlSW52ZXJzZShzbSwgcmVsLCBzdG9yZSwgcm0pOwogICAg\nICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG51bGxJbnZlcnNlKHNt\nLCBybSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmllbGQuZGVs\nZXRlUm93KHNtLCBzdG9yZSwgcm0pOwoKICAgICAgICAgICAgLy8gaWYgb3Vy\nIGZvcmVpZ24ga2V5IGhhcyBhIGRlbGV0ZSBhY3Rpb24sIHdlIG5lZWQgdG8g\nc2V0IHRoZQogICAgICAgICAgICAvLyByZWxhdGVkIG9iamVjdCBzbyBjb25z\ndHJhaW50cyBjYW4gYmUgZXZhbHVhdGVkCiAgICAgICAgICAgIE9wZW5KUEFT\ndGF0ZU1hbmFnZXIgcmVsID0gUmVsYXRpb25TdHJhdGVnaWVzLmdldFN0YXRl\nTWFuYWdlcgogICAgICAgICAgICAgICAgKHNtLmZldGNoT2JqZWN0RmllbGQo\nZmllbGQuZ2V0SW5kZXgoKSksIHN0b3JlLmdldENvbnRleHQoKSk7CiAgICAg\nICAgICAgIGlmIChyZWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgRm9y\nZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKENsYXNzTWFwcGlu\nZykKICAgICAgICAgICAgICAgICAgICByZWwuZ2V0TWV0YURhdGEoKSk7CiAg\nICAgICAgICAgICAgICBpZiAoZmsuZ2V0RGVsZXRlQWN0aW9uKCkgPT0gRm9y\nZWlnbktleS5BQ1RJT05fUkVTVFJJQ1QgfHwKICAgICAgICAgICAgICAgICAg\nICBmay5nZXREZWxldGVBY3Rpb24oKSA9PSBGb3JlaWduS2V5LkFDVElPTl9D\nQVNDQURFKSB7CiAgICAgICAgICAgICAgICAgICAgUm93IHJvdyA9IGZpZWxk\nLmdldFJvdyhzbSwgc3RvcmUsIHJtLCBSb3cuQUNUSU9OX0RFTEVURSk7CiAg\nICAgICAgICAgICAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIG51bGws\nIHJlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAg\nICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBOdWxsIGludmVyc2UgcmVsYXRp\nb25zIHRoYXQgcmVmZXJlbmNlIHRoZSBnaXZlbiBvYmplY3QuCiAgICAgKi8K\nICAgIHByaXZhdGUgdm9pZCBudWxsSW52ZXJzZShPcGVuSlBBU3RhdGVNYW5h\nZ2VyIHNtLCBSb3dNYW5hZ2VyIHJtKQogICAgICAgIHRocm93cyBTUUxFeGNl\ncHRpb24gewogICAgICAgIGlmIChmaWVsZC5nZXRVc2VDbGFzc0NyaXRlcmlh\nKCkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgRm9yZWlnbktleSBm\nayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoKTsKICAgICAgICBDb2x1bW5JTyBp\nbyA9IGZpZWxkLmdldENvbHVtbklPKCk7CiAgICAgICAgaWYgKCFpby5pc0Fu\neVVwZGF0YWJsZShmaywgdHJ1ZSkpCiAgICAgICAgICAgIHJldHVybjsKCiAg\nICAgICAgLy8gbnVsbCBpbnZlcnNlIGlmIG5vdCBhbHJlYWR5IGVuZm9yY2Vk\nIGJ5IGZrCiAgICAgICAgaWYgKGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1h\ncHBpbmdzKCkubGVuZ3RoICE9IDEpCiAgICAgICAgICAgIHRocm93IFJlbGF0\naW9uU3RyYXRlZ2llcy51bmludmVyc2FibGUoZmllbGQpOwogICAgICAgIFJv\ndyByb3cgPSBybS5nZXRBbGxSb3dzKGZrLmdldFRhYmxlKCksIFJvdy5BQ1RJ\nT05fVVBEQVRFKTsKICAgICAgICByb3cuc2V0Rm9yZWlnbktleShmaywgaW8s\nIG51bGwpOwogICAgICAgIHJvdy53aGVyZUZvcmVpZ25LZXkoZmssIHNtKTsK\nICAgICAgICBybS5mbHVzaEFsbFJvd3Mocm93KTsKICAgIH0KCiAgICAvKioK\nICAgICAqIFRoaXMgbWV0aG9kIHVwZGF0ZXMgdGhlIGludmVyc2UgY29sdW1u\ncyBvZiBvdXIgcmVsYXRpb24KICAgICAqIHdpdGggdGhlIGdpdmVuIG9iamVj\ndC4KICAgICAqLwogICAgcHJpdmF0ZSB2b2lkIHVwZGF0ZUludmVyc2UoT3Bl\nbkpQQVN0YXRlTWFuYWdlciBzbSwgT3BlbkpQQVN0YXRlTWFuYWdlciByZWws\nCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBSb3dNYW5hZ2VyIHJtKQogICAg\nICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAgIGlmIChyZWwgPT0g\nbnVsbCkKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICBGb3JlaWduS2V5\nIGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbHVtbklP\nIGlvID0gZmllbGQuZ2V0Q29sdW1uSU8oKTsKCiAgICAgICAgaW50IGFjdGlv\nbjsKICAgICAgICBpZiAocmVsLmlzTmV3KCkgJiYgIXJlbC5pc0ZsdXNoZWQo\nKSkgewogICAgICAgICAgICBpZiAoc20uaXNEZWxldGVkKCkgfHwgIWlvLmlz\nQW55SW5zZXJ0YWJsZShmaywgZmFsc2UpKQogICAgICAgICAgICAgICAgcmV0\ndXJuOwogICAgICAgICAgICBhY3Rpb24gPSBSb3cuQUNUSU9OX0lOU0VSVDsK\nICAgICAgICB9IGVsc2UgaWYgKHJlbC5pc0RlbGV0ZWQoKSkgewogICAgICAg\nICAgICBpZiAocmVsLmlzRmx1c2hlZCgpIHx8ICFzbS5pc0RlbGV0ZWQoKSkK\nICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgYWN0aW9uID0g\nUm93LkFDVElPTl9ERUxFVEU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAg\nICAgaWYgKHNtLmlzRGVsZXRlZCgpKQogICAgICAgICAgICAgICAgc20gPSBu\ndWxsOwogICAgICAgICAgICBpZiAoIWlvLmlzQW55VXBkYXRhYmxlKGZrLCBz\nbSA9PSBudWxsKSkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAg\nICAgYWN0aW9uID0gUm93LkFDVElPTl9VUERBVEU7CiAgICAgICAgfQoKICAg\nICAgICBpZiAoZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5s\nZW5ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVn\naWVzLnVuaW52ZXJzYWJsZShmaWVsZCk7CgogICAgICAgIC8vIGdldCB0aGUg\ncm93IGZvciB0aGUgaW52ZXJzZSBvYmplY3Q7IHRoZSByb3cgbWlnaHQgYmUg\naW4gYSBzZWNvbmRhcnkKICAgICAgICAvLyB0YWJsZSBpZiB0aGVyZSBpcyBh\nIGZpZWxkIGNvbnRyb2xsaW5nIHRoZSBmb3JlaWduIGtleQogICAgICAgIFJv\ndyByb3cgPSBudWxsOwogICAgICAgIEZpZWxkTWFwcGluZ1tdIGludnMgPSBm\naWVsZC5nZXRJbnZlcnNlTWFwcGluZ3MoKTsKICAgICAgICBmb3IgKGludCBp\nID0gMDsgaSA8IGludnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYg\nKGludnNbaV0uZ2V0TWFwcGVkQnlNZXRhRGF0YSgpID09IGZpZWxkCiAgICAg\nICAgICAgICAgICAmJiBpbnZzW2ldLmdldFR5cGVDb2RlKCkgPT0gSmF2YVR5\ncGVzLlBDKSB7CiAgICAgICAgICAgICAgICByb3cgPSBpbnZzW2ldLmdldFJv\ndyhyZWwsIHN0b3JlLCBybSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIGJy\nZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIENsYXNzTWFw\ncGluZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAg\nICAgICBpZiAocm93ID09IG51bGwpCiAgICAgICAgICAgIHJvdyA9IHJtLmdl\ndFJvdyhyZWxNYXBwaW5nLmdldFRhYmxlKCksIGFjdGlvbiwgcmVsLCB0cnVl\nKTsKCiAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiB1cGRhdGUsIHRoaXMgbWln\naHQgYmUgdGhlIG9ubHkgbW9kIHRvIHRoZSByb3csIHNvCiAgICAgICAgLy8g\nbWFrZSBzdXJlIHRoZSB3aGVyZSBjb25kaXRpb24gaXMgc2V0CiAgICAgICAg\naWYgKGFjdGlvbiA9PSBSb3cuQUNUSU9OX1VQREFURQogICAgICAgICAgICAm\nJiByb3cuZ2V0VGFibGUoKSA9PSByZWxNYXBwaW5nLmdldFRhYmxlKCkpCiAg\nICAgICAgICAgIHJvdy53aGVyZVByaW1hcnlLZXkocmVsKTsKCiAgICAgICAg\nLy8gdXBkYXRlIHRoZSBpbnZlcnNlIHBvaW50ZXIgd2l0aCBvdXIgb2lkIHZh\nbHVlCiAgICAgICAgcm93LnNldEZvcmVpZ25LZXkoZmssIGlvLCBzbSk7CiAg\nICB9CgogICAgcHVibGljIGludCBzdXBwb3J0c1NlbGVjdChTZWxlY3Qgc2Vs\nLCBpbnQgdHlwZSwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwKICAgICAgICBK\nREJDU3RvcmUgc3RvcmUsIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gp\nIHsKICAgICAgICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9KT0lOTEVTUykK\nICAgICAgICAgICAgcmV0dXJuIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkg\nIT0gZmllbGQuSk9JTl9JTlZFUlNFCiAgICAgICAgICAgICAgICAmJiBzZWwu\naXNTZWxlY3RlZChmaWVsZC5nZXRUYWJsZSgpKSkgPyAxIDogMDsKICAgICAg\nICBpZiAodHlwZSA9PSBTZWxlY3QuVFlQRV9UV09fUEFSVCkKICAgICAgICAg\nICAgcmV0dXJuIDE7CgogICAgICAgIC8vIGFscmVhZHkgY2FjaGVkPwogICAg\nICAgIGlmIChzbSAhPSBudWxsKSB7CiAgICAgICAgICAgIE9iamVjdCBvaWQg\nPSBzbS5nZXRJbnRlcm1lZGlhdGUoZmllbGQuZ2V0SW5kZXgoKSk7CiAgICAg\nICAgICAgIGlmIChzdG9yZS5nZXRDb250ZXh0KCkuZmluZENhY2hlZChvaWQs\nIG51bGwpICE9IG51bGwpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAg\nICAgICB9CgogICAgICAgIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5n\nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIHN3aXRjaCAo\ndHlwZSkgewogICAgICAgICAgICBjYXNlIFNlbGVjdC5FQUdFUl9QQVJBTExF\nTDoKICAgICAgICAgICAgICAgIHJldHVybiBjbHNzLmxlbmd0aDsKICAgICAg\nICAgICAgY2FzZSBTZWxlY3QuRUFHRVJfT1VURVI6CiAgICAgICAgICAgICAg\nICByZXR1cm4gKGNsc3MubGVuZ3RoID09IDEgJiYgc3RvcmUuZ2V0REJEaWN0\naW9uYXJ5KCkuY2FuT3V0ZXJKb2luCiAgICAgICAgICAgICAgICAgICAgKHNl\nbC5nZXRKb2luU3ludGF4KCksIGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzc1sw\nXSkpKSA/IDEgOgogICAgICAgICAgICAgICAgICAgIDA7CiAgICAgICAgICAg\nIGNhc2UgU2VsZWN0LkVBR0VSX0lOTkVSOgogICAgICAgICAgICAgICAgcmV0\ndXJuIChjbHNzLmxlbmd0aCA9PSAxKSA/IDEgOiAwOwogICAgICAgICAgICBk\nZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQog\nICAgfQoKICAgIHB1YmxpYyB2b2lkIHNlbGVjdEVhZ2VyUGFyYWxsZWwoU2Vs\nZWN0RXhlY3V0b3Igc2VsLAogICAgICAgIGZpbmFsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sIGZpbmFsIEpEQkNTdG9yZSBzdG9yZSwKICAgICAgICBmaW5h\nbCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBmaW5hbCBpbnQgZWFn\nZXJNb2RlKSB7CiAgICAgICAgZmluYWwgQ2xhc3NNYXBwaW5nW10gY2xzcyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKCk7CiAgICAgICAg\naWYgKCEoc2VsIGluc3RhbmNlb2YgVW5pb24pKQogICAgICAgICAgICBzZWxl\nY3RFYWdlclBhcmFsbGVsKChTZWxlY3QpIHNlbCwgY2xzc1swXSwgc3RvcmUs\nIGZldGNoLCBlYWdlck1vZGUpOwogICAgICAgIGVsc2UgewogICAgICAgICAg\nICBVbmlvbiB1bmlvbiA9IChVbmlvbikgc2VsOwogICAgICAgICAgICBpZiAo\nZmV0Y2guZ2V0U3ViY2xhc3NGZXRjaE1vZGUgKGZpZWxkLmdldFR5cGVNYXBw\naW5nKCkpIAogICAgICAgICAgICAgICAgIT0gSkRCQ0ZldGNoQ29uZmlndXJh\ndGlvbi5FQUdFUl9KT0lOKQogICAgICAgICAgICAgICAgdW5pb24uYWJvcnRV\nbmlvbigpOwogICAgICAgICAgICB1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNl\nbGVjdG9yKCkgewogICAgICAgICAgICAgICAgcHVibGljIHZvaWQgc2VsZWN0\nKFNlbGVjdCBzZWwsIGludCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICBz\nZWxlY3RFYWdlclBhcmFsbGVsKHNlbCwgY2xzc1tpZHhdLCBzdG9yZSwgZmV0\nY2gsCiAgICAgICAgICAgICAgICAgICAgICAgIGVhZ2VyTW9kZSk7CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0K\nCiAgICAvKioKICAgICAqIFBlcmZvcm0gYW4gZWFnZXIgcGFyYWxsZWwgc2Vs\nZWN0LgogICAgICovCiAgICBwcml2YXRlIHZvaWQgc2VsZWN0RWFnZXJQYXJh\nbGxlbChTZWxlY3Qgc2VsLCBDbGFzc01hcHBpbmcgY2xzLAogICAgICAgIEpE\nQkNTdG9yZSBzdG9yZSwgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbiBmZXRjaCwg\naW50IGVhZ2VyTW9kZSkgewogICAgICAgIHNlbC5zZWxlY3RQcmltYXJ5S2V5\nKGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpKTsKICAgICAgICAvLyBzZXQg\nYSB2YXJpYWJsZSBuYW1lIHRoYXQgZG9lcyBub3QgY29uZmxpY3Qgd2l0aCBh\nbnkgaW4gdGhlIHF1ZXJ5OwogICAgICAgIC8vIHVzaW5nIGEgdmFyaWFibGUg\nZ3VhcmFudGVlcyB0aGF0IHRoZSBzZWxlY3RlZCBkYXRhIHdpbGwgdXNlIGRp\nZmZlcmVudAogICAgICAgIC8vIGFsaWFzZXMgYW5kIGpvaW5zIHRoYW4gYW55\nIGV4aXN0aW5nIFdIRVJFIGNvbmRpdGlvbnMgb24gdGhpcyBmaWVsZAogICAg\nICAgIC8vIHRoYXQgbWlnaHQgb3RoZXJ3aXNlIGxpbWl0IHRoZSByZWxhdGlv\nbnMgdGhhdCBtYXRjaAogICAgICAgIEpvaW5zIGpvaW5zID0gc2VsLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNscywgdHJ1ZSk7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLCBlYWdlck1v\nZGUsIAogICAgICAgICAgICBqb2lucyk7CiAgICB9CgogICAgcHVibGljIHZv\naWQgc2VsZWN0RWFnZXJKb2luKFNlbGVjdCBzZWwsIE9wZW5KUEFTdGF0ZU1h\nbmFnZXIgc20sCiAgICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hD\nb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJNb2RlKSB7CiAgICAgICAg\nLy8gbGltaXQgdGhlIGVhZ2VyIG1vZGUgdG8gc2luZ2xlIG9uIHJlY3Vyc2l2\nZSBlYWdlciBmZXRjaGluZyBiL2MKICAgICAgICAvLyBhdCB0aGlzIHBvaW50\nIHRoZSBzZWxlY3QgaGFzIGJlZW4gbW9kaWZpZWQgYW5kIGFuIGF0dGVtcHQg\ndG8KICAgICAgICAvLyBjbG9uZSBpdCBmb3IgYSB0by1tYW55IGVhZ2VyIHNl\nbGVjdCBjYW4gcmVzdWx0IGluIGEgY2xvbmUgdGhhdAogICAgICAgIC8vIHBy\nb2R1Y2VzIGludmFsaWQgU1FMCiAgICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9\nIGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBpbmdzKClbMF07CiAgICAg\nICAgYm9vbGVhbiBmb3JjZUlubmVyID0gZmV0Y2guaGFzRmV0Y2hJbm5lckpv\naW4oZmllbGQuZ2V0RnVsbE5hbWUoZmFsc2UpKSA/CiAgICAgICAgICAgICAg\nICB0cnVlIDogZmFsc2U7CiAgICAgICAgc2VsLnNlbGVjdChjbHMsIGZpZWxk\nLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwgc3RvcmUsIGZldGNoLAogICAgICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uLkVBR0VSX0pPSU4sCiAgICAg\nICAgICAgIGVhZ2VySm9pbihzZWwubmV3Sm9pbnMoKSwgY2xzLCBmb3JjZUlu\nbmVyKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgdGhlIGpvaW5zIG5l\nZWRlZCB0byBzZWxlY3QvbG9hZCBlYWdlciBkYXRhLgogICAgICovCiAgICBw\ncml2YXRlIEpvaW5zIGVhZ2VySm9pbihKb2lucyBqb2lucywgQ2xhc3NNYXBw\naW5nIGNscywgYm9vbGVhbiBmb3JjZUlubmVyKSB7CiAgICAgICAgYm9vbGVh\nbiBpbnZlcnNlID0gZmllbGQuZ2V0Sm9pbkRpcmVjdGlvbigpID09IGZpZWxk\nLkpPSU5fSU5WRVJTRTsKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAg\nICAgICAgam9pbnMgPSBqb2luKGpvaW5zLCBmYWxzZSk7CiAgICAgICAgICAg\nIGpvaW5zID0gc2V0RW1iZWRkZWRWYXJpYWJsZShqb2lucyk7CiAgICAgICAg\nfQoKICAgICAgICAvLyBhbmQgam9pbiBpbnRvIHJlbGF0aW9uCiAgICAgICAg\nRm9yZWlnbktleSBmayA9IGZpZWxkLmdldEZvcmVpZ25LZXkoY2xzKTsKICAg\nICAgICBpZiAoIWZvcmNlSW5uZXIgJiYgZmllbGQuZ2V0TnVsbFZhbHVlKCkg\nIT0gRmllbGRNYXBwaW5nLk5VTExfRVhDRVBUSU9OKQogICAgICAgICAgICBy\nZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRpb24oZmllbGQuZ2V0TmFtZSgp\nLCBmaywgZmllbGQuCiAgICAgICAgICAgICAgICBnZXRUeXBlTWFwcGluZygp\nLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZhbHNl\nKTsKICAgICAgICByZXR1cm4gam9pbnMuam9pblJlbGF0aW9uKGZpZWxkLmdl\ndE5hbWUoKSwgZmssIGZpZWxkLmdldFR5cGVNYXBwaW5nKCksIAogICAgICAg\nICAgICBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGludmVyc2UsIGZh\nbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIElmIGpvaW5pbmcgZnJvbSBh\nbiBlbWJlZGRlZCBvd25lciwgdXNlIHZhcmlhYmxlIHRvIGNyZWF0ZSBhIHVu\naXF1ZQogICAgICogYWxpYXMgaW4gY2FzZSBvd25lciBjb250YWlucyBvdGhl\nciBzYW1lLXR5cGVkIGVtYmVkZGVkIHJlbGF0aW9ucy4KICAgICAqLwogICAg\ncHJpdmF0ZSBKb2lucyBzZXRFbWJlZGRlZFZhcmlhYmxlKEpvaW5zIGpvaW5z\nKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldERlZmluaW5nTWV0YURhdGEoKS5n\nZXRFbWJlZGRpbmdNZXRhRGF0YSgpID09IG51bGwpCiAgICAgICAgICAgIHJl\ndHVybiBqb2luczsKICAgICAgICByZXR1cm4gam9pbnMuc2V0VmFyaWFibGUo\nZmllbGQuZ2V0RGVmaW5pbmdNZXRhRGF0YSgpLgogICAgICAgICAgICBnZXRF\nbWJlZGRpbmdNZXRhRGF0YSgpLmdldEZpZWxkTWV0YURhdGEoKS5nZXROYW1l\nKCkpOwogICAgfQoKICAgIHB1YmxpYyBpbnQgc2VsZWN0KFNlbGVjdCBzZWws\nIE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9yZSwKICAg\nICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBpbnQgZWFnZXJN\nb2RlKSB7CiAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJlY3Rpb24oKSA9\nPSBmaWVsZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgIHJldHVybiAtMTsK\nICAgICAgICAvLyBhbHJlYWR5IGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNt\nICE9IG51bGwgJiYgc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4\nKCkpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICBp\nZiAoIUJvb2xlYW4uVFJVRS5lcXVhbHMoX2ZrT2lkKSkKICAgICAgICAgICAg\ncmV0dXJuIC0xOwogICAgICAgIHNlbC5zZWxlY3QoZmllbGQuZ2V0Q29sdW1u\ncygpLCBmaWVsZC5qb2luKHNlbCkpOwogICAgICAgIHJldHVybiAwOwogICAg\nfQoKICAgIHB1YmxpYyBPYmplY3QgbG9hZEVhZ2VyUGFyYWxsZWwoT3BlbkpQ\nQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3JlIHN0b3JlLAogICAgICAgIEpE\nQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gsIE9iamVjdCByZXMpCiAgICAg\nICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAgICAgICAgLy8gcHJvY2VzcyBi\nYXRjaGVkIHJlc3VsdHMgaWYgd2UgaGF2ZW4ndCBhbHJlYWR5CiAgICAgICAg\nTWFwIHJlbHM7CiAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIFJlc3VsdCkK\nICAgICAgICAgICAgcmVscyA9IHByb2Nlc3NFYWdlclBhcmFsbGVsUmVzdWx0\nKHNtLCBzdG9yZSwgZmV0Y2gsIChSZXN1bHQpIHJlcyk7CiAgICAgICAgZWxz\nZQogICAgICAgICAgICByZWxzID0gKE1hcCkgcmVzOwoKICAgICAgICAvLyBz\ndG9yZSBvYmplY3QgZm9yIHRoaXMgb2lkIGluIGluc3RhbmNlCiAgICAgICAg\nc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgcmVscy5yZW1vdmUo\nc20uZ2V0T2JqZWN0SWQoKSkpOwogICAgICAgIHJldHVybiByZWxzOwogICAg\nfQoKICAgIC8qKgogICAgICogUHJvY2VzcyB0aGUgZ2l2ZW4gYmF0Y2hlZCBy\nZXN1bHQuCiAgICAgKi8KICAgIHByaXZhdGUgTWFwIHByb2Nlc3NFYWdlclBh\ncmFsbGVsUmVzdWx0KE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sCiAgICAgICAg\nSkRCQ1N0b3JlIHN0b3JlLCBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNo\nLCBSZXN1bHQgcmVzKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewog\nICAgICAgIC8vIGRvIHNhbWUgam9pbnMgYXMgZm9yIGxvYWQKICAgICAgICAv\nLyMjIyBjaGVhdDogd2Uga25vdyB0eXBpY2FsIHJlc3VsdCBqb2lucyBvbmx5\nIGNhcmUgYWJvdXQgdGhlIHJlbGF0aW9uCiAgICAgICAgLy8jIyMgcGF0aDsg\ndGh1cyB3ZSBjYW4gaWdub3JlIGRpZmZlcmVudCBtYXBwaW5ncwogICAgICAg\nIENsYXNzTWFwcGluZ1tdIGNsc3MgPSBmaWVsZC5nZXRJbmRlcGVuZGVudFR5\ncGVNYXBwaW5ncygpOwogICAgICAgIEpvaW5zIGpvaW5zID0gcmVzLm5ld0pv\naW5zKCkuc2V0VmFyaWFibGUoIioiKTsKICAgICAgICBlYWdlckpvaW4oam9p\nbnMsIGNsc3NbMF0sIHRydWUpOwoKICAgICAgICBNYXAgcmVscyA9IG5ldyBI\nYXNoTWFwKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIG93bmVyID0gZmllbGQu\nZ2V0RGVmaW5pbmdNYXBwaW5nKCk7CiAgICAgICAgQ2xhc3NNYXBwaW5nIGNs\nczsKICAgICAgICBPYmplY3Qgb2lkOwogICAgICAgIHdoaWxlIChyZXMubmV4\ndCgpKSB7CiAgICAgICAgICAgIGNscyA9IHJlcy5nZXRCYXNlTWFwcGluZygp\nOwogICAgICAgICAgICBpZiAoY2xzID09IG51bGwpCiAgICAgICAgICAgICAg\nICBjbHMgPSBjbHNzWzBdOwogICAgICAgICAgICBvaWQgPSBvd25lci5nZXRP\nYmplY3RJZChzdG9yZSwgcmVzLCBudWxsLCB0cnVlLCBudWxsKTsKICAgICAg\nICAgICAgcmVscy5wdXQob2lkLCByZXMubG9hZChjbHMsIHN0b3JlLCBmZXRj\naCwgam9pbnMpKTsKICAgICAgICB9CiAgICAgICAgcmVzLmNsb3NlKCk7Cgog\nICAgICAgIHJldHVybiByZWxzOwogICAgfQoKICAgIHB1YmxpYyB2b2lkIGxv\nYWRFYWdlckpvaW4oT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgSkRCQ1N0b3Jl\nIHN0b3JlLAogICAgICAgIEpEQkNGZXRjaENvbmZpZ3VyYXRpb24gZmV0Y2gs\nIFJlc3VsdCByZXMpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAg\nICAgICAgQ2xhc3NNYXBwaW5nIGNscyA9IGZpZWxkLmdldEluZGVwZW5kZW50\nVHlwZU1hcHBpbmdzKClbMF07CgogICAgICAgIC8vIGZvciBpbnZlcnNlRWFn\nZXIgZmllbGQKICAgICAgICBGaWVsZE1hcHBpbmcgbWFwcGVkQnlGaWVsZE1h\ncHBpbmcgPSBmaWVsZC5nZXRNYXBwZWRCeU1hcHBpbmcoKTsKICAgICAgICBQ\nZXJzaXN0ZW5jZUNhcGFibGUgbWFwcGVkQnlWYWx1ZSA9IG51bGw7CgogICAg\nICAgIGlmIChtYXBwZWRCeUZpZWxkTWFwcGluZyAhPSBudWxsKSB7CiAgICAg\nICAgCVZhbHVlTWFwcGluZyB2YWwgPSBtYXBwZWRCeUZpZWxkTWFwcGluZy5n\nZXRWYWx1ZU1hcHBpbmcoKTsKICAgICAgICAJQ2xhc3NNZXRhRGF0YSBkZWNN\nZXRhID0gdmFsLmdldFR5cGVNZXRhRGF0YSgpOwogICAgICAgIAkvLyB0aGlz\nIGludmVyc2UgZmllbGQgZG9lcyBub3QgaGF2ZSBjb3JyZXNwb25kaW5nIGNs\nYXNzTWFwcGluZwogICAgICAgIAkvLyBpdHMgdmFsdWUgbWF5IGJlIGEgY29s\nbGVjdGlvbi9tYXAgZXRjLgogICAgICAgIAlpZiAoZGVjTWV0YSAhPSBudWxs\nKSB7CiAgICAgICAgCSAgICBtYXBwZWRCeVZhbHVlID0gc20uZ2V0UGVyc2lz\ndGVuY2VDYXBhYmxlKCk7CiAgICAgICAgCSAgICByZXMuc2V0TWFwcGVkQnlG\naWVsZE1hcHBpbmcobWFwcGVkQnlGaWVsZE1hcHBpbmcpOwogICAgICAgIAkg\nICAgcmVzLnNldE1hcHBlZEJ5VmFsdWUobWFwcGVkQnlWYWx1ZSk7CiAgICAg\nICAgCX0KICAgICAgICB9CgogICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxk\nLmdldEluZGV4KCksIHJlcy5sb2FkKGNscywgc3RvcmUsIGZldGNoLAogICAg\nICAgICAgICBlYWdlckpvaW4ocmVzLm5ld0pvaW5zKCksIGNscywgZmFsc2Up\nKSk7CiAgICB9CgogICAgcHVibGljIHZvaWQgbG9hZChPcGVuSlBBU3RhdGVN\nYW5hZ2VyIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgSkRCQ0ZldGNo\nQ29uZmlndXJhdGlvbiBmZXRjaCwgUmVzdWx0IHJlcykKICAgICAgICB0aHJv\nd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBpZiAoZmllbGQuZ2V0Sm9pbkRp\ncmVjdGlvbigpID09IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAgICAgICAg\ncmV0dXJuOwogICAgICAgIC8vIGNhY2hlZCBvaWQ/CiAgICAgICAgaWYgKHNt\nICE9IG51bGwgJiYgc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4\nKCkpICE9IG51bGwpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAo\nIUJvb2xlYW4uVFJVRS5lcXVhbHMoX2ZrT2lkKSkKICAgICAgICAgICAgcmV0\ndXJuOwogICAgICAgIGlmICghcmVzLmNvbnRhaW5zQWxsKGZpZWxkLmdldENv\nbHVtbnMoKSkpCiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgLy8gZ2V0\nIHRoZSByZWxhdGVkIG9iamVjdCdzIG9pZAogICAgICAgIENsYXNzTWFwcGlu\nZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAg\nICBPYmplY3Qgb2lkID0gbnVsbDsKICAgICAgICBpZiAocmVsTWFwcGluZy5p\nc01hcHBlZCgpKSB7CiAgICAgICAgICAgIG9pZCA9IHJlbE1hcHBpbmcuZ2V0\nT2JqZWN0SWQoc3RvcmUsIHJlcywgZmllbGQuZ2V0Rm9yZWlnbktleSgpLAog\nICAgICAgICAgICAgICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAhPSBWYWx1\nZU1hcHBpbmcuUE9MWV9GQUxTRSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsK\nICAgICAgICAgICAgQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMo\nKTsKICAgICAgICAgICAgaWYgKHJlbE1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBl\nKCkgPT0gQ2xhc3NNYXBwaW5nLklEX0RBVEFTVE9SRSkgewogICAgICAgICAg\nICAgICAgbG9uZyBpZCA9IHJlcy5nZXRMb25nKGNvbHNbMF0pOwogICAgICAg\nICAgICAgICAgaWYgKCFyZXMud2FzTnVsbCgpKQogICAgICAgICAgICAgICAg\nICAgIG9pZCA9IHN0b3JlLm5ld0RhdGFTdG9yZUlkKGlkLCByZWxNYXBwaW5n\nLCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgICAg\nICAvLyBhcHBsaWNhdGlvbiBpZAogICAgICAgICAgICAgICAgaWYgKGNvbHMu\nbGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBPYmplY3QgdmFs\nID0gcmVzLmdldE9iamVjdChjb2xzWzBdLCBudWxsLCBudWxsKTsKICAgICAg\nICAgICAgICAgICAgICBpZiAodmFsICE9IG51bGwpCiAgICAgICAgICAgICAg\nICAgICAgICAgIG9pZCA9IEFwcGxpY2F0aW9uSWRzLmZyb21QS1ZhbHVlcyhu\nZXcgT2JqZWN0W117IHZhbCB9LAogICAgICAgICAgICAgICAgICAgICAgICAg\nICAgcmVsTWFwcGluZyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAg\nICAgICAgICAgICAgICAgIE9iamVjdFtdIHZhbHMgPSBuZXcgT2JqZWN0W2Nv\nbHMubGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGludCBpID0g\nMDsgaSA8IGNvbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAg\nICAgICAgdmFsc1tpXSA9IHJlcy5nZXRPYmplY3QoY29sc1tpXSwgbnVsbCwg\nbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWxzW2ldID09\nIG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAg\nICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gY29scy5sZW5ndGggLSAx\nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2lkID0gQXBwbGljYXRp\nb25JZHMuZnJvbVBLVmFsdWVzKHZhbHMsIHJlbE1hcHBpbmcpOwogICAgICAg\nICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAg\nfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9pZCA9PSBudWxsKQogICAgICAg\nICAgICBzbS5zdG9yZU9iamVjdChmaWVsZC5nZXRJbmRleCgpLCBudWxsKTsK\nICAgICAgICBlbHNlCiAgICAgICAgICAgIHNtLnNldEludGVybWVkaWF0ZShm\naWVsZC5nZXRJbmRleCgpLCBvaWQpOwogICAgfQoKICAgIHB1YmxpYyB2b2lk\nIGxvYWQoZmluYWwgT3BlbkpQQVN0YXRlTWFuYWdlciBzbSwgZmluYWwgSkRC\nQ1N0b3JlIHN0b3JlLAogICAgICAgIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3Vy\nYXRpb24gZmV0Y2gpCiAgICAgICAgdGhyb3dzIFNRTEV4Y2VwdGlvbiB7CiAg\nICAgICAgLy8gY2hlY2sgZm9yIGNhY2hlZCBvaWQgdmFsdWUsIG9yIGxvYWQg\nb2lkIGlmIG5vIHdheSB0byBqb2luCiAgICAgICAgaWYgKEJvb2xlYW4uVFJV\nRS5lcXVhbHMoX2ZrT2lkKSkgewogICAgICAgICAgICBPYmplY3Qgb2lkID0g\nc20uZ2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCkpOwogICAgICAg\nICAgICBpZiAob2lkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIE9iamVj\ndCB2YWwgPSBzdG9yZS5maW5kKG9pZCwgZmllbGQsIGZldGNoKTsKICAgICAg\nICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdldEluZGV4KCksIHZh\nbCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAg\nICAgICB9CgogICAgICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIHJlbHMgPSBm\naWVsZC5nZXRJbmRlcGVuZGVudFR5cGVNYXBwaW5ncygpOwogICAgICAgIGZp\nbmFsIGludCBzdWJzID0gZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpOwog\nICAgICAgIGZpbmFsIEpvaW5zW10gcmVzSm9pbnMgPSBuZXcgSm9pbnNbcmVs\ncy5sZW5ndGhdOwoKICAgICAgICAvL2NhY2hlIHVuaW9uIGZvciBmaWVsZCBo\nZXJlCiAgICAgICAgLy9zZWxlY3QgZGF0YSBmb3IgdGhpcyBzbQogICAgICAg\nIFVuaW9uIHVuaW9uID0gbnVsbDsKICAgICAgICBTZWxlY3RJbXBsIHNlbCA9\nIG51bGw7CiAgICAgICAgTGlzdCBwYXJtTGlzdCA9IG51bGw7CgogICAgICAg\nIGlmICghKChKREJDU3RvcmVNYW5hZ2VyKXN0b3JlKS5pc1F1ZXJ5U1FMQ2Fj\naGVPbigpKQogICAgICAgICAgICB1bmlvbiA9IG5ld1VuaW9uKHNtLCBzdG9y\nZSwgZmV0Y2gsIHJlbHMsIHN1YnMsIHJlc0pvaW5zKTsKICAgICAgICBlbHNl\nIHsKICAgICAgICAgICAgTWFwPEpEQkNTdG9yZU1hbmFnZXIuU2VsZWN0S2V5\nLCBPYmplY3RbXT4gcmVsYXRpb25GaWVsZFVuaW9uQ2FjaGUgPSAKICAgICAg\nICAgICAgICAgICgoSkRCQ1N0b3JlTWFuYWdlcilzdG9yZSkuZ2V0Q2FjaGVN\nYXBGcm9tUXVlcnlTUUxDYWNoZSgKICAgICAgICAgICAgICAgIFJlbGF0aW9u\nRmllbGRTdHJhdGVneS5jbGFzcyk7CiAgICAgICAgICAgIGJvb2xlYW4gZm91\nbmQgPSB0cnVlOwogICAgICAgICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9u\nIGZldGNoQ2xvbmUgPSBuZXcgSkRCQ0ZldGNoQ29uZmlndXJhdGlvbkltcGwo\nKTsKICAgICAgICAgICAgZmV0Y2hDbG9uZS5jb3B5KGZldGNoKTsKICAgICAg\nICAgICAgSkRCQ1N0b3JlTWFuYWdlci5TZWxlY3RLZXkgc2VsS2V5ID0gCiAg\nICAgICAgICAgICAgICBuZXcgSkRCQ1N0b3JlTWFuYWdlci5TZWxlY3RLZXko\nbnVsbCwgZmllbGQsIGZldGNoKTsKICAgICAgICAgICAgT2JqZWN0W10gb2Jq\nID0gcmVsYXRpb25GaWVsZFVuaW9uQ2FjaGUuZ2V0KHNlbEtleSk7CiAgICAg\nICAgICAgIGlmIChvYmogIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdW5p\nb24gPSAoVW5pb24pIG9ialswXTsKICAgICAgICAgICAgICAgIHJlc0pvaW5z\nWzBdID0gKEpvaW5zKW9ialsxXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAg\nICAgICAgICAgICAgIHN5bmNocm9uaXplZChyZWxhdGlvbkZpZWxkVW5pb25D\nYWNoZSkgewogICAgICAgICAgICAgICAgICAgIG9iaiA9IHJlbGF0aW9uRmll\nbGRVbmlvbkNhY2hlLmdldChzZWxLZXkpOwogICAgICAgICAgICAgICAgICAg\nIGlmIChvYmogIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB1\nbmlvbiA9IChVbmlvbikgb2JqWzBdOwogICAgICAgICAgICAgICAgICAgICAg\nICByZXNKb2luc1swXSA9IChKb2lucykgb2JqWzFdOwogICAgICAgICAgICAg\nICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNl\nbGVjdCByZWxhdGVkIG1hcHBpbmcgY29sdW1uczsgam9pbmluZyBmcm9tIHRo\nZSAKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVsYXRlZCB0eXBlIGJh\nY2sgdG8gb3VyIGZrIHRhYmxlIGlmIG5vdCBhbiBpbnZlcnNlIAogICAgICAg\nICAgICAgICAgICAgICAgICAvLyBtYXBwaW5nIChpbiB3aGljaCBjYXNlIHdl\nIGNhbiBqdXN0IG1ha2Ugc3VyZSB0aGUgCiAgICAgICAgICAgICAgICAgICAg\nICAgIC8vIGludmVyc2UgY29scyA9PSBvdXIgcGsgdmFsdWVzKQogICAgICAg\nICAgICAgICAgICAgICAgICB1bmlvbiA9IG5ld1VuaW9uKHNtLCBzdG9yZSwg\nZmV0Y2gsIHJlbHMsIHN1YnMsIAogICAgICAgICAgICAgICAgICAgICAgICAg\nICAgICAgIHJlc0pvaW5zKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm91\nbmQgPSBmYWxzZTsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAg\nICAgfQogICAgICAgICAgICAgICAgICAgIHNlbCA9ICgoTG9naWNhbFVuaW9u\nLlVuaW9uU2VsZWN0KXVuaW9uLmdldFNlbGVjdHMoKVswXSkuCiAgICAgICAg\nICAgICAgICAgICAgICAgIGdldERlbGVnYXRlKCk7CiAgICAgICAgICAgICAg\nICAgICAgU1FMQnVmZmVyIGJ1ZiA9IHNlbC5nZXRTUUwoKTsKICAgICAgICAg\nICAgICAgICAgICBpZiAoYnVmID09IG51bGwpIHsKICAgICAgICAgICAgICAg\nICAgICAJKChTZWxlY3RJbXBsKXNlbCkuc2V0U1FMKHN0b3JlLCBmZXRjaCk7\nCiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gZmFsc2U7CiAgICAg\nICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBvbmx5\nIGNhY2hlIHRoZSB1bmlvbiB3aGVuIGVsZW1zIGxlbmd0aCBpcyAxIGZvciBu\nb3cKICAgICAgICAgICAgICAgICAgICBpZiAoIWZvdW5kICYmIHJlbHMubGVu\nZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0W10g\nb2JqMSA9IG5ldyBPYmplY3RbMl07CiAgICAgICAgICAgICAgICAgICAgICAg\nIG9iajFbMF0gPSB1bmlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgb2Jq\nMVsxXSA9IHJlc0pvaW5zWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAo\nKEpEQkNTdG9yZU1hbmFnZXIpc3RvcmUpLmFkZFRvU3FsQ2FjaGUoCiAgICAg\nICAgICAgICAgICAgICAgICAgICAgICByZWxhdGlvbkZpZWxkVW5pb25DYWNo\nZSwgc2VsS2V5LCBvYmoxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAg\nICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgTG9nIGxv\nZyA9IHN0b3JlLmdldENvbmZpZ3VyYXRpb24oKS4KICAgICAgICAgICAgICAg\nIGdldExvZyhKREJDQ29uZmlndXJhdGlvbi5MT0dfSkRCQyk7CiAgICAgICAg\nICAgIGlmIChsb2cuaXNUcmFjZUVuYWJsZWQoKSl7CiAgICAgICAgICAgICAg\nICBpZiAoZm91bmQpIAogICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZShf\nbG9jLmdldCgiY2FjaGUtaGl0IiwgZmllbGQsIHRoaXMuZ2V0Q2xhc3MoKSkp\nOyAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxz\nZQogICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZShfbG9jLmdldCgiY2Fj\naGUtbWlzc2VkIiwgZmllbGQsIHRoaXMuZ2V0Q2xhc3MoKSkpOwogICAgICAg\nICAgICB9CgogICAgICAgICAgICBwYXJtTGlzdCA9IG5ldyBBcnJheUxpc3Qo\nKTsKICAgICAgICAgICAgQ2xhc3NNYXBwaW5nIG1hcHBpbmcgPSBmaWVsZC5n\nZXREZWZpbmluZ01hcHBpbmcoKTsKICAgICAgICAgICAgT2JqZWN0IG9pZCA9\nIHNtLmdldE9iamVjdElkKCk7CiAgICAgICAgICAgIENvbHVtbltdIGNvbHMg\nPSBtYXBwaW5nLmdldFByaW1hcnlLZXlDb2x1bW5zKCk7CiAgICAgICAgICAg\nIGlmIChzZWwgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHNlbCA9ICgoTG9n\naWNhbFVuaW9uLlVuaW9uU2VsZWN0KXVuaW9uLmdldFNlbGVjdHMoKVswXSku\nCiAgICAgICAgICAgICAgICBnZXREZWxlZ2F0ZSgpOwoKICAgICAgICAgICAg\nc2VsLndoZXJlUHJpbWFyeUtleShtYXBwaW5nLCBjb2xzLCBjb2xzLCBvaWQs\nIHN0b3JlLCAKICAgICAgICAgICAgCW51bGwsIG51bGwsIHBhcm1MaXN0KTsK\nICAgICAgICB9CiAgICAgICAgCiAgICAgICAgUmVzdWx0IHJlcyA9IHVuaW9u\nLmV4ZWN1dGUoc3RvcmUsIGZldGNoLCBwYXJtTGlzdCk7CiAgICAgICAgdHJ5\nIHsKICAgICAgICAgICAgT2JqZWN0IHZhbCA9IG51bGw7CiAgICAgICAgICAg\nIGlmIChyZXMubmV4dCgpKQogICAgICAgICAgICAgICAgdmFsID0gcmVzLmxv\nYWQocmVsc1tyZXMuaW5kZXhPZigpXSwgc3RvcmUsIGZldGNoLAogICAgICAg\nICAgICAgICAgICAgIHJlc0pvaW5zW3Jlcy5pbmRleE9mKCldKTsKICAgICAg\nICAgICAgc20uc3RvcmVPYmplY3QoZmllbGQuZ2V0SW5kZXgoKSwgdmFsKTsK\nICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZXMuY2xvc2UoKTsK\nICAgICAgICB9CiAgICB9CiAgICAKICAgIHByb3RlY3RlZCBVbmlvbiBuZXdV\nbmlvbihmaW5hbCBPcGVuSlBBU3RhdGVNYW5hZ2VyIHNtLCAKICAgICAgICBm\naW5hbCBKREJDU3RvcmUgc3RvcmUsIGZpbmFsIEpEQkNGZXRjaENvbmZpZ3Vy\nYXRpb24gZmV0Y2gsIAogICAgICAgIGZpbmFsIENsYXNzTWFwcGluZ1tdIHJl\nbHMsIGZpbmFsIGludCBzdWJzLCAKICAgICAgICBmaW5hbCBKb2luc1tdIHJl\nc0pvaW5zKSB7CiAgICAgICAgVW5pb24gdW5pb24gPSBzdG9yZS5nZXRTUUxG\nYWN0b3J5KCkubmV3VW5pb24ocmVscy5sZW5ndGgpOwogICAgICAgIHVuaW9u\nLnNldEV4cGVjdGVkUmVzdWx0Q291bnQoMSwgZmFsc2UpOwogICAgICAgIGlm\nIChmZXRjaC5nZXRTdWJjbGFzc0ZldGNoTW9kZShmaWVsZC5nZXRUeXBlTWFw\ncGluZygpKQogICAgICAgICAgICAhPSBKREJDRmV0Y2hDb25maWd1cmF0aW9u\nLkVBR0VSX0pPSU4pCiAgICAgICAgICAgIHVuaW9uLmFib3J0VW5pb24oKTsK\nICAgICAgICB1bmlvbi5zZWxlY3QobmV3IFVuaW9uLlNlbGVjdG9yKCkgewog\nICAgICAgICAgICBwdWJsaWMgdm9pZCBzZWxlY3QoU2VsZWN0IHNlbCwgaW50\nIGlkeCkgewogICAgICAgICAgICAgICAgaWYgKGZpZWxkLmdldEpvaW5EaXJl\nY3Rpb24oKSA9PSBmaWVsZC5KT0lOX0lOVkVSU0UpCiAgICAgICAgICAgICAg\nICAgICAgc2VsLndoZXJlRm9yZWlnbktleShmaWVsZC5nZXRGb3JlaWduS2V5\nKHJlbHNbaWR4XSksCiAgICAgICAgICAgICAgICAgICAgICAgIHNtLmdldE9i\namVjdElkKCksIGZpZWxkLmdldERlZmluaW5nTWFwcGluZygpLCBzdG9yZSk7\nCiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBy\nZXNKb2luc1tpZHhdID0gc2VsLm5ld0pvaW5zKCkuam9pblJlbGF0aW9uKGZp\nZWxkLmdldE5hbWUoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQu\nZ2V0Rm9yZWlnbktleShyZWxzW2lkeF0pLCByZWxzW2lkeF0sCiAgICAgICAg\nICAgICAgICAgICAgICAgIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNzZXMoKSwg\nZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBmaWVsZC53aGVy\nZVByaW1hcnlLZXkoc2VsLCBzbSwgc3RvcmUpOwogICAgICAgICAgICAgICAg\nfQogICAgICAgICAgICAgICAgc2VsLnNlbGVjdChyZWxzW2lkeF0sIHN1YnMs\nIHN0b3JlLCBmZXRjaCwgZmV0Y2guRUFHRVJfSk9JTiwgCiAgICAgICAgICAg\nICAgICAgICAgcmVzSm9pbnNbaWR4XSk7CiAgICAgICAgICAgIH0KICAgICAg\nICB9KTsKICAgICAgICByZXR1cm4gdW5pb247CiAgICB9CgogICAgcHVibGlj\nIE9iamVjdCB0b0RhdGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpEQkNTdG9y\nZSBzdG9yZSkgewogICAgICAgIHJldHVybiBSZWxhdGlvblN0cmF0ZWdpZXMu\ndG9EYXRhU3RvcmVWYWx1ZShmaWVsZCwgdmFsLCBzdG9yZSk7CiAgICB9Cgog\nICAgcHVibGljIHZvaWQgYXBwZW5kSXNOdWxsKFNRTEJ1ZmZlciBzcWwsIFNl\nbGVjdCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAgICAgLy8gaWYgbm8gaW52\nZXJzZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0YWJsZSAodXN1YWxseSBh\nIG5vLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCdsbCBiZSBpbiB0aGUgcHJp\nbWFyeSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xzIGFyZSBudWxsOwogICAg\nICAgIC8vIGlmIGludmVyc2UsIHRoZW4gd2UgaGF2ZSB0byBkbyBhIHN1Yi1z\nZWxlY3QgdG8gc2VlIGlmIGFueSBpbnZlcnNlCiAgICAgICAgLy8gb2JqZWN0\ncyBwb2ludCBiYWNrIHRvIHRoaXMgZmllbGQncyBvd25lcgogICAgICAgIGlm\nIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgIT0gZmllbGQuSk9JTl9JTlZF\nUlNFKSB7CiAgICAgICAgICAgIC8vIyMjIHByb2JhYmx5IG5lZWQgc29tZSBz\nb3J0IG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZrIGNvbnN0YW50cwogICAgICAg\nICAgICBqb2lucyA9IGpvaW4oam9pbnMsIGZhbHNlKTsKICAgICAgICAgICAg\nQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENvbHVtbnMoKTsKICAgICAgICAg\nICAgaWYgKGNvbHMubGVuZ3RoID09IDApCiAgICAgICAgICAgICAgICBzcWwu\nYXBwZW5kKCIxIDw+IDEiKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAg\nICAgICAgc3FsLmFwcGVuZChzZWwuZ2V0Q29sdW1uQWxpYXMoY29sc1swXSwg\nam9pbnMpKS4KICAgICAgICAgICAgICAgICAgICBhcHBlbmQoIiBJUyAiKS5h\ncHBlbmRWYWx1ZShudWxsLCBjb2xzWzBdKTsKICAgICAgICB9IGVsc2UKICAg\nICAgICAgICAgdGVzdEludmVyc2VOdWxsKHNxbCwgc2VsLCBqb2lucywgdHJ1\nZSk7CiAgICB9CgogICAgcHVibGljIHZvaWQgYXBwZW5kSXNOb3ROdWxsKFNR\nTEJ1ZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zKSB7CiAgICAg\nICAgLy8gaWYgbm8gaW52ZXJzZSwganVzdCBqb2luIHRvIG1hcHBpbmcncyB0\nYWJsZSAodXN1YWxseSBhIG5vLW9wCiAgICAgICAgLy8gYmVjYXVzZSBpdCds\nbCBiZSBpbiB0aGUgcHJpbWFyeSB0YWJsZSkgYW5kIHNlZSBpZiBmayBjb2xz\nIGFyZW4ndAogICAgICAgIC8vIG51bGw7IGlmIGludmVyc2UsIHRoZW4gd2Ug\naGF2ZSB0byBkbyBhIHN1Yi1zZWxlY3QgdG8gc2VlIGlmIGFueQogICAgICAg\nIC8vIGludmVyc2Ugb2JqZWN0cyBwb2ludCBiYWNrIHRvIHRoaXMgZmllbGQn\ncyBvd25lcgogICAgICAgIGlmIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkg\nIT0gZmllbGQuSk9JTl9JTlZFUlNFKSB7CiAgICAgICAgICAgIC8vIyMjIHBy\nb2JhYmx5IG5lZWQgc29tZSBzb3J0IG9mIHN1YnNlbGVjdCBoZXJlIG9uIGZr\nIGNvbnN0YW50cwogICAgICAgICAgICBqb2lucyA9IGpvaW4oam9pbnMsIGZh\nbHNlKTsKICAgICAgICAgICAgQ29sdW1uW10gY29scyA9IGZpZWxkLmdldENv\nbHVtbnMoKTsKICAgICAgICAgICAgaWYgKGNvbHMubGVuZ3RoID09IDApCiAg\nICAgICAgICAgICAgICBzcWwuYXBwZW5kKCIxID0gMSIpOwogICAgICAgICAg\nICBlbHNlCiAgICAgICAgICAgICAgICBzcWwuYXBwZW5kKHNlbC5nZXRDb2x1\nbW5BbGlhcyhjb2xzWzBdLCBqb2lucykpLgogICAgICAgICAgICAgICAgICAg\nIGFwcGVuZCgiIElTIE5PVCAiKS5hcHBlbmRWYWx1ZShudWxsLCBjb2xzWzBd\nKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgICAgdGVzdEludmVyc2VOdWxs\nKHNxbCwgc2VsLCBqb2lucywgZmFsc2UpOwogICAgfQoKICAgIC8qKgogICAg\nICogQXBwZW5kIFNRTCBmb3IgYSBzdWItc2VsZWN0IHRlc3Rpbmcgd2hldGhl\nciBhbiBpbnZlcnNlIG9iamVjdCBleGlzdHMKICAgICAqIGZvciB0aGlzIHJl\nbGF0aW9uLgogICAgICovCiAgICBwcml2YXRlIHZvaWQgdGVzdEludmVyc2VO\ndWxsKFNRTEJ1ZmZlciBzcWwsIFNlbGVjdCBzZWwsIEpvaW5zIGpvaW5zLAog\nICAgICAgIGJvb2xlYW4gZW1wdHkpIHsKICAgICAgICBEQkRpY3Rpb25hcnkg\nZGljdCA9IGZpZWxkLmdldE1hcHBpbmdSZXBvc2l0b3J5KCkuZ2V0REJEaWN0\naW9uYXJ5KCk7CiAgICAgICAgZGljdC5hc3NlcnRTdXBwb3J0KGRpY3Quc3Vw\ncG9ydHNTdWJzZWxlY3QsICJTdXBwb3J0c1N1YnNlbGVjdCIpOwoKICAgICAg\nICBpZiAoZmllbGQuZ2V0SW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKS5sZW5n\ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVnaWVz\nLnVuaW52ZXJzYWJsZShmaWVsZCk7CgogICAgICAgIGlmIChlbXB0eSkKICAg\nICAgICAgICAgc3FsLmFwcGVuZCgiMCA9ICIpOwogICAgICAgIGVsc2UKICAg\nICAgICAgICAgc3FsLmFwcGVuZCgiMCA8ICIpOwoKICAgICAgICBGb3JlaWdu\nS2V5IGZrID0gZmllbGQuZ2V0Rm9yZWlnbktleSgpOwogICAgICAgIENvbnRh\naW5lckZpZWxkU3RyYXRlZ3kuYXBwZW5kSm9pbkNvdW50KHNxbCwgc2VsLCBq\nb2lucywgZGljdCwgZmllbGQsCiAgICAgICAgICAgIGZrKTsKICAgIH0KCiAg\nICBwdWJsaWMgSm9pbnMgam9pbihKb2lucyBqb2lucywgYm9vbGVhbiBmb3Jj\nZU91dGVyKSB7CiAgICAgICAgLy8gaWYgd2UncmUgbm90IGluIGFuIGludmVy\nc2Ugb2JqZWN0IHRhYmxlIGpvaW4gbm9ybWFsbHksIG90aGVyd2lzZQogICAg\nICAgIC8vIGFscmVhZHkgdHJhdmVyc2VkIHRoZSByZWxhdGlvbjsganVzdCBq\nb2luIGJhY2sgdG8gb3duZXIgdGFibGUKICAgICAgICBpZiAoZmllbGQuZ2V0\nSm9pbkRpcmVjdGlvbigpICE9IGZpZWxkLkpPSU5fSU5WRVJTRSkKICAgICAg\nICAgICAgcmV0dXJuIGZpZWxkLmpvaW4oam9pbnMsIGZvcmNlT3V0ZXIsIGZh\nbHNlKTsKICAgICAgICBDbGFzc01hcHBpbmdbXSBjbHNzID0gZmllbGQuZ2V0\nSW5kZXBlbmRlbnRUeXBlTWFwcGluZ3MoKTsKICAgICAgICBpZiAoY2xzcy5s\nZW5ndGggIT0gMSkKICAgICAgICAgICAgdGhyb3cgUmVsYXRpb25TdHJhdGVn\naWVzLnVuaW52ZXJzYWJsZShmaWVsZCk7CiAgICAgICAgaWYgKGZvcmNlT3V0\nZXIpCiAgICAgICAgICAgIHJldHVybiBqb2lucy5vdXRlckpvaW5SZWxhdGlv\nbihmaWVsZC5nZXROYW1lKCksCiAgICAgICAgICAgICAgICBmaWVsZC5nZXRG\nb3JlaWduS2V5KCksIGNsc3NbMF0sIGZpZWxkLmdldFNlbGVjdFN1YmNsYXNz\nZXMoKSwgCiAgICAgICAgICAgICAgICB0cnVlLCBmYWxzZSk7CiAgICAgICAg\ncmV0dXJuIGpvaW5zLmpvaW5SZWxhdGlvbihmaWVsZC5nZXROYW1lKCksIGZp\nZWxkLmdldEZvcmVpZ25LZXkoKSwKICAgICAgICAgICAgY2xzc1swXSwgZmll\nbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCB0cnVlLCBmYWxzZSk7CiAgICB9\nCgogICAgcHVibGljIEpvaW5zIGpvaW5SZWxhdGlvbihKb2lucyBqb2lucywg\nYm9vbGVhbiBmb3JjZU91dGVyLAogICAgICAgIGJvb2xlYW4gdHJhdmVyc2Up\nIHsKICAgICAgICAvLyBpZiB0aGlzIGlzIGFuIGludmVyc2UgbWFwcGluZyBp\ndCdzIGFscmVhZHkgam9pbmVkIHRvIHRoZSByZWxhdGlvbgogICAgICAgIGlm\nIChmaWVsZC5nZXRKb2luRGlyZWN0aW9uKCkgPT0gZmllbGQuSk9JTl9JTlZF\nUlNFKQogICAgICAgICAgICByZXR1cm4gam9pbnM7CiAgICAgICAgQ2xhc3NN\nYXBwaW5nW10gY2xzcyA9IGZpZWxkLmdldEluZGVwZW5kZW50VHlwZU1hcHBp\nbmdzKCk7CiAgICAgICAgaWYgKGNsc3MubGVuZ3RoICE9IDEpIHsKICAgICAg\nICAgICAgaWYgKHRyYXZlcnNlKQogICAgICAgICAgICAgICAgdGhyb3cgUmVs\nYXRpb25TdHJhdGVnaWVzLnVuam9pbmFibGUoZmllbGQpOwogICAgICAgICAg\nICByZXR1cm4gam9pbnM7CiAgICAgICAgfQoKICAgICAgICBqb2lucyA9IHNl\ndEVtYmVkZGVkVmFyaWFibGUoam9pbnMpOwogICAgICAgIGlmIChmb3JjZU91\ndGVyKQogICAgICAgICAgICByZXR1cm4gam9pbnMub3V0ZXJKb2luUmVsYXRp\nb24oZmllbGQuZ2V0TmFtZSgpLCAKICAgICAgICAgICAgICAgIGZpZWxkLmdl\ndEZvcmVpZ25LZXkoY2xzc1swXSksIGNsc3NbMF0sIAogICAgICAgICAgICAg\nICAgZmllbGQuZ2V0U2VsZWN0U3ViY2xhc3NlcygpLCBmYWxzZSwgZmFsc2Up\nOwogICAgICAgIHJldHVybiBqb2lucy5qb2luUmVsYXRpb24oZmllbGQuZ2V0\nTmFtZSgpLCBmaWVsZC5nZXRGb3JlaWduS2V5KGNsc3NbMF0pLAogICAgICAg\nICAgICBjbHNzWzBdLCBmaWVsZC5nZXRTZWxlY3RTdWJjbGFzc2VzKCksIGZh\nbHNlLCBmYWxzZSk7CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vCiAgICAvLyBKb2luYWJsZSBpbXBsZW1lbnRhdGlvbgogICAgLy8v\nLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgcHVibGljIGludCBnZXRG\naWVsZEluZGV4KCkgewogICAgICAgIHJldHVybiBmaWVsZC5nZXRJbmRleCgp\nOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgZ2V0UHJpbWFyeUtleVZhbHVl\nKFJlc3VsdCByZXMsIENvbHVtbltdIGNvbHMsIEZvcmVpZ25LZXkgZmssCiAg\nICAgICAgSkRCQ1N0b3JlIHN0b3JlLCBKb2lucyBqb2lucykKICAgICAgICB0\naHJvd3MgU1FMRXhjZXB0aW9uIHsKICAgICAgICBDbGFzc01hcHBpbmcgcmVs\nbWFwcGluZyA9IGZpZWxkLmdldFR5cGVNYXBwaW5nKCk7CiAgICAgICAgaWYg\nKHJlbG1hcHBpbmcuZ2V0SWRlbnRpdHlUeXBlKCkgPT0gQ2xhc3NNYXBwaW5n\nLklEX0RBVEFTVE9SRSkgewogICAgICAgICAgICBDb2x1bW4gY29sID0gY29s\nc1swXTsKICAgICAgICAgICAgaWYgKGZrICE9IG51bGwpCiAgICAgICAgICAg\nICAgICBjb2wgPSBmay5nZXRDb2x1bW4oY29sKTsgICAKICAgICAgICAgICAg\nbG9uZyBpZCA9IHJlcy5nZXRMb25nKGNvbCwgam9pbnMpOwogICAgICAgICAg\nICBpZiAoZmllbGQuZ2V0T2JqZWN0SWRGaWVsZFR5cGVDb2RlKCkgPT0gSmF2\nYVR5cGVzLkxPTkcpCiAgICAgICAgICAgICAgICByZXR1cm4gTnVtYmVycy52\nYWx1ZU9mKGlkKTsKICAgICAgICAgICAgcmV0dXJuIHN0b3JlLm5ld0RhdGFT\ndG9yZUlkKGlkLCByZWxtYXBwaW5nLCBmaWVsZC5nZXRQb2x5bW9ycGhpYygp\nIAogICAgICAgICAgICAgICAgIT0gVmFsdWVNYXBwaW5nLlBPTFlfRkFMU0Up\nOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlbG1hcHBpbmcuaXNPcGVuSlBB\nSWRlbnRpdHkoKSkKICAgICAgICAgICAgcmV0dXJuICgoSm9pbmFibGUpIHJl\nbG1hcHBpbmcuZ2V0UHJpbWFyeUtleUZpZWxkTWFwcGluZ3MoKVswXS4KICAg\nICAgICAgICAgICAgIGdldFN0cmF0ZWd5KCkpLmdldFByaW1hcnlLZXlWYWx1\nZShyZXMsIGNvbHMsIGZrLCBzdG9yZSwgam9pbnMpOwoKICAgICAgICBpZiAo\nY29scyA9PSBnZXRDb2x1bW5zKCkgJiYgZmsgPT0gbnVsbCkKICAgICAgICAg\nICAgZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7CiAgICAgICAgZWxzZQog\nICAgICAgICAgICBmayA9IGNyZWF0ZVRyYW5zbGF0aW5nRm9yZWlnbktleShy\nZWxtYXBwaW5nLCBjb2xzLCBmayk7IAogICAgICAgIHJldHVybiByZWxtYXBw\naW5nLmdldE9iamVjdElkKHN0b3JlLCByZXMsIGZrLAogICAgICAgICAgICBm\naWVsZC5nZXRQb2x5bW9ycGhpYygpICE9IFZhbHVlTWFwcGluZy5QT0xZX0ZB\nTFNFLCBqb2lucyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBm\nYXV4IGZvcmVpZ24ga2V5IHRoYXQgdHJhbnNsYXRlcyBiZXR3ZWVuIHRoZSBj\nb2x1bW5zIHRvIHB1bGwKICAgICAqIHRoZSBkYXRhIGZyb20gYW5kIG91ciBy\nZWxhdGVkIHR5cGUncyBwcmltYXJ5IGtleSBjb2x1bW5zLgogICAgICovCiAg\nICBwcml2YXRlIEZvcmVpZ25LZXkgY3JlYXRlVHJhbnNsYXRpbmdGb3JlaWdu\nS2V5KENsYXNzTWFwcGluZyByZWxtYXBwaW5nLAogICAgICAgIENvbHVtbltd\nIGdjb2xzLCBGb3JlaWduS2V5IGdmaykgewogICAgICAgIEZvcmVpZ25LZXkg\nZmsgPSBmaWVsZC5nZXRGb3JlaWduS2V5KCk7IAogICAgICAgIENvbHVtbltd\nIGNvbHMgPSBmay5nZXRDb2x1bW5zKCk7CgogICAgICAgIEZvcmVpZ25LZXkg\ndGZrID0gbnVsbDsKICAgICAgICBDb2x1bW4gdGNvbDsKICAgICAgICBmb3Ig\nKGludCBpID0gMDsgaSA8IGdjb2xzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAg\nICAgIHRjb2wgPSBnY29sc1tpXTsKICAgICAgICAgICAgaWYgKGdmayAhPSBu\ndWxsKQogICAgICAgICAgICAgICAgdGNvbCA9IGdmay5nZXRDb2x1bW4odGNv\nbCk7CiAgICAgICAgICAgIGlmICh0ZmsgPT0gbnVsbCkKICAgICAgICAgICAg\nICAgIHRmayA9IG5ldyBGb3JlaWduS2V5KG51bGwsIHRjb2wuZ2V0VGFibGUo\nKSk7CiAgICAgICAgICAgIHRmay5qb2luKHRjb2wsIGZrLmdldFByaW1hcnlL\nZXlDb2x1bW4oY29sc1tpXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4g\ndGZrOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgZ2V0Sm9pblZhbHVlKE9i\namVjdCBmaWVsZFZhbCwgQ29sdW1uIGNvbCwgSkRCQ1N0b3JlIHN0b3JlKSB7\nCiAgICAgICAgT2JqZWN0IG8gPSBmaWVsZC5nZXRGb3JlaWduS2V5KCkuZ2V0\nQ29uc3RhbnQoY29sKTsKICAgICAgICBpZiAobyAhPSBudWxsKQogICAgICAg\nICAgICByZXR1cm4gbzsKICAgICAgICBjb2wgPSBmaWVsZC5nZXRGb3JlaWdu\nS2V5KCkuZ2V0UHJpbWFyeUtleUNvbHVtbihjb2wpOwogICAgICAgIGlmIChj\nb2wgPT0gbnVsbCkKICAgICAgICAgICAgdGhyb3cgbmV3IEludGVybmFsRXhj\nZXB0aW9uKCk7CgogICAgICAgIENsYXNzTWFwcGluZyByZWxtYXBwaW5nID0g\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKTsKICAgICAgICBKb2luYWJsZSBqID0g\nZmllbGQuZ2V0VHlwZU1hcHBpbmcoKS5hc3NlcnRKb2luYWJsZShjb2wpOwog\nICAgICAgIGlmIChJbXBsSGVscGVyLmlzTWFuYWdlYWJsZShmaWVsZFZhbCkp\nCiAgICAgICAgICAgIGZpZWxkVmFsID0gc3RvcmUuZ2V0Q29udGV4dCgpLmdl\ndE9iamVjdElkKGZpZWxkVmFsKTsKICAgICAgICBpZiAoZmllbGRWYWwgaW5z\ndGFuY2VvZiBPcGVuSlBBSWQpCiAgICAgICAgICAgIGZpZWxkVmFsID0gKChP\ncGVuSlBBSWQpIGZpZWxkVmFsKS5nZXRJZE9iamVjdCgpOwogICAgICAgIGlm\nIChyZWxtYXBwaW5nLmdldE9iamVjdElkVHlwZSgpICE9IG51bGwKICAgICAg\nICAgICAgJiYgcmVsbWFwcGluZy5nZXRPYmplY3RJZFR5cGUoKS5pc0luc3Rh\nbmNlKGZpZWxkVmFsKSkgewogICAgICAgICAgICBPYmplY3RbXSBwa3MgPSBB\ncHBsaWNhdGlvbklkcy50b1BLVmFsdWVzKGZpZWxkVmFsLCByZWxtYXBwaW5n\nKTsKICAgICAgICAgICAgZmllbGRWYWwgPSBwa3NbcmVsbWFwcGluZy5nZXRG\naWVsZChqLmdldEZpZWxkSW5kZXgoKSkuCiAgICAgICAgICAgICAgICBnZXRQ\ncmltYXJ5S2V5SW5kZXgoKV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBq\nLmdldEpvaW5WYWx1ZShmaWVsZFZhbCwgY29sLCBzdG9yZSk7CiAgICB9Cgog\nICAgcHVibGljIE9iamVjdCBnZXRKb2luVmFsdWUoT3BlbkpQQVN0YXRlTWFu\nYWdlciBzbSwgQ29sdW1uIGNvbCwKICAgICAgICBKREJDU3RvcmUgc3RvcmUp\nIHsKICAgICAgICByZXR1cm4gZ2V0Sm9pblZhbHVlKHNtLmZldGNoKGZpZWxk\nLmdldEluZGV4KCkpLCBjb2wsIHN0b3JlKTsKICAgIH0KCiAgICBwdWJsaWMg\ndm9pZCBzZXRBdXRvQXNzaWduZWRWYWx1ZShPcGVuSlBBU3RhdGVNYW5hZ2Vy\nIHNtLCBKREJDU3RvcmUgc3RvcmUsCiAgICAgICAgQ29sdW1uIGNvbCwgT2Jq\nZWN0IGF1dG9JbmMpIHsKICAgICAgICB0aHJvdyBuZXcgVW5zdXBwb3J0ZWRF\neGNlcHRpb24oKTsKICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8v\nLy8vLy8vLwogICAgLy8gRW1iZWRkYWJsZSBpbXBsZW1lbnRhdGlvbgogICAg\nLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBwdWJsaWMgQ29s\ndW1uW10gZ2V0Q29sdW1ucygpIHsKICAgICAgICByZXR1cm4gZmllbGQuZ2V0\nQ29sdW1ucygpOwogICAgfQoKICAgIHB1YmxpYyBDb2x1bW5JTyBnZXRDb2x1\nbW5JTygpIHsKICAgICAgICByZXR1cm4gZmllbGQuZ2V0Q29sdW1uSU8oKTsK\nICAgIH0KCiAgICBwdWJsaWMgT2JqZWN0W10gZ2V0UmVzdWx0QXJndW1lbnRz\nKCkgewogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHB1YmxpYyBP\nYmplY3QgdG9FbWJlZGRlZERhdGFTdG9yZVZhbHVlKE9iamVjdCB2YWwsIEpE\nQkNTdG9yZSBzdG9yZSkgewogICAgICAgIHJldHVybiB0b0RhdGFTdG9yZVZh\nbHVlKHZhbCwgc3RvcmUpOwogICAgfQoKICAgIHB1YmxpYyBPYmplY3QgdG9F\nbWJlZGRlZE9iamVjdFZhbHVlKE9iamVjdCB2YWwpIHsKICAgICAgICByZXR1\ncm4gVU5TVVBQT1JURUQ7CiAgICB9CgogICAgcHVibGljIHZvaWQgbG9hZEVt\nYmVkZGVkKE9wZW5KUEFTdGF0ZU1hbmFnZXIgc20sIEpEQkNTdG9yZSBzdG9y\nZSwKICAgICAgICBKREJDRmV0Y2hDb25maWd1cmF0aW9uIGZldGNoLCBPYmpl\nY3QgdmFsKQogICAgICAgIHRocm93cyBTUUxFeGNlcHRpb24gewogICAgICAg\nIENsYXNzTWFwcGluZyByZWxNYXBwaW5nID0gZmllbGQuZ2V0VHlwZU1hcHBp\nbmcoKTsKICAgICAgICBPYmplY3Qgb2lkOwogICAgICAgIGlmICh2YWwgPT0g\nbnVsbCkKICAgICAgICAgICAgb2lkID0gbnVsbDsKICAgICAgICBlbHNlIGlm\nIChyZWxNYXBwaW5nLmdldElkZW50aXR5VHlwZSgpID09IENsYXNzTWFwcGlu\nZy5JRF9EQVRBU1RPUkUpCiAgICAgICAgICAgIG9pZCA9IHN0b3JlLm5ld0Rh\ndGFTdG9yZUlkKCgoTnVtYmVyKSB2YWwpLmxvbmdWYWx1ZSgpLCByZWxNYXBw\naW5nLAogICAgICAgICAgICAgICAgZmllbGQuZ2V0UG9seW1vcnBoaWMoKSAh\nPSBWYWx1ZU1hcHBpbmcuUE9MWV9GQUxTRSk7CiAgICAgICAgZWxzZSB7CiAg\nICAgICAgICAgIE9iamVjdFtdIHBrcyA9IChnZXRDb2x1bW5zKCkubGVuZ3Ro\nID09IDEpID8gbmV3IE9iamVjdFtdeyB2YWwgfQogICAgICAgICAgICAgICAg\nOiAoT2JqZWN0W10pIHZhbDsKICAgICAgICAgICAgYm9vbGVhbiBudWxscyA9\nIHRydWU7CiAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBudWxscyAmJiBp\nIDwgcGtzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgbnVsbHMgPSBw\na3NbaV0gPT0gbnVsbDsKICAgICAgICAgICAgaWYgKG51bGxzKQogICAgICAg\nICAgICAgICAgb2lkID0gbnVsbDsKICAgICAgICAgICAgZWxzZSB7CiAgICAg\nICAgICAgICAgICBvaWQgPSBBcHBsaWNhdGlvbklkcy5mcm9tUEtWYWx1ZXMo\ncGtzLCByZWxNYXBwaW5nKTsKICAgICAgICAgICAgICAgIGlmIChmaWVsZC5n\nZXRQb2x5bW9ycGhpYygpID09IFZhbHVlTWFwcGluZy5QT0xZX0ZBTFNFCiAg\nICAgICAgICAgICAgICAgICAgJiYgb2lkIGluc3RhbmNlb2YgT3BlbkpQQUlk\nKSB7CiAgICAgICAgICAgICAgICAgICAgKChPcGVuSlBBSWQpIG9pZCkuc2V0\nTWFuYWdlZEluc3RhbmNlVHlwZShyZWxNYXBwaW5nLgogICAgICAgICAgICAg\nICAgICAgICAgICBnZXREZXNjcmliZWRUeXBlKCkpOwogICAgICAgICAgICAg\nICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAob2lk\nID09IG51bGwpCiAgICAgICAgICAgIHNtLnN0b3JlT2JqZWN0KGZpZWxkLmdl\ndEluZGV4KCksIG51bGwpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgc20u\nc2V0SW50ZXJtZWRpYXRlKGZpZWxkLmdldEluZGV4KCksIG9pZCk7CiAgICB9\nCn0K\n","encoding":"base64"}

